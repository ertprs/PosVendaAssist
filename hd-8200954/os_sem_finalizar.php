<?
include "dbconfig.php";
include "includes/dbconnect-inc.php";
include "autentica_usuario.php";

$title = "Fechamento de Ordem de Serviço";
$layout_menu = 'os';
include "cabecalho.php";

#------------ Fecha Ordem de Servico ------------#
$btn_acao = strtolower($_POST['btn_acao']);

if ($btn_acao == 'continuar') {

	$sql = "select tbl_os.os from tbl_os join tbl_os_extra using(os) where tbl_os.fabrica = 1 and tbl_os.data_fechamento::date <= '2005-11-30' and tbl_os.finalizada isnull and tbl_os_extra.extrato isnull and tbl_os.solucao_os notnull and os in (449885, 449731, 449599, 513069, 480365, 396398, 441605, 512812, 385658, 393479, 415226, 415227, 415228, 415221, 440866, 478368, 440828, 440764, 497065, 431488, 497002, 443006, 443013, 443018, 443021, 443024, 443028, 443029, 442981, 442984, 442991, 442996, 443001, 466205, 435226, 393525, 450413, 450451, 451786, 451795, 451753, 451720, 451688, 451705, 450677, 450844, 450862, 496871, 496803, 496778, 496736, 435682, 460416, 496756, 431612, 435703, 431683, 465699, 465855, 465793, 496632, 474647, 474549, 496490, 496460, 478780, 470975, 470867, 480543, 480560, 480578, 480615, 480633, 481776, 481582, 481548, 481562, 481510, 481527, 481457, 481473, 483553, 484229, 496331, 419195, 487803, 490625, 490645, 488170, 488508, 491274, 491310, 491383, 491453, 491759, 492664, 492537, 492455, 492324, 492282, 498004, 498129, 500264, 498140, 500278, 498175, 500198, 500199, 498210, 498256, 498308, 498391, 498309, 499888, 499885, 499886, 499887, 498621, 498641, 498733, 498749, 498761, 498778, 498830, 499438, 498886, 499451, 499459, 498911, 498930, 499310, 499283, 499157, 499236, 499252, 499196, 503515, 499214, 501516, 503202, 503209, 502743, 498310, 502452, 496991, 506693, 512783, 512658, 512469, 512406, 545310, 530173, 530174, 530175, 530176, 530177, 530178, 530179, 530392, 530393, 530394, 530395, 530396, 530397, 530398, 530790, 530791, 529442, 529443, 529445, 529446, 529447, 529448, 529449, 529450, 529454, 529455, 529456, 529458, 529459, 529461, 529462, 529463, 529464, 529465, 529466, 529467, 529468, 529469, 529470, 529471, 529472, 529473, 529474, 529475, 529476, 529477, 529478, 529479, 529480, 529481, 529460, 530206, 530207, 530208, 530209, 530210, 530211, 530212, 530213, 530968, 530969, 530970, 530971, 530972, 530973, 530974, 529495, 529496, 529497, 529498, 529499, 529500, 529501, 529502, 529503, 529504, 529505, 529506, 529507, 529508, 529509, 530806, 530807, 530808, 530809, 530810, 530811, 530812, 530813, 530814, 530815, 530816, 530817, 568035, 518329, 518267, 515766, 516173, 517210, 529522, 529523, 529524, 529525, 529526, 529527, 529528, 529529, 529530, 529531, 529532, 529533, 529534, 529535, 529536, 529537, 522017, 524878, 524905, 524911, 554157, 545351, 530854, 530855, 530856, 530857, 530858, 530859, 530272, 530274, 548748, 530275, 530276, 530277, 530278, 530279, 530280, 530281, 530282, 530283, 530284, 530285, 530286, 530287, 553465, 527112, 533233, 554245, 553507, 553513, 545368, 530698, 530699, 530700, 537521, 530721, 530722, 530723, 530724, 530725, 530726, 530727, 530132, 530133, 530134, 530135, 548789, 530136, 530137, 530138, 530139, 530140, 545380, 570623, 527195, 530349, 530350, 530351, 533390, 527978, 530746, 530747, 530748, 530749, 530750, 530751, 545394, 553620, 533729, 543832, 530762, 530763, 530764, 530765, 530766, 548845, 545403, 528661, 528744, 528794, 528982, 528991, 531156, 531157, 531158, 531159, 531160, 531161, 531162, 531163, 531164, 531166, 531256, 531257, 531258, 531259, 531364, 531365, 531366, 531367, 531368, 531369, 531370, 531371, 531372, 531373, 531374, 531375, 531376, 531377, 531378, 531379, 531380, 531381, 531382, 531383, 531384, 531385, 531386, 531387, 531388, 531389, 531390, 531391, 531392, 531393, 531714, 531715, 531716, 531717, 531718, 531719, 531720, 531721, 531722, 531723, 531724, 531725, 531726, 531727, 531809, 531810, 531811, 531812, 531813, 531814, 531815, 531816, 531817, 531853, 531855, 531856, 531857, 531858, 531859, 531860, 531861, 531862, 531863, 531864, 531865, 531866, 531867, 531868, 539326, 539328, 539330, 539346, 532406, 534906, 534918, 570640, 539889, 543899, 540062, 540110, 553695, 540419, 548934, 541390, 541598, 548973, 541617, 541633, 571197, 576760, 567229, 542328, 546102, 427124, 576771, 570659, 546703, 570208, 570237, 553806, 571720, 568995, 571731, 576845, 576868, 514281, 544489, 549281, 569098, 549341, 549399, 549426, 549507, 568285, 549596, 549589, 549629, 549721, 549795, 549853, 549877, 569119, 553964, 553965, 550307, 550349, 576928, 567486, 549198, 551473, 554019, 569895, 576943, 552711, 552748, 552763, 552776, 552791, 552811, 552820, 552827, 552836, 568401, 553074, 553081, 553101, 553112, 553133, 567601, 576999, 577016, 555026, 555091, 555080, 555103, 555122, 570000, 555143, 555162, 555184, 555436, 555496, 576563, 567762, 577071, 570556, 556888, 556911, 568597, 568611, 568658, 570595, 568748, 559584, 562504, 563791, 563857, 563996, 564065, 564066, 564067, 564068, 564069, 564070, 564071, 564072, 564147, 568806, 570115, 565170, 565176, 565192, 565196, 565203, 576610, 573712, 573845, 577160, 574093, 574126, 574185, 574326, 574342, 574256, 574431, 574453, 574514, 574536, 574572, 574641, 574668, 574710, 574718, 574821, 574866, 574899, 574911, 575021, 575047, 575064, 575080, 575108, 575119, 575145, 576706, 575160, 575214, 575375, 575406, 575415, 575433, 575438, 575519, 575534, 575557, 575627, 575638, 575669, 579931)";
	$res = pg_exec ($con,$sql);
	$msg_erro = pg_errormessage ($con);

	$resX = pg_exec ($con,"BEGIN TRANSACTION");

	for($i=0; $i<pg_numrows($res); $i++){
		$os = pg_result($res,$i,os);
echo "$i :: OS: $os &nbsp;&nbsp; -> ";
		$sql2 = "SELECT fn_finaliza_os($os, 1)";
echo "SQL: $sql2 &nbsp;&nbsp; -> ";
		$res2 = @pg_exec ($con,$sql2);
		$msg_erro = pg_errormessage($con);
echo "Erro: $msg_erro <BR><BR>";
	}

	if (strlen ($msg_erro) > 0) {
		$resX = @pg_exec ($con,"ROLLBACK TRANSACTION");
	}else{
		$resX = @pg_exec ($con,"COMMIT TRANSACTION");
echo "Finalizado...<BR>";
	}
}
?>

<?
if (strlen ($msg_erro) > 0) {
	echo $msg_erro ;
}

if (!$btn_acao) {
	$sql = "select tbl_os.os, tbl_os.posto, tbl_os.data_fechamento, tbl_os.finalizada from tbl_os join tbl_os_extra using(os) where tbl_os.fabrica = 1 and tbl_os.data_fechamento::date <= '2005-11-30' and tbl_os.finalizada isnull and tbl_os_extra.extrato isnull and tbl_os.solucao_os notnull";
	$res = pg_exec ($con,$sql);
	$msg_erro = pg_errormessage ($con);
?>
<table width="600" border="0" cellpadding="3" cellspacing="1" align="center">
	<!-- ------------- Formulário ----------------- -->
	<form name="frm_os" method="post" action="<? echo $PHP_SELF ?>">
<?
	for ($i = 0 ; $i < pg_numrows ($res) ; $i++) {
		$cor = "#FFFFFF";
		if ($i % 2 == 0) $cor = '#F1F4FA';

		$os    = trim(pg_result ($res,$i,os));
		$posto = trim(pg_result ($res,$i,posto));
		$data_fechamento = trim(pg_result ($res,$i,data_fechamento));
		$finalizada      = trim(pg_result ($res,$i,finalizada));
?>

		<tr bgcolor="<? echo $cor ?>">
			<td><font size="2" face="Geneva, Arial, Helvetica, san-serif"><? echo $os ?></td>
			<td><font size="2" face="Geneva, Arial, Helvetica, san-serif"><? echo $posto ?></td>
			<td><font size="2" face="Geneva, Arial, Helvetica, san-serif"><? echo $data_fechamento ?></td>
			<td><font size="2" face="Geneva, Arial, Helvetica, san-serif"><? echo $finalizada ?></td>
		</tr>
<?
	}
?>
<tr>
		<td height="27" valign="middle" align="center" colspan="3" background="" bgcolor="#FFFFFF">
			<input type="hidden" name="btn_acao" value="">
			<img src='imagens/btn_continuar.gif' onclick="javascript: if (document.frm_os.btn_acao.value == '' ) { document.frm_os.btn_acao.value='continuar' ; document.frm_os.submit() } else { alert ('Aguarde submissão') }" ALT="Continuar com Ordem de Serviço" border='0' style='cursor: pointer'>
		</td>
	</tr>
</table>
<?
}
?>

<p>

<? include "rodape.php"; ?>
