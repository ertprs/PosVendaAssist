<?php

include_once 'dbconfig.php';
include_once 'includes/dbconnect-inc.php';
include_once 'autentica_usuario.php';
include_once 'class/aws/anexaS3.class.php';
include_once 'funcoes.php';

include_once 'class/communicator.class.php';
if (in_array($login_fabrica, [123])) {
    if (isset($_GET['os'])) {
        $os_termo   = $_GET['os'];
        
        if (data_corte_termo($os_termo)) {
            $sql_termo = "SELECT campos_adicionais
                          FROM tbl_os_campo_extra
                          WHERE os = {$os_termo}
                          AND fabrica = {$login_fabrica}";
            $res_termo = pg_query($con, $sql_termo);
            if (pg_num_rows($res_termo) == 0) {
                header("Location: termo_entrega.php?os=$os_termo");
            } 
        }
    }
}

if($login_fabrica == 115){        
    $sql_audit = "SELECT defeito_constatado, obs FROM tbl_os WHERE os = {$os}";
    $res_audit = pg_query($con, $sql_audit);

    $x_defeito_constatado   = pg_fetch_result($res_audit, 0, 'defeito_constatado');    

    $sql_audit_1 = "SELECT
                        op.os_produto,
                        op.os,
                        oi.peca,
                        p.referencia,
                        oi.servico_realizado
                        FROM tbl_os_produto op
                        JOIN tbl_os_item oi ON oi.os_produto = op.os_produto
                        JOIN tbl_peca p ON p.peca = oi.peca
                        WHERE op.os = {$os}
                        ORDER BY op.os_produto";

    $res_audit_1 = pg_query($con, $sql_audit_1);    

    $contar_audit_1 = pg_num_rows($res_audit_1);

    for($x=0; $x<=$contar_audit_1; $x++){
        $arr_audit[] = pg_fetch_array($res_audit_1);
    }    
}

if($_POST["verifica_def_const_cor_etiqueta"] == true){

    $defeito_constatado = $_POST['defeito_constatado'];

    $sql = "select defeito_constatado, campos_adicionais from tbl_defeito_constatado where defeito_constatado = $defeito_constatado  ";
    $res = pg_query($con, $sql);
    if(pg_num_rows($res)>0){
        $campos_adicionais = json_decode(pg_fetch_result($res, 0, 'campos_adicionais'),true);
        $pedir_cor_etiqueta = $campos_adicionais['pedir_cor_etiqueta'];
    }

    if($pedir_cor_etiqueta == true){
        echo "sim";
    }else{
        echo "nao";
    }

    exit;
}

if ($_POST["buscaQtdFoto"]) {
    $ref = $_POST["ref"];
    $desc = $_POST["desc"];

    $sqlPA = "SELECT parametros_adicionais FROM tbl_peca WHERE fabrica = $login_fabrica AND peca = (SELECT peca FROM tbl_peca WHERE fabrica = $login_fabrica AND UPPER(TRIM(referencia)) = UPPER(TRIM('$ref')) AND UPPER(TRIM(descricao)) = UPPER(TRIM('$desc')) LIMIT 1)";    
    $resPA = pg_query($con, $sqlPA);

    unset($parametros_adicionais);
    unset($qtde_fotos);
    unset($serial_lcd);

    if (pg_num_rows($resPA) > 0) {
        $parametros_adicionais = pg_fetch_result($resPA, 0, "parametros_adicionais");

        $json = json_decode($parametros_adicionais, true);

        if ($json["qtde_fotos"] > 0) {
            $qtde_fotos = $json["qtde_fotos"];
        } else {
            $qtde_fotos = 0;
        }

        if (strlen($json["serial_lcd"]) > 0) {
            $serial_lcd = $json["serial_lcd"];
        } else {
            $serial_lcd = "f";
        }

        $retornoPeca = ["qtde_fotos"=> $qtde_fotos, "serial_lcd"=> $serial_lcd];

    } else {
        $retornoPeca = ["qtde_fotos"=> 0, "serial_lcd"=> 0];
    }

    exit(json_encode($retornoPeca));

}

if (isset($_GET['ajax_exclui_item_checklist']) && $_GET['ajax_exclui_item_checklist'] == true) {

    $checklist_fabrica            = $_GET['checklist_fabrica'];
    $os = $_GET['os'];
    $constatado = $_GET['constatado'];
    $reclamado   = $_GET['reclamado'];
    $sql = "DELETE FROM tbl_os_defeito_reclamado_constatado
                  WHERE fabrica = $login_fabrica
                    AND checklist_fabrica  = $checklist_fabrica
                    AND os                 = $os
                    AND defeito_reclamado  = $reclamado
                    AND defeito_constatado = $constatado";
    $res = pg_query($con, $sql);
    if (pg_last_error()) {
        exit(json_encode(["erro" => true, "msg" => "Erro ao excluir checklist"]));
    }
    exit(json_encode(["erro" => false, "msg" => "Checklist excluido com sucesso"]));
}

if (isset($_GET['ajax_exclui_checklist_os']) && $_GET['ajax_exclui_checklist_os'] == true) {
    $checklist_fabrica = implode(",", $_GET['check_list_fabrica']);

    $sql = "DELETE FROM tbl_os_defeito_reclamado_constatado
                  WHERE fabrica = $login_fabrica
                    AND os = $os AND checklist_fabrica IN({$checklist_fabrica})";
    $res = pg_query($con, $sql);


    $sqlEXT = "SELECT campos_adicionais  FROM tbl_os_campo_extra WHERE os=$os";
    $resEXT = pg_query($con,$sqlEXT);
    if (pg_num_rows($resEXT) > 0) {
        $campos_adicionais = json_decode(pg_fetch_result($resEXT, 0, 'campos_adicionais'),1);
        unset($campos_adicionais["condicao_instalacao"]);
        $campos_adicionaisENC = json_encode($campos_adicionais);
        $sqlENC = "UPDATE tbl_os_campo_extra SET campos_adicionais = '".$campos_adicionaisENC."' WHERE os=$os";
        $resENC = pg_query($con, $sqlENC);
    }


    if (pg_last_error()) {
        exit(json_encode(["erro" => true, "msg" => "Erro ao excluir checklist"]));
    }
    exit(json_encode(["erro" => false, "msg" => "Checklist excluido com sucesso"]));
}

if (isset($_GET['ajax_carrega_checklist'])) {
    $familia            = $_GET['familia'];
    $defeito_constatado = $_GET['defeito_constatado'];
    $defeito_reclamado = $_GET['defeito_reclamado'];
    $tipo_atendimento   = $_GET['tipo_atendimento'];
    $check   = $_GET['check'];
    
    if ($check == "instalacao_sem_defeito") {
        $condCheck = "AND codigo='52'";
    } 
    if ($check == "nao_avaliado") {
        $condCheck = "AND codigo='51'";
    } 
     $sql = "SELECT checklist_fabrica,
                    codigo,
                    descricao
                FROM tbl_checklist_fabrica
                WHERE fabrica = $login_fabrica
                AND familia = $familia
                {$condCheck}
                AND tipo_atendimento = $tipo_atendimento
               -- AND defeito_constatado = $defeito_constatado";
    $res = pg_query($con, $sql);
    if (pg_num_rows($res) > 0) {
        $contador_res = pg_num_rows($res);

        for ($i=0; $i < $contador_res; $i++) {
            $checklist_fabrica = pg_fetch_result($res, $i, 'checklist_fabrica');
            $codigo = pg_fetch_result($res, $i, 'codigo');
            $descricao = pg_fetch_result($res, $i, 'descricao');

            if (mb_check_encoding($descricao, "UTF-8")) {
                $descricao = $descricao;
            }
            
            echo  "<tr>
                        <td class='txt_checklist'>
                            <input type='checkbox' disabled='disabled' checked='checked' > $codigo - $descricao
                            <input type='hidden' id='$checklist_fabrica'  name='check_list_fabrica[".$defeito_reclamado."][".$defeito_constatado."][]' value='$checklist_fabrica'>
                        </td>
                        <td class='txt_checklist'></td>
                    </tr>";
        }
    }
    exit;
}



/*
function data_corte_termo($con, $os, $login_fabrica) {
	$data_corte = '2018-12-17';

    $sql_data_digitacao = "SELECT data_digitacao::DATE FROM tbl_os WHERE os = {$os} AND fabrica = {$login_fabrica}";
    $res_data_digitacao = pg_query($con, $sql_data_digitacao);
    $dt_digitacao = pg_fetch_result($res_data_digitacao, 0, 'data_digitacao');

	$oDataCorte = new DateTime($data_corte);
	$oDataDigitacao = new DateTime($dt_digitacao);

    if ($oDataDigitacao >= $oDataCorte) {
        return true;
    } else {
        return false;
    } 
}*/

if (in_array($login_fabrica, [91])) {
    include_once 'validar_peca_vinculada.php';
}


if ($login_fabrica == 72 && !empty( $_REQUEST['os'] )) {
    $os = $_REQUEST["os"];

    $aux_sql = "SELECT status_os
        FROM tbl_os_status 
        WHERE os = {$os}
        AND status_os IN ( 19, 70 )
        ORDER BY data DESC LIMIT 1 ";

    $aux_res = pg_query($con, $aux_sql);
    $aux_result = pg_fetch_array( $aux_res, 0, PGSQL_NUM );

    if ( $aux_result[0] == '70' ) {
        header("Location: os_press.php?os=$os");
    }
}

if ($login_fabrica == 42 && !empty( $_REQUEST['os'] )) {
    $os = $_REQUEST["os"];

    $xx_sql = "SELECT cancelada 
        FROM tbl_os 
        WHERE os = {$os}
        AND fabrica = {$login_fabrica}";

    $xx_res = pg_query($con, $xx_sql);
    $xx_cat = pg_fetch_array( $xx_res, 0, 'cancelada');
    if ($xx_cat) {
        header("Location: os_press.php?os=$os");
    }
}

if($novaTelaOs) {
    header("Location: cadastro_os.php?os_id=$os");
}
//$fabricas_image_uploader = !in_array($login_fabrica, array(126, 137));
// Em 2018-06-29 foi habilitado a funcionalidade do Image Uploader para a Lorenzetti
$fabricas_image_uploader = [19];


 /**
  * @author William Castro <william.castro@telecontrol.com.br>
  * hd-6639553 -> Box Uploader
  *
  */  

if ($fabricaFileUploadOS) {
    
    if (!empty($os)) {
        $tempUniqueId = $os;
        $anexoNoHash = null;
    } else if (strlen(getValue("anexo_chave")) > 0) {
        $tempUniqueId = getValue("anexo_chave");
        $anexoNoHash = true;
    } else {
        if ($areaAdmin === true) {
            $tempUniqueId = $login_fabrica.$login_admin.date("dmYHis");
        } else {
            $tempUniqueId = $login_fabrica.$login_posto.date("dmYHis");
        }

        $anexoNoHash = true;
    }
}

//include_once 'class/email/mailer/class.phpmailer.php';
//$mailer = new PHPMailer();
$programa_insert = $_SERVER['PHP_SELF'];

if($_POST['ajax'] == "verifica_recompra"){

    $posto_id       = $_POST['posto_id'];
    $referencia     = $_POST['ajax_peca'];

    $sql = "SELECT controla_estoque, posto, fabrica
                FROM tbl_posto_fabrica
                WHERE posto = $posto_id
                AND fabrica = $login_fabrica";
    $res = pg_query($con, $sql);
    if(pg_num_rows($res)>0){
        $controla_estoque = pg_fetch_result($res, 0, controla_estoque);
    }

    if($controla_estoque == 't'){
        $sql_estoque = "SELECT tbl_estoque_posto.qtde, tbl_estoque_posto.peca
                        FROM tbl_estoque_posto
                        INNER JOIN tbl_peca ON tbl_peca.peca = tbl_estoque_posto.peca
                        AND tbl_peca.fabrica = $login_fabrica
                        WHERE tbl_estoque_posto.posto = $posto_id
                        AND tbl_estoque_posto.fabrica = $login_fabrica
                        AND tbl_peca.referencia = '$referencia'; ";
        $res_estoque = pg_query($con, $sql_estoque);
        if(pg_num_rows($res_estoque)>0){
            $qtde_estoque = pg_fetch_result($res_estoque, 0, 'qtde');
        }

        if($qtde_estoque > 0 ){
            $sql_servico = "SELECT servico_realizado, descricao from tbl_servico_realizado where fabrica = $login_fabrica and gera_pedido = 'f' and ativo = 't'";
            $res_servico = pg_query($con, $sql_servico);
            $campos = "<option value=''>SELECIONE</option>";
            $contador_servico = pg_num_rows($res_servico);
            for($i=0; $i<$contador_servico; $i++){
                $servico_realizado  = pg_fetch_result($res_servico, $i, 'servico_realizado');
                $descricao          = pg_fetch_result($res_servico, $i, 'descricao');

                $campos .= "<option value='$servico_realizado'>$descricao</option>";

            }

            echo $campos;
        }
    }
    exit;
}

if(in_array($login_fabrica, array(11,172))){

    if(strlen($os) > 0){

        $sql_fabrica = "SELECT fabrica FROM tbl_os WHERE os = {$os}";
        $res_fabrica = pg_query($con, $sql_fabrica);

        if(pg_num_rows($res_fabrica) > 0){

            $fabrica_os = pg_fetch_result($res_fabrica, 0, "fabrica");

            if($fabrica_os != $login_fabrica){

                $self = $_SERVER['PHP_SELF'];
                $self = explode("/", $self);

                unset($self[count($self)-1]);

                $page = implode("/", $self);
                $page = "http://".$_SERVER['HTTP_HOST'].$page."/token_cookie_changes.php";
                $pageReturn = "http://".$_SERVER['HTTP_HOST'].$_SERVER['PHP_SELF']."?os={$os}&reabrir=";

                $params = "?cook_admin=&cook_fabrica={$fabrica_os}&page_return={$pageReturn}";
                $page = $page.$params;

                header("Location: {$page}");
                exit;

            }

        }

    }

}

if ($login_fabrica == 72) {
    $sql= "SELECT tbl_tipo_posto.descricao
            FROM tbl_posto_fabrica
            JOIN  tbl_tipo_posto USING(tipo_posto)
            WHERE tbl_posto_fabrica.posto   = $login_posto
              AND tbl_posto_fabrica.fabrica = $login_fabrica";
    $res = pg_query($con,$sql);
    $descricao_tipo_posto = pg_fetch_result($res, 0, 'descricao');

    $mallory_posto_TOP = (strtolower($descricao_tipo_posto) == 'posto autorizado top');
}

if($login_fabrica == 1){
    require "classes/ParametrosAdicionaisFabrica.php";
    $parametrosAdicionaisObject = new ParametrosAdicionaisFabrica($login_fabrica);

    require "classes/form/GeraComboType.php";
}

if(in_array($login_fabrica, array(88,101))){
  $limite_anexos_nf = 5;
}

if($login_fabrica == 134){
    $tema = traduz("servico.realizado",$con);
}else{
    $tema = traduz("defeito.constatado");
}

if($login_fabrica == 74){
        include_once "classes/FechamentoOS.php";

        $fechamentoOS = new FechamentoOS();
}

include_once 'class/AuditorLog.php';

//hd-3283021 - fputti
//Verifica se a os veio pelo callcenter, se sim redireciona para os cadatros para o mesmo selecionar o tipo de atendimento.
if (in_array($login_fabrica, array(50))) {// Verifica se o posto é Interno
    $os = $_GET["os"];
    if(!empty($os)) {
        $sql = "SELECT os
            FROM tbl_os
            WHERE tbl_os.fabrica={$login_fabrica}
            AND tbl_os.os={$os}
            AND tbl_os.hd_chamado IS NOT NULL
            AND tbl_os.tipo_atendimento IS NULL";
        $res = pg_query($con,$sql);

        if( pg_num_rows($res) > 0) {

            echo '<script>
                alert("Por favor, insira o Tipo de Atendimento");
            window.location.href="os_cadastro.php?os='.$os.'";
              </script>';
        exit;
        }
    }
}

if (in_array($login_fabrica, array(137,141,144,94))) {// Verifica se o posto é Interno

    $sql = "SELECT posto
              FROM tbl_posto_fabrica
              JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto
                                 AND tbl_tipo_posto.fabrica    = tbl_posto_fabrica.fabrica
                                 AND tbl_tipo_posto.posto_interno
             WHERE tbl_posto_fabrica.fabrica = $login_fabrica
               AND tbl_posto_fabrica.posto   = $login_posto";
    $res = pg_query($con,$sql);

    $posto_interno = (pg_num_rows($res) > 0);
}

if($login_fabrica == 30){ //HD-3027234
    $os = $_GET["os"];
	if(!empty($os)) {
		$sqlStatusOS = "SELECT status_os FROM tbl_os_status WHERE tbl_os_status.os = $os AND status_os IN (102, 103, 104) ORDER BY data DESC LIMIT 1";
		$resStatusOS = pg_query($con, $sqlStatusOS);

		if(pg_num_rows($resStatusOS) > 0){
			$statusNumeroSerie = pg_fetch_result($resStatusOS, 0, 'status_os');
			if(in_array($statusNumeroSerie,array(102,104))){
				header("Location: os_press.php?os=$os");
				exit;
			}
		}
	}
}

### HD-2181938 - INICIO ###

if($login_fabrica == 131){
    $os = $_GET["os"];

    if (strlen($os)>0){
       $select = "SELECT os FROM tbl_os WHERE fabrica = {$login_fabrica} AND os = {$os}";
       $result = pg_query($con, $select);

       if(pg_num_rows($result) > 0){
           $sql = "SELECT auditoria.os
               INTO TEMP tmp_auditoria_pedido_peca_produto
               FROM (
                 SELECT ultimo_status.os, (
                    SELECT status_os
                      FROM tbl_os_status
                     WHERE tbl_os_status.os             = ultimo_status.os
                       AND tbl_os_status.fabrica_status = $login_fabrica
                       AND status_os IN (203,204,205)
                  ORDER BY os_status DESC LIMIT 1) AS ultima_os_status
                   FROM (
                     SELECT DISTINCT os
                       FROM tbl_os_status
                      WHERE tbl_os_status.fabrica_status = $login_fabrica
                       AND status_os IN (203,204,205)
                   ) ultimo_status) auditoria
              WHERE auditoria.ultima_os_status IN (205);";
           $res = pg_query($con, $sql);

           $sqlOs = "SELECT
                tbl_os.os AS os_interv
               FROM tbl_os
               WHERE tbl_os.fabrica = 131
               AND tbl_os.os IN ( SELECT os FROM tmp_auditoria_pedido_peca_produto );";
           $resOs = pg_query($con, $sqlOs);

           if(pg_num_rows($resOs) > 0){

               $cont = pg_num_rows($resOs);

               for ($i=0; $i < $cont ; $i++) {
                   $osInterv = pg_fetch_result($resOs, $i, 'os_interv');
                   if($osInterv === $os){
                       header("Location: os_press.php?os=$os");
                       exit;
                   }
               }
           }
       }
    }
}
### HD-2181938 - FIM ###

/**
 * AJAX para carregar select de
 * fornecedores por peça
 * @author William Ap. Brandino
 */
if($_POST['ajax'] == "fornecedor_peca"){
    $ajax_peca = $_POST['ajax_peca'];
    $ajax_tipo = $_POST['tipo'];

   /**
    * - Entra nesse IF somente se
    * na requisição do AJAX, vier um KIT
    *
    * @param String $ajax_tipo
    */
    if($ajax_tipo == "kit"){
        $sqlKit = " SELECT tbl_kit_peca_peca.peca
                    FROM    tbl_kit_peca_peca
                    JOIN    tbl_kit_peca USING (kit_peca)
                    WHERE   tbl_kit_peca.referencia = '$ajax_peca'
                    AND     tbl_kit_peca.fabrica    = $login_fabrica
        ";
        $resKit = pg_query($con,$sqlKit);
        $contaKit = pg_numrows($resKit);

        if($contaKit == 1){
           /**
            * - Caso a busca pelo kit traga
            * somente UMA peça
            * Retorna a busca de fornecedores da peça
            */
            $ajax_peca_busca = pg_fetch_result($resKit,0,peca);

            $sqlAjax = "
                SELECT  tbl_fornecedor_peca.fornecedor  AS retorno_fornecedor_peca      ,
                        tbl_fornecedor.nome             AS retorno_fornecedor_peca_nome
                FROM    tbl_fornecedor_peca
                JOIN    tbl_fornecedor  ON  tbl_fornecedor.fornecedor   = tbl_fornecedor_peca.fornecedor
                                        AND tbl_fornecedor_peca.peca    = $ajax_peca_busca
                WHERE   tbl_fornecedor_peca.fabrica = $login_fabrica
            ";
        }else if($contaKit > 1){
           /**
            * - Caso a busca pelo kit traga
            * MAIS DE UMA peça
            * Retorna a INTERSECÇÃO de fornecedores
            * das peças presentes no kit
            */

            $sqlAjax = "
                SELECT * FROM (
                    (
            ";

            for($c = 0; $c < $contaKit; $c++){
                $ajax_peca_busca = pg_fetch_result($resKit,$c,peca);
                if($c > 0){
                    $sqlAjax .= "
                        ) INTERSECT (
                    ";
                }
                $sqlAjax .= "
                    SELECT  tbl_fornecedor_peca.fornecedor  AS retorno_fornecedor_peca      ,
                            tbl_fornecedor.nome             AS retorno_fornecedor_peca_nome
                    FROM    tbl_fornecedor_peca
                    JOIN    tbl_fornecedor  ON  tbl_fornecedor.fornecedor   = tbl_fornecedor_peca.fornecedor
                                            AND tbl_fornecedor_peca.peca    = $ajax_peca_busca
                    WHERE   tbl_fornecedor_peca.fabrica = $login_fabrica
                ";
            }

            $sqlAjax .= "
                    )
                ) AS forn
            ";
        }
    }else{
       /**
        * - No ELSE, somente quando não vier
        * requisição do ajax por kit
        * @param String $ajax_peca
        */
        $sqlAjax = "
            SELECT  tbl_fornecedor_peca.fornecedor  AS retorno_fornecedor_peca      ,
                    tbl_fornecedor.nome             AS retorno_fornecedor_peca_nome
            FROM    tbl_fornecedor_peca
            JOIN    tbl_fornecedor  ON  tbl_fornecedor.fornecedor   = tbl_fornecedor_peca.fornecedor
            JOIN    tbl_peca        ON  tbl_peca.peca               = tbl_fornecedor_peca.peca
                                    AND tbl_peca.referencia         = '$ajax_peca'
            WHERE   tbl_fornecedor_peca.fabrica = $login_fabrica
        ";
    }
// echo $sqlAjax;
    $resAjax = pg_query($con,$sqlAjax);

    if(pg_numrows($resAjax) > 0){
        $retorno = pg_fetch_all($resAjax);
        foreach($retorno as $k => $v){
            $montaSelect[(int)$v['retorno_fornecedor_peca']] = utf8_encode($v['retorno_fornecedor_peca_nome']);
        }
        echo json_encode($montaSelect);
    }else{
        echo "erro";
    }
    exit;
}

if($_GET['defeitos_checklist'] == 'true'){ //HD-2881143NEW
    $familia            = $_GET['id_familia'];
    $defeito_constatado = $_GET['defeito_constatado'];

    $sql = "SELECT checklist_fabrica,
                    codigo,
                    descricao
                FROM tbl_checklist_fabrica
                WHERE fabrica = $login_fabrica
                AND familia = $familia
                AND defeito_constatado = $defeito_constatado";
    $res = pg_query($con, $sql);
    if(pg_num_rows($res) > 0){
        $rows = pg_num_rows($res);
        $html = "<td align='left' style='padding-top:1em' id='$defeito_constatado'>
            <table width='700' align='center' border='0' cellspacing='0' cellpadding='5' class='formulario'>
                <tbody>
                    <tr>";
                        for ($i=0; $i < $rows; $i++) {
                            $checklist_fabrica = pg_fetch_result($res, $i, 'checklist_fabrica');
                            $codigo = pg_fetch_result($res, $i, 'codigo');
                            $descricao = pg_fetch_result($res, $i, 'descricao');
                            if (mb_check_encoding($descricao, "UTF-8")) {
                                $descricao = utf8_decode($descricao);
                            }
                            if(($i % 2) <> 0){
                              $html.="<td align='left' style='padding-top:1em'>
                                         <input type='checkbox' name='check_list_fabrica[]' value='$checklist_fabrica'> $codigo - $descricao
                                    </td></tr>";
                            } else{
                              $html.="<tr><td align='left' style='padding-top:1em'>
                                         <input type='checkbox' name='check_list_fabrica[]' value='$checklist_fabrica'> $codigo - $descricao
                                    </td>";
                            }
                        }
        $html .="</tr>
                    </tbody>
                </table>
            </td>";
            echo $html;exit;
    }else{
        echo "false";
    }
    exit;
}

if (isset($_POST['defeito_constatado_solucao'])) {

    $defeito_constatado = $_POST['defeito_constatado_solucao'];

    $querySolucao = "SELECT DISTINCT d.solucao, s.descricao
                     FROM tbl_diagnostico as d
                     JOIN tbl_solucao as s 
                        ON (s.solucao = d.solucao)
                     WHERE d.defeito_constatado = $defeito_constatado  
                     AND s.ativo = 't' 
                     AND d.fabrica = $login_fabrica";

    $res = pg_query($con, $querySolucao);

    $solucoes = [];

    for ($i = 0; pg_num_rows($res) > $i; $i++) {

        $id   = pg_fetch_result($res, $i, solucao);
        $desc = pg_fetch_result($res, $i, descricao);

        $solucoes[$id] = utf8_encode($desc);
        
    }

    exit(json_encode($solucoes));
    
}


/**
 * - AJAX para adicionar/remover data de visita
 * do posto na revenda para vistoria do produto
 *
 * @author William Ap. Brandino
 */

if($_POST['ajax'] == "agenda_visita"){
    $os          = $_POST['os'];
    $os_visita   = $_POST['os_visita'];
    $data_agenda = $_POST['data_agenda'];
    $tipo        = $_POST['tipo'];
    $justificativa = $_POST['justificativa'];

    if(empty($justificativa)) $justificativa = "null";
    $aux_data = explode("/",$data_agenda);
    $data_grava = $aux_data[2]."-".$aux_data[1]."-".$aux_data[0];

    $sql = pg_query($con,"BEGIN TRANSACTION");

    if($tipo == "gravar"){

        $sql = "INSERT INTO tbl_os_visita(
                        os,
                        data,
                        justificativa
                    ) VALUES (
                        $os,
                        '$data_grava',
                        $justificativa
                    ) RETURNING os_visita;";
        $res = pg_query($con,$sql);
        $os_visita = pg_fetch_result($res,0,os_visita);

        $texto = "Data agendamento: O Posto informou a seguinte data de agendamento {$data_agenda}";

        $sql = "INSERT INTO tbl_os_interacao
                    (programa,fabrica, os,  comentario, interno, exigir_resposta)
                    VALUES
                    ('$programa_insert',$login_fabrica, $os, '$texto', TRUE, FALSE)";
        $res = pg_query($con,$sql);

        if (in_array($login_fabrica, array(50))) {
            $sqlStatusCheck = "SELECT status_checkpoint FROM tbl_os WHERE os = $os;";
            $resStatusCheck = pg_query($con, $sqlStatusCheck);
            $xstatus_checkpoint = pg_fetch_result($resStatusCheck, 0, status_checkpoint);

            if ($xstatus_checkpoint == 0) {
                $sqlUpCheckpoint = "UPDATE tbl_os SET status_checkpoint = 1 WHERE os = $os;";
                $resUpCheckpoint = pg_query($con, $sqlUpCheckpoint);
            }
        }



        if($os_visita == ""){
            $sql = pg_query($con,"ROLLBACK TRANSACTION");
            echo "erro";
        }else{
            $sql = pg_query($con,"COMMIT TRANSACTION");
            echo json_encode(array("os_visita",$os_visita));
        }
    }
    if($tipo == "apagar"){

        $sql = "SELECT data FROM tbl_os_visita WHERE os_visita = {$os_visita};";
        $res = pg_query($con, $sql);
        $data_agenda = pg_fetch_result($res, 0, data);
        $data_agenda = date("d/m/Y", strtotime($data_agenda));

        $texto = "Data agendamento: O Posto excluiu a seguinte data de agendamento {$data_agenda}";

        $sql = "DELETE FROM tbl_os_visita WHERE os_visita = {$os_visita};";
        $res = pg_query($con,$sql);

        $sql = "INSERT INTO tbl_os_interacao
                        (programa,fabrica, os,  comentario, interno, exigir_resposta)
                    VALUES
                        ('$programa_insert',$login_fabrica, $os, '$texto', TRUE, FALSE)";
        $res = pg_query($con,$sql);

        if(!pg_last_error($con)){
            $sql = pg_query($con,"COMMIT TRANSACTION");
            echo json_encode(array("sucesso", "sim"));
        }else{
            $sql = pg_query($con,"ROLLBACK TRANSACTION");
            echo "erro";
        }
    }
    if ($tipo == "verificar") {
        $sql = "SELECT
                    tbl_os_visita.hora_chegada_cliente
                FROM tbl_os_visita
                    LEFT JOIN tbl_justificativa USING(justificativa)
                WHERE justificativa = {$justificativa} AND tbl_os_visita.os = {$os} AND hora_chegada_cliente IS NOT NULL";
        $res = pg_query($con, $sql);
        if (pg_num_rows($res) > 0) {
            exit(json_encode(array('error' => utf8_encode('Não será possível agendar uma avaliação inicial pois já existe um agendamento realizado e confirmado a visita'))));
        }
        exit(json_encode(array('ok' => utf8_encode('O registro não existe'))));
    }
    exit;
}

if(!in_array($login_fabrica,array(11,172))){
    include_once('anexaNF_inc.php');
}

/*HD-3601428*/
$fabrica_exclui_anexo = in_array($login_fabrica, array(42));

if(in_array($login_fabrica, array(42))){
    $amazonTC = new AmazonTC("os", $login_fabrica);
}

if(in_array($login_fabrica, array(42)) && $_POST["deletar_imagem_os"] == 'true'){
    if(strlen($_POST["file"]) > 0){
        if($amazonTC->deleteObject($_POST["file"], false,"","")){
            $resp = json_encode(array('apagado' => "true" ));
            echo $resp;
            exit;
        }
    }
}
if ($login_fabrica == 42) {
    if ($_POST['ajax'] == 'excluir_nf') {
        $img_nf     = anti_injection($_POST['excluir_nf']);
        $nome_anexo = anti_injection($_POST['anexo_nome']);
        $excluiu    = excluirNF($img_nf);

        if ($excluiu) {
            $html = temNF(preg_replace('/^(\d+).*$/', '$1', $nome_anexo), 'linkEx') ? : $inputNotaFiscal;
            die("ok|$html|$nome_anexo|$nome_anexo");
        }
        if (!$excluiu) die($ret = 'ko|Não foi possível excluir o arquivo solicitado.');
;
    }
}

if(isset($_POST['verifica_numero_serie'])){

    $lote               = $_POST['lote'];
    $referencia_produto = $_POST['referencia_produto'];

    $letra      = substr($lote, 0, 1);
    $dias       = substr($lote, 1, 3);
    $ano_lote   = substr($lote, 4, 2);
    $ref_prod   = substr($lote, 6, 4);

    if(strlen($lote) <= 10){

        $ano_atual = date("y");

        if(strtoupper($letra) <> "P"){
            echo "auditoria";
        }else if($dias > 366){
            echo "auditoria";
        }else if($ano_atual <> $ano_atual){
            echo "auditoria";
        }else if($ref_prod <> $referencia_produto){
            echo "auditoria";
        }else{
            echo "ok";
        }

    }else{
        echo "auditoria";
    }

    exit;

}

if( in_array($login_fabrica, array(11,172)) ){
    $os = $_GET["os"];

    $sql = "SELECT os from tbl_os_troca where os = {$os} ";
    $res = pg_query($con,$sql);
    // se houver OS na tbl_os_troca, não mostra botão de lançar itens.
    $rows_troca = pg_num_rows($res);
    if($rows_troca>0){

        header("Location: os_press.php?os=$os");
        exit;

    }
}
#HD 311414 FIM
if($login_fabrica == 74){
    include_once "class/email/mailer/class.phpmailer.php";
}
if ($S3_sdk_OK) {
    include_once S3CLASS;
    $s3ve = new anexaS3('ve', (int) $login_fabrica);
    $S3_online = is_object($s3ve);
}

if ( in_array($login_fabrica, array(3,11,125,126,137,172)) ) {
    # A class AmazonTC está no arquivo assist/class/aws/anexaS3.class.php
    $amazonTC = new AmazonTC("os", $login_fabrica);
}

if($login_fabrica == 42){
    $sql_prestacao = "  SELECT  tbl_posto_fabrica.prestacao_servico
                        FROM    tbl_posto_fabrica
                        WHERE   posto = $login_posto
                        AND     fabrica = $login_fabrica
    ";
    $res_prestacao      = pg_query($con,$sql_prestacao);
    $prestacao_servico  = pg_fetch_result($res_prestacao,0,prestacao_servico);
}
if($login_fabrica == 125){
    //Serviços que geram pedido
    $servicosGeramPedido = array();
    $servGeraPedido = " SELECT servico_realizado
                        FROM tbl_servico_realizado
                        WHERE fabrica = $login_fabrica AND
                        gera_pedido is true";
    $res_geraPedido = pg_query($con, $servGeraPedido);
    $count = pg_num_rows($res_geraPedido);
    for ($i=0; $i < $count; $i++) {
        $servicosGeramPedido[] = pg_fetch_result($res_geraPedido, $i, $servico_realizado);
    }

    $arrPecaCriticaGeraPedido= array();
    $arrPecaCriticaSemFoto = array();
    if($_POST["deletaImagem"] == "true"){
        $os = $_POST["os"];
        $peca_remover = $_POST["peca_remover"];
        $i = $_POST["i"];
        $amazonTC->getObjectList("peca_critica-{$os}-{$peca_remover}-{$i}");
        $pathinfo = pathinfo($amazonTC->files[0]);
        $file = $pathinfo["basename"];
        $amazonTC->deleteObject($file,false,"","");
        $respJson = json_encode(array("deletado"=>"true"));
        echo $respJson;
        exit;
    }

    if($_GET["verifica_peca_critica"]=="true"){
        $peca = $_GET["peca"];
        $sql = "SELECT peca_critica,
                       referencia,
                       descricao
                FROM tbl_peca
                WHERE fabrica = {$login_fabrica} AND
                      referencia = '{$peca}'";
        $res = pg_query($con,$sql);
        $peca_critica = pg_fetch_result($res, 0, 'peca_critica');
        $referencia   = pg_fetch_result($res, 0, 'referencia');
        $descricao    = pg_fetch_result($res, 0, 'descricao');
        if($peca_critica == "t"){
            $respJson = json_encode(array('critica' => "true", "referencia" => utf8_encode($referencia), "descricao" => utf8_encode($descricao) ));
        }else{
            $respJson = json_encode(array('critica' => "false", "referencia" => utf8_encode($referencia), "descricao" => utf8_encode($descricao) ));
        }
        echo $respJson;
        exit;
    }

}

include_once 'ajax_cabecalho.php';

$sql_controla_estoque = "SELECT controla_estoque FROM tbl_posto_fabrica WHERE fabrica = $login_fabrica AND posto = $login_posto;";
$res_controla_estoque = pg_query($con,$sql_controla_estoque);
$controla_estoque     = pg_result($res_controla_estoque, 0, 'controla_estoque');

$php_self = $_SERVER['PHP_SELF'];

#HD 670818 -  INICIO

$usam_os_cadastro_unico = array(85,87); //20
if (in_array($login_fabrica, $usam_os_cadastro_unico)) {
    include_once("os_cadastro_unico.php");
    exit;
}

if ($S3_sdk_OK) {
    include_once S3CLASS;
    $s3_ge = new anexaS3('ge', (int) $login_fabrica); //Anexo garantia estendida para Elgin
    $S3_online = is_object($s3_ge);
}

$loop_itens = 0;

/* Foram retirados os arrays, agora essas inforamçoes estão na tbl_fabrica no campo parametros_adicionais. As variáveis estão sendo montadas no arquivo autentica_usuario.php -- Ronald (HD-1010800)

$fabricas_padrao_itens             = array(81,94,98,99,114,115,116);
$fabrica_verifica_status_os        = in_array($login_fabrica,array(2,3,6,11,25,45,50,51,81,98,106,108,111,114));
$fabrica_exigi r_defeito_constatado = in_array($login_fabrica,array(3,6,24,42,45,80,81,91,114,115,116));
$fabrica_solucao_os_obrigatoria    = in_array($login_fabrica,array(42, 50, 52, 74, 81, 86, 94, 95, 104, 105, 114,115,116));
$fabrica_pesquisa_lbm_inativo      = in_array($login_fabrica, array(3,81,114)); /*HD: 79762 03/03/2009 DEIXAR APENAS A BUSCA PELA LISTA BÁSICA MESMO QUANDO O PRODUTOS ESTIVER INATIVO
*/

#HD 670818 -  FIM
//HD 56418 Candece
if ((in_array($login_fabrica, array(35,40,50)) OR $login_fabrica >= 126) && $login_fabrica != 172 ) {

    $os = $_GET['os'];

    if (strlen($os) > 0) {

        $sql = "SELECT os, status_os FROM tbl_os_status WHERE os = $os ORDER BY data DESC LIMIT 1";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0) {

            $status_os = pg_fetch_result($res, 0, 'status_os');

            if (in_array($login_fabrica, array(35,40,50)) OR $login_fabrica >= 126) {

                if ($status_os == 118) {
                    header("Location: os_press.php?os=$os");
                    exit;
                }
            } else {
                if ($status_os == "118" OR $status_os == "127") {
                    header("Location: os_em_auditoria.php?os=$os");
                    exit;
                }
            }
        }
    }
}

if($login_fabrica == 74 && isset($_POST['limpa_movimento_estoque']) && isset($_POST['servico'])){

    $os         = $_POST['os'];
    $servico    = $_POST['servico'];
    $qtde       = $_POST['qtde'];
    $referencia = $_POST['referencia'];

    /* hd_chamado=2782600
    if (strlen($servico)>0){
        $sql_tipo_estoque = "SELECT ressarcimento
                FROM tbl_servico_realizado
                WHERE fabrica = $login_fabrica AND servico_realizado = $servico";
        $res_tipo_estoque = pg_query($con, $sql_tipo_estoque);

        if(pg_num_rows($res_tipo_estoque) > 0){
            $ressarcimento = pg_result($res_tipo_estoque, 0, 'ressarcimento');
            $tipo_estoque = ($ressarcimento == 't') ? "estoque" : "pulmao";
        }
    }
    */
    $tipo_estoque = "estoque";
    $sql_qtde_saida = "SELECT qtde_saida, peca FROM tbl_estoque_posto_movimento WHERE os = $os AND fabrica = $login_fabrica AND posto = $login_posto";
    $res_qtde_saida = pg_query($con, $sql_qtde_saida);

    if(pg_num_rows($res_qtde_saida) > 0){

        $qtde_saida = pg_result($res_qtde_saida, 0, 'qtde_saida');
        $peca       = pg_result($res_qtde_saida, 0, 'peca');

        $sql_servico_update = "UPDATE tbl_estoque_posto
                               SET qtde = qtde + $qtde_saida
                               WHERE
                               fabrica = $login_fabrica
                               AND posto = $login_posto
                               AND tipo = '$tipo_estoque'
                               AND peca = $peca";
        $res_servico_update = pg_query($con, $sql_servico_update);

        $sql_delete_movimentacao = "DELETE FROM tbl_estoque_posto_movimento WHERE os = $os AND fabrica = $login_fabrica AND posto = $login_posto AND tipo = '$tipo_estoque'";
        $res_delete_movimentacao = pg_query($con, $sql_delete_movimentacao);

    }

    exit;

}

if(in_array($login_fabrica,array(134)) &&isset($_POST['estoque_minimo'])){

    $peca = $_POST['peca_estoque_minimo'];

    $sql = "SELECT qtde
                FROM tbl_estoque_posto
                JOIN tbl_peca ON tbl_estoque_posto.peca = tbl_peca.peca AND tbl_peca.fabrica = $login_fabrica
                WHERE tbl_estoque_posto.fabrica = $login_fabrica
                AND tbl_estoque_posto.posto = $login_posto
                AND tbl_peca.referencia = '$peca'
                AND tbl_estoque_posto.tipo = 'garantia'
                AND tbl_estoque_posto.qtde <= tbl_estoque_posto.estoque_minimo
                AND tbl_estoque_posto.qtde > 0";
    $res = pg_query($con,$sql);

    if(pg_num_rows($res) > 0){
        echo "estoque_minimo";
    }

    exit;
}

if($login_fabrica == 50 AND isset($_POST['comunicado_fora_garantia'])){ //HD-3246942
    $peca_ref = $_POST['referencia'];
    $sql_garantia = "SELECT tbl_peca.peca
                        FROM tbl_peca
                        WHERE referencia = '$peca_ref'
                        AND fabrica = $login_fabrica
                        AND bloqueada_garantia IS TRUE ";
    $res_garantia = pg_query($con, $sql_garantia);

    if(pg_num_rows($res_garantia) > 0){
        echo "bloqueada";
    }
    exit;
}

if(in_array($login_fabrica,array(35,74,134)) && isset($_POST['limpa_movimento_estoque2'])){

    $os         = $_POST['os'];
    $servico    = $_POST['servico'];
    $qtde       = $_POST['qtde'];
    $referencia = $_POST['referencia'];
    if(strlen(trim($referencia)) == 0){
        $referencia = $_POST['input_refpeca'];
    }

    /*
        Verifica se o campo ressarcimento do servico realizao é true
        se for true estoque antigo se não estoque pulmão
    */
    if (strlen($servico)>0){
        $sql_tipo_estoque = "SELECT ressarcimento
                            FROM tbl_servico_realizado
                            WHERE fabrica = $login_fabrica AND servico_realizado = $servico";
        $res_tipo_estoque = pg_query($con, $sql_tipo_estoque);

        if(pg_num_rows($res_tipo_estoque) > 0){

            $ressarcimento = pg_fetch_result($res_tipo_estoque, 0, 'ressarcimento');
            $tipo_estoque = ($ressarcimento == 't') ? "estoque" : "pulmao";

            if($login_fabrica == 134){
                $tipo_estoque = "garantia";
            }elseif($login_fabrica == 74){ //hd_chamado=2782600
                $tipo_estoque = "estoque";
            }

        }
    }

    // Pega o id da peça
    $sql_peca = "SELECT peca FROM tbl_peca WHERE referencia = '$referencia'";
    $res_peca = pg_query($con, $sql_peca);

    if (pg_num_rows($res_peca) > 0) {
        $peca = pg_fetch_result($res_peca, 0, 'peca');

        if($tipo_estoque == "pulmao" AND $login_fabrica <> 74){ // removendo if no hd_chamado=2782600

            $sql_vm = "SELECT qtde_saida
                       FROM tbl_estoque_posto_movimento
                       WHERE os = $os
                       AND fabrica = $login_fabrica
                       AND posto = $login_posto
                       AND peca = $peca
                       AND tipo = 'estoque'";
            $res_vm = pg_query($con, $sql_vm);

            if(pg_num_rows($res_vm) > 0){

                $qtde_saida = pg_fetch_result($res_vm, 0, 'qtde_saida');

                $sql_update = "UPDATE tbl_estoque_posto
                               SET qtde = qtde + $qtde_saida
                               WHERE fabrica = $login_fabrica
                               AND posto = $login_posto
                               AND tipo = 'estoque'
                               AND peca = $peca";
                $res_update = pg_query($con, $sql_update);

                $sql_dm = "DELETE FROM tbl_estoque_posto_movimento
                            WHERE os = $os
                            AND fabrica = $login_fabrica
                            AND posto = $login_posto
                            AND peca = $peca
                            AND tipo = 'estoque'";
                $res_dm = pg_query($con, $sql_dm);
            }
        }else{

            $tipo_estoque = ($login_fabrica == 74) ? "estoque" : $tipo_estoque;

            $sql_vm = "SELECT qtde_saida
                       FROM tbl_estoque_posto_movimento
                       WHERE os = $os
                       AND fabrica = $login_fabrica
                       AND posto = $login_posto
                       AND peca = $peca
                       AND tipo = '$tipo_estoque'";
            $res_vm = pg_query($con, $sql_vm);

            if(pg_num_rows($res_vm) > 0){

                $qtde_saida = pg_fetch_result($res_vm, 0, 'qtde_saida');

                $sql_update = "UPDATE tbl_estoque_posto
                               SET qtde = qtde + $qtde_saida
                               WHERE fabrica = $login_fabrica
                               AND posto = $login_posto
                               AND tipo = '$tipo_estoque'
                               AND peca = $peca";
                $res_update = pg_query($con, $sql_update);

                $sql_dm = "DELETE FROM tbl_estoque_posto_movimento
                            WHERE os = $os
                            AND fabrica = $login_fabrica
                            AND posto = $login_posto
                            AND peca = $peca
                            AND tipo = '$tipo_estoque'";
                $res_dm = pg_query($con, $sql_dm);
            }
        }
    }

    exit;

}

if ($_POST['ajax_carrega_falha_potencial']) {//fputti hd-3130038

    $defeito = $_POST['defeito'];

    if(!empty($defeito)) {
        $sql = "SELECT DISTINCT
            tbl_servico.descricao AS nome_falha,
            tbl_defeito_constatado.descricao AS nome_defeito,
            tbl_diagnostico.defeito_constatado,
            tbl_diagnostico.servico
            FROM    tbl_diagnostico
            JOIN tbl_servico ON tbl_servico.servico=tbl_diagnostico.servico
            JOIN tbl_defeito_constatado ON tbl_defeito_constatado.defeito_constatado=tbl_diagnostico.defeito_constatado
            WHERE tbl_diagnostico.fabrica = $login_fabrica
            AND  tbl_diagnostico.defeito_constatado = $defeito
            ORDER BY tbl_servico.descricao DESC;";

        $res   = pg_query($con,$sql);
        $qtd   = pg_num_rows($res);

        if ($qtd > 0) {
            $retorno       .= "<option value=''> Selecione ...</option>";
            for ($i=0; $i < $qtd; $i++) {
                $servico    = pg_fetch_result($res, $i, servico);
                $nome_falha = pg_fetch_result($res, $i, nome_falha);
                $nome_falha = mb_check_encoding($nome_falha, "UTF-8") ? utf8_encode(trim($nome_falha)) : trim($nome_falha); 
                $retorno   .= "<option value='".$servico."'>".$nome_falha."</option>";
            }
        } else {
            $retorno = "<option value=''> Nenhuma Falha em Potencial encontrada.</option>";
        }
    }else{
            $retorno = "<option value=''> Nenhuma Falha em Potencial encontrada.</option>";
    }
    echo $retorno;
    exit();
}

if($_GET['ajax_causa_defeito']){

    $defeitos = $_GET['defeitos'];

    $defeitos = str_replace('\\', '', $defeitos);

    $defeitos = json_decode($defeitos,true);

    forEach($defeitos as $value){
        $auxDefeitos[] = "'".$value."'";
    }

    $defeitos = implode(',', $auxDefeitos);

    if(strlen($defeitos) > 0) {
        $sql = "select distinct tbl_causa_defeito.causa_defeito, tbl_causa_defeito.codigo,tbl_causa_defeito.descricao from tbl_defeito
            join tbl_defeito_causa_defeito using(defeito)
            join tbl_causa_defeito using(causa_defeito)
            where codigo_defeito in($defeitos) and tbl_causa_defeito.fabrica = 131;";
        $res = pg_query($con,$sql);

        $contador_resd = pg_num_rows($res); 
        for ($i=0; $i < $contador_resd; $i++) {
            $causas[] = array('descricao' => utf8_encode(pg_fetch_result($res, $i, descricao)),'codigo' => pg_fetch_result($res, $i, 'causa_defeito'));
        }

        if(count($causas) > 0){
            $causasJson = json_encode($causas);
        }else{
            $causasJson = json_encode(array("erro" => "Nenhuma Causa relacionada aos defeitos"));
        }
    }

    echo $causasJson;
    exit;
}

if($_GET['ajax_nao_lanca_peca']){
    $defeito = $_GET['defeito'];

    if (strlen($defeito)>0){
        $sql = "SELECT lancar_peca
                FROM tbl_defeito_constatado
                WHERE defeito_constatado = $defeito
                AND fabrica = $login_fabrica";
        $res = pg_query($con,$sql);

            echo pg_fetch_result($res, 0, 'lancar_peca');
     }else{
            echo "f";
     }
    exit;
}

#HD 311414 - 24/03/2011 - Gabriel Silveira - INICIO - VERIFICA SE A OS TEM REGISTRO NA TBL_OS_TROCA, SE TIVER IRÁ REDIRECIONAR PARA os_finalizada.php
if ($login_fabrica == 6) {

    $os = $_GET['os'];

    if (strlen($os) > 0) {

        $sql = "Select os from tbl_os_troca where os = $os and fabric = $login_fabrica";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0) {
            header ("Location: os_finalizada.php?os=$os");
            exit;
        }
    }
}

// 14/01/2010 MLG - HD 189523
if ($login_fabrica == 15) {

    if (!function_exists("is_between")) {
        function is_between($valor,$min,$max) {   // BEGIN function is_between
            // Devolve 'true' se o valor está entre ("between") o $min e o $max
            return ($valor >= $min AND $valor <= $max);
        }
    }

    function valida_serie_latinatec($serie,$prod_min_ver,$prod_max_ver,$lbm_min_ver,$lbm_max_ver) {
        if (strlen(trim($serie)) < 3) return true;
        $serie_ok = false;
        $usar_serie_produto    = ($prod_min_ver != "" or $prod_max_ver != "");
        $usar_serie_lbm        = ($lbm_min_ver != "" or $lbm_max_ver != "");
        if (!$usar_serie_lbm and !$usar_serie_produto) $serie_ok = true;
        if (!$serie_ok) {
            $min_serie_prod = (trim($prod_min_ver) == "") ? " " : strtoupper($prod_min_ver);
            $max_serie_prod = (trim($prod_max_ver) == "") ? "z" : strtoupper($prod_max_ver);
            $min_serie_lbm  = (trim($lbm_min_ver)  == "") ? " " : strtoupper($lbm_min_ver);
            $max_serie_lbm  = (trim($lbm_max_ver)  == "") ? "z" : strtoupper($lbm_max_ver); // O minúsculo é proposital...

            $l = substr($serie, 6, 1);
            $mes = substr($serie, 9, 1);
            $dia = substr($serie, 10, 2);
            if ( ($l == 'L' || $l == 'R') && ($mes >= 'A' && $mes <= 'L') && ($dia >= 1 && $dia <= 31) ) {
                $serie = substr($serie, -8);
            } else {
               $serie = $serie[1];
            }

            if (is_between(strtoupper($serie),$min_serie_prod, $max_serie_prod) or !$usar_serie_produto) {
                if (is_between(strtoupper($serie),$min_serie_lbm, $max_serie_lbm)) {
                    $serie_ok = true;
                }
            }
        }
        return $serie_ok;
    }

    function valida_kit_latinatec($serie,$in,$out) { //hd_chamado=2552862

        if (strlen(trim($serie)) < 3) return true;

        $serie_ok = false;
        $usar_kit_produto   = ($in != "" or $out != "");

        if (!$in and !$out) $serie_ok = true;

        if (!$serie_ok) {
            $in = (trim($in)    == "") ? " " : strtoupper($in);
            $out = (trim($out)  == "") ? "Z" : strtoupper($out);
            
            $l = substr($serie, 6, 1);
            $mes = substr($serie, 9, 1);
            $dia = substr($serie, 10, 2);
            
            if ( ($l == 'L' || $l == 'R') && ($mes >= 'A' && $mes <= 'L') && ($dia >= 1 && $dia <= 31) ) {
                $serie = substr($serie, -8);
            } else {
                $serie = $serie[1];
            }
            if (is_between(strtoupper($serie),$in, $out) or !$usar_kit_produto) {
                $serie_ok = true;
            }

        }
        return $serie_ok;
    }

}

if ($login_fabrica == 3) {

    $xos = $_GET['os'];

    if (strlen($xos) == 0) {
        $xos = $_POST['os'];
    }

    if (strlen($xos) > 0) {

        $status_os = "";

        $sql = "SELECT status_os
                FROM  tbl_os_status
                WHERE os = $xos
                AND status_os IN (120,201, 122, 123, 126, 140, 141, 142, 143, 174)
                ORDER BY data DESC LIMIT 1";
        $res_intervencao = pg_query($con, $sql);
        $msg_erro        = pg_errormessage($con);

        if (pg_num_rows($res_intervencao) > 0) {

            $status_os = pg_fetch_result($res_intervencao,0,status_os);

            if (in_array($status_os,array(120,201,122,126,140,141,143))) {
                header("Location: os_press.php?os=$xos");
                exit;
            }

        }

    }

}

if ($login_fabrica == 5) {
    $os=$_GET['os'];
    header("Location: os_item_new_mondial.php?os=$os&reabrir=$reabrir");
    exit;
}

if ($login_fabrica == 35) {
    $sql = "SELECT status_os
            from tbl_os_status
            where os=$os and status_os in (62,64) order by data desc";
    $res = pg_query($con,$sql);

    if (pg_num_rows($res)>0) {
        $status_os = pg_fetch_result($res, 0, 0);
        if ($status_os == 62) {

            $sql = "SELECT sua_os from tbl_os where os=$os";
            $res = pg_query($con,$sql);

            $sua_os = pg_fetch_result($res, 0, 0);

            $sql = "SELECT tbl_os.produto
                    FROM tbl_os
                    join tbl_produto using(produto)
                    where tbl_os.os = $os
                    and tbl_produto.produto_critico is true";
            $res = pg_query($con,$sql);

            if (pg_num_rows($res)>0) {
                echo "<script>
                    alert('OS COM PRODUTO CRITICO E EM INTERVENÇÃO PELO FABRICANTE');
                    window.location = 'os_consulta_lite.php?btn_acao=ok&sua_os=$sua_os';
                </script>";
            }
        }
    }
}

if ($ajax == 'peca') {
    if (strlen(trim($referencia)) > 4) {
        $sql = "SELECT
                    produto
                FROM
                    tbl_os
                WHERE
                    os = $os
                AND
                    fabrica = $login_fabrica";
        $res = pg_query($con,$sql) ;
        $produto = pg_fetch_result($res,0,produto);

        $sql = "SELECT
                    peca,
                    referencia,
                    descricao
                FROM
                    tbl_peca
                JOIN
                    tbl_lista_basica USING (peca)
                WHERE
                    referencia = '{$referencia}'
                AND
                    tbl_peca.fabrica = {$login_fabrica}
                AND
                    tbl_lista_basica.produto = {$produto}
                AND
                    tbl_peca.ativo IS TRUE
                AND
                    produto_acabado IS NOT TRUE;";
        $res = pg_query($con,$sql);

        if (pg_num_rows($res) > 0) {
            $descricao = pg_fetch_result($res,0,descricao);
            echo "ok|$descricao";
        }
        else {
            echo "NO|NO";
        }
    }
    else {
        echo "NO|NO";
    }
    exit;
}

if ($ajax == 'defeito_constatado') {

    if (strlen(trim($defeito_constatado)) > 2) {

        $sql = "SELECT  tbl_linha.linha    ,
                        tbl_familia.familia
                FROM tbl_os
                JOIN tbl_produto USING(produto)
                JOIN tbl_linha   ON tbl_linha.linha     = tbl_produto.linha
                JOIN tbl_familia ON tbl_familia.familia = tbl_produto.familia
                WHERE tbl_os.fabrica = $login_fabrica
                AND   tbl_os.os      = $os";

        $res = pg_query($con,$sql) ;
        $produto_linha   = pg_fetch_result($res,0,'linha');
        $produto_familia = pg_fetch_result($res,0,'familia');

        if (pg_num_rows($res) > 0) {
        $sql = "SELECT DISTINCT (tbl_diagnostico.defeito_constatado),
                   tbl_defeito_constatado.descricao,
                   tbl_defeito_constatado.codigo
              FROM tbl_diagnostico
              JOIN tbl_defeito_constatado ON tbl_diagnostico.defeito_constatado = tbl_defeito_constatado.defeito_constatado and tbl_defeito_constatado.ativo
             WHERE tbl_diagnostico.linha   = $produto_linha
               AND tbl_diagnostico.familia = $produto_familia
               AND tbl_diagnostico.ativo
               AND tbl_defeito_constatado.codigo = '$defeito_constatado'
             ORDER BY tbl_defeito_constatado.descricao";

        $res = pg_query($con,$sql);

        if (pg_num_rows($res) > 0) {

            $defeito_constatado = pg_fetch_result($res,0,'defeito_constatado');
            $codigo             = pg_fetch_result($res,0,'codigo');
            $descricao          = pg_fetch_result($res,0,'descricao');
            echo "ok|$defeito_constatado|$codigo|$descricao";

        } else {

            echo "NO|NO $sql";

        }
    } else {

        echo "NO|NO $sql";

    }

    } else {

        echo "NO|NO";

    }

    exit;

}

if ($ajax == 'defeito_constatado_solucao') {

    if (strlen(trim($defeito_constatado)) > 2) {

        $sql = "SELECT  tbl_linha.linha    ,
                        tbl_familia.familia
                FROM tbl_os
                JOIN tbl_produto USING(produto)
                JOIN tbl_linha   ON tbl_linha.linha     = tbl_produto.linha
                JOIN tbl_familia ON tbl_familia.familia = tbl_produto.familia
                WHERE tbl_os.fabrica = $login_fabrica
                AND   tbl_os.os      = $os";

        $res = pg_query($con,$sql);

        $produto_linha   = (pg_num_rows($res) > 0) ? pg_fetch_result($res,0,'linha')   : '';
        $produto_familia = (pg_num_rows($res) > 0) ? pg_fetch_result($res,0,'familia') : '';

        if (pg_num_rows($res) > 0) {
        $sql = "SELECT DISTINCT (tbl_diagnostico.defeito_constatado),
                   tbl_defeito_constatado.descricao,
                  tbl_defeito_constatado.codigo,
                  tbl_solucao.solucao,
                  tbl_solucao.descricao as solucao_descricao
             FROM tbl_diagnostico
             JOIN tbl_defeito_constatado  ON tbl_diagnostico.defeito_constatado = tbl_defeito_constatado.defeito_constatado and tbl_defeito_constatado.ativo
             JOIN tbl_solucao             ON tbl_diagnostico.solucao            = tbl_solucao.solucao
            WHERE tbl_diagnostico.linha   = $produto_linha
              AND tbl_diagnostico.familia = $produto_familia
              AND tbl_diagnostico.ativo
              AND tbl_defeito_constatado.codigo = '$defeito_constatado'
            ORDER BY tbl_defeito_constatado.descricao";

        $res = pg_query($con,$sql);

        if (pg_num_rows($res) > 0) {

            $defeito_constatado = pg_fetch_result($res, 0, 'defeito_constatado');
            $codigo             = pg_fetch_result($res, 0, 'codigo');
            $descricao          = pg_fetch_result($res, 0, 'descricao');
            echo "ok|$defeito_constatado|$codigo|$descricao";

        } else {

            echo "NO|NO $sql";

        }
    }else{
            echo "NO|NO $sql";
    }
    } else {

        echo "NO|NO";

    }

    exit;

}

if ($ajax == "numero_serie") {

    $produto_referencia = $_POST['produto_referencia'];
    $numero_serie       = $_POST['numero_serie'];

    $sql = "
            SELECT
                produto,
                numero_serie_obrigatorio
            FROM tbl_produto
                JOIN tbl_linha ON tbl_linha.linha = tbl_produto.linha
            WHERE
                referencia = '$produto_referencia'
                AND tbl_linha.fabrica = $login_fabrica;";
    $res = pg_query($con,$sql);

    if (pg_num_rows($res) > 0) {

        if (pg_num_rows($res) == 1){
            $produto = pg_fetch_result($res, 0, 'produto');

            $sql = "SELECT numero_serie, serie, referencia_produto, data_fabricacao, tbl_produto.descricao, tbl_produto.produto
                    FROM tbl_numero_serie
                    JOIN tbl_produto ON tbl_numero_serie.produto = tbl_produto.produto AND tbl_produto.fabrica_i = $login_fabrica
                    WHERE serie = '$numero_serie';";
            $res = pg_query($con,$sql);

            if (pg_num_rows($res) > 0){
                $numero_serie      = pg_fetch_result($res,0,'serie');
                $referencia        = pg_fetch_result($res,0,'referencia_produto');
                $prod              = pg_fetch_result($res,0,'produto');
                $data_fabricacacao = pg_fetch_result($res,0,'data_fabricacao');
                $descricao         = pg_fetch_result($res,0,'descricao');

                echo "1|$numero_serie|$referencia|$prod|$data_fabricacacao|$descricao";
            }else{
                echo 2;
            }

           exit;
        }
    }

    echo 0;
    exit;

}

if($_GET['troca_prod']){
    $os = $_GET['os'];
    $produto = $_GET['produto'];

    $sql = "UPDATE tbl_os SET produto = $produto FROM tbl_produto WHERE os = $os AND fabrica = $login_fabrica AND posto = $login_posto AND tbl_produto.produto = $produto AND tbl_produto.ativo ";
    $res = pg_query($con,$sql);

    if(strlen(pg_errormessage($con) == 0)){
        echo "ok";
    } else {
        echo "NO";
    }
    exit;
}

if($ajax=='tipo_atendimento'){

    if(!empty($id)){
        $sql = "SELECT tipo_atendimento,km_google
                FROM tbl_tipo_atendimento
                WHERE tipo_atendimento = $id
                AND   fabrica          = $login_fabrica";
        $res = pg_query($con,$sql);
        if(pg_num_rows($res)>0){

            $km_google = pg_fetch_result($res,0,km_google);
            if($km_google == 't'){
                echo "ok|sim";
            }else{
                echo "no|nao";
            }

        }
    }
     exit;
}

if (strlen($_GET["peca_referencia"]) > 0 AND $_GET["peca_troca"] == "sim") {

    $referencia = trim($_GET["peca_referencia"]);

    $sql  = "SELECT peca
            FROM tbl_peca
            WHERE fabrica = $login_fabrica
            AND   referencia ='$referencia'
            AND   troca_obrigatoria IS TRUE";

    $res = pg_query($con,$sql);

    if (pg_num_rows($res) > 0) {
        echo "sim";
    }

    exit;

}

$atualiza_serie_trocada = $_GET['atualiza_serie_trocada'];

if (strlen($atualiza_serie_trocada) == 0) {
    $atualiza_serie_trocada = $_POST['atualiza_serie_trocada'];
}

if (strlen($atualiza_serie_trocada) > 0) {

    $os_item        = $_GET["os_item"];
    $serie_trocada  = $_GET["serie_trocada"];

    if (strlen($os_item) > 0 and strlen($serie_trocada) > 0) {

        $sql = "UPDATE tbl_os_item SET peca_serie_trocada ='$serie_trocada'
                WHERE os_item = $os_item";

        $res      = pg_query($con,$sql);
        $msg_erro = pg_errormessage($con);

        if (strlen($msg_erro) == 0) {
            echo "Atualizado com Sucesso!";
        } else {
            echo "Ocorreu o seguinte erro $msg_erro";
        }

    }

    exit;

}

if (strlen($os) > 0 AND (strlen($defeito_reclamado) > 0 or count($defeito_reclamado) >0) AND $login_fabrica == 19) {
    $tipo_atend = $_POST['osg'];
    $cond = "";
	$defeito_reclamado = is_array($defeito_reclamado) ? $defeito_reclamado[0] : $defeito_reclamado;
    if($tipo_atend)
		$cond = ",tipo_atendimento = $tipo_atend";

    $sql = "UPDATE tbl_os SET defeito_reclamado = $defeito_reclamado".$cond." WHERE os = $os AND fabrica = $login_fabrica";

    $res = pg_query($con,$sql);
}

if (strlen($os) > 0 and $defeito == 'defeito') {

    echo "<h2 style='font-family:Verdana'>".$tema."</h2>";

    if (strlen($defeito_constatado_codigo) > 0 OR strlen(trim($defeito_constatado_descricao)) > 2 OR $login_fabrica == 43) {

        $sql = "SELECT tbl_linha.linha    ,
                       tbl_familia.familia
                  FROM tbl_os
                  JOIN tbl_produto    USING(produto)
                  JOIN tbl_linha      ON tbl_linha.linha     = tbl_produto.linha
                  JOIN tbl_familia    ON tbl_familia.familia = tbl_produto.familia
                 WHERE tbl_os.fabrica = $login_fabrica
                   AND tbl_os.os      = $os";

        $res = pg_query($con,$sql);
        $produto_linha   = pg_fetch_result($res,0,'linha');
        $produto_familia = pg_fetch_result($res,0,'familia');
        $defeito_constatado_codigo_t = trim($defeito_constatado_codigo);
        if (strlen($defeito_constatado_codigo_t) > 0)
            $sql_a1 = " AND  tbl_defeito_constatado.codigo like '%$defeito_constatado_codigo%' ";

        if (strlen($defeito_constatado_descricao) > 0)
            $sql_a1 = " AND  upper(tbl_defeito_constatado.descricao) like upper('%$defeito_constatado_descricao%') ";

        $sql = "SELECT DISTINCT (tbl_diagnostico.defeito_constatado),
                       tbl_defeito_constatado.descricao,
                       tbl_defeito_constatado.codigo
                  FROM tbl_diagnostico
                  JOIN tbl_defeito_constatado ON tbl_diagnostico.defeito_constatado = tbl_defeito_constatado.defeito_constatado and tbl_defeito_constatado.ativo
                 WHERE tbl_diagnostico.linha   = $produto_linha
                   AND tbl_diagnostico.familia = $produto_familia
                   AND tbl_diagnostico.ativo
                   AND tbl_defeito_constatado.ativo IS TRUE
                   $sql_a1
                 ORDER BY tbl_defeito_constatado.descricao";

        $res = pg_query($con,$sql);

        if (pg_num_rows($res) > 0) {

            echo "<table style='font-family:verdana;font-size:12px;'>";
            echo "<tr bgcolor='#336699' style='color:#FFFFFF'>";

            if (!in_array($login_fabrica,array(43,114))) echo "<Th>Código</th>";

            echo "<th>Descrição</th>";
            echo "</tr>";

            $contador_res_0 = pg_num_rows($res);

            for ($i = 0; $i < $contador_res_0; $i++) {

                $defeito_constatado = pg_fetch_result($res,$i,'defeito_constatado');
                $codigo             = pg_fetch_result($res,$i,'codigo');
                $descricao          = pg_fetch_result($res,$i,'descricao');

		if ($login_fabrica == 30) {
			$buscaSolucao = "window.opener.listaSolucao({$defeito_constatado}, {$produto_linha}, null, {$produto_familia});";
		}

                echo "<tr>";

                if (!in_array($login_fabrica,array(43,114))) echo "<td><a href=\"javascript: defeito_constatado.value='$defeito_constatado';defeito_constatado_codigo.value='$codigo';defeito_constatado_descricao.value='$descricao';{$buscaSolucao}this.close();\">$codigo</a></td>";

                echo "<td><a href=\"javascript: defeito_constatado.value='$defeito_constatado';defeito_constatado_codigo.value='$codigo';defeito_constatado_descricao.value='".addslashes($descricao)."';{$buscaSolucao}this.close();\">$descricao</a></td>";
                echo "</tr>";

            }

            echo "</table>";

        } else if (!in_array($login_fabrica,array(43,114))) {

            echo "<h4 style='color:#FF0000'>Nenhum defeito com o código: $defeito_constatado_codigo</h4>";

        } else {

            echo "<h4 style='color:#FF0000'>Nenhum defeito com a descrição: $defeito_constatado_descricao</h4>";

        }

    } else if (!in_array($login_fabrica,array(43,114))) {

        echo "<h4 style='color:#FF0000'>Nenhum defeito com o código: $defeito_constatado_codigo</h4>";

    } else {

        echo "<h4 style='color:#FF0000'>Nenhum defeito com a descrição: $defeito_constatado_descricao</h4>";

    }

    echo "<br><center><a href='javascript:this.close();'>[Fechar]</a></center>";

    exit;

}

if($login_fabrica == 19){ //hd_chamado=2881143
    if($_GET['id_defeito_constatado_reclamado']){

        $os_id = $_GET['os'];
        $defeito_pecas    = $_GET['defeito_constatado_pecas'];
        $pecas_lancadas_os  = $_GET['pecas_lancadas'];
        $pecas_lancadas_os = explode(',', $pecas_lancadas_os);
        $deletar = array();

        $id_defeito_constatado_reclamado = $_GET['id_defeito_constatado_reclamado'];


        // $sql_delete = "DELETE FROM tbl_os_defeito_reclamado_constatado
        //                     WHERE os=$os
        //                     AND defeito_constatado = $id_defeito_constatado_reclamado";
        // echo $sql_delete;exit;
        // $res_delete = pg_query($con, $sql_delete);


        foreach ($pecas_lancadas_os as $key => $value) {
            $sql_valida_pecas = "SELECT tbl_peca.peca
                    FROM tbl_peca
                    JOIN tbl_peca_familia ON tbl_peca_familia.peca = tbl_peca.peca AND tbl_peca_familia.fabrica = $login_fabrica
                    JOIN tbl_defeito_constatado_familia_peca ON tbl_defeito_constatado_familia_peca.familia_peca = tbl_peca_familia.familia_peca
                        AND tbl_defeito_constatado_familia_peca.fabrica = $login_fabrica
                    WHERE tbl_peca.referencia = '$value'
                    AND tbl_defeito_constatado_familia_peca.defeito_constatado IN ($defeito_pecas)";
            $res_valida_pecas = pg_query($con, $sql_valida_pecas);

            if(pg_num_rows($res_valida_pecas) == 0){
                $deletar[] = $value;
            }
        }
        exit(json_encode($deletar));
    }
}



if($_GET['ajax_servico']){
    $servico = $_GET['servico'];

    $sql = "SELECT peca_estoque
                    FROM tbl_servico_realizado
                    WHERE servico_realizado = $servico
                    AND fabrica = $login_fabrica";
    $res = pg_query($con,$sql);

    if(pg_num_rows($res) > 0){
        $peca_estoque = pg_fetch_result($res, 0, 'peca_estoque');

        if($peca_estoque == "t"){
            echo "ok";
        }else{
            echo "no";
        }
    }else{
        echo "no";
    }

    exit;
}

$msg_erro     = "";
$msg_previsao = "";

if (!empty($_POST['btn_acao'])) {
    if (($_POST['btn_acao'] == "gravar") and $login_fabrica == '131') {
        $os = $_GET['os'];
        $sql = "SELECT status_os from tbl_os_status where os = '{$os}' and status_os IN (171, 172) order by data desc limit 1";
        $qry = pg_query($con, $sql);

        if (pg_num_rows($qry) > 0) {
            $status_atual = pg_fetch_result($qry, 0, 'status_os');

            if ($status_atual == '171') {
                $msg_erro = 'OS em auditoria de valores adicionais - não pode ser alterada.';
            }
        }
    }
}

$sql = "SELECT * FROM tbl_fabrica WHERE fabrica = $login_fabrica";
$res = pg_query($con,$sql);

$pedir_causa_defeito_os_item       = pg_fetch_result($res, 0, 'pedir_causa_defeito_os_item');
$pedir_defeito_constatado_os_item  = pg_fetch_result($res, 0, 'pedir_defeito_constatado_os_item');
$pedir_defeito_reclamado_descricao = pg_fetch_result($res, 0, 'pedir_defeito_reclamado_descricao');
$qtde_pecas_intervencao            = pg_fetch_result($res, 0, 'qtde_pecas_intervencao');
$ip_fabricante                     = trim (pg_fetch_result($res, 0, 'ip_fabricante'));
$ip_acesso                         = $_SERVER['REMOTE_ADDR'];
$os_item_admin                     = "null";

# AJAX PARA PEGAR SERVICO REALIZADO
if ($login_fabrica == 3 AND isset($_POST['buscaServicoRealizado'])) {

    header('Content-Type: text/html; charset=ISO-8859-1');
    $buscaServicoRealizado = trim($_POST['buscaServicoRealizado']);
    $os                    = trim($_POST['os']);

    if (strlen($buscaServicoRealizado) > 0) {

        if (strlen($os) > 0) {

            if($buscaServicoRealizado == "073894" ||  $buscaServicoRealizado == "073897" ||  $buscaServicoRealizado == "073373" || $buscaServicoRealizado == "771889"  || $buscaServicoRealizado == "074957"  || $buscaServicoRealizado == "773936") {
                $regarca_gas = 1;
            }

        } else {
            //RODRIGO PEDROSO
            $sql = "SELECT  bloqueada_garantia
                    FROM    tbl_peca
                    WHERE   fabrica = $login_fabrica
                    AND referencia  = '$buscaServicoRealizado'
                    AND bloqueada_garantia IS TRUE";

            $res = pg_query($con,$sql) ;

            if (pg_num_rows($res)>0){
                $bloqueada_garantia = pg_fetch_result($res,0,'bloqueada_garantia');
            }

        }

        if (strlen($os) > 0) {

            $sql = "SELECT *
                    FROM   tbl_servico_realizado
                    WHERE  tbl_servico_realizado.fabrica = $login_fabrica ";

            if ($regarca_gas == 1) {
                $sql .= "AND tbl_servico_realizado.servico_realizado = 692";
            } else {
                $sql .= "AND tbl_servico_realizado.servico_realizado <> 692";
                $sql .= "AND tbl_servico_realizado.ativo IS TRUE ";
            }

        } else {

            $sql = "SELECT *
                    FROM   tbl_servico_realizado
                    WHERE  tbl_servico_realizado.fabrica = $login_fabrica
                    AND   (tbl_servico_realizado.ativo IS TRUE OR (tbl_servico_realizado.servico_realizado=643 or tbl_servico_realizado.servico_realizado=644) )";

            if ($login_pede_peca_garantia == 't' AND !in_array($login_fabrica,array(1,24,15,30,52))) {
                $sql .= "AND tbl_servico_realizado.descricao NOT ILIKE 'troca%' ";
            }

            if ($bloqueada_garantia != 't') {
                $sql .= " AND tbl_servico_realizado.descricao NOT ILIKE '%pedido Faturado%'";
                $sql .= ($login_fabrica <> 3) ? "AND tbl_servico_realizado.descricao NOT ILIKE '%peça do Estoque%'" : "" ;
                $bloqueada_garantia = "f";
            }
        }

        if($login_fabrica == 42 and !in_array($tipo_atendimento,array(104,133,134))){
             $sql .= " AND tbl_servico_realizado.garantia_acessorio IS NOT TRUE";
        }

        $sql .= " ORDER BY descricao ";

        $res = pg_query($con,$sql) ;
        echo $bloqueada_garantia."||";

        for ($i = 0 ; $i < pg_num_rows($res) ; $i++ ) {
            $serv = pg_fetch_result($res,$i,'servico_realizado');
            $desc = pg_fetch_result($res,$i,'descricao');
            if ($login_fabrica == 3 and $controla_estoque == 'f' and $serv == 43){ continue; } //HD 171607 - Pular o loop quando acha o serviço de troca de estoque e o posto não está com o controla_estoque true.
            echo "<option value='$serv'>";
            echo $desc;
            echo "</option>";
        }

    } else {

        echo "<option value=''>Selecione a peça</option>";

    }

    exit;

}

if (in_array($login_fabrica,array(2,15,30,59))) {

    $btn_altera         = $_POST['btn_altera'];
    $os_altera          = $_POST['os_altera'];
    $referencia_produto = trim($_POST['referencia_produto']);

    if (strlen($btn_altera) > 0 AND strlen($os_altera) > 0 AND strlen($referencia_produto) > 0) {

        $res = pg_query($con,"BEGIN TRANSACTION");

        $sql = "UPDATE tbl_os SET produto =
                    (
                        SELECT produto
                        FROM tbl_produto
                        JOIN tbl_linha USING (linha)
                        WHERE  tbl_linha.fabrica  = $login_fabrica
                        AND  referencia = '$referencia_produto'
                    )
                WHERE tbl_os.os = $os_altera
                AND   tbl_os.fabrica = $login_fabrica
                AND   tbl_os.defeito_constatado IS NULL
                AND   tbl_os.solucao_os IS NULL ";

        $res = pg_query($con,$sql);
        $msg_erro .= pg_errormessage($con);

        if (strlen($msg_erro) == 0) {
            $sqlx = "SELECT fn_valida_os($os_altera,$login_fabrica)";
            $res = pg_query($con,$sqlx);
            $msg_erro = pg_errormessage($con);
        }

        if($login_fabrica == 30){
            $sql = "
                INSERT INTO tbl_os_interacao (
                    programa,
                    os,
                    data,
                    comentario,
                    interno,
                    posto
                ) VALUES (
                    '$programa_insert',
                    $os,
                    CURRENT_TIMESTAMP,
                    'Foi alterado o produto da OS para $referencia_produto',
                    TRUE,
                    $login_posto
                );
            ";
            $res = pg_query($con,$sql);
        }

        if (strlen($msg_erro) == 0) {
            $res = pg_query($con,"COMMIT TRANSACTION");
            header("Location: $php_self?os=$os_altera");
        } else {
            $res = pg_query($con,"ROLLBACK TRANSACTION");
        }

    }

}

/*  MLG 26/10/2010 - Toda a rotina de anexo de imagem da NF, inclusive o array com os parâmetros por fabricante, está num include.
    Para saber se a fábrica pede imagem da NF, conferir a variável (bool) '$anexaNotaFiscal'
    Para anexar uma imagem, chamar a função anexaNF($os, $_FILES['foto_nf'])
    Para mostrar a imagem: echo temNF($os); // Devolve um link: <a href='imagem' blank><img src='imagem[thumb'></a>
    Para saber se tem anexo: temNF($os, 'bool');
*/

if($login_fabrica == 30){
    $limite_anexos_nf =  3;
}elseif($login_fabrica == 88){
  $limite_anexos_nf = 5;
}

if ($login_fabrica == 19 && (empty($_FILES["foto_nf"]["name"][0]))) {

    $rvt = new TDocs($con,$login_fabrica);
    $qtdeAnexos = $rvt->getDocumentsByRef($os,'os')->attachCount;

    $objectId = $_POST['objectid'];
    $sqlDocs = "SELECT tdocs, tdocs_id, referencia, obs FROM tbl_tdocs WHERE referencia_id = 0 AND referencia = '$objectId' AND contexto = 'os'";
    $resDocs = pg_query($con,$sqlDocs);

    if ($qtdeAnexos < 1 and pg_num_rows($resDocs) == 0) {
        $sqlLinha = "
            SELECT  tbl_produto.linha,
                    tbl_linha.nome AS linha_nome
            FROM    tbl_produto
            JOIN    tbl_linha USING(linha)
            WHERE   tbl_produto.referencia = '".filter_input(INPUT_POST,'produto_referencia')."'
            AND     fabrica_i = $login_fabrica
        ";
        $resLinha  = pg_query($con,$sqlLinha);
        $anexoLinha = pg_fetch_result($resLinha,0,linha);
        $linha_nome = pg_fetch_result($resLinha,0,linha_nome);
        if (in_array($anexoLinha,array(265,928))) {
            $msg_erro .= "Para produtos da linha ".$linha_nome.", por favor inserir anexo do RVT - Relatório de Visita Técnica <br />";
        }
    }
}


if ($login_fabrica == '131') {
    $qtdeAnexos = temNF($os, 'count');

    if ((!empty($_POST['btn_acao'])) and (!empty($_POST['custo_adicional'][0])) and ($qtdeAnexos <> 2) and (empty($_FILES['foto_nf']['tmp_name']))) {
        $msg_erro = 'Para lançamento de valor adicionado é obrigatório o anexo do comprovante do pedágio.';
    }
}

if($login_fabrica == 15 && strlen($_POST["btn_acao"]) > 0){
    $sqlParametrosAdicionais = "SELECT parametros_adicionais FROM tbl_posto_fabrica WHERE posto = {$login_posto} AND fabrica = {$login_fabrica}";
    $resParametrosAdicionais = pg_query($con, $sqlParametrosAdicionais);
    if (pg_num_rows($resParametrosAdicionais) > 0) {
        $parametrosAdicionais = json_decode(pg_fetch_result($resParametrosAdicionais, 0, "parametros_adicionais"), true);
        extract($parametrosAdicionais);
        if ($nf_obrigatorio == 't' AND ($_POST["anexo_os_item"] != "1" or empty($_POST['anexo_os_item']))) {
            if(empty($_FILES['foto_nf']['tmp_name'][0])){
                $msg_erro .= "O Anexo de Nota Fiscal é obrigatório <br />";
            }
        }
    }
}

$sql_controla_estoque = "SELECT controla_estoque FROM tbl_posto_fabrica WHERE fabrica = $login_fabrica AND posto = $login_posto;";
$res_controla_estoque = pg_query($con,$sql_controla_estoque);
$controla_estoque     = pg_result($res_controla_estoque,0,'controla_estoque');

if (strlen($_GET['reabrir']) > 0) $reabrir = $_GET['reabrir'];
if (strlen($_GET['os']) > 0)      $os      = $_GET['os'];
if (strlen($_POST['os']) > 0)     $os      = $_POST['os'];
if (strlen($_POST['os_int']) > 0) $os      = $_POST['os_int'];

$defeito_reclamado = $_POST['xxdefeito_reclamado'];
if(!empty($os)) {
    $sql = "SELECT  tbl_os.sua_os,
            tbl_os.qtde_km,
            tbl_os.fabrica,
            tbl_os.status_checkpoint,
            tipo_atendimento,
            tbl_os.excluida
        FROM    tbl_os
        WHERE   tbl_os.os = $os";
    $res = pg_query($con,$sql) ;

    if (pg_num_rows($res) > 0) {

        if (pg_fetch_result($res, 0, 'fabrica') <> $login_fabrica) {
        header("Location: os_cadastro.php");
        exit;
        }
        if(pg_fetch_result($res, 0, 'excluida') == 't' && in_array($login_fabrica, array(20))){
            header('Location:os_press.php?os=' . $os);
            exit;
        }

    }
    $qtde_km           = pg_fetch_result($res, 0, 'qtde_km');
    $tipo_atendimento  = pg_fetch_result($res, 0, 'tipo_atendimento');
    $sua_os            = trim(pg_fetch_result($res, 0, 'sua_os'));
    $status_checkpoint = trim(pg_fetch_result($res, 0, 'status_checkpoint'));

}
if ($login_fabrica == 14) {

    $imprimir       = $_GET['imprimir'];
    $qtde_etiquetas = $_GET['qtde_etiq'];

    if (strlen($imprimir) > 0 AND strlen($os) > 0) {
        header("Location: os_item.php?os=$os&imprimir=1&qtde_etiq=$qtde_estiquetas");
    } else {
        header("Location: os_item.php?os=$os");
    }
    exit;
}

if ($login_fabrica == 1 AND strlen($os) > 0) {
    header("Location: os_item.php?os=$os");
    exit;
}

if ($login_fabrica == 45) {

    $troca = trim($_GET['troca']);

    if ($troca == "1") {

        $sql = "SELECT tbl_produto.troca_obrigatoria
                  FROM tbl_produto
                  JOIN tbl_os ON tbl_os.produto = tbl_produto.produto
                 WHERE tbl_os.os  = $os
                   AND tbl_os.posto = $login_posto;";

        $res = pg_query($con,$sql);

        if (pg_num_rows($res) > 0) {

            $troca_obrigatoria = trim(pg_fetch_result($res,0,troca_obrigatoria));

            if ($troca_obrigatoria == 't') {

                $sql_intervencao = "SELECT status_os
                                      FROM tbl_os_status
                                     WHERE os = $os
                                       AND status_os IN (62,64,65)
                                     ORDER BY data DESC
                                     LIMIT 1";

                $res_intervencao = pg_query($con, $sql_intervencao);
                $status_os = "";

                if (pg_num_rows($res_intervencao) > 0) {
                    $status_os = trim(pg_fetch_result($res_intervencao,0,status_os));
                }

                if (pg_num_rows($res_intervencao) == 0 or $status_os == "65"){
                    $sql = "INSERT INTO tbl_os_status (os,status_os,data,observacao) values ($os,62,current_timestamp,'O Produto desta O.S. necessita de troca.')";
                    $res = pg_query($con,$sql);
                    $msg_intervencao .= "<br>A produto $produto_referencia precisa de Intervenção da Assistência Técnica da Fábrica. Aguarde o contato da fábrica";
                }

                $assunto = "TROCA OBRIGATORIA - OS ITEM NEW - $os - $login_fabrica - $login_posto";
                $corpo   = "OS: $os \n";

            }

        }

    }

}

if ($login_fabrica == 24) {

    $sql = "SELECT current_timestamp-data_digitacao < '00:02:00'
              FROM tbl_os
             WHERE os =  $os ";
    $res = pg_query($con,$sql);
    $verifica = pg_fetch_result($res,0,0);

}

if ($login_fabrica <> 56) {

    if ($verifica == 't' or !in_array($login_fabrica,[24,117])) {
        $sql  = "SELECT fn_valida_os_reincidente($os,$login_fabrica)";
        $res1 = pg_query($con,$sql);
    }

}

if (strlen($_GET['os']) > 0) {

    $os = $_GET['os'];

    if ($login_fabrica == 19) {
        $sqlVerificaReincidenciaGarantia = "SELECT tbl_os_extra.os_reincidente, r.tipo_atendimento
                                          FROM tbl_os_extra
                                          JOIN tbl_os r ON r.os = tbl_os_extra.os_reincidente
                                          AND r.fabrica = {$login_fabrica}
                                          WHERE tbl_os_extra.os = {$os}
                                          AND r.tipo_atendimento = 339";
        $resVerificaReincidenciaGarantia = pg_query($con, $sqlVerificaReincidenciaGarantia);

        if (pg_num_rows($resVerificaReincidenciaGarantia) > 0) {

            $sqlDesconsideraReincidencia = "UPDATE tbl_os
                                             SET os_reincidente = null
                                             WHERE os = {$os};

                                             UPDATE tbl_os_extra
                                             SET os_reincidente = null
                                             WHERE os = {$os};";
            pg_query($con, $sqlDesconsideraReincidencia);

        }

    }

    $sql = "SELECT motivo_atraso ,
                   observacao    ,
                   os_reincidente,
                   obs_reincidencia
              FROM tbl_os
             WHERE os = $os
               AND fabrica = $login_fabrica";

    $res = pg_query($con, $sql);

    $motivo_atraso    = pg_fetch_result($res, 0, 'motivo_atraso');
    $observacao       = pg_fetch_result($res, 0, 'observacao');
    $os_reincidente   = pg_fetch_result($res, 0, 'os_reincidente');
    $obs_reincidencia = pg_fetch_result($res, 0, 'obs_reincidencia');

    if ($login_fabrica == 2) {

        if ($os_reincidente == 't' AND (strlen($obs_reincidencia) == 0)) header("Location: os_motivo_atraso.php?os=$os&justificativa=ok");

    } else {

        if ($os_reincidente == 't' AND strlen($obs_reincidencia ) == 0)  header("Location: os_motivo_atraso.php?os=$os&justificativa=ok");

    }

}

if (strlen($reabrir) > 0) {

    if ($login_fabrica == 94) {
        $cond_extrato_revenda = " AND extrato != 0";
    }

    $sql = "SELECT os
            FROM tbl_os_extra
            WHERE os = $os
            AND extrato IS NOT NULL
            $cond_extrato_revenda
            ";

    $res = pg_query($con, $sql);

    if ( pg_num_rows ( $res ) ) {

    $msg_erro .= "Esta OS não pode ser reaberta pois já entrou em extrato.";
        echo "<script language='javascript'>alert('$msg_erro'); history.go(-1);</script>";
        exit();

    }

    $sql = "SELECT count(*)
              FROM tbl_os_item
              JOIN tbl_os_produto USING(os_produto)
              JOIN tbl_servico_realizado ON tbl_os_item.servico_realizado = tbl_servico_realizado.servico_realizado
             WHERE os = $os
               AND fabrica = $login_fabrica
               AND tbl_servico_realizado.troca_produto IS TRUE;";

    $res = pg_query($con,$sql);

    if (pg_fetch_result($res,0,0) == 0) {
        if (in_array($login_fabrica, array(117,35))) {
            $reabrir_elgin = ", data_conserto = null";
        }else{
            $reabrir_elgin = "";
        }

        $sql = "UPDATE tbl_os SET data_fechamento = null, finalizada = null $reabrir_elgin
                 WHERE tbl_os.os      = $os
                   AND tbl_os.fabrica = $login_fabrica
                   AND tbl_os.posto   = $login_posto;";

        $res = pg_query($con,$sql);
        $msg_erro .= pg_errormessage($con);

        if ($login_fabrica == 19) {
            $sqlOS = "SELECT os_numero,os_sequencia, sua_os from tbl_os where os = $os AND tbl_os.fabrica = $login_fabrica AND tbl_os.posto   = $login_posto";
            $res = pg_query($con,$sqlOS);
            $os_numero = pg_fetch_result($res, 0, 'os_numero');
            $sua_os_ant = pg_fetch_result($res, 0, 'sua_os');

            $sqlAnt = "SELECT tbl_os_extra.os
                FROM tbl_os_extra 
                JOIN tbl_os ON tbl_os_extra.os = tbl_os.os
                WHERE data_fechamento   = data_abertura
                AND tbl_os.fabrica      = $login_fabrica
                AND tbl_os.os_numero    = $os_numero
                AND tbl_os.excluida     <> 't'
                AND tbl_os_extra.os_reincidente = $os
                AND (tipo_atendimento = 235 or tipo_atendimento = 335)";
            $resAnt = pg_query($con, $sqlAnt);

            if (pg_num_rows($resAnt) > 0) {
                $os_ant = pg_fetch_result($resAnt, 0, 'os');

                $sqlInstalacao = "UPDATE tbl_os SET excluida = 't' WHERE os = $os_ant";
                pg_query($con,$sqlInstalacao);

                $sqlOSStatus = "INSERT INTO tbl_os_status (os, status_os, observacao) VALUES ($os_ant, 15, 'OS excluída pois a OS que a gerou ($sua_os_ant) foi reaberta')";
                $resOSStatus = pg_query($con, $sqlOSStatus);
            }
    }

    } else {

        $msg_erro .= "Esta OS não pode ser reaberta pois a solução foi a troca do produto.";
        echo "<script language='javascript'>alert('Esta os não pode ser reaberta pois o produto foi trocado pela fábrica'); history.go(-1);</script>";
        exit();

    }

}else{
    $sql = "SELECT os FROM tbl_os where os= $os and finalizada notnull";
    $res = pg_query($con,$sql);
    if(pg_num_rows($res) > 0) {
        echo "<script language='javascript'>alert('Esta os já está finalizada, não pode ser alterada'); window.location = 'os_press.php?os=$os';</script>";
        exit();

    }
}

if ( in_array($login_fabrica, array(11,172)) ) {

    $interacao_msg = $_POST['interacao_msg'];

    if (strlen($interacao_msg) > 0) {

        $interacao_exigir_resposta = $_POST['interacao_exigir_resposta'];

        if (strlen($interacao_msg) == 0) {
            $msg_erro.= "Por favor, insira algum comentário.";
        }

        if ($interacao_exigir_resposta <> 't') {
            $interacao_exigir_resposta = 'f';
        }

        if (strlen($msg_erro) == 0) {

            $sql = "INSERT INTO tbl_os_interacao(
                                    programa       ,
                                    os             ,
                                    comentario     ,
                                    exigir_resposta
                                )VALUES(
                                    '$programa_insert',
                                    $os              ,
                                    '$interacao_msg' ,
                                    '$interacao_exigir_resposta'
                                )";

            $res = pg_query($con,$sql);

        }

    }

}

# Fabio 17/01/2007 - verifica o status das OS da britania
# HD 14830 - Fabrica 25
# HD 13618 - Fabrica 45
# HD 12657 - Fabrica 2
if ($fabrica_verifica_status_os) {

    $sql = "SELECT status_os,observacao
              FROM tbl_os_status
             WHERE os = $os
               AND status_os IN (19,20,62,64,65,72,73,81,87,88,116,117,102,68,70,115,98,99,100,101,102,103,104,174)
             ORDER BY data DESC LIMIT 1";

    $res = pg_query($con,$sql);

    if (pg_num_rows($res) > 0) {

        $status     = pg_fetch_result($res, 0, 'status_os');
        $observacao = pg_fetch_result($res, 0, 'observacao');

        if (in_array($login_fabrica,array(101))){

            if ($status == '20') {
                header("Location: os_press.php?os=$os");
                exit;
            }

        }

        if (in_array($login_fabrica,array(98,106,108,111))){

            if ($status == '62') {
                header("Location: os_press.php?os=$os");
                exit;
            }

        }

        if ($status == '62') {

            if (strpos($observacao, "troca") > 0) {

                $msg_intervencao .= "<b style='color:#FF3333'>OS com intervenção da assistência técnica da Fábrica</b><br><b style='color:#000;font-size:12px'>O produto selecionado deve ser trocado.<br> Selecione o ".$tema." e a Solução para continuar</b>";

                header("Location: os_finalizada.php?os=$os");

                exit;

            } else {

                header("Location: os_press.php?os=$os");
                exit;

                //adicionado para digitar constatado e solucao

            }

        }

        if ($status == '65') {

            header("Location: os_press.php?os=$os");
            exit;

        }

        if ($status == '72' or $status == '87' or $status == '116') {

            header("Location: os_finalizada.php?os=$os");
            exit;

        }

    }

}

if (strlen($_POST['qtde_itens_mostrar']) > 0) $qtde_itens_mostrar = $_POST['qtde_itens_mostrar'];

if ($qtde_itens_mostrar == '' and $login_fabrica == 30) $qtde_itens_mostrar = 20;
//adicionado por Fabio 02/01/2007- numero de itens na OS
if ($login_fabrica <> 30) $qtde_itens_mostrar="";

if ($login_fabrica == 72 or (isset($_REQUEST['n_itens']) AND strlen($_REQUEST['n_itens']) > 0)) {

    $qtde_itens_mostrar = $_REQUEST['n_itens'];

    switch ($login_fabrica) {
        case 15:
            if (strlen($qtde_itens_mostrar) == 0) {
                $qtde_itens_mostrar = -1;
            }

            switch ($qtde_itens_mostrar) {
                case 20:
                    $qtde_itens_mostrar = 20;
                break;
                case 30:
                    $qtde_itens_mostrar = 30;
                break;
                case 40:
                    $qtde_itens_mostrar = 40;
                break;
                default:
                    $qtde_itens_mostrar = 10;
                break;
            }
        break;
        case 86:
            $qtde_itens_mostrar = $qtde_itens_mostrar > 30 ?
                40 : (1+intval($qtde_itens_mostrar/10))*10;
        break;
        case 72:
            $qtde_itens_mostrar = $mallory_posto_TOP ? 10 : 3;
        break;
        case 74:
            $qtde_itens_mostrar = 10;
        break;
        default:
            if ($qtde_itens_mostrar > 10) $qtde_itens_mostrar = 10;
            if ($qtde_itens_mostrar < 0)  $qtde_itens_mostrar = 3;
        break;
    }

} else if($login_fabrica <> 30) {

    $qtde_itens_mostrar = 3;

    /*  HD 13498 9/2/2008
    A pedido da Dalila foi aumentada a quantidade de linhas para este posto*/
    /* Adicionado posto 13979 - HD 14278 */
    if ($login_fabrica == 45) {
        $sql= "SELECT qtde_os_item
                 FROM tbl_posto_fabrica
                WHERE posto   = $login_posto
                  AND fabrica = $login_fabrica";
        $res = pg_query($con,$sql);
        $qtde_itens_mostrar = pg_fetch_result($res, 0, 'qtde_os_item');
    }

    if ($login_fabrica == 15 ) {
        $qtde_itens_mostrar = 150;
    }

    if ($login_fabrica == 74) {
        $qtde_itens_mostrar = 20;
    }

    if ($login_fabrica == 3) {
        $sql = "SELECT tbl_os_item.os_item
                FROM tbl_os_item
                JOIN tbl_os_produto ON tbl_os_produto.os_produto = tbl_os_item.os_produto
                JOIN tbl_os ON tbl_os.os = tbl_os_produto.os AND tbl_os.fabrica = $login_fabrica
                WHERE tbl_os.os = $os";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 3) {
            $qtde_itens_mostrar = 5;
        }
    }

    if($login_fabrica >= 104 OR $login_fabrica == 81){
    $sql = "SELECT qtde_item_os FROM tbl_fabrica WHERE fabrica = $login_fabrica";
    $res = pg_query($con,$sql);

    $qtde_itens_mostrar = pg_fetch_result($res,0,0);

    $qtde_itens_mostrar = ($qtde_itens_mostrar > 0) ? $qtde_itens_mostrar : 5;
    }
}

$numero_pecas_faturadas = 0;
// fim do numero de linhas - Fabio 02/01/2007

//modificado por Fernando 02/08/2006 - Exclusao do item na OS qdo o mesmo estiver abaixo dos 30%.
//verifica se tem os_item amarrado na os_produto se nao tiver ele apaga os_produto.

$os_item = trim($_GET ['os_item']);

if ($os_item > 0) {

    if ($os_item_old != $os_item) {

        $os_item_old = $os_item;
        // echo $os_item_old." - ".$os_item;exit;
        // seleciona a os_produto que contem a os_item quem não geraam pedido
        $sql = "SELECT os_produto,os FROM tbl_os_item WHERE os_item = $os_item AND pedido IS NULL";
        $res = pg_query($con,$sql);

        if (pg_num_rows($res) == 1) {
            $os_auditor = pg_fetch_result($res, 0, 'os');
            $os_produto = pg_fetch_result($res, 0, 'os_produto');

            if (!empty($os_produto)) {
            #HD 15489
            $sql = "UPDATE tbl_os_produto SET os = 4836000 WHERE os_produto = $os_produto";
            $res = pg_query($con, $sql);

            }
            // if (!pg_last_error()) {
            //     if(in_array($login_fabrica, $fabricas_auditor)){


            //         $sqls = "SELECT os_produto, posicao, peca, qtde, defeito, causa_defeito, servico_realizado, admin,
            //                 peca_serie, peca_serie_trocada, peca_reposicao_estoque, parametros_adicionais, peca_obrigatoria, fornecedor
            //         FROM tbl_os_item
            //         WHERE os_item = $os_item";

            //         $ress = pg_query($con,$sqls);
            //         $ress = pg_fetch_all($ress);
            //         $antes = $ress[0];
            //         auditorLog($os,$antes,array(
            //             "os_produto" => '',
            //             "posicao" => '',
            //             "peca" => '',
            //             "qtde" => '',
            //             "defeito" =>  '',
            //             "causa_defeito" => '',
            //             "servico_realizado" =>  '',
            //             "admin" => '',
            //             "peca_causadora" =>  '',
            //             "parametros_adicionais" => '',
            //             "peca_obrigatoria" => '',
            //             "fornecedor" => ''
            //         ), 'tbl_os_item', '/os_item.php', "DELETE");

            //     }
            // }

        } else {

            $msg_erro_item .= "Não foi encontrado o item.";

        }

    } else {

        $msg_erro_item .= "Não foi encontrado o item.";

    }

}

$btn_acao     = strtolower($_POST['btn_acao']);
$btn_imprimir = strtolower($_POST['btn_imprimir']);

if ((($login_fabrica==3 or $login_fabrica == 45 or $login_fabrica == 24) AND $login_posto==6359) or ($login_fabrica == 46 AND $login_posto==6359)){
    $query = "    SELECT orcamento
                FROM tbl_orcamento
                WHERE empresa = $login_fabrica
                AND   os      = $os";

    $orca = pg_query($con, $query);

    if (pg_num_rows($orca) > 0) {
        $orcamento = pg_fetch_result($orca,0,orcamento);
    }

}

if ($login_fabrica == 3 AND $login_posto == 6359) {

    $query = "SELECT os_revenda_item, os_revenda FROM tbl_os_revenda_item WHERE os_lote = $os";
    $orca  = pg_query($con, $query);

    if (pg_num_rows($orca) > 0) {
        $os_revenda_item = pg_fetch_result($orca, 0, 'os_revenda_item');
        $os_revenda      = pg_fetch_result($orca, 0, 'os_revenda');
    }

}

if($login_fabrica == 140){
    $sql_ta = "SELECT entrega_tecnica FROM tbL_tipo_atendimento WHERE tipo_atendimento = (SELECT tipo_atendimento FROM tbl_os WHERE os = $os AND fabrica = $login_fabrica) AND fabrica = $login_fabrica";
    $res_ta = pg_query($con, $sql_ta);

    if(pg_num_rows($res_ta) > 0){
        $entrega_tecnica = pg_fetch_result($res_ta, 0, 'entrega_tecnica');
    }
}

if ($btn_acao == "gravar") {

    if($login_fabrica == 30 ){
        $cor_etiqueta_fornecedor = $_POST["cor_etiqueta_fornecedor"];        
    }


    //hd-2795821
    $sql_posto_fabrica = "SELECT parametros_adicionais FROM tbl_posto_fabrica WHERE posto = $login_posto and fabrica = $login_fabrica";
    $res_posto_fabrica = pg_query($con, $sql_posto_fabrica);

    if(strlen(trim(pg_last_error($con)))== 0 ){
        if(pg_num_rows($res_posto_fabrica)>0){
            $parametros_adicionais = pg_fetch_result($res_posto_fabrica, 0, parametros_adicionais);
            $parametros_adicionais = json_decode($parametros_adicionais, true);

            $gera_pedido_posto = (strlen(trim($parametros_adicionais['gera_pedido']))>0 )? $parametros_adicionais['gera_pedido'] : 'f';

        }
    }else{
        $msg_erro .= pg_last_error($con);
    }

    if($login_fabrica == 91) {

        for($j=0; $j < $qtde_item; $j++){

            if(strlen($_POST['peca_'.$j]) > 0){

                $rf = $_POST['peca_'.$j];
                $sqlF_linha = "SELECT * FROM tbl_peca_fora_linha WHERE referencia = '$rf' AND fabrica = $login_fabrica AND libera_garantia IS NOT TRUE";
                $resF_linha = pg_query($con, $sqlF_linha);

                    if(pg_num_rows($resF_linha) > 0){
                        $descF = $_POST['descricao_' . $j];
                        $msg_erro .= "A peça $descF está fora de linha e garantia<br>";
                    }

                $sqlid = "SELECT peca FROM tbl_peca WHERE UPPER(referencia) = UPPER('$rf') AND fabrica = $login_fabrica";
                $res   = pg_query($con, $sqlid);
                $peca_id = pg_fetch_result($res, 0, "peca");

                //busco pecas filhas daquele id verifica se peça e mae
                $sql = "SELECT peca_filha FROM tbl_peca_container WHERE peca_mae = $peca_id"; 
                $resultado = pg_query($con, $sql);

                 if (pg_num_rows($resultado) > 0) {
               
                    while ($dados = pg_fetch_object($resultado)) {
               
                          $peca_filha = $dados->peca_filha;
                                         
                          for($a=0; $a < $qtde_item; $a++){
                           
                             if(strlen($_POST['peca_'.$a]) > 0){
                             $rf2 = $_POST['peca_'.$a];   

                             $id  = "SELECT peca FROM tbl_peca WHERE UPPER(referencia) = UPPER('$rf2') AND fabrica = $login_fabrica";
                             $res = pg_query($con, $id);
                             $resultado2 = pg_fetch_result($res, 0, "peca");

                                if ($resultado2 == $peca_filha) {                                     
                                     $msg_erro.= "A peça inserida já pertence a outra peça do pedido.";
                                 }
                             } 
                         } 
                    } 
                 } 
            }
        }
    }

    // Validação peça fora de linha ou sem preço HD-6995925
    if($login_fabrica == 42) {
        $pecas_fora_linha = [];
        $pecas_sem_preco  = [];

        for($j=0; $j < $qtde_item; $j++){

            if(strlen($_POST['peca_'.$j]) > 0){

                $rf = $_POST['peca_'.$j];
                $sqlF_linha = "SELECT * FROM tbl_peca_fora_linha WHERE referencia = '$rf' AND fabrica = $login_fabrica AND libera_garantia IS NOT TRUE ";
                $resF_linha = pg_query($con, $sqlF_linha);

                    if(pg_num_rows($resF_linha) > 0){
                        $pecas_fora_linha[] = $rf; 
                    }
                
                unset($makita_preco_bruto);
                $ref_peca = $rf;
                $ins_makita = ', preco';
                $_GET['linha_form'] = $xx;
                $_REQUEST['linha_form'] = $xx;
                $_GET['condicao'] = '1159'; //condicao de pagamento a vista
                $_GET['produto_referencia'] = $ref_peca;
                $_GET['posto'] = $login_posto;
                unset($makita_preco);
                ob_start();
                include('makita_valida_regras.php');
                ob_get_clean();

                if (empty($makita_preco) || $makita_preco == 0) {
                    $pecas_sem_preco[] = $rf;
                }
            }
        }
        
        if (count($pecas_fora_linha) > 0) {
            $msg_erro .= "A(s) peça(s) ".implode(",", $pecas_fora_linha).", está(ão) fora de linha, gentileza entrar em contato com o Depto. De Assistência através do Help Desk.  <a href='helpdesk_cadastrar.php' target='_blank'><button type='button'>Abrir Help-Desk</button></a><br><br>";
        }

        if (count($pecas_sem_preco) > 0) {
            $msg_erro .= "A(s) peça(s) ".implode(",", $pecas_sem_preco).", não possui(em) preço cadastrado, gentileza entrar em contato com o Depto. De Assistência através do Help Desk.  <a href='helpdesk_cadastrar.php' target='_blank'><button type='button'>Abrir Help-Desk</button></a><br>";
        }
    }

    $sql_distrib = "SELECT fabrica FROM tbl_fabrica WHERE parametros_adicionais ilike '%telecontrol_distrib%' and fabrica = $login_fabrica";
    $res_distrib = pg_query($con, $sql_distrib);
    $pecas_os_item = array();

    if (pg_num_rows($res_distrib) > 0) {
        $telecontrol_distrib = true;

        $sql_peca_os_item = "SELECT peca, qtde FROM tbl_os_item JOIN tbl_os_produto USING(os_produto) where os = $os";
        $res_peca_os_item = pg_query($con, $sql_peca_os_item);

        while ($fetch = pg_fetch_assoc($res_peca_os_item)) {
            $pecas_os_item[$fetch['peca']] = (int) $fetch['qtde'];
        }
    }

    if(strlen($cookie_login['cook_login_unico']) > 0){ //HD-3165481

        if(strlen($os) > 0){
            $sqlOS = "SELECT fabrica FROM tbl_os WHERE os = $os";
            $resOS = pg_query($con, $sqlOS);

            if(pg_num_rows($resOS) > 0){
                $fabrica_os = pg_fetch_result($resOS, 0, 'fabrica');
                if($fabrica_os <> $login_fabrica){
                    include_once "cabecalho.php";
                    echo '<table align="center" width="700">
                            <tr style="background-color:#FF0000; font-size:16px; color:#FFFFFF; text-align:center;" >
                                <td>OS: '.$os.' não pertence a essa Fábrica</td>
                            </tr>
                    </table>';
                    exit;
                }
            }
        }
    }
    if($login_fabrica == 6 && !temNF($os, 'bool')){
        $tem_pecas = false;
        for($i=0;$i<$qtde_item;$i++){
            if(strlen($_POST['peca_'.$i]) > 0){
                $tem_pecas = true;
                break;
            }
        }
    }

    //fputti HD-3283021
    if ($login_fabrica == 50 && $tipo_atendimento == 55) {
        $sql = "SELECT os FROM tbl_os_visita WHERE os = {$os};";
        $res = pg_query($con, $sql);
        if (pg_num_rows($res) == 0) {
            $msg_erro.= 'É obrigatório agendar uma visita.<br/>';
        }
    }

    if (($anexaNotaFiscal and !$msg_erro) || ($login_fabrica == 6 and $tem_pecas)) {

        if ($fabricas_image_uploader) {
            $filesByImageUploader = 0;

            $objectId = $_POST['objectid'];
            $sqlDocs = "SELECT tdocs, tdocs_id, referencia, obs FROM tbl_tdocs WHERE referencia_id = 0 AND referencia = '$objectId' AND contexto = 'os'";
            $resDocs = pg_query($con,$sqlDocs);
            $filesByImageUploader = pg_num_rows($resDocs);
        }

        if ((is_array($_FILES['foto_nf']) and $_FILES['foto_nf']['name'] != '' and !$filesByImageUploader) || ($login_fabrica == 123 && $_FILES['foto_termo'])) {

            if ($login_fabrica == 6 AND temNF($os,'bool')) {
                $img_nf = temNF($os,  'path');
                //$img_nf = anti_injection($img_nf);
                //echo $img_nf[0];
                $excluiu = (excluirNF($img_nf[0]));
                $nome_anexo = preg_replace("/.*\/([rexs]_)?(\d+)([_-]\d)?\..*/", "$1$2", $img_nf);
                if ($excluiu === false) $msg_erro .= 'Não foi possível excluir o arquivo anterior.<br />';
            }

            if($login_fabrica == 30){

                $temImg = ($S3_online) ? temNF($os, 'count') : 0;
                if($produto_serie == "00000000000000"){
                    for($an = 0; $an<=3; $an++){

                        if(!isset($_FILES["foto_nf"]['tmp_name'][$an])){
                            continue;
                        }

                    }
                }

                foreach (range(0, 3) as $idx) {

                    if ($anexaNotaFiscal and $_FILES["foto_nf"]['tmp_name'][$idx][0] != '') {
                        $file = array(
                            "name" => $_FILES["foto_nf"]["name"][$idx][0],
                            "type" => $_FILES["foto_nf"]["type"][$idx][0],
                            "tmp_name" => $_FILES["foto_nf"]["tmp_name"][$idx][0],
                            "error" => $_FILES["foto_nf"]["error"][$idx][0],
                            "size" => $_FILES["foto_nf"]["size"][$idx][0]
                        );

                        $anexou = anexaNF($os, $file);

                        if ($anexou !== 0) $msg_erro .= (is_numeric($anexou)) ? $msgs_erro[$anexou] : $anexou; // '0' é que executou OK
                    }
                }
                $temImg = ($S3_online) ? temNF($os, 'count') : 0;

                if($temImg < 3 and $produto_serie == "00000000000000"){
                    $erro_anexo = "Anexos Obrigatórios. <br>";
                }

                $msg_erro .= $erro_anexo;

            }else{

                $xqtdeAnexos = 0;

                if ($login_fabrica == 19 and 1 == 2) {
                    $rvt = new TDocs($con,$login_fabrica);
                    $xqtdeAnexos = $rvt->getDocumentsByRef($os,'os')->attachCount;
                }

                $qt_anexo = 0;
                foreach($_FILES['foto_nf'] as $files){
                    if(strlen($_FILES['foto_nf']['name'][$qt_anexo])==0){
                        continue;
                    }
                    $dados_anexo['name']      = $_FILES['foto_nf']['name'][$qt_anexo];
                    $dados_anexo['type']      = $_FILES['foto_nf']['type'][$qt_anexo];
                    $dados_anexo['tmp_name']  = $_FILES['foto_nf']['tmp_name'][$qt_anexo];
                    $dados_anexo['error']     = $_FILES['foto_nf']['error'][$qt_anexo];
                    $dados_anexo['size']      = $_FILES['foto_nf']['size'][$qt_anexo];

                    $anexou = anexaNF($os, $dados_anexo);

                    $qt_anexo++;
                }

                if ($login_fabrica == 123 && isset($_FILES['foto_termo'])) {
                    $dados_anexo_termo['name']      = $_FILES['foto_termo']['name'];
                    $dados_anexo_termo['type']      = $_FILES['foto_termo']['type'];
                    $dados_anexo_termo['tmp_name']  = $_FILES['foto_termo']['tmp_name'];
                    $dados_anexo_termo['error']     = $_FILES['foto_termo']['error'];
                    $dados_anexo_termo['size']      = $_FILES['foto_termo']['size'];
                    $dados_anexo_termo['termo_entrega']     = 'ok';

                    $anexou_termo = anexaNF($os, $dados_anexo_termo);
                }
            }
            if ($anexou !== 0) $msg_erro .= (is_numeric($anexou)) ? $msgs_erro[$anexou] : $anexou; // '0' é que executou OK

            if ($login_fabrica == 6 && $anexou === 0) {
                $sql = "INSERT INTO tbl_os_status (os, status_os, observacao) VALUES ($os, 189, 'OS em auditoria de nota fiscal')";
                $res = pg_query($con, $sql);
            }

            if ($anexou === 0 and $login_fabrica == 72) {

                $sql = "SELECT status_os, admin FROM tbl_os_status WHERE tbl_os_status.os = $os AND status_os = 154 ORDER BY data DESC LIMIT 1";
                $res = pg_query($con, $sql);

                if (pg_num_rows($res) == 1) {

                    $status_os = pg_fetch_result($res, 0, 'status_os');
                    $admin     = pg_fetch_result($res, 0, 'admin');

                    if ($status_os == 154) {

                        $sql = "SELECT email, nome_completo FROM tbl_admin WHERE admin = {$admin};";
                        $res = pg_query($con, $sql);

                        $email_admin         = pg_fetch_result($res, 0, 'email');
                        $nome_completo_admin = pg_fetch_result($res, 0, 'nome_completo');

                        if ($email_admin != "") {

                            $remetente    = "Suporte <helpdesk@telecontrol.com.br>";
                            $destinatario = $email_admin;
                            $assunto      = "Anexada Nota Fiscal à OS {$os}\n";
                            $mensagem     = "Prezado(a) {$nome_completo_admin}\n";
                            $mensagem    .="<br /><br />Foi anexada uma imagem de nota fiscal referente à OS {$os}\n";
                            $mensagem    .="<br /><br />----------\n";
                            $mensagem    .="<br />Atenciosamente,\n";
                            $mensagem    .="<br />Suporte Telecontrol\n";
                            $mensagem    .="<br />www.telecontrol.com.br\n";
                            $mensagem    .="<br /><b>Esta é uma mensagem automática, não responda este e-mail.</b>\n";
                            $headers="Return-Path: <helpdesk@telecontrol.com.br>\nFrom:".$remetente."\nContent-type: text/html\n";

                            mail($destinatario, utf8_encode($assunto), utf8_encode($mensagem), $headers);

                        }

                    }

                }

            }

        }else{
            if($login_fabrica == 6 AND $tem_pecas == true){
                $msg_erro .= "É obrigatório a inclusão de NF, caso tenha lançamento de itens.<br />";
            }
        }
    }

//exit;

    if( in_array($login_fabrica, array(3,11,126,137,172)) ){
        //upload temporario
        $types = array("png", "jpg", "jpeg", "bmp", "pdf", "doc", 'docx');

        $arrFilesUpload = array();
        $arrLinks = array("img_os_item_1"=>array("link"=>"", "name"=>""), 'img_os_item_2' =>array("link"=>"", "name"=>""));
        foreach ($_FILES as $key => $imagem) {

          if((strlen(trim($imagem["name"])) > 0) && ($imagem["size"] > 0)){
            if($key == "img_os_item_1" || $key == "img_os_item_2" ){
                $pathinfo = pathinfo($imagem['name']);
              $type  = $pathinfo['extension'];
              if (!in_array($type, $types)) {

                $msg_erro .= "Formato inválido, são aceitos os seguintes formatos: png, jpeg, bmp, doc e pdf";
                break;

              } else {

                if(strlen($os) > 0 ){
                  $fileName = "anexo_os_item_{$login_fabrica}_{$os}_{$key}";
                }
                $arrFilesUpload[] = array("file_temp"=>$fileName.".".$type, "file_new"=>$fileName.".".$type);
                $amazonTC->tempUpload($fileName, $imagem, "", "");

                $arrLinks[$key]["link"] = $amazonTC->getLink("$fileName.$type", true, "", "");
                $arrLinks[$key]["name"] = $fileName.".".$type;

              }
            }
          }
        }

        if(isset($_POST['tmp_img_os_item_1']) && strlen($_POST['tmp_img_os_item_1']) > 0){
            $arrFilesUpload[] = array("file_temp"=>$_POST['tmp_img_os_item_1'], "file_new"=>$_POST['tmp_img_os_item_1']);

            $arrLinks["img_os_item_1"]["link"] = $amazonTC->getLink($_POST['tmp_img_os_item_1'], true, "", "");
            $arrLinks["img_os_item_1"]["name"] = $_POST['tmp_img_os_item_1'];
        }

        if(isset($_POST['tmp_img_os_item_2']) && strlen($_POST['tmp_img_os_item_2']) > 0){
            $arrFilesUpload[] = array("file_temp"=>$_POST['tmp_img_os_item_1'], "file_new"=>$_POST['tmp_img_os_item_1']);

            $arrLinks["img_os_item_2"]["link"] = $amazonTC->getLink($_POST['tmp_img_os_item_2'], true, "", "");
            $arrLinks["img_os_item_2"]["name"] = $_POST['tmp_img_os_item_2'];
        }
      }
    //  FIM Anexa imagem NF

    if ($login_fabrica == 91) {
        $audProd    = new AuditorLog();
        $audItem    = new AuditorLog();
        $audOs      = new AuditorLog();

        $query_action = "INSERT";

        $audOs->retornaDadosSelect("SELECT  os,
                                            defeito_reclamado,
                                            defeito_constatado,
                                            solucao_os as solucao,
                                            obs
                                            from tbl_os
                                            where os = {$os}");

        $audProd->retornaDadosSelect("SELECT DISTINCT   tbl_os_produto.os_produto,
                                                        tbl_os.os,
                                                        tbl_os.causa_defeito,
                                                        tbl_os_produto.produto,
                                                        tbl_os.serie
                                                FROM    tbl_os_produto
                                                JOIN    tbl_os USING(os)
                                                WHERE   tbl_os.os = {$os}");


        $audItem->retornaDadosSelect("SELECT    tbl_os_item.os_item, tbl_os_item.peca,
                                                tbl_os_item.qtde,
                                                tbl_os_item.servico_realizado,
                                                tbl_os_item.defeito,
                                                tbl_os_item.parametros_adicionais,
                                                tbl_os_item.admin,
                                                tbl_os_item.peca_obrigatoria as devolucao_obrigatoria,
                                                tbl_os_item.fornecedor
                                        FROM    tbl_os_item
                                        JOIN    tbl_os_produto  USING(os_produto)
                                        JOIN    tbl_os          USING(OS)
                                        WHERE   tbl_os.os = $os");

    } else {
        $auditorLog = new AuditorLog();
        $auditorLog->retornaDadosSelect("select * from tbl_os join tbl_os_produto using(os) join tbl_os_item using(os_produto) where os = {$os}");
    }

    $res = pg_query($con, "BEGIN TRANSACTION");

    $defeito_constatado       = $_POST['defeito_constatado'];

    if($login_fabrica == 72 and strlen(trim($defeito_constatado))==0){
        $msg_erro .= "Por favor, preencha o campo do defeito constatado. <Br>";
    }

    if ($defeito_constatado == '20934') {
        $respostas = array();

        foreach (range(0, 2) as $idx) {
            if (empty($_POST['resposta_' . $idx])) {
                $msg_erro.= 'Para o defeito MÁQUINA NÃO APRESENTOU DEFEITO é necessário responder todas as perguntas.<br/>';
                break;
            }

            $respostas[$_POST['pergunta_' . $idx]] = $_POST['resposta_' . $idx];
        }
    }

     // Adicionar vários defeitos constatados para uma única OS
    //if(in_array($login_fabrica,array(2, 30, 59,94,131,134,144))) {

    if (in_array($login_fabrica,array(30))) {
        $numero_vezes = 100;
        $array_integridade  = array();
        $todosDefeitos      = array();
        $defeito_cor_etiqueta_fornecedor = false; 

        for ($i=1; $i < $numero_vezes; $i++) {

            $pedir_cor_etiqueta = false; 

            $int_constatado = trim($_POST["integridade_defeito_constatado_" . $i]);
            $int_solucao    = trim($_POST["integridade_solucao_" . $i]);
            if($login_fabrica == 30){
                $cor_etiqueta_fornecedor   = trim($_POST['integridade_cor_fornecedor_'.$i]);
            }    

            if($login_fabrica == 30 and strlen($cor_etiqueta_fornecedor)>0){
                $defeito_cor_etiqueta_fornecedor = true; 

                $sql_dc = "SELECT defeito_constatado, campos_adicionais from tbl_defeito_constatado where defeito_constatado = $int_constatado and fabrica = $login_fabrica ";
                $res_dc = pg_query($con, $sql_dc);
                if(pg_num_rows($res_dc)>0){
                    $campos_adicionais_dc = json_decode( pg_fetch_result($res_dc, 0, 'campos_adicionais')   ,true);
                    $pedir_cor_etiqueta = (isset($campos_adicionais_dc['pedir_cor_etiqueta'])) ? true : false; 
                }
            }       

            if (!isset($_POST["integridade_defeito_constatado_" . $i])) continue;

            if (strlen($int_constatado) == 0) {
                $msg_erro ="Favor adicionar o ".$tema;
                break;
            }

            $aux_defeito_constatado = $int_constatado;
            $aux_solucao            = $int_solucao;
            $aux_campo_solucao      = " solucao, ";

            if (empty($aux_solucao)) {
                $aux_campo_solucao = "";
            } else {
                $aux_solucao = "$aux_solucao,";
            }

            array_push($array_integridade,$aux_defeito_constatado);

            $sql = "SELECT defeito_constatado_reclamado 
                    FROM tbl_os_defeito_reclamado_constatado
                    WHERE os = $os
                    AND   defeito_constatado = $aux_defeito_constatado";

            $res = pg_query ($con,$sql);
                    
            $msg_erro .= pg_errormessage($con);

            if (@pg_num_rows($res)==0) {

                if(in_array($login_fabrica,array(94,131,134,144))){

                    $sql = "INSERT INTO tbl_os_defeito_reclamado_constatado(
                                os,
                                defeito_constatado,
                                fabrica
                            )VALUES(
                                $os,
                                $aux_defeito_constatado,
                                $login_fabrica
                            )   ";
                } else {

                    $campos_adicionais = null;

                    if($login_fabrica == 30 and strlen($cor_etiqueta_fornecedor) > 0 and $pedir_cor_etiqueta == true){
                        $campos_adicionais['cor_etiqueta_fornecedor'] = $cor_etiqueta_fornecedor; 
                        $campos_adicionais = json_encode($campos_adicionais);     

                        $cmp_campos_adicionais = ", campos_adicionais  "; 
                        $vl_campos_adicionais = ", '$campos_adicionais' ";                         
                    }else{
                        $cmp_campos_adicionais = " "; 
                        $vl_campos_adicionais = " "; 
                    }

                    $sql = "INSERT INTO tbl_os_defeito_reclamado_constatado(
                                os,
                                defeito_constatado,
                                $aux_campo_solucao
                                fabrica 
                                $cmp_campos_adicionais
                            )VALUES(
                                $os,
                                $aux_defeito_constatado,
                                $aux_solucao
                                $login_fabrica 
                                $vl_campos_adicionais
                            )";

                }
                $res = pg_query ($con,$sql);

                       // $msg_erro .= $sql;
                $msg_erro .= pg_errormessage($con);

                if ($login_fabrica == 30) {
                    $sqlDef = "
                        SELECT  descricao
                        FROM    tbl_defeito_constatado
                        WHERE   defeito_constatado = $aux_defeito_constatado
                    ";
                    $resDef = pg_query($con,$sqlDef);
                    array_push($todosDefeitos,pg_fetch_result($resDef,0,descricao));
                }
            }
        }

        if ($login_fabrica == 30 && strlen($todosDefeitos) > 0) {
            $defeitos = implode(", ",$todosDefeitos);
            $msg = "Defeitos cadastrados na OS: $defeitos";

            $sql = "
                    INSERT INTO tbl_os_interacao (
                        programa,
                        os,
                        data,
                        comentario,
                        interno,
                        fabrica,
                        admin
                    ) VALUES (
                        '$programa_insert',
                        $os,
                        CURRENT_TIMESTAMP,
                        '$msg',
                        TRUE,
                        $login_fabrica,
                        $login_admin
                    );
                ";
            $res = pg_query($con,$sql);
        }

        $lista_defeitos = implode(",",$array_integridade);

        if(!empty($lista_defeitos)){
            $sql = "DELETE FROM tbl_os_defeito_reclamado_constatado
                    WHERE os = $os
                    AND   defeito_constatado NOT IN ($lista_defeitos) ";
            $res = @pg_query ($con,$sql);
            $msg_erro .= pg_errormessage($con);
            //o defeito constatado recebe o primeiro defeito constatado.
        }
        
        $defeito_constatado = $aux_defeito_constatado;

    }

    $causa_defeito            = $_POST['causa_defeito'];
    $data_fechamento          = $_POST['data_fechamento'];
    $defeito_constatado_grupo = $_POST['defeito_constatado_grupo'];
    $falha_em_potencial     = $_POST["falha_em_potencial"];
    $ajusterealizado        = $_POST["ajusterealizado"];


    if ($login_fabrica == 72 &&  strlen($msg_erro) == 0 && in_array($_POST['solucao_os'], array(3042, 3043, 3044, 3045, 3046))) {//fputti HD-3130038

        if (strlen($ajusterealizado) == 0) {
            $msg_erro .= "O campo Ajuste Realizado é obrigatório.<br />";
        }

        if (strlen($msg_erro) == 0) {
            $sql = " UPDATE tbl_os_extra SET obs_adicionais = '$ajusterealizado' WHERE os = $os";
            $res = pg_query ($con,$sql);
            $msg_erro .= pg_errormessage($con);
        }

    }

    if(strlen($falha_em_potencial) ==0 AND $login_fabrica == 72){
    $msg_erro .= "Informe a Falha em Potêncial";
    }

    if ($login_fabrica == 72 && strlen($msg_erro) == 0 && strlen($falha_em_potencial) > 0) {//fputti HD-3130038
        $sql = "SELECT tbl_os.os, tbl_os_produto.servico, tbl_os_produto.os_produto
                  FROM tbl_os_produto
                  JOIN tbl_os ON tbl_os.os=tbl_os_produto.os
                 WHERE tbl_os.os=$os
                   AND tbl_os.fabrica=$login_fabrica
                   AND tbl_os_produto.servico IS NOT NULL";
        $res = pg_query($con,$sql);
        if (pg_num_rows($res) > 0) {
            $xoss       = pg_fetch_result($res, 0, os);
            $os_produto = pg_fetch_result($res, 0, os_produto);
            $sqlUp      = "UPDATE tbl_os_produto
                              SET servico=$falha_em_potencial
                            WHERE os=$xoss
                              AND os_produto=$os_produto";
            $resUp     = @pg_query($con,$sqlUp);
            $msg_erro .= pg_errormessage($con);
        } else {
            $prod_referencia = $_POST["produto_referencia"];
           if (strlen($prod_referencia) > 0) {
                $sqlProduto = "SELECT tbl_produto.produto
                      FROM tbl_produto
                      JOIN tbl_os ON tbl_os.produto=tbl_produto.produto
                     WHERE tbl_os.os=$os
                       AND tbl_os.fabrica=$login_fabrica
                       AND tbl_produto.referencia='$prod_referencia'";
                $resProduto = pg_query($con, $sqlProduto);
                if (pg_num_rows($resProduto) > 0) {
                    $produto = pg_fetch_result($resProduto, 0, produto);
                    $sqlIns = "INSERT INTO tbl_os_produto (
                            os     ,
                            produto,
                            servico
                        )VALUES(
                            $os     ,
                            $produto,
                            $falha_em_potencial
                    );";

                    $resIns    = @pg_query($con,$sqlIns);
                    $msg_erro .= pg_errormessage($con);
                }
            }
        }
    }

    if (in_array($login_fabrica, array(30,144))) {
        $necessita_troca_produto = $_POST["necessita_troca_produto"];
        $motivo_troca = $_POST['motivo_troca'];
        if (!strlen($necessita_troca_produto)) {
            $necessita_troca_produto = "f";
        }

        if($login_fabrica == 30 && $necessita_troca_produto == 't' && strlen($motivo_troca) == 0){
            $msg_erro .= "É necessário gravar o motivo da solicitação de troca.";
        }
        if (!empty($defeito_constatado) && in_array($login_fabrica, array(141))) {
            $sql = "SELECT defeito_constatado FROM tbl_defeito_constatado WHERE fabrica = {$login_fabrica} AND defeito_constatado = {$defeito_constatado} AND defeito_constatado_grupo IS NOT NULL";
            $res = pg_query($con, $sql);

            if (pg_num_rows($res) > 0) {
                $laudo_produto_fora_garantia = $_POST["laudo_produto_fora_garantia"];

                $tem_pecas = false;

                for ($i = 0; $i < $qtde_item; $i++) {
                    if (strlen($_POST["peca_{$i}"]) > 0 || strlen($_POST["descricao_{$i}"]) > 0) {
                        $tem_pecas = true;
                        break;
                    }
                }

                if ($necessita_troca_produto == "t") {
                    $msg_erro .= "Para produto fora de garantia não pode ser solicitado a troca do produto <br />";
                } else if ($tem_pecas == true) {
                    $msg_erro .= "Para produto fora de garantia não pode ser lançado peças <br />";
                } else if (empty($laudo_produto_fora_garantia)) {
                    $msg_erro .= "Selecione o laudo <br />";
                } else if (!strlen($_FILES["foto_produto"]["tmp_name"])) {
                    $msg_erro .= "Anexe a foto do produto <br />";
                } else {
                    $foto_produto = $_FILES["foto_produto"];

                    $ext = preg_replace("/.+\./", "", $foto_produto["name"]);

                    if ($ext == "jpeg") {
                        $ext = "jpg";
                    }

                    if (!in_array($ext, array("png", "jpg", "bmp"))) {
                        $msg_erro .= "Foto do produto com formato inválido, são aceitos os seguintes formatos: png, jpg, bmp";
                    }
                }
            }
        }
    }

    if ((strlen($causa_defeito) == 0 OR $causa_defeito == 'Selecione uma opção') AND ($login_fabrica == 131)){
            $msg_erro .= "Informe a causa do ".$tema." <br />";
    }

    if (in_array($login_fabrica,array(91,125)) and !empty($defeito_constatado)) {
        $sqlLP = "SELECT lancar_peca FROM tbl_defeito_constatado WHERE defeito_constatado = $defeito_constatado AND lancar_peca IS TRUE";
        $qryLP = pg_query($con, $sqlLP);

        if (pg_num_rows($qryLP) > 0) {
            for ($i = 0; $i < (int) $_POST['qtde_item']; $i++) {
                if (!empty($_POST['peca_' . $i])) {
                    $erro_lancar_peca = '';
                    break;
                }
                if($login_fabrica == 91){
                    $erro_lancar_peca = 'Favor selecionar a peça que foi conectada ou regulada, colocando no item Serviços - Ajuste elétrico ou mecânico(não gera pedido).<br/>';
                }
                if($login_fabrica == 125){
                    $erro_lancar_peca = 'Para o defeito selecionado, é obrigatório informar a peça a ser trocada.<br/>';
                }
            }
        }

        $msg_erro.= $erro_lancar_peca;
    }

    if(in_array($login_fabrica, array(120,201))){

        $sqlLP = "SELECT lancar_peca FROM tbl_defeito_constatado WHERE defeito_constatado = $defeito_constatado AND lancar_peca IS FALSE";
        $qryLP = pg_query($con, $sqlLP);

        if(pg_num_rows($qryLP) > 0){

            if(strlen($_POST['peca_0']) > 0){
                $msg_erro .= "Para o ".$tema." não é necessário Peça <br />";
            }

        }

    }

    if (strlen($data_fechamento) > 0) {

        $xdata_fechamento = fnc_formata_data_pg ($data_fechamento);
        if ($xdata_fechamento > "'".date("Y-m-d")."'") $msg_erro.= "Data de fechamento maior que a data de hoje.";

    }

    $sql = "SELECT consumidor_revenda from tbl_os where os = $os";
    $res = pg_query($con, $sql);

    $consumidor_revenda = pg_fetch_result($res, 0, 'consumidor_revenda');

    $sem_anexo = false;

    $filesByImageUploader = 0;
    if ($fabricas_image_uploader) {
        $rvt = new TDocs($con,$login_fabrica);
        $qtdeAnexos = (int) $rvt->getDocumentsByRef($os,'os')->attachCount;

        if (!isset($limite_anexos_nf)) {
            $limite_anexos_nf = 1 - $qtdeAnexos;
        }

        if($limite_anexos_nf < 1) $limite_anexos_nf = 1;

        $objectId = $_POST['objectid'];
        $sqlDocs = "SELECT tdocs, tdocs_id, referencia, obs FROM tbl_tdocs WHERE referencia_id = 0 AND referencia = '$objectId' AND contexto = 'os' ORDER BY data_input ASC LIMIT $limite_anexos_nf";
        $resDocs = pg_query($con,$sqlDocs);
        $resDocs = pg_fetch_all($resDocs);
        if(count($resDocs)>0 && $resDocs != false){
            foreach ($resDocs as $key => $value) {
                $sqlUpate = "UPDATE tbl_tdocs set fabrica = $login_fabrica, referencia = 'os', referencia_id = $os WHERE tdocs = ".$value['tdocs'];
                $res = pg_query($con, $sqlUpate);
                if(pg_last_error($con)){
                    $msg_erro .= "<br>".pg_last_error($con);
                }
                $filesByImageUploader += 1;
            }
        }
    }

    // HD 350051 - Obrigatoriedade para as que exigem imagem da NF.
    if(!in_array($login_fabrica,array(15, 3)) && !$fabricaFileUploadOS){
        if ($anexaNotaFiscal and !temNF($os, 'bool') and
            (($login_fabrica == 43 and $consumidor_revenda == 'C') or // HD 354997 - ImgNF obrig. para 43 só OS Consumidor
             ($login_fabrica != 43 and $login_fabrica <> 72 and $fabricas_anexam_NF[$login_fabrica]['nf_obrigatoria'] == true)) and $fabricas_image_uploader and $filesByImageUploader == 0) {

            if(in_array($login_fabrica, array(42))){

                $sem_anexo = true;

            }else{

                $msg_erro .= "Não pode ser gravada a OS sem que haja uma imagem da Nota Fiscal.";

            }
        }
    }

    if(in_array($login_fabrica, array(42)) && $sem_anexo === true){

        $amazonTC->getObjectList("anexo_os_{$login_fabrica}_{$os}_img_os_");
        $files_anexo_os = $amazonTC->files;

        if(count($files_anexo_os) == 0){

            $msg_erro .= "Não pode ser gravada a OS sem que haja uma imagem da Nota Fiscal.";

        }

    }

    if($login_fabrica == 24){
        $referencia_produto = $_POST["produto_referencia"];
        $serie = $_POST["produto_serie"];

        $sqlNS = "SELECT * FROM  tbl_numero_serie where serie = '$serie' and referencia_produto = '$referencia_produto' and fabrica = $login_fabrica";
        $resNS = pg_query($con, $sqlNS);
        if(pg_num_rows($resNS)==0){
            $msg_erro .= "NÚMERO DE SÉRIE INVÁLIDO OU NÃO ENCONTRADO PARA ESSE PRODUTO <br> ";
        }

        $sqlns = "SELECT produto_serie
            FROM tbl_produto_serie
            WHERE '$serie' between serie_inicial and serie_final
            AND fabrica = $login_fabrica AND serie_ativa is true ";
        $resns = pg_query($con, $sqlns);
        if(pg_num_rows($resns)>0){
            $msg_erro .= "NÚMERO DE SÉRIE BLOQUEADO, ENTRAR EM CONTATO COM A FÁBRICA. <br> ";
        }
    }    

    //Samuel 18-08 a pedido do Fabricio da Britania o campo Defeito constatado e solucao passam a ser obrigatorios
    //HD 206869: Exigir digitação de defeito constatado
    if (!in_array($login_fabrica,array(30,114,144)) && $fabrica_exigir_defeito_constatado) {
        if (strlen($defeito_constatado)==0) {
            $msg_erro .= strtoupper("Por favor preencher o campo ".$tema.".<br />");
        }

        if ($fabrica_solucao_os_obrigatoria) {
            $solucao_os = $_POST['solucao_os'];
            if (strlen($solucao_os) == 0) {
                $msg_erro .= "Por favor preencher o campo solução.<BR>";
            }

        }

    }

    if (in_array($login_fabrica, [123])) {

        if ((data_corte_termo($os)) && $_FILES['foto_termo']['tmp_name'] == '') {
            $tem_termo = false;
            unset($anexou_termo);

            $sql_termo = "SELECT obs FROM tbl_tdocs WHERE referencia_id = $os AND fabrica = $login_fabrica";
            $res_termo = pg_query($con, $sql_termo);
            if (pg_num_rows($res_termo) > 0) {
                for ($t=0; $t < pg_num_rows($res_termo); $t++) { 
                    $anexou_termo = pg_fetch_result($res_termo, $t, 'obs');
                    $anexou_termo = json_decode($anexou_termo, true);
                    if ($anexou_termo[0]['termo_entrega'] == 'ok') {
                        $tem_termo = true;
                        break;
                    }
                }
            }

            if ($tem_termo === false) {
                $msg_erro .= "Anexar o termo de entrega";
            }
        }
    }

    if(strlen($solucao_os) > 0 AND $login_fabrica == 117){
        $sqlSolucao = "SELECT solucao
                        FROM tbl_solucao
                        WHERE solucao = $solucao_os
                        AND fabrica = $login_fabrica
                        AND descricao ~* 'compressor'";
        $resSolucao = pg_query($con,$sqlSolucao);
      if(pg_num_rows($resSolucao) > 0){
        $sql_status = "SELECT os FROM tbl_os_status WHERE os={$os} and status_os = 167;";
        $res_status = pg_query($con, $sql_status);

        if (pg_num_rows($res_status) == 0 ) {
                    $sql = "INSERT INTO tbl_os_status (os,status_os,observacao,automatico) VALUES ($os,167,'OS em intervenção por troca de compressor','t')";
                $res = @pg_query ($con,$sql);
        }
    }

    if(!empty($os)) {
        $sqlD = "SELECT tbl_os.defeito_constatado, count(1)
            FROM tbl_os
            JOIN tbl_os_produto USING(os)
            JOIN tbl_os_item USING(os_produto)
                        WHERE tbl_os.os = $os
            AND fabrica = $login_fabrica
            GROUP BY tbl_os.defeito_constatado";
        $resD = pg_query($con,$sqlD);
        if(pg_num_rows($resD) >0 ) {
            $dc_intervencao = pg_fetch_result($resD,0,0);
            $qt_intervencao = pg_fetch_result($resD,0,1);
        }
    }
    }

    if(strlen($_POST['custo_extra']) > 0 AND $inf_valores_adicionais){

        $sql = "SELECT status_os FROM tbl_os_status WHERE tbl_os_status.os = $os AND status_os IN(171,172,173) ORDER BY data DESC LIMIT 1";
        $res = pg_query($con, $sql);
        if(pg_num_rows($res) > 0){
            $status_os = pg_fetch_result($res, 0, 'status_os');
        }
        $outros_custos = $_POST['outros_custos'];
        $custo_extra = $_POST['custo_extra'];

        $valor_adicional_formatado = retira_acentos($_POST['valor_adicional_formatado']);

        $valor_adicional_formatado = str_replace("\\","",$valor_adicional_formatado);
        $valor_format = json_decode($valor_adicional_formatado,true);
        if($login_fabrica == 125 and !empty($valor_format[0]['ALINHAMENTO'])) {
            $qtde_item = $_POST['qtde_item'];
            for($x = 0 ;$x< $qtde_item;$x++ ){
                $servico = $_POST['servico_'.$x];
                if(!empty($servico)){
                    $sql ="SELECT servico_realizado
                            FROM tbl_servico_realizado
                            WHERE servico_realizado = $servico
                            AND (descricao ~* 'motor' or descricao ~* 'trilho'); ";
                    $res = pg_query($con, $sql);
                    if(pg_num_rows($res) > 0) {
                        //$valor_format[0]['ALINHAMENTO'] = 0 ;
                        $valor_adicional_formatado = json_encode($valor_format);
                        break;
                    }
                }
            }
        }

        if(count($valor_format[0]) == 0 AND count($valor_format[1]) == 0){
            $valor_adicional_formatado = "";
        }

        $gravaValoresAdicionais = array(35, 125, 131, 139);

        if(in_array($login_fabrica, $gravaValoresAdicionais)){

            $totalValoresAdicionais = 0;

            if(count($valor_format[0]) > 0){

                foreach($valor_format[0] as $v){
                    if(strstr($v, ",")){
                        $v = str_replace(",", ".", $v);
                    }
                    $totalValoresAdicionais += $v;
                }

            }

            if(count($valor_format[1]) > 0){

                foreach($valor_format[1] as $v){
                    if(strstr($v, ",")){
                        $v = str_replace(",", ".", $v);
                    }
                    $totalValoresAdicionais += $v;
                }

            }

            if(!strstr($totalValoresAdicionais, ".")){
                $totalValoresAdicionais = $totalValoresAdicionais.".00";
            }
            $sql = "UPDATE tbl_os SET valores_adicionais = '$totalValoresAdicionais' WHERE os = $os AND fabrica = $login_fabrica";
            $res = pg_query($con, $sql);

            $totalValoresAdicionais = "";

        }

        if(!empty($valor_adicional_formatado) AND $status_os != 171){
            if(!in_array($login_fabrica,array(35,125))){
                $sql = "INSERT INTO tbl_os_status (os,status_os,observacao,automatico) VALUES ($os,171,'OS em intervenção de custos adicionais','t')";
                $res = @pg_query ($con,$sql);
            }

            $sql = "select * from tbl_os_campo_extra where os = $os";
            $res = pg_query ($con,$sql);
            if(pg_num_rows($res) > 0){
                $sql = "UPDATE tbl_os_campo_extra SET valores_adicionais = '$valor_adicional_formatado' WHERE os = $os";
            }else{
                $sql = "INSERT INTO tbl_os_campo_extra(os,fabrica,valores_adicionais) VALUES($os,$login_fabrica,'$valor_adicional_formatado')";
            }

            $res = pg_query ($con,$sql);
        }
    }
    if (in_array($login_fabrica,array(3)) AND empty($tecnico)) {
        #$msg_erro .= "Por favor informe um técnico.<BR>";
    }

    if (in_array($login_fabrica, array(30, 50, 94))) {

        if (in_array($login_fabrica, array(30,50))) {
            $km      = 1;
            $qtde_km = $_POST["distancia_km"];
            $qtde_km = str_replace(",", ".", $qtde_km);
        }else{
            $km      = $_POST["km"];
            $qtde_km = $_POST["qtde_km"];
        }

        if ($km == 1 AND (strlen($qtde_km) == 0 OR $qtde_km == 0) and $login_fabrica == 94) {

            $msg_erro = "Informe a distância de KM";

        } else if ($km == 1) {
            if ($qtde_km > 100 and $login_fabrica == 94) {

                // HD 955738 removido a pedido do cliente $qtde_km -= 100; // HD 415106 - Foi solicitado para pagar somente o que exceder de 100km. Brayan.
                $sql = "UPDATE tbl_os SET qtde_km = '$qtde_km' WHERE os = $os";
                $res = @pg_query ($con,$sql);
                $sql = "SELECT os
                    FROM tbl_os_status
                    WHERE status_os = 98
                    AND os = $os";
                $res = @pg_query ($con,$sql);
                if(pg_num_rows($res) == 0) {
                    $sql = "INSERT INTO tbl_os_status (os,status_os,observacao,automatico) VALUES ($os,98,'Quantidade de KM calculado superior a 100 km.','t')";
                    $res = @pg_query ($con,$sql);
                }

            } else if (in_array($login_fabrica, array(30,50)) && $qtde_km > 0 && strlen($_POST['informar_km']) > 0 ){
                if ($login_fabrica == 50) { //HD: 24813 - PARA

                    $qtde_km_aux = $qtde_km;
                    //desconta 20 km pois entende-se que é area hurbana e não pagam os 20'
                    $qtde_km = $qtde_km - 20;
                    $qtde_km = ($qtde_km < 0) ? 0 : $qtde_km;
                    $obs_km = " OS entrou em auditoria de km ({$qtde_km}).";
                } else {
                    $obs_km = " OS entrou em auditoria de km ({$qtde_km}).";
                }

                if ($login_fabrica == 30 || ($login_fabrica == 50 && $qtde_km_aux >= 50)) {
                    // HD 955738 removido a pedido do cliente $qtde_km -= 100; // HD 415106 - Foi solicitado para pagar somente o que exceder de 100km. Brayan.
                    $sql = "UPDATE tbl_os SET qtde_km = {$qtde_km}, tipo_atendimento = 41 WHERE os = {$os};";
                    $res = @pg_query ($con,$sql);
                    $sql = "SELECT os
                        FROM tbl_os_status
                        WHERE status_os = 98
                        AND os = $os";
                    $res = @pg_query ($con,$sql);
                    if(pg_num_rows($res) == 0) {
                        $sql = "INSERT INTO tbl_os_status (os,status_os,observacao,automatico) VALUES ({$os},98,'{$obs_km}','t')";
                        $res = @pg_query ($con,$sql);
                    }
                }
            } else {
                $qtde_km = 0;
            }
        } else {
            $qtde_km = 0;
        }
    }

    // HD 415550 - Inicio
    if (isset($_POST['valor_mao_de_obra'])) {

        $valor     = str_replace(',','.', $_POST ['valor_mao_de_obra']);
        $int_valor = (int) $valor;
        $valor     = ( !empty($int_valor) ) ? $valor : 0;

        $sql = "UPDATE tbl_os SET mao_de_obra = " . $valor . " WHERE os = " . $os ;
        $res = pg_query($con,$sql);

    }

    // HD 415550 - FIM
    if (in_array($login_fabrica,array(30,114))) {

        $aux_defeito_constatado_codigo    = $_POST['defeito_constatado_codigo'];
        $aux_defeito_constatado_descricao = $_POST['defeito_constatado_descricao'];
        $qtde_integridade                 = $_POST['qtde_integridade'];

        for ($f = 1; $f <= $qtde_integridade; $f++) {
            $integridade_defeito_constatado .= $_POST['integridade_defeito_constatado_'.$f] . ';';
            $integridade_defeito_descricao  .= $_POST['integridade_defeito_descricao_'.$f] . ';';
        }

    }

    if (in_array($login_fabrica, array(15,19,24,30,50,52,74,85,137))) {

        if (isset($_POST['produto_serie'])) {
            $referencia_produto_serie = trim($_POST['produto_referencia']);
            $produto_serie = trim($_POST['produto_serie']);
            $xproduto_serie_db = trim($_POST['produto_serie_db']);


                //HD-6856662
                if ($login_fabrica == 30) {
                     $produto_serie = $_POST['produto_serie'];     
                   if ($produto_serie == '00000000000000') {
                       if($fabricaFileUploadOS){
                            $sql = "SELECT tdocs
                                    FROM tbl_tdocs 
                                    WHERE referencia_id = $os
                                    AND fabrica =   $login_fabrica
                                    AND situacao = 'ativo'";
                                    $res = pg_query($con, $sql);//exit($sql);
                           if(pg_num_rows($res) == 0){
                                $msg_erro = 'É necessário informar anexos de nota ou fotos de produto <br>';
                           }    
                        }  
                     }       
                }

            if (in_array($login_fabrica, array(30, 50))) {
                $chkNS = "SELECT numero_serie_obrigatorio FROM tbl_produto JOIN tbl_os using(produto) WHERE os = {$os} AND numero_serie_obrigatorio IS TRUE;";
                $qry = pg_query($con, $chkNS);

                if (pg_num_rows($qry) > 0 and empty($produto_serie)) {
                    $msg_erro.= 'É Obrigatório o cadastro do número de série deste produto<br/>';
                }
            }

            if (in_array($login_fabrica, array(50))) {
                if (!empty($produto_serie)) {
                    if (!is_numeric($produto_serie)) {
                        $msg_erro .= "Número de série {$produto_serie} inválido para o produto!";
                    } else if (strlen($produto_serie) > 20) {
                        $msg_erro .= "Número de série não pode ser maior que 20 dígitos!";
                    } else {
                        $sqlSerie = "SELECT serie
                                            FROM tbl_numero_serie
                                            WHERE fabrica = {$login_fabrica}
                                            AND referencia_produto = '{$referencia_produto_serie}'
                                            AND (serie = '{$produto_serie}'
                                            OR (substr(serie, 1, length(serie) - 1) = '{$produto_serie}'
                                            AND data_fabricacao BETWEEN '2013-07-25' AND '2013-09-13'));";
                        $resSerie = pg_query($con, $sqlSerie);

                        if (pg_num_rows($resSerie) == 0) {
                            $chkAudit = "SELECT ost.status_os, oa.os_auditar FROM tbl_os_status ost LEFT JOIN tbl_os_auditar oa USING(os) WHERE ost.os = {$os} AND ost.status_os IN (102,103,104) ORDER BY ost.data DESC LIMIT 1;";
                            $resAudit = pg_query($con, $chkAudit);

                            $status_os_serie = pg_fetch_result($resAudit, 0, status_os);
                            $os_auditar_serie = pg_fetch_result($resAudit, 0, os_auditar);

                            if ($status_os_serie != 102 && empty($os_auditar_serie) && $produto_serie != $xproduto_serie_db) {
                                $sqlInstAuditSerie = "INSERT INTO tbl_os_status (os, status_os, observacao) VALUES ({$os}, 102, 'OS Aguardando aprovação de número de Série.');";
                                $resInstAuditSerie = pg_query($con, $sqlInstAuditSerie);

                                if (strlen(pg_last_error($con)) > 0) {
                                    $msg_erro .= "Ocorreu um erro na gravação dos dados!";
                                }
                            }
                        }

                    }
                }
            }

            if(empty($produto_serie) && $login_fabrica == 137 && $posto_interno !== true){
                $msg_erro .= "O número de Lote é obrigatório <br />";
            }

            if(empty($msg_erro) && $login_fabrica == 137 && $posto_interno !== true){
                $auditoria_numero_serie = $_POST['auditoria_numero_serie'];
                if($auditoria_numero_serie == "sim"){
                    $msg_auditoria = "Intervenção de Número de Série: $produto_serie";
                    $sql_auditoria_serie = "
                        INSERT INTO tbl_os_status (os, status_os, observacao, automatico)
                        VALUES($os, 102, '$msg_auditoria', 't');
                    ";
                    $res_auditoria_serie = pg_query($con, $sql_auditoria_serie);
                }
            }

        }else{

            if($login_fabrica == 24){
                $msg_erro .= "Preencha o número de série <br />";

            }
            if($login_fabrica == 137 && $posto_interno !== true){
                $msg_erro .= "O número de Lote é obrigatório <br />";
            }
        }

    if ($login_fabrica == 74) {

        $sql = "SELECT interv_reinc.os
                    FROM (
                        SELECT
                        ultima_reinc.os,
                        (SELECT status_os
                        FROM tbl_os_status
                        WHERE fabrica_status = $login_fabrica
                        AND tbl_os_status.os = ultima_reinc.os AND status_os IN (131,135,67,103,102,103,64) order by data desc LIMIT 1) AS ultimo_reinc_status
                        FROM (SELECT DISTINCT os
                        FROM tbl_os_status
                        JOIN tbl_os USING(os)
                        WHERE tbl_os.os = $os
                        AND fabrica_status = $login_fabrica
                        AND tbl_os.finalizada IS NULL AND status_os IN (131,135,67,103,102,103,64) ) ultima_reinc
                        ) interv_reinc
                    WHERE interv_reinc.ultimo_reinc_status IN (64,103,135)";

        $res = pg_query($con, $sql);

        if (pg_numrows($res) > 0) {
            $os_aprovada = "aprovada";
        }

        if (strlen($produto_serie) == 0 and $login_fabrica != 74) {

            $msg_erro = "Número de série obrigatório";

        } else {

            $data_fab = $_POST['data_fabricacao'];

            if ( !empty($data_fab) || $login_fabrica == 74 ) { // HD 854585 - Para atlas vai zerar a data fab. caso seja vazia (num. serie irregular)

                if (empty($data_fab)) {

                    $xxdata_fabricacao = 'NULL';

                } else {

                    list($d,$m,$y) = explode('/',$data_fab);
                    $xxdata_fabricacao = "'$y-$m-$d'";

                }

                $sql = "UPDATE tbl_os_extra SET data_fabricacao = $xxdata_fabricacao WHERE os = $os";
                $res = pg_query($con, $sql);
                // $msg_erro .= pg_errormessage($con);

            }
        }
    }

    #HD 708727 - Condição para lorenzetti - Obrigatóriedade do numero de série somente para a linha 265
    if ($login_fabrica == 19) {

        $sql = "SELECT  tbl_produto.linha
                FROM    tbl_os
                JOIN    tbl_produto on (tbl_os.produto = tbl_produto.produto)
                WHERE   tbl_os.fabrica = $login_fabrica
                AND     tbl_os.os = $os";

        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0) {

            $produto_linha_lorenzetti = pg_result($res, 0, 0);

            if ($produto_linha_lorenzetti == 265) {

                if (strlen($produto_serie) == 0) {
                    $msg_erro = "Número de série obrigatório para este produto";
                }

            }

        }

    }

    if ($login_fabrica == 30) {

        $xproduto_serie = $produto_serie;

        #HD 276459 visita_agendada

        $visita_agendada     = $_POST['visita_agendada'];
        list($d,$m,$y)       = explode('/', $visita_agendada);
        $visita_agendada_aux = "$y-$m-$d";

        if (strlen($visita_agendada) > 0) {

                $sql = "UPDATE tbl_os
                        SET visita_agendada = '$visita_agendada_aux'
                        WHERE os     = $os
                        AND posto  = $login_posto";

            $res = pg_query($con,$sql);
            if(pg_errormessage($con)){
                $msg_erro .= "<br>Erro ao gravar agendamento verifique data";
            }else{
                $gravou_visita = "sim";
            }
        }
    }

    if (strlen($msg_erro) == 0 AND isset($_POST['produto_serie'])) {

        if ($login_fabrica == 74) {

            /*$sql = "SELECT fn_verifica_serie_atlasfogoes(os, serie, '$produto_serie',$xxdata_fabricacao, NULL)
                    FROM tbl_os
                    WHERE os = $os
                    AND serie != '$produto_serie'";

            $res = pg_query($con, $sql);
            $msg_erro .= pg_errormessage($con);*/

            $produto_serie = $_POST['produto_serie'];

            /**
             * Toda essa parte de verificação de número de série foi refatorada
             * o código anterior não fazia nenhum sentido
             * vampos parar de preguiça e fazer um código simples é só pensar um pouco
             */
            $sqlVerificaIntervaloSerie = "  SELECT * FROM tbl_produto_serie
                                            WHERE fabrica = $login_fabrica
                                            AND tbl_produto_serie.serie_ativa IS TRUE
                                            AND $produto_serie BETWEEN serie_inicial::bigint and serie_final::bigint";

            $res = pg_query($con,$sqlVerificaIntervaloSerie);

            $sqlVerificaCampo = "
                SELECT campos_adicionais
                FROM tbl_os_campo_extra
                WHERE fabrica = {$login_fabrica}
                AND os = {$os}
            ";
            $resVerificaCampo = pg_query($con, $sqlVerificaCampo);

            if (pg_num_rows($resVerificaCampo) > 0) {
                $campos_adicionais = pg_fetch_result($resVerificaCampo, 0, "campos_adicionais");

                if (!empty($campos_adicionais)) {
                    $campos_adicionais = json_decode($campos_adicionais, true);
                } else {
                    $campos_adicionais = array();
                }
            } else {
                $campos_adicionais = array();
            }

            if (pg_num_rows($res) > 0 && (!isset($campos_adicionais["ns_sequencia"]) || $campos_adicionais["ns_sequencia"] == "f")) {
                $campos_adicionais["ns_sequencia"] = "t";
            } else if ($campos_adicionais["ns_sequencia"] == "t") {
                $campos_adicionais["ns_sequencia"] = "f";
            }

            $campos_adicionais = json_encode($campos_adicionais);

            if (!pg_num_rows($resVerificaCampo)) {
                $sqlCamposAdicionais = "
                    INSERT INTO tbl_os_campo_extra
                    (os, fabrica, campos_adicionais)
                    VALUES
                    ({$os}, {$login_fabrica}, '{$campos_adicionais}')
                ";
            } else {
                $sqlCamposAdicionais = "
                    UPDATE tbl_os_campo_extra SET
                        campos_adicionais = '{$campos_adicionais}'
                    WHERE fabrica = {$login_fabrica}
                    AND os = {$os}
                ";
            }

            $resCamposAdicionais = pg_query($con, $sqlCamposAdicionais);

            $enviar_email_atlas = "false";

            if (strlen(pg_last_error()) > 0) {
                $msg_erro =  "Erro na verificação de série";
            } else if (pg_num_rows($res) > 0) {
                $enviar_email_atlas = "true";
            }
        }

        $sql = "UPDATE tbl_os
                SET serie = '$produto_serie'
                WHERE os     = $os
                AND posto  = $login_posto ; 
                SELECT fn_valida_os($os, $login_fabrica) ;";
        $res = pg_query($con,$sql);
        $msg_erro .= pg_errormessage($con);

        $sql      = "SELECT current_timestamp - data_digitacao < '00:05:00' FROM tbl_os WHERE os = $os ";
        $res      = pg_query($con,$sql);
        $verifica = pg_fetch_result($res,0,0);

        if ($verifica == 't') {
            $sql  = "SELECT fn_valida_os_reincidente($os,$login_fabrica)";
            $res1 = pg_query($con,$sql);

            $msg_erro .= pg_errormessage($con);
        }
    }
}

    if ($login_fabrica == 58 or $login_fabrica == 46 or $login_fabrica == 19) {

        $sql = "SELECT produto, familia, linha FROM tbl_produto JOIN tbl_os using(produto) WHERE os = $os";
        $res = pg_query($con,$sql);

        $laudo_produto = pg_fetch_result($res, 0, 'produto');
        $laudo_familia = pg_fetch_result($res, 0, 'familia');
        $laudo_linha   = pg_fetch_result($res, 0, 'linha');

        if ($login_fabrica <> 19) {

            $sql = "SELECT * FROM tbl_laudo_tecnico WHERE tbl_laudo_tecnico.produto = $laudo_produto";
            $res = pg_query($con,$sql);

            if (pg_num_rows($res) == 0) {

                $sql = "SELECT * FROM tbl_laudo_tecnico WHERE tbl_laudo_tecnico.familia = $laudo_familia";
                $res = pg_query($con,$sql);

            }

        } elseif ($login_fabrica == 19 and $tipo_atendimento <> 20) {
            $sql = "SELECT tbl_laudo_tecnico.* FROM tbl_laudo_tecnico WHERE linha = $laudo_linha AND ordem NOT IN (11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27) ORDER BY ordem;";
        } else {
            $sql = "SELECT *
                    FROM tbl_laudo_tecnico
                    WHERE tbl_laudo_tecnico.linha = $laudo_linha";

        }
            $res = pg_query($con,$sql);


        if ($login_fabrica == 19) {
            $digitou_laudo = $_POST['digitou_laudo'];
        }

        if (pg_num_rows($res) > 0 and $digitou_laudo == 'n') {

            for ($i = 0; $i < pg_num_rows($res); $i++) {

                $laudo      = pg_fetch_result($res, $i, 'laudo_tecnico');
                $titulo     = pg_fetch_result($res, $i, 'titulo');
                $afirmativa = pg_fetch_result($res, $i, 'afirmativa');
                $observacao = pg_fetch_result($res, $i, 'observacao');

                if (strlen($msg_erro) == 0) {

                    $laudo_ordem = trim($_POST["ordem_$laudo"]);

                    if ($afirmativa == 't') {

                        $laudo_afirmativa = trim($_POST["afirmativa_$laudo"]);

                        if (strlen($laudo_afirmativa) == 0) {
                            $msg_erro.= "Por favor, complete o Laudo Técnico.";
                        } else {
                            $laudo_afirmativa = "'".trim($_POST["afirmativa_$laudo"])."'";
                        }

                    } else {

                        $laudo_afirmativa = 'null';

                    }

                    if ($observacao == 't') {

                $laudo_observacao = trim($_POST["observacao_$laudo"]);
                $laudo_observacao = str_replace("'","''",$laudo_observacao);

                        if (strlen($laudo_observacao) == 0) {

                            $msg_erro.= "Por favor, complete o Laudo Técnico $laudo.";

                        }

                    } else {

                        $laudo_observacao = '';

                    }

                    if (strlen($msg_erro) == 0) {

                        $sql2 = "INSERT INTO tbl_laudo_tecnico_os (titulo        ,
                                                                   os          ,
                                                                   afirmativa  ,
                                                                   observacao  ,
                                                                   ordem
                                                                  ) VALUES (
                                                                   '$titulo'          ,
                                                                   '$os'              ,
                                                                   $laudo_afirmativa,
                                                                   '$laudo_observacao',
                                                                   $laudo_ordem
                                                                  )";

                        $res2 = pg_query($con,$sql2);
                        $msg_erro .= pg_errormessage($con);

                    }

                }

            }

        }

    }

    //para a fabrica 11 é obrigatório aparencia_produto e acessorios, para as outras é mostrado na tela /os_cadastro.php
    if ( in_array($login_fabrica, array(11,172)) ) {
        //APARENCIA
        $aparencia_produto= "'".trim($_POST["aparencia_produto"])."'";
        $acessorios= "'".trim($_POST["acessorios"])."'";
        if (strlen(trim($aparencia_produto)) == 0) {
            $aparencia_produto = 'null';
            $msg_erro .= "Informar a Aparência do Produto.<BR>";
        } else {
            $sql = "UPDATE tbl_os SET aparencia_produto = $aparencia_produto
                WHERE  tbl_os.os    = $os
                AND    tbl_os.posto = $login_posto;";
            $res = pg_query($con,$sql);
            $msg_erro .= pg_errormessage($con);
        }

        //ACESSORIOS
        if (strlen(trim($acessorios)) == 0) {

            $acessorios = 'null';
            $msg_erro .= "Informar os Acessórios do produto.<BR>";

        } else {

            $sql = "UPDATE tbl_os
                       SET acessorios   = $acessorios
                     WHERE tbl_os.os    = $os
                       AND tbl_os.posto = $login_posto;";

            $res = pg_query($con,$sql);
            $msg_erro .= pg_errormessage($con);

        }

    }

    if (strlen($msg_erro) == 0) {

        if (strlen($defeito_constatado) == 0) $defeito_constatado = 'null';

        //Rotina de vários defeitos para uma única OS.

        if (in_array($login_fabrica,array(2,30,43,59,85,95,94,114,131,144))) {

            $numero_vezes       = 100;
            $array_integridade  = array();
            $todosDefeitos      = array();

            for ($i = 0; $i < $numero_vezes; $i++) {

               $int_constatado = trim($_POST["integridade_defeito_constatado_$i"]);
               $int_solucao    = trim($_POST["integridade_solucao_$i"]);
               $principal      = trim($_POST["principal"]);

                if (!isset($_POST["integridade_defeito_constatado_$i"])) continue;
                if (strlen($int_constatado) == 0) continue;

                $defeito_constatado = $int_constatado;
                $solucao_os = $int_solucao;

                $aux_defeito_constatado = $int_constatado;
                $aux_solucao            = $int_solucao;

                array_push($array_integridade, $aux_defeito_constatado);

                if (in_array($login_fabrica,array(43,59,2,85))) {
                    # HD 309680
                    if (strlen($aux_solucao) > 0) {//HD 79185

                        $sql = "SELECT defeito_constatado_reclamado
                                FROM   tbl_os_defeito_reclamado_constatado
                                WHERE  os=$os
                                AND    defeito_constatado = $aux_defeito_constatado
                                AND    solucao            = $aux_solucao";
                        $res = pg_query($con,$sql);
                        $msg_erro .= pg_errormessage($con);

                    }

                    if (pg_num_rows($res) == 0) {

                        if (strlen($msg_erro) == 0) {

                            if (strlen($aux_solucao) > 0) {

                                $sql = "INSERT INTO tbl_os_defeito_reclamado_constatado(
                                            os,
                                            defeito_constatado,
                                            solucao,
                                            fabrica
                                        ) VALUES (
                                            $os,
                                            $aux_defeito_constatado,
                                            $aux_solucao,
                                            $login_fabrica
                                        )";

                                $res = pg_query($con,$sql);
                                $msg_erro .= pg_errormessage($con);

                            }

                        }

                    }

                } else {

                    $sql = "SELECT defeito_constatado_reclamado
                              FROM tbl_os_defeito_reclamado_constatado
                             WHERE os = $os
                               AND defeito_constatado = $aux_defeito_constatado";

                    $res = pg_query($con,$sql);
                    $msg_erro .= pg_errormessage($con);

                    if (pg_num_rows($res) == 0) {

                        $sql = "INSERT INTO tbl_os_defeito_reclamado_constatado(
                                    os,
                                    defeito_constatado,
                                    fabrica
                                ) VALUES (
                                    $os,
                                    $aux_defeito_constatado,
                                    $login_fabrica
                                )";

                        $res = pg_query($con,$sql);
                        $msg_erro .= pg_errormessage($con);
                        if($login_fabrica == 30){
                            $sqlDef = "
                                SELECT  descricao
                                FROM    tbl_defeito_constatado
                                WHERE   defeito_constatado = $aux_defeito_constatado
                            ";
                            $resDef = pg_query($con,$sqlDef);
                            array_push($todosDefeitos,pg_fetch_result($resDef,0,descricao));
                        }
                    }
                }
            }

            if($login_fabrica == 30 && count($todosDefeitos) > 0){
            $defeitos = implode(", ",$todosDefeitos);
            $defeitos = str_replace("'","\\'",$defeitos);
                $msg = "Defeitos cadastrados na OS: $defeitos";

                $sql = "
                    INSERT INTO tbl_os_interacao (
                        programa,
                        os,
                        data,
                        comentario,
                        interno,
                        posto
                    ) VALUES (
                        '$programa_insert',
                        $os,
                        CURRENT_TIMESTAMP,
                        E'$msg',
                        TRUE,
                        $login_posto
                    );
                ";

        $res = pg_query($con,$sql);
        $msg_erro = pg_errormessage($con);
            }

            if (strlen($msg_erro) == 0) {//HD 79185

                $lista_defeitos = implode($array_integridade,",");

                if (strlen($lista_defeitos) > 0) {

                    if($login_fabrica == 30){
                        $sqlExcluir = "
                            SELECT  tbl_defeito_constatado.descricao
                            FROM    tbl_defeito_constatado
                            JOIN    tbl_os_defeito_reclamado_constatado USING (defeito_constatado)
                            WHERE   tbl_os_defeito_reclamado_constatado.os      = $os
                            AND     tbl_defeito_constatado.defeito_constatado   NOT IN ($lista_defeitos)
                        ";
                        $resExcluir = pg_query($con,$sqlExcluir);
                        if(pg_num_rows($resExcluir) > 0){
                            $defeitosExcluir = pg_fetch_all_columns($resExcluir,0);
                        }
                    }

                    $sql = "DELETE FROM tbl_os_defeito_reclamado_constatado
                             WHERE os = $os
                               AND defeito_constatado NOT IN ($lista_defeitos)";

                    $res = pg_query($con,$sql);

                    if (strlen(pg_errormessage($con)) > 0) {
                        $msg_erro .= "<br>É necessário clicar no botão Adicionar Defeito!<br>";
                    }else{
                        if($login_fabrica == 30 && count($defeitosExcluir) > 0){
//                         print_r($defeitosExcluir);
                            $defEx = implode(", ",$defeitosExcluir);
                            $msg = "Defeitos excluídos da OS: $defEx";

                            $sql = "
                                INSERT INTO tbl_os_interacao (
                                    programa,
                                    os,
                                    data,
                                    comentario,
                                    interno,
                                    posto
                                ) VALUES (
                                    '$programa_insert',
                                    $os,
                                    CURRENT_TIMESTAMP,
                                    '$msg',
                                    TRUE,
                                    $login_posto
                                );
                            ";
//                             exit(nl2br($sql));
                            $res = pg_query($con,$sql);
                        }
                    }

                } else {

                    $sql = "DELETE FROM tbl_os_defeito_reclamado_constatado
                            WHERE os = $os";

                    $res = pg_query($con,$sql);
                    $msg_erro.="É necessário clicar no botão Adicionar Defeito!<br>";

                }

            }

            //o defeito constatado recebe o primeiro defeito constatado.
            $defeito_constatado = $aux_defeito_constatado;

            if($login_fabrica == 30){
                if($defeito_constatado == 12485 OR $defeito_constatado == 11792){
                    $obs_defeito = ($defeito_constatado == 12485) ? "OS com Processo Judicial" : "OS com Troca de Produto";
                    $sql = "INSERT INTO tbl_os_status (
                                os,
                                status_os,
                                observacao,
                                fabrica_status
                            ) VALUES (
                                $os,
                                164,
                                '".$obs_defeito."',
                                $login_fabrica
                            )";
                    $res      = pg_query($con,$sql);

                    $arquivo_defeito_constatado = $_FILES['arquivo_defeito_constatado'];
                    if(empty($arquivo_defeito_constatado['name'])){
                        $msg_erro = "O arquivo de ".$tema." é obrigatório<br>";
                    }else{
                        $s3tj = new anexaS3('tj', (int) $login_fabrica);
                        if(is_object($s3tj)){
                            $s3tj->uploadFileS3($os, $arquivo_defeito_constatado);

                            if(!$s3tj->temAnexo){
                                $msg_erro = $s3tj->_erro;
                            }
                        }
                    }

                }

            }
            // HD 41052
            if ($login_fabrica == 43 and strlen($principal) > 0) $defeito_constatado = $principal;

        }

        if($login_fabrica == 134){
            // $defeitos_hidden = $_POST['defeito_con']
            $defeitos_hidden = json_decode(str_replace('\\', '',$_POST['defeito_constatado_hidden']));

            $sql = "delete from tbl_os_defeito_reclamado_constatado where os = $os";
            $res_aux = pg_query($con,$sql);

            foreach ($defeitos_hidden as $codigo) {
                $sql = " select defeito_constatado from tbl_defeito_constatado where codigo = '$codigo' and fabrica = $login_fabrica;";
                $res_aux = pg_query($con,$sql);
                if(pg_num_rows($res_aux)){

                    $defeito_constatado = pg_result($res_aux,0,defeito_constatado);
                    if(strlen($defeito_constatado) > 0){
                        $sql = "insert into tbl_os_defeito_reclamado_constatado(os,defeito_constatado,fabrica) values($os,$defeito_constatado,$login_fabrica)";
                        $res_aux = pg_query($con,$sql);
                    }

                }
            }
        }

        $sqlTipoAt = "SELECT tipo_atendimento
                      FROM tbl_os
                      WHERE os = {$os}";
        $resTipoAt = pg_query($con, $sqlTipoAt);

        $tipoAtendimentoOs = pg_fetch_result($resTipoAt, 0, 'tipo_atendimento');

        if ($login_fabrica == 19 ) {

            $defeito_post = $_POST['defeitos_lorenzetti_hidden'];
            $defeito_post = preg_replace('/[\[\]]/', '', $defeito_post);
            $defeito_post = str_replace('"', '', $defeito_post);
            $defeito_post = str_replace('\\', '', $defeito_post);

            $condicao_instalacao = $_POST['condicao_instalacao'];
			if( verifica_checklist_tipo_atendimento($tipoAtendimentoOs)) {
				if (strlen($condicao_instalacao) == 0) {
					$msg_erro .= "Informe a condição de instalação.<br>";
				}
				if (count($_POST['check_list_fabrica']) == 0) {
					$msg_erro .= "Selecione um checklist.<br>";
				}
			}
            if (count($_POST['i_defeito_constatado']) == 0) {
                $msg_erro .= "Selecione um Defeito Constatado.<br>";
            }

            if (empty($msg_erro)) {
                #Apaga todos os defeitos reclamados e defeitos_constatados
                $sql = "DELETE FROM tbl_os_defeito_reclamado_constatado WHERE os=$os";
                $res = pg_query($con,$sql);
                $msg_erro .= pg_errormessage($con);
            }
            


            if(empty($msg_erro)) {
                #Apaga todos os defeitos reclamados e defeitos_constatados
                $sql = "DELETE FROM tbl_os_defeito_reclamado_constatado WHERE os=$os /*AND checklist_fabrica IS NULL*/";
                $res = pg_query($con,$sql);
                $msg_erro .= pg_errormessage($con);
            }

            if (strlen($msg_erro) == 0) {

                $count_defeito_reclamado  = count($_POST["defeito_reclamado"]);

                for ($o = 0; $o < $count_defeito_reclamado; $o++) {
                    
                    $aux_defeito_reclamado    = trim($_POST["defeito_reclamado"][$o]);

                    if (strlen($aux_defeito_reclamado) == 0) {
                         continue;
                    }

                    #Insere todos os defeitos reclamados
                    $sql = "INSERT INTO tbl_os_defeito_reclamado_constatado(
                                os                    ,
                                defeito_reclamado,
                                fabrica
                            ) VALUES (
                                $os                   ,
                                $aux_defeito_reclamado,
                                $login_fabrica
                            )";

                    $count_defeito_constatado = count($_POST["i_defeito_constatado"][$aux_defeito_reclamado]);
                    $post_defeito_constatado  = $_POST["i_defeito_constatado"][$aux_defeito_reclamado];

                    for ($j = 0; $j < $count_defeito_constatado; $j++) {

                        $aux_defeito_constatado = trim($post_defeito_constatado[$j]);
                        if (strlen($aux_defeito_constatado) == 0) {
                            continue;
                        }

                        $sql = "SELECT defeito_constatado_reclamado
                                  FROM tbl_os_defeito_reclamado_constatado
                                 WHERE os                 = $os
                                   AND defeito_reclamado  = $aux_defeito_reclamado
                                   AND defeito_constatado = $aux_defeito_constatado";
                        $res = pg_query($con,$sql);

                        $msg_erro .= pg_errormessage($con);
                        if (pg_num_rows($res) == 0) {
                            if (isset($_POST["check_list_fabrica"]) && count($_POST["check_list_fabrica"]) > 0) {

                                $defeitos_checklist       = $_POST['check_list_fabrica'][$aux_defeito_reclamado][$aux_defeito_constatado];
                                
                                $count_defeitos_checklist = count($defeitos_checklist);

                                if ($count_defeitos_checklist > 0) {
                                    for ($d=0; $d < $count_defeitos_checklist; $d++) {
                                        $sql = "INSERT INTO tbl_os_defeito_reclamado_constatado(
                                                    os,
                                                    checklist_fabrica,
                                                    defeito_reclamado,
                                                    defeito_constatado,
                                                    fabrica
                                                )VALUES(
                                                    {$os},
                                                    {$defeitos_checklist[$d]},
                                                    {$aux_defeito_reclamado},
                                                    {$aux_defeito_constatado},
                                                    {$login_fabrica}
                                                )";
                                        $res = pg_query($con,$sql);
                                    }
                                } else {

                                    $sql = "INSERT INTO tbl_os_defeito_reclamado_constatado(
                                                os,
                                                defeito_reclamado,
                                                defeito_constatado,
                                                fabrica
                                            )VALUES(
                                                {$os},
                                                {$aux_defeito_reclamado},
                                                {$aux_defeito_constatado},
                                                {$login_fabrica}
                                            )";
                                    $res = pg_query($con,$sql);

                                }

                            } else {
                                $sql = "INSERT INTO tbl_os_defeito_reclamado_constatado(
                                        os,
                                        defeito_reclamado,
                                        defeito_constatado,
        								fabrica
                                    )VALUES(
                                        $os,
                                        $aux_defeito_reclamado,
                                        $aux_defeito_constatado,
        								$login_fabrica
                                    )";
                                $res = pg_query($con,$sql);
                            }

                            $msg_erro .= pg_errormessage($con);

                            $sql = "DELETE FROM tbl_os_defeito_reclamado_constatado
                                     WHERE os                 = $os
                                       AND defeito_reclamado  = $aux_defeito_reclamado
                                       AND defeito_constatado IS NULL
                                       AND checklist_fabrica IS NULL";
                            $res = pg_query($sql);

                        }else{
                            $sql = "INSERT INTO tbl_os_defeito_reclamado_constatado(
                                    os,
                                    defeito_constatado,
                                    defeito_reclamado,
                                    fabrica
                                    $checklist_fabrica_campo
                                )VALUES(
                                    $os,
                                    $aux_defeito_constatado,
                                    $aux_defeito_reclamado,
                                    $login_fabrica
                                    $checklist_fabrica_valor
                                )";
                            $res = pg_query($con,$sql);
                            $msg_erro .= pg_errormessage($con);

                        }

                    }//count_defeito_constatado

                }//count_defeito_reclamado

            }
          
        }

        if(in_array($login_fabrica, [19])){
             if (strlen($msg_erro) == 0) {

                $campos_adicionais = null;

                $sqlEXT = "SELECT campos_adicionais  FROM tbl_os_campo_extra WHERE os=$os";
                $resEXT = pg_query($con,$sqlEXT);
                if (pg_num_rows($resEXT) > 0) {
                    
                    $campos_adicionais = json_decode(pg_fetch_result($resEXT, 0, 'campos_adicionais'),true);

                    if($login_fabrica == 19){
                        $campos_adicionais["condicao_instalacao"] = utf8_encode($condicao_instalacao);    
                    }else{

                        if($defeito_cor_etiqueta_fornecedor == true){
                            $campos_adicionais['defeito_cor_etiqueta_fornecedor'] = 'sim';
                        }else{
                            unset($campos_adicionais["defeito_cor_etiqueta_fornecedor"]);
                        }   
                    }

			$campos_adicionaisENC = json_encode($campos_adicionais); 

			if(strlen(trim($campos_adicionaisENC))>0){
                            $campos_adicionaisENC = "'".$campos_adicionaisENC."'"; 
                        }else{
			    $campos_adicionaisENC = 'null';
			}	
 
                    $sqlENC = "UPDATE tbl_os_campo_extra SET campos_adicionais = ".$campos_adicionaisENC." WHERE os=$os"; 
                    $resENC = pg_query($con, $sqlENC);
                    $msg_erro .= pg_errormessage($con);

                } else {

                    if($login_fabrica == 19){
                        $campos_adicionais["condicao_instalacao"] = utf8_encode($condicao_instalacao);
                    }else{                  

                        if($defeito_cor_etiqueta_fornecedor == true){
                            $campos_adicionais['defeito_cor_etiqueta_fornecedor'] = 'sim';
                        }else{
                            if(isset($campos_adicionais["defeito_cor_etiqueta_fornecedor"])){                            
                                unset($campos_adicionais["defeito_cor_etiqueta_fornecedor"]);
                            }
                        }  
                    }
                    $campos_adicionaisENC = json_encode($campos_adicionais);

                    $sqlENC = "INSERT INTO tbl_os_campo_extra (fabrica, os, campos_adicionais) VALUES ($login_fabrica, $os, '".$campos_adicionaisENC."')";
                    $resENC = pg_query($con, $sqlENC);
                    $msg_erro .= pg_errormessage($con);
                }

                # HD 28155
                if ($tipo_atendimento <> 6 and $login_fabrica == 19) {

                    $sql = "SELECT defeito_constatado
                              FROM tbl_os_defeito_reclamado_constatado
                             WHERE os = $os LIMIT 1";

                    $res = pg_query($con,$sql);
                    if (pg_num_rows($res) > 0) {
                        $defeito_constatado = pg_fetch_result($res,0,0);
                    } else {
                        $msg_erro.= "É necessário informar o ".$tema."<br/>";
                    }
                }
            }

            
        }

        if ($login_fabrica == 52) {

            if (strlen($msg_erro) == 0) {

                if (strlen($defeito_constatado_grupo) > 0) {

                    $sql = "UPDATE tbl_os
                               SET defeito_constatado_grupo = $defeito_constatado_grupo
                             WHERE tbl_os.os                = $os
                               AND tbl_os.posto             = $login_posto;";

                    $res = pg_query($con,$sql);
                    $msg_erro .= pg_errormessage($con);

                }

            }

        }

        if (strlen($msg_erro) == 0) {

            if (strlen($defeito_constatado) > 0) {

                $sql = "UPDATE tbl_os SET defeito_constatado = $defeito_constatado
                        WHERE  tbl_os.os    = $os
                        AND    tbl_os.posto = $login_posto;";

                $res = pg_query($con,$sql);
                $msg_erro .= pg_errormessage($con);

            }

        }
        //CASO DEFEITO RECLAMADO ESTEJA VAZIO

        $defeito_reclamado = $_POST['defeito_reclamado'];

        if (strlen($defeito_reclamado) == 0 && in_array($login_fabrica,[120,201])) {
            $msg_erro.= "Informe o defeito reclamado.";
        }

        if ($pedir_defeito_reclamado_descricao == 't') {
            if (strlen($defeito_reclamado) == 0) {
                $defeito_reclamado = 'null';
            }
        }

        if (strlen($defeito_reclamado) == 0 && !in_array($login_fabrica, [19, 134])) {
            $msg_erro.= "Informe o defeito reclamado.";
        }

        if (count($defeito_reclamado) == 0 && in_array($login_fabrica, [19])) {
            $msg_erro.= "Informe o defeito reclamado.";
        }

        if (strlen($msg_erro) == 0) {

            if (strlen($defeito_reclamado) > 0) {

                $sql = "UPDATE tbl_os
                           SET defeito_reclamado = $defeito_reclamado
                         WHERE tbl_os.os         = $os
                           AND tbl_os.posto      = $login_posto;";

                $res = pg_query($con,$sql);
                $msg_erro .= pg_errormessage($con);

            }

        }//CASO DEFEITO RECLAMADO ESTEJA VAZIO

    }

    //hd 351696 Início
    if($login_fabrica == 42 && empty($msg_erro) ){
        $xdefeito_raclamado             = $_POST['xxdefeito_reclamado'];
        $defeito_reclamado_descricao_os = $_POST['defeito_reclamado_descricao_os'];

        //HD 687592 - adicionado " && strlen($defeito_reclamado) > 0 " - gabrieLsilveira
        if(strlen($xdefeito_raclamado) == 0 and strlen($defeito_reclamado_descricao_os) == 0 && strlen($defeito_reclamado) == 0){
            $msg_erro = 'Informe o Defeito Reclamado pelo Cliente <br />';
        }

        $filial_posto                   = $_POST['filial_posto'];
        if (strlen($filial_posto) == 0) {
            $msg_erro = 'Informe a filial correspondente a este posto';
        } else {
            $sqlPres = "UPDATE  tbl_os
                        SET     filial  = $filial_posto
                        WHERE   fabrica = $login_fabrica
                        AND     posto   = $login_posto
                        AND     os      = $os
            ";
            $resPres  = pg_query($con,$sqlPres);
            $msg_erro = pg_last_error($con);
        }
    }
    //hd 351696 Fim

    if ($login_fabrica == 96) {     # HD 390996

        $total_orcamento = $_POST['total_orcamento'];
        $total_horas     = $_POST['total_horas'];
        $prazo_retorno   = $_POST['prazo_retorno'];
        $total_orcamento = str_replace(",",".",$total_orcamento);
        $total_horas     = str_replace(",",".",$total_horas);

        if (!empty($total_orcamento) and empty($total_horas)) {
            $msg_erro = "Por favor, informe total de horas ";
        }

        if (strlen($prazo_retorno) > 0 and strlen($msg_erro) == 0) {

            if (is_numeric($prazo_retorno) == false) $msg_erro = "Prazo de Retorno Inválido";

        } else {
            $prazo_retorno = 0;
        }

        if (empty($total_orcamento) and !empty($total_horas)) {
            $msg_erro = "Por favor, informe total do orçamento";
        }

        if (!empty($total_orcamento) and !empty($total_horas) and strlen($msg_erro) == 0) {

            $sql = " SELECT os FROM tbl_orcamento_os_fabrica WHERE os = $os";
            $res = pg_query($con,$sql);

            if (pg_num_rows($res) > 0) {

                $sql = " UPDATE tbl_orcamento_os_fabrica SET
                            total           = $total_orcamento  ,
                            total_horas     = $total_horas      ,
                            prazo_retorno   = $prazo_retorno
                        WHERE os = $os";

            } else {

                $sql = " INSERT INTO tbl_orcamento_os_fabrica(
                                os,
                                fabrica,
                                total,
                                total_horas,
                                prazo_retorno
                            )VALUES(
                                $os,
                                $login_fabrica,
                                $total_orcamento,
                                $total_horas,
                                $prazo_retorno
                            )";

            }

            $res      = pg_query($con,$sql);
            $msg_erro = pg_last_error($con);

        }

    }

    if (strlen($msg_erro) == 0) {

        $xcausa_defeito = $_POST ['causa_defeito'];

        if (strlen($xcausa_defeito) == 0 or strstr($xcausa_defeito, 'Selecione')) $xcausa_defeito = "null";
        if (strlen($xcausa_defeito) > 0) {

            $sql = "UPDATE tbl_os SET causa_defeito = $xcausa_defeito
                    WHERE  tbl_os.os    = $os
                    AND    tbl_os.posto = $login_posto;";

            $res = pg_query($con,$sql);
            $msg_erro .= pg_errormessage($con);

        }

    }

    if (strlen($msg_erro) == 0) {

        $x_solucao_os = $_POST['solucao_os'];

        if ($login_fabrica == 30 && empty($x_solucao_os)) {
            $x_solucao_os = $aux_solucao;
        }

        if (in_array($login_fabrica, [11,172,72]) AND !empty($x_solucao)) {//fputti HD-3130038
            $temPeca = array();
            for ($i=0; $i < $_POST['qtde_item']; $i++) {
                if (empty($_POST['peca_'.$i])) {
                    continue;
                }
                $temPeca[] = $_POST['peca_'.$i];
            }
            if (count($temPeca) == 0) {
               $sqlSolucao = "SELECT solucao
                          FROM tbl_solucao
                         WHERE tbl_solucao.solucao = $x_solucao_os
                           AND tbl_solucao.fabrica = $login_fabrica
                           AND tbl_solucao.ativo = 't'
                           AND tbl_solucao.troca_peca = 't'";

                $resSolucao = pg_query($con, $sqlSolucao);
                if (pg_num_rows($resSolucao) > 0) {
                    $msg_erro.= "É obrigatório lançamento de peça.";
                }
            }
        }

        if (strlen($x_solucao_os) == 0) $x_solucao_os = 'null';
        else                            $x_solucao_os = "'".$x_solucao_os."'";

        $sql = "UPDATE tbl_os SET solucao_os = $x_solucao_os
                WHERE  tbl_os.os    = $os
                AND    tbl_os.posto = $login_posto;";

        $res       = pg_query($con,$sql);
        $msg_erro .= pg_errormessage($con);

    }

    $obs = trim($_POST["obs"]);
    $obs = str_replace("'","''",$obs);

    if (isFabrica(15, 72) && strlen($os) > 0) {

        $sql_obs = "SELECT obs FROM tbl_os WHERE fabrica = {$login_fabrica} AND os = {$os}";
        $res_obs = pg_query($con, $sql_obs);

        if (pg_num_rows($res_obs) > 0) {

            $obs_anterior = trim(pg_fetch_result($res_obs, 0, "obs"));

            $obs_anterior_comp = strtolower(str_replace(" ", "", trim($obs_anterior)));
            $obs_comp = strtolower(str_replace(" ", "", trim($obs)));

            if ($obs_anterior_comp != $obs_comp) {

                $emails_arr = getValorFabrica(array(
                    15 => 'iuri.brito@latina.com.br',
                    72 => ["sap@mallory.com.br", "asstec@mallory.com.br"],
                ));

                $mailer = new TcComm($externalId);

                // Se for em ambientes de teste, enviar para...
                if ($_serverEnvironment == 'development') {
                    $emails_arr = array("manuel.lopez@telecontrol.com.br", "willian.lourencini@telecontrol.com.br");
                    $mensagem_obs = "<h2>AMBIENTE DE TESTES</h2>";
                }

                $mensagem_obs .= "O Posto Autorizado {$login_codigo_posto} - {$login_nome} alterou o campo Observação da OS {$os} de \"{$obs_anterior}\" para \"{$obs}\" ";

                $status = $mailer->sendMail(
                    $emails_arr,
                    "Alteração do Campo Observação na OS {$os}",
                    $mensagem_obs,
                    $externalEmail
                );

                // $emailCom = new Log2();
                // $emailCom->adicionaTituloEmail("Alteração do Campo Observação na OS {$os}");
                // $emailCom->adicionaLog(array("titulo" => "Alteração do Campo Observação na OS {$os}")); // Titulo

                // if ($_serverEnvironment == 'development') {
                    // $emailCom->adicionaEmail("sap@mallory.com.br");
                    // $emailCom->adicionaEmail("asstec@mallory.com.br");
                // }else{
                    // $emailCom->adicionaEmail("guilherme.silva@telecontrol.com.br");
                    // $emailCom->adicionaEmail("fernando.rodrigues@telecontrol.com.br");
                    // $emailCom->adicionaEmail("sap@mallory.com.br");
                    // $emailCom->adicionaEmail("asstec@mallory.com.br");
                // }

                /* $codigo_posto = $_COOKIE["cook_login_codigo_posto"];
                $id_posto = $_COOKIE["cook_posto"];

                $sql_posto_nome = "SELECT nome FROM tbl_posto WHERE posto = {$id_posto}";
                $res_posto_nome = pg_query($con, $sql_posto_nome);

                $nome_posto = pg_fetch_result($res_posto_nome, 0, "nome");

                $mensagem_obs = "O Posto Autorizado {$codigo_posto} - {$nome_posto} alterou o campo Observação da OS {$os} de \"{$obs_anterior}\" para \"{$obs}\" ";

                $emailCom->adicionaLog($mensagem_obs);

                $emailCom->enviaEmails(); */

            }

        }

    }

    //HD 238556
    if ($login_fabrica == 30) {
        $sql_obs = "SELECT
                        tbl_os.obs
                    FROM tbl_os
                    WHERE tbl_os.os = $os
                    and tbl_os.posto = $login_posto";

        $res_obs = pg_query($con,$sql_obs);
        $obs_os = pg_fetch_result($res_obs, 0, 0);

        if (!empty($obs)){

            $sql_posto = "SELECT nome_fantasia from tbl_posto_fabrica where posto=$login_posto and fabrica=$login_fabrica";
            $res_posto = pg_query($con,$sql_posto);
            $nome_fantasia_posto = pg_fetch_result($res_posto, 0, 0);
            $data_insercao_obs = date("d/m/y h:i:s");

            if (!empty($obs_os)) {
                $obs = "'$obs_os
-----------------------------------------
$obs
Gravado por: $nome_fantasia_posto
Em: $data_insercao_obs'";
            }else{
                $obs = "'$obs
Gravado por: $nome_fantasia_posto
Em: $data_insercao_obs'";
            }
            // echo $obs;
            // exit;
        }else{
            if (!empty($obs_os)){
                $obs = "'".$obs_os."'";
            }else{
                $obs = "null";
            }
        }
    }else{
        if (strlen($obs) > 0) $obs = "'".$obs."'";
        else                  $obs = "";
    }

    //takashi 07-08 a pedido do andre da tectoy o campo observação passa a ser obrigatorio
    if (in_array($login_fabrica, array(6,101))) {

        if (strlen($obs) == 0) {
            $msg_erro .= (in_array($login_fabrica, array(101))) ? "Por favor preencher o campo Descrição detalhada do problema <br />" : "Por favor preencher o campo Observação <br />";
        }

    }
    //takashi 07-08 a pedido do andre da tectoy o campo observação passa a ser obrigatorio

    $tecnico_nome = trim($_POST["tecnico_nome"]);
    if (strlen($tecnico_nome) > 0) {
        $tecnico_nome = "'".$tecnico_nome."'";
    } else {

        if ($login_fabrica == 30) { # 136812
            if($defeito_constatado != 12485 and $defeito_constatado != 11792){
                $msg_erro.= "Por favor, informe o nome do técnico"."<br />";
            }else{
                $tecnico_nome = "null";
            }
        } else {
            $tecnico_nome = "null";
        }

    }

    if($login_fabrica == 59 and (empty($_POST['tecnico']) or $_POST['tecnico'] == 'null')){
    $msg_erro .= "Favor informar nome do técnico.";
    }

    if (strlen($tecnico) > 0) {

        $sql = "SELECT tecnico FROM tbl_tecnico WHERE tecnico = $tecnico AND fabrica = $login_fabrica AND posto = $login_posto";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) == 0) {
           # $msg_erro.= "O técnico informado não está cadastrado";
        }

    } else {

        $tecnico = "null";

    }

    if ($login_fabrica == 19) {

        $sql = "SELECT linha
                  FROM tbl_produto
                  JOIN tbl_os USING(produto)
                 WHERE os = $os";

         //echo trim($_POST["fabricacao_produto"]);exit;
        $res    = pg_query($con,$sql);
        $linhax = pg_fetch_result($res,0,0);
        if (($linhax == 260 || $linhax == 263) && $_POST["fabricacao_produto_hidden"] == "t") {
            $fabricacao_produto = trim($_POST["fabricacao_produto"]);
            if (strlen($fabricacao_produto) == 0) {

                $msg_erro .= "Por favor, preencha o campo Mês e Ano de Fabricação do Produto<br/>";

            } else {

                $sql = "SELECT tbl_produto.parametros_adicionais
                        FROM tbl_produto
                        JOIN tbl_linha ON tbl_produto.linha = tbl_linha.linha
                        WHERE referencia = '$produto_referencia'
                        AND fabrica_i = $login_fabrica";

                $res    = pg_query($con,$sql);
                $parametros_adicionais = pg_fetch_result($res,0,'parametros_adicionais');

                $parametros_adicionais = json_decode($parametros_adicionais);

                $data_fab = $parametros_adicionais->data_fabricacao;

                list($m, $y) = explode("/", $data_fab);
                $xdata_fab = $y."-".$m;

                list($mm, $yy) = explode("/", $fabricacao_produto);
                $xfabricacao_produto = $yy."-".$mm;

                if ($xfabricacao_produto < $xdata_fab) {
                    $msg_erro .= "Data de fabricação incorreta para o produto.<br/>";
                }

                if (strlen($fabricacao_produto) <> 7) {
                    $msg_erro .= "Mês e ano inválidos! Verifique os dados digitados.<br/>";
                }

                if (!is_numeric(substr($fabricacao_produto,0,2)) or substr($fabricacao_produto,0,2) < 1 or substr($fabricacao_produto,0,2) > 12) {
                    $msg_erro .= "Mês e ano inválidos! Verifique os dados digitados.<br/>";
                }


                if (substr($fabricacao_produto,2,1) <> "/") {
                    $msg_erro .= "Mês e ano inválidos! Verifique os dados digitados.<br/>";
                }

                $sql = "SELECT TO_CHAR (current_date,'YYYY')";
                $res = pg_query($con,$sql);
                $ano_atual = pg_fetch_result($res,0,0);

            }


        } else {
            $fabricacao_produto = "01/0001";
        }
        //hd 47311
    }

    //DEFEITO RECLAMADO COMO CAMPO TEXTO
    if (($pedir_defeito_reclamado_descricao == 't') AND ( $defeito_reclamado == 'null' OR in_array($login_fabrica,array(72, 94)) ) ) {

        $defeito_reclamado_descricao_os = $_POST["defeito_reclamado_descricao_os"];

        if (strlen($defeito_reclamado_descricao_os) == 0 && $consumidor_revenda <> "R" and $login_fabrica == 94) {
            $msg_erro.= "Por favor, preencha o campo do defeito reclamado.";
        }

        if($login_fabrica == 72 and strlen(trim($defeito_reclamado_descricao_os))== 0){
            $msg_erro.= "Por favor, preencha o campo do defeito reclamado.";
        }

        if ($fabrica_solucao_os_obrigatoria and $login_fabrica == 72) {
            $solucao_os = $_POST['solucao_os'];
            if (strlen($solucao_os) == 0) {
                $msg_erro .= "<Br> Por favor preencher o campo solução.<BR>";
            }

        }

    } else if(!in_array($login_fabrica,array(42,74,96,115,116,117,120,201,121,122))) {//PARA OUTRAS FÁBRICAS SETA NULL
        $defeito_reclamado_descricao_os = 'null';
    }

    $valores_adicionais = trim($_POST["valores_adicionais"]);
    $valores_adicionais = str_replace (",",".",$valores_adicionais);

    if (strlen($valores_adicionais) == 0) $valores_adicionais = "0";

    $justificativa_adicionais = trim($_POST["justificativa_adicionais"]);

    if (strlen($justificativa_adicionais) > 0) $justificativa_adicionais = "'".$justificativa_adicionais."'";
    else                                       $justificativa_adicionais = "null";

    if (strlen($type) > 0) $type = "'".trim($_POST['type'])."'";
    else                   $type = 'null';

    if($login_fabrica <> 94)
        $qtde_km = trim($_POST["qtde_km"]);

    $qtde_km = str_replace (",",".",$qtde_km);

    if ($login_fabrica == 3) {
        if (strlen($qtde_km) == 0) $qtde_km = "0";
    } else {
        if (strlen($qtde_km) == 0) $qtde_km = " qtde_km ";
    }

    //HD 20862 20/6/2008
    if ($login_fabrica == 3) {

        if (strlen($_POST['atendimento_domicilio']) == 0) {
            $tipo_atendimento = ' NULL ';
        } else {
            $tipo_atendimento = '37';
        }

    }

    //HD 20682 20/6/2008
    if ($login_fabrica == 3 AND $tipo_atendimento == 37) {

        $status_os = trim($_POST["status_os"]);
        //if (strlen($status_os)==0 or $status_os=="101"){

        $sql_atendimento = " tipo_atendimento = $tipo_atendimento, ";

        //hd 24288
        //if (strlen($_POST["autorizacao_domicilio"])>0) $autorizacao_domicilio = trim($_POST["autorizacao_domicilio"]);
        //else                                          $autorizacao_domicilio = "NULL";

        if (strlen(trim($_POST["justificativa_autorizacao"]))>0) $justificativa_autorizacao = trim($_POST["justificativa_autorizacao"]);
        else                                                     $justificativa_autorizacao = "NULL";

        if ($qtde_km == "0") {
            $msg_erro .= "Informe o campo Kilometragem";
        }

        //hd 24288
        //if($autorizacao_domicilio == "NULL"){
        //    $msg_erro .= "Informe o campo Número de Autorização";
        //}

        if ($justificativa_autorizacao == "NULL") {
            $msg_erro .= "Informe o campo Justificativa da Kilometragem";
        }
        //}

    } else {
        //hd 24288
        //$autorizacao_domicilio     = "NULL";
        $justificativa_autorizacao = "NULL";
    }

    if ($login_fabrica == 3 AND $status_os == "101" AND $tipo_atendimento != 37) {
        $sql_atendimento = " tipo_atendimento = $tipo_atendimento, ";
    }

    if (strlen($msg_erro) == 0) {

        if ($login_fabrica == 3 AND $status_os <> "99" AND (strlen($status_os) == 0 or $status_os == "101")) {//HD 20682 20/6/2008
            $sql_dom_britania = " /*autorizacao_domicilio = $autorizacao_domicilio,*/             ";
    } else if($login_fabrica <> 3) {
        if($login_fabrica == 94){
            $sql_dom_britania = " qtde_km               = case when qtde_km > 0 then qtde_km else  $qtde_km end               ,";
        }else{
            $sql_dom_britania = " qtde_km               = $qtde_km                ,";
        }

    }

    $obs = "'".str_replace("'","",$obs) ."'";
    $obs = str_replace("\\","\/",$obs);
        $sql = "UPDATE  tbl_os SET obs              = $obs                             ,
                        tecnico_nome                = $tecnico_nome                    ,
                        tecnico                     = $tecnico                         ,
                        codigo_fabricacao           = '$codigo_fabricacao'             ,
                        fabricacao_produto          = '$fabricacao_produto'            ,";
                    if($login_fabrica <> 15 AND $login_fabrica <> 35 AND $login_fabrica <> 125) {
                      $sql .= "  valores_adicionais          = $valores_adicionais    ,";
                    }
                    $sql .= " justificativa_adicionais    = $justificativa_adicionais        ,";
                    if($login_fabrica <> 96){
                        $sql .= "defeito_reclamado_descricao = '$defeito_reclamado_descricao_os',";
                    }
                    $sql .="
                        $sql_atendimento
                        $sql_dom_britania
                        type                        = $type
                WHERE  tbl_os.os    = $os
                AND    tbl_os.posto = $login_posto;";


        $res = pg_query($con,$sql);

        $msg_erro .= pg_errormessage($con);
        //exit($msg_erro);

        if ($login_fabrica == 3  AND $tipo_atendimento == 37 AND (strlen($status_os) == 0 or $status_os == "101")) {//HD 20682 20/6/2008

            $sql = "INSERT INTO tbl_os_status(
                        os,
                        status_os,
                        data,
                        observacao
                        )VALUES(
                        $os,
                        98 ,
                        current_timestamp,
                        '$justificativa_autorizacao');";
            $res = pg_query($con,$sql);
            $msg_erro .= pg_errormessage($con);

        }

    }


    if (strlen($msg_erro) == 0) { //HD 79185
        #HD 13618

        $sqlT = "SELECT tbl_produto.troca_obrigatoria
                FROM   tbl_produto
                JOIN   tbl_os ON tbl_os.produto = tbl_produto.produto
                WHERE  tbl_os.os    = $os
                AND    tbl_os.posto = $login_posto;";
        $resT = pg_query($con,$sqlT);
        if (pg_num_rows($resT) > 0) {
            $troca_obrigatoria = pg_fetch_result($resT,0,troca_obrigatoria);
        }
    }

    $informatica = trim($_POST["informatica"]);

    #HD 101357
    if($login_fabrica == 3){
        $linha_p = $_POST[linha_envia];
        if($linha_p==528){
            $informatica = 't';
        }
    }

    $orcamento_garantia = "";

    if ($login_fabrica == 15) {

        $Xsql = "SELECT produto FROM tbl_produto WHERE fabrica_i = $login_fabrica AND referencia = '$produto_referencia'";
        $Xres = pg_query($con, $Xsql);
        $produto = pg_fetch_result($Xres, 0, "produto");

        $Xsql = "SELECT familia FROM tbl_produto WHERE fabrica_i = $login_fabrica AND referencia = '$produto_referencia'";
        $Xres = pg_query($con, $Xsql);

        $familia = pg_fetch_result($Xres, 0, "familia");

        for ($i = 0; $i < $qtde_item; $i++) {
            $xpeca = $_POST["peca_" . $i];
            if(!empty($xpeca)) {
                $sql = "SELECT peca FROM tbl_peca WHERE fabrica = $login_fabrica AND referencia = '$xpeca'";
                $res = pg_query($con, $sql);

                $array_peca[] = pg_fetch_result($res, 0, "peca");
            }
        }

        if (in_array($familia, array(3930, 3932)) and $defeito_constatado == 20906 AND !in_array($produto,array(207157,207158,207159))) {
            if (!in_array(1424754, $array_peca)) {
                $msg_erro .= "Para o produto e ".$tema." escolhido é obrigatorio ter a peça 270040 - FONTE MICROPROCESSADA PATEC2 RHE <br />";
            }

            if (in_array(1370632, $array_peca)) {
                $msg_erro .= "Para o produto e ".$tema." escolhido não pode ser lançado a peça 270033 - FONTE PATEC2 RHE <br />";
            }
        } else {
            if (in_array(1424754, $array_peca) AND !in_array($produto,array(207157,207158,207159))) {
                $msg_erro .= "Para o produto e ".$tema." escolhido não pode ser lançado a peça 270040 - FONTE MICROPROCESSADA PATEC2 RHE <br />";
            }
        }
    }

    if ($login_fabrica == 3 && strlen($msg_erro) > 0) {
        /*
            SEMPRE QUE ALTERAR ALGUMA REGRA DESTE IF ALTERAR PARA O IF DA LINHA 2843
            POIS FAZ AS MESMAS REGRAS CASO NÃO DÊ NENHUM ERRO DE CABEÇALHO
        */
        unset($qtde_fotos);
        unset($serial_lcd);
        unset($os_item_array);
        $types   = array("gif", "png", "jpg", "jpeg");
        $qtde_item = $_POST["n_itens"];

        for ($i = 0 ; $i < $qtde_item ; $i++) {
           $xpeca    = $_POST['peca_'           . $i];
           $xservico = $_POST['servico_'        . $i];

            if ($login_fabrica == 3 and $xservico == 20) {
                unset($files, $foto_upload);

                $qtde_fotos[$i] = $_POST["qtde_fotos_$i"];
                $serial_lcd[$i] = $_POST["serial_lcd_$i"];

                if ($serial_lcd[$i] == "t") {
                    $txt_serial_lcd[$i] = $_POST["txt_serial_lcd_$i"];

                    if (!strlen($txt_serial_lcd[$i])) {
                        $msg_erro .= "O serial para a peça $xpeca é obrigatório. <br />";
                    }
                }

                if ($qtde_fotos[$i] > 0) {
                    $foto_obg_erro = false;

                    for ($k = 0; $k < $qtde_fotos[$i]; $k++) {
                        if ($_POST["temp_uploaded_{$i}_{$k}"]) {
                            $temp_uploaded[$i][$k]["upload"] = $_POST["temp_uploaded_{$i}_{$k}"];
                            $temp_uploaded[$i][$k]["ext"]    = $_POST["temp_uploaded_ext_{$i}_{$k}"];

                            if ($temp_uploaded[$i][$k]["upload"] <> "t") {
                                $foto_obg_erro = true;
                            } else {
                                if ($foto_obg_erro === false) {
                                    $foto_upload[$k]["upload"] = $temp_uploaded[$i][$k]["upload"];
                                    $foto_upload[$k]["ext"]    = $temp_uploaded[$i][$k]["ext"];
                                }
                            }
                        }
                    }

                    if ($foto_obg_erro) {
                        $msg_erro .= "Para a peça {$xpeca} é obrigatorio o upload das fotos. <br />";
                    }
                }
            }
        }
    }

    if($login_fabrica == 74 ) {
        $solicitacao_peca = "";
        $osJaLancada = false;
        $solucaoOsJaLancada = null;
        /* Verifica se o tipo do posto tem revenda cadasatrada OSCOnsumidorVinculada */
        $sqlVerificaPosto = "SELECT parametros_adicionais
                             FROM tbl_posto_fabrica
                             WHERE fabrica = 74 AND
                                   posto = {$login_posto} ";
        $resVerificaPosto = pg_query($con, $sqlVerificaPosto);

        $parametros_adicionais =  pg_fetch_result($resVerificaPosto, 0, "parametros_adicionais");

        $parametrosAdicionais = json_decode($parametros_adicionais);

        if(isset($parametrosAdicionais->revendaOSVinculada)) {
            $arrOsVinculada = $parametrosAdicionais->revendaOSVinculada;
        }else{

        }

        /* verifica revenda da OS */
        $sqlOSConsumidorVinculada = "SELECT revenda from tbl_os where os = $os";

        $resOSConsumidorVinculada = pg_query($con, $sqlOSConsumidorVinculada);
        $revendaOs = pg_fetch_result($resOSConsumidorVinculada, 0, "revenda");

        if(!empty($arrOsVinculada) and !in_array($revendaOs,$arrOsVinculada)){
                $msg_erro = "Revenda n&atilde;o autorizada para esta solu&ccedil;&atilde;o.";
        }
        /* Verifica se OS tem registro em tbl_os_campo_extra.
           Se houver esse registro e a solução da OS for Solicitação de Peças (4637), não deve deixar lançar itens
        */

        $sqlVerificaOsVinculada = "SELECT solucao_os
                                   FROM tbl_os_campo_extra
                                   INNER JOIN tbl_os on tbl_os.os = tbl_os_campo_extra.os_troca_origem AND
                                              tbl_os.fabrica = tbl_os_campo_extra.fabrica
                                   WHERE tbl_os_campo_extra.fabrica = {$login_fabrica} AND
                                         os_troca_origem = {$os} AND
                                         tbl_os.solucao_os = 4637";
       $resVerificaOsVinculada = pg_query($con, $sqlVerificaOsVinculada);
       if(pg_num_rows($resVerificaOsVinculada) > 0){
           $osJaLancada=true;
           $solicitacao_peca = true;
           $solucaoOsJaLancada = pg_fetch_result($resVerificaOsVinculada,0,"solucao_os");
       }
    /* compara se revenda esta dentro do array dos parametros_adicionais */
    /* se tiver lança nova OS, e não deixa lançar itens. Senão, continua o processo normalmente */

        if(in_array($revendaOs, $arrOsVinculada) && !$osJaLancada and $solucao_os == 4637) {

          $insertNovaOs = "INSERT INTO tbl_os(
                                       fabrica               ,
                                       posto                 ,
                                       data_abertura         ,
                                       data_nf               ,
                                       consumidor_nome       ,
                                       revenda_cnpj          ,
                                       revenda_nome          ,
                                       consumidor_cidade     ,
                                       consumidor_estado     ,
                                       consumidor_fone       ,
                                       produto               ,
                                       revenda_fone          ,
                                       defeito_reclamado     ,
                                       revenda               ,
                                       aparencia_produto     ,
                                       consumidor_cpf        ,
                                       qtde_km               ,
                                       consumidor_revenda    ,
                                       nota_fiscal           ,
                                       garantia_produto      ,
                                       tipo_atendimento      ,
                                       consumidor_endereco   ,
                                       consumidor_numero     ,
                                       consumidor_cep        ,
                                       consumidor_bairro     ,
                                       consumidor_email
                                 ) ( SELECT                                            fabrica               ,
                                       posto                 ,
                                       data_abertura         ,
                                       data_nf               ,
                                       consumidor_nome       ,
                                       revenda_cnpj          ,
                                       revenda_nome          ,
                                       consumidor_cidade     ,
                                       consumidor_estado     ,
                                       consumidor_fone       ,
                                       produto               ,
                                       revenda_fone          ,
                                       defeito_reclamado     ,
                                       revenda               ,
                                       aparencia_produto     ,
                                       consumidor_cpf        ,
                                       qtde_km               ,
                                       consumidor_revenda    ,
                                       nota_fiscal           ,
                                       garantia_produto      ,
                                       tipo_atendimento      ,
                                       consumidor_endereco   ,
                                       consumidor_numero     ,
                                       consumidor_cep        ,
                                       consumidor_bairro     ,
                                       consumidor_email
                                   FROM tbl_os
                                   WHERE os = $os
                                  ) RETURNING os";
         $resNewOs = pg_query($con, $insertNovaOs);

            if(!$resNewOs){
                $msg_erro = "Erro ao inserir nova OS para deslocamento";
            }else{

                if(strlen($msg_erro) == 0){
                    $newOs = pg_fetch_result($resNewOs, 0, "os");

                    $insertCampoExtra = "INSERT INTO tbl_os_campo_extra(
                                     os,
                                     fabrica,
                                     os_troca_origem
                                ) VALUES (
                                     {$newOs},
                                     {$login_fabrica},
                                     $os
                                )";

                    $resInsertCampoExtra = pg_query($con, $insertCampoExtra);

                    if(!$resInsertCampoExtra){
                        $msg_erro = "Erro ao inserir nova OS para deslocamento";

                    }else{

                        $sql= "SELECT fn_valida_os($newOs, $login_fabrica)";
                        pg_query($con, $sql);
                        $msg_erro = pg_last_error($con);

                        if(strlen($msg_erro) == 0){
                            $solicitacao_peca = true;
                        }
                    }
                }
            }

        }else{

            if(strlen($msg_erro) == 0){

                if(!empty($solucaoOsJaLancada) && ($solucaoOsJaLancada != $_POST["solucao_os"]) ){

                    $msg_erro = "N&atilde;o &eacute; poss&iacute;vel alterar a OS.";

                }
            }
        }
    }

    if (strlen($msg_erro) == 0) {

        $qtde_item = $_POST['qtde_item'];
        $loop_itens = $qtde_item;
        $qtde_item_ant = $_POST['qtde_item_ant'];

        if (in_array($login_fabrica, array(3,15,74,86,94)))
        {
           $qtde_item = $_POST["n_itens"];
        }

        if($login_fabrica == 104){
            $sqlServico1 = "SELECT servico_realizado FROM tbl_servico_realizado WHERE fabrica = $login_fabrica AND descricao ilike '%estoque%' and gera_pedido IS NOT TRUE";
            $resServico1 = pg_query($con,$sqlServico1);

            if(pg_num_rows($resServico1) > 0){
                $verifica_servico = pg_fetch_result($resServico1,0,0);
            }

            if(empty($login_admin)){
                $sql_pedido_exportado = "SELECT 
                                            osp.os,
                                            pd.pedido,
                                            pd.status_pedido,
                                            pd.exportado,
                                            osi.servico_realizado
                                            FROM tbl_os_produto osp
                                            JOIN tbl_os_item osi ON osi.os_produto = osp.os_produto
                                            JOIN tbl_pedido_item pi ON pi.pedido_item = osi.pedido_item
                                            JOIN tbl_pedido pd ON pd.pedido = pi.pedido
                                            WHERE osp.os = {$os}
                                            AND pd.fabrica = {$login_fabrica}";

                $res_pedido_exportado   = pg_query($con, $sql_pedido_exportado);
                $contador_res_exportado = pg_num_rows($res_pedido_exportado);

                if($contador_res_exportado > 0){  
                    for($x=0; $x<$contador_res_exportado; $x++){
                        $status_pedido_exportado        = pg_fetch_result($res_pedido_exportado, $x, status_pedido);
                        $pedido_exportado               = pg_fetch_result($res_pedido_exportado, $x, exportado);
                        $servico_realizado_exportado    = pg_fetch_result($res_pedido_exportado, $x, servico_realizado);                                                

                        if($servico_realizado_exportado != 10585){
                            $contador_servico_realizado += 1;
                        }
                    }

                    if(!empty($pedido_exportado) AND $contador_servico_realizado == 0){
                        $msg_erro .= 'Não é permitido lançar peças com pedido gerado e exportado ';
                    }                    
                }
            }
        }

        $array_peca_de_gas = array('073894','073897','073373','771889','074957','773936');

        $array_pecas_kit = array();

        if ($login_fabrica == 30) {
            $sql_posto = "SELECT tipo_posto
                          FROM tbl_posto_fabrica
                          WHERE fabrica = {$login_fabrica}
                          AND posto = {$login_posto}";
            $res_posto = pg_query($con, $sql_posto);

            $xtipo_posto = pg_fetch_result($res_posto, 0, "tipo_posto");

            $sqlEstoque = "select controla_estoque from tbl_posto_fabrica where fabrica = $login_fabrica and posto = $login_posto";
            $resEstoque = pg_query($con,$sqlEstoque);
            $controla_estoque = pg_fetch_result($resEstoque, 0, 'controla_estoque');

            $sqlServico = "SELECT servico_realizado
                            FROM tbl_servico_realizado
                            WHERE fabrica = $login_fabrica
                            AND peca_estoque
                            AND gera_pedido IS FALSE";
            $resServico = pg_query($con,$sqlServico);
            if(pg_num_rows($resServico) > 0){
                $servico_estoque = pg_fetch_result($resServico, 0, 'servico_realizado');
            }

            $sqlServico = "SELECT servico_realizado
                            FROM tbl_servico_realizado
                            WHERE fabrica = $login_fabrica
                            AND gera_pedido
                            AND peca_estoque IS NOT TRUE
                            AND ressarcimento IS NOT TRUE";
            $resServico = pg_query($con,$sqlServico);
            if(pg_num_rows($resServico) > 0){
                $servico_garantia = pg_fetch_result($resServico, 0, 'servico_realizado');
            }

            $t = 0;
        }

        $peca_negativa = array();
        $t = 0;

        if ($login_fabrica == 3) {
            unset($qtde_fotos);
            unset($serial_lcd);
            unset($os_item_array);
            $types   = array("gif", "png", "jpg", "jpeg");
        }

        $po_peca = array();
        $po_peca_usa = array();

        if(in_array($login_fabrica,array(131,134,144))){
            $defeitoAux = true;
            $defeitos_constatado = array();
            $i = 0;
            while($defeitoAux == true){
                $i += 1;

                if(isset($_POST['integridade_defeito_constatado_'.$i])){
                    $defeitos_constatado[] = "'".$_POST['integridade_defeito_constatado_'.$i]."'";
                }else{
                    break;
                }
            }
        }

        if(in_array($login_fabrica,array(19))){
            if(isset($_POST['defeitos_lorenzetti_hidden'])){
                $defeito_constatado = $_POST['defeitos_lorenzetti_hidden'];
                $defeito_constatado = str_replace("\"", '', $defeito_constatado);
                $defeito_constatado = str_replace("\\", '', $defeito_constatado);

                $defeitos_constatado = json_decode($defeito_constatado, true);
            }
        }

        $defeitos_constatado =  implode(',', $defeitos_constatado);

        if ($login_fabrica == 50) {
            $peca_unica = array();

            for ($i = 0; $i < $qtde_item; $i++) {
                $xpeca_ref = $_POST["peca_".$i];

                if (strlen($xpeca_ref) > 0) {
                    $sql = "SELECT peca_unica_os FROM tbl_peca WHERE fabrica = $login_fabrica AND referencia = '$xpeca_ref' AND peca_unica_os IS TRUE";
                    $res = pg_query($con, $sql);

                    if (pg_num_rows($res) > 0) {
                        $peca_unica[] = $xpeca_ref;
                    }
                }
            }

            if (count($peca_unica) > 1) {
                $msg_erro .= "As seguintes peças não podem ser lançadas juntas: ".implode(", ", $peca_unica);
            }
        }

        if($login_fabrica == 140){
            $pecas_importadas = array();

            $sql_posto_nome = "SELECT
                                tbl_posto.nome
                            FROM tbl_posto JOIN tbl_posto_fabrica
                                ON tbl_posto.posto = tbl_posto_fabrica.posto
                                AND tbl_posto_fabrica.fabrica = $login_fabrica
                            WHERE tbl_posto.posto = $login_posto";
            $res_posto_nome = pg_query($con, $sql_posto_nome);
            $posto_nome = pg_fetch_result($res_posto_nome, 0, 'nome');

        }

         if ($login_fabrica == 104) {
             $sql_contatos_consumidor = "
                SELECT consumidor_email,
                    consumidor_celular,
                    referencia,
                    descricao
                FROM tbl_os
                JOIN tbl_produto USING(produto)
                WHERE os = $os";
             $qry_contatos_consumidor = pg_query($con, $sql_contatos_consumidor);

             $consumidor_email = pg_fetch_result($qry_contatos_consumidor, 0, 'consumidor_email');
             $consumidor_celular = pg_fetch_result($qry_contatos_consumidor, 0, 'consumidor_celular');
             $produto_os = pg_fetch_result($qry_contatos_consumidor, 0, 'referencia') . ' - ' . pg_fetch_result($qry_contatos_consumidor, 0, 'descricao');
         }

         $pecas_lancadas         = array();
         $pecas_lancadas_os_item = array();
         $alterou_pecas          = false;

         if(in_array($login_fabrica, array(104))){

            for ($i = 0 ; $i < $qtde_item ; $i++) {

                $xos_item  = $_POST['os_item_'.$i];
                $xpeca_ref = $_POST['peca_'.$i];

                if(strlen($xos_item) == 0 && strlen($xpeca_ref) == 0){
                    continue;
                }

                if(strlen($xos_item) == 0 && strlen($xpeca_ref) > 0){
                    $alterou_pecas = true;
                    continue;
                }

                $sql_peca_id = "SELECT peca FROM tbl_peca WHERE referencia = '{$xpeca_ref}' AND fabrica = {$login_fabrica}";
                $res_peca_id = pg_query($con, $sql_peca_id);

                if(pg_num_rows($res_peca_id) > 0){

                    $xpeca = pg_fetch_result($res_peca_id, 0, "peca");

                    $sql_verifica_peca = "SELECT os_item FROM tbl_os_item WHERE fabrica_i = {$login_fabrica} AND os_item = {$xos_item} AND peca = {$xpeca}";
                    $res_verifica_peca = pg_query($con, $sql_verifica_peca);

                    if(pg_num_rows($res_verifica_peca) == 0) {
                        $alterou_pecas = true;
                    }else{
                        $pecas_lancadas_os_item[] = $xpeca_ref;
                    }

                }

            }

         }

        $gravar_auditoria_produto_acabado = false;
        $arr_pecas_qtde = array();

        if (($login_fabrica == 15 && !in_array($login_posto, [343192, 118825, 393942])) || $login_fabrica <> 15) {

            for ($p = 0; $p < $qtde_item; $p++) {
                if(strlen(trim($_POST["peca_". $p])) == 0){
                        continue;
                    }
                $ref_peca   = trim($_POST["peca_" . $p]);
                $desc_peca  = trim($_POST["descricao_". $p]);

                $sql_peca_bloqueada = "SELECT bloqueada_garantia FROM tbl_peca WHERE referencia = '$ref_peca' AND fabrica = $login_fabrica ";
                $res_peca_bloqueada = pg_query($con, $sql_peca_bloqueada);
                if (pg_num_rows($res_peca_bloqueada) > 0) {
                    if (pg_fetch_result($res_peca_bloqueada, 0, 'bloqueada_garantia') == "t" && !in_array($login_fabrica, [3,72])) {
                        $msg_erro .= "<br>Peça: $ref_peca - $desc_peca bloqueada para garantia. <br>";
                    }
                }     
            }
        }

        $emAuditoria = false;
        
        for ($i = 0 ; $i < $qtde_item ; $i++) {

            $xos_item            = $_POST['os_item_'        . $i];
            $xorcamento_item     = $_POST['orcamento_item_' . $i];
            $xpeca               = $_POST['peca_'           . $i];

            if (!in_array($login_fabrica, [141])) {
                $xos_produto         = $_POST['os_produto_'     . $i];
            } else {

                //Alteração para inserir apenas um os_produto
                $sqlOsProduto = "SELECT os_produto
                                 FROM tbl_os
                                 JOIN tbl_os_produto USING(os)
                                 WHERE os = {$os}";
                $resOsProduto = pg_query($con, $sqlOsProduto);

                if (!empty($xpeca)) {

                    $xos_produto = pg_fetch_result($resOsProduto, 0, 'os_produto');

                } else {

                    $xos_produto = "";

                }

            }

            $xproduto            = $_POST['produto_'        . $i];
            $xserie              = $_POST['serie_'          . $i];
            $xposicao            = $_POST['posicao_'        . $i];
            $xpeca_ref           = $_POST['peca_'           . $i];
            $xqtde               = $_POST['qtde_'           . $i];
            $xdefeito            = $_POST['defeito_'        . $i];
            $xservico            = $_POST['servico_'        . $i];
            $xpeca_serie         = $_POST['peca_serie_'     . $i];
            $xpeca_serie_trocada = $_POST['peca_serie_trocada_' . $i];
            $xpcausa_defeito     = $_POST['pcausa_defeito_' . $i];
            $xreparo_estoque     = $_POST['reparo_estoque_' . $i];
            $xkit_peca           = $_POST['kit_kit_peca_' . $i];
            $descricao           = $_POST['descricao_' . $i];
            $depara_auditoria    = $_POST['depara_auditoria_' . $i];

            if($login_fabrica == 104){
                    
                $anexos_inseridos = [];

                if (!empty($os)){
                    $cond_tdocs = "AND tbl_tdocs.referencia_id = {$os}";
                }else{
                    $cond_tdocs = "AND tbl_tdocs.hash_temp = '{$anexo_chave}'";
                }

                $sql = "SELECT obs
                        FROM   tbl_tdocs
                        WHERE  tbl_tdocs.fabrica = {$login_fabrica}
                        AND    tbl_tdocs.situacao = 'ativo'
                        {$cond_tdocs}";
                $res = pg_query($con, $sql);

                if (pg_num_rows($res) > 0) {

                    while ($dados = pg_fetch_object($res)) {

                        $json_obs = json_decode($dados->obs, true);

                        $anexos_inseridos[] = $json_obs[0]['typeId'];

                    }

                }

                $sqlRefPeca = "SELECT 
                referencia, 
                peca_critica
                FROM tbl_peca
                WHERE fabrica = {$login_fabrica}
                AND ativo = 't'
                AND referencia = '{$xpeca_ref}'";  

                //die(nl2br($sqlRefPeca));

                $resRefPeca     = pg_query($con, $sqlRefPeca);                
                $confereCritica = pg_fetch_result($resRefPeca, 0, 'peca_critica');
                
                if($confereCritica == 't'){  
                    $contar_anexos_inseridos = count($anexos_inseridos);
                    for($x=0; $x<$contar_anexos_inseridos; $x++){
                        $anexo_x = $anexos_inseridos[$x];
                        if($anexo_x == "peca"){
                            $contador_anexo_x++;                                  
                        }
                    }

                    if($contador_anexo_x == 0){
                        $contador_x++;
                    }                    
                }
            }            

            if($login_fabrica == 123 and empty($xos_item) and !empty($xpeca_ref)){
                
                $sqlVerificaAuditoria = "SELECT auditoria_os FROM tbl_auditoria_os WHERE os = $os AND auditoria_status = 6 and (bloqueio_pedido IS TRUE OR cancelada IS NOT NULL OR reprovada IS NOT NULL) ORDER BY auditoria_os DESC"; 
                $resVerificaAuditoria = pg_query($con, $sqlVerificaAuditoria);
                if(pg_num_rows($resVerificaAuditoria)==0){
                    $sql_auditoria = "INSERT INTO tbl_auditoria_os (auditoria_status, os, observacao) VALUES (6, $os, 'Lançamento de Peça') ";
                    $res_auditoria = pg_query($con, $sql_auditoria);

                    $emAuditoria = true;

                    if(strlen(pg_last_error($con))>0){
                        $msg_erro .= "Falha ao gravar auditoria de fábrica. ";
                    }
                }
            }

            if(in_array($login_fabrica, [123]) and strlen(trim($xpeca))>0){

                if(isset($arr_pecas_qtde["$xpeca"])){
                    $arr_pecas_qtde["$xpeca"] += 1;
                }else{
                    $arr_pecas_qtde["$xpeca"] = 1;
                }

                $sql_listaBasica = "SELECT lista_basica, tbl_peca.peca, qtde 
                                    from tbl_lista_basica 
                                    join tbl_produto using(produto) 
                                    join tbl_peca using(peca) 
                                    where tbl_produto.referencia = '$xproduto' 
                                    and tbl_lista_basica.fabrica = $login_fabrica 
                                    and tbl_peca.referencia = '$xpeca' 
                                    and tbl_lista_basica.qtde >= ".$arr_pecas_qtde["$xpeca"];
                $res_listaBasica = pg_query($con, $sql_listaBasica);
                if(pg_num_rows($res_listaBasica)==0){
                    $msg_erro .= "A peça $xpeca está com a quantidade maior do que a lista básica do produto. <br>";
                }
            }

            //valida troca de produto e peça is not produto acabado
            // Removendo regra HD-6213401 
            if($login_fabrica == 134 and strlen(trim($xos_item)) == 0 and strlen(trim($xpeca)) > 0 && 1==2){
                $sql_produto_acabado = "SELECT peca, produto_acabado 
                                        FROM tbl_peca 
                                        WHERE referencia = '$xpeca' 
                                        AND fabrica = $login_fabrica 
                                        AND produto_acabado is not true ";
                $res_produto_acabado = pg_query($con, $sql_produto_acabado);

                if(pg_num_rows($res_produto_acabado)>0 and in_array('081', $defeitos_hidden)){
                    $gravar_auditoria_produto_acabado = true;
                }
            }

            if(in_array($login_fabrica, array(104))){

                if(strlen($xservico) > 0){

                    $servico_gera_troca = false;

                    $sql_servico_troca = "SELECT troca_de_peca FROM tbl_servico_realizado WHERE servico_realizado = {$xservico} AND fabrica = {$login_fabrica}";
                    $res_servico_troca = pg_query($con, $sql_servico_troca);

                    if(pg_num_rows($res_servico_troca) > 0){

                        $troca_peca = pg_fetch_result($res_servico_troca, 0, "troca_de_peca");
                        $servico_gera_troca = ($troca_peca == "t") ? true : false;

                    }

                    if(!in_array($xpeca_ref, $pecas_lancadas_os_item)){

                        if (!empty($xpeca_ref) && !empty($descricao) && $servico_gera_troca === true) {
                            $pecas_lancadas[] = $xpeca_ref . ' - ' . $descricao;
                        }

                    }

                }

            }


            # HD 2551514 - Esmaltec
            if (in_array($login_fabrica, array(30))) {
                    $xobs_os_item = $_POST['obs_os_item_'.$i];
            }
            # ------------------------------------

            if (in_array($login_fabrica, array(141,144)) && empty($xos_item) && !empty($xpeca) && $necessita_troca_produto == "t") {
                $msg_erro = "Após solicitado troca de produto, não pode ser lançado novas peças. <br />";
                continue;
            }

            if($login_fabrica == 91){
                $xfornecedor = $_POST['fornecedor_'.$i];
                if((strlen($xfornecedor) == 0) && !empty($xpeca) && empty($xkit_peca)){
                    $msg_erro = "Favor, cadastrar o fornecedor da(s) peça(s)";
                    continue;
                }else{
                    $campo_fornecedor = ", fornecedor";
                    $valor_fornecedor = ", ".$xfornecedor;
                }

            }

            if($login_fabrica == 140){

                if(trim($descricao) == "PEÇA IMPORTADA"){

                    $pecas_importadas[] = array(
                        "referencia"    => $xpeca_ref,
                        "descricao"     => $descricao,
                        "posto"         => $posto_nome,
                        "pedido"        => $pedido,
                        "tipo_pedido"   => $tipo_pedido,
                        "os"            => $os
                    );

                }

            }
            /*
            if($login_fabrica == 19 and strlen($_POST['peca_'           . $i]) > 0){ //HD-2881143NEW
                $defeitoL = $_POST["defeitos_lorenzetti_hidden"];
                // $defeitosL = str_replace('[', '', $defeitoL);
                // $defeitosM = str_replace(']', '', $defeitosL);

                $defeitosL = preg_replace('/[\[\]]/', '', $defeitosL);
                $defeitosL = str_replace('\\', '', $defeitosL);
                $defetiosIN = str_replace('"', '', $defeitosL);

                $sql_valida_pecas = "SELECT DISTINCT tbl_peca.peca
                        FROM tbl_peca
                        JOIN tbl_peca_familia ON tbl_peca_familia.peca = tbl_peca.peca AND tbl_peca_familia.fabrica = $login_fabrica
                        JOIN tbl_defeito_constatado_familia_peca ON tbl_defeito_constatado_familia_peca.familia_peca = tbl_peca_familia.familia_peca
                            AND tbl_defeito_constatado_familia_peca.fabrica = $login_fabrica
                        WHERE tbl_peca.referencia = '$xpeca'
                        AND tbl_defeito_constatado_familia_peca.defeito_constatado IN ($defetiosIN)";
                        #echo nl2br($sql_valida_pecas);exit;
                $res_valida_pecas = pg_query($con, $sql_valida_pecas);

                if(pg_num_rows($res_valida_pecas) == 0){
                    $msg_erro = "Peça $xpeca não pertence a nenhum defeito lançado";
                }
            }
            */
            if(in_array($login_fabrica,array(19,134))and strlen($_POST['peca_'. $i]) > 0){

                if(strlen(trim($defeitos_constatado)) >0 ){
                    $sql = "select produto from tbl_produto join tbl_linha USING (linha) left join tbl_familia using(familia) where tbl_produto.referencia like('$xproduto')  and tbl_linha.fabrica = $login_fabrica";

                    $res = pg_query($con,$sql);
                    $produto_aux = pg_result($res,0,produto);

                    $sql = "select peca from tbl_peca where referencia like('$xpeca') and fabrica  = $login_fabrica";

                    $res = pg_query($con,$sql);
                    $peca_aux = pg_result($res,0,peca);

                    $sql = "SELECT tbl_peca.peca, tbl_peca.referencia as peca_referencia, tbl_peca.descricao as peca_descricao
                            from tbl_peca join tbl_peca_defeito_constatado using(peca)
                            join tbl_defeito_constatado using(defeito_constatado)
                            join tbl_lista_basica using(peca)
                            where tbl_peca_defeito_constatado.fabrica = $login_fabrica
                            and tbl_defeito_constatado.defeito_constatado in($defeitos_constatado)
                            and tbl_lista_basica.produto = $produto_aux
                            and tbl_lista_basica.peca = $peca_aux;";

                    $res = pg_query($con,$sql);
                    if(pg_result($res,0,peca) == ""){
                        $msg_erro .= " A peça $xpeca não está relacionada ao(s) defeito(s) constatado(s) selecionados</br> ";
                    }
                }else{
                    $msg_erro .= "Informe um ".$tema."</br> ";
                }

            }

            if (in_array($login_fabrica, array(120,201)) && !empty($xpeca) && empty($xservico)) {
                $msg_erro .= "Favor, preencher o serviço da peça $xpeca_ref - $descricao <br />";
            }

            if (in_array($login_fabrica, array(120,201)) && !empty($xpeca) && empty($xdefeito)) {
                $msg_erro .= "Favor, preencher o defeito da peça $xpeca_ref - $descricao <br />";
            }
            
            if ($login_fabrica == 50 && strlen($xpeca_ref) > 0) {
                $sql_peca = "SELECT peca FROM tbl_peca WHERE fabrica = $login_fabrica AND referencia = '$xpeca_ref'";
                $res_peca = pg_query($con, $sql_peca);

                if (pg_num_rows($res_peca) > 0) {
                    $peca_aux = pg_fetch_result($res_peca, 0, "peca");

                    $sql_produto = "SELECT produto FROM tbl_produto WHERE fabrica_i = $login_fabrica AND referencia = '$xproduto'";
                    $res_produto = pg_query($con, $sql_produto);

                    if (pg_num_rows($res_produto)) {
                        $produto_aux = pg_fetch_result($res_produto, 0, "produto");

                        if (in_array($produto_aux, array(34333, 212885, 212884, 34914, 214793)) && in_array($peca_aux, array(1466423, 864884, 854989, 1501803, 1539430, 1539441, 1547942, 1547941, 1547940))) {
                            $sql_os_serie = "SELECT data_fabricacao
                                             FROM tbl_os
                                             JOIN tbl_numero_serie ON tbl_numero_serie.produto = tbl_os.produto AND tbl_numero_serie.serie = tbl_os.serie AND tbl_numero_serie.fabrica = $login_fabrica
                                             WHERE tbl_os.os = $os
                                             AND tbl_os.fabrica = $login_fabrica";
                            $res_os_serie = pg_query($con, $sql_os_serie);

                            if (pg_num_rows($res_os_serie) > 0) {
                                $serie_data_fabricacao = pg_fetch_result($res_os_serie, 0, "data_fabricacao");

                                if (strtotime($serie_data_fabricacao) < strtotime('2014-03-01')) {
                                    if (in_array($peca_aux, array(1501803, 1539430, 1539441))) {
                                        $msg_erro .= "A peça $xpeca_ref não pode ser lançada na OS<br />";
                                    } else if (in_array($peca_aux, array(1466423, 864884, 854989))) {
                                        switch ($peca_aux) {
                                            case 1466423:
                                                $msg_erro .= "Por favor troque a peça $xpeca_ref pela peça 077.1.602<br />";
                                                break;

                                            case 864884:
                                                $msg_erro .= "Por favor troque a peça $xpeca_ref pela peça 077.1.601<br />";
                                                break;

                                            case 854989:
                                                $msg_erro .= "Por favor troque a peça $xpeca_ref pela peça 077.1.600<br />";
                                                break;
                                        }
                                    }
                                } else {
                                    if (in_array($peca_aux, array(1466423, 864884, 854989, 1547942, 1547941, 1547940))) {
                                        $msg_erro .= "A peça $xpeca_ref não pode ser lançada na OS<br />";
                                    }
                                }
                            }
                        }
                    }
                }
            }

            if($login_fabrica == 35){
                $po_peca[$i] = $_POST['po_peca_'.$i];

                $sql_po = "SELECT promocao_site FROM tbl_peca WHERE referencia = '$xpeca_ref' AND fabrica = $login_fabrica";
                $res_po = pg_query($con, $sql_po);

                if(pg_num_rows($res_po) > 0){
                    $promocao_site = pg_fetch_result($res_po, 0, promocao_site);

                    if ($promocao_site == "t") {
                        $po_peca_usa[$i] = "t";
                    }

                    if($promocao_site == 't' && strlen($po_peca[$i]) == 0){
                        $msg_erro .= "O PO Peça da peça $xpeca_ref é obrigatório. <br />";
                    }
                }

           }

            if ($login_fabrica == 3 and $xservico == 20) {
                /*
                    SEMPRE QUE ALTERAR ALGUMA REGRA DESTE IF ALTERAR PARA O IF DA LINHA 2702
                    POIS FAZ AS MESMAS REGRAS CASO DÊ ALGUM ERRO DE CABEÇALHO
                */
                unset($files, $foto_upload);

                $qtde_fotos[$i] = $_POST["qtde_fotos_$i"];
                $serial_lcd[$i] = $_POST["serial_lcd_$i"];

                if ($serial_lcd[$i] == "t") {
                    $txt_serial_lcd[$i] = $_POST["txt_serial_lcd_$i"];

                    if (!strlen($txt_serial_lcd[$i])) {
                        $msg_erro .= "O serial para a peça $xpeca é obrigatório. <br />";
                    }
                }

                if ($qtde_fotos[$i] > 0) {
                    $foto_obg_erro = false;

                    for ($k = 0; $k < $qtde_fotos[$i]; $k++) {
                        if ($_POST["temp_uploaded_{$i}_{$k}"]) {
                            $temp_uploaded[$i][$k]["upload"] = $_POST["temp_uploaded_{$i}_{$k}"];
                            $temp_uploaded[$i][$k]["ext"]    = $_POST["temp_uploaded_ext_{$i}_{$k}"];

                            if ($temp_uploaded[$i][$k]["upload"] <> "t") {
                                $foto_obg_erro = true;
                            } else {
                                if ($foto_obg_erro === false) {
                                    $foto_upload[$k]["upload"] = $temp_uploaded[$i][$k]["upload"];
                                    $foto_upload[$k]["ext"]    = $temp_uploaded[$i][$k]["ext"];
                                }
                            }
                        }
                    }

                    if ($foto_obg_erro) {
                        $msg_erro .= "Para a peça {$xpeca} é obrigatorio o upload das fotos. <br />";
                    } else {
                        $item_foto_upload = "t";
                    }
                }
            } else {
                $item_foto_upload = "f";
            }

            if(in_array($xpeca, $array_peca_de_gas)) {
                if($xservico <> 692){
                    $msg_erro = "O serviço para peça $xpeca deve ser Recarga de Gás.";
                }
            }

            if ($login_fabrica == 30 && $xtipo_posto <> 368 and !empty($xpeca)) {
                $sql_peca = "SELECT peca
                            FROM tbl_peca
                            where referencia='$xpeca'
                            and fabrica = {$login_fabrica}
                            and (remessa_garantia IS TRUE OR remessa_garantia_compressor IS TRUE)";
                $res_peca = pg_query($con, $sql_peca);

                if (pg_num_rows($res_peca) > 0 && $xservico == 549) {
                    $msg_erro = "A peça $xpeca não pode ser lançada com o serviço Troca de peça (faturada)";
                }
            }

            if ($login_fabrica == 30 && $xtipo_posto == 368 && $xservico == 549) {
                $msg_erro = "A peça $xpeca não pode ser lançada com o serviço Troca de peça (faturada)";
            }

            if ($login_fabrica == 30 and $controla_estoque == 't' AND !empty($xpeca)) {
                if(strlen($xkit_peca) > 0){
                    $xsql_peca = "
                        SELECT  tbl_peca.peca                           AS peca_kit             ,
                                tbl_peca.remessa_garantia                                       ,
                                tbl_peca.remessa_garantia_compressor                            ,
                                tbl_peca.referencia                     AS peca_kit_referencia  ,
                                tbl_kit_peca_peca.qtde                  AS peca_kit_qtde
                        FROM    tbl_peca
                        JOIN    tbl_kit_peca_peca   USING(peca)
                        JOIN    tbl_kit_peca        USING (kit_peca)
                        WHERE   tbl_kit_peca_peca.kit_peca  = $xkit_peca
                        AND     tbl_kit_peca.fabrica        = $login_fabrica
                    ";
                    $xres_peca = pg_query($con, $xsql_peca);
                    if(pg_numrows($xres_peca) > 0){
                        $contar_peca = pg_numrows($xres_peca);
                        for($px = 0; $px < $contar_peca; $px++){
                            $peca_kit                       = pg_fetch_result($xres_peca,$px,peca_kit);
                            $remessa_garantia               = pg_fetch_result($xres_peca,$px,remessa_garantia);
                            $remessa_garantia_compressor    = pg_fetch_result($xres_peca,$px,remessa_garantia_compressor);
                            $peca_kit_referencia            = pg_fetch_result($xres_peca,$px,peca_kit_referencia);
                            $peca_kit_qtde                  = pg_fetch_result($xres_peca,$px,peca_kit_qtde);

                            $sqlAN = "  SELECT  SUM(qtde) AS qtde
                                        FROM    tbl_estoque_posto
                                        WHERE   posto   = $login_posto
                                        AND     peca    = $peca_kit
                                        AND     fabrica = $login_fabrica";
                            $resAN = pg_exec($con, $sqlAN);
                            if (pg_numrows($resAN) > 0) {
                                $qtde_total_estoque  = pg_result($resAN,0,'qtde');
                            }

                            if (strlen($os) > 0) {
                                $cond_os = " AND os <> $os ";
                            }

                            $sqlq = "SELECT sum(qtde) as qtde
                                    FROM    tbl_os
                                    JOIN    tbl_os_produto USING(os)
                                    JOIN    tbl_os_item USING(os_produto)
                                    JOIN    tbl_servico_realizado ON tbl_os_item.servico_realizado = tbl_servico_realizado.servico_realizado
                                    WHERE   tbl_os_item.peca = $peca_kit
                                    AND     tbl_os.finalizada IS NULL
                                    AND     tbl_os.data_fechamento IS NULL
                                    AND     tbl_os.posto   = $login_posto
                                    AND     tbl_os.fabrica = $login_fabrica
                                    AND     tbl_servico_realizado.peca_estoque IS TRUE
                                    {$cond_os} ";

                            $resq    = pg_query($con, $sqlq);

                            $qtde_os =  pg_fetch_result($resq,0,'qtde');
                            $qtde_os = ($qtde_os > 0) ? $qtde_os : 0;

                            $qtde_os += $xqtde;

                            if ($qtde_total_estoque < ($peca_kit_qtde * $xqtde) AND $remessa_garantia != "t" AND $remessa_garantia_compressor != "t") {

                                $peca_negativa['p_'.$t] = $peca_kit;
                                $t++;

                            }else{
                                if($remessa_garantia != "t" AND $remessa_garantia_compressor != "t"){
                                    $xservico = $servico_estoque;
                                }
                            }
                        }
                    }
                }else{
                    $sql_peca = "SELECT peca,remessa_garantia,remessa_garantia_compressor
                                FROM tbl_peca
                                where referencia='$xpeca'
                                and fabrica = {$login_fabrica}";
                    $res_peca = pg_query($con, $sql_peca);
                    $xxpeca = pg_fetch_result($res_peca, 0, 'peca');
                    $remessa_garantia = pg_fetch_result($res_peca, 0, 'remessa_garantia');
                    $remessa_garantia_compressor = pg_fetch_result($res_peca, 0, 'remessa_garantia_compressor');

                    $sqlq = "SELECT sum(qtde) AS qtde
                                FROM    tbl_estoque_posto
                                WHERE   tbl_estoque_posto.peca = $xxpeca
                                AND     tbl_estoque_posto.posto = $login_posto
                                AND     tbl_estoque_posto.fabrica = $login_fabrica";

                    $resq = pg_query($con, $sqlq);

                    $qtde_estoque = (pg_num_rows($resq) > 0) ? pg_fetch_result($resq,0,'qtde') : 0;

                    $qtde_estoque = ($qtde_estoque > 0) ? $qtde_estoque : 0;

                    if (strlen($os) > 0) {
                        $cond_os = " AND os <> $os ";
                    }

                    $sqlq = "SELECT sum(qtde) as qtde
                            FROM    tbl_os
                            JOIN    tbl_os_produto USING(os)
                            JOIN    tbl_os_item USING(os_produto)
                            JOIN    tbl_servico_realizado ON tbl_os_item.servico_realizado = tbl_servico_realizado.servico_realizado
                            WHERE   tbl_os_item.peca = $xxpeca
                            AND     tbl_os.finalizada IS NULL
                            AND     tbl_os.data_fechamento IS NULL
                            AND     tbl_os.posto   = $login_posto
                            AND     tbl_os.fabrica = $login_fabrica
                            AND     tbl_servico_realizado.peca_estoque IS TRUE
                            {$cond_os} ";

                    $resq    = pg_query($con, $sqlq);

                    $qtde_os =  pg_fetch_result($resq,0,'qtde');
                    $qtde_os = ($qtde_os > 0) ? $qtde_os : 0;

                    $qtde_os += $xqtde;

                    if ($qtde_estoque < $qtde_os AND $remessa_garantia != "t" AND $remessa_garantia_compressor != "t") {

                        $peca_negativa['p_'.$t] = $xxpeca;
                        $t++;

                    }else{
                        if($remessa_garantia != "t" AND $remessa_garantia_compressor != "t"){
                            $xservico = $servico_estoque;
                        }
                    }
                }
            }

            /**
             * - HD 2551514 - Esmaltec (Início)
             * A partir deste HD uma OS que necessitar ser reaberta ou tiver novos
             * lançamentos de peças após a geração de pedido não é mais validada
             * pela quantida de peças da lista básica, será necessário acrescentar
             * um motivo para o acrescimo e essa OS entrará em Auditoria.
             *
             * @author Maicon Antonio
             */
            if (in_array($login_fabrica, array(30)) AND strlen($xpeca) > 0) {
                $sqlVerificarPecas = "
                    SELECT  COUNT(*)
                    FROM    tbl_os_item
                    JOIN    tbl_os_produto  USING(os_produto)
                    JOIN    tbl_os          USING(os)
                    WHERE   tbl_os.os           = $os
                    AND     tbl_os.fabrica      = $login_fabrica
                    AND     tbl_os_item.peca    = (
                        SELECT  peca
                        FROM    tbl_peca
                        WHERE   referencia  = '$xpeca'
                        AND     fabrica     = $login_fabrica
                    )
                    AND     tbl_os_item.pedido IS NOT NULL;";
                $resVerificarPecas  = pg_query($con, $sqlVerificarPecas);
                $qtdeGravado        = pg_fetch_result($resVerificarPecas, 0, 0);
                if ($qtdeGravado > 0) {
                    /**
                     * - Comparar quantidade da OS com
                     * quantidade da lista básica
                     */

                    $sqlComparar = "
                        SELECT  DISTINCT
                                tbl_lista_basica.qtde
                        FROM    tbl_lista_basica
                        JOIN    tbl_peca        ON  tbl_peca.peca           = tbl_lista_basica.peca
                                                AND tbl_peca.referencia     = '$xpeca'
                        JOIN    tbl_os_produto  ON  tbl_os_produto.produto  = tbl_lista_basica.produto
                        JOIN    tbl_os          ON  tbl_os.os               = tbl_os_produto.os
                                                AND tbl_os.os               = $os
                    ";
                    $resComparar = pg_query($con,$sqlComparar);
                    $qtdeLista = pg_fetch_result($resComparar,0,qtde);

                    if(($xqtde + $qtdeGravado) > $qtdeLista){
                        $linhaPecaDuplicada[$xpeca] = $i;
                        $dadosPecasDuplicadas[$xpeca] = array(
                            "qtde"          => (int)$xqtde,
                            "qtdeGravado"   => (int)$qtdeGravado
                        );
                    }
                }
            }

            if (in_array($login_fabrica, array(30)) && in_array($i, $linhaPecaDuplicada) && strlen($xobs_os_item) == 0) {
                if (count($linhaPecaDuplicada) > 1) {
                    $msg_erro = "É necessário um motivo para o lançamento das peças já adicionadas na OS.";
                } else {
                    $msg_erro = "É necessário um motivo para o lançamento da peça ($xpeca - $descricao) já adicionada na OS.";
                }
            }

            # HD 2551514 - Esmaltec (Fim)

            #HD 670814 -  INICIO
            if(($fabricas_padrao_itens || $login_fabrica > 99) && !in_array($login_fabrica, array(91,120,201,172)) ){
                $xdefeito = 'null';
            }

            if($login_fabrica == 95)
                $xdefeito = 'null';

            #HD 670814 -  FIM

            if (!empty($xservico)) {
                if($login_fabrica == 3){ // HD-2117072
                    $sqlLinha = "SELECT tbl_produto.linha
                                    FROM tbl_produto
                                    JOIN tbl_os ON tbl_os.produto = tbl_produto.produto
                                    WHERE tbl_os.os = $os";
                    $resLinha = pg_query($con, $sqlLinha);

                    if(pg_num_rows($resLinha) > 0){
                        $id_linha = pg_fetch_result($resLinha, 0, 'linha');
                    }

                    if($xservico == 692 AND $id_linha == 623){
                        $sql =" INSERT INTO
                            tbl_os_status(
                                os,
                                status_os,
                                observacao,
                                fabrica_status
                            )VALUES(
                                $os,
                                199,
                                'Intervenção referente ao Serviço: RECARGA DE GÁS',
                                $login_fabrica
                            )";
                        $res = pg_query($con, $sql);
                    }
                }

                if($login_fabrica == 131){ ### HD-2181938 / MONTEIRO ###

                    $sql_gera_pedido = "SELECT
                                    tbl_servico_realizado.servico_realizado
                                    FROM tbl_servico_realizado
                                    WHERE servico_realizado = $xservico
                                    AND gera_pedido is true
                                    AND fabrica = $login_fabrica";

                    $res_gera_pedido = pg_query($con, $sql_gera_pedido);

                    if(pg_num_rows($res_gera_pedido) > 0){
                        $auditoria_os_pressure = 'true';
                        // Estava colocando em auditoria para cada peça.

                        // $sql =" INSERT INTO
                        //     tbl_os_status(
                        //         os,
                        //         status_os,
                        //         observacao,
                        //         fabrica_status
                        //     )VALUES(
                        //         $os,
                        //         205,
                        //         'Aguardando aprovação para gerar pedido',
                        //         $login_fabrica
                        //     )";
                        // $res = pg_query($con, $sql);
                    }
                }
            }

            if (!empty($xservico)) {//HD 384011
                //AND peca_estoque IS TRUE
                $sql_servico  = "SELECT peca_estoque, troca_de_peca FROM tbl_servico_realizado WHERE servico_realizado = $xservico AND fabrica = $login_fabrica ;";
                $res_servico  = @pg_query($sql_servico);
                $serv_estoque = pg_result($res_servico, 0, 'peca_estoque');
                $troca_peca = pg_fetch_result($res_servico, 0, troca_de_peca);
            } else {

                $serv_estoque = 'f';
            }

            /*(HD 159888 - esmaltec) (HD 384011 - atlas) controle de estoque - Verifica estoque antes de salvar*/
            $controla_saldo = 't';

            if(in_array($login_fabrica,array(74)) and !empty($xpeca)){
                $sqlSaldo = "SELECT controla_saldo FROM tbl_peca WHERE referencia = '$xpeca' AND fabrica = $login_fabrica";
                $resSaldo = pg_query($con,$sqlSaldo);
                $controla_saldo = pg_fetch_result($resSaldo, 0, 'controla_saldo');
            }

        if (in_array($login_fabrica,array(3)) && empty($msg_erro) && strlen($xpeca) > 0 && $controla_estoque == 't' && $serv_estoque == 't' && $controla_saldo == 't') {

                $qtde_total_estoque = 0;

                $sql_peca = "SELECT peca
                            FROM tbl_peca
                            where referencia='$xpeca'
                            and fabrica=$login_fabrica;";

                $res_peca = pg_query($con,$sql_peca);

                if (pg_num_rows($res_peca)) {

                    $peca_estoque = pg_result($res_peca,0,'peca');

                    $sqlAN = "SELECT SUM(qtde) AS qtde
                                FROM tbl_estoque_posto
                                WHERE posto = $login_posto
                                AND peca    = $peca_estoque
                                AND fabrica = $login_fabrica ";
                    $resAN = pg_exec($con, $sqlAN);

                    if (pg_numrows($resAN) > 0) {
                        $qtde_total_estoque  = pg_result($resAN,0,'qtde');
                    }

                        if ($login_fabrica != 3){

                            if ($qtde_total_estoque < $xqtde) {
                                if($login_fabrica == 74){
                                    $msg_erro = "Peça $xpeca não possui saldo no estoque, favor trocar o serviço da peça<br />";
                                }else{
                                    $msg_erro = "Não tem saldo da peça $xpeca, favor efetuar o pedido de compra desta peça para que você possa lançar na O.S.<br />";
                                }
                            }

                        }else{

                            $sql_LB = "
                                        SELECT
                                        tbl_lista_basica.qtde
                                        FROM tbl_lista_basica

                                        JOIN tbl_produto on (tbl_lista_basica.produto = tbl_produto.produto)
                                        JOIN tbl_peca on (tbl_lista_basica.peca = tbl_peca.peca)
                                        WHERE  tbl_produto.referencia = '$xproduto'
                                        AND    tbl_lista_basica.fabrica = $login_fabrica
                                        AND    tbl_peca.referencia = '$xpeca'
                                        ";
                            $res_LB = pg_query($con, $sql_LB);
                            if(pg_numrows($res_LB)>0){
                                $qtde_LB  = pg_result($res_LB,0,'qtde');

                            }

                            if ( $qtde_total_estoque < $qtde_LB && $xservico == 43){
                                $msg_erro = "Quantidade inserida para a peça $xpeca é maior do que o estoque interno <br />";
                            }

                        }

                } else {

                    $msg_erro = 'Peça não encontrada! <br />';

                }

            }

            if(in_array($login_fabrica, array(24)) AND !empty($xpeca)){
                //validar o Defeito
                if(intval($xdefeito) == 0){
                    $msg_erro = "Favor informar o defeito da peça";
                }
            }

            /*HD 159888 - FIM*/
            /* HD 202030 - dupla verificação javascript e php -Samuel 2010-02-03*/
            if (($login_fabrica == 50 or $login_fabrica == 91 )and strlen($xdefeito) > 0 and strlen($xpeca) > 0 and strlen($xkit_peca)==0 ) {

                $sqlD = "SELECT     tbl_defeito.descricao                   ,
                                tbl_defeito.defeito                     ,
                                tbl_defeito.codigo_defeito              ,
                                tbl_peca_defeito.ativo
                        FROM  tbl_peca_defeito
                        JOIN  tbl_defeito using(defeito)
                        JOIN  tbl_peca on tbl_peca.peca = tbl_peca_defeito.peca
                        AND   tbl_peca.fabrica = $login_fabrica
                        AND   tbl_peca.referencia = '$xpeca'
                        WHERE tbl_peca_defeito.ativo = 't'
                        AND   tbl_defeito.ativo = 't'
                        AND   tbl_defeito.defeito = $xdefeito";

                $resD = pg_query($con,$sqlD);
                if (pg_num_rows($resD) == 0) {
                    if($login_fabrica == 50  or $login_fabrica == 91){
                        $msg_erro .= "Sem Defeitos Cadastrados para a peça {$xpeca_ref}, Contate o Fabricante!";
                    }else{
                        $msg_erro .= "Você deve escolher o defeito da Peça novamente!";
                    }
                }

            }

            //HD 107982 2009-07-20
            if ($login_fabrica == 24) {

                if ($xreparo_estoque=="peca_reposicao_estoque") {
                    $xpeca_reposicao_estoque = "'t'";
                } else {
                    $xpeca_reposicao_estoque = "'f'";
                }

                if ($xreparo_estoque == "aguardando_peca_reparo") {
                    $xaguardando_peca_reparo = "'t'";
                } else {
                    $xaguardando_peca_reparo = "'f'";
                }

                // HD 170216
                if ($xservico == '504' and $xaguardando_peca_reparo == "'f'" and $xpeca_reposicao_estoque == "'f'") {
                    $msg_erro.= "Para este serviço, é obrigado selecionar se é Repor Estoque ou Aguardando peça para reparo";
                }

            } else {

                $xpeca_reposicao_estoque = "'f'";
                $xaguardando_peca_reparo = "'f'";

            }

            $xpreco_orcamento = $_POST['preco_orcamento_' . $i];
            $xpreco_orcamento = (empty($xpreco_orcamento)) ? "null" : $xpreco_orcamento;

            $xpreco_venda_orcamento = $_POST['preco_venda_orcamento_' . $i];
            $xpreco_venda_orcamento = $xpreco_venda_orcamento;

            $xpreco_orcamento = str_replace ("," , "." ,$xpreco_orcamento);

            $xpreco_venda_orcamento = str_replace ("," , "." ,$xpreco_venda_orcamento);

            if ($xservico <> 643 AND $xservico<> 644 AND $xservico <> 4247 AND $xservico <> 4289){
                $xpreco_orcamento = "null";
            }

            /*IGOR - hd: 45924 13/10/2008*/
            if ($login_fabrica <> 50) {
                $xpeca    = $xpeca;
            }

            $xserie = (strlen($xserie) == 0) ? 'null' : "'".$xserie."'";

            // HD 101357 - desbloqueada
            if ($informatica == 't' and strlen($xpeca)> 0 AND $login_fabrica != 127) {

                $sql_x = "SELECT numero_serie_peca from tbl_peca where referencia = '$xpeca' and fabrica = $login_fabrica;";

                $res_x = pg_query($con, $sql_x);
                $testa_numero_serie_peca = pg_fetch_result($res_x, 0, 'numero_serie_peca');

                if ($testa_numero_serie_peca <> 't') {

                    if (strlen($xpeca_serie) == 0) $msg_erro .= "";
                    else                           $xpeca_serie = "'" . $xpeca_serie . "'";

                } else {
                    if (strlen($xpeca_serie) == 0) $msg_erro .= "É necessário informar a Série da Peça para linha de Informática.";
                    else                           $xpeca_serie = "'" . $xpeca_serie . "'";

                    if($login_fabrica == 3 and strlen($msg_erro ) == 0 ){
                        $sql = "SELECT numero_serie_peca
                                FROM tbl_numero_serie_peca
                                WHERE fabrica = $login_fabrica and
                                    serie_peca = $xpeca_serie ;";
                        $res = pg_query($con,$sql);
                        if (pg_num_rows($res) > 0) {
                        }else{
                            $msg_erro .= "É necessário informar a Série da Peça Válido para linha de Informática.";
                        }
                    }
                }
            }else{
                $xpeca_serie = (strlen($xpeca_serie) == 0)?'null':"'".$xpeca_serie."'";
            }

            if ($xpeca_serie == '') $xpeca_serie = 'NULL';

            $xpeca_serie_trocada= (strlen($xpeca_serie_trocada) == 0)?'null':"'".$xpeca_serie_trocada."'";
            $xposicao            = (strlen($xposicao) == 0) ? 'null' : "'".$xposicao."'";

            $xadmin_peca      = $_POST["admin_peca_"     . $i];
            if (strlen($xadmin_peca)==0) $xadmin_peca ="null";
            if ($xadmin_peca == "P") $xadmin_peca ="null";

            if ((strlen($xos_produto) > 0 or strlen($xorcamento_item)>0) AND strlen($xpeca) == 0) {

                if (strlen($xos_produto) > 0) {
                    $antesDel = '';
                    // if (in_array($login_fabrica, $fabricas_auditor)){
                    //         //Informações para o Auditor
                    //         $sqlAntesDel = "SELECT os_produto, posicao, peca, qtde, defeito, causa_defeito, servico_realizado, admin, peca_causadora, parametros_adicionais,peca_obrigatoria, fornecedor
                    //                 FROM tbl_os_item WHERE os_produto = $xos_produto";
                    //         $resAntesDel = pg_query($con,$sqlAntesDel);
                    //         $rowAntesDel    = pg_fetch_all($resAntesDel);

                    // }

                    $sql = "DELETE FROM tbl_os_produto
                            WHERE  tbl_os_produto.os         = $os
                            AND    tbl_os_produto.os_produto = $xos_produto";

                    #HD 15489
                    $sql = "UPDATE tbl_os_produto SET
                                os = 4836000
                            WHERE os         = $os
                            AND   os_produto = $xos_produto";

                    $res = pg_query($con,$sql);
                    $msg_erro .= pg_errormessage($con);

                    if (!pg_last_error()) {
                        // if (in_array($login_fabrica, $fabricas_auditor)){
                        //     if (pg_num_rows($resAntesDel) > 1) {

                        //         foreach ($rowAntesDel as $keyAntes => $valueAntes) {
                        //             $antesDel = array(
                        //                 "os_produto" => $valueAntes['os_produto'],
                        //                 "posicao" => $valueAntes['posicao'],
                        //                 "peca" => $valueAntes['peca'],
                        //                 "qtde" => $valueAntes['qtde'],
                        //                 "defeito" =>  $valueAntes['defeito'],
                        //                 "causa_defeito" => $valueAntes['causa_defeito'],
                        //                 "servico_realizado" =>  $valueAntes['servico_realizado'],
                        //                 "admin" => $valueAntes['admin'],
                        //                 "peca_causadora" =>  $valueAntes['peca_causadora'],
                        //                 "parametros_adicionais" => $valueAntes['parametros_adicionais'],
                        //                 "peca_obrigatoria" => $valueAntes['peca_obrigatoria'],
                        //                 "fornecedor" => $valueAntes['fornecedor']
                        //             );
                        //             $auditorLogSavedDelete["ANTES"][$keyAntes] = $antesDel;
                        //             $auditorLogSavedDelete["OS"][$keyAntes] = $os;
                        //             $auditorLogSavedDelete["DELETE"][$keyAntes] = array(
                        //                 "os_produto" => '',
                        //                 "posicao" => '',
                        //                 "peca" => '',
                        //                 "qtde" => '',
                        //                 "defeito" =>  '',
                        //                 "causa_defeito" => '',
                        //                 "servico_realizado" =>  '',
                        //                 "admin" => '',
                        //                 "peca_causadora" =>  '',
                        //                 "parametros_adicionais" => '',
                        //                 "peca_obrigatoria" => '',
                        //                 "fornecedor" => ''
                        //             );
                        //         }
                        //     } else {
                        //         $rowAntesDel2    = pg_fetch_array($resAntesDel);
                        //         $antesDel2 = array(
                        //                 "os_produto" => $rowAntesDel2['os_produto'],
                        //                 "posicao" => $rowAntesDel2['posicao'],
                        //                 "peca" => $rowAntesDel2['peca'],
                        //                 "qtde" => $rowAntesDel2['qtde'],
                        //                 "defeito" =>  $rowAntesDel2['defeito'],
                        //                 "causa_defeito" => $rowAntesDel2['causa_defeito'],
                        //                 "servico_realizado" =>  $rowAntesDel2['servico_realizado'],
                        //                 "admin" => $rowAntesDel2['admin'],
                        //                 "peca_causadora" =>  $rowAntesDel2['peca_causadora'],
                        //                 "parametros_adicionais" => $rowAntesDel2['parametros_adicionais'],
                        //                 "peca_obrigatoria" => $rowAntesDel2['peca_obrigatoria'],
                        //                 "fornecedor" => $rowAntesDel2['fornecedor']
                        //             );
                        //         $auditorLogSavedDelete["ANTES"][] = $antesDel2;
                        //         $auditorLogSavedDelete["OS"][] = $os;
                        //         $auditorLogSavedDelete["DELETE"][] = array(
                        //             "os_produto" => '',
                        //             "posicao" => '',
                        //             "peca" => '',
                        //             "qtde" => '',
                        //             "defeito" =>  '',
                        //             "causa_defeito" => '',
                        //             "servico_realizado" =>  '',
                        //             "admin" => '',
                        //             "peca_causadora" =>  '',
                        //             "parametros_adicionais" => '',
                        //             "peca_obrigatoria" => '',
                        //             "fornecedor" => ''
                        //         );
                        //     }
                        // }
                    }

                    if($login_fabrica == 30 && strlen($msg_erro) == 0){
                        $sqlProcura = "
                            SELECT  tbl_peca.referencia || ' - ' || tbl_peca.descricao AS peca_interacao
                            FROM    tbl_peca
                            JOIN    tbl_os_item USING (peca)
                            JOIN    tbl_os_produto USING (os_produto)
                            WHERE   tbl_os_produto.os_produto = $xos_produto
                        ";

                        $resProcura = pg_query($con,$sqlProcura);
                        $peca_interacao = pg_fetch_result($resProcura,0,peca_interacao);

                        $sql = "
                            INSERT INTO tbl_os_interacao (
                                programa,
                                os,
                                data,
                                comentario,
                                interno,
                                posto
                            ) VALUES (
                                '$programa_insert',
                                $os,
                                CURRENT_TIMESTAMP,
                                'A peça $peca_interacao foi retirada da OS',
                                TRUE,
                                $login_posto
                            );
                        ";
                        $res = pg_query($con,$sql);
                    }
                }

                if (strlen($orcamento) > 0 AND strlen($xorcamento_item) > 0) {

                    $sql = "DELETE FROM tbl_orcamento_item WHERE  orcamento_item = $xorcamento_item AND orcamento = $orcamento";
                    $res = pg_query($con,$sql);

                    $msg_erro .= pg_errormessage($con);

                    $query = "UPDATE tbl_orcamento SET
                                total_pecas     = (SELECT SUM(preco*qtde)
                                                FROM tbl_orcamento_item
                                                WHERE orcamento = $orcamento),
                                total_pecas_venda = (SELECT SUM(preco_venda*qtde)
                                                FROM tbl_orcamento_item
                                                WHERE orcamento = $orcamento)
                            WHERE orcamento = $orcamento
                            AND empresa = $login_fabrica";

                    $orca = pg_query($con, $query);
                    $msg_erro .= pg_errormessage($con);

                }

            } else {

                if ($login_fabrica == 3 && strlen($xpeca) > 0) {

                    $sqlX = "SELECT referencia, TO_CHAR (previsao_entrega,'DD/MM/YYYY') AS previsao
                             FROM tbl_peca
                             WHERE UPPER(referencia_pesquisa) = UPPER('$xpeca')
                             AND   fabrica = $login_fabrica
                             AND   previsao_entrega > date(current_date + INTERVAL '20 days');";

                    $resX = pg_query($con,$sqlX);

                    if (pg_num_rows($resX) > 0) {

                        $peca_previsao = pg_fetch_result($resX, 0, 'referencia');
                        $previsao      = pg_fetch_result($resX, 0, 'previsao');

                        $msg_previsao  = "O pedido da peça $peca_previsao foi efetivado. A previsão de disponibilidade desta peça será em $previsao. A fábrica tomará as medidas necessárias par o atendimento ao consumidor.";

                    }

                }

                if (strlen($xpeca) > 0 and strlen($msg_erro) == 0) {

                    $xpeca = strtoupper($xpeca);

                    $sqlI = "SELECT tbl_fabrica.pergunta_qtde_os_item
                             FROM tbl_fabrica
                             WHERE tbl_fabrica.fabrica = $login_fabrica
                             AND   tbl_fabrica.pergunta_qtde_os_item IS TRUE";

                    $resI  = pg_exec($con, $sqlI);

                    if (pg_numrows($resI) > 0) {

                        if ((int)$xqtde<1 && !empty($xpeca) && $login_fabrica <> 140) {
                            $msg_erro = "Informe a quantidade para a peça $xpeca";
                        }

                    } else {

                        if (strlen($xqtde) == 0) $xqtde = "1";

                    }

                    if($login_fabrica == 140){
                        $xqtde = str_replace(",", ".", $xqtde);
                    }

                    if ($login_fabrica == 1 && intval($xqtde) == 0) $msg_erro .= " O item $xpeca está sem quantidade, por gentileza informe a quantidade para este item. ";

                    #HD 13618
                    if ($login_fabrica==45 and $troca_obrigatoria == 't'){
                        $msg_erro .= " Este produto é de Troca e não é fornecido peças para reparo.";
                        break;
                    }

                    if (strlen($xproduto) == 0) {

                        $sql = "SELECT tbl_os.produto
                                FROM   tbl_os
                                WHERE  tbl_os.os      = $os
                                AND    tbl_os.fabrica = $login_fabrica;";

                        $res = pg_query($con,$sql);

                        if (pg_num_rows($res) > 0) {
                            $xproduto = pg_fetch_result($res,0,0);
                        }

                    } else {

                        $sql = "SELECT tbl_os.produto
                            FROM   tbl_os
                            JOIN   tbl_produto USING(produto)
                            WHERE  tbl_os.os      = $os
                            AND    tbl_os.fabrica = $login_fabrica ";

                        if ($login_fabrica == 94 and $posto_interno == true) {
                            $sql .= " AND tbl_produto.uso_interno_ativo IS TRUE ";
                        }else{
                            $sql .= " AND tbl_produto.ativo IS TRUE ";
                        }

                        $res = pg_query($con,$sql);

                        if (pg_num_rows($res) == 0) {
                            $msg_erro .= "Produto $xproduto não cadastrado";
                            $linha_erro = $i;
                        } else {
                            $xproduto = pg_fetch_result($res,0,produto);
                        }

                    }

                    if (strlen($msg_erro) == 0) {

                        #peças para Orçamento
                        # $os_revenda_item > 0 quando a OS for de revenda
                        if (in_array($login_fabrica,array(3,24,45)) AND in_array($xservico,array(643,644,4247,4289))) {

                            $gravou_pecas_orcamento = "sim";

                            # Apaga caso exista algum item que não é orçamento
                            if (strlen($xos_produto) > 0){
                                $sql = "DELETE FROM tbl_os_produto
                                        WHERE  tbl_os_produto.os         = $os
                                        AND    tbl_os_produto.os_produto = $xos_produto";
                                #HD 15489
                                $sql = "UPDATE tbl_os_produto SET
                                            os = 4836000
                                        WHERE os         = $os
                                        AND   os_produto = $xos_produto";
                                $res = pg_query($con,$sql);
                                $msg_erro .= pg_errormessage($con);

                                // if (!pg_last_error()) {
                                //     if(in_array($login_fabrica, $fabricas_auditor)){
                                //         $sqls = "SELECT os_produto, posicao, peca, qtde, defeito, causa_defeito, servico_realizado, admin,
                                //                 peca_serie, peca_serie_trocada, peca_reposicao_estoque,parametros_adicionais, peca_obrigatoria, fornecedor
                                //         FROM tbl_os_item
                                //         WHERE os_item = $xos_item";

                                //         $ress = pg_query($con,$sqls);
                                //         $ress = pg_fetch_all($ress);
                                //         $antes = $ress[0];
                                //         auditorLog($os,$antes,array(
                                //             "os_produto" => '',
                                //             "posicao" => '',
                                //             "peca" => '',
                                //             "qtde" => '',
                                //             "defeito" =>  '',
                                //             "causa_defeito" => '',
                                //             "servico_realizado" =>  '',
                                //             "admin" => '',
                                //             "peca_causadora" =>  '',
                                //             "parametros_adicionais" => '',
                                //             "peca_obrigatoria" => '',
                                //             "fornecedor" => ''
                                //         ), 'tbl_os_item', '/os_item.php', "DELETE");

                                //     }
                                // }
                            }

                            if (strlen($orcamento)==0){
                                $query = "INSERT INTO tbl_orcamento (empresa,os) VALUES ($login_fabrica,$os)";
                                $orca = pg_query($con, $query);
                                $msg_erro .= pg_errormessage($con);
                                $query = "SELECT currval('tbl_orcamento_orcamento_seq') AS orcamento";
                                $orca = pg_query($con, $query);
                                $orcamento = pg_fetch_result($orca,0,orcamento);
                            }

                            if (strlen($orcamento)==0){
                                $msg_erro .= "Erro ao criar o orçamento. Tente novamente ou contate o Suporte Telecontrol através do e-mail: suportetelecontrol.com.br";
                            }
                            //HD 21425 não pode gravar produto acabado
                            $sql = "SELECT tbl_peca.*
                                    FROM   tbl_peca
                                    WHERE  (UPPER(tbl_peca.referencia_pesquisa) = UPPER('$xpeca')
                                            OR UPPER(tbl_peca.referencia) = UPPER('$xpeca'))
                                    AND    tbl_peca.fabrica = $login_fabrica
                                    AND    tbl_peca.produto_acabado IS NOT TRUE;";

                            $res = pg_query($con, $sql);

                            if (pg_num_rows($res) == 0) {

                                $msg_erro .= "Peça $xpeca não cadastrada-";
                                $linha_erro = $i;

                            } else {
                                $xpeca = pg_fetch_result($res, 0, 'peca');
                            }

                            if (strlen($xdefeito) == 0 and !in_array($login_fabrica, array(95,96,81,98,114))) {
                                $msg_erro .= "Favor informar o defeito da peça<br />"; #$defeito = "null";
                            }

                            if (strlen($xservico) == 0) {
                                $msg_erro .= "Favor informar o serviço realizado<br />"; #$servico = "null";
                            }

                            if (strlen($xpcausa_defeito) == 0) {
                                $xpcausa_defeito = 'null';
                            }

                            if (strlen($msg_erro) == 0) {

                                if (strlen($xorcamento_item) == 0) {

                                    $query = "INSERT INTO tbl_orcamento_item
                                    (orcamento,peca,defeito,servico_realizado,preco,qtde,preco_venda)
                                    VALUES ($orcamento,$xpeca,$xdefeito,$xservico,$xpreco_orcamento,$xqtde,$xpreco_venda_orcamento)";

                                    $orca      = pg_query($con, $query);
                                    $msg_erro .= pg_errormessage($con);

                                } else {

                                    $query = "UPDATE tbl_orcamento_item SET
                                                peca              = $xpeca,
                                                defeito           = $xdefeito,
                                                servico_realizado = $xservico,
                                                preco             = $xpreco_orcamento,
                                                preco_venda       = $xpreco_venda_orcamento,
                                                qtde              = $xqtde
                                            WHERE orcamento = $orcamento
                                            AND orcamento_item = $xorcamento_item";

                                    $orca = pg_query($con, $query);
                                    $msg_erro .= pg_errormessage($con);

                                }

                                $query = "UPDATE tbl_orcamento SET
                                            total_pecas = (    SELECT
                                                        SUM(preco*qtde)
                                                        FROM tbl_orcamento_item
                                                        WHERE orcamento = $orcamento
                                                    )
                                        WHERE orcamento = $orcamento
                                        AND empresa = $login_fabrica";

                                $orca = pg_query($con, $query);
                                $msg_erro .= pg_errormessage($con);

                            }

                        } else {

                            /**
                            * HD 955406
                            * Verificação dos itens da OS.
                            * Se existir algum item na OS com peça "somente_kit",
                            * deverá verificar a váriavel $xkit_peca, se não existir essa váriavel deste item,
                            * é por que o usuário não clicou na lupa e está tentando burlar...
                            * Se não achar, deverá retornar erro
                            */
                            if (in_array($login_fabrica,array(3,15,24,30,91))) {
                                $xsqlKitPeca = "SELECT tbl_lista_basica.somente_kit
                                        FROM tbl_peca
                                        JOIN tbl_lista_basica on tbl_peca.peca = tbl_lista_basica.peca and tbl_lista_basica.produto = $xproduto
                                        JOIN tbl_kit_peca_peca  on tbl_peca.peca = tbl_kit_peca_peca.peca
                                        JOIN tbl_kit_peca_produto on tbl_lista_basica.produto = tbl_kit_peca_produto.produto and tbl_kit_peca_produto.produto = $xproduto
                                        JOIN tbl_kit_peca ON tbl_kit_peca.kit_peca = tbl_kit_peca_produto.kit_peca
                                        WHERE tbl_peca.referencia = '".$xpeca."'
                                        AND tbl_peca.fabrica = $login_fabrica
                                        AND tbl_lista_basica.fabrica = $login_fabrica
                                        ";
                                $xresKitPeca = pg_query($con,$xsqlKitPeca);
                                $resultKitPeca = pg_fetch_result($xresKitPeca, 0, 0);

                                if($login_fabrica == 15){ //hd_chamado=2552862
                                    $sqlLatina = "SELECT tbl_kit_peca.referencia,
                                                   tbl_kit_peca.descricao,
                                                   tbl_kit_peca.kit_peca,
                                                   tbl_kit_peca_produto.serie_inicial,
                                                   tbl_kit_peca_produto.serie_final
                                                FROM tbl_kit_peca
                                                JOIN tbl_kit_peca_produto ON tbl_kit_peca_produto.kit_peca = tbl_kit_peca.kit_peca
                                                WHERE tbl_kit_peca.fabrica = $login_fabrica
                                                AND tbl_kit_peca_produto.produto = $xproduto";
                                    $resLatina = pg_query($con, $sqlLatina);

                                    $serie_produto = $_POST['produto_serie'];

                                    if(pg_num_rows($resLatina) > 0){
                                        for ($p=0; $p < pg_num_rows($resLatina); $p++) {
                                            $serie_in = pg_fetch_result($resLatina, $p, 'serie_inicial');
                                            $serie_out = pg_fetch_result($resLatina, $p, 'serie_final');

                                            if (!valida_kit_latinatec($serie_produto,$serie_in,$serie_out)) {
                                                $resultKitPeca = 'f';
                                            }
                                        }
                                    }
                                }
                                if (strlen($xkit_peca) == 0) {

                                    if ($resultKitPeca == 't') {
                                        # verifica se a peça do post ja foi gravada
                                        $verificaPecaGravada = "SELECT count(tbl_os_item.peca) as qtde_item_os,
                                                                       tbl_lista_basica.qtde as qtde_permitida
                                                                FROM tbl_os_item
                                                                JOIN tbl_os_produto using(os_produto)
                                                                JOIN tbl_os using(os)
                                                                JOIN tbl_peca using(peca)
                                                                JOIN tbl_lista_basica on tbl_os_produto.produto = tbl_lista_basica.produto AND
                                                                     tbl_peca.peca = tbl_lista_basica.peca where os = {$os} AND
                                                                     tbl_os.fabrica = {$login_fabrica} AND tbl_peca.referencia = '{$xpeca}'
                                                               GROUP by tbl_lista_basica.qtde ";
                                        $resVerificaPecaGravada = pg_query($verificaPecaGravada);

                                        if(pg_num_rows($resVerificaPecaGravada) > 0){
                                            $qtd_item_os = pg_fetch_result($resVerificaPecaGravada,0,"qtde_item_os");
                                            $qtd_permitida = pg_fetch_result($resVerificaPecaGravada,0,"qtde_permitida");

                                            if($qtd_item_os != $qtd_permitida){
                                                $msg_erro = "Existem peças obrigatórias de kit lançados na OS fora do KIT, por favor utilize a lupa. Referência: $xpeca";
                                            }

                                        }else{

                                            $msg_erro = "Existem peças obrigatórias de kit lançados na OS fora do KIT, por favor utilize a lupa. Referência: $xpeca";
                                        }

                                    }

                                }

                            }

                            if ((in_array($login_fabrica,array(3,15,24,30,91))) and strlen($xkit_peca) > 0 and empty($msg_erro) and !pg_num_rows($xresKitPeca)) {//HD 258901
                                if ($login_fabrica != 91) {
                                    if (strlen($xdefeito) == 0) $msg_erro .= "Favor informar o defeito da peça<br />";
                                    if (strlen($xservico) == 0) $msg_erro .= "Favor informar o serviço realizado<br />";
                                }

                                if (strlen($xos_produto) >  0) {

                                    $sql = "UPDATE tbl_os_produto SET
                                                os = 4836000
                                            WHERE os         = $os
                                            AND   os_produto = $xos_produto";

                                    $res = pg_query($con, $sql);
                                    if (pg_last_error()) {
                                        $msg_erro .= pg_errormessage($con);
                                    }

                                    // if (!pg_last_error()) {
                                    //     if(in_array($login_fabrica, $fabricas_auditor)){
                                    //         $sqls = "SELECT os_produto, posicao, peca, qtde, defeito, causa_defeito, servico_realizado, admin,
                                    //                 peca_serie, peca_serie_trocada, peca_reposicao_estoque,parametros_adicionais, peca_obrigatoria, fornecedor
                                    //         FROM tbl_os_item
                                    //         WHERE os_item = $xos_item";

                                    //         $ress = pg_query($con,$sqls);
                                    //         $ress = pg_fetch_all($ress);
                                    //         $antes = $ress[0];
                                    //         auditorLog($os,$antes,array(
                                    //             "os_produto" => '',
                                    //             "posicao" => '',
                                    //             "peca" => '',
                                    //             "qtde" => '',
                                    //             "defeito" =>  '',
                                    //             "causa_defeito" => '',
                                    //             "servico_realizado" =>  '',
                                    //             "admin" => '',
                                    //             "peca_causadora" =>  '',
                                    //             "parametros_adicionais" => '',
                                    //             "peca_obrigatoria" => '',
                                    //             "fornecedor" => ''
                                    //         ), 'tbl_os_item', '/os_item.php', "DELETE");
                                    //     }
                                    // }

                                }

                                if (strlen($msg_erro) == 0) {

                                    $sqlPecaKit = "
                                        SELECT  tbl_peca.peca       ,
                                                tbl_peca.referencia ,
                                                tbl_peca.descricao
                                        FROM    tbl_kit_peca_peca
                                        JOIN    tbl_peca USING(peca)
                                        WHERE   tbl_peca.fabrica            = $login_fabrica
                                        AND     tbl_kit_peca_peca.kit_peca  = $xkit_peca
                                  ORDER BY      tbl_peca.peca
                                    ";

                                    $resPecaKit = pg_query($con, $sqlPecaKit);

                                    if (pg_num_rows($resPecaKit) > 0) {

                                        $sqlx = "INSERT INTO tbl_os_produto (
                                                        os     ,
                                                        produto,
                                                        serie
                                                    )VALUES(
                                                        $os     ,
                                                        $xproduto,
                                                        $xserie
                                                );";

                                        $resx      = pg_query($con, $sqlx);
                                        if (pg_last_error()) {
                                            $msg_erro .= pg_errormessage($con);
                                        }

                                        $resx        = pg_query($con, "SELECT CURRVAL('seq_os_produto')");
                                        $xos_produto = pg_fetch_result($resx,0,0);

                                        for ($xx = 0; $xx < pg_num_rows($resPecaKit); $xx++) {

                                            $xxpeca             = pg_fetch_result($resPecaKit, $xx, peca);
                                            $pecaKitRef[$xx]    = pg_fetch_result($resPecaKit, $xx, referencia);
                                            $pecaKitDesc[$xx]   = pg_fetch_result($resPecaKit, $xx, descricao);

                                            $kit_peca_peca = $_POST['kit_peca_'.$xxpeca];
                                            $kit_peca_qtde = $_POST['kit_peca_qtde_'.$xxpeca];

                                            if($login_fabrica == 125){
                                                $sql = "SELECT devolucao_obrigatoria
                                                        FROM tbl_peca_servico
                                                        INNER JOIN tbl_peca ON tbl_peca_servico.peca = tbl_peca.peca
                                                        WHERE tbl_peca.peca = $xxpeca AND tbl_peca.fabrica = $login_fabrica and tbl_peca_servico.servico_realizado = 10740 ";
                                            }else{
                                                $sql = "SELECT devolucao_obrigatoria from tbl_peca WHERE peca = $xxpeca AND fabrica = $login_fabrica";
                                            }
                                            $res = pg_query($con,$sql);
                                            $devolucao_obrigatoria = pg_fetch_result($res, 0, 'devolucao_obrigatoria');
                                            $devolucao_obrigatoria = ($devolucao_obrigatoria == "t" AND $troca_peca == 't') ? $devolucao_obrigatoria : "f";

                                            if (strlen($kit_peca_peca) > 0) {

                                                if (in_array($login_fabrica,array(3,30,91))) {
                                                    $pa = array("kit_peca" => $xkit_peca);
                                                    $paLog = "kit_peca : $xkit_peca";
                                                    $pa = json_encode($pa);

                                                    $insertColumn = ", parametros_adicionais";
                                                    $insertValue  = ", '$pa'";
                                                }
                                                if($login_fabrica==91){

                                                    $kit_fornecedor = $_POST['kit_fornecedor_'.$xxpeca];
                                                    $kit_defeito    = $_POST['kit_defeito_'.$xxpeca];
                                                    $xdefeito       = (empty($kit_defeito)) ? $xdefeito : $kit_defeito;
                                                    $xfornecedor    = (empty($kit_fornecedor)) ? $xfornecedor : $kit_fornecedor;

                                                     $sqly = "SELECT    tbl_defeito.descricao                   ,
                                                                        tbl_defeito.defeito                     ,
                                                                        tbl_defeito.codigo_defeito              ,
                                                                        tbl_peca_defeito.ativo
                                                                FROM  tbl_peca_defeito
                                                                JOIN  tbl_defeito using(defeito)
                                                                JOIN  tbl_peca on tbl_peca.peca = tbl_peca_defeito.peca
                                                                AND   tbl_peca.fabrica = $login_fabrica
                                                                AND   tbl_peca.peca = $xxpeca
                                                                WHERE tbl_peca_defeito.ativo = 't'
                                                                AND   tbl_defeito.ativo = 't'
                                                                AND   tbl_defeito.defeito = $xdefeito";

                                                    $resy = pg_query($con,$sqly);

                                                    if(pg_num_rows($res)==0){
                                                        $msg_erro .= "Sem Defeitos Cadastrados para esta peca, Contate o Fabricante!";
                                                    }
                                                }
                                                if (strlen($msg_erro)==0){
                                                    if($login_fabrica == 91){
                                                        $query_action = "INSERT";

                                                         $sqlx = "INSERT INTO tbl_os_item (
                                                                            os_produto            ,
                                                                            peca                  ,
                                                                            qtde                  ,
                                                                            defeito               ,
                                                                            peca_obrigatoria      ,
                                                                            fornecedor            ,
                                                                            liberacao_pedido      ,
                                                                            servico_realizado
                                                                            $insertColumn
                                                                        )VALUES(
                                                                            $xos_produto          ,
                                                                            $xxpeca               ,
                                                                            $kit_peca_qtde        ,
                                                                            $xdefeito             ,
                                                                            '$devolucao_obrigatoria',
                                                                            $xfornecedor          ,
                                                                            '$gera_pedido_posto',
                                                                            $xservico
                                                                            $insertValue
                                                                    );";

                                                            $resx      = pg_query($con,$sqlx);

                                                            if (pg_last_error()) {
                                                                $msg_erro .= pg_errormessage($con);
                                                            }
                                                            if (!pg_last_error()) {
                                                                if (in_array($login_fabrica, $fabricas_auditor)){
                                                                    $auditorLogSaved["ANTES_INSERT"][] = array(
                                                                                "os_produto" => '',
                                                                                "posicao" => '',
                                                                                "peca" => '',
                                                                                "qtde" => '',
                                                                                "defeito" =>  '',
                                                                                "causa_defeito" => '',
                                                                                "servico_realizado" =>  '',
                                                                                "admin" => '',
                                                                                "peca_causadora" =>  '',
                                                                                "parametros_adicionais" => '',
                                                                                "peca_obrigatoria" => '',
                                                                                "fornecedor" => '');
                                                                    $auditorLogSaved["OS"][] = $os;
                                                                    $auditorLogSaved["INSERT"][] = array(
                                                                                "os_produto" => $xos_produto,
                                                                                "posicao" => '',
                                                                                "peca" => $xxpeca,
                                                                                "qtde" => $kit_peca_qtde,
                                                                                "defeito" => $xdefeito,
                                                                                "causa_defeito" => '',
                                                                                "servico_realizado" => $xservico,
                                                                                "admin" => $xadmin_peca,
                                                                                "peca_causadora" => '',
                                                                                "parametros_adicionais" => $paLog,
                                                                                "peca_obrigatoria" => $devolucao_obrigatoria,
                                                                                "fornecedor" => $xfornecedor,
                                                                    );
                                                                }
                                                            }
                                                    }else{
                                                        for ($kit_n = 0; $kit_n < $kit_peca_qtde; $kit_n++) {
                                                            $sqlx = "INSERT INTO tbl_os_item (
                                                                            os_produto            ,
                                                                            peca                  ,
                                                                            qtde                  ,
                                                                            defeito               ,
                                                                            liberacao_pedido ,
                                                                            servico_realizado
                                                                            $insertColumn
                                                                        )VALUES(
                                                                            $xos_produto          ,
                                                                            $xxpeca               ,
                                                                            1                     ,
                                                                            $xdefeito             ,
                                                                            '$gera_pedido_posto',
                                                                            $xservico
                                                                            $insertValue
                                                                    );";

                                                            $resx      = pg_query($con,$sqlx);
                                                            if (pg_last_error()) {
                                                                $msg_erro .= pg_errormessage($con);
                                                            }

                                                        }

                                                        if($login_fabrica == 30){
                                                            $msg = "Foram adicionadas as peças na OS: <br />";
                                                            for ($xx = 0; $xx < pg_num_rows($resPecaKit); $xx++) {
                                                                $msg .= $pecaKitRef[$xx]." - ".$pecaKitDesc[$xx];
                                                            }

                                                            $sql = "
                                                                INSERT INTO tbl_os_interacao (
                                                                    programa,
                                                                    os,
                                                                    data,
                                                                    comentario,
                                                                    interno,
                                                                    posto
                                                                ) VALUES (
                                                                    '$programa_insert',
                                                                    $os,
                                                                    CURRENT_TIMESTAMP,
                                                                    '$msg',
                                                                    TRUE,
                                                                    $login_posto
                                                                );
                                                            ";
                                                            $res = pg_query($con,$sql);
                                                        }

                                                    }

                                                }

                                            }

                                        }

                                    }

                                }
                            } else {

                                if (strlen($xos_produto) == 0) {

                                    $sql = "INSERT INTO tbl_os_produto (
                                                os     ,
                                                produto,
                                                serie
                                            )VALUES(
                                                $os     ,
                                                $xproduto,
                                                $xserie
                                        );";

                                    $res = pg_query($con,$sql);
                                    if (pg_last_error()) {
                                        $msg_erro .= pg_errormessage($con);
                                    }

                                    $res         = pg_query($con, "SELECT CURRVAL('seq_os_produto')");
                                    $xos_produto = pg_fetch_result($res, 0, 0);

                                } else {

                                    $sql = "UPDATE tbl_os_produto SET
                                                os      = $os      ,
                                                produto = $xproduto,
                                                serie   = $xserie
                                            WHERE os_produto = $xos_produto;";

                                    $res = pg_query($con,$sql);
                                    if (pg_last_error()) {
                                        $msg_erro .= pg_errormessage($con);
                                    }

                                }   

                                // Delete Orçamento caso exista
                                if (strlen($xorcamento_item) > 0) {

                                    $sql = "DELETE FROM tbl_orcamento_item
                                            WHERE orcamento = $orcamento
                                            AND orcamento_item = $xorcamento_item";

                                    $res       = pg_query($con, $sql);
                                    if (pg_last_error()) {
                                        $msg_erro .= pg_errormessage($con);
                                    }

                                }

                                if (strlen($msg_erro) > 0) {

                                    continue ;

                                } else {

                                    $xpeca = strtoupper ($xpeca);

                                    if($login_fabrica == 134){
                                        if(!in_array('081', $defeitos_hidden)){
                                            $condProAcabado = " AND tbl_peca.produto_acabado IS NOT TRUE ";
                                        }else{
                                            $condProAcabado = "";
                                        }                                        
                                    }else{
                                        $condProAcabado = " AND tbl_peca.produto_acabado IS NOT TRUE ";
                                    }
                                    //HD 21425 não pode gravar produto acabado
                                    if (strlen($xpeca) > 0) {
                                        $sql = "SELECT tbl_peca.*
                                                  FROM tbl_peca
                                                 WHERE (UPPER(tbl_peca.referencia) = UPPER('$xpeca'))
                                                   AND tbl_peca.fabrica = $login_fabrica
                                                   $condProAcabado ;";

                                        if ($login_fabrica == 50 or $login_fabrica == 5 or $login_fabrica == 121) {
                                            /* hd: 45924 13/10/2008 */
                                            $sql = "SELECT tbl_peca.*
                                                      FROM tbl_peca
                                                     WHERE UPPER(tbl_peca.referencia) = UPPER('$xpeca')
                                                       AND tbl_peca.fabrica = $login_fabrica
                                                       AND tbl_peca.produto_acabado IS NOT TRUE;";

                                        }
                                        $res = pg_query($con,$sql);

                                        unset($aux_xpeca);

                                        if (pg_num_rows($res) == 0) {

                                            $msg_erro .= "Peça $xpeca não cadastrada";
                                            $linha_erro = $i;

                                        } else {

                                            $aux_xpeca = $xpeca;
                                            $xpeca                    = pg_fetch_result($res, 0, 'peca');
                                            $xdescricao               = pg_fetch_result($res, 0, 'descricao');
                                            $intervencao_fabrica_peca = pg_fetch_result($res, 0, 'retorna_conserto');
                                            $troca_obrigatoria_peca   = pg_fetch_result($res, 0, 'troca_obrigatoria');
                                            $bloqueada_garantia_peca  = pg_fetch_result($res, 0, 'bloqueada_garantia');
                                            $bloqueada_peca_critica   = pg_fetch_result($res, 0, 'peca_critica');
                                            $intervencao_carteira     = pg_fetch_result($res, 0, 'intervencao_carteira');
                                            $previsao_entrega_peca    = pg_fetch_result($res, 0, 'previsao_entrega');
                                            $gera_troca_produto       = pg_fetch_result($res, 0, 'gera_troca_produto');

                                            if($login_fabrica == 35 AND $bloqueada_garantia_peca == 't'){
                                                $msg_erro .= "A peça $xdescricao não é atendida na garantia.";
                                            }

                                            if ($gera_troca_produto == 't' AND $login_fabrica == 45) {

                                                $sql_intervencao = "SELECT status_os
                                                                      FROM tbl_os_status
                                                                     WHERE os = $os
                                                                       AND status_os IN (62,64,65)
                                                                     ORDER BY data DESC
                                                                     LIMIT 1";

                                                $res_intervencao = pg_query($con, $sql_intervencao);
                                                $status_os = "";

                                                if (pg_num_rows($res_intervencao) > 0){
                                                    $status_os = trim(pg_fetch_result($res_intervencao, 0, 'status_os'));
                                                }

                                                if (pg_num_rows($res_intervencao) == 0 or $status_os == "64") {

                                                    if ($gera_troca_produto == 't') {
                                                        $sql = "INSERT INTO tbl_os_status (os,status_os,data,observacao) values ($os,62,current_timestamp,'Foi lançada uma  peça nesta O.S., e é necessário que o produto seja trocado.')";
                                                        $res = pg_query($con,$sql);
                                                    }

                                                }

                                            }

                                        }

                                        if ($login_fabrica == 6) {//HD 3475

                                            if ($intervencao_fabrica_peca != 't' AND $xservico != "485") {

                                                $ssql = "SELECT (current_date - data_abertura) as dias from tbl_os where os=$os";
                                                $ress = pg_query($con, $ssql);

                                                if (pg_num_rows($ress) > 0) {

                                                    if (pg_fetch_result($ress,0,0) > 40) {
                                                        $msg_erro .= "PARA SOLICITAÇÃO DE PEÇA DESTA ORDEM DE SERVIÇO, FAVOR ENTRAR EM CONTATO COM O DEPTO. TÉCNICO - TEC TOY";
                                                   }

                                                }

                                            }

                                        }

                                        //HD-896985
                                        if($login_fabrica == 52){
                                            if(!empty($_POST['rg_tecnico'])){

                                                $sqlTecnico = "UPDATE tbl_os_extra SET tecnico = '".$_POST['nome_tecnico']."|".$_POST['rg_tecnico']."' WHERE os = ".$os." ";
                                                $res = pg_query($con,$sqlTecnico);
                                                $nome_tecnico = $_POST['nome_tecnico'];

                                            }else{
                                                $msg_erro .= "Você deve preencher os campos \"RG do técnico\" <br />";
                                                $nome_tecnico = $_POST['nome_tecnico'];
                                                $rg_tecnico = $_POST['rg_tecnico'];
                                            }

                                            if(!empty($_POST['nome_tecnico']) ){

                                                $sqlTecnico = "UPDATE tbl_os_extra SET tecnico = '".$_POST['nome_tecnico']."|".$_POST['rg_tecnico']."' WHERE os = ".$os." ";
                                                $res = pg_query($con,$sqlTecnico);
                                                $rg_tecnico = $_POST['rg_tecnico'];
                                            }else{
                                                $rg_tecnico = $_POST['rg_tecnico'];
                                                $nome_tecnico = $_POST['nome_tecnico'];
                                                $msg_erro .= "Você deve preencher os campos \"Nome do técnico\" <br />";
                                            }

                                        }

                                        $rg_tecnico = $_POST['rg_tecnico'];
                                        $nome_tecnico = $_POST['nome_tecnico'];

                                        if (strlen($xdefeito) == 0 and !in_array($login_fabrica,array(96,98)))
                                             $msg_erro .= "Favor informar o defeito da peça<br />"; #$defeito = "null";

                                        if (strlen($xservico) == 0 || intval($xservico) == 0)
                                            $msg_erro .= "Favor informar o serviço realizado<br />"; #$servico = "null";

                                        //if ($login_fabrica == 5 and strlen($xcausa_defeito) == 0) $msg_erro = "Selecione a causa do defeito.";
                                        //elseif (strlen($xcausa_defeito) == 0)                    $xcausa_defeito = 'null';

                                        if (strlen($xpcausa_defeito) == 0) $xpcausa_defeito = 'null';

                                        if (strlen($msg_erro) == 0) {

                                            if ( in_array($login_fabrica, array(11,172)) ) {

                                                $sql = "SELECT CURRENT_DATE - date(data_abertura) as dias
                                                          FROM tbl_os
                                                         WHERE tbl_os.os = $os";

                                                $res  = pg_query($con,$sql);
                                                $dias = pg_fetch_result($res,0,0);
                                                $existe_item = $_POST['existe_item'];

                                                if ($dias > 15 and $existe_item == 0 and $xservico == 61) {

                                                    echo "<script type='text/javascript'>
                                                    alert('ATENÇÃO \\nEste pedido de peças está sendo realizado a mais de 15 (quinze) dias após a data da abertura da OS.\\nEsclarecemos que os pedidos de peças em atraso acarretam o atraso no conserto do aparelho, e que pode acarretar prejuí­zo para a empresa decorrentes de reclamações no SAC ou PROCON.\\nPor fim, informamos que este pedido de peça em atraso foi cadastrado em nosso banco de dados e, caso a empresa venha a sofrer prejuízo por conta desta OS, em decorrência deste ato, o valor do  prejuízo poderá ser descontado de Vossa Senhoria.');
                                                    </script>";

                                                }

                                            }
                                            unset($makita_preco_bruto);
                                            if($login_fabrica == 42) {

                                                    $preco = "select referencia from tbl_peca where peca = $xpeca";
                                                    $preco_res = pg_query($con,$preco);
                                                    $ref_peca = pg_result($preco_res,0,0);
                                                    $ins_makita = ', preco';
                                                    $_GET['linha_form'] = $xx;
                                                    $_REQUEST['linha_form'] = $xx;
                                                    $_GET['condicao'] = '1159'; //condicao de pagamento a vista
                                                    $_GET['produto_referencia'] = $ref_peca;
                                                    $_GET['posto'] = $login_posto;
                                                    unset($makita_preco);
                                                    ob_start();
                                                    include('makita_valida_regras.php');
                                                    ob_get_clean();
                                                    $makita_preco_bruto = ', ' . round($makita_preco,2);
                                            }

                                            /* VERIFICA SE A PEÇA È DE DEVOLUÇÃO OBRIGATÓRIA PARA PODER MONTAR O LGR */

                                            if($login_fabrica == 125){
                                                $sql = "SELECT devolucao_obrigatoria
                                                        FROM tbl_peca_servico
                                                        INNER JOIN tbl_peca ON tbl_peca_servico.peca = tbl_peca.peca
                                                        WHERE tbl_peca.peca = $xpeca AND tbl_peca.fabrica = $login_fabrica and tbl_peca_servico.servico_realizado = 10740 ";
                                            }elseif (in_array($login_fabrica,[120,201])) {
                                                $sql = "SELECT
                                                            CASE WHEN lower(tbl_linha.nome) <> 'lavadora'
                                                                THEN 'f'
                                                            ELSE
                                                                (SELECT devolucao_obrigatoria from tbl_peca WHERE peca = $xpeca AND fabrica = $login_fabrica)
                                                            END AS devolucao_obrigatoria
                                                        FROM tbl_produto
                                                            JOIN tbl_linha USING(linha)
                                                        WHERE tbl_produto.produto = {$xproduto}";
                                            }else{
                                                $sql = "SELECT devolucao_obrigatoria from tbl_peca WHERE peca = $xpeca AND fabrica = $login_fabrica";
                                            }
                                            $res = pg_query($con,$sql);
                                            $devolucao_obrigatoria = pg_fetch_result($res, 0, 'devolucao_obrigatoria');
                                            $devolucao_obrigatoria = ($devolucao_obrigatoria == "t" AND $troca_peca == 't') ? $devolucao_obrigatoria : "f";
                                            /* FIM */

                                            if (in_array($login_fabrica, array(30)) && in_array($i, $linhaPecaDuplicada)) {
                                                $obsOsItemLabel = ", obs";
                                                $obsOsItemValue = ", '$xobs_os_item'";
                                                $obsOsItemUpd = ", obs = '$xobs_os_item'";
                                            }

                                            if (strlen($xos_item) == 0) {
                                                if($login_fabrica == 30){
                                                    $peca_desc_interacao[] = $xdescricao;
                                                }
                                                #HD 101357 inserir nul no lugar do numero de serie da peca para não dar erro no insert
                                                if ($login_fabrica == 3 AND strlen($xpeca_serie) == 0) {
                                                    $xpeca_serie = "null";
                                                }

                                                if(in_array($login_fabrica,array(96,81,98,114))){
                                                    $xdefeito = 'null';
                                                }

                                                $parametros_adicionais = null;
                                                if ($login_fabrica == 3) {
                                                    if ($xservico == 20 and $serial_lcd[$i] == "t") {
                                                        $xpeca_serie = "'{$txt_serial_lcd[$i]}'";
                                                    }

                                                    unset($parametros_adicionais);

                                                    $parametros_adicionais = array( "item_foto_upload" => "{$item_foto_upload}" );
                                                    //$parametros_adicionais = array_merge($parametros_adicionais, $foto_upload);
                                                    $parametros_adicionais["foto_upload"] = $foto_upload;
                                                    $parametros_adicionais = json_encode($parametros_adicionais);
                                                }

                                                if ($login_fabrica == 35) {
                                                    $parametros_adicionais = array("po_peca" => utf8_encode($po_peca[$i]));
                                                    $parametros_adicionais = json_encode($parametros_adicionais);
                                                }

                                                if(!in_array($login_fabrica,array(3,6,80,85,86))) {
                                                    $campos_gera_pedido_posto = ", liberacao_pedido ";
                                                    $value_gera_pedido_posto = ", '$gera_pedido_posto' ";
                                                }

                                                if($login_fabrica == 134){
                                                    $sql = "SELECT descricao, peca_estoque, ativo
                                                            FROM tbl_servico_realizado
                                                                WHERE servico_realizado = $xservico and fabrica = $login_fabrica ";
                                                    $res = pg_query($con, $sql);
                                                    $peca_estoque = pg_fetch_result($res, 0, peca_estoque);
                                                }

                                                if($login_fabrica == 134 AND $peca_estoque == 't'){
                                                    //Movimentação de estoque
                                                    $sqlIns = "INSERT INTO tbl_estoque_posto_movimento(fabrica,posto,os,tipo,peca,data,qtde_saida,obs)
                                                        values($login_fabrica,$login_posto,$os,'garantia',$xpeca,CURRENT_DATE,$qtde,'Peça utilizada em Ordem de Serviço')";
                                                    $resIns = pg_query($con, $sqlIns);
                                                    if(strlen(pg_last_error($con))>0){
                                                        $msg_erro .= pg_last_error($con);
                                                    }
                                                    $sqlUpd = "UPDATE tbl_estoque_posto set qtde = qtde - $qtde where fabrica = $login_fabrica AND posto = $login_posto and peca = $xpeca ";
                                                    $resUpd = pg_query($con, $sqlUpd);
                                                    if(strlen(pg_last_error($con))>0){
                                                        $msg_erro .= pg_last_error($con);
                                                    }
                                                }

                                                if (in_array($login_fabrica, array(19))) {
                                                    $sql = "
                                                        SELECT os_produto
                                                        FROM tbl_os_produto
                                                        WHERE os = {$os}
                                                    ";
                                                    $res = pg_query($con, $sql);
                                                    $aux_os_produto = array();
                                                    for ($l = 0; $l <= pg_num_rows($res); $l++) {
                                                        $aux_os_produto[$l] = pg_fetch_result($res, $l, 'os_produto');
                                                    }
                                                    $aux_oss_produto = implode(",", $aux_os_produto);
                                                    $aux_oss_produto = substr($aux_oss_produto, 0, -1);
                                                    $sql = "
                                                        SELECT os_item
                                                            FROM tbl_os_item
                                                            WHERE os_produto IN ({$aux_oss_produto})
                                                                AND peca = {$xpeca}
                                                                AND fabrica_i = $login_fabrica
                                                    ";
                                                    $res = pg_query($con, $sql);
                                                    if (pg_num_rows($res) > 0){
                                                        $msg_erro .= "Não é possível lançar a mesma peça mais de uma vez, favor alterar a quantidade.";
                                                    }
                                                }

                                                if (in_array($login_fabrica, [140])) {

                                                    $sqlPreco = "SELECT preco
                                                                 FROM tbl_tabela_item
                                                                 WHERE peca = {$xpeca}
                                                                 AND tabela = 759";
                                                    $resPreco = pg_query($con, $sqlPreco);

                                                    $custo_peca = (float) pg_fetch_result($resPreco, 0, 'preco');

                                                    $campo_custo_peca = ", custo_peca";
                                                    $valor_custo_peca = ", {$custo_peca}";

                                                }

                                                if ((in_array($login_fabrica, array(19)) && strlen($msg_erro) == 0) || $login_fabrica != 19) {
                                                $sql = "INSERT INTO tbl_os_item (os_produto            ,
                                                                                 posicao               ,
                                                                                 peca                  ,
                                                                                 qtde                  ,
                                                                                 defeito               ,
                                                                                 causa_defeito         ,
                                                                                 servico_realizado     ,
                                                                                 admin                 ,
                                                                                 peca_serie            ,
                                                                                 peca_serie_trocada    ,
                                                                                 peca_reposicao_estoque,
                                                                                 aguardando_peca_reparo,
                                                                                 peca_obrigatoria      $campos_gera_pedido_posto,
                                                                                 parametros_adicionais
                                                                                 $campo_fornecedor
                                                                                 $ins_makita
                                                                                 $obsOsItemLabel
                                                                                 {$campo_custo_peca}
                                                                       ) VALUES (
                                                                                 $xos_produto            ,
                                                                                 $xposicao               ,
                                                                                 $xpeca                  ,
                                                                                 $xqtde                  ,
                                                                                 $xdefeito               ,
                                                                                 $xpcausa_defeito        ,
                                                                                 $xservico               ,
                                                                                 $xadmin_peca            ,
                                                                                 $xpeca_serie            ,
                                                                                 $xpeca_serie_trocada    ,
                                                                                 $xpeca_reposicao_estoque,
                                                                                 $xaguardando_peca_reparo,
                                                                                 '$devolucao_obrigatoria'
                                                                                 $value_gera_pedido_posto,
                                                                                 '{$parametros_adicionais}'
                                                                                 $valor_fornecedor
                                                                                 $makita_preco_bruto
                                                                                 $obsOsItemValue
                                                                                 {$valor_custo_peca}) RETURNING os_item;";
                                                $res = pg_query($con,$sql);

                                              $msg_erro .= pg_errormessage($con);
                                                }
                                                // if (!pg_last_error()) {
                                                //     if(in_array($login_fabrica, $fabricas_auditor)){
                                                //         $auditorLogSaved["ANTES_INSERT"][] = array(
                                                //             "os_produto" => '',
                                                //             "posicao" => '',
                                                //             "peca" => '',
                                                //             "qtde" => '',
                                                //             "defeito" =>  '',
                                                //             "causa_defeito" => '',
                                                //             "servico_realizado" =>  '',
                                                //             "admin" => '',
                                                //             "peca_causadora" =>  '',
                                                //             "parametros_adicionais" => '',
                                                //             "peca_obrigatoria" => '',
                                                //             "fornecedor" => ''  );
                                                //             $auditorLogSaved["OS"][] = $os;
                                                //             $auditorLogSaved["INSERT"][] = array(
                                                //             "os_produto" => $xos_produto,
                                                //             "posicao" => $xposicao,
                                                //             "peca" => $xpeca,
                                                //             "qtde" => $xqtde,
                                                //             "defeito" => $xdefeito,
                                                //             "causa_defeito" => $xpcausa_defeito,
                                                //             "servico_realizado" => $xservico,
                                                //             "admin" => $xadmin_peca,
                                                //             "peca_causadora" => '',
                                                //             "parametros_adicionais" => $parametros_adicionais,
                                                //             "peca_obrigatoria" => $devolucao_obrigatoria,
                                                //             "fornecedor" => $xfornecedor,
                                                //             );
                                                //     }
                                                // }
                                                if(in_array($login_fabrica, [125,131]) or $telecontrol_distrib){
                                                    $add_peca = "true";
                                                }
                                                if (!pg_last_error() and $login_fabrica == 3) {
                                                    $os_item_array[$i] = pg_fetch_result($res, 0, "os_item");
                                                }


                                                if(in_array($login_fabrica,array(35, 50,72,74,134))){
                                                    $xos_item = pg_fetch_result($res, 0, "os_item");
                                                }
                                            #echo $msg_erro;
                                            } else {
                                                #HD 101357 inserir nul no lugar do numero de serie da peca para não dar erro no insert
                                                if ($login_fabrica == 3 AND strlen($xpeca_serie) == 0) {
                                                    $xpeca_serie = "null";
                                                }
                                                if ($login_fabrica == 3) {
                                                    if ($xservico == 20 and $serial_lcd[$i] == "t") {
                                                        $xpeca_serie = "'{$txt_serial_lcd[$i]}'";
                                                    }
                                                    $sqlPA = "SELECT parametros_adicionais FROM tbl_os_item WHERe os_item = {$xos_item}";
                                                    $resPA = pg_query($con, $sqlPA);
                                                    unset($parametros_adicionais);
                                                    if (strlen(pg_fetch_result($resPA, 0, "parametros_adicionais")) > 0) {
                                                        $parametros_adicionais = json_decode(pg_fetch_result($resPA, 0, "parametros_adicionais"), true);
                                                    }
                                                    $parametros_adicionais["item_foto_upload"] = "{$item_foto_upload}";
                                                    if (count($foto_upload) > 0) {
                                                        foreach ($foto_upload as $key => $value) {
                                                            $parametros_adicionais["foto_upload"][$key] = $value;
                                                        }
                                                    }
                                                    $parametros_adicionais = json_encode($parametros_adicionais);
                                                    $updateADC = ", parametros_adicionais   = '{$parametros_adicionais}'";
                                                }

                                                if ($login_fabrica == 24) {
                                                    $sqlPA = "SELECT parametros_adicionais, servico_realizado FROM tbl_os_item WHERe os_item = {$xos_item}";
                                                    $resPA = pg_query($con, $sqlPA);
                                                    unset($parametros_adicionais);
                                                    if (strlen(pg_fetch_result($resPA, 0, "parametros_adicionais")) > 0) {
                                                        $parametros_adicionais = json_decode(pg_fetch_result($resPA, 0, "parametros_adicionais"), true);
                                                        
                                                        if (isset($parametros_adicionais['excluida_auditoria']) && pg_fetch_result($resPA, 0, 'servico_realizado') != $xservico) {
                                                            unset($parametros_adicionais['excluida_auditoria']);
                                                            unset($parametros_adicionais['adminExcluiu']);

                                                            if (count($parametros_adicionais) > 0) {
                                                                $parametros_adicionais = json_encode($parametros_adicionais);
                                                            } else {
                                                                $parametros_adicionais = "";
                                                            }
                                                            $updateADC = ", parametros_adicionais   = '{$parametros_adicionais}'";
                                                        }
                                                    }
                                                }

                                                if ($login_fabrica == 35) {
                                                    $sqlPA = "SELECT parametros_adicionais FROM tbl_os_item WHERe os_item = {$xos_item}";
                                                    $resPA = pg_query($con, $sqlPA);
                                                    unset($parametros_adicionais);
                                                    if (strlen(pg_fetch_result($resPA, 0, "parametros_adicionais")) > 0) {
                                                        $parametros_adicionais = json_decode(pg_fetch_result($resPA, 0, "parametros_adicionais"), true);
                                                    }
                                                    $parametros_adicionais["po_peca"] = utf8_encode("$po_peca[$i]");
                                                    $parametros_adicionais = json_encode($parametros_adicionais);
                                                    $updateADC = ", parametros_adicionais   = '{$parametros_adicionais}'";
                                                }
                                                if($login_fabrica == 42) {
                                                    $makita_preco = round($makita_preco,2);
                                                    $upd_preco = ', preco = ' . $makita_preco;
                                                }
                                                // if (in_array($login_fabrica, $fabricas_auditor)){
                                                //     $sqls = "SELECT os_produto, posicao, peca, qtde, defeito, causa_defeito, servico_realizado, admin,
                                                //                     peca_serie, peca_serie_trocada, peca_reposicao_estoque,  peca_obrigatoria, fornecedor
                                                //             FROM tbl_os_item
                                                //             WHERE os_item = $xos_item";
                                                //     $ress = pg_query($con,$sqls);
                                                //     $ress = pg_fetch_all($ress);
                                                //     $antesItem = $ress[0];
                                                // }
                                                $sql = "UPDATE tbl_os_item SET
                                                            os_produto              = $xos_produto            ,
                                                            posicao                 = $xposicao               ,
                                                            peca                    = $xpeca                  ,
                                                            qtde                    = $xqtde                  ,";
                                                if(!in_array($login_fabrica,array(96,81,98,114))){
                                                            $sql .= "defeito        = $xdefeito               ,";
                                                }
                                                 $sql .="   causa_defeito           = $xpcausa_defeito        ,
                                                            servico_realizado       = $xservico               ,
                                                            admin                   = $xadmin_peca            ,
                                                            peca_serie              = $xpeca_serie            ,
                                                            peca_serie_trocada      = $xpeca_serie_trocada    ,
                                                            peca_reposicao_estoque  = $xpeca_reposicao_estoque,
                                                            peca_obrigatoria        = '$devolucao_obrigatoria',
                                                            aguardando_peca_reparo  = $xaguardando_peca_reparo
                                                            $updateADC
                                                            $upd_preco ";
                                                if($login_fabrica == 91){
                                                    $query_action = "UPDATE";
                                                    $valor_fornecedor = str_replace(",", "", $valor_fornecedor);
                                                    $sql .= "$campo_fornecedor     = $valor_fornecedor           ";
                                                }
                                                if (in_array($login_fabrica, array(30))) {
                                                    $sql .= $obsOsItemUpd;
                                                }
                                                $sql .="  WHERE os_item = $xos_item;";
                                                $res = pg_query($con,$sql);
                                                $msg_erro .= pg_errormessage($con);

                                                // if (!pg_last_error()) {
                                                //     if (in_array($login_fabrica, $fabricas_auditor)){
                                                //         $auditorLogSaved["ANTES_UPDATE"][] = $antesItem;
                                                //         $auditorLogSaved["OS"][] = $os;
                                                //         $auditorLogSaved["UPDATE"][] = array(
                                                //             "os_produto" => $xos_produto,
                                                //             "posicao" => $xposicao,
                                                //             "peca" => $xpeca,
                                                //             "qtde" => $xqtde,
                                                //             "defeito" => $xdefeito,
                                                //             "causa_defeito" => $xpcausa_defeito,
                                                //             "servico_realizado" => $xservico,
                                                //             "admin" => $xadmin_peca,
                                                //             "peca_causadora" => '',
                                                //             "parametros_adicionais" => $parametros_adicionais,
                                                //             "peca_obrigatoria" => $devolucao_obrigatoria,
                                                //             "fornecedor" => $xfornecedor,
                                                //         );
                                                //     }
                                                // }
                                                if (!pg_last_error() and $login_fabrica == 3) {
                                                    $os_item_array[$i] = $xos_item;
                                                }
                                            }
                                            if (strlen($msg_erro) > 0) {
                                                break ;
                                            }
                                            // Se a peça estiver como bloqueada garantia, a os é cadastrada, a peça tbm, mas o pedido da peça nao eh feito. Somente após a autorizacao o pedido da peça eh feito. -- Fabio 07/03/2007
                                            if (($login_fabrica == 3  AND $xservico == "20" AND $bloqueada_garantia_peca == 't') OR
                                                ( in_array($login_fabrica, array(11,172)) AND $xservico == "61" AND $bloqueada_garantia_peca == 't')) {
                                                // envia email teste para avisar
                                                $os_bloqueada_garantia ='t';
                                                $msg_intervencao .= "<br />O pedido da peça $xpeca precisa de análise antes do envio. Aguarde o contato da fábrica";
                                                $gravou_peca = "sim";
                                            }
                                            // Se a PEÇA tiver intervencao da fabrica e for troca de peca gerando pedido, alterar status da OS para Intervenção da Assistência Técnica da Fábrica PENDENTE ( tbl_status_os -> 62)
                                            //Retirado intervençao tecnica para Lenoxx - HD 11374
                                            // ($login_fabrica==11  AND $xservico=="61")
                                            //voltei a rotina para Lenoxx hd 15230
                                            elseif ((($login_fabrica == 2 AND $xservico == "7" AND $login_posto == 6359)  OR ($login_fabrica == 6  AND $xservico=="485") OR ( in_array($login_fabrica, array(11,172)) AND $xservico == "61") OR ($login_fabrica == 51  AND $xservico == "673"))
                                                AND ($intervencao_fabrica_peca == 't' OR $troca_obrigatoria_peca == 't') AND $xqtde > 0) {
                                                $os_com_intervencao = 't';
                                                $gravou_peca = "sim";
                                            }
                                            # INTERVENÇÃO DE CARTEIRA
                                            else if (($login_fabrica == 3 AND $xservico == "20" AND $intervencao_carteira == 't')) {
                                                // envia email teste para avisar
                                                $os_com_intervencao_carteira ='t';
                                                $gravou_peca="sim";
                                            }
                                            else if (in_array($login_fabrica,array(98,106,108,111,124,137)) AND $bloqueada_peca_critica == 't') { //HD 418875 Ederson Sandre
                                                // envia email teste para avisar
                                                $os_com_intervencao_carteira ='t';
                                                $gravou_peca="sim";
                                            }
                                            # se for peça critica, entra em OS com intervenção de suprimentos
                                            else if ( in_array($login_fabrica, array(11,172)) AND $bloqueada_peca_critica == 't' AND $xservico == "61") {
                                                $os_com_intervencao_suprimentos = 't';
                                                $gravou_peca = "sim";
                                            } else if ($login_fabrica == 3 AND $xservico == 20) {
                                                $gravou_peca = "sim";
                                                if(($intervencao_fabrica_peca == 't' OR $troca_obrigatoria_peca == 't') AND $xqtde > 0) {
                                                    $os_com_intervencao = 't';
                                                }
                                                if ($serial_lcd[$i] == "t" or $qtde_fotos[$i] > 0) {
                                                      $os_com_intervencao_display = 't';
                                                }
                                            } else if($login_fabrica == 3) { // hd 49873
                                                $sqlp = "SELECT gera_pedido
                                                FROM tbl_servico_realizado
                                                WHERE fabrica = $login_fabrica
                                                AND ativo IS TRUE
                                                AND servico_realizado = $xservico";
                                                $resp = pg_query($con,$sqlp);
                                                $gera_pedido = pg_fetch_result($resp,0,0);
                                                if ($gera_pedido == 't') {
                                                    $os_com_intervencao = 't';
                                                    $gravou_peca = "sim";
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

            /*
            Fabrica = 35
            CASO O PEDIDO SERA TROCA DE PEÇA ABATE DO ESTOQUE PULMÃO
            */
            if($login_fabrica == 35){
                if(strlen($xos_item) > 0){
                    include "regra_controle_estoque_cadence.php";
                }
            }


            /*
            Fabrica: 50 / Colormaq
            CASO O PEDIDO SERA TROCA DE PEÇA ABATE DO ESTOQUE PULMÃO
            */

            if($login_fabrica == 50){
                include_once "regra_controle_estoque_colormaq.php";
            }

            /* Fim 50 */

            /*
            Fabrica: 72 /  Mallory
            CASO O PEDIDO SERA TROCA DE PEÇA ABATE DO ESTOQUE PULMÃO
            */

            if($login_fabrica == 72){
                include_once "regra_controle_estoque_mallory.php";
            }

            /* Fim 72 */

            /*

            Fabrica: 74
            TROCA DE PEÇA GERANDO PEDIDO / PECA USANDO ESTOQUE (RECOMPRA)

            */

            if($login_fabrica == 74){
                include_once "regra_controle_estoque_atlas.php";

                if(strlen($depara_auditoria) > 0){
                    $sqlPro = " SELECT  os
                                FROM    tbl_os_status
                                WHERE   os = $os
                                AND     status_os = 196
                    ";
                    $resPro = pg_query($con,$sqlPro);
                    if(pg_num_rows($resPro) == 0){
                        $sqlIns = "
                            INSERT INTO tbl_os_status(
                                os              ,
                                status_os       ,
                                observacao      ,
                                fabrica_status
                            ) VALUES (
                                $os                                                                 ,
                                196                                                                 ,
                                'OS em auditoria de peças com datas limite de substituição ATÉ-A PARTIR' ,
                                $login_fabrica
                            );
                        ";
                        $resIns = pg_query($con,$sqlIns);
                        if(!pg_last_error($con)){
                            require "class/email/PHPMailer/PHPMailerAutoload.php";

                            $mail = new PHPMailer;

                            $mail->isSMTP();

                            $mail->From         = "helpdesk@telecontrol.com.br";
                            $mail->FromName     = "Suporte Telecontrol";
                            $mail->AddAddress('aujor@atlas.ind.br','Atlas Fogões');
                            //$mail->addAddress('william.brandino@telecontrol.com.br', 'Atlas Fogões');

                            $mail->isHTML(true);
                            $mail->Subject      = "OS entrando em auditoria de PEÇAS - $os";
                            $mensagem = "
                                Prezado(a);
                                <br /><br />Foi cadastrado uma nova OS - <a href='/assist/os_press.php?os=$os' target='_blank'>{$os}</a>
                                <br />Onde a mesma entrou em auditoria por ter uma peça cadastrada como ATÉ-A PARTIR com limite de data
                                <br />Atenciosamente,
                                <br />Suporte Telecontrol
                                <br />www.telecontrol.com.br
                                <br /><b><em>Esta é uma mensagem automática, não responda este e-mail.</em></b>
                            ";

                            $mail->Body = $mensagem;

                            #if(!$mail->send()){
                            #   echo "Erro ao enviar: ".$mail->ErrorInfo;
                            #}
                        }
                    }
                }
            }

            /* Fim 74 */

            /*

            Fabrica: 134
            TROCA DE PEÇA GERANDO PEDIDO / PECA USANDO ESTOQUE (RECOMPRA)

            */

            // if($login_fabrica == 134){  HD-2517478 comentado
            //     include_once "regra_controle_estoque_thermosystem.php";

            //     if(count($array_peca_sem_estoque) > 0){
            //         $msg_erro = implode("<br>",$array_peca_sem_estoque);
            //     }
            // }

            /* Fim 134 */
        }

        if($login_fabrica == 104){
            if($contador_x > 0){
                $msg_erro .= "Obrigatório o envio de foto da peça danificada para aprovação da garantia. Será necessário observar o padrão de garantia da peça antes do envio. Dúvidas, entrar em contato com o analista da região.";
            }
            //echo "<pre>";
            //echo $contador_x;
            //echo "</pre>";exit;
        }


        if($login_fabrica == 134 and $gravar_auditoria_produto_acabado == true){
            $sql_grava_auditoria = "INSERT INTO tbl_os_status (os, status_os, observacao, fabrica_status) VALUES ($os, 192, 'Troca de produto', $login_fabrica)"; 
            $res_grava_auditoria = pg_query($con, $sql_grava_auditoria);
            if(pg_num_rows($res_grava_auditoria)>0){
                $msg_erro .= "Falha ao gravar auditoria de troca de produto. ";
            }
        }

        if($login_fabrica == 30 && count($peca_desc_interacao) > 0){
            $descPecas = implode(", ",$peca_desc_interacao);
            $msg = "Foram adicionadas as peças: $descPecas";

            $sql = "
                INSERT INTO tbl_os_interacao (
                    programa,
                    os,
                    data,
                    comentario,
                    interno,
                    posto
                ) VALUES (
                    '$programa_insert',
                    $os,
                    CURRENT_TIMESTAMP,
                    '$msg',
                    TRUE,
                    $login_posto
                );
            ";
            $res = pg_query($con,$sql);
        }

        if($login_fabrica == 131 and $auditoria_os_pressure == 'true') {
            if($add_peca == 'true') {
                $auditar = false;
                $sql = "SELECT status_os FROM tbl_os_status WHERE os = $os order by os_status desc limit 1";
                $res = pg_query($con,$sql);
                if(pg_num_rows($res) > 0) {
                    $status_os = pg_fetch_result($res,0,'status_os');
                    if($status_os == 205) {
                        $auditar = true;
                    }
                }else{
                    $auditar = true;
                }
                if($auditar) {
                    $sql =" INSERT INTO
                        tbl_os_status(
                            os,
                            status_os,
                            observacao,
                            fabrica_status
                        )VALUES(
                            $os,
                            205,
                            'Aguardando aprovação para gerar pedido',
                            $login_fabrica
                        )";
                    $res = pg_query($con, $sql);
                }
            }else{
                $sql_aud = "SELECT  status_os
                                FROM    tbl_os_status
                                WHERE   tbl_os_status.os = $os
                                AND     tbl_os_status.status_os IN (203,204,205)
                                ORDER BY tbl_os_status.data DESC LIMIT 1";
                $res_aud = pg_query($con, $sql_aud);

                if(pg_num_rows($res_aud) > 0){
                    $statusAud = pg_fetch_result($res_aud, 0, 'status_os');
                }
                if($statusAud <> 205){
                    $sql =" INSERT INTO
                        tbl_os_status(
                            os,
                            status_os,
                            observacao,
                            fabrica_status
                        )VALUES(
                            $os,
                            205,
                            'Aguardando aprovação para gerar pedido',
                            $login_fabrica
                        )";
                    $res = pg_query($con, $sql);
                }
            }
        }

        if(strlen($msg_erro) ==0 && $login_fabrica == 15){
            $sql = 'SELECT fn_valida_nova_mascara_ns_latinatec($1,$2,$3);';
            $params = array($os,$login_fabrica,$produto_serie);
            pg_query_params($con,$sql,$params);
            $msg_erro = pg_errormessage($con);
        }

        if (empty($msg_erro) and $login_fabrica == '50') {
            $sqlDelResp = "DELETE FROM tbl_resposta WHERE os = $os";
            $qryDelResp = pg_query($con, $sqlDelResp);

            if (!empty($respostas)) {
                foreach ($respostas as $key => $value) {
                    $sqlInsResp = "INSERT INTO tbl_resposta (pergunta, os, txt_resposta) VALUES ($key, $os, '$value')";
                    $qryInsResp = pg_query($con, $sqlInsResp);
                }
            }
        }

        if($login_fabrica == 125){
            $sql = "SELECT  tbl_servico_realizado.descricao
                    FROM    tbl_os_item
                    JOIN    tbl_os_produto          ON  tbl_os_item.os_produto          = tbl_os_produto.os_produto
                    JOIN    tbl_servico_realizado   ON  tbl_os_item.servico_realizado   = tbl_servico_realizado.servico_realizado
                                                    AND tbl_servico_realizado.fabrica   = $login_fabrica
                    WHERE   tbl_os_produto.os                       = $os
                    AND     lower(tbl_servico_realizado.descricao)  IN('troca de motor','troca de trilho')";

            $res = pg_query($con,$sql);

            if(pg_num_rows($res) > 0){
                $sql = "SELECT valores_adicionais FROM tbl_os_campo_extra WHERE os = $os";
                $res = pg_query($con,$sql);
                $valores_adicionais = pg_fetch_result($res, 0, 'valores_adicionais');
                $valores_adicionais = json_decode($valores_adicionais,true);
                if(pg_num_rows($res) == 0){
                    $msg_erro = "Para peças com Troca de Motor ou trilho, é obrigatória a marcação do serviço de Alinhamento";
                }else{
                    if(!array_key_exists("ALINHAMENTO", $valores_adicionais[0] )){
                        $msg_erro = "É obrigatória a marcação do serviço de Alinhamento";
                    }
                }

                if(empty($msg_erro)){
                    foreach ($valores_adicionais as $key => $value) {
                        foreach ($value as $valor) {
                            $valor2 = str_replace(".", "", $valor);
                            $valor2 = str_replace(",", ".", $valor2);
                            $soma  = $soma + $valor2;
                        }
                    }

                    $sql = "UPDATE tbl_os SET valores_adicionais = $soma WHERE os = $os";
                    $res      = pg_exec($con,$sql);
                    $msg_erro = pg_errormessage($con);
                }

            }
        }
       if (strlen(trim($_POST['obs']))>0){

            if ($login_fabrica == 125 ) {

                $sql_email = "SELECT tbl_posto.cnpj FROM tbl_posto JOIN tbl_os ON tbl_os.posto = tbl_posto.posto WHERE tbl_os.os = {$os}";
                $res_email = pg_query($con, $sql_email);

                $codigo_posto       = pg_fetch_result($res_email, 0, 'cnpj');

                include_once 'class/email/PHPMailer/class.phpmailer.php';

                $mail = new PHPMailer(true); // the true param means it will throw exceptions on errors, which we need to catch
                $mail->IsSMTP(); // telling the class to use SMTP

                try {
                    //$mail->SMTPDebug  = 2;                     // enables SMTP debug information (for testing)
                    $mail->SMTPAuth   = true;                  // enable SMTP authentication
                    $mail->SMTPSecure = "ssl";                 // sets the prefix to the servier
                    $mail->Host       = "smtp.gmail.com";      // sets GMAIL as the SMTP server
                    $mail->Port       = 465;
                                                                            // set the SMTP port for the GMAIL server
                    $mail->Username   = "noreply@telecontrol.com.br";  // GMAIL username
                    $mail->From       = "helpdesk@telecontrol.com.br";
                    $mail->FromName     = "Suporte Telecontrol";
                    $mail->Password   = "tele6588";            // GMAIL password
                    $mail->AddReplyTo('gustavo.xavier@telecontrol.com.br', 'luis.carlos@telecontrol.com.br', 'andre.bernardo@telecontrol.com.br');
                    $mail->AddAddress('gustavo.xavier@telecontrol.com.br', 'luis.carlos@telecontrol.com.br', 'andre.bernardo@telecontrol.com.br');
                    $mail->SetFrom('noreply@telecontrol.com.br', 'Suporte Telecontrol');

                    $mail->Subject = Date('d/m/Y');
                    $mensagem           = " <br /> FABRICANTE : SAINT-GOBAIN\n";
                    $mensagem           .= " <br /> Posto {$codigo_posto}\n";
                    $mensagem           .= " <br /> Número da OS {$os}\n";
                    $mensagem           .= " <br /> Observação {$_POST['obs']}\n";
                    $mail->MsgHTML($mensagem);
                    $mail->Send();
                } catch (phpmailerException $e) {
                    echo $e->errorMessage(); //Pretty error messages from PHPMailer
                } catch (Exception $e) {
                    echo $e->getMessage(); //Boring error messages from anything else!
                }
            }
        }

        if($login_fabrica == 30){
            if(count($peca_negativa) > 0){
                $peca_negativa = json_encode($peca_negativa);

                echo "<script>
                        window.open('pedido_cadastro_normal.php?pecas=$peca_negativa');
                    </script>";
                //$msg_erro = "Existem peças sem estoque, retire da OS e faça um pedido faturado e retire as peças da Ordem de Serviço";
            }
            if($visita_agendada != "" && $gravou_visita == "sim"){
                $sql = "
                    SELECT  tbl_hd_chamado.hd_chamado,
                            tbl_hd_chamado.admin
                    FROM    tbl_hd_chamado_extra
                    JOIN    tbl_hd_chamado USING(hd_chamado)
                    where os = $os;
                ";
                $res = pg_query($con,$sql);

                if(pg_num_rows($res) > 0){
                    $hd_chamado         = pg_fetch_result($res,0,hd_chamado);
                    $comentario = "A Ordem de Serviço $os sofreu alterações na data de agendamento";
                    $sqlItem = "
                        INSERT INTO tbl_hd_chamado_item (
                            hd_chamado,
                            data,
                            comentario,
                            interno,
                            posto
                        ) VALUES (
                            $hd_chamado,
                            CURRENT_TIMESTAMP,
                            '$comentario',
                            't',
                            $login_posto
                        );
                    ";
                    $resItem = pg_query($con,$sqlItem);
                }
            }
        }

        if ($login_fabrica == 80) {
            $rastreamento_envio = $_POST['rastreamento_envio'];
            $data_envio = $_POST['data_envio'];

                $sql = "SELECT hd_chamado from tbl_hd_chamado_extra where os = $os";

                $res = pg_exec($con,$sql);

                if (pg_num_rows($res)>0 and strlen($rastreamento_envio) > 1 ) {

                    $hd_chamado = pg_result($res,0,0);
                    $rastreio = "'Envio do Produto ao consumidor em $data_envio, número do rastreamento ==><a href=\\\"http://www.websro.com.br/correios.php?P_COD_UNI=$rastreamento_envio\".\"BR target=\"_blank\"> $rastreamento_envio </a>'";
                    $sqlinf = "INSERT INTO tbl_hd_chamado_item(
                        hd_chamado   ,
                        data         ,
                        comentario   ,
                        interno      ,
                        admin
                        )values(
                        $hd_chamado       ,
                        current_timestamp ,
                        $rastreio,
                        't',
                        (SELECT admin FROM tbl_hd_chamado WHERE hd_chamado = $hd_chamado limit 1)
                        )";
                    $resinf = pg_query($con,$sqlinf);

                    $sql = "UPDATE tbl_os set obs = 'Envio do Produto ao consumidor em $data_envio, número do rastreamento ==><a href=\"http://www.websro.com.br/correios.php?P_COD_UNI=$rastreamento_envio"."BR target=\"_blank\"\"> $rastreamento_envio </a>' where os = $os";
                    $res = pg_query($con,$sql);
                }
        }

        if (empty($msg_erro) and ($login_fabrica == 6 or
            ($login_fabrica == 15 and
             in_array($login_posto,array(6359,10950,10952,20235,2405,5551,12008,11946,11467,10806,11958,11946,11471,11732,118825,359970,343192,393942))))) { //HD 2599, 15180, 11/12/09-HD 183336

            // HD 671900
            $pre_kit_total = $_POST['pre_total_kit'];
            if( strlen($xos_produto) == 0 ) {

                $query = pg_query($con,"BEGIN TRANSACTION");
                $rollback = FALSE;
                $sql2 = "select produto from tbl_os where os=$os and fabrica = $login_fabrica";
                $res2 = pg_query($con,$sql2);

                $pre_produto = pg_fetch_result($res2,0,0);

                $sql = "INSERT INTO tbl_os_produto (
                                        os     ,
                                        produto,
                                        serie
                                    )VALUES(
                                        $os     ,
                                        $pre_produto,
                                        $xserie
                                );";
                $res = pg_query($con,$sql);
                $msg_erro .= pg_errormessage($con);

                $res = pg_query($con,"SELECT CURRVAL ('seq_os_produto')");
                $xos_produto  = pg_fetch_result($res,0,0);
            }

            for($i=0;$i < $pre_kit_total; $i++) {

                $kit_id = $_POST['pre_kit_' . $i];

                if( empty($kit_id) )
                    continue;
                if(empty($_POST['pre_defeito_kit_' . $i]) || empty($_POST['pre_servico_kit_' . $i]) ) {
                    $rollback = TRUE;
                    $msg_erro = "Escolha o defeito do " . $_POST['descricao_kit_' . $i];
                    break;
                }
                $defeito = $_POST['pre_defeito_kit_' . $i];
                $servico = $_POST['pre_servico_kit_' . $i];

                $sql = "SELECT tbl_os_item.peca
                        FROM tbl_os_produto
                        JOIN tbl_os_item USING(os_produto)
                        JOIN tbl_kit_peca_peca USING(peca)
                        WHERE os = $os
                        AND kit_peca = $kit_id";
                $res = pg_query($con,$sql);

                if( pg_num_rows($res) > 0 )
                    continue;

                // verifica e insere as peças do kit na OS
                $sql = "SELECT peca,qtde
                        FROM tbl_kit_peca_peca
                        WHERE kit_peca = " . $kit_id;
                $res = pg_query($con,$sql);
                $contar_res = pg_num_rows($res);
                for($j = 0; $j < $contar_res; $j++) {

                    $peca_kit = pg_result($res,$j,0);
                    $qtde_kit = pg_result($res,$j,1);

                    $sql = "INSERT INTO tbl_os_item (
                                        os_produto        ,
                                        peca              ,
                                        qtde              ,
                                        defeito           ,
                                        liberacao_pedido ,
                                        servico_realizado
                                    )VALUES(
                                        $xos_produto    ,
                                        $peca_kit       ,
                                        $qtde_kit       ,
                                        $defeito        ,
                                        '$gera_pedido_posto'  ,
                                        $servico
                                );";
                    $res2 = pg_query($con,$sql);
                    $msg_erro .= pg_errormessage($con);

                }

            }

            if($rollback === TRUE){
                $query = pg_query($con,"ROLLBACK");
            }
            $pre_total = $_POST['pre_total'];

            for ($i = 0 ; $i < $pre_total ; $i++) {
                $pre_peca = $_POST['pre_peca_'.$i];
                if (strlen($pre_peca)>0){

                    //echo "<BR>$pre_peca";
                    $pre_defeito = $_POST['pre_defeito_'.$i];
                    $pre_servico = $_POST['pre_servico_'.$i];
                    $pre_qtde    = $_POST['pre_qtde_'   .$i];
                    //echo "<BR>$pre_defeito";
                    //echo "<BR>$pre_servico";
                    if (strlen($pre_defeito)== 0)$msg_erro .= "Favor informar o defeito da peça<BR>";
                    if (strlen($pre_servico)== 0)$msg_erro .= "Favor informar o serviço realizado<BR>";

                    $sql = "select produto from tbl_os where os=$os and fabrica = $login_fabrica";
                    $res = pg_query($con,$sql);
                    if(pg_num_rows($res)>0){
                        $pre_produto = pg_fetch_result($res,0,0);
                    }

                    $sql_peca = "SELECT tbl_peca.referencia
                                FROM tbl_peca
                                WHERE peca = $pre_peca";
                    $res_peca = pg_query($con,$sql_peca);

                    $referencia = pg_fetch_result($res_peca,0,'referencia');
                    #HD 335128 VALIDACAO DO NRO DE SERIE COM A PECA DA LISTA BASICA - INICIO
                    if ($login_fabrica == 15)  {

                        if (isset($_POST['produto_serie'])) {
                            $produto_serie_letra = substr($_POST['produto_serie'],1,1);
                        }

                        if (strlen($produto_serie)>0){
                        $sql_serie_in_out = "SELECT
                                            tbl_lista_basica.peca         ,
                                            tbl_lista_basica.serie_inicial,
                                            tbl_lista_basica.serie_final
                                            froM tbl_lista_basica
                                            where produto=$pre_produto
                                            AND tbl_lista_basica.peca = $pre_peca
                                            ORDER BY tbl_lista_basica.peca";

                            $res_serie_in_out = pg_query($con,$sql_serie_in_out);

                            $serie_inicial = pg_result($res_serie_in_out,0, serie_inicial);
                            $serie_final = pg_result($res_serie_in_out,0, serie_final);

                            if (strlen($serie_inicial)>0 and strlen($serie_final)>0){

                                $sql_serie= "SELECT
                                            tbl_lista_basica.peca,
                                            tbl_lista_basica.serie_inicial,
                                            tbl_lista_basica.serie_final
                                            froM tbl_lista_basica
                                            where produto=$pre_produto
                                            AND tbl_lista_basica.peca = $pre_peca
                                            AND '$produto_serie_letra' between tbl_lista_basica.serie_inicial and tbl_lista_basica.serie_final
                                            ORDER BY tbl_lista_basica.peca";
                                $res_serie = pg_query($con,$sql_serie);

                                $linha = pg_num_rows($res_serie);
                                if ($linha == 0){
                                    $msg_erro .= " A peça $referencia não pertence a esta versão do produto<BR>";
                                }

                            }
                        }

                    }#HD 335128 VALIDACAO DO NRO DE SERIE COM A PECA DA LISTA BASICA - FIM

                    if (strlen($msg_erro)==0){
                            $sql = "INSERT INTO tbl_os_produto (
                                            os     ,
                                            produto

                                        )VALUES(
                                            $os     ,
                                            $pre_produto
                                    );";
                                $res = pg_query($con,$sql);
                                $msg_erro .= pg_errormessage($con);
                                $res = pg_query($con,"SELECT CURRVAL ('seq_os_produto')");
                                $xos_produto  = pg_fetch_result($res,0,0);

                    }
                    if (strlen($msg_erro) == 0) {
                            $sql = "INSERT INTO tbl_os_item (
                                        os_produto        ,
                                        peca              ,
                                        qtde              ,
                                        defeito           ,
                                        liberacao_pedido ,
                                        servico_realizado
                                    )VALUES(
                                        $xos_produto    ,
                                        $pre_peca       ,
                                        $pre_qtde       ,
                                        $pre_defeito    ,
                                        '$gera_pedido_posto',
                                        $pre_servico
                                );";

                            $res = pg_query($con,$sql);
                            $msg_erro .= pg_errormessage($con);
                            //echo "2- ".$sql;


                    }
                }
            }
        }
    }

    # Caso gravou peças de orçamento, registrar...
    if (strlen($orcamento) > 0 AND $gravou_pecas_orcamento == "sim") {

        $gravou_pecas_orcamento = "";

        $valor_mo_orcamento = trim($_POST["valor_mo_orcamento"]);
        $orcamento_aprovado = trim($_POST["orcamento_aprovado"]);

        $valor_mo_orcamento = str_replace ("," , "." ,$valor_mo_orcamento);
        $valor_mo_orcamento = str_replace ("-" , "" , $valor_mo_orcamento);
        $valor_mo_orcamento = str_replace ("/" , "" , $valor_mo_orcamento);
        $valor_mo_orcamento = str_replace (" " , "" , $valor_mo_orcamento);

        if (strlen($valor_mo_orcamento) == 0) {
            $valor_mo_orcamento = " NULL ";
        }

        if (strlen($orcamento_aprovado) > 0) {
            $orcamento_aprovado = "'t'";
        } else {
            $orcamento_aprovado = "NULL";
        }

        if (strlen($orcamento) == 0) {
            $query = "INSERT INTO tbl_orcamento (empresa,os,total_mao_de_obra,aprovado) VALUES ($login_fabrica,$os,$valor_mo_orcamento,$orcamento_aprovado)";
            $orca = pg_query($con, $query);
            $msg_erro .= pg_errormessage($con);
            $query = "SELECT currval('tbl_orcamento_orcamento_seq') AS orcamento";
            $orca = pg_query($con, $query);
            $orcamento = pg_fetch_result($orca,0,orcamento);
        }else{
            $query = "UPDATE tbl_orcamento SET
                        total_mao_de_obra= $valor_mo_orcamento,
                        total_pecas     = (SELECT
                                    SUM(preco*qtde)
                                    FROM tbl_orcamento_item
                                    WHERE orcamento=$orcamento
                                    ),
                        aprovado = $orcamento_aprovado
                    WHERE orcamento = $orcamento
                    AND empresa = $login_fabrica";
            $orca = pg_query($con, $query);
            $msg_erro .= pg_errormessage($con);
        }

        #Criar Help-Desk
        $sql = "SELECT hd_chamado FROM tbl_hd_chamado WHERE orcamento = $orcamento";
        $res_chamado = pg_query($con, $sql);
        if(pg_num_rows($res_chamado)>0){
            $hd_chamado = pg_fetch_result($res_chamado,0,hd_chamado);
        }else{
            $sql = "INSERT INTO tbl_hd_chamado (posto,titulo,orcamento) VALUES ($login_posto,'Orçamento da OS NÂº $sua_os',$orcamento)";
            $res_chamado = pg_query($con, $sql);
            $msg_erro .= pg_errormessage($con);

            $sql = "SELECT currval('seq_hd_chamado')";
            $res_chamado = pg_query($con, $sql);
            $hd_chamado = pg_fetch_result($res_chamado,0,0);
        }

        $sql = "INSERT INTO tbl_hd_chamado_item (hd_chamado,comentario) VALUES ($hd_chamado,'Ordem de Serviço alterada. Aguardando aprovação')";
        $res_chamado = pg_query($con, $sql);
        $msg_erro .= pg_errormessage($con);

        if (strlen($orcamento)>0){
            $query = "UPDATE tbl_orcamento SET
                        aprovado = NULL,
                        data_aprovacao = NULL,
                        data_reprovacao = NULL,
                        motivo_reprovacao = NULL
                    WHERE orcamento = $orcamento
                    AND empresa = $login_fabrica";
            $orca = pg_query($con, $query);
            $msg_erro .= pg_errormessage($con);
        }

    }

//HD 208462: 1. Se a solução selecionada exigir troca de peça, exigir os_item com serviço que gere troca de peça
//             Totas as fábricas, autorizado por Samuel
//             2. Se a solução selecionada não exigir troca de peça, não deixar cadastrar os_item com serviço
//             que gere troca de peça. Todas as fábricas, autorizado por Samuel

//HD 232039: Para a SightGPS cadastra varios defeitos e solucoes, a validação é diferente. Ver mais abaixo

if (strlen($x_solucao_os) > 0 && $x_solucao_os <> 'null' && $login_fabrica != 47 && $login_fabrica != 59 && empty($msg_erro)) {

    if (($solucao_os != 328 || $solucao_os != 330 || $solucao_os != 331)) {

        //HD 227536: Para as soluções 328 330 331 não deve validar a questão de lançamento de itens
        $sql_t = "SELECT troca_peca FROM tbl_solucao WHERE solucao = $x_solucao_os AND fabrica = $login_fabrica AND troca_peca IS TRUE; ";
        $res_t = pg_query($con,$sql_t);
        if (pg_num_rows($res_t) > 0) {

            $sql_t = "SELECT COUNT(*)
                            FROM tbl_os_item
                            JOIN tbl_os_produto USING(os_produto)
                            JOIN tbl_servico_realizado ON tbl_os_item.servico_realizado = tbl_servico_realizado.servico_realizado
                        WHERE os = $os
                        AND tbl_servico_realizado.troca_de_peca IS TRUE";

            $res_t = pg_query($con,$sql_t);

            if (pg_fetch_result($res_t,0,0) == 0) {

                if (stripos($msg_erro,"Informe a quantidade para a peça") === false) {
                   // $msg_erro .= "Para a solução escolhida, é necessário especificar a peça a ser trocada.";
                }

            }

        } else {
            if( ( $login_fabrica == 40 && $solucao_os != 2942) || $login_fabrica != 40  ) { // HD 688720
                $sql_t = "SELECT COUNT(*)
                            FROM tbl_os_item
                            JOIN tbl_os_produto USING(os_produto)
                            JOIN tbl_servico_realizado ON tbl_os_item.servico_realizado = tbl_servico_realizado.servico_realizado
                        WHERE os = $os
                        AND tbl_servico_realizado.troca_de_peca IS TRUE";

                $res_t = pg_query($con,$sql_t);

                if (pg_fetch_result($res_t,0,0) > 0) {
                    if($login_fabrica == 74){
                        $msg_erro = "Para a solu&ccedil;&atilde;o escolhida, o servi&ccedil;o n&atilde;o pode ser troca de pe&ccedil;as. Automaticamente ser&aacute; aberta uma nova OS para solicita&ccedil;&atilde;o de pe&ccedil;as";
                    }else{
                        /*$msg_erro .= "Para a solução escolhida, o serviço não pode ser troca de peça em garantia, caso queira que algum item gere pedido, favor colocar a solução \"Troca de peça gerando pedido em garantia\".";*/
                    }
                }
            }
        }

    }

} else if (in_array($login_fabrica,array(59))) { //HD 232039: Validar defeito constatado e solução para fábricas que lançam mais de um defeito x solucao

    $sql = "
    SELECT
    DISTINCT
    tbl_solucao.troca_peca

    FROM
    tbl_os_defeito_reclamado_constatado
    JOIN tbl_solucao ON tbl_os_defeito_reclamado_constatado.solucao=tbl_solucao.solucao

    WHERE
    os=$os
    ";
    $res = pg_query($con, $sql);

    //Contando quantos itens lançados possuem serviço com troca de peça
    $sql_t = "
    SELECT
    COUNT(*)

    FROM
    tbl_os_item
    JOIN tbl_os_produto USING(os_produto)
    JOIN tbl_servico_realizado ON tbl_os_item.servico_realizado = tbl_servico_realizado.servico_realizado

    WHERE
    os = $os
    AND tbl_servico_realizado.troca_de_peca IS TRUE
    ";
    $res_t = pg_query($con, $sql_t);
    //Se tiver dois registros no result, quer dizer que um deles é 't' e outro 'f' já que o campo é boolean
    //Se tiver um registro e este for 't'
    //Nestes dois casos tem que digitar peça com serviço com troca de peça
    if (pg_num_rows($res) == 2 || (pg_num_rows($res) == 1 && pg_result($res, 0, troca_peca) == 't')) {
        if(pg_fetch_result($res_t,0,0) == 0){
            $msg_erro .= "Uma das soluções escolhidas exige troca de peça.<br>É necessário especificar a peça a ser trocada.";
        }
    }
    //Se tiver um registro e este for 'f' não pode digitar peça com serviço de troca de peça
    elseif (pg_num_rows($res) == 1 && pg_result($res, 0, troca_peca) == 'f') {
        if(pg_fetch_result($res_t,0,0) > 0){
            $msg_erro .= "Nenhuma das soluções escolhidas exige troca de peça.<br>Não pode existir peça que tenha serviço com troca de peça.";
        }
    }
}

if ($login_fabrica == 6 and $solucao_os == 3813) {
    $sqlxyz = "SELECT * FROM tbl_os_item JOIN tbl_os_produto USING (os_produto) JOIN tbl_os USING (os) WHERE servico_realizado = 10664 AND tbl_os.os = $os";
    $querxyz = pg_query($con, $sqlxyz);

    $queryteste = pg_query($con, "select servico_realizado from tbl_os_item join tbl_os_produto using(os_produto) join tbl_os using (os) where tbl_os.os = $os");

    if (pg_num_rows($querxyz) == 0) {
        $msg_erro.= "<br/>Para a solução escolhida ao menos um dos serviços deve ser 'Troca de componente'";
    }
}

    if ($login_fabrica == 90) { //HD 311795

        $recolhimento = $_POST['recolhimento'] == 'sim' ? 't' : 'f';
        $sql_r = "UPDATE tbl_os_extra SET recolhimento = '" . $recolhimento . "' WHERE os = " . $os;
        //var_dump($sql_r);
        $res_r = pg_query($con, $sql_r);
        $msg_erro = pg_errormessage($con);
        echo !empty($msg_erro) ? $msg_erro : '';

        //gravar aqui o campo reoperacao de gas HD 320946
        $reoperacao = $_POST['reop_gas'] == 'sim' ? 't' : 'f';
        $sql_r = "UPDATE tbl_os_extra SET reoperacao_gas = '" . $reoperacao . "' WHERE os = ". $os;
        $res_r = pg_query($con, $sql_r);
        $msg_erro = pg_errormessage($con);
        echo !empty($msg_erro) ? $msg_erro : '';
    }

    /* HD 882634 - Latinatec */
    if( $login_fabrica == 15 and !empty($_POST['serie_reoperado']) ){

        $serie_reoperado = $_POST['serie_reoperado'];

        $sql = "UPDATE
                    tbl_os_extra
                SET serie_justificativa = '$serie_reoperado'
                WHERE os = $os";
        $res = pg_query($con, $sql);
    }
    /* Fim - HD 882634 - Latinatec */

    //HD 196225: Exclui­ algumas linhas abaixo que estavam comentadas. Caso precise, verificar arquivo em não_sync com diff
    if (strlen($msg_erro) == 0) {

        //echo "FAZZ-validacao ";

        $valida_os_item = true;

		if($telecontrol_distrib) {
			if(!$add_peca) $valida_os_item = false;
		}
        if (in_array($login_fabrica, [141]) && $posto_interno) {
            $valida_os_item = false;
		}

        if (true === $valida_os_item) {
            $sql      = "SELECT fn_valida_os_item($os, $login_fabrica)";
            $res      = @pg_query($con,$sql);

            $msg_erro = pg_errormessage($con);

        }
        if($login_fabrica == 131 and $auditoria_os_pressure == 'true' and $add_peca == 'true') {
            $sql_verifica_aud = "SELECT tbl_peca.peca_critica
                                    FROM tbl_os
                                    JOIN tbl_os_produto ON tbl_os.os = tbl_os_produto.os
                                    JOIN tbl_os_item ON tbl_os_produto.os_produto = tbl_os_item.os_produto
                                    JOIN tbl_peca ON tbl_os_item.peca = tbl_peca.peca
                                    JOIN tbl_servico_realizado ON tbl_os_item.servico_realizado = tbl_servico_realizado.servico_realizado
                                    WHERE tbl_os.os = $os
                                    AND tbl_os.fabrica = $login_fabrica
                                    AND tbl_peca.peca_critica IS TRUE
                                    AND tbl_servico_realizado.gera_pedido IS TRUE
                                    AND tbl_os_item.pedido IS NULL";
            $res_verifica_aud = pg_query($con, $sql_verifica_aud);

            if(pg_num_rows($res_verifica_aud) > 0){
                $aud_peca_critica = pg_fetch_result($res_verifica_aud, 0, 'peca_critica');
            }

            if($aud_peca_critica == "t"){
                $sql_aud = "SELECT  status_os
                                FROM    tbl_os_status
                                WHERE   tbl_os_status.os = $os
                                AND     tbl_os_status.status_os IN (62, 19,64)
                                ORDER BY tbl_os_status.os_status DESC LIMIT 1";
                $res_aud = pg_query($con, $sql_aud);

                if(pg_num_rows($res_aud) > 0){
                    $statusAud = pg_fetch_result($res_aud, 0, 'status_os');
                }
                if($statusAud <> 62){
                    $insertAud = "INSERT INTO tbl_os_status (os, status_os, observacao)
                                    VALUES ($os, 62, 'OS com Peça crítica para garantia')";
                    $resInsertAud = pg_query($con, $insertAud);
                }
            }
        }

        if ($login_fabrica == 74 and strlen(trim($_POST['produto_serie'])) >0 AND 1 == 2) {

            $referencia = $_POST['produto_referencia'];

            $sql_numero_serie = "select numero_serie from tbl_numero_serie where serie= '".$_POST['produto_serie']."' and referencia_produto = '$referencia' and fabrica = $login_fabrica;";
            $res_numero_serie = pg_query($con, $sql_numero_serie);

            if(pg_num_rows($res_numero_serie)==0){
                $sql = "INSERT INTO tbl_os_status (os, status_os, observacao, fabrica_status)
                        VALUES($os,102,'Os em auditoria de Número de Série',$login_fabrica);";
                $query = @pg_query($con,$sql);
            }
        }

        if ($login_fabrica == 19 and strpos(pg_errormessage($con),"ERRO_VALOR_PECA_SUPERIOR") > 0) {
            $msg_alerta_peca = pg_errormessage($con);
        }

        //$msg_erro .= "SELECT fn_valida_os_item($os, $login_fabrica)";
        if (strlen($data_fechamento) > 0) {

            if (strlen($msg_erro) == 0) {

                    $sql = "UPDATE tbl_os SET data_fechamento = $xdata_fechamento
                            WHERE  tbl_os.os    = $os
                            AND    tbl_os.posto = $login_posto;";

                    $res = pg_query($con,$sql);
                    $msg_erro .= pg_errormessage($con);

                    $sql = "SELECT fn_finaliza_os($os, $login_fabrica)";
                    $res = pg_query($con,$sql);
                    $msg_erro = pg_errormessage($con);

            }

        }

    }

// echo "DÉC. TERCEIRO TESTE: ".$msg_erro;exit;
    if ($login_fabrica == 91) {
        $sql = "SELECT status_os FROM tbl_os_status WHERE os = {$os} ORDER BY os_status DESC LIMIT 1";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0) {
            $xstatus_os = pg_fetch_result($res, 0, "status_os");
        }

        if ($xstatus_os != 178) {
            $sql = "SELECT tbl_produto.produto_critico FROM tbl_os JOIN tbl_produto USING(produto) WHERE os = {$os} AND tbl_os.fabrica = {$login_fabrica}";
            $res = pg_query($con, $sql);

            if (pg_num_rows($res) > 0) {
              $produto_critico = pg_fetch_result($res, 0, "produto_critico");

                if ($produto_critico == "t") {
                    $sql = "INSERT INTO tbl_os_status (os, status_os, data, observacao) values ($os, 178, current_timestamp, 'OS com intervenção da fábrica')";
                    $res = pg_query ($con, $sql);
                }
            }
        }
    }

    if (!strlen($msg_erro) && in_array($login_fabrica, array(30,141,144))) {
        if ($necessita_troca_produto == "t") {
            if(in_array($login_fabrica,array(141,144))){
                $select = "SELECT status_os FROM tbl_os_status WHERE os = {$os} AND status_os IN(192,193,194) ORDER BY data DESC LIMIT 1";
                $result = pg_query($con, $select);

                $rows = pg_num_rows($result);

                if ($rows > 0) {
                    $status_os_troca_produto = pg_fetch_result($result, 0, "status_os");
                }

                if ($rows == 0 || ($status_os_troca_produto == 194)) {
                    $insert = "INSERT INTO tbl_os_status
                                (os, status_os, observacao)
                                VALUES
                                ({$os}, 192, 'OS com troca de produto em auditoria')";
                    $result = pg_query($con, $insert);

                    if (strlen(pg_last_error()) > 0) {
                        $msg_erro = "Erro ao lançar ordem de serviço";
                    }
                }
            }else{
                $sql = "
                    UPDATE  tbl_os
                    SET     justificativa_adicionais = '$motivo_troca'
                    WHERE   os = $os
                ";
                $res = pg_query($con,$sql);
                if(!pg_last_error($con)){
                    $parteNorte = array(
                        'AC',
                        'AL',
                        'AM',
                        'AP',
                        'BA',
                        'CE',
                        'MA',
                        'PA',
                        'PB',
                        'PE',
                        'PI',
                        'RN',
                        'RR',
                        'RO',
                        'SE',
                        'TO'
                    );

                    $parteSul = array(
                        'DF',
                        'ES',
                        'GO',
                        'MG',
                        'MT',
                        'MS',
                        'PR',
                        'RJ',
                        'RS',
                        'SC',
                        'SP'
                    );

                    $sqlUfPosto = "
                        SELECT  nome,
                                cnpj,
                                estado
                        FROM    tbl_posto
                        WHERE   posto = $login_posto
                    ";
                    $resUfPosto = pg_query($con,$sqlUfPosto);

                    $postoEmail = pg_fetch_result($resUfPosto,0,estado);
                    $postoNome  = pg_fetch_result($resUfPosto,0,nome);
                    $postoCnpj  = pg_fetch_result($resUfPosto,0,cnpj);

                    require "class/email/PHPMailer/PHPMailerAutoload.php";
                    $mailer = new PHPMailer;

                    $mailer->isSMTP();
                    $mailer->IsHTML();

                    $mailer->From = "no-reply@telecontrol.com.br";
                    $mailer->FromName = "Posvenda Telecontrol";

                    if(in_array($postoEmail,$parteNorte)){
                        $mailer->addAddress("sac.regional1@esmaltec.com.br","Regional NORTE Esmaltec");
                    }else if(in_array($postoEmail,$parteSul)){
                        $mailer->addAddress("sac.regional2@esmaltec.com.br","Regional SUL Esmaltec");
                    }
                    $mailer->Subject = "OS $os com Solicitação de Troca/Ressarcimento";
                    $msg = "Prezado(s),";
                    $msg .= "<br /><br />Favor, acessar o sistema para visualizar a solicitação de troca/ressarcimento da OS $os";
                    $msg .= "<br />Motivo: $motivo_troca";
                    $msg .= "<br />Posto: $postoNome";
                    $msg .= "<br />CNPJ: $postoCnpj";
                    $mailer->Body = $msg;

                    $mailer->Send();
                }
            }
        }
    }


    if (strlen($msg_erro) == 0 and $gravou_peca == "sim" and (in_array($login_fabrica, array(2,3,6,11,51,81,98,106,108,111,114,137,140,172)))) {

        // quando a peça estiver sob intervenção da assistencia técnica, $os_com_intervencao==t
        // então inseri um status 62 para bloquear a OS

        if($login_fabrica == 3 && $os_com_intervencao_display == 't'){

            $sql = "INSERT INTO tbl_os_status (os,status_os,data,observacao) values ($os,175,current_timestamp,'OS com intervenção de display')";
            $res = pg_query($con, $sql);

        }

        if (strlen($os_com_intervencao_display) == 0 && $os_com_intervencao == 't') {

            if ($telecontrol_distrib == "t") {

               \Posvenda\Helpers\Auditoria::gravar($os, 4, "Auditoria de Peça", "Em auditoria", $con);

            } else {

                // envia email teste para avisar
                $sql_intervencao = "SELECT sua_os,
                                           to_char(data_digitacao,'DD/MM/YYYY') AS data_digitacao,
                                           nome
                                      FROM tbl_os
                                      JOIN tbl_posto USING(posto)
                                     WHERE tbl_os.os = $os";

                $res_Y = pg_query($con,$sql_intervencao);

                $y_sua_os = pg_fetch_result($res_Y, 0, 'sua_os');
                $y_data   = pg_fetch_result($res_Y, 0, 'data_digitacao');
                $y_nome   = pg_fetch_result($res_Y, 0, 'nome');

                $sql_intervencao = "SELECT *
                                      FROM tbl_os_status
                                     WHERE os = $os
                                     ORDER BY data DESC LIMIT 1";

                $res_intervencao = pg_query($con, $sql_intervencao);
                $sql = "INSERT INTO tbl_os_status (os,status_os,data,observacao) values ($os,62,current_timestamp,'Peça da O.S. com intervenção da fábrica.')";

                if (pg_num_rows($res_intervencao) == 0) {

                    $res = pg_query($con,$sql);

                } else {

                    $status_os = pg_fetch_result($res_intervencao, 0, 'status_os');

                    if ($status_os != 62) {
                        $res = pg_query($con,$sql);
                    }

                }

            }

        } else if ($os_bloqueada_garantia == 't' and strlen($msg_erro) == 0) {

            // se a peça cadastrada estiver bloqueada para garantia, $os_bloqueada_garantia==t
            // então ele inseri o status 72 para bloquear a OS para o SAP
            // no caso se tiver peça bloqueada para garantia, deve justificar.

            if ($telecontrol_distrib == "t") {

               \Posvenda\Helpers\Auditoria::gravar($os, 4, "Peça boqueada para garantia", "Em auditoria", $con);

            } else {

                $sql_intervencao = "SELECT *
                                      FROM tbl_os_status
                                     WHERE os = $os
                                     ORDER BY data DESC LIMIT 1";

                $res_intervencao = pg_query($con, $sql_intervencao);

                $sql = "INSERT INTO tbl_os_status (os,status_os,data,observacao) values ($os,72,current_timestamp,'Peça da OS bloqueada para garantia')";

                if (pg_num_rows($res_intervencao)== 0) {

                    $res = pg_query($con,$sql);
                    $msg_erro .= pg_errormessage($con);

                } else {

                    $status_os = pg_fetch_result($res_intervencao,0,'status_os');

                    if ($status_os != 72) {

                        $res = pg_query($con,$sql);
                        $msg_erro .= pg_errormessage($con);

                    }

                }

            }

        } else if ( in_array($login_fabrica, array(11,172)) AND $intervencao_previsao == 't' and strlen($msg_erro) == 0) {

            \Posvenda\Helpers\Auditoria::gravar($os, 4, "Peça com previsão para entrega superior a 15 dias", "Em auditoria", $con);

        } else if ( in_array($login_fabrica, array(11,172)) AND $os_com_intervencao_suprimentos == 't') {

            if ($login_posto == 6359 OR $login_posto == 6945 OR $login_posto == 1967) {

                \Posvenda\Helpers\Auditoria::gravar($os, 4, "OS com intervenção de suprimentos", "Em auditoria", $con);

            }

        } else if ($login_fabrica == 3 AND $os_com_intervencao_carteira == 't') { /* 35521 */

            $sql_intervencao = "SELECT *
                                  FROM tbl_os_status
                                 WHERE os=$os
                                   AND status_os IN (116,117)
                                 ORDER BY data DESC LIMIT 1";

            $res_intervencao = pg_query($con, $sql_intervencao);

            $sql = "INSERT INTO tbl_os_status (os,status_os,data,observacao) values ($os,116,current_timestamp,'OS com intervenção de Carteira')";

            if (pg_num_rows($res_intervencao) == 0) {

                $res       = pg_query($con,$sql);
                $msg_erro .= pg_errormessage($con);

            } else {

                $status_os = pg_fetch_result($res_intervencao,0,'status_os');

                if ($status_os != 116) {

                    $res       = pg_query($con, $sql);
                    $msg_erro .= pg_errormessage($con);

                }

            }

        } else if(($login_fabrica == 137) AND $os_com_intervencao_carteira == 't'){

             $sql_intervencao = "SELECT *
                                  FROM tbl_os_status
                                 WHERE os=$os
                                   AND status_os IN (116,117)
                                 ORDER BY data DESC LIMIT 1";

            $res_intervencao = pg_query($con, $sql_intervencao);

            $sql = "INSERT INTO tbl_os_status (os,status_os,data,observacao) values ($os,116,current_timestamp,'OS com intervenção da Assistência Técnica da Fábrica')";

            if (pg_num_rows($res_intervencao) == 0) {

                $res       = pg_query($con,$sql);
                $msg_erro .= pg_errormessage($con);

            } else {

                $status_os = pg_fetch_result($res_intervencao,0,'status_os');

                if ($status_os != 116) {

                    $res       = pg_query($con, $sql);
                    $msg_erro .= pg_errormessage($con);

                }

            }

        } else if ($login_fabrica == 3) {

            $sqld = "SELECT current_date - data_abertura,
                            qtde_dias_intervencao_sap
                       FROM tbl_os
                  LEFT JOIN tbl_fabrica USING (fabrica)
                      WHERE os = $os";

            $resd = pg_query($con, $sqld);
            $data_aberturax = pg_fetch_result($resd,0,0);
            $qtde_dias_intervencao_sap = pg_fetch_result($resd, 0, 'qtde_dias_intervencao_sap');

            // HD 34210
            if ($data_aberturax >= $qtde_dias_intervencao_sap) {

                $sql_intervencao = "SELECT *
                                      FROM tbl_os_status
                                     WHERE os = $os
                                     ORDER BY data DESC LIMIT 1";

                $res_intervencao = pg_query($con,$sql_intervencao);

                $sql = "INSERT INTO tbl_os_status (os,status_os,data,observacao) values ($os,72,current_timestamp,'Pedido de Peças a mais de $qtde_dias_intervencao_sap dias.')";

                if (pg_num_rows($res_intervencao) == 0) {

                    $res = pg_query($con,$sql);
                    $msg_erro .= pg_errormessage($con);
                    $peca_mais_30_dias = 't';

                } else {

                    $status_os = pg_fetch_result($res_intervencao, 0, 'status_os');

                    if ($status_os != 72) {

                        $res = pg_query($con, $sql);
                        $msg_erro .= pg_errormessage($con);
                        $peca_mais_30_dias = 't';

                    }

                }

            }
        }

    }


    //HD 4291-Paulo
    if ($login_posto == 4311) {

        $prateleira_box = strtoupper(trim($_POST['prateleira_box']));

        if (strlen($prateleira_box) == 0) $prateleira_box = " ";
        if (strlen($msg_erro) == 0 and strlen($prateleira_box) > 0) {

            $sql= "UPDATE tbl_os
                      SET prateleira_box = '$prateleira_box'
                    WHERE os = $os
                        AND posto = $login_posto";

            $res = pg_query($con,$sql);

            $msg_erro .= pg_errormessage($con);

        }

    }

    if($login_fabrica == 137){
        $sql_linha_arge = "
            SELECT
                tbl_linha.linha
            FROM tbl_os
            JOIN tbl_produto ON tbl_produto.produto = tbl_os.produto
            JOIN tbl_linha ON tbl_produto.linha = tbl_linha.linha AND tbl_linha.nome = 'OSCILANTE'
            WHERE
                tbl_os.os = {$os}
        ";
        $res_linha_arge = pg_query($con, $sql_linha_arge);

        if(pg_num_rows($res_linha_arge) > 0){

            $qtde_pecas_intervencao = 5;
        }

    }

    //HD 255530: Colocar OS em intervenção para a Nova Computadores
    if ( ($login_fabrica == 43  || $qtde_pecas_intervencao > 0) && strlen($msg_erro) == 0) {
        //Verifica se a OS já está em intervenção
        //Seleciona o último status dentre os status de invervenção e verifica se
        //é diferente de 64 - Aprovado

        //HD 283312: Arrumei a query, estava errado na cláusula WHERE "AND os_status" estava "AND status_os" e na subquery também.

        $sql = "
        SELECT
        status_os

        FROM
        tbl_os_status

        WHERE
        os=$os
        AND os_status=(
            SELECT MAX(os_status)
            FROM tbl_os_status
            WHERE status_os IN (62,64,65,127)
            AND os=$os
        )
        AND status_os<>64
        ";
        //HD 283312: FIM
        $res = pg_query($con, $sql);
        //Se veio resultado, quer dizer que o último status de intervenção não é
        //64 - Aprovado, então já está em intervenção

        if (!pg_num_rows($res) || $qtde_pecas_intervencao > 0 || $login_fabrica == 114) {
            $nova_intervencao = "sim";

            $sql = "
            SELECT
            tbl_os_item.os_item

            FROM
            tbl_os_produto
            JOIN tbl_os_item ON tbl_os_produto.os_produto=tbl_os_item.os_produto
            JOIN tbl_servico_realizado ON tbl_os_item.servico_realizado=tbl_servico_realizado.servico_realizado

            WHERE
            tbl_os_produto.os=$os
            AND tbl_servico_realizado.gera_pedido IS TRUE
            AND tbl_os_item.pedido isnull
            ";

            if (in_array($login_fabrica, array(141, 144))) {
                 $sql = "SELECT tbl_os_item.os_item
                         FROM tbl_os_produto
                         JOIN tbl_os_item ON tbl_os_produto.os_produto = tbl_os_item.os_produto
                         JOIN tbl_servico_realizado ON tbl_os_item.servico_realizado = tbl_servico_realizado.servico_realizado
                         WHERE tbl_os_produto.os = $os
                         AND tbl_servico_realizado.troca_de_peca IS TRUE ";
            }

            $res = pg_query($con, $sql);

            if($qtde_pecas_intervencao > 0 AND !empty($nova_intervencao)){

                /*
                    HD 2551514 - Esmaltec - Início
                    Verificar se o último status da Os já não é o Status da Auditoria de Peças
                    Caso a OS já estiver em auditoria não grava nova alteração de status.
                    Apesar desse bloqueio normalmente o Posto não consegue lançar itens pois o botão some na consulta.
                */
                if (in_array($login_fabrica, array(30))) {
                    $tem_intervencao_pecas = false;

                    $sqlIntervencaoPecas = "
                        SELECT  COUNT(*)
                        FROM    tbl_os_status
                        JOIN    tbl_os USING(os)
                        WHERE   os          = $os
                        AND     os_status   IN (
                                    SELECT os_status
                                    FROM tbl_os_status
                                    WHERE os = $os
                              ORDER BY os_status DESC
                                    LIMIT 1
                                )
                        AND     status_os   IN (118)
                        AND     fabrica     = $login_fabrica;
                    ";
                    $resIntervencaoPecas = pg_query($con, $sqlIntervencaoPecas);
                    $conta = pg_fetch_result($resIntervencaoPecas, 0, 0);
                    if ($conta > 0) {
                        $tem_intervencao_pecas = true;
                    }
                }
                if (pg_num_rows($res) > $qtde_pecas_intervencao && (!in_array($login_fabrica, array(30,120,201,134)) || (in_array($login_fabrica, array(30)) && $tem_intervencao_pecas !== true))) {
                /*if (pg_num_rows($res) > $qtde_pecas_intervencao) {
                   HD 2551514 - Esmaltec - Fim*/
                    if(in_array($login_fabrica, array(46,72,114,104,122,123,124,125,127,128,129,131,132,136,137,140,141,144)) || $login_fabrica > 144 || ($login_fabrica == 30 && $login_tipo_posto != 501)){
                        $xstatus = 118;
                    }else{
                        if($login_tipo_posto != 501){
                            $xstatus = 62;
                        }
                    }
                    
                    if($login_fabrica == 30){
                        $sqlODefeito = "
                            SELECT  tbl_defeito_constatado.codigo AS tem_o_codigo
                            FROM    tbl_os_defeito_reclamado_constatado
                            JOIN    tbl_defeito_constatado  ON  tbl_defeito_constatado.defeito_constatado   = tbl_os_defeito_reclamado_constatado.defeito_constatado
                                                            AND tbl_defeito_constatado.codigo               = '000013'
                                                            AND tbl_os_defeito_reclamado_constatado.os      = $os
                        ";
                        $resODefeito = pg_query($con,$sqlODefeito);
                        $tem_o_codigo = pg_fetch_result($resODefeito,0,tem_o_codigo);
                        if($tem_o_codigo == '000013' || $login_tipo_posto == 501){
                            $grava_auditoria = "nao";
                        }else{
                            $grava_auditoria = "sim";
                        }
                    }else{
                        $grava_auditoria = "sim";
                    }

                    if ($mallory_posto_TOP === true) {
                        $grava_auditoria = "nao";
                    }

                    if($grava_auditoria == "sim"){
			
			if($login_fabrica == 104 || $telecontrol_distrib == "t"){
				$sql = "INSERT INTO tbl_auditoria_os(os,auditoria_status,observacao) 
						VALUES($os,4,'OS em auditoria de peças excedentes')";
			}else{
				$sql = "
				    INSERT INTO
					tbl_os_status (
					os,
					status_os,
					observacao,
					fabrica_status
				    )VALUES (
					$os,
					$xstatus,
					'OS com mais de $qtde_pecas_intervencao peças',
					$login_fabrica
				    )";
			}
// exit(nl2br($sql));
                        $res = pg_query($con, $sql);
                    }
                }

            }elseif (pg_num_rows($res) >= 3 and $status_os_vonder != 64) {
                $sql = "
                INSERT INTO
                tbl_os_status (
                os,
                status_os,
                observacao
                )

                VALUES (
                $os,
                62,
                'OS com mais de 3 peças'
                )
                ";
                $res = pg_query($con, $sql);
            }
            //Se não é intervenção por conta de ser com mais de 3 peças verifica
            //OS Reincidente com pedido da mesma peça da OS anterior
            elseif ($login_fabrica != 94) {
                $sql = "
                SELECT
                tbl_os_extra.os_reincidente

                FROM
                tbl_os
                JOIN tbl_os_extra ON tbl_os.os=tbl_os_extra.os

                WHERE
                tbl_os.os=$os
                AND tbl_os.os_reincidente IS TRUE
                AND tbl_os_extra.os_reincidente IS NOT NULL
                ";
                $res = pg_query($con, $sql);

                //É reincidente
                if (pg_num_rows($res) > 0) {
                    $os_reincidente = pg_result($res, 0, os_reincidente);

                    $sql = " SELECT tbl_os_item.os_item
                    FROM tbl_os_item
                    JOIN tbl_os_produto ON tbl_os_item.os_produto=tbl_os_produto.os_produto
                    JOIN tbl_servico_realizado ON tbl_servico_realizado.servico_realizado=tbl_os_item.servico_realizado
                         AND tbl_servico_realizado.gera_pedido IS TRUE
                    JOIN tbl_os_item AS os_item_reincidente ON tbl_os_item.peca=os_item_reincidente.peca
                    JOIN tbl_os_produto AS os_produto_reincidente ON os_item_reincidente.os_produto=os_produto_reincidente.os_produto
                    JOIN tbl_servico_realizado AS servico_realizado_reincidente ON os_item_reincidente.servico_realizado=servico_realizado_reincidente.servico_realizado
                         AND servico_realizado_reincidente.gera_pedido IS TRUE

                    WHERE tbl_os_produto.os=$os
                    AND os_produto_reincidente.os=$os_reincidente ";

                    $res = pg_query($con, $sql);

                    //A OS atual e a reincidente tem peças em comum
                    if (pg_num_rows($res) > 0) {

                        $sql = "INSERT INTO tbl_os_status (
                                    os,
                                    status_os,
                                    observacao
                                ) VALUES (
                                    $os,
                                    62,
                                    'OS reincidente e com pedido da mesma peça'
                                ) ";

                        $res = pg_query($con, $sql);

                    }

                }

            }

        }
        //Como está dentro de uma transaction, se der um erro o sistema vai retornar erros
        //para todos os demais comandos SQL
        if (pg_errormessage($con)) {
            $msg_erro = "Falha na rotina de intervenção de OS. Contate o fabricante.";
        }

    }

    if(in_array($login_fabrica,array(120,201,134)) AND strlen($msg_erro) == 0){ //hd_chamado=2517478

        $pecasAuditoria['os_liberada'] = true;

        if(in_array($login_fabrica,[120,201])){

            $sql = "SELECT tbl_auditoria_os.liberada, reprovada FROM tbl_auditoria_os
                        INNER JOIN tbl_auditoria_status ON tbl_auditoria_status.auditoria_status = tbl_auditoria_os.auditoria_status
                        WHERE os = {$os}
                        AND tbl_auditoria_os.auditoria_status = 4
                        ORDER BY data_input DESC LIMIT 1";
            $res = pg_query($con,$sql);

            if(pg_num_rows($res) > 0) {
                $liberada = pg_fetch_result($res,0,'liberada') ;
                $reprovada = pg_fetch_result($res,0,'reprovada') ;

                if(!empty($liberada) or !empty($reprovada)){
                    $pecasAuditoria['os_liberada'] = true;
                }else{
                    $pecasAuditoria['os_liberada'] = false;
                }
            }else{
                $pecasAuditoria['os_liberada'] = true;
            }

            $sql = "SELECT qtde_pecas_intervencao FROM tbl_fabrica WHERE fabrica = $login_fabrica";
            $res = pg_query($con, $sql);
            $pecasAuditoria['quantidade'] = (int)(pg_fetch_result($res,0, "qtde_pecas_intervencao"))-1;
            // $pecasAuditoria['servico_realizado'] = " AND 1=1";
        }else{
            $pecasAuditoria['quantidade'] = 0;
            $pecasAuditoria['servico_realizado'] = " AND tbl_servico_realizado.troca_de_peca IS TRUE " ;
        }

        //if($login_fabrica == 134){
        $sql = "SELECT tbl_os_item.os_item
                 FROM tbl_os_produto
                 JOIN tbl_os_item ON tbl_os_produto.os_produto = tbl_os_item.os_produto
                 JOIN tbl_servico_realizado ON tbl_os_item.servico_realizado = tbl_servico_realizado.servico_realizado
                 WHERE tbl_os_produto.os = $os
                 AND tbl_os_item.pedido isnull
                 ".$pecasAuditoria['servico_realizado'] ;
        $res = pg_query($con, $sql);

        if(pg_num_rows($res) > $pecasAuditoria['quantidade'] and $pecasAuditoria['os_liberada'] == true){          

           $sqlInsert ="INSERT INTO tbl_auditoria_os(
                        os,
                        auditoria_status,
                        observacao
                    )VALUES(
                        $os,
                        4,
                        'Auditoria de Pe&ccedil;a Excedente'
                    )";
            $resInsert = pg_query($con, $sqlInsert);

        }
    }
    //HD 255530 FIM

    //HD 416877 - INTERVENÇÃO FAMASTIL - 86 - gabrielSilva
    if (in_array($login_fabrica,array(86,115,116,117)) AND strlen($msg_erro) == 0) {

        if($login_fabrica == 115) {
            $contador = 0;         
            $x_auditoria = 0;  

            foreach ($arr_audit as $valor) {                
                if($_POST['peca_'.$contador] == $valor['referencia'] AND $_POST['servico_'.$contador] == $valor['servico_realizado']){                    
                    $x_auditoria++;                    
                }
                $contador++;                
            }
        }                

        if($login_fabrica == 115 AND $x_defeito_constatado == $_POST['defeito_constatado'] AND $x_auditoria == $contador) {                
            $sql_ins_status = "INSERT INTO tbl_os_status (
                        os,
                        status_os,
                        data,
                        observacao,                        
                        status_os_troca
                    ) VALUES (
                        $os,
                        64,
                        current_timestamp,
                        '',
                        false
                    )";

            $res_ins_status = pg_query($con, $sql_ins_status);
            $msg_erro       = pg_errormessage($con);                              
        } else {            
            $sql_status = "SELECT status_os_ultimo FROM tbl_os WHERE os={$os};";
            $res_status = pg_query($con, $sql_status);

            $status_os_ultimo = pg_fetch_result($res_status, 0, 'status_os_ultimo');

            if ($status_os_ultimo <> 62) {

                $sql_ins_status = " INSERT INTO tbl_os_status (
                                        os,
                                        status_os,
                                        data,
                                        observacao,
                                        status_os_troca
                                    ) VALUES (
                                        $os,
                                        62,
                                        current_timestamp,
                                        'OS com intervenção técnica',
                                        false
                                    )";

                $res_ins_status = pg_query($con, $sql_ins_status);
                $msg_erro       = pg_errormessage($con);
            }
        }
    }

    if ($login_fabrica == 96) {//HD 399700 : Para trocar o tipo de atendimento Bosch Security

        $tipo_atendimento = $_REQUEST['tipo_atendimento'];

        if (strlen($tipo_atendimento) > 0) {

            $sql = "UPDATE tbl_os SET tipo_atendimento = $tipo_atendimento WHERE os = $os";
            $res = pg_query($con, $sql);

        }

        if ($tipo_atendimento == 93) {

            //Insere um Motivo para OS Fora de Garantia
            $motivo = $_POST['motivo'];

            if (empty($motivo)) {
                $msg_erro = "Informe um Motivo";
            }

            if (strlen($msg_erro) == 0) {

                $sql = "UPDATE tbl_os_extra SET obs_nf = '".$motivo."' WHERE os = $os";
                $res = pg_query($con, $sql);

                $msg_erro = pg_errormessage($con);
                $msg_erro = !empty($msg_erro) ? $msg_erro : '';

            }

        }

    }

    if (strlen($msg_erro)==0) {
    if (in_array($login_fabrica,array(24,30,74,117))) {
         $sql= "SELECT fn_valida_os($os, $login_fabrica)";
         pg_query($con, $sql);
         $msg_erro .= pg_errormessage($con);

     }
     }

    if ($login_fabrica == 94 && strlen($msg_erro) == 0) {//HD 785254

        if (!empty($data_abertura)) {

            $sql = "SELECT data_abertura FROM tbl_os WHERE os = $os";
            $res = pg_query($con, $sql);

            $data_abertura2 = pg_fetch_result($res, 0, 'data_abertura');
            $data_abertura3 = implode('-',array_reverse(explode('/',$data_abertura)));

            if (strtotime($data_abertura3) > strtotime(date('Y-m-d'))) {

                $msg_erro = 'Data de Abertura não pode ser maior que a data de hoje!';

            } else if (strtotime($data_abertura3) < strtotime($data_abertura2)) {

                $msg_erro = 'Data de Abertura não pode ser menor que a data já cadastrada!';

            } else {
                $sql = "UPDATE tbl_os SET data_abertura = '$data_abertura3', data_digitacao = '" . $data_abertura3 . ' ' . date('H:i:s') . "' WHERE os = $os";
                $res = pg_query($con, $sql);
                $msg_erro = pg_errormessage($con);
            }

        }

    }

    if($login_fabrica == 6 AND $_POST['numero_correio']){
        $numero_correio = $_POST['numero_correio'];
        $sql = "UPDATE tbl_os_extra SET obs_adicionais = '$numero_correio' WHERE os = $os";
        $res = pg_query($con,$sql);
        $msg_erro = pg_errormessage($con);
    }

    if ($login_fabrica == 125 && strlen($msg_erro) == 0) {
        $qtde_pecas_criticas = $_POST["qtde_pecas_criticas"];

        //variavel para verificar se as imagens de todas as pecas criticas foram enviadas;
        $qtde_fotos_pecas_criticas = 0;

            //para cada item lançado, verifica se ha uma foto correspondente
            for ($i = 0; $i < $qtde_item; $i++) {

                    $referencia_peca = $_POST["peca_{$i}"];

                    //verifica se peca é critica
                    //verifica se peça é critica
                        $sqlPecaCritica = " SELECT  referencia
                                FROM tbl_peca
                                WHERE fabrica = $login_fabrica AND
                                      tbl_peca.referencia = '{$referencia_peca}' AND
                                      tbl_peca.peca_critica is true";
                        $resPecaCritica = pg_query($con, $sqlPecaCritica);
                    //se peça for critica e o serviço selecionado gerar pedido
                    if(pg_num_rows($resPecaCritica) > 0 && in_array($_POST["servico_".$i], array(10740,10741,10742)) ){

                        $os = $_POST["os"];
                        $descricao_peca = $_POST["descricao_{$i}"];
                        $ext = $_POST["peca_critica_ext_{$i}"];
                        if($amazonTC->ifObjectExists("peca_critica-{$os}-{$referencia_peca}-{$i}.{$ext}",true,"","") ){

                            $files[] = array(
                                "file_temp" => "peca_critica-{$os}-{$referencia_peca}-{$i}.{$ext}",
                                "file_new"  => "peca_critica-{$os}-{$referencia_peca}-{$i}.{$ext}"
                            );

                        }else{

                            $msg_upload .= "É obrigatório anexar todas as imagens das peças <br />";

                        }

                    }

            }

            if(strlen($msg_upload)==0){
                $files = array_filter($files);
                if(count($files) > 0){

                    if ($amazonTC->moveTempToBucket($files,"","") === false) {
                        $msg_erro = "Erro ao salvar arquivos, por favor tente novamente <br />";
                    }

                    foreach ($files as $key => $file) {
                        $nome_arquivo = $file["file_new"];
                        $link = $amazonTC->getLink($nome_arquivo, false, "", "");
                        if (!strlen($link)) {
                            $msg_erro .= "É obrigatório anexar todas as imagens das peças críticas <br />";
                        }
                    }
                }

            }else{
                $msg_erro .= "Deve ser enviada uma foto para cada peça crítica.";

            }
    }

    if ($login_fabrica == 3 && !strlen($msg_erro)) {
        $sql = "SELECT DATE_PART('YEAR', data_digitacao) AS year, DATE_PART('MONTH', data_digitacao) AS month
                FROM tbl_os
                WHERE fabrica = $login_fabrica
                AND os = $os";
        $res = pg_query($con, $sql);

        $year  = pg_fetch_result($res, 0, "year");
        $month = pg_fetch_result($res, 0, "month");
        for ($i = 0; $i < $qtde_item; $i++) {
            $xpeca    = $_POST["peca_{$i}"];
            $xservico = $_POST["servico_{$i}"];

            if ($xservico == 20) {
                unset($files);

                $qtde_fotos[$i] = $_POST["qtde_fotos_$i"];

                if ($qtde_fotos[$i] > 0) {
                    $foto_obg_erro = false;

                    for ($k = 0; $k < $qtde_fotos[$i]; $k++) {
                        if ($_POST["temp_uploaded_{$i}_{$k}"]) {
                           $temp_uploaded[$i][$k]["upload"] = $_POST["temp_uploaded_{$i}_{$k}"];
                           $temp_uploaded[$i][$k]["ext"]    = $_POST["temp_uploaded_ext_{$i}_{$k}"];

                            if ($temp_uploaded[$i][$k]["upload"] == "t") {
                                $ext = $temp_uploaded[$i][$k]["ext"];

                                $files[] = array(
                                    "file_temp" => "{$os}-{$xpeca}-{$i}-{$k}.{$ext}",
                                    "file_new"  => "{$os}-{$os_item_array[$i]}-{$k}.{$ext}"
                                );
                            }
                        }
                    }

                    if (count($files) > 0) {
                        if ($amazonTC->moveTempToBucket($files, $year, $month) === false) {
                            $msg_erro = "Erro ao salvar arquivos, por favor tente novamente <br />";
                            break;
                        }
                    }

                    foreach ($files as $key => $file) {
                        $nome_arquivo = $file["file_new"];

                        if (!strlen($amazonTC->getLink($nome_arquivo, false, $year, $month))) {
                            $msg_erro = "É obrigatório anexar todas as imagens das peças <br />";
                            break;
                        }
                    }
                }
            }
        }
    }
    if ($login_fabrica == 129) {
        unset($laudo_tecnico);

        $sql = "SELECT
                    tbl_posto.nome AS posto_nome,
                    tbl_os.data_abertura,
                    tbl_os.consumidor_nome,
                    tbl_os.consumidor_endereco || ' ' || tbl_os.consumidor_numero || ' ' || tbl_os.consumidor_complemento AS consumidor_endereco,
                    tbl_os.consumidor_cidade,
                    tbl_os.consumidor_estado,
                    tbl_os.consumidor_bairro,
                    tbl_os.consumidor_fone AS consumidor_telefone,
                    tbl_os.revenda_nome AS local_compra,
                    tbl_os.nota_fiscal,
                    tbl_os.data_nf,
                    tbl_os.tecnico_nome
                FROM tbl_os
                JOIN tbl_posto_fabrica ON tbl_posto_fabrica.fabrica = $login_fabrica AND tbl_posto_fabrica.posto = tbl_os.posto
                JOIN tbl_posto ON tbl_posto.posto = tbl_posto_fabrica.posto
                WHERE tbl_os.fabrica = $login_fabrica
                AND tbl_os.os = $os";
        $res = pg_query($con, $sql);

        $laudo_tecnico['laudo_tecnico_posto_nome']                              = pg_fetch_result($res, 0, "posto_nome");
        $laudo_tecnico['laudo_tecnico_posto_numero']                            = $_POST['laudo_tecnico_posto_numero'];
        $laudo_tecnico['laudo_tecnico_data_abertura']                           = pg_fetch_result($res, 0, "data_abertura");
        $laudo_tecnico['laudo_tecnico_cliente_nome']                            = pg_fetch_result($res, 0, "consumidor_nome");
        $laudo_tecnico['laudo_tecnico_cliente_endereco']                        = trim(addslashes(pg_fetch_result($res, 0, "consumidor_endereco")));
        $laudo_tecnico['laudo_tecnico_cliente_cidade']                          = pg_fetch_result($res, 0, "consumidor_cidade");
        $laudo_tecnico['laudo_tecnico_cliente_estado']                          = pg_fetch_result($res, 0, "consumidor_estado");
        $laudo_tecnico['laudo_tecnico_cliente_bairro']                          = addslashes(pg_fetch_result($res, 0, "consumidor_bairro"));
        $laudo_tecnico['laudo_tecnico_cliente_telefone']                        = pg_fetch_result($res, 0, "consumidor_telefone");
        $laudo_tecnico['laudo_tecnico_local_compra']                            = pg_fetch_result($res, 0, "local_compra");
        $laudo_tecnico['laudo_tecnico_nota_fiscal']                             = pg_fetch_result($res, 0, "nota_fiscal");
        $laudo_tecnico['laudo_tecnico_nota_fiscal_data']                        = pg_fetch_result($res, 0, "data_nf");
        $laudo_tecnico['laudo_tecnico_data_instalado']                          = $_POST['laudo_tecnico_data_instalado'];
        $laudo_tecnico['laudo_tecnico_instaladora_nome']                        = $_POST['laudo_tecnico_instaladora_nome'];
        $laudo_tecnico['laudo_tecnico_agua_utilizada']                          = $_POST['laudo_tecnico_agua_utilizada'];
        $laudo_tecnico['laudo_tecnico_pressurizador']                           = $_POST['laudo_tecnico_pressurizador'];
        $laudo_tecnico['laudo_tecnico_tensao']                                  = $_POST['laudo_tecnico_tensao'];
        $laudo_tecnico['laudo_tecnico_tipo_gas']                                = $_POST['laudo_tecnico_tipo_gas'];
        $laudo_tecnico['laudo_tecnico_gas_glp']                                 = $_POST['laudo_tecnico_gas_glp'];
        $laudo_tecnico['laudo_tecnico_pressao_gas_dinamica']                    = $_POST['laudo_tecnico_pressao_gas_dinamica'];
        $laudo_tecnico['laudo_tecnico_pressao_gas_estatica']                    = $_POST['laudo_tecnico_pressao_gas_estatica'];
        $laudo_tecnico['laudo_tecnico_pressao_agua_dinamica']                   = $_POST['laudo_tecnico_pressao_agua_dinamica'];
        $laudo_tecnico['laudo_tecnico_pressao_agua_estatica']                   = $_POST['laudo_tecnico_pressao_agua_estatica'];
        $laudo_tecnico['laudo_tecnico_diametro_duto']                           = $_POST['laudo_tecnico_diametro_duto'];
        $laudo_tecnico['laudo_tecnico_comprimento_total_duto']                  = $_POST['laudo_tecnico_comprimento_total_duto'];
        $laudo_tecnico['laudo_tecnico_quantidade_curvas']                       = $_POST['laudo_tecnico_quantidade_curvas'];
        $laudo_tecnico['laudo_tecnico_caracteristica_local_instalacao']         = $_POST['laudo_tecnico_caracteristica_local_instalacao'];
        $laudo_tecnico['laudo_tecnico_local_instalacao_interno_ambiente']       = $_POST['laudo_tecnico_local_instalacao_interno_ambiente'];
        $laudo_tecnico['laudo_tecnico_local_instalacao_interno_ambiente_outro'] = $_POST['laudo_tecnico_local_instalacao_interno_ambiente_outro'];
        $laudo_tecnico['laudo_tecnico_instalacao_nbr']                          = $_POST['laudo_tecnico_instalacao_nbr'];
        $laudo_tecnico['laudo_tecnico_problema_diagnosticado']                  = $_POST['laudo_tecnico_problema_diagnosticado'];
        $laudo_tecnico['laudo_tecnico_providencias_adotadas']                   = $_POST['laudo_tecnico_providencias_adotadas'];
        $laudo_tecnico['laudo_tecnico_tecnico_nome']                            = pg_fetch_result($res, 0, "tecnico_nome");

        $x = 0;
        if(!strlen($msg_erro)){
        foreach ($laudo_tecnico as $key => $value) {
        if($value){
                $sqlLT = "SELECT laudo_tecnico_os
                          FROM tbl_laudo_tecnico_os
                          WHERE fabrica = $login_fabrica
                          AND os = $os
                          AND titulo = '$key'";
                $resLT = pg_query($con, $sqlLT);
                if (pg_num_rows($resLT) > 0) {
                    $sql = "UPDATE tbl_laudo_tecnico_os
                            SET
                                observacao = '$value'
                            WHERE fabrica = $login_fabrica
                            AND os = $os
                            AND titulo = '$key'";
                } else {
                    $sql = "INSERT INTO tbl_laudo_tecnico_os
                                (titulo, os, observacao, fabrica, ordem)
                            VALUES
                                ('$key', $os, '$value', $login_fabrica, $x)";
                }

                $res = pg_query($con, $sql);

        $x++;
        }
            }
        }
    }

    if(empty($msg_erro) && $login_fabrica == 140){

        if(count($pecas_importadas) > 0){

            include_once "class/log/log.class.php";
            $email_info = new Log();

            $email_info->adicionaLog(array("titulo" => "Lista solicitada de Peças Importadas pelo Posto - {$posto_nome}"));

            $relacao_pecas = "<table cellpadding='5'>";
            $relacao_pecas .= "
                                <tr>
                                    <th colspan='6' align='center' bgcolor='#e8e8e8'>Relação de Peças Importadas</th>
                                </tr>
                                <tr>
                                    <th>Referência</th>
                                    <th>Descrição</th>
                                    <th>Posto</th>
                                    <th>Pedido</th>
                                    <th>Tipo Pedido</th>
                                    <th>OS</th>
                                </tr>
                            ";

            for ($i = 0; $i < count($pecas_importadas); $i++) {

                $info_pecas = $pecas_importadas[$i];

                $referencia     = $info_pecas['referencia'];
                $descricao      = $info_pecas['descricao'];
                $posto          = $info_pecas['posto'];
                $pedido         = $info_pecas['pedido'];
                $tipo_pedido    = $info_pecas['tipo_pedido'];
                $os             = $info_pecas['os'];

                $relacao_pecas .= "
                                <tr>
                                    <td>{$referencia}</td>
                                    <td>{$descricao}</td>
                                    <td>{$posto}</td>
                                    <td>{$pedido}</td>
                                    <td>{$tipo_pedido}</td>
                                    <td>{$os}</td>
                                </tr>
                            ";

            }

            $relacao_pecas .= "</table>";

            $email_info->adicionaLog($relacao_pecas);

            $email_info->adicionaLog("linha");
            $email_info->adicionaLog("<b>Data: ".date("d/m/Y H:i:s")."</b>");

            $email_info->adicionaTituloEmail("Conserto do Produto na OS Lavor - ".$os);

            $ip_devel = $_SERVER['REMOTE_ADDR'];
            if($ip_devel == "179.233.213.77"){
                $email_info->adicionaEmail("guilherme.silva@telecontrol.com.br");
            }else{
                $email_info->adicionaEmail("lucas.alves@lavorwash.com.br");
                $email_info->adicionaEmail("astec.gr@lavorwash.com.br");
                $email_info->adicionaEmail("trombini.wainer@lavorwash.com.br");
            }

            $email_info->enviaEmails();

        }

    }

    if($login_fabrica == 30 and empty($msg_erro)){
        $sql_hd = "SELECT hd_chamado FROM tbl_os WHERE os = {$os}";
        $res_hd = pg_query($con,$sql_hd);
        $hd_chamado = pg_fetch_result($res_hd, 0, 'hd_chamado');

        /*if(!empty($hd_chamado)){
            //$msg_erro = verificaAlteracaoDadosAtendimento($hd_chamado,$os,"os_item");
        }*/

        if (strlen($msg_erro) == 0 && count($linhaPecaDuplicada) > 0) {
            $sqlVerAudit = "SELECT liberada, reprovada FROM tbl_auditoria_os WHERE os = {$os}
                            AND auditoria_status = 4
                            AND observacao ='OS com quantidade de peças maior do que a lista básica do produto.'
                            order by auditoria_os desc limit 1 ;";
            $resVerAudit = pg_query($con, $sqlVerAudit);
            $auditar = false;
            if(pg_num_rows($resVerAudit) > 0) {
                $reprovada_auditoria = pg_fetch_result($resVerAudit,0,'reprovada');
                $liberada_auditoria  = pg_fetch_result($resVerAudit,0,'liberada');
                if(!empty($reprovada_auditoria) or !empty($liberada_auditoria)) $auditar = true;
            }else{
                $auditar = true;
            }

            if ($auditar) {
                $pecasVerif = array_keys($linhaPecaDuplicada);
                $passou = 0;
                foreach($pecasVerif as $verifPeca){
                    $qtdeCompara = array_sum($dadosPecasDuplicadas[$verifPeca]);

                    $sql = "
                        SELECT  tbl_lista_basica.qtde
                        FROM    tbl_lista_basica
                        JOIN    tbl_peca        USING(peca)
                        JOIN    tbl_os_item     USING(peca)
                        JOIN    tbl_os_produto  ON  tbl_os_produto.os_produto   = tbl_os_item.os_produto
                                                AND tbl_os_produto.produto      = tbl_lista_basica.produto
                        JOIN    tbl_os          USING(os)
                        JOIN    tbl_servico_realizado USING(servico_realizado)
                        WHERE   tbl_peca.referencia = '$verifPeca'
                        AND     tbl_os.os           = $os
                        AND     tbl_servico_realizado.gera_pedido IS TRUE
                        AND     tbl_os_item.pedido IS NULL
                        AND     tbl_os_item.obs <> ''
                    ";
                    $res = pg_query($con,$sql);

                    if(pg_num_rows($res) > 0){
                        $qtdeLista = pg_fetch_result($res,0,qtde);

                        if($qtdeCompara > $qtdeLista){
                            $passou++;
                        }
                    }
                }

                if($passou > 0){
                    $sqlInsAudit = "INSERT INTO tbl_auditoria_os (os, auditoria_status, observacao)
                                            VALUES ({$os}, 4, 'OS com quantidade de peças maior do que a lista básica do produto.');";
                    $resInsAudit = pg_query($con, $sqlInsAudit);
                    if (strlen(pg_last_error($con)) > 0) {
                        $msg_erro = "Ocorreu um erro na gravação dos dados da OS (AUDITORIA OS).";
                    }
                }
            }
        }
    }

    if ($login_fabrica == 19 && empty($msg_erro)) {
        $sql_qtde = "SELECT peca
                     FROM tbl_os_item
                     JOIN tbl_os_produto ON tbl_os_produto.os_produto = tbl_os_item.os_produto
                     WHERE tbl_os_produto.os = {$os}
                     AND tbl_os_item.fabrica_i = {$login_fabrica}
                     ";
        $res_qtde = pg_query($con, $sql_qtde);

        $string_defeitos = str_replace(
                                array("[","]","\""),
                                array("", "", ""),
                                $_POST["defeitos_lorenzetti_hidden"]
                            );
        $array_defeitos_selecionados  = explode(",",$string_defeitos);

        for ($x = 0;$x < pg_num_rows($res_qtde);$x++) {
            $peca_referencia_integridade            = $_POST["peca_".$x];
            $peca_descricao_integridade             = $_POST["descricao_".$x];

            $sql_peca = "SELECT peca
                         FROM tbl_peca
                         WHERE referencia = '{$peca_referencia_integridade}'
                         AND fabrica = $login_fabrica";
            $res_peca = pg_query($sql_peca);

            $peca_id = pg_fetch_result($res_peca, 0, 'peca');

            if (!empty($peca_id)) {

                $sql_integridade = "SELECT defeito_constatado
                                    FROM tbl_peca_defeito_constatado
                                    WHERE peca  = {$peca_id}
                                    AND fabrica = {$login_fabrica}
                                    ";
                $res_integridade = pg_query($con, $sql_integridade);

                if (pg_num_rows($res_integridade) > 0) {
                    for ($i=0;$i<pg_num_rows($res_integridade);$i++) {
                        $defeito_constatado_peca[] = pg_fetch_result($res_integridade, $i, 'defeito_constatado');
                    }

                    $defeitos_iguais         = array_intersect($defeito_constatado_peca, $array_defeitos_selecionados);


                    /*
                    Kaique 18/01/2018 hd-4039612
                    Foi criada uma trava para não deixar gravar a OS caso a peça não pertença a algum dos defeitos constatados.
                    Essa trava vai entrar em ação apenas quando ocorrer algum erro, ou o posto tentar
                    burlar a regra de alguma forma.
                    */
                    if (count($defeitos_iguais) == 0) {
                        $msg_erro .= "<br />A peça {$peca_referencia_integridade} - {$peca_descricao_integridade} não pertence ao(s) defeito(s) selecionado(s)";
                    }
                }
            }
        }
    }
  
    if (strlen($msg_erro) == 0) {

        if ($login_fabrica == 24 && $_POST['qtde_peca_lancada'] > 3) {
            $sql_aud_peca = "SELECT auditoria_os FROM tbl_auditoria_os WHERE os = $os AND liberada IS NULL AND cancelada IS NULL AND reprovada IS NULL";
            $res_aud_peca = pg_query($con, $sql_aud_peca);
            if (pg_num_rows($res_aud_peca) == 0) {
                $sqlInsAudit = "INSERT INTO tbl_auditoria_os (os,auditoria_status,observacao) VALUES ({$os},4,'Quantidade de peça lançada acima da quantidade permitida.')";
                $resInsAudit = pg_query($con, $sqlInsAudit);
                if (pg_last_error()) {
                    $msg_erro = "Ocorreu um erro na gravação da auditoria (AUDITORIA OS).";
                }
            }
        }

            if($login_fabrica == 134){
                $sqlx = "SELECT fn_calcula_os_thermosystem($os,$login_fabrica);";
                $res = pg_query($con,$sqlx);
                $msg_erro = pg_errormessage($con);
            }

        if ( in_array($login_fabrica, array(3,11,126,137,172)) ) {

            if (count($arrFilesUpload) > 0) {
                if ($amazonTC->moveTempToBucket($arrFilesUpload, $year, $month) === false) {
                    $msg_erro = "Erro ao salvar arquivos, por favor tente novamente <br />";
                    $erro_upload = "true";
                }
            }

        }

        if( $tipo_atendimento <> 93 && !$telecontrol_distrib) {
            $sqlB = "UPDATE tbl_os SET status_checkpoint=fn_os_status_checkpoint_os(os)
                    WHERE os = $os
                    AND status_checkpoint<>fn_os_status_checkpoint_os(os)";
                    $res = pg_query($con,$sqlB);
                    $msg_erro .= pg_errormessage($con);
        }



        //Remoção da OS congelada da Suggar
        if ($login_fabrica == 24) {
            $sql_f = "UPDATE tbl_os_campo_extra SET os_bloqueada = FALSE
                            WHERE os = $os
                            AND fabrica = $login_fabrica;";
            $res_f = pg_query($con,$sql_f);
            $msg_erro .= pg_errormessage($con);
        }

        if($login_fabrica == 50){ //HD-3321672
            if(strlen(trim($produto_serie)) > 0){
                $sqlSserie = "SELECT serie
                            FROM tbl_numero_serie
                            JOIN tbl_produto ON tbl_produto.produto = tbl_numero_serie.produto
                            WHERE serie = '$produto_serie'
                            AND referencia = '$xproduto'
                            AND fabrica = $login_fabrica";
                $resSserie = pg_query($con, $sqlSserie);
                $msg_erro .= pg_last_error($con);
                if(pg_num_rows($resSserie) == 0){
                    $sql_update = "UPDATE tbl_os set serie_reoperado = $produto_serie WHERE os = $os AND fabrica = $login_fabrica";
                    $res_update = pg_query($con, $sql_update);
                    $msg_erro .= pg_last_error($con);
                }else{
                    $sql_update = "UPDATE tbl_os set serie_reoperado = null WHERE os = $os AND fabrica = $login_fabrica";
                    $res_update = pg_query($con, $sql_update);
                    $msg_erro .= pg_last_error($con);
                }
            }
        }

//         if ($login_fabrica == 30) { //Verifica se OS esta em auditoria de carência
//             $sqlAuditoria = "SELECT os FROM tbl_auditoria_os WHERE os = $os AND auditoria_status = 1 AND liberada IS NOT NULL;";
//             $resAuditoria = pg_query($con, $sqlAuditoria);
//             if (pg_num_rows($resAuditoria) > 0) {
//                 $sqlAuditoria = " UPDATE tbl_auditoria_os SET liberada = null WHERE os = $os AND auditoria_status = 1";
//                 $resAuditoria = pg_query($con, $sqlAuditoria);
//                 $msg_erro .= pg_last_error($con);
//             }
//         }

        $tipo_os = "SELECT tipo_os_cortesia FROM tbl_os WHERE os = {$os}";

        $res_tipo_os = pg_query($con, $tipo_os);
        
        $os_cortesia = pg_fetch_result($res_tipo_os, 0, tipo_os_cortesia);

        if ($login_fabrica == 42 && $prestacao_servico == 't' && $os_cortesia != 'OS Cortesia') {
            $sqlOsAbertas = "SELECT count(tbl_os.os) total
                               FROM tbl_os
                              WHERE tbl_os.fabrica={$login_fabrica}
                                AND tbl_os.posto={$login_posto }
                                AND tbl_os.data_abertura BETWEEN '".date('Y-m-01')." 00:00:00' AND '".date('Y-m-t')." 23:59:59'";
            $resOsAbertas = pg_query($con, $sqlOsAbertas);

            $sqlOsMedia = "SELECT (qtde_media*2) qtde_media
                             FROM tbl_posto_media_atendimento
                            WHERE fabrica={$login_fabrica}
                              AND posto={$login_posto}
                            LIMIT 1;";
            $resOsMedia = pg_query($con, $sqlOsMedia);

            $mediaOs   = pg_fetch_result($resOsMedia, 0, 'qtde_media');
            $total_os_aberta_mes_atual   = pg_fetch_result($resOsAbertas, 0, 'total');

            if ($total_os_aberta_mes_atual > $mediaOs) {
                $sqlAud = "SELECT os
                            FROM tbl_os_produto
                            JOIN tbl_os_item USING(os_produto)
                            WHERE os = $os
                            AND digitacao_item::date=current_date
                            and pedido isnull";
                $resItem = pg_query($con, $sqlAud);

                $sqlAud = "SELECT os,liberada, reprovada
                            FROM tbl_auditoria_os
                            WHERE os = $os";
                $resAud = pg_query($con, $sqlAud);
                if(pg_num_rows($resAud) > 0) {
                    $liberada = pg_fetch_result($resAud, 0, 'liberada');
                    $reprovada = pg_fetch_result($resAud, 0, 'reprovada');
                }

                if((pg_num_rows($resAud) == 0 or !empty($reprovada)) and pg_num_rows($resItem) > 0) {
                    $sqlInsAudit = "INSERT INTO tbl_auditoria_os (os,auditoria_status,observacao) 
                    VALUES ({$os},6,'Quantidade de OSs abertas no mês atual é maior que o dobro da média.');";

                    $resInsAudit = pg_query($con, $sqlInsAudit);
                    
                    if (strlen(pg_last_error($con)) > 0) {
                        $msg_erro = "Ocorreu um erro na gravação dos dados da OS (AUDITORIA OS).";
                    }
                }
            }

        }
        
        if ($login_fabrica == 42 && $os_cortesia == 'OS Cortesia' && strlen($os) > 0) {
            
            /*
             * - Verifica se OS já
             * se encontra em auditoria
             */

            $sqlConta = "
                SELECT  COUNT(1) AS verifica_auditoria
                FROM    tbl_auditoria_os
                JOIN    tbl_os USING (os)
                WHERE   tbl_os.os                           = $os
                AND     tbl_os.cortesia                     IS TRUE
                AND     tbl_auditoria_os.auditoria_status   = 6
                AND     (
                            tbl_auditoria_os.liberada    IS NULL
                        OR  tbl_auditoria_os.cancelada   IS NULL
                        OR  tbl_auditoria_os.reprovada   IS NULL
                        )
            ";
           

            $resConta = pg_query($con,$sqlConta);

            $verifica_auditoria = pg_fetch_result($resConta,0,verifica_auditoria);

            /** verificação se a os tem pecas */
     
            $verifica_peca = 0;
            
            if (!empty($_POST['peca_0'])) {
                $verifica_peca = 1;
            }

            /** 
             * @author William Castro 
             */
            if ($verifica_auditoria == 0 && $verifica_peca > 0) {                
                /* Gravação da Auditoria da OS */
                $sqlInsAud = "INSERT INTO tbl_auditoria_os (os,auditoria_status,observacao) VALUES ($os,6,'Auditoria de Solicitação de Cortesia Comercial')";
                
                $resInsAud = pg_query($con,$sqlInsAud);

                if (strlen(pg_last_error($con)) > 0) {
                    $msg_erro .= "Ocorreu um erro na gravação dos dados da OS (AUDITORIA OS).";
                }
            }

        } 

        if (strlen(trim($msg_erro)) == 0) {
            if ($login_fabrica == 24) {
                $sql_7 = "SELECT os, campos_adicionais FROM tbl_os_campo_extra WHERE os = {$os} AND fabrica = {$login_fabrica} AND JSON_FIELD('os_7_dias_sem_peca', campos_adicionais) = 'true'";
                $res_7 = pg_query($con, $sql_7);
                if (pg_num_rows($res_7) > 0) {
                    $campos_add = json_decode(pg_fetch_result($res_7, 0, 'campos_adicionais'), true);

                    unset($campos_add['mensagem_os']);
                    unset($campos_add['os_7_dias_sem_peca']);

                    if (count($campos_add) == 0) {
                        $campos_add = '{}';
                    } else {
                        $campos_add = json_encode($campos_add);
                    }

                    $sql_up = "UPDATE tbl_os_campo_extra SET campos_adicionais = '$campos_add' WHERE fabrica = $login_fabrica AND os = $os";
                    $res_up = pg_query($con, $sql_up);

                    if (pg_last_error()) {
                        $msg_erro .= "Ocorreu um erro ao gravar OS.";       
                    }
                }
            }
        }

        if (strlen($msg_erro) == 0) {

            if (in_array($login_fabrica, [141]) && $qtde_item > 0 && $consumidor_revenda == 'R') {

                $sqlUltimaOs = "SELECT  tbl_os.os,
                                        tbl_hd_chamado_extra.email,
                                        tbl_os.os_numero
                                FROM tbl_os
                                JOIN tbl_os_revenda ON tbl_os_revenda.os_revenda = tbl_os.os_numero
                                JOIN tbl_hd_chamado_extra USING(os)
                                WHERE 
                                (
                                    SELECT os_numero FROM tbl_os
                                    WHERE os = {$os}
                                    LIMIT 1
                                ) = tbl_os.os_numero
                                ORDER BY tbl_os.os_sequencia DESC
                                LIMIT 1";
                $resUltimaOs = pg_query($con, $sqlUltimaOs);

                $sua_os_pesquisa   = pg_fetch_result($resUltimaOs, 0, 'os_numero');
                $ultimaOsRevenda   = pg_fetch_result($resUltimaOs, 0, 'os');

                if (pg_num_rows($resUltimaOs) > 0 && $ultimaOsRevenda == $os) {

                    $email_atendimento = pg_fetch_result($resUltimaOs, 0, 'email');
                    
                    $assunto = "Serviço de Atendimento UNICOBA";
                    $mensagem = "Ordem de serviço {$sua_os_pesquisa} de revenda foi analisada pela fábrica e está aguardando reparo";

                    if(strlen(trim($email_atendimento))>0){
                        
                        $mailTc = new TcComm('smtp@posvenda');


                        $mailTc->sendMail(
                            $email_atendimento,
                            $assunto,
                            $mensagem,
                            'noreply@telecontrol.com.br'
                        );
                    }

                }
            }

            $res = pg_query($con,"COMMIT TRANSACTION");


            // /echo "<pre>"; print_r($auditorLog); echo "</ pre>"; die;
            if ($login_fabrica == 91) {

                $audProd->retornaDadosSelect("SELECT DISTINCT tbl_os_produto.os_produto,
                                            tbl_os.os,
                                            tbl_os.causa_defeito,
                                            tbl_os_produto.produto,
                                            tbl_os.serie
                                    FROM    tbl_os_produto
                                    JOIN    tbl_os USING(os)
                                    WHERE   tbl_os.os = {$os}")
                    ->enviarLog($query_action,'tbl_os_produto',$login_fabrica."*".$os);

                $audItem->retornaDadosSelect("SELECT tbl_os_item.os_item, tbl_os_item.peca,
                                                    tbl_os_item.qtde,
                                                    tbl_os_item.servico_realizado,
                                                    tbl_os_item.defeito,
                                                    tbl_os_item.parametros_adicionais,
                                                    tbl_os_item.admin,
                                                    tbl_os_item.peca_obrigatoria as devolucao_obrigatoria,
                                                    tbl_os_item.fornecedor
                                            FROM    tbl_os_item
                                            JOIN    tbl_os_produto  USING(os_produto)
                                            JOIN    tbl_os          USING(OS)
                                            WHERE   tbl_os.os = $os")
                    ->enviarLog($query_action,'tbl_os_item',$login_fabrica."*".$os);

                $audOs->retornaDadosSelect("SELECT os,
                            defeito_reclamado,
                            defeito_constatado,
                            solucao_os as solucao,
                            obs
                            from tbl_os
                            where os = {$os}")->enviarLog($query_action,'tbl_os',$login_fabrica."*".$os);
            } else {
                $auditorLog->retornaDadosSelect()->enviarLog('update', "tbl_os", $login_fabrica."*".$os);
            }

            if ($login_fabrica == 104 && empty($msg_erro) && count($pecas_lancadas) > 0) {
                $helper = new \Posvenda\Helpers\Os();

                $sql_posto = "SELECT nome FROM tbl_posto WHERE posto = $login_posto";
                $qry_posto = pg_query($con, $sql_posto);
                $nome_posto = pg_fetch_result($qry_posto, 0, 'nome');

                $msg_pecas_os = "Produto Vonder. Informamos que para a OS {$os} foi solicitado a(s) peça(s) ";
                $msg_pecas_os .= implode(", ", $pecas_lancadas);
                $msg_pecas_os .= " para o conserto do produto {$produto_os}. Favor Aguardar";

                if (!empty($consumidor_email)) {
                    $helper->comunicaConsumidor($consumidor_email, $msg_pecas_os);
                }

                if (!empty($consumidor_celular)) {
                    $status_sms = $helper->comunicaConsumidor($consumidor_celular, $msg_pecas_os,$login_fabrica, $os);
                }
            }

            if (in_array($defeito_constatado, array('20934', '24160'))) {
                $ins = "INSERT INTO tbl_os_status (os, status_os, observacao) VALUES ($os, 20, 'OS em análise pelo fabricante')";
                $qry = pg_query($con, $ins);
            }

            if ($telecontrol_distrib && !isset($novaTelaOs)) {

                $sql = "SELECT tbl_os_item.os_item
                        FROM tbl_os
                        JOIN tbl_os_produto ON tbl_os_produto.os = tbl_os.os
                        JOIN tbl_os_item ON tbl_os_item.os_produto = tbl_os_produto.os_produto
                        WHERE tbl_os.os = {$os}";
                $res = pg_query($con, $sql);

                if (pg_num_rows($res) == 0) {
                    atualiza_status_checkpoint($os, 'Aguardando Analise');
                }

            }

            validaIntervencao($os);
        }else {
            $res = pg_query ($con,"ROLLBACK TRANSACTION");
        }

        if(!empty($total_orcamento) and !empty($total_horas) and $login_fabrica == 96) {
            $sql_admin = "SELECT admin, cliente_admin FROM tbl_os WHERE os = $os";
            $res_admin = pg_query ($con,$sql_admin);

            if (pg_num_rows ($res_admin) > 0){
                $cliente_admin = pg_fetch_result($res_admin,0,cliente_admin);
                $admin = pg_fetch_result($res_admin,0,admin);

                if(strlen($admin) > 0)
                    $sql_email = "SELECT nome_completo AS nome, email FROM tbl_admin WHERE fabrica = $login_fabrica AND admin = $admin";
                else
                    $sql_email = "SELECT nome, email FROM tbl_cliente_admin WHERE fabrica = $login_fabrica AND cliente_admin = $cliente_admin";

                $res_email = pg_query($con,$sql_email);

                $cliente_email = strtolower(pg_fetch_result($res_email,0,email));
                $nome_completo = pg_fetch_result($res_email,0,nome);

                if(strlen($cliente_email) > 0){
                                $remetente    = "Suporte <helpdesk@telecontrol.com.br>";
                                $destinatario = $cliente_email;

                                $assunto      = "Orçamento - {$os}\n";
                                $mensagem     = "Prezado(a) {$nome_completo}\n";
                                $mensagem    .="<br /><br />Foi cadastrado um novo orçamento no sistema - <a href='/assist/os_press.php?os=$os' target='_blank'>{$os}</a>\n";
                                $mensagem    .="<br /><br />----------\n";
                                $mensagem    .="<br />Atenciosamente,\n";
                                $mensagem    .="<br />Suporte Telecontrol\n";
                                $mensagem    .="<br />www.telecontrol.com.br\n";
                                $mensagem    .="<br /><b>Esta é uma mensagem automática, não responda este e-mail.</b>\n";
                                $headers="Return-Path: <helpdesk@telecontrol.com.br>\nFrom:".$remetente."\nContent-type: text/html\n";

                                mail($destinatario, utf8_encode($assunto), utf8_encode($mensagem), $headers);
                }
            }

        }

        if($login_fabrica == 140){

            if($entrega_tecnica == "t"){

                if($_FILES['laudo_tecnico']['size'] > 0){

                    $s3 = new AmazonTC('inspecao', $login_fabrica);
                    $laudo_tecnico = $_FILES['laudo_tecnico'];

                    $types = array("png", "jpg", "jpeg", "bmp", "pdf");
                    $type  = strtolower(preg_replace("/.+\//", "", $laudo_tecnico["type"]));

                    if (!in_array($type, $types)) {
                        $msg_erro .=  "Formato inválido, são aceitos os seguintes formatos: png, jpeg, bmp, pdf <br />";
                    }else{
                        $name = $os;
                        $file = $laudo_tecnico;
                        $s3->upload ($name, $file);
                    }

                }else{
                    $msg_erro .=  "Por favor, insira o Laudo Técnico <br />";
                }

            }

        }

        if($login_fabrica == 50 OR $login_fabrica == 86){
            $sql = "SELECT lancar_peca FROM tbl_defeito_constatado WHERE defeito_constatado = $defeito_constatado";
            $res = pg_query($con,$sql);
            $lancar_peca = pg_fetch_result($res,0, 'lancar_peca');

            if($lancar_peca == "f" AND $login_fabrica == 86){
                header("Location: laudo_tecnico_famastil.php?os=$os&defeito_constatado=$defeito_constatado");
                exit;
            }
        }

        if (in_array($login_fabrica, array(141))) {
            if (!empty($defeito_constatado)) {
                $sql = "SELECT defeito_constatado FROM tbl_defeito_constatado WHERE fabrica = {$login_fabrica} AND defeito_constatado = {$defeito_constatado} AND defeito_constatado_grupo IS NOT NULL";
                $res = pg_query($con, $sql);

                if (pg_num_rows($res) > 0) {
                    $laudo_produto_fora_garantia = $_POST["laudo_produto_fora_garantia"];

                    if (!empty($laudo_produto_fora_garantia) && strlen($_FILES["foto_produto"]["tmp_name"]) > 0) {
                        $s3_foto_produto = new AmazonTC("inspecao", $login_fabrica);

                        $foto_produto = $_FILES["foto_produto"];

                        $sql = "SELECT produto FROM tbl_os WHERE fabrica = {$login_fabrica} AND os = {$os}";
                        $res = pg_query($con, $sql);

                        $produto = pg_fetch_result($res, 0, "produto");

                        $s3_foto_produto->upload("{$os}_{$produto}", $foto_produto);

                        if (in_array($laudo_produto_fora_garantia, array("nao_comercializado", "nao_atende_requisitos_garantia finalizar"))) {
                            $sql = "UPDATE tbl_os SET
                                        laudo_tecnico = '{$laudo_produto_fora_garantia}',
                                        data_conserto = CURRENT_TIMESTAMP,
                                        status_checkpoint = 4
                                    WHERE os = {$os} AND fabrica = {$login_fabrica}";
                            $res = pg_query($con, $sql);

                            $sql = "UPDATE tbl_os_extra SET
                                        extrato = 0
                                    WHERE os = {$os}";
                            $res = pg_query($con, $sql);
                        } else {
                            $sql = "UPDATE tbl_os SET
                                        laudo_tecnico = '{$laudo_produto_fora_garantia}',
                                        data_conserto = CURRENT_TIMESTAMP
                                    WHERE os = {$os} AND fabrica = {$login_fabrica}";
                            $res = pg_query($con, $sql);
                        }

                        echo "<script> window.location = 'os_press.php?os=$os'; window.open('laudo_produto_fora_garantia.php?os={$os}', '_blank'); </script>";
                    }else{
                        header("Location: os_press.php?os=$os");
                    }
                }else{
                    header("Location: os_press.php?os=$os");
                }
            }else{
                header("Location: os_press.php?os=$os");
            }
        }

        if(!strlen($msg_erro) && !in_array($login_fabrica, array(141))){

            if (!in_array($login_fabrica,array(2,51,106,108,111)) AND ($os_bloqueada_garantia == 't' OR $peca_mais_30_dias == 't' OR $os_com_intervencao == 't' OR $intervencao_previsao == 't' OR $os_com_intervencao_carteira == 't')) {

                if ( !in_array($login_fabrica, array(11,172)) ) {
                    header("Location: os_justificativa_garantia.php?os=$os");
                } else {
                    echo "<script>window.location = 'os_justificativa_garantia.php?os=$os'</script>";
                }

            } else {
  
                if ($login_fabrica == 3 AND $btn_imprimir == 'imprimir') {

                    header("Location: os_fechamento.php?sua_os=$sua_os&btn_acao_pesquisa=continuar");

                } else {

                    if ( !in_array($login_fabrica, array(11,172)) ) {

                        if(in_array($login_fabrica,array(50,106,108,111))){
                            header("Location: os_press.php?os=$os");
                        } else {
                            if($login_fabrica == 24){
                                $verificaReincidencia = "SELECT os_reincidente FROM tbl_os WHERE os = {$os}";
                                $resVerificaReincidencia = pg_query($con, $verificaReincidencia);
                                $reincidente = pg_fetch_result($resVerificaReincidencia, 0,"os_reincidente");

                                if($reincidente == "t"){

                                    header("Location: os_motivo_atraso.php?os=$os&bjustificativa=ok");
                                }else{

                                   header("Location: os_finalizada.php?os=$os");
                                }

                            } else {
                                if ($login_fabrica == 30 && $solucao_os == 5684) {
                                    $sql = "SELECT os FROM tbl_os WHERE sua_os = '{$os}' AND fabrica = {$login_fabrica};";
                                    $res = pg_query($con, $sql);
                                    $os_aux = pg_fetch_result($res, 0, "os");

                                    $sql = "SELECT os FROM tbl_os_campo_extra WHERE os = {$os_aux} AND fabrica = {$login_fabrica}";
                                    $res = pg_query($con, $sql);
                                    if (pg_num_rows($res) == 0) {
                                        header("Location: helpdesk_posto_autorizado_novo_atendimento.php?ordem_de_servico=$os");
                                    }else{
                                        header("Location: os_finalizada.php?os=$os");
                                    }
                                }else{        
                                    if($login_fabrica == 125 and strlen($msg_erro)==0){
                                        $semEstoquePeca = array();
                                        //echo "os = $os ";
                                        $sqlPeca = "SELECT tbl_os_item.peca, tbl_os_item.os_item, tbl_os_produto.produto from tbl_os_item 
                                                inner join tbl_os_produto on tbl_os_produto.os_produto = tbl_os_item.os_produto 
                                                where tbl_os_produto.os = $os 
                                                and tbl_os_item.servico_realizado = 10741 
                                                and parametros_adicionais !~'kit' 
                                                and tbl_os_item.pedido is null ";
                                        $resPeca = pg_query($con, $sqlPeca);
                                        //echo nl2br($sqlPeca);
                                        //echo pg_last_error($con);
                                        $contar_resPeca = pg_num_rows($resPeca); 
                                        for($pe = 0; $pe<$contar_resPeca; $pe++){
                                            $peca_osx = pg_fetch_result($resPeca, $pe, 'peca');
                                            $produtox = pg_fetch_result($resPeca, $pe, 'produto');

                                            //echo "<br><Br> peca = $peca_osx <br>";

                                            $sqlVerEstoquePeca = "SELECT * FROM tbl_posto_estoque WHERE posto = 4311 and qtde >= 1 and peca = $peca_osx";
                                            $resVerEstoquePeca = pg_query($con, $sqlVerEstoquePeca);

                                            //echo "<br><br>".nl2br($sqlVerEstoquePeca);

                                            if(pg_num_rows($resVerEstoquePeca)==0){
                                                $semEstoquePeca[] = $peca_osx;
                                            }
                                        }
    

                                        if(count($semEstoquePeca)>0){
                                            //echo "dentro do array"; 
                                            
                                            $arr_sem_estoque = implode(",", $semEstoquePeca);
                                            
                                            $sqlkit = "SELECT DISTINCT tbl_kit_peca.peca as peca_kit, 
                                                        tbl_kit_peca.descricao as descricao_kit 
                                                        FROM tbl_kit_peca
                                                        JOIN tbl_kit_peca_peca ON tbl_kit_peca.kit_peca = tbl_kit_peca_peca.kit_peca
                                                        WHERE tbl_kit_peca.fabrica = $login_fabrica
                                                        AND tbl_kit_peca_peca.peca in ($arr_sem_estoque) ";
                                            $reskit =pg_query($con, $sqlkit);
                                            //echo "<br><br>".nl2br($sqlkit);
                                            $contar_reskit = pg_num_rows($reskit);

                                            for($z=0; $z<$contar_reskit; $z++){
                                                $peca_principal_kit = pg_fetch_result($reskit, $z, 'peca_kit');
                                                $descricao_kit = pg_fetch_result($reskit, $z, 'descricao_kit');

                                                $sqlVerEstoqueKit = "SELECT * FROM tbl_posto_estoque WHERE posto = 4311 and qtde >= 1 and peca = $peca_principal_kit";
                                                $resVerEstoquekit = pg_query($con, $sqlVerEstoqueKit);
                                                //echo "<br><Br>". nl2br($sqlVerEstoqueKit);
                                                
                                                if(pg_num_rows($resVerEstoquekit)>0){
                                                    $result = pg_query($con,'BEGIN TRANSACTION');
                                                    //echo "passou no begin";

                                                    $sqlbusca = "SELECT tbl_os_item.os_produto, tbl_os_item.os_item
                                                                FROM tbl_os_item, tbl_kit_peca,tbl_kit_peca_peca, tbl_os_produto
                                                                WHERE tbl_os_item.os_produto = tbl_os_produto.os_produto
                                                                AND tbl_kit_peca.peca = $peca_principal_kit
                                                                and tbl_os_produto.os = $os 
                                                                AND tbl_kit_peca_peca.kit_peca = tbl_kit_peca.kit_peca
                                                                and tbl_os_item.peca = tbl_kit_peca_peca.peca";
                                                    $resbusca = pg_query($con, $sqlbusca);
                                                    //echo"<br><Br>". nl2br($sqlbusca);
                                                    //echo pg_last_error($con);
                                                    $contar_resbusca = pg_num_rows($resbusca);

                                                    for($del=0; $del<$contar_resbusca; $del++){
                                                        $os_item_del = pg_fetch_result($resbusca, $del, os_item);
                                                        $os_produto_del = pg_fetch_result($resbusca, $del, os_produto);

                                                        $sqldelositem = "DELETE from tbl_os_item WHERE os_item = $os_item_del";
                                                        $resdelositem = pg_query($con, $sqldelositem);
                                                        $msg_erro = pg_last_error($con);
                                                       
                                                        $sqldelosproduto = "DELETE from tbl_os_produto WHERE os_produto = $os_produto_del";
                                                        $resdelosproduto = pg_query($con, $sqldelosproduto);
                                                        $msg_erro = pg_last_error($con);
                                                    }                                           
                                                    
                                                    if(strlen($msg_erro)==0){
                                                        $sqlInstOsProduto = "INSERT INTO tbl_os_produto(os,produto) VALUES($os,$produtox) RETURNING os_produto"; 
                                                        $resInstOsProduto = pg_query($con, $sqlInstOsProduto);

                                                        if(pg_affected_rows($resInstOsProduto)>0){
                                                            $os_produto = pg_fetch_result($resInstOsProduto, 0, os_produto);

                                                            $parametros_adicionais = json_encode(array('kit'=>true));

                                                            $sqlOsItem = "INSERT INTO tbl_os_item(os_produto,peca,qtde,servico_realizado, parametros_adicionais) VALUES($os_produto, $peca_principal_kit, 1, 10741, '$parametros_adicionais') RETURNING os_item";
                                                            $resOsItem = pg_query($con, $sqlOsItem);

                                                        }
                                                        $result = pg_query($con,"commit TRANSACTION");
                                                    }
                                                }
                                            }
                                        }                
                                    }

                                header("Location: os_finalizada.php?os=$os");

                                }
                            }
                        }
                    } else {
                        echo "<script>window.location = 'os_finalizada.php?os=$os'</script>";
                    }

                }

            }

        }

    } else {
        $res = pg_query($con,"ROLLBACK TRANSACTION");
    }

}
#HD 276459 visita_agendada
if (strlen($os) > 0 /*AND strlen($msg_erro) == 0*/) {
    $sql = "SELECT os FROM tbl_os WHERE fabrica = {$login_fabrica} AND posto = {$login_posto} AND os = {$os}";
    $res = pg_query($con, $sql);

    if (!pg_num_rows($res)) {
        header("Location: menu_inicial.php");
           exit;
    }
    $campoFalha = "";
    $condFalha  = "";
    if ($login_fabrica == 72) {
        $campoFalha = "tbl_os_produto.servico,";
        $condFalha  = "LEFT JOIN tbl_os_produto ON tbl_os_produto.os=tbl_os.os";
    }
    #----------------- Le dados da OS --------------
    $sql = "SELECT  tbl_os.*                       ,
                    tbl_produto.produto            ,
                    tbl_produto.referencia         ,
                    tbl_produto.descricao          ,
                    tbl_produto.voltagem           ,
                    tbl_produto.linha              ,
                    tbl_produto.familia            ,
                    tbl_produto.troca_obrigatoria  ,
                    tbl_linha.nome AS linha_nome   ,
                    tbl_posto_fabrica.codigo_posto ,
                    tbl_os_extra.orientacao_sac    ,
                    tbl_os_extra.tecnico AS info_tecnico  ,
                    tbl_os_extra.obs_nf    ,
                    tbl_os_extra.os_reincidente AS reincidente_os,
                    TO_CHAR(tbl_os_extra.data_fabricacao,'DD/MM/YYYY') as data_fabricacao   ,
                    to_char(tbl_os.visita_agendada::date,'dd/mm/yyyy') as visita_agendada2,
                    to_char(tbl_os.data_abertura::date,'dd/mm/yyyy')   as data_abertura2,
                    tbl_os_extra.obs_adicionais,
                    tbl_defeito_constatado.descricao as defeito_descricao,
                    tbl_defeito_constatado.lancar_peca ,
                    $campoFalha
                    tbl_linha.informatica
            FROM    tbl_os
            JOIN    tbl_os_extra USING (os)
            LEFT JOIN tbl_defeito_constatado ON tbl_os.defeito_constatado = tbl_defeito_constatado.defeito_constatado
            JOIN    tbl_posto USING (posto)
            JOIN    tbl_posto_fabrica ON tbl_posto.posto = tbl_posto_fabrica.posto
                                      AND tbl_posto_fabrica.fabrica = $login_fabrica
            LEFT JOIN    tbl_produto USING (produto)
            LEFT JOIN    tbl_linha   ON tbl_produto.linha = tbl_linha.linha
            $condFalha
            WHERE   tbl_os.os = $os";
// echo nl2br($sql);
    $res = pg_query($con, $sql) ;

    $defeito_constatado = pg_fetch_result($res, 0, 'defeito_constatado');
    $defeito_descricao  = pg_fetch_result($res, 0, 'defeito_descricao');
    $lancar_peca  = pg_fetch_result($res, 0, 'lancar_peca');
    $aparencia_produto  = pg_fetch_result($res, 0, 'aparencia_produto');
    $acessorios         = pg_fetch_result($res, 0, 'acessorios');
    $causa_defeito      = pg_fetch_result($res, 0, 'causa_defeito');
    $linha              = pg_fetch_result($res, 0, 'linha');
    $informatica        = pg_fetch_result($res, 0, 'informatica');
    $linha_nome         = pg_fetch_result($res, 0, 'linha_nome');
    $consumidor_nome    = pg_fetch_result($res, 0, 'consumidor_nome');
    $filial_posto       = pg_fetch_result($res, 0, 'filial');
    $sua_os             = pg_fetch_result($res, 0, 'sua_os');

    if($login_fabrica == 52){
        $tecnico             = pg_fetch_result($res, 0, 'info_tecnico');
        $explodeTecnico = explode("|", $tecnico);
        $nome_tecnico = $explodeTecnico[0];
        $rg_tecnico = $explodeTecnico[1];

    }

    $type               = pg_fetch_result($res, 0, 'type');
    $data_abertura      = pg_fetch_result($res, 0, 'data_abertura2');
    $data_aberturax     = pg_fetch_result($res, 0, 'data_abertura');
    $produto_os         = pg_fetch_result($res, 0, 'produto');
    $produto_referencia = pg_fetch_result($res, 0, 'referencia');
    $produto_descricao  = pg_fetch_result($res, 0, 'descricao');
    $produto_voltagem   = pg_fetch_result($res, 0, 'voltagem');
    $tecnico            = pg_fetch_result($res, 0, 'tecnico');
    $data_fabricacao    = pg_fetch_result($res, 0, 'data_fabricacao');

    if ($login_fabrica == 15) {
        $produto_serie  = strtoupper(pg_fetch_result($res, 0, 'serie'));
    } else {
        $produto_serie  = pg_fetch_result($res, 0, 'serie');
    }

    $produto_serie_db   = pg_fetch_result($res, 0, 'serie');
    $qtde_produtos      = pg_fetch_result($res, 0, 'qtde_produtos');
    $obs                = pg_fetch_result($res, 0, 'obs');
    $codigo_posto       = pg_fetch_result($res, 0, 'codigo_posto');
    $defeito_reclamado  = pg_fetch_result($res, 0, 'defeito_reclamado');
    $os_reincidente     = pg_fetch_result($res, 0, 'reincidente_os');
    $consumidor_revenda = pg_fetch_result($res, 0, 'consumidor_revenda');
    $solucao_os         = pg_fetch_result($res, 0, 'solucao_os');
    $tecnico_nome       = pg_fetch_result($res, 0, 'tecnico_nome');
    $tecnico            = pg_fetch_result($res, 0, 'tecnico');
    $codigo_fabricacao  = pg_fetch_result($res, 0, 'codigo_fabricacao');
    $valores_adicionais = pg_fetch_result($res, 0, 'valores_adicionais');
    $qtde_km            = pg_fetch_result($res, 0, 'qtde_km');
    $produto_familia    = pg_fetch_result($res, 0, 'familia');
    $produto_linha      = pg_fetch_result($res, 0, 'linha');
    $troca_obrigatoria  = pg_fetch_result($res, 0, 'troca_obrigatoria');
    $fabricacao_produto = pg_fetch_result($res, 0, 'fabricacao_produto');
    $obs_nf             = trim(pg_fetch_result($res, 0, 'obs_nf'));

    $defeito_constatado_grupo       = pg_fetch_result($res, 0, 'defeito_constatado_grupo');
    $justificativa_adicionais       = pg_fetch_result($res, 0, 'justificativa_adicionais');
    $defeito_reclamado_descricao_os = pg_fetch_result($res, 0, 'defeito_reclamado_descricao');
    //hd 24288
    //$autorizacao_domicilio = pg_fetch_result($res,0,autorizacao_domicilio);

    $orientacao_sac    = pg_fetch_result($res, 0, 'orientacao_sac');
    #$orientacao_sac = html_entity_decode ($orientacao_sac,ENT_QUOTES);
    #$orientacao_sac = str_replace ("<br />","",$orientacao_sac);

    //HD 4291 Paulo
    if ($login_posto == 4311) {
        $prateleira_box = pg_fetch_result($res,0, prateleira_box);
    }
    $obs_adicionais             = pg_fetch_result($res, 0, 'obs_adicionais');

    #HD 276459 visita_agendada
    if (in_array($login_fabrica, array(30,50))) { //HD 27561

        if ($login_fabrica == 30) {
            $visita_agendada            = pg_fetch_result($res, 0, 'visita_agendada2');
        }
        $consumidor_numero      = pg_fetch_result($res, 0, 'consumidor_numero');
        $consumidor_endereco        = pg_fetch_result($res, 0, 'consumidor_endereco');
        $consumidor_complemento     = pg_fetch_result($res, 0, 'consumidor_complemento');
        $consumidor_cidade      = pg_fetch_result($res, 0, 'consumidor_cidade');
        $consumidor_estado          = pg_fetch_result($res, 0, 'consumidor_estado');
        $consumidor_cep         = pg_fetch_result($res, 0, 'consumidor_cep');

        if (strlen($produto_serie) == 0) {
            $produto_serie = $xproduto_serie;
        }

    }

    if (in_array($login_fabrica, array(3,24,45)) && $login_posto == 6359) {

        $sql = "SELECT orcamento,
                total_mao_de_obra,
                aprovado,
                TO_CHAR(data_aprovacao,'DD/MM/YYYY HH24:MI')  AS data_aprovacao,
                TO_CHAR(data_reprovacao,'DD/MM/YYYY HH24:MI') AS data_reprovacao,
                motivo_reprovacao
            FROM tbl_orcamento
            WHERE os = $os
            AND empresa = $login_fabrica";

        $res = pg_query($con,$sql);

        if (pg_num_rows($res) > 0) {

            $orcamento          = pg_fetch_result($res, 0, 'orcamento');
            $valor_mo_orcamento = pg_fetch_result($res, 0, 'total_mao_de_obra');
            $aprovado           = pg_fetch_result($res, 0, 'aprovado');
            $data_aprovacao     = pg_fetch_result($res, 0, 'data_aprovacao');
            $data_reprovacao    = pg_fetch_result($res, 0, 'data_reprovacao');
            $motivo_reprovacao  = pg_fetch_result($res, 0, 'motivo_reprovacao');
            $valor_mo_orcamento = number_format($valor_mo_orcamento,2,',','.');

        }

    }

    if (strlen($os_reincidente) > 0) {

        $sql = "SELECT tbl_os.sua_os
                FROM   tbl_os
                WHERE  tbl_os.os      = $os_reincidente
                AND    tbl_os.fabrica = $login_fabrica
                AND    tbl_os.posto   = $login_posto;";

        $res = pg_query($con,$sql) ;

        if (pg_num_rows($res) > 0) $sua_os_reincidente = trim(pg_fetch_result($res, 0, 'sua_os'));

    }

    if($login_fabrica == 30){
        $sql = "SELECT status_os
                FROM tbl_os_status
                WHERE status_os IN (164,165,166)
                AND tbl_os_status.os =  $os
                AND tbl_os_status.fabrica_status = $login_fabrica
                ORDER BY data DESC LIMIT 1";
        $res = pg_query($con,$sql);
        if(pg_num_rows($res) > 0){
            $status_os = pg_fetch_result($res, 0, 'status_os');
        }
    }

    if($inf_valores_adicionais){
        $sql = "SELECT valores_adicionais FROM tbl_os_campo_extra WHERE os = $os";
        $res = pg_query($con,$sql) ;
        if(pg_num_rows($res) > 0){
            $valor_adicional_formatado = pg_fetch_result($res, 0, 'valores_adicionais');
            $json_format = json_decode($valor_adicional_formatado,true);
            $custo_extra = "t";
            if(count($json_format[1]) > 0){
                $outros_custos = "t";
            }
        }

        $sql = "SELECT status_os FROM tbl_os_status WHERE os = $os AND status_os IN(171,172,173) ORDER BY os_status DESC LIMIT 1";
        $res = pg_query($con,$sql);
        if(pg_num_rows($res) > 0){
            $status_adicional = pg_fetch_result($res, 0, 'status_os');
            if($status_adicional == 171 OR $status_adicional == 172){
                $bloqueia_valores = "disabled";
            }
        }
    }

    $sql = "SELECT DATE_PART('YEAR', data_digitacao) AS year, DATE_PART('MONTH', data_digitacao) AS month
            FROM tbl_os
            WHERE fabrica = $login_fabrica
            AND os = $os";
    $res = pg_query($con, $sql);

    $year  = pg_fetch_result($res, 0, "year");
    $month = pg_fetch_result($res, 0, "month");

}

#---------------- Carrega campos de configuração da Fabrica -------------
if(strlen($os) > 0 && ($login_fabrica == 24 or $login_fabrica > 100)){
    $sql = "select count(*) as total from tbl_os_item join tbl_os_produto on tbl_os_item.os_produto = tbl_os_produto.os_produto and tbl_os_produto.os = $os";
    $res = pg_query($con, $sql);

    if(pg_num_rows($res) > 0){
        $cont_os_itens = pg_fetch_result($res, 0, 'total');
    }
}

$sql = "SELECT  tbl_fabrica.os_item_subconjunto  ,
                tbl_fabrica.pergunta_qtde_os_item,
                tbl_fabrica.os_item_serie        ,
                tbl_fabrica.os_item_aparencia    ,
                tbl_fabrica.qtde_item_os
        FROM    tbl_fabrica
        WHERE   tbl_fabrica.fabrica = $login_fabrica;";
//         echo nl2br($sql);
// if(strlen($msg_erro) == 0){
    $resX = pg_query($con,$sql);
// }

if (pg_num_rows($resX) > 0) {
    $os_item_subconjunto = pg_fetch_result($resX,0,os_item_subconjunto);
    if (strlen($os_item_subconjunto) == 0) $os_item_subconjunto = 't';

    $pergunta_qtde_os_item = pg_fetch_result($resX,0,pergunta_qtde_os_item);
    if (strlen($pergunta_qtde_os_item) == 0) $pergunta_qtde_os_item = 'f';

    //HD - 675542 : Apena para a Gelopar e o Posto 60908 pode alterar a quantidade
    if($login_fabrica == 85 AND ($login_posto == 60908 || $login_posto == 6359)){
        $pergunta_qtde_os_item = 't';
    }

    $os_item_serie = pg_fetch_result($resX,0,os_item_serie);
    if (strlen($os_item_serie) == 0) $os_item_serie = 'f';

    $os_item_aparencia = pg_fetch_result($resX,0,os_item_aparencia);
    if (strlen($os_item_aparencia) == 0) $os_item_aparencia = 'f';

    $qtde_item = pg_fetch_result($resX,0,qtde_item_os);

    /* Qtde Item Suggar */
    if(strlen($cont_os_itens) > 0 && ($login_fabrica == 24 or $login_fabrica > 100)){
        if($cont_os_itens >= $qtde_item){
             $qtde_item = $cont_os_itens + 5;
        }
    }

    if(($login_fabrica == 24 or $login_fabrica > 100) && $loop_itens > 0){
        $qtde_item = $loop_itens;
    }

    if (strlen($qtde_item) == 0) $qtde_item = 5;

    if($login_fabrica == 85 && ($login_posto == 60908 || $login_posto == 6359)){
        $qtde_item = 30;
    }

    if($login_fabrica == 45) {
        $sql="SELECT qtde_os_item
                FROM tbl_posto_fabrica
                where posto   = $login_posto
                and   fabrica = $login_fabrica";
        $res = pg_query($con,$sql);
        $qtde_item    = pg_fetch_result($res,0,qtde_os_item);
    }

}

// Incluida em funcoes.php
/*function verifica_checklist_tipo_atendimento($tipo_at) {
    global $con, $login_fabrica;

    $sql = "SELECT checklist_fabrica
            FROM tbl_checklist_fabrica
            WHERE fabrica = {$login_fabrica}
            AND tipo_atendimento = {$tipo_at}
            LIMIT 1";
    $res = pg_query($con, $sql);

    if (pg_num_rows($res) > 0) {
        return true;
    }

    return false;
}*/

$qtde_item_ant = (empty($qtde_item_ant)) ? $qtde_item : $qtde_item_ant;

$resX = pg_query($con,"SELECT item_aparencia FROM tbl_posto_fabrica WHERE posto = $login_posto AND fabrica = $login_fabrica");
$posto_item_aparencia = pg_fetch_result($resX,0,0);

$title = "Telecontrol - Assistência Técnica - Ordem de Serviço";
$body_onload = "javascript: document.frm_os.defeito_constatado.focus(); listaSolucao(document.frm_os.defeito_constatado.value, document.frm_os.xxproduto_linha.value, document.frm_os.defeito_reclamado.value,  document.frm_os.xxproduto_familia.value); ";

$layout_menu = 'os';
include_once "cabecalho.php";
// ini_set("display_errors", 1);
            // error_reporting(E_ALL);

if($login_fabrica==3){
    if (strlen($_POST['os'])>0) $os = $_POST['os'];
    else                       $os = $_GET['os'];

    $sql ="select
            sua_os
        from tbl_os
        join tbl_os_troca using(os)
        where os = $os
        AND   data_conserto IS NOT NULL";
    $res = pg_query($con, $sql);

    if(pg_num_rows($res)>0){
        $sua_os = pg_fetch_result($res,0,sua_os);
        echo "<P>";
            echo "<B>OS<FONT SIZE='3' COLOR='#FF0033'>&nbsp;$sua_os&nbsp;</FONT>com troca de produto não pode ser alterada.</B>";
        echo "</P>";
        exit;
    }
}

if($login_fabrica==35){ // HD 112977
    if (strlen($_POST['os'])>0) $os = $_POST['os'];
    else                       $os = $_GET['os'];
    $sql ="SELECT
            sua_os
        FROM tbl_os
        JOIN tbl_os_troca using(os)
        WHERE os = $os";
    $res = pg_query($con, $sql);

    if(pg_num_rows($res)>0){
        $sua_os = pg_fetch_result($res,0,sua_os);
        echo "<P>";
            echo "<b>OS<FONT SIZE='3' COLOR='#FF0033'>&nbsp;$sua_os&nbsp;</FONT>com troca de produto não pode ser alterada.</B>";
        echo "</P>";
        exit;
    }
}

$imprimir        = $_GET['imprimir'];
$qtde_etiquetas  = $_GET['qtde_etiq'];

if (strlen($os) == 0) $os = $_GET['os'];

if (strlen($imprimir) > 0 AND strlen($os) > 0) {
    echo "<script language='javascript'>";
    echo "window.open ('os_print.php?os=$os&qtde_etiquetas=$qtde_etiquetas','os_print','resizable=yes,resize=yes,status=no,scrollbars=yes,directories=no,width=500,height=400,top=18,left=0')";
    echo "</script>";
}
if( in_array($login_fabrica, array(11,172)) && strlen($msg_erro) > 0){

    if (count($arrFilesUpload) > 0) {
        if ($amazonTC->moveTempToBucket($arrFilesUpload, $year, $month) === false) {
            $msg_erro = "Erro ao salvar arquivos, por favor tente novamente <br />";
            $erro_upload = "true";
        }
    }
}
if ($login_fabrica == 116) {
   $sql = "SELECT tbl_tipo_atendimento.entrega_tecnica FROM tbl_os JOIN tbL_tipo_atendimento USING(tipo_atendimento) WHERE tbl_os.fabrica = $login_fabrica AND os = $os";
    $res = pg_query($con, $sql);

    if (pg_fetch_result($res, 0, "entrega_tecnica") == "t") {
        $sql = "SELECT os FROM tbl_laudo_tecnico_os WHERE fabrica = $login_fabrica AND os = $os";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) == 0) {
            echo "<script>window.location = 'checklist_entrega_tecnica.php?os=$os';</script>";
        }
    }
}

if(in_array($login_fabrica,array(88,114))){
    $sql = "SELECT os FROM tbl_laudo_tecnico_os WHERE fabrica = $login_fabrica AND os = $os";
    $res = pg_query($con, $sql);

    $sql_linha = "SELECT tbl_produto.linha from tbl_produto join tbl_os on tbl_os.produto = tbl_produto.produto WHERE tbl_os.os = $os AND tbl_os.fabrica = $login_fabrica AND tbl_produto.fabrica_i = $login_fabrica";
    $res_linha = pg_query($con, $sql_linha);

    $linha = pg_fetch_result($res_linha, 0, "linha");

    if (pg_num_rows($res) == 0 && $linha == 691) {
        echo "<script>window.location = 'checklist_os_item.php?os=$os';</script>";
    }

    if($login_fabrica == 88 && pg_num_rows($res) == 0){
        $sqlFamilia = "
        SELECT  tbl_produto.familia
        FROM    tbl_produto
        JOIN    tbl_os ON tbl_os.produto = tbl_produto.produto
        WHERE   tbl_os.os               = $os
        AND     tbl_os.fabrica          = $login_fabrica
        AND     tbl_produto.fabrica_i   = $login_fabrica
        ";
        $resFamilia = pg_query($con,$sqlFamilia);
        $familia = pg_fetch_result($resFamilia,0,familia);

        echo "<script>window.location = 'opiniao_posto_new.php?os=$os&familia=$familia';</script>";
    }
}

//  03/02/2010 MLG HD - 201678 (voltando alteração feita 13/11/09)
$gambiara_esmaltec = 'waldir/samuel';
if($login_fabrica == 131 || $login_fabrica == 134){
    include_once "javascript_pesquisas_novo.php";
}else{
    include_once "javascript_pesquisas.php";
}

include_once "js/js_css.php";
if($login_fabrica == 114){
    $sql = "SELECT os FROM tbl_laudo_tecnico_os WHERE fabrica = $login_fabrica AND os = $os";
    $res = pg_query($con, $sql);

    $sql_linha = "SELECT tbl_produto.linha from tbl_produto join tbl_os on tbl_os.produto = tbl_produto.produto WHERE tbl_os.os = $os AND tbl_os.fabrica = $login_fabrica AND tbl_produto.fabrica_i = $login_fabrica";
    $res_linha = pg_query($con, $sql_linha);

    $linha = pg_fetch_result($res_linha, 0, "linha");

    if (pg_num_rows($res) == 0 && $linha == 691) {
?>

<script type="text/javascript">
$(document).ready(function () {
    Shadowbox.init();
});

$(window).load(function () {
    Shadowbox.open({
        content: "checklist_os_item.php?os=<?=$os?>",
        player: "iframe",
        title: "Checklist",
        width: 800,
        height: 500
    });
});
</script>

<?
     }
}

$Posto_SAC = '';
if ($login_fabrica == 30) {
    $sql = "SELECT tbl_tipo_posto.descricao FROM tbl_posto_fabrica JOIN tbl_tipo_posto ON(tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto) WHERE tbl_posto_fabrica.fabrica = {$login_fabrica} AND tbl_posto_fabrica.posto = {$login_posto}";
    $res = pg_query ($con,$sql);

    $Posto_SAC = pg_result ($res,0,descricao);
}
?>

<script type="text/javascript">
     var layoutCheckList = '\
                        <table width="700" align="center" id="checklist" border="1" cellspacing="0" cellpadding="1" class="formulario">\
                            <tbody>\
                                <tr>\
                                    <td class="titulo_tabela" valign="middle" colspan="5">\
                                        <label style="margin:auto;font:14px Arial">Checklist:</label>\
                                    </td>\
                                </tr>\
                                <tr class="titulo_tabela_2"><td class="tal">Checklist</td><td width="10%">Ação</td></tr>\
                                <tbody id="show">\
                                </tbody>\
                            </tbody>\
                        </table>\
                        <br/>';

    function retornaCheckList(selecionadosIDS, selecionadosDESC, defeitoReclamado, defeitoConstatado, ja_preenchido = false, xos) {

        console.log(selecionadosIDS)
        console.log(selecionadosDESC)
        console.log(defeitoReclamado)
        console.log(defeitoConstatado)
        console.log(ja_preenchido)
        console.log(xos)
        Shadowbox.close();
        var selecionadosID   = $.parseJSON(selecionadosIDS);
        var selecionadosDES  = $.parseJSON(selecionadosDESC);
        var codigo_defeito = "";
        
        $("input[name^=i_defeito_constatado]").closest("td").each(function(){

            var codDef = $(this).text().split("-");

            if ($.trim($(this).text()) == "PRODUTO SEM DEFEITO" || $.trim(codDef[0]) == "554") {
                codigo_defeito = "554";
            }

        });

        if (selecionadosID.length > 0) {

            $("#t_checklist").show();
            $("#t_checklist").html(layoutCheckList);
            
            for (var i = 0; i < selecionadosID.length; i++) {
                $("#show").append('\
                    <tr class="t_checklist tr_check trchk-'+selecionadosID[i]+'">\
                        <td class="tal">\
                            <input type="hidden" class="check_list_fabrica" name="check_list_fabrica['+defeitoReclamado+']['+defeitoConstatado+'][]" value="'+selecionadosID[i]+'"> \
                            <input type="checkbox" checked disabled name="check_list_fabrica_'+defeitoReclamado+'_'+defeitoConstatado+'_'+selecionadosID[i]+'" > '+selecionadosDES[i]+'\
                        </td>\
                        <td>\
                            <button type="button" data-os="'+xos+'" data-constatado="'+defeitoConstatado+'" data-reclamado="'+defeitoReclamado+'" data-posicao="'+selecionadosID[i]+'" class="btn btn-delete btn-remove-item-checklist">Excluir</button>\
                        </td>\
                    </tr>');
            }
            if (codigo_defeito == "554" || $("#defeito_na_instalacao").is(":checked")) {
                $("#show").append('\
                    <tr class="t_checklist">\
                        <td colspan="100%" class="tac">\
                            <button type="button"  data-reclamado="'+defeitoReclamado+'" data-checklist="'+selecionadosIDS+'"  data-os="'+xos+'" data-constatado="'+defeitoConstatado+'" class="btn btn-info btn-visualizar-checklist btn-add-defeito-constatado"> Visualizar Checklist </button>\
                        </td>\
                    </tr>');
            }

        }

        $.each($("input[name^='i_defeito_constatado"), function(index, val) {
           if ($(val).data('codigo') == "554") {
                $.each($(".tr_check"), function(i, ele) {
                    $(ele).css('background-color', '#ffd9d8');
                });
           }
        });

    }

    function abreCheckList(ja_preenchido = false, defeito_reclamado = '', tipo_atendimento = '', defeito_constatado = '', id_familia = '', checklist = '') {
        Shadowbox.init();
        Shadowbox.open({
            content: 'checklist_iframe.php?ja_preenchido='+ja_preenchido+'&defeito_reclamado='+defeito_reclamado+'&tipo_atendimento='+tipo_atendimento+'&defeitos_checklist=true&defeito_constatado='+defeito_constatado+'&id_familia='+id_familia+'&checklist='+checklist,
            player: "iframe",
            title: "Checklist",
            width: 1200,
            height: 800,
            options: {
                modal: true
                /*enableKeys: false,
                displayNav: false*/
            }
           
        });
    }

    $(function(){

        <?php if($login_fabrica == 24){ ?>
        $("#produto_serie").blur(function(){
            var serie       = $("#produto_serie").val();
            var referencia  = $("#referencia_produto").val();
            $.ajax({
                type: "POST",
                datatype: 'json',
                url: "verifica_produto_serie.php",
                data: {verifica_produto_serie:true, referencia: referencia, serie:serie},
                success: function(retorno){
                    var dados = $.parseJSON(retorno);
                    if(dados.retorno == 'erro'){
                      $("#msg_erro_produto_serie").css('color', '#ff0000')
                      $("#msg_erro_produto_serie").text('Número de série bloqueado, entrar em contato com a fábrica.');
                    }

                }
            });
        });
        <?php } ?>



        $(document).on("click", ".btn-remove-item-checklist" , function(){
            var posicao = $(this).data('posicao');
            var os = $(this).data('os');
            var constatado = $(this).data('constatado');
            var reclamado = $(this).data('reclamado');
            var selecionadosIDS = [];

            $.ajax({
                url: "<?php echo $_SERVER['PHP_SELF'] ?>",
                type: "GET",
                dataType: "JSON",
                data: {
                    ajax_exclui_item_checklist: 'true',
                    checklist_fabrica : posicao,
                    os : os,
                    constatado : constatado,
                    reclamado : reclamado
                },
                complete: function(data){
                    data = data.responseText;
                    if(data.erro == "true") {
                        alert('Erro ao excluir checklist');
                    } else { 
                        
                        $(".trchk-"+posicao).remove();
                        $.each($("input[name^='check_list_fabrica"), function(index, val) {
                            selecionadosIDS.push($(val).val())
                        });
                        $(".btn-visualizar-checklist").attr('data-checklist', selecionadosIDS)
                        alert("Checklist excluido com sucesso");
                    }

                }
            });

        });

        $(document).on("change, click", "input[name=condicao_instalacao]" , function(){
            var tipo = $(this).data('tipo');
           
            var tipo_atendimento   = $("input[name=xtipo_atendimento]").val();
            var id_familia         = $("input[name=xxproduto_familia]").val();
            var defeito_constatado = "";
            var defeito_reclamado = "";

            $.each($("input[name='defeito_reclamado"), function(index, val) {
                defeito_reclamado = $(val).val();
            });

            defeito_constatado = $('input[name="i_defeito_constatado['+defeito_reclamado+'][]"]:first').val();

            var URL = 'os_item_new.php?ajax_carrega_checklist=true&check='+tipo+'&defeito_reclamado='+defeito_reclamado+'&familia='+id_familia+'&tipo_atendimento='+tipo_atendimento+'&defeito_constatado='+defeito_constatado;

            if (tipo == "instalacao_sem_defeito" || tipo == "nao_avaliado") {
                $("#t_checklist").show();
                $("#t_checklist").html(layoutCheckList);
                $("#show").load(URL);
            } else {
                $("#t_checklist").html("");
                abreCheckList(false, defeito_reclamado, tipo_atendimento, defeito_constatado, id_familia, '');
            }

        });

        $(document).on("click", ".btn-visualizar-checklist" , function(){

            var constatado       = $(this).data("constatado");
            var os               = $(this).data("os");
            var reclamado        = $(this).data("reclamado");
            var tipo_atendimento = $("input[name=xtipo_atendimento]").val();
            var id_familia       = $("input[name=xxproduto_familia]").val();

            var selecionadosIDS = [];
            $.each($(".check_list_fabrica"), function(index, val) {
                selecionadosIDS.push($(val).val())
            });

            if (selecionadosIDS.length == 0) {
                $.each($(".check_list_fabrica2"), function(index, val) {
                    selecionadosIDS.push($(val).val())
                });
            }

            if ($(this).data("novo") == "t") {
                $("#checklist_preenchido").remove();
            }

            if (constatado == "" || constatado == undefined) {
                constatado = $("input[name^=i_defeito_constatado]:first").val();
            }

            abreCheckList(true, reclamado, tipo_atendimento, constatado, id_familia, selecionadosIDS)
            $(".btn-visualizar-checklist").attr('data-checklist', selecionadosIDS)


        });

        <?php
        if (in_array($login_fabrica, [19]) && verifica_checklist_tipo_atendimento($tipo_atendimento)) { ?>

            $(document).on("click", ".btn-add-defeito-constatado" , function(){
                if ($(this).data("checklist") != "") {
                    var checklist = $(this).data("checklist");
                } else {
                    var checklist = "";
                }
                var id_defeito        = $("select[name^=i_defeito_constatado] option:selected").val();
                var familia_produto   = $("input[name=xxproduto_familia]").val();
                var defeito           = $("input[name^=i_defeito_constatado]").data('codigo');
                var tipo              = $("select[name^=i_defeito_constatado] option:selected").data('tipo');
                var tipo_atendimento  = $("input[name=xtipo_atendimento]").val();
                var posicao           = $(this).data("posicao");
                var defeito_reclamado = $("input[id=defeito_reclamado_"+posicao+"]").val();

                if (defeito !== undefined && defeito !== "undefined" && defeito != "") {
                    var codigoDefeito     = defeito;
                } else {
                    var text_defeito      = $("select[name=defeito_constatado_"+posicao+"] option:selected").text();
                    var xcodigoDefeito    = text_defeito.split("-");
                    var codigoDefeito     = xcodigoDefeito[0];
                    var id_defeito        = $("select[name=defeito_constatado_"+posicao+"] option:selected").val();
                }
                
                $(".mostra_condicao").show();

                if (codigoDefeito == "554") {
                    $("input[id=instalacao_sem_defeito]").attr("disabled", true);
                    $("input[id=nao_avaliado]").attr("disabled", true);
                    $("input[id=defeito_na_instalacao]").attr("checked", true);
                } else {
                    $("input[id=instalacao_sem_defeito]").removeAttr("disabled");
                    $("input[id=nao_avaliado]").removeAttr("disabled");
                    //$("input[id=defeito_na_instalacao]").removeAttr("checked");
                }

                if (codigoDefeito == '554') {
                    
                    abreCheckList(false, defeito_reclamado, tipo_atendimento, id_defeito, familia_produto, [])

                    //$("input[name='btn_adicionar']").hide();
                } 
            });

            if ($("input[name^=i_defeito_constatado]").length > 0) {
                $(".mostra_condicao").show();
            }
        <?php
        }
        ?>

        $("#nao_avaliado, #instalacao_sem_defeito").click(function(){

            $("#checklist_preenchido, .btn-visualizar-checklist").remove();

        });

    $("#defeito_na_instalacao").click(function(){

        $("#checklist_preenchido").remove();

    });

    $("#dt_fabricacao_ilegivel").click(function(){
        if ($(this).attr('checked') == 'checked') {
            $('#esconde_data').hide();
            $('#fabricacao_produto_hidden').val("f");
        } else {
            $('#esconde_data').show();
            $('#fabricacao_produto_hidden').val("t");
        }
    });

    <?php
    if ($login_fabrica == 30) {
        /* Se a OS estiver em algum HelpDesk do tipo 'Solicitação de troca de produto' o mesmo não será concertado */
        $sql = "SELECT
                    os_bloqueada
                FROM tbl_os_campo_extra
                WHERE fabrica = {$login_fabrica}
                    AND os = {$os};";

        $res = pg_query($con, $sql);
        if (pg_num_rows($res) > 0) {
            $os_bloqueada = pg_fetch_result($res, 0, "os_bloqueada");
		}
		$sql = "SELECT
                    os
                FROM tbl_os_status
                WHERE status_os = 187
                    AND os = {$os};";

        $res = pg_query($con, $sql);
        if (pg_num_rows($res) > 0) {
            $os_liberada_excedente = 'Liberada';
        }
    }
    if($login_fabrica == 30 and empty($os_liberada_excedente) and ($_POST['produto_serie'] == '00000000000000') || $Posto_SAC == 'SAC' || $os_bloqueada == 't'){?>
        
        <?php if ($login_posto != 28332) { ?>
            
            $("#tablemostrar").hide();
        
            for (var i = 0; i < 50; i++) {
                if ($('input[name=peca_'+i+']').length) {
                    $('input[name=kit_kit_peca_'+i+']').val('');
                    $('input[name=produto_'+i+']').val('');
                    $('input[name=os_item_'+i+']').val('');
                    $('input[name=os_produto_'+i+']').val('');
                    $('input[name=admin_peca_'+i+']').val('');
                    $('input[name=serie_'+i+']').val('');
                    $('input[name=peca_'+i+'_anterior]').val('');
                    $('input[name=peca_'+i+']').val('');
                    $('input[name=descricao_'+i+']').val('');
                    $('input[name=descricao_'+i+'_anterior]').val('');
                    $('input[name=peca_'+i+']').val('');
                    $('input[name=qtde_'+i+']').val('');
                    $('select[name=defeito_'+i+']').val('');
                    $('select[name=servico_'+i+']').val('');
                }
            }
        
        <?php } ?>

    <?php } ?>

        Shadowbox.init({
            skipSetup: true
        });

        <?php
            if($login_fabrica == 131){ // HD-2181938
        ?>
            $("button[name=btn_gravar]").click(function(){
                if (confirm('Tem certeza que deseja gravar? Após gravar não será possível alterar ou incluir itens!')) {
                    return;
                }else{
                    location.reload();
                }
            });

        <?php
            }
        ?>

        <?php
        if($login_fabrica == 131 || ($login_fabrica == 137 && $posto_interno == false)){
        ?>

        $('#produto_serie').blur(function(){

            var lote = $(this).val();
            var referencia_produto = $('input[name=produto_referencia]').val();

            if(lote.length == 0){
                alert('O número de Lote é obrigatório!');
                return;
            }

            $.ajax({
                url: "<?php echo $_SERVER['PHP_SELF'] ?>",
                type: "post",
                data: {
                    verifica_numero_serie   : "ok",
                    lote                    : lote,
                    referencia_produto      : referencia_produto
                },
                complete: function(data){

                    data = data.responseText;
                    if(data == "auditoria"){
                        alert("O número de Lote está incorreto e passará por auditoria da fabrica");
                        $('#auditoria_numero_serie').val('sim');
                    }else{
                        $('#auditoria_numero_serie').val('nao');
                    }

                }
            });
        });

        <?php
        }
        ?>

    });

    function verifica_qtde_peca() {
        if ($("#qtde_peca_lancada").val() == "" || $("#qtde_peca_lancada").val() == undefined) {

            let p = $('tr[id^=mostrar_]').length;
            let qtde_peca = 0;
            // verificar tipo pedido de troca gera pedido produção
             
            for (j=0; j < p; j++) {
                if ($("input[name=descricao_"+j+"]").val() != undefined && $("input[name=descricao_"+j+"]").val() != "" && $("select[name=servico_"+j+"]").val() == 504 && ($("input[name=os_item_"+j+"]").val() == "" || $("input[name=os_item_"+j+"]").val() == undefined || $("input[name=excluida_auditoria_"+j+"]").val() == 'sim')) {
                    qtde_peca++;
                }
            }

            if (qtde_peca > 3) {
                 var pergunta_os = confirm("As peças que necessitam de troca estão acima de 3 unidades. Deseja prosseguir com o lançamento de todas as peças ?\
                    \r\rSe sim, a OS será auditada pelo fabricante e só irá gerar pedido após a aprovação.");

                if (pergunta_os == true){
                    $("#qtde_peca_lancada").val(qtde_peca);                    
                    document.frm_os.btn_acao.value='gravar';
                    document.frm_os.submit();
                }
            } else {
                $("#qtde_peca_lancada").val('1');
                document.frm_os.btn_acao.value='gravar';
                document.frm_os.submit();
            }
        } else {
            $("#qtde_peca_lancada").val('1');
            document.frm_os.btn_acao.value='gravar';
            document.frm_os.submit();
        }
    }

<?php
    if(in_array($login_fabrica,array(131,134))){
?>
    function retorna_dados_peca (
        peca,referencia,descricao,ipi,origem,para,peca_para,para_descricao,posicao) {
        $("#peca_"+posicao).val(referencia);
        $("#descricao_"+posicao).val(descricao);


        verificaEstoqueRecompra(referencia, posicao);        
    }

<?php
    }
?>


<?php if (in_array($login_fabrica,array(131,134))) { ?>
    function verificaEstoqueRecompra(peca_referencia, posicao){
        var posto_id = $("#posto_id").val();
        $.ajax({
            url:"<?=$PHP_SELF?>",
            type:"POST",
            dataType:"json",
            data:{
                ajax:"verifica_recompra",
                ajax_peca:peca_referencia,
                posto_id: posto_id
            },
            complete: function(data){
                var dados = data.responseText;
                if(dados.length > 0){
                    console.log(dados);
                    $("#servico_"+posicao).html(dados);
                }

            }
        });
    }

<?php
}
if($login_fabrica == 94){
?>

function getPecas(pecas){
    cont = 0;
    while(cont < pecas.length){
        var p = pecas[cont];
        var conf = 0;
        var conf2 = 0;
        var d = [];
        d = p.split('|');
        var ref = d[0];
        var desc = d[1];

        $('input[id^="peca_"]').each(function(){
            if($(this).val() == "" && conf != 1){
                $(this).val(ref);
                conf = 1;
            }
        });

        $('input[id^="descricao_"]').each(function(){
            if($(this).val() == "" && conf2 != 1){
                $(this).val(desc);
                conf2 = 1;
            }
        });
        cont++;
    }
}
<?php } ?>

<? if(in_array($login_fabrica, array(42))) { ?>
    function deletarImagemOS(el, fileName, idx){
        var elemento = $(el);
        $.ajax({
            url:"<?=$PHP_SELF?>",
            type:"POST",
            data:{
                deletar_imagem_os: "true",
                file:fileName
            },
            complete:function(data){
                var resp = $.parseJSON(data.responseText);

                if(resp.apagado == "true"){

                    var table = elemento.parents("table");
                    var length = table.find("td").length
                    if(length > 1){
                        elemento.parent().remove();
                    }else{
                        table.remove();
                    }

                    if (idx) {
                        $('#' + idx).remove();
                    }
                }

            }
        });
    }
<? } ?>

</script>

<?
# Se a OS for uma OS de revenda, entra
if (strlen($os_revenda)>0 or $login_fabrica==3){
?>
<script type="text/javascript">

    function EscondeDiv(x){
        var campo = document.getElementById('retorno_serie_'+x);
        campo.style.display = "none";
    }
var http3 = new Array();
function atualizaserietrocada(os_item, serietrocada,x){

    os_item      = document.getElementById(os_item).value;
    serietrocada = document.getElementById(serietrocada).value;

    var curDateTime = new Date();
    http3[curDateTime] = createRequestObject();
    var campo = document.getElementById('retorno_serie_'+x);

    if (!campo) {
        return;
    }

    url = "<?=$php_self;?>?atualiza_serie_trocada=true&os_item="+os_item+"&serie_trocada="+serietrocada;
    http3[curDateTime].open('get',url);
    http3[curDateTime].onreadystatechange = function(){
        if(http3[curDateTime].readyState == 1) {
            campo.innerHTML = " <font size='1' face='verdana'> Aguarde..</font>";
        }
        if (http3[curDateTime].readyState == 4){
            if (http3[curDateTime].status == 200 || http3[curDateTime].status == 304){
                var results = http3[curDateTime].responseText;
                campo.innerHTML = results;
                campo.style.display = "block";
                window.setTimeout('EscondeDiv('+x+')',2000);
            }else {
                alert('Ocorreu um erro');
            }
        }
    }
    http3[curDateTime].send(null);

}

function mostraDomicilio(campo,destino){
    if(campo.checked){
        document.getElementById(destino).style.display = "block";
    }else{
        document.getElementById(destino).style.display = "none";
    }
}

function checarNumero(campo){
    var num = campo.value.replace(",",".");
    campo.value = parseFloat(num).toFixed(2);
    if (campo.value=='NaN') {
        campo.value='';
    }
}

$().ready(function() {

    $("select[rel=servicos_realizados]").focus(function(){
        var campo = $(this);
        if  ( $("input[name='peca_"+campo.attr("alt")+"']").val() !='' ){
            campo.html('<option value="">Aguarde . . . . . . . .</option>');
            $.post('<? echo $php_self; ?>',
                { buscaServicoRealizado : $("input[name='peca_"+campo.attr("alt")+"']").val()
                    <? if (strlen($os_revenda)==0){ echo ", os : '$os'";}?>
                },
                function(resposta){
                    retorno = resposta.split("||");
                    //alert(retorno);
                    campo.html(retorno[1]);
                }
            );

            $(campo).change();
        }
    });
    $("select[rel=servicos_realizados]").change(function(){
        var campo = $(this);
        if (campo.val()=='643' || campo.val()=='644'){
            $("#orcamento_mostra_"+campo.attr("alt")).show();
            $("#orcamento_mao_obra").show();
        }else{
            $("#orcamento_mostra_"+campo.attr("alt")).hide();
        }

        <?php if ($login_fabrica == 3) { ?>
                let p = campo.attr("alt");
                if ($("input[name=peca_"+p+"]").val() != '' && $("input[name=peca_"+p+"]").val() != undefined && $("input[name=descricao_"+p+"]").val() != '' &&  $("input[name=descricao_"+p+"]").val() != undefined) {
                    $.ajax({
                        url: 'os_item_new.php',
                        cache: false,
                        type: "POST",
                        data:{
                            buscaQtdFoto: true,
                            ref: $("input[name=peca_"+p+"]").val(),
                            desc: $("input[name=descricao_"+p+"]").val()
                        },
                        complete: function(retorno){
                            let respJson = $.parseJSON(retorno.responseText);
                            if (respJson.qtde_fotos != undefined) {
                                $("input[name=qtde_fotos_"+p+"]").val(respJson.qtde_fotos);
                                $("input[name=serial_lcd_"+p+"]").val(respJson.serial_lcd);
                                verificaPA(campo.attr("alt"));
                            }
                        }
                    });
                }
        <?php } ?>
    });

    <?php if ($login_fabrica == 3) { ?>
        $("input[name^=peca_], input[name^=descricao_]").on("change", function() {
            let i = $(this).attr('name').replace(/([^\d])+/gim, '');
            
            $(this).parent("td").parent("tr").find("select[name^=servico_]").val("");
            let divQF  = $("div[name=upload_fotos_"+i+"]");
            let spanSL = $("span[name=serial_lcd_"+i+"]");

            if ($(divQF).is(":visible")) {
                $(divQF).hide();
            }

            if ($(spanSL).is(":visible")) {
                $(spanSL).hide();
            }
        });
    <?php } ?>

});

</script>

<?}?>

<?php if ($login_fabrica == 94) : // HD 415550 ?>
    <script type="text/javascript" src="js/jquery.alphanumeric.js"></script>
    <script type="text/javascript">
        $().ready(function(){
            $("#valor_mao_de_obra").numeric( {'allow' : ','});
            $("#qtde_km").numeric({'allow' : '.'});
        });

    </script>
<?php endif; // HD 415550 - FIM ?>

<script type='text/javascript' src='ajax.js'></script>
<script type='text/javascript' src='ajax_cep.js'></script>
<script type='text/javascript' src='ajax_produto.js'></script>
<script type='text/javascript' src='js/bibliotecaAJAX.js'></script>

<script type="text/javascript" src="js/jquery.blockUI_2.39.js"></script>
<!--<script type="text/javascript" src="js/plugin_verifica_servidor.js"></script>-->
<script type="text/javascript"    src="admin/js/jquery.price_format.1.7.min.js"></script>
<img id="prevImage" style="display:block;" />
<script src="js/jquery.form.js"></script>
<div id="results"></div>
<?php if (in_array($login_fabrica, array(50))) {?>
<style type="text/css">
    @import "plugins/jquery/datepick/telecontrol.datepick.css";
</style>
<script type="text/javascript" src="plugins/jquery/datepick/jquery.datepick.js"></script>
<script type="text/javascript" src="plugins/jquery/datepick/jquery.datepick-pt-BR.js"></script>
<?php }?>

<link rel="stylesheet" type="text/css" href="admin/fancybox/jquery.fancybox-1.3.4.css" />
<script type='text/javascript' src='js/FancyZoom.js'></script>
<script type='text/javascript' src='js/FancyZoomHTML.js'></script>
<script language="JavaScript">

/**
* @method
* @name:    toQueryString
* @author:  Manuel López
* @return:  String
* @desc:    Converte um Objeto simples para queryString
*   obj = {peca:'ABC123', serie:'987654', ajax: true, descricao: null};
*   toQueryString(obj) // "peca=ABC123&serie=987654&ajax=true&descricao=null"
*/
function toQueryString(obj, sep) {
    "use strict";
    sep = sep || '&';
    if (typeof obj !== 'object')
        return obj;

    var p    = [],
        idx  = Object.keys(obj),
        self = obj;
    idx.forEach(function(i) {
        p.push(i+'='+obj[i]);
    });
    return p.join(sep);
}

/** hd-6794016 */
$(function() {
    <?php for ($i = 0; $i < 50; $i++) { ?>
        <?php if (!empty($_POST['qtde_' . $i])) { ?>
            $('input[name=qtde_' + '<?php echo $i ?>').val('<?php echo $_POST['qtde_' . $i] ?>');
        <?php } ?>
   <?php } ?>
});


var ajax_process = false;
var os = "<?=$os?>";

String.prototype.trim = function() {
    return this.replace(/^\s+|\s+$/g, '');
}

function trim(str) {
    return str.replace(/^\s+|\s+$/g, '');
}

function verificaNumero(e) {
    if (e.which != 8 && e.which != 0 && ((e.which < 48 && e.which != 44 && e.which != 46) || e.which > 57)) {
        return false;
    }
}
<? if($login_fabrica == 125){ ?>
function showAnexoPecaCritica(value,i){

    if(($("#item_img_peca_critica_"+i).length > 0) && ($.inArray( value, Array("10740","10741","10742")) > -1 ) ){
        $("#msg_peca_critica").show();
        $("#item_img_peca_critica_"+i).show();
    }else{
        $("#item_img_peca_critica_"+i).hide();
        if($("div[id^=item_img_peca_critica_]:visible").length == 0){
            $("#msg_peca_critica").hide();
        }
    }
}
function deletaImagem(os, peca, i){
    if($("#peca_critica_"+i).val() == "true"){
        $.ajax({
            url: 'os_item_new.php',
            cache: false,
            type: "POST",
            data:{
                deletaImagem: "true",
                peca_remover: peca,
                os: os,
                i : i
            },
            complete: function(retorno){
                var respJson = $.parseJSON(retorno.responseText);
                if(respJson.deletado == "true"){
                   $("#upload_peca_critica_"+i).remove();
                   $("#item_img_peca_critica_"+i).remove();
                   var qtde_pecas_criticas = parseInt($("#qtde_pecas_criticas").val());
                   $("#qtde_pecas_criticas").val(qtde_pecas_criticas-1);
                   if($("div[id^=item_img_peca_critica_]:visible").length == 0){
                        $("#msg_peca_critica").hide();
                   }

                }

            }
        });
    }else{

       $("#upload_peca_critica_"+i).remove();
       $("#item_img_peca_critica_"+i).remove();
       var qtde_pecas_criticas = parseInt($("#qtde_pecas_criticas").val());
       $("#qtde_pecas_criticas").val(qtde_pecas_criticas-1);
       if($("div[id^=item_img_peca_critica_][id!=item_img_peca_critica_linhaI]").length == 0){
            $("#msg_peca_critica").html("");
        }
    }
}
function imgPecasCriticas(i){
    var peca      = $.trim($("#peca_"+i).val());

    var qtde_pecas_criticas = parseInt($("#qtde_pecas_criticas").val());
        $.ajax({
            url: 'os_item_new.php',
            cache: false,
            data:{
                verifica_peca_critica: "true",
                peca: peca
            },
            complete: function(retorno){
                var respJson = $.parseJSON(retorno.responseText);
                if(respJson.critica == "true" ){

                    $("#qtde_pecas_criticas").val(qtde_pecas_criticas+1);
                    if($("#item_img_peca_critica_"+i).length == 0  ){
                        //monta input para imgs
                        var peca = respJson.referencia;
                        var divContainerForm = $("#form_upload_peca_critica");
                        var formModel = $("#model_form_peca_critica");
                        $(divContainerForm).append($(formModel).clone().html().replace(/linhaI/g, i).replace(/OSNumber/g, os).replace(/pecaReferencia/g, peca));
                        $(divContainerForm).find("input[name=img_peca_critica_"+i+"]").attr("onchange", "ajax_process = true; $('#btn_anexar_img_"+i+"').hide(); $('#mini_anexar_img_"+i+"').show(); $('#mini_anexar_img_"+i+"').attr('src', 'imagens/ajax-loader.gif'); $('#upload_peca_critica_"+i+"').submit();");

                        //monta btn para anexar img
                        var divContainerBtn = $("#container_btn_anexar_img");
                        var btnModel = $("#item_img_peca_critica");
                        $(divContainerBtn).append($(btnModel).clone().html().replace(/linhaI/g, i).replace(/referencia/g, peca));
                        $(divContainerBtn).find("img[name=mini_anexar_img_"+i+"]").click(function(){$("#img_peca_critica_"+i).click();});

                        $("#upload_peca_critica_"+i).ajaxForm({
                            complete: function(data) {
                                if (data.responseText == "erro") {
                                    alert("Arquivo inválido, selecione outro arquivo!");
                                    $("#mini_anexar_img_"+data.i).attr("src", 'image/foto.png');
                                } else {
                                    data = $.parseJSON(data.responseText);
                                    $("#mini_anexar_img_"+data.i).attr("src", data.file);
                                    $("#mini_anexar_img_"+data.i).show();
                                    $("#peca_critica_"+data.i).val("true");
                                    $("#peca_critica_ext_"+data.i).val(data.ext);
                                }

                            }
                        });

                        if($.inArray( $("#servico_"+i).val(), Array("10740","10741","10742")) > -1){
                            $("#msg_peca_critica").html("Foi inserida uma peça crítica.<br/> Obrigatório anexar uma foto da peça danificada para uma pré-análise do fabricante <br/><br/>");
                            $("#item_img_peca_critica_"+i).show();
                            $("#msg_peca_critica").show()
                        }
                    }else{
                        var peca      = $.trim($("#peca_"+i).val());
                        if($("#referencia_peca_critica_"+i).val() != peca){
                            $("#item_img_peca_critica_"+i).remove();
                            $("#upload_peca_critica_"+i).remove();

                            //monta input para imgs
                            var peca = respJson.referencia;
                            var divContainerForm = $("#form_upload_peca_critica");
                            var formModel = $("#model_form_peca_critica");
                            $(divContainerForm).append($(formModel).clone().html().replace(/linhaI/g, i).replace(/OSNumber/g, os).replace(/pecaReferencia/g, peca));
                            $(divContainerForm).find("input[name=img_peca_critica_"+i+"]").attr("onchange", "ajax_process = true; $('#btn_anexar_img_"+i+"').hide(); $('#mini_anexar_img_"+i+"').show(); $('#mini_anexar_img_"+i+"').attr('src', 'imagens/ajax-loader.gif'); $('#upload_peca_critica_"+i+"').submit();");

                            //monta btn para anexar img
                            var divContainerBtn = $("#container_btn_anexar_img");
                            var btnModel = $("#item_img_peca_critica");
                            $(divContainerBtn).append($(btnModel).clone().html().replace(/linhaI/g, i).replace(/referencia/g, peca));
                            $(divContainerBtn).find("img[name=mini_anexar_img_"+i+"]").click(function(){$("#img_peca_critica_"+i).click();});

                            $("#upload_peca_critica_"+i).ajaxForm({
                                complete: function(data) {
                                    if (data.responseText == "erro") {
                                        alert("Arquivo inválido, selecione outro arquivo!");
                                        $("#mini_anexar_img_"+data.i).attr("src", 'image/foto.png');
                                    } else {
                                        data = $.parseJSON(data.responseText);
                                        $("#mini_anexar_img_"+data.i).attr("src", data.file);
                                        $("#mini_anexar_img_"+data.i).show();
                                        $("#peca_critica_"+data.i).val("true");
                                        $("#peca_critica_ext_"+data.i).val(data.ext);
                                    }

                                }
                            });
                        }

                    }
                }else{

                    var peca_remover = $("#referencia_peca_critica_"+i).val();
                    deletaImagem(os, peca_remover, i);

                }
            }
        });

}

<? } ?>

function verificaPOPeca(po, linha){

    if(po == 't'){
        $('#po_peca_'+linha).show();
        $('#po_peca_'+linha).find('input').val('');
    }else{
        $('#po_peca_'+linha).hide();
        $('#po_peca_'+linha).find('input').val('');
    }

}

function verificaPA (i) {
    var fabrica = '<?php echo $login_fabrica;?>';
    var qtde_fotos = $("input[name=qtde_fotos_"+i+"]").val();
    var serial_lcd = $("input[name=serial_lcd_"+i+"]").val();

    var divQF     = $("div[name=upload_fotos_"+i+"]");
    var spanSL    = $("span[name=serial_lcd_"+i+"]");
    var filesForm = $("#file_forms");
    var model     = $("#filesFormModel");
    var peca      = $.trim($("#peca_"+i).val());

    $(divQF).find("#upload_mini").find("img").remove();
    $("form[name^=file_form_"+i+"]").remove();

    $(spanSL).find("input").val("");

    if (qtde_fotos > 0) {


        var img_exemp =   ["defeito_tela_inteira.png", "etiq_fabricante_display.png","etiq_fabricante_display_rasurada.png","etiq_pci_opencell.png","atencao-teste.png"];
        var label_exemp = ["Defeito Tela Inteira", "Etiq Fabricante Display"," Etiq Fabricante Display Rasurada","Etiq PCI OpenCell","Etiq PCI OpenCell Rasurada"];


        for (var k = 0; k < qtde_fotos; k++) {
            if (fabrica == 3) {
                var image_file = "image/img_britania/"+img_exemp[k];
                var xlabel_exemp = "<td>"+label_exemp[k]+"</td></tr>";
                $(divQF).find("#upload_mini").append("<tr><td><img class='img_tumb_britania_display' id='img_"+i+"_"+k+"' src='"+image_file+"' style='cursor: pointer;' title='Clique para adicionar uma foto' onclick='javascript: if (ajax_process == false) { $(\"input[name=file_"+i+"_"+k+"]\").click(); } else { alert(\"Espere o upload atual finalizar\"); }' /></td>"+xlabel_exemp);
            } else {
                var image_file = "image/foto.png";
                $(divQF).find("#upload_mini").append("<img class='img_tumb_britania_display' id='img_"+i+"_"+k+"' src='"+image_file+"' style='cursor: pointer;' title='Clique para adicionar uma foto' onclick='javascript: if (ajax_process == false) { $(\"input[name=file_"+i+"_"+k+"]\").click(); } else { alert(\"Espere o upload atual finalizar\"); }' />");
            }


            $(divQF).find("#upload_mini").append("<input type='hidden' name='temp_uploaded_"+i+"_"+k+"' value='f' />");
            $(divQF).find("#upload_mini").append("<input type='hidden' name='temp_uploaded_ext_"+i+"_"+k+"' value='' />");

            $(filesForm).append($(model).clone().html().replace(/linhaI/g, i).replace(/fotoK/g, k).replace(/OSNumber/g, os).replace(/pecaRef/g, peca));

            $("form[name=file_form_"+i+"_"+k+"]").ajaxForm({
                complete: function(data) {
                    if (data.responseText == "erro") {
                        alert("Arquivo inválido, selecione outro arquivo!");
                    } else {
                        data = $.parseJSON(data.responseText);
                        $("#img_"+data.i+"_"+data.k).attr("src", data.file);
                        $("input[name=temp_uploaded_"+data.i+"_"+data.k+"]").val("t");
                        $("input[name=temp_uploaded_ext_"+data.i+"_"+data.k+"]").val(data.ext);

                        $("img.loadImg:visible").hide();
                    }

                    $("#loadImg"+i).hide();
                    ajax_process = false;
                }
            });

            $(filesForm).find("input[name=file_"+i+"_"+k+"]").attr("onchange", "$('div[name=upload_fotos_"+i+"]').find('img.loadImg').show(); ajax_process = true; $('#file_form_"+i+"_"+k+"').submit();");
        }
    } else {
        if ($(divQF).is(":visible")) {
            $(divQF).hide();
        }

        if ($(spanSL).is(":visible")) {
            $(spanSL).hide();
        }
    }

    /*$(divQF).parent("td").parent("tr").find("select[name^=servico_]").val("");

    if ($(divQF).is(":visible")) {
        $(divQF).hide();
    }

    if ($(spanSL).is(":visible")) {
        $(spanSL).hide();
    }*/
}

$(document).ready(function() {

    var login_fabrica = "<?=$login_fabrica?>";

    if (login_fabrica == 3) {

        var loop = $("#loop").val();

        for (var i = 0; i < loop; i++) {
            var qtde_fotos = $("input[name=qtde_fotos_"+i+"]").val();

            if (qtde_fotos > 0) {
                for (var k = 0; k < qtde_fotos; k++) {
                    $("form[name=file_form_"+i+"_"+k+"]").ajaxForm({
                        complete: function(data) {
                            data = $.parseJSON(data.responseText);

                            if (data.erro) {
                                alert(data.erro);
                            } else {
                                $("#img_"+data.i+"_"+data.k).attr("src", data.file);
                                $("input[name=temp_uploaded_"+data.i+"_"+data.k+"]").val("t");
                                $("input[name=temp_uploaded_ext_"+data.i+"_"+data.k+"]").val(data.ext);

                            }

                            $("img.loadImg:visible").hide();
                            ajax_process = false;
                        }
                    });
                }
            }
        }

        $("select[name^=servico_]").change(function () {
            var i = $(this).parents("tr[id^=mostrar_]").attr("alt");
            var qtde_fotos = $("input[name=qtde_fotos_"+i+"]").val();
            var serial_lcd = $("input[name=serial_lcd_"+i+"]").val();

            if ($(this).val() == 20) {
                if (qtde_fotos > 0) {
                    $("div[name=upload_fotos_"+i+"]").show();
                } else {
                    $("div[name=upload_fotos_"+i+"]").hide();
                }

                if (serial_lcd == "t") {
                    $("span[name=serial_lcd_"+i+"]").show();
                } else {
                    $("span[name=serial_lcd_"+i+"]").hide();
                }
            } else {
                $("div[name=upload_fotos_"+i+"]").hide();
                $("span[name=serial_lcd_"+i+"]").hide();
            }
        });
    }

    if(login_fabrica == 125){

        var qtde_pecas_criticas = $("#qtde_pecas_criticas").val();
        var os = <?php echo $_GET['os']; ?>;

        for (var i = 0; i < qtde_pecas_criticas; i++) {
            verificaPecaCritica($('#servico_'+i).val(),i,os);
        }

        /*$("input[name=i][class=frm_upload_peca_critica]").each(function() {
            var i = $(this).val();
            if($("#peca_critica_"+i).val()=="true" && ($.inArray( $("#servico_"+i).val(), Array("10740","10741","10742")) > -1 )      ){
                $("#msg_peca_critica").html("Foi inserida uma peça crítica.<br/> Obrigatório anexar uma foto da peça danificada para uma pré-análise do fabricante <br/><br/>");
                if($("div[id^=item_img_peca_critica_]:visible").length > 0){
                    $("#msg_peca_critica").show();


                }
            }
            $("#upload_peca_critica_"+i).ajaxForm({
                complete: function(data) {
                    if (data.responseText == "erro") {
                        alert("Arquivo inválido, selecione outro arquivo!");
                    } else {

                        data = $.parseJSON(data.responseText);
                        $("#mini_anexar_img_"+data.i).attr("src", data.file);
                        $("#mini_anexar_img_"+data.i).show();
                        $("#peca_critica_"+data.i).val("true");
                        $("#peca_critica_ext_"+data.i).val(data.ext);
                    }
                }
            });
        });*/
    }

    <?php
        if($login_fabrica == 140){

            ?>
/*
            $("table#tablemostrar > tbody > tr > td > input[id^=qtde_]").priceFormat({
                prefix: '',
                centsSeparator: ',',
                thousandsSeparator: '.'
            });
*/
            <?php

        }
    ?>

    $("input[name^=qtde_]").keypress(verificaNumero);

    $(".novo_valor_adicional").priceFormat({
        prefix: '',
        centsSeparator: ',',
        thousandsSeparator: '.'
    });

    var fabrica     = <?=$login_fabrica?>;
    <?php
        if(!empty($lancar_peca)){
    ?>
            var lancar_peca = '<?=$lancar_peca?>';
    <?php
        }
    ?>

    if(fabrica == 30){
        var defeito_constatado_os = '<?=$defeito_constatado?>';
        var status_os = '<?=$status_os?>';

        if(defeito_constatado_os == 12485 || defeito_constatado_os == 11792){

            if(status_os == 165){
                $("#tbl_integridade input[type='button']").attr('disabled',true);
                $("input[type=text]").attr('readonly',true);
                $("textarea").attr('readonly',true);
                $("input[name=foto_nf]").attr('disabled',true);
                $("select option").hide();
                 $("select option:selected").show();
            }else if(status_os == 166){
                $("input[name=btn_gravar]").hide();
            }

        }
    }

    if($("#custo_extra").is(":checked")){
        $("#descricao_custos").show();
        $("#descricao_custos_prod").show();
        $("#outros_custos_span").show();
    }

    $("#custo_extra").change(function(){
        $("#descricao_custos").toggle();
        $("#descricao_custos_prod").toggle();
        $("#outros_custos_span").toggle();
    });

     if($("#outros_custos").is(":checked")){
        $("#table_outros_servicos").show();
    }

    $("#outros_custos").change(function(){
        $("#table_outros_servicos").toggle();
    });

    if(fabrica == 50 || fabrica == 86){
        verificaDefeitoConstatado();
    }

    if(fabrica == 6){
        var linha = '<?php echo $linha_nome;?>';
        var coleta_peca = '<?php echo $coleta_peca;?>';

        if(linha.toUpperCase() == "TABLET" && coleta_peca == "t"){
            $("input[name^=peca_]").attr("disabled",true);
            $("input[name^=descricao_]").attr("disabled",true);
        $("img.lanca_peca").hide();
        }else{
        $("input[name^=peca_]").attr("disabled",false);
            $("input[name^=descricao_]").attr("disabled",false);
            $("img.lanca_peca").show();
        }
    }
    verifyObjectId($("#objectid").val());

});
setIntervalRunning = false;
setIntervalHandler = null;

function getQrCode(){
    $("#btn-qrcode-request").fadeOut(1000);
    $("#btn-google-play").fadeOut(1000);
    $.ajax("controllers/QrCode.php",{
      method: "POST",
      data: {
        "ajax": "requireQrCode",
        "options": [
          "notafiscal"
        ],
        "title": "Upload de Nota Fiscal",
        "objectId": $("#objectid").val()
      }
   }).done(function(response){

      response = JSON.parse(response);
      console.log(response);

      $("#env-qrcode").find("img").attr("src",response.qrcode)
      $("#env-qrcode").fadeIn(1000);

      if(setIntervalRunning==false){
        setIntervalHandler = setInterval(function(){
          console.log("buscando...");


          verifyObjectId($("#objectid").val());
        },5000);
      }
   });
}

function verifyObjectId(objectId){

    $.ajax("controllers/TDocs.php",{
            method: "POST",
            data:{
              "ajax": "verifyObjectId",
              "objectId": objectId,
              "context": "os"
            }
          }).done(function(response){
            response = JSON.parse(response);

            if(response.exception == undefined){
              $(response).each(function(idx,elem){

                if($("#"+elem.tdocs_id).length == 0){
                  //var img = $("<div class='env-img'><img id='"+elem.tdocs_id+"' style='width: 150px; border: 2px solid #e2e2e2; margin-left: 5px;margin-right: 5px;'><button data-tdocs='"+elem.tdocs_id+"'>Excluir</button></div>");
                  //##var img = $("<div class='env-img'><a href='http://api2.telecontrol.com.br/tdocs/document/id/"+elem.tdocs_id+"/file/imagem.jpg' target='_BLANK' ><img id='"+elem.tdocs_id+"' style='width: 90px; border: 2px solid #e2e2e2; margin-left: 5px;margin-right: 5px;'></a><br/><button data-tdocs='"+elem.tdocs_id+"'>Excluir</button></div>");
                  //$(img).find("img").attr("src","http://api2.telecontrol.com.br/tdocs/document/id/"+elem.tdocs_id);


                  var img = $("<div class='env-img'><a href='http://api2.telecontrol.com.br/tdocs/document/id/"+elem.tdocs_id+"/file/imagem.jpg' target='_BLANK' ><img id='"+elem.tdocs_id+"' style='width: 90px; border: 2px solid #e2e2e2; margin-left: 5px;margin-right: 5px;'></a><br/><button class='btn-danger' data-tdocs='"+elem.tdocs_id+"'>Excluir</button></div>");

                  $(img).find("img").attr("src","http://api2.telecontrol.com.br/tdocs/document/id/"+elem.tdocs_id+"/file/imagem.jpg");
                  $(img).find("button").click(function(){
                      $.ajax("controllers/TDocs.php",{
                        method: "POST",
                        data: {
                          "ajax": "removeImage",
                          "objectId": elem.tdocs_id,
                          "context": "os"
                        }
                      }).done(function(response){
                          response = JSON.parse(response);
                          console.log(response);
                          if(response.res == 'ok'){
                            $("#"+elem.tdocs_id).parents(".env-img").fadeOut(1000);
                          }else{
                            alert("Não foi possível excluir o anexo, por favor tente novamente");
                          }
                      });
                  });

                  $("#env-images").append(img);
                  setupZoom();
                  console.log(elem.tdocs_id);
                }
              });
            }
          });
}

function retiraAcentos(obj) {

    var com_acento = 'áàãâäéèêëíìîïóòõôöúùûüçÁÀÃÂÄÉÈÊËÍÌÎÏÓÒÕÖÔÚÙÛÜÇ';
    var sem_acento = 'aaaaaeeeeiiiiooooouuuucAAAAAEEEEIIIIOOOOOUUUUC';

    resultado = '';

    for (i = 0; i < obj.value.length; i++) {

        if (com_acento.search(obj.value.substr(i,1)) >= 0) {
            resultado += sem_acento.substr(com_acento.search(obj.value.substr(i,1)),1);
        } else {
            resultado += obj.value.substr(i,1);
        }

    }

    obj.value = resultado.toUpperCase();

}

//HD 276459 visita_agendada
function gravaVisita(os,obj,os_visita) {

    var data = $(obj).val();

    if(os_visita == ""){
        os_visita = $(obj).attr("rel");
    }

    if (data.length > 0 && data != '__/__/____' ) {
        $.ajax({
            url:'ajax_grava_visita.php',
            type:'POST',
            dataType:"JSON",
            data:{
                os:os,
                data:data,
                os_visita:os_visita,
                posto:<?=$login_posto?>
            },
            complete: function(retorno){
                $(obj).attr({"rel":retorno.responseText});
            }
        })
        .done(function(data){
            alert(data['resposta']);
        });
    } else {
        alert('Digite uma data válida');
    }
}

function retorno_visita(dados) {
    var tratar_dados = dados.split('|');
    alert(tratar_dados[1]);
}

function verificaKM(){
    if($("#km").is(':checked')){
        $("#qtde_km_div").css('display','block');
    }else{
        $("#qtde_km_div").css('display','none');
        //$("#qtde_km").val('');
    }
}

function adiciona_linha(valor) {

    <?php if($login_fabrica == 24){ ?>

        if($('input[name=peca_'+valor+']').val() == ""){
            alert("Por favor informe a Peça");
            $('input[name=peca_'+valor+']').focus();
            return;
        }

        if($('input[name=descricao_'+valor+']').val() == ""){
            alert("Por favor informe a Descrição da Peça");
            $('input[name=descricao_'+valor+']').focus();
            return;
        }

        if($('input[name=qtde_'+valor+']').val() == ""){
            alert("Por favor informe a Quantidade de Peça");
            $('input[name=qtde_'+valor+']').focus();
            return;
        }

        if($('select[name=defeito_'+valor+']').val() == ""){
            alert("Por favor informe o Defeito sa Peça");
            $('select[name=defeito_'+valor+']').focus();
            return;
        }

        if($('select[name=servico_'+valor+']').val() == ""){
            alert("Por favor informe o Serviço realizado na Peça");
            $('select[name=servico_'+valor+']').focus();
            return;
        }

        var qtde_linha = parseInt($("#qtde_item").val());
        var linha = valor;

        if ((parseInt(valor)+1) == qtde_linha) {
            var linha_new = parseInt(linha) + 1;
            $("#tablemostrar > tbody").find("tr[id^=mostrar_]").last("tr").after("<tr id='mostrar_"+linha+"'>" + $("tr[id=mostrar_"+(valor-1)+"]").clone().html().replace(/(_|,)\d\d?/g,'\$1'+linha_new) + "</tr>");

            var cont = 0;
            $("#tablemostrar > tbody > tr").each(function(){
                cont++;
            });

            cont = parseInt(cont)-2;

            var div = $('#tablemostrar > tbody > tr').eq(cont);
            $(div).attr('alt', linha_new);
            $(div).attr('id', 'mostrar_'+linha_new);

            $("select[name=servico_"+linha+"]").attr('alt',parseInt(linha)+1);
            $("#qtde_item").val(qtde_linha + 1);
            $("input[name=peca_"+linha_new+"]").val("");
            $("input[name=descricao_"+linha_new+"]").val("");
            $("input[name=qtde_"+linha_new+"]").val("");
            $(div).find("select").each(function(){$(this).val("")});
            $(div).find("select[id=servico_"+linha_new+"]").attr('alt', linha_new);
            $("#orcamento_mostra_"+linha).hide();
        }

    <?php }else{ ?>

        var qtde_linha = parseInt($("#qtde_item").val());
    var linha = valor;
        if (valor == qtde_linha) {
            $("#tablemostrar > tbody").find("tr[id^=mostrar_]").last("tr").after("<tr id='mostrar_"+linha+"'>" + $("tr[id=mostrar_"+(valor-1)+"]").clone().html().replace(/(_|,)\d\d?/g,'\$1'+linha) + "</tr>");
            $("select[name=servico_"+linha+"]").attr('alt',parseInt(linha)+1);
            $("#qtde_item").val(qtde_linha + 1);
            $("input[name=peca_"+linha+"]").val("");
            $("input[name=descricao_"+linha+"]").val("");
            $("tr[id=mostrar_"+linha+"]").find("select").each(function(){$(this).val("")});
            $("#orcamento_mostra_"+linha).hide();
        }

    <?php } ?>

    verifica_estoque_peca(linha);

}

function verifica_estoque_peca(linha){
    var referencia = $("#peca_"+linha).val();
    var qtde_estoque = $("#qtde_estoque_"+linha).val();
    var novo_estoque = parseInt(qtde_estoque)-1
    var servico = $("#servico_"+linha).val();

    var texto = "Esta peça será utilizada de seu estoque";
    if(qtde_estoque > 0){
        $.ajax({
            url: 'os_item_new.php?ajax_servico=1&servico='+servico,
            cache: false,
            success: function(retorno){
                if(retorno == "ok"){
                    $("#div_estoque_"+linha).html(texto).show();
                }else{
                    $("#div_estoque_"+linha).hide();
                }
            }
        });
    }
}

function verificaPecaCritica(valor,linha,os){
    var contador = $('#qtde_pecas_criticas').val();
    if (valor == 10741 || valor == 10742 || valor == 10740) { //TROCA DE PEÇA
        var peca = $('#peca_'+linha).val();
        $.ajax({
            url: window.location,
            method: 'GET',
            timeout: 5000,
            data: {verifica_peca_critica: "true", peca: peca}
        }).fail(function(){
        }).done(function(data){
            data = JSON.parse(data);
            if (data.critica == "true") {
                contador++;
                $('#qtde_pecas_criticas').val(contador);
                if ($('#item_img_peca_critica_'+linha).length) {
                    $('#item_img_peca_critica_'+linha).remove();
                    $('#upload_peca_critica_'+linha).remove();
                }
                $('#container_btn_anexar_img').find('span').show();
                $('#container_btn_anexar_img').append("\
                    <div id='item_img_peca_critica_"+linha+"'>\
                        <span>Referência Peça: "+peca+"</span>\
                        <img id='mini_anexar_img_"+linha+"' name='mini_anexar_img_"+linha+"' src='image\/foto.png' title='Clique aqui para inserir a imagem' alt='Clique aqui para inserir a imagem' onclick='javascript: $('#img_peca_critica_"+linha+"').click();' style='display: none'>\
                        <button type='button' id='btn_anexar_img_"+linha+"' name='btn_anexar_img_"+linha+"' title='Clique aqui para inserir a imagem' alt='Clique aqui para inserir a imagem' onclick=\"$('#img_peca_critica_"+linha+"').click();\">Inserir Anexo</button>\
                        <input type='hidden' value='true' id='peca_critica_"+linha+"' name='peca_critica_"+linha+"'>\
                        <input type='hidden' value='' id='peca_critica_ext_"+linha+"' name='peca_critica_ext_"+linha+"'>\
                    </div>\
                ");

                $('#form_upload_peca_critica').append("\
                    <form id='upload_peca_critica_"+linha+"' name='upload_peca_critica_"+linha+"' action='upload_peca_critica.php' method='post' enctype='multipart/form-data'>\
                        <input type='hidden' class='frm_upload_peca_critica' name='i' value='"+linha+"'>\
                        <input type='hidden' class='frm_upload_peca_critica' name='referencia_peca_critica_"+linha+"' id='referencia_peca_critica_"+linha+"' value='"+peca+"'>\
                        <input type='hidden' class='frm_upload_peca_critica' name='os' id='os' value='"+os+"'>\
                        <input type='file' class='frm_upload_peca_critica' form='upload_peca_critica_"+linha+"' name='img_peca_critica_"+linha+"' id='img_peca_critica_"+linha+"' value='' onchange=\"$('#btn_anexar_img_"+linha+"').hide(); $('#mini_anexar_img_"+linha+"').show(); $('#mini_anexar_img_"+linha+"').attr('src', 'imagens\/ajax-loader.gif'); $('#upload_peca_critica_"+linha+"').submit();\">\
                    </form>\
                    <br />\
                ");
                $("#upload_peca_critica_"+linha).ajaxForm({
                    complete: function(data) {
                        if (data.responseText == "erro") {
                            alert("Arquivo inválido, selecione outro arquivo!");
                            $("#mini_anexar_img_"+data.i).attr("src", 'image/foto.png');
                        } else {
                            data = $.parseJSON(data.responseText);
                            $("#mini_anexar_img_"+data.i).attr("src", data.file);
                            $("#mini_anexar_img_"+data.i).show();
                            $("#peca_critica_"+data.i).val("true");
                            $("#peca_critica_ext_"+data.i).val(data.ext);
                        }

                    }
                });
            }
        });
    }
}


/*$(function () {

    $("#defeito_constatado_codigo").change(function() {
        console.log("desappear here")

        //let defeito_constatado = $("#defeito_constatado_codigo").val();

        let defeito_constatado = "";

        console.log($("#defeito_constatado_descricao").val());

        if ($("#defeito_constatado_descricao").val().length > 0) {

            defeito_constatado = $("#defeito_constatado").val();
    
            console.log(defeito_constatado);
        
            adicionarSolucoes(defeito_constatado);  
        }

    });

});
*/

function getSolucoes() {

    let defeito_constatado = $("#defeito_constatado").val();

    adicionarSolucoes(defeito_constatado);
        
}

function adicionarSolucoes(defeito_constatado) {

    $.ajax({
        url: "<?=$php_self?>",
        type:"POST",
        data:{ defeito_constatado_solucao : defeito_constatado },
        beforeSend:function() {
            $("#solucao_os").html('');
            $("#solucao_os").append("<option value=''>Carregando...</option");
        },
        success: function(data) {

            console.log(data);

            if (data.length > 0) {

                $("#solucao_os").html('');
                
                data = $.parseJSON(data);

                $("#solucao_os").append("<option value=''></option");
                $.each(data, function(cod, desc) {
                    $("#solucao_os").append("<option value='"+ cod +"'>"+ desc +"</option");
                });

            }  else {

                $("#solucao_os").html('');
                $("#solucao_os").append("<option value=''>DEFEITO SEM SOLUÇÃO CADASTRADA</option");
            }
        },
    });
}


$().ready(function() {

    <? if ($login_fabrica == 15 or $login_fabrica == 74) { ?>
        ocultaLinhas();
    <?}?>

})

<?
//HD 676195 - Adicionado Famastil
//HD 710187 -  Adicionado Atlas fogoes
if ($login_fabrica == 15 || $login_fabrica==86 || $login_fabrica == 74 || $login_fabrica == 94) {

    if (strlen($os) > 0) {

        $sql            = "SELECT count(os_item) FROM tbl_os_produto JOIN tbl_os_item USING(os_produto) WHERE os = $os";
        $res_count      = pg_query($con, $sql);
        $linhas_inicial = pg_result($res_count, 0, 0);
        $linhas_item    = $linhas_inicial;

        if ($login_fabrica == 94)
        {
            if ($linhas_inicial >= 0 and $linhas_inicial < 20)
            {
                $linhas_inicial = 20;
            }
            else if ($linhas_inicial >= 20 and $linhas_inicial < 40)
            {
                $linhas_inicial = 40;
            }
            else if ($linhas_inicial >= 40 and $linhas_inicial < 60)
            {
                $linhas_inicial = 60;
            }
            else if ($linhas_inicial >= 60 and $linhas_inicial < 80)
            {
                $linhas_inicial = 80;
            }
            else if ($linhas_inicial >= 80 and $linhas_inicial < 100)
            {
                $linhas_inicial = 100;
            }
        }
        else
        {
            $linhas_inicial = $linhas_inicial + 5;
        }

        if ($linhas_inicial < 10) {

            $linhas_inicial = ($login_fabrica == 74) ? 20 : 10;
        }

    } else {
        $linhas_inicial = 10;
    } ?>
    function ocultaLinhas() {
        var qtde = $('#qtde_mostrar').val();
        var linhas_mostrar = $('select[name=n_itens]').val();
        <?
            if ($login_fabrica == 94)
            {
        ?>
                for (i=<?echo $linhas_inicial;?>;i<=300;i++) {
                    $('#mostrar_'+i).css('display', 'none');
                }
        <?
            }
            else
            {
        ?>
                for (i=linhas_mostrar;i<=150;i++) {
                    $('#mostrar_'+i).css('display', 'none');
                }
        <?
            }
        if ($login_fabrica == 74) {
        ?>

            var linhas = linhas_mostrar;

            if (linhas == 10) {
                $("select[name=n_itens]").val(10);
            }
            else if (linhas == 20) {
                $("select[name=n_itens]").val(20);
            }
            else if (linhas == 30) {
                $("select[name=n_itens]").val(30);
            }
            else if (linhas > 30) {
                $("select[name=n_itens]").val(40);
            }

        <?
        }
        ?>
    }

    function mostrarLinhas(qtde) {
        navegador = navigator.appName;
        versao = parseInt(navigator.appVersion);
        if (navegador == 'Microsoft Internet Explorer') {
            var strBlock = 'block';
        }else {
            var strBlock = 'table-row';
        }

        ocultaLinhas();
        for (i=10;i<qtde;i++) {
            $('#mostrar_'+i).css('display', strBlock);
        }
    }
<?
    if ($login_fabrica == 94)
    {
?>
        $().ready(function() {
            mostrarLinhas(20);
            $("select[name=n_itens]").val("<?=$linhas_inicial?>");
        })
<?
    }

}
?>

$().ready(function() {
    var login_fabrica = <?=$login_fabrica?>;
    $("input[rel='data']").mask("99/99/9999");//HD 785254

    $('#produto_serie').blur(function () {
        var serie = $(this).val();
        $(this).val(serie.toUpperCase());

        /*if(login_fabrica == 74){
            var numero_serie = jQuery.trim($(this).val());
            var produto_referencia = jQuery.trim($("input[name=produto_referencia]").val());

            if(numero_serie.length > 0 && produto_referencia.length > 0){
                $.ajax({
                    type: "POST",
                    url: "<?=$php_self?>",
                    data: "ajax=numero_serie&numero_serie="+numero_serie+"&produto_referencia="+produto_referencia,
                    success: function(retorno){
                        data = retorno.split('|');
                        if(data[0] == 2){
                            var pergunta = confirm("Número de série '"+numero_serie+"' é inválido \n\nA OS irá para intervenção da fábrica, caso tenha digitado errado, favor clicar no botão 'Cancelar', caso contrário, favor clicar em 'OK'");

                            if (pergunta == false){
                                $('#produto_serie').val('');
                            }
                            $("input[name=data_fabricacao]").val('');
                            $("#data_fabricacao_opener").show().find('p').html('');
                        }else{

                            var data_fab = data[4].split('-');
                            var data_fabricacao = data_fab[2]+"/"+data_fab[1]+"/"+data_fab[0];

                            if(data[2] != produto_referencia){
                                if(confirm("Para o número de série informado, o produto será trocado. Deseja continuar??")){
                                    $.ajax({
                                        url: '<? echo $PHP_SELF;?>?troca_prod=1&produto='+data[3]+'&os=<? echo $os; ?>',
                                        cache: false,
                                        success: function(result) {

                                            if(result == "ok"){
                                                $("input[name=produto_serie]").val(data[1]);
                                                $("input[name=produto_os]").val(data[3]);
                                                $("input[name=data_fabricacao]").val(data_fabricacao);
                                                $("input[name=produto_referencia]").val(data[2])
                                                $("#data_fabricacao_opener").show().find('p').html(data_fabricacao);
                                                $("#produto_descricao_opener").find('b').html(data[5]);
                                                listaDefeitos(data[2]);
                                            } else {
                                                alert('Erro ao trocar o produto');
                                            }
                                        }
                                    });

                                }
                            }else{
                                $("input[name=produto_serie]").val(data[1]);
                                $("input[name=produto_os]").val(data[3]);
                                $("input[name=data_fabricacao]").val(data_fabricacao);
                                $("#data_fabricacao_opener").show().find('p').html(data_fabricacao);
                            }

                        }
                    }
                });
            }
        }*/
    });
    if(login_fabrica == 30){
        $("#produto_serie").prop("maxlength",14);
        $("#produto_serie").keypress(function(event){
            var tecla = event.which;

            if(tecla > 47 && tecla < 58){
                return true;
            }else{
                if(tecla != 8){
                    return false;
                }else{
                    return true;
                }
            }
        });
    }
});
//  #HD 276459 visita_agendada
$(function(){
    $("#fabricacao_produto").mask("99/9999");
    $("#visita_agendada").mask("99/99/9999");
    $("input[name^=visita_agendada_]").mask("99/99/9999");
    $("#data_envio").mask("99/99/9999");
});

function abreComunicadoPeca(i){
    var referencia = document.getElementById('peca_'+i).value;
    url = "pesquisa_comunicado_peca.php?referencia=" + referencia;
    window.open(url,"Comunicado","status=yes,scrollbars=yes,directories=no,width=650,height=400,top=18,left=0");
}

var http5 = new Array();

function Verifica_dev_obrig(num){

    var rel = $("#peca_"+num).attr('rel');

    if(rel == 'sim'){
        $("#dev_obrig_"+num).show();
    }else{
        $("#dev_obrig_"+num).hide();
    }
}

function checarComunicado(i){
    var imagem     = document.getElementById('imagem_comunicado_'+i);
    var referencia = document.getElementById('peca_'+i).value;
    imagem.style.visibility = "hidden";
    imagem.title = "Não há comunicados para esta peça.";
    if (referencia.length > 0){
        var curDateTime = new Date();
        http5[curDateTime] = createRequestObject();
        url = "os_item_comunicado_ajax.php?referencia="+escape(referencia);
        http5[curDateTime].open('get',url);
        http5[curDateTime].onreadystatechange = function(){
            if (http5[curDateTime].readyState == 4)
            {
                if (http5[curDateTime].status == 200 || http5[curDateTime].status == 304)
                {
                    var response = http5[curDateTime].responseText;
                    if (response=="ok"){
                        imagem.title = "Há comunicados para esta peça. Clique aqui para ler.";
                        imagem.style.visibility = "visible";
                    }
                    else {
                        imagem.title = "Não há comunicados para esta peça.";
                        imagem.style.visibility = "hidden";
                    }
                }
            }
        }
        http5[curDateTime].send(null);
    }
}

<?php
#HD 307418
?>
    function limpaDefeito(i) {
        $('#defeito_'+i).html('<option id="op_'+i+'"></option>');
    }

    function allPrePeca(){
        if($('input[rel=check_peca]').is(":checked")){
            $("input[rel=check_peca]").attr('checked',false);
        }else{
            $("input[rel=check_peca]").attr('checked',true);
        }
    }

    function allPreDefeito(valor){
        $('input[rel=check_peca]:checked').each(
            function(){
                $(this).parent().parent().children().children('select[rel=pre_defeito]').val(valor);
        })
    }

    function atualizaQtde(campo,campo2) {

        if (campo && campo2) {

            if ( campo.value.length == 0) {
                campo2.value = '';
            }

            if (campo.value.length > 0 && campo2.value.length == 0) {
                campo2.value = 1;
            }

        }

    }

    function fnc_troca(os) {

        alert('A troca de produto deve ser feita somente quando o reparo do produto necessita de troca de peças.');

        if (confirm('A Fábrica irá fazer a troca do produto. Confirmar a troca?')) {
            window.location='<?=$php_self?>?os='+os+'&troca=1';
        }

    }
    function direcionarOsFinalizada(os) {
        if(confirm('As informações da OS foram alteradas ? Caso seja gravada entrará em Intervenção novamente e irá aguardar a aprovação da fábrica. Deseja gravar a OS? ')){ document.frm_os.btn_acao.value='gravar';}
        else{  window.location='os_finalizada.php?os='+os; alert('');}
    }

    if(referencia == undefined){
        var produto;
        var referencia;
        var descricao;
        var posicao;
        var preco;
        var qtde;
        var kit_peca;
        var serie_reoperado;
        var qtde_estoque;
    }

    //funcao lista basica tectoy, posicao, serie inicial, serie final
    function fnc_pesquisa_lista_basica2 (produto_referencia, peca_referencia, peca_descricao, peca_preco, voltagem, tipo, peca_qtde) {

        var url = "";

        if (tipo == "tudo") {
            url = "peca_pesquisa_lista.php?produto=" + produto_referencia + "&descricao=" + peca_referencia.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&exibe=<? echo $_SERVER['REQUEST_URI']; ?>";
        }

        if (tipo == "referencia") {
            url = "peca_pesquisa_lista.php?produto=" + produto_referencia + "&peca=" + peca_referencia.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&exibe=<? echo $_SERVER['REQUEST_URI']; ?>";
        }

        if (tipo == "descricao") {
            url = "peca_pesquisa_lista.php?produto=" + produto_referencia + "&descricao=" + peca_descricao.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&exibe=<? echo $_SERVER['REQUEST_URI']; ?>";
        }

        janela = window.open(url, "janela", "  status=yes, scrollbars=yes, directories=no, width=501, height=400, top=18, left=0");

        produto    = produto_referencia;
        referencia = peca_referencia;
        descricao  = peca_descricao;
        preco      = peca_preco;
        qtde       = peca_qtde;
        janela.focus();

    }


    function addAnexoUpload()
    {
        var tpl = $("#anexoTpl").html();
        var id = $("#qtde_anexos").val();

        if (id == "3") {
            return;
        }

        var rep = tpl.replace('@TYPE@', 'file');
        var tr = '<tr>' + rep.replace('@ID@', id) + '</tr>';
        $("#qtde_anexos").val(parseInt(id) + 1);

        $("#input_anexos").append(tr);
    }
    
        function validarPeca(referencia){
           $.ajax({
             url:"<?=$PHP_SELF?>",
             type:"POST",
             dataType:"json",
             data:{
                  ajax:"validar_peca_vinculada",
                  referencia:referencia
             }
           })
           .done(function(data){
               if (data != '' && data != null) {
                  $("[name^='peca_']").each(function() {
                      if ($.inArray(this.value.toString(), data.peca_mae) != -1) {
                          var mae = this.value;
                          console.log(data);
                          console.log(this.value);
                          console.log(data[mae]);
                          $.each(data[mae], function(key, value) {
                          $("[name^='peca_']").each(function() {           
                                  if (value == this.value) {
                                      name = this.name;
                                      total = (name.length) - 1;
                                      posicao = name.substring(total, name.length);
                                      alert("A peça, " + $("[name='peca_"+posicao+"']").val() + " - " + $("[name='descricao_"+posicao+"']").val() + ", será removida, pois já pertence a outra peça do pedido.");
                                      $("[name='descricao_"+posicao+"']").val("");
                                      $("[name='peca_"+posicao+"']").val("");
                                      $("[name='fornecedor_"+posicao+"'] option").remove();
                                      $("[name='defeito_"+posicao+"'] option").remove();                                  
                                   }
                                
                              });
                          });
                      };
                  });
              }           
          });//21110221 - 29190002/33510005
       }

    function carregaFornecedor(linha,peca,tipo){
        $.ajax({
            url:"<?=$PHP_SELF?>",
            type:"POST",
            dataType:"json",
            data:{
                ajax:"fornecedor_peca",
                ajax_peca:peca,
                tipo:tipo
            }
        })
        .done(function(data){
            var forn = "<option value=''>Selecione um fornecedor</option>";
            $.each(data,function(key,value){
                forn += "<option value='"+key+"'>"+value+"</option>";
            });
            $("select[name=fornecedor_"+linha+"]").html(forn);
        })
        .fail(function(){
            alert("Não foi possível carregar os fornecedores desta peça");
        });        
       validarPeca(peca);
    }

    function limpa_kit(kit_linha){
        var conteudo_kit_linha = $('#kit_peca_'+kit_linha).html();
            //alert(kit_linha);
        $('#kit_peca_'+kit_linha).html("<input name='kit_peca_"+kit_linha+"' value='kit_peca_"+kit_linha+"' type='hidden'>");
        $('input[name=descricao_'+kit_linha+']').val("");
        $('input[name=peca_'+kit_linha+']').val("");
        $('select[name=fornecedor_'+kit_linha+']').html("<option value=''></option>");
        $('#defeito_'+kit_linha).val("");
        $('#servico_'+kit_linha).val("");
    }

    function fnc_pesquisa_lista_basica_suggar(produto_referencia, peca_referencia, peca_descricao, peca_posicao, peca_preco, voltagem, tipo, kit_peca_item,linha) {
        var url = "";

        var kit_peca_item2 = "";
        var login_fabrica = <?=$login_fabrica?>;

        if (kit_peca_item[0] != undefined) {
            kit_peca_item2 = kit_peca_item[0].value;
        }

        if (tipo == "tudo") {
                url = "peca_pesquisa_lista.php?produto=" + produto_referencia + "&descricao=" + peca_referencia[0].value + "&tipo=" + tipo + "&voltagem=" + voltagem[0].value + "&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&input_posicao="+linha;
        }

        if (tipo == "referencia") {
                url = "peca_pesquisa_lista.php?produto=" + produto_referencia + "&peca=" + peca_referencia[0].value + "&tipo=" + tipo + "&voltagem=" + voltagem[0].value+"&kit_peca="+kit_peca_item2+"&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&input_posicao="+linha;
        }

        if (tipo == "descricao") {
            url = "peca_pesquisa_lista.php?produto=" + produto_referencia + "&descricao=" + peca_descricao[0].value + "&tipo=" + tipo + "&voltagem=" + voltagem[0].value +"&kit_peca="+kit_peca_item2+"&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&input_posicao="+linha;

        }

        janela = window.open(url, "janela", "  status=yes, scrollbars=yes, directories=no, width=501, height=400, top=18, left=0");

        produto    = produto_referencia[0];
        referencia = peca_referencia[0];
        descricao  = peca_descricao[0];
        posicao    = peca_posicao;
        preco      = peca_preco[0];
        qtde       = '';//HD 258901

//         if(login_fabrica == 91){
//             carregaFornecedor(posicao,referencia.value);
//         }

        if (kit_peca_item[0] != undefined) {
            kit_peca   = kit_peca_item[0];
        }

        janela.focus();

    }

    function fnc_pesquisa_lista_basica_latina(produto_referencia, peca_referencia, peca_descricao, peca_preco, voltagem, tipo, serie, kit_peca_item, defeito_constatado,i) {

        var fabrica = "<?=$login_fabrica?>";

        var url = "";

        if (tipo == "tudo") {
                url = "peca_pesquisa_lista.php?<?if (strlen($_GET['os'])>0) echo 'os='.$_GET['os'].'&';?>produto=" + produto_referencia + "&descricao=" + peca_referencia.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&input_posicao="+i;
        }

        if (tipo == "referencia") {
                url = "peca_pesquisa_lista.php?<?if (strlen($_GET['os'])>0) echo 'os='.$_GET['os'].'&';?>produto=" + produto_referencia + "&peca=" + peca_referencia.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&serie=" + serie.value + "&kit_peca="+kit_peca_item.value + "&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&input_posicao="+i;
        }

        if (tipo == "descricao") {
                url = "peca_pesquisa_lista.php?<?if (strlen($_GET['os'])>0) echo 'os='.$_GET['os'].'&';?>produto=" + produto_referencia + "&descricao=" + peca_descricao.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&serie=" + serie.value + "&kit_peca="+ kit_peca_item.value + "&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&input_posicao="+i;
        }

        if (fabrica == 15) {
            url += "&defeito_constatado="+defeito_constatado.value;
        }

        janela = window.open(url, "janela", "  status=yes, scrollbars=yes, directories=no, width=501, height=400, top=18, left=0");

        produto         = produto_referencia;
        referencia      = peca_referencia;
        descricao       = peca_descricao;
        preco           = peca_preco;
        serie_reoperado = serie_reoperado;
        janela.focus();

    }

    function createRequestObject() {

        var request_;
        var browser = navigator.appName;

        if (browser == "Microsoft Internet Explorer") {
            request_ = new ActiveXObject("Microsoft.XMLHTTP");
        } else {
            request_ = new XMLHttpRequest();
        }

        return request_;

    }

    var http_forn = new Array();

function pega_peca(os,referencia,descricao,linha) {
    var ref = document.getElementById(referencia).value;
    if(document.getElementById(referencia).value.length > 0){
        url = "<?=$php_self?>?ajax=peca&referencia="+ref+"&os="+os;
        var curDateTime = new Date();
        http_forn[curDateTime] = createRequestObject();
        http_forn[curDateTime].open('GET',url,true);
        http_forn[curDateTime].onreadystatechange = function(){
            if (http_forn[curDateTime].readyState == 4)
            {
                if (http_forn[curDateTime].status == 200 || http_forn[curDateTime].status == 304)
                {
                    var response = http_forn[curDateTime].responseText.split("|");
                    if (response[0]=="ok"){
                        document.getElementById(descricao).value = response[1];

                        <?php if ( $login_fabrica==30 ){?>
                        if ( $("#ver_estoque_"+linha).css("display")=="none" ){
                            $("#ver_estoque_"+linha).show();
                            $("#img_arrow_"+linha).show();
                        } else {
                            $('#tr_estoque_' + linha).slideUp("slow");
                            $("#img_arrow_"+linha).attr("src","imagens/barrow_down.png");
                            $('#ver_estoque_'+linha).html("Ver <br>&nbsp;&nbsp; Estoque");
                        }
                        <?}?>

                    } else {
                        $('#tr_estoque_' + linha).slideUp("slow");
                        $("#ver_estoque_"+linha).hide();
                        $("#img_arrow_"+linha).hide();
                        document.getElementById(descricao).value = "";
                    }
                }
            }

        }
        http_forn[curDateTime].send(null);

    }

}

function pega_dc(os,id,referencia,descricao){

    var ref = document.getElementById(referencia).value;
    if(document.getElementById(referencia).value.length > 0){
        url = "<?=$php_self?>?ajax=defeito_constatado&defeito_constatado="+ref+"&os="+os;

        var curDateTime = new Date();
        http_forn[curDateTime] = createRequestObject();
        http_forn[curDateTime].open('GET',url,true);
        http_forn[curDateTime].onreadystatechange = function(){
            if (http_forn[curDateTime].readyState == 4)
            {
                if (http_forn[curDateTime].status == 200 || http_forn[curDateTime].status == 304)
                {
                    var response = http_forn[curDateTime].responseText.split("|");
                    if (response[0]=="ok"){
                        document.getElementById(id).value = response[1];
                        document.getElementById(referencia).value = response[2];

                        var defeito_constatado_var = response[1]; 

                        $.ajax({
                            url: "<?php echo $_SERVER['PHP_SELF'] ?>",
                            type: "POST",
                            dataType: "JSON",
                            data: {
                                verifica_def_const_cor_etiqueta: 'true',
                                defeito_constatado : defeito_constatado_var
                            },
                            complete: function(data){
                                data = data.responseText;
                                console.log(data);

                                if(data == 'sim'){
                                    $("#fornecedor_select").show();
                                    $(".fornecedor_select").show();
                                    $("#pedir_cor_etiqueta").val('sim'); 
                                }else{
                                    $("#fornecedor_select").hide();
                                    $(".fornecedor_select").hide();
                                    $("#pedir_cor_etiqueta").val(' '); 
                                }
                            }
                        });                      

                        document.getElementById(descricao).value = response[3];
                        getSolucoes();
                    }
                }
            }
        }
        http_forn[curDateTime].send(null);
    }
}

function fnc_pesquisa_dc (os, defeito_constatado, defeito_constatado_codigo, defeito_constatado_descricao) {
    var url = "";
    if (defeito_constatado != '') {
        url = "<?=$php_self?>?defeito=defeito&os=" + os+"&defeito_constatado_codigo="+defeito_constatado_codigo.value+"&defeito_constatado_descricao="+defeito_constatado_descricao.value;

        janela = window.open(url, "janela", "  status=yes, scrollbars=yes, directories=no, width=501, height=400, top=18, left=0");
        janela.defeito_constatado           = defeito_constatado          ;
        janela.defeito_constatado_codigo    = defeito_constatado_codigo   ;
        janela.defeito_constatado_descricao = defeito_constatado_descricao;
        janela.focus();
    }

}

    function fnc_pesquisa_lista_basica (produto_referencia, peca_referencia, peca_descricao, peca_preco, voltagem, tipo, peca_qtde, defeito_constatado, qtde_estoque_item, qtde_fotos_item, serial_lcd_item, linha_i) {
        var posto_interno = '';
    <?php
        if($posto_interno === true){
    ?>
        posto_interno = 't';
    <?php
        }
    ?>
        var url = "";
        if (tipo == "tudo") {
                url = "peca_pesquisa_lista.php?produto=" + produto_referencia + "&descricao=" + peca_referencia.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&os=<?=$os?>" + "&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&defeito_constatado="+defeito_constatado.value+"&linha_i="+linha_i+"&posto_interno="+posto_interno;
        }

        if (tipo == "referencia") {
                url = "peca_pesquisa_lista.php?produto=" + produto_referencia + "&peca=" + peca_referencia.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&os=<?=$os?>" + "&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&linha_i="+linha_i+"&posto_interno="+posto_interno;
        }

        if (tipo == "descricao") {
                url = "peca_pesquisa_lista.php?produto=" + produto_referencia + "&descricao=" + peca_descricao.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&os=<?=$os?>" + "&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&defeito_constatado="+defeito_constatado.value+"&linha_i="+linha_i+"&posto_interno="+posto_interno;
        }
        janela = window.open(url, "janela", "  status=yes, scrollbars=yes, directories=no, width=501, height=400, top=18, left=0");
        produto    = produto_referencia;
        referencia = peca_referencia;
        descricao  = peca_descricao;
        preco      = peca_preco;
        qtde       = peca_qtde;

        <?php
        if ($login_fabrica == 3) {
        ?>
            qtde_fotos  = qtde_fotos_item;
            serial_lcd = serial_lcd_item;
        <?php
        }

        if (in_array($login_fabrica,[120,201])) {
        ?>
            qtde_estoque = qtde_estoque_item;
        <?php
        }
        ?>
        janela.focus();

}

//hd_chamado=2881143
function fnc_pesquisa_lista_basica_lorenzetti (produto_referencia, peca_referencia, peca_descricao, peca_preco, voltagem, tipo, peca_qtde, defeito_constatado, qtde_estoque_item, qtde_fotos_item, serial_lcd_item, linha_i) {
    if (defeito_constatado.length > 2){
        var posto_interno = '';
        <?php if($posto_interno === true){ ?>
            posto_interno = 't';
        <?php } ?>

        var url = "";
        if (tipo == "tudo") {
            url = "peca_pesquisa_lista.php?produto=" + produto_referencia + "&descricao=" + peca_referencia.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&os=<?=$os?>" + "&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&defeito_constatado="+defeito_constatado+"&linha_i="+linha_i+"&posto_interno="+posto_interno;
        }

        if (tipo == "referencia") {
            url = "peca_pesquisa_lista.php?produto=" + produto_referencia + "&peca=" + peca_referencia.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&os=<?=$os?>" + "&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&defeito_constatado="+defeito_constatado+"&linha_i="+linha_i+"&posto_interno="+posto_interno;
        }

        if (tipo == "descricao") {
            url = "peca_pesquisa_lista.php?produto=" + produto_referencia + "&descricao=" + peca_descricao.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&os=<?=$os?>" + "&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&defeito_constatado="+defeito_constatado+"&linha_i="+linha_i+"&posto_interno="+posto_interno;
        }
        janela = window.open(url, "janela", "toolbar=no, location=yes, status=yes, scrollbars=yes, directories=no, width=501, height=400, top=18, left=0");
        produto    = produto_referencia;
        referencia = peca_referencia;
        descricao  = peca_descricao;
        preco      = peca_preco;
        qtde       = peca_qtde;
        janela.focus();
    }else{
        alert("Adicione os defeitos para continuar");
    }
}




function fnc_pesquisa_peca_lista_sub (produto_referencia, peca_posicao, peca_referencia, peca_descricao) {
    var url = "";
    if (produto_referencia != '') {
        url = "peca_pesquisa_lista_subconjunto.php?produto=" + produto_referencia;
        janela = window.open(url, "janela", "  status=yes, scrollbars=yes, directories=no, width=501, height=400, top=18, left=0");
        janela.produto    = produto_referencia;
        janela.posicao    = peca_posicao;
        janela.referencia = peca_referencia;
        janela.descricao  = peca_descricao;
        janela.focus();
    }
}

function fnc_pesquisa_peca_lista_unicoba (tipo, peca_posicao, consulta) {
    var url = "";
    peca_consulta = $(consulta).val();
    if (consulta != '') {        
        url = "peca_pesquisa.php?multipeca=true&posicao=" + peca_posicao + "&campo=" + peca_consulta +  "&tipo=" + tipo;
        janela = window.open(url, "janela", "  status=yes, scrollbars=yes, directories=no, width=501, height=400, top=18, left=0");
        janela.posicao    = peca_posicao;
        janela.campo = consulta;
        janela.tipo  = tipo;
        janela.focus();
    }
}
function retorna_peca(peca_referencia,peca_descricao,linha){
    gravaDados("peca_"+linha,peca_referencia);
    gravaDados("descricao_"+linha,peca_descricao);
}
<?php
    if($login_fabrica == 50){ //HD-3246942
    ?>
        function comunicado_fora_garantia(n){

            var linha_tr                = $('#mostrar_'+n);
            var referencia              = $('#peca_'+n).val();
            var os  =  <?=$os?>;

            if(referencia.length == 0){
                $("#servico_"+n).val('');
                alert('Selecione uma peça');
                return ;
            }

            $.ajax({
                url: '<?php echo $_SERVER[PHP_SELF]; ?>',
                type: 'POST',
                data: {
                    comunicado_fora_garantia : 'ok',
                    os                       : os,
                    referencia               : referencia,
                },
                complete: function(data){
                    data = data.responseText;

                    if(data == 'bloqueada'){
                        Shadowbox.init();
                        Shadowbox.open({
                            content: "comunicado_peca_bloqueada.php",
                            player: "iframe",
                            title: "Comunicado",
                            width: 800,
                            height: 325,
                            options: {
                                modal: true,
                                enableKeys: false
                            }
                        });
                        $("#sb-nav").css({ display: "none" });
                        $("#peca_"+n).val('');
                        $("#descricao_"+n).val('');
                        $("#defeito_"+n).val('');
                        $("#servico_"+n).val('');
                    }
                }
            });

        }
    <?php
    }
    if(in_array($login_fabrica,array(35,72,74,134))){
        ?>

        var ajax_estoque = {};

        function verificaEstoqueMinimo(peca){
            $.ajax({
                url: '<?php echo $_SERVER[PHP_SELF]; ?>',
                type: 'POST',
                data: {
                    estoque_minimo : 'ok',
                    peca_estoque_minimo : peca
                },
                complete: function(data){
                    data = data.responseText;

                    if(data == "estoque_minimo"){
                        alert("A peça "+ peca + " já atingiu seu estoque mí­nimo. Realizar um pedido de compra para esta peça.");
                    }
                }
            });
        }

        function limpaMovimentacaoEstoque(n){
            var os                      = '<?=$os?>';
            var servico                 = $('#servico_'+n).val();
            var limpa_movimento_estoque2 = "ok";
            var qtde                    = $('#qtde_'+n).val();
            var referencia              = $('#peca_'+n).val();
            var os_item                 = $('input[name=os_item_'+n+']').val();
            var input_refpeca           = $('#input_refpeca_'+n).val();

            $.ajax({
                url: '<?php echo $_SERVER[PHP_SELF]; ?>',
                type: 'POST',
                data: {
                    limpa_movimento_estoque2 : limpa_movimento_estoque2,
                    os                      : os,
                    servico                 : servico,
                    qtde                    : qtde,
                    referencia              : referencia,
                    os_item                 : os_item,
                    input_refpeca           : input_refpeca
                },
                beforeSend: function(){
                    ajax_estoque[n] = true;
                    $('#loading_'+n).show();
                },
                complete: function(data){
                    data = data.responseText;
                    ajax_estoque[n] = false;
                    $('#loading_'+n).hide();
                }
            });

        }
        <?php
    }

?>

/* FUNÇÃO PARA INTELBRAS E SUGGAR - POIS TEM POSIÇÃO PARA SER PESQUISADA */
function fnc_pesquisa_peca_lista_intel (produto_referencia, peca_referencia, peca_descricao, peca_posicao, tipo) {

    var url = "";

    if (tipo == "tudo") {
        url = "peca_pesquisa_lista.php?produto=" + produto_referencia + "&descricao=" + peca_referencia.value + "&tipo=" + tipo + "&faturado=sim";
    }

    if (tipo == "referencia") {
        url = "peca_pesquisa_lista.php?produto=" + produto_referencia + "&peca=" + peca_referencia.value + "&tipo=" + tipo + "&faturado=sim";
    }

    if (tipo == "descricao") {
        url = "peca_pesquisa_lista.php?produto=" + produto_referencia + "&descricao=" + peca_descricao.value + "&tipo=" + tipo + "&faturado=sim";
    }

    if (peca_referencia.value.length >= 4 || peca_descricao.value.length >= 4) {

        janela = window.open(url, "janela", "  status=yes, scrollbars=yes, directories=no, width=501, height=400, top=18, left=0");

        janela.produto    = produto_referencia;
        janela.referencia = peca_referencia;
        janela.descricao  = peca_descricao;
        janela.posicao    = peca_posicao;
        janela.preco      = '';//HD 258901
        janela.focus();

    } else {

        alert("Digite pelo menos 4 caracteres!");

    }

}

function gravaDados(name, valor){
    try {
        $("#"+name).val(valor);
    } catch(err){
        return false;
    }
    Shadowbox.close();
}

function fnc_pesquisa_lista_serie(linha,produto_referencia, peca_referencia, peca_descricao, produto_serie, tipo, peca_qtde) {
    var busca_peca      = peca_referencia.value || peca_descricao.value ;
    var tipo_busca_peca = (tipo == 'referencia') ? 'peca' : 'descricao';
    var params = {
        'os': os,
        'tipo': tipo,
        'linha': linha,
        'exibe': document.location.pathname,
        'produto': produto_referencia,
        'produto_serie': produto_serie.value
    };
    params[tipo_busca_peca] = busca_peca;

    // Adiciona o valor se existe o elemento input no formulário
    if (typeof document.frm_os.versao_produto !== 'undefined') {
        if (document.frm_os.versao_produto.value.length > 0)
            params.versao_produto = document.frm_os.versao_produto.value;
    }

    Shadowbox.open({
        content: "peca_pesquisa_lista_serie.php?" + toQueryString(params),
        player: "iframe",
        title: "Pesquisa Lista",
        width: 501,
        height: 400
    });
}


function retorna_pecas_lbm(peca_referencia,peca_descricao,depara_auditoria,linha){
    gravaDados("peca_"+linha,peca_referencia);
    gravaDados("descricao_"+linha,peca_descricao);
    gravaDados("depara_auditoria_"+linha,depara_auditoria);
}

/* FUNÇÃO PARA buscar número de série e referencia do produto*/

function fnc_pesquisa_peca_serie(serie,peca_referencia,peca_descricao) {

    var url = "peca_pesquisa_serie.php?serie=" + serie;

    if (serie.length > 0 ) {

        janela = window.open(url, "janela", "  status=yes, scrollbars=yes, directories=no, width=501, height=400, top=18, left=0");
        janela.referencia = peca_referencia;
        janela.descricao  = peca_descricao;
        janela.focus();

    } else {

        alert("Digite o número de série!");

    }

}

function listaSolucao(defeito_constatado, produto_linha,defeito_reclamado, produto_familia) {
    var numOs = $('input[name ="os"]').val(); 

    if(defeito_constatado != 16149){
        $("#fornecedor_select").hide();
        $(".fornecedor_select").hide();
        $("#pedir_cor_etiqueta").val(' '); 
    }else{
        $("#fornecedor_select").show();
        $(".fornecedor_select").show();
        $("#pedir_cor_etiqueta").val('sim');         
    }

    $.ajax({
        url : "ajax_solucao.php",
        type: "GET",
        data: {defeito_constatado:defeito_constatado,defeito_reclamado:defeito_reclamado,produto_linha:produto_linha,produto_familia:produto_familia, num_os:numOs},
        complete: function(data){
            if(data.responseText != ""){
                //$("#solucao_os").html(data.responseText);
                $("#solucao_os").html('');
                $("#solucao_os").append("<option value=''></option");
                $("#solucao_os").append(data.responseText);
            }else{
                $("#solucao_os").html("<option value=''>Nenhuma solução encontrada</option>");
            }
        }
    });
}

function listaSolucao_antigo(defeito_constatado, produto_linha,defeito_reclamado, produto_familia) {

    try {
        ajax = new ActiveXObject("Microsoft.XMLHTTP");
    } catch(e) {

        try {ajax = new ActiveXObject("Msxml2.XMLHTTP");}
        catch(ex) {
            try {
                ajax = new XMLHttpRequest();
            } catch(exc) {
                alert("Esse browser não tem recursos para uso do Ajax"); ajax = null;
            }
        }

    }

    if (ajax) {
    if(document.forms[0].solucao_os){
        document.forms[0].solucao_os.options.length = 1;
    }
        idOpcao  = document.getElementById("opcoes");
        ajax.open("GET", "ajax_solucao.php?defeito_constatado="+defeito_constatado+"&defeito_reclamado="+defeito_reclamado+"&produto_linha="+produto_linha+"&produto_familia="+produto_familia);
        ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

        ajax.onreadystatechange = function() {
        if(ajax.readyState == 1) {idOpcao.innerHTML = "Carregando...!";}
            if(ajax.readyState == 4 ) {
                if(ajax.responseXML) {
                    montaComboSolucao(ajax.responseXML);
                } else {
            if(document.forms[0].solucao_os){
                        idOpcao.innerHTML = "Selecione a solucao";
            }
                }
            }
        }
        var params = "defeito_constatado="+defeito_constatado+"&defeito_reclamado="+defeito_reclamado+"&produto_linha="+produto_linha+"&produto_familia="+produto_familia;
        ajax.send(null);
    }
}

function listaSolucaoGrupo(defeito_constatado_grupo,familia) {
    try {
        ajax = new ActiveXObject("Microsoft.XMLHTTP");
    }
    catch(e) {
        try {ajax = new ActiveXObject("Msxml2.XMLHTTP");}
        catch(ex) {
            try {
                ajax = new XMLHttpRequest();
            }
            catch(exc) {
                alert("Esse browser não tem recursos para uso do Ajax"); ajax = null;
            }
        }
    }
    if(ajax) {

        var idOpcao = document.getElementById('defeito_constatado');
//        alert("ajax_defeito_constatado_grupo.php?defeito_constatado_grupo="+defeito_constatado_grupo+"&os="+os);
        ajax.open("GET", "ajax_defeito_constatado_grupo.php?defeito_constatado_grupo="+defeito_constatado_grupo+"&familia="+familia);
        ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        ajax.onreadystatechange = function() {
            if(ajax.readyState == 1) {idOpcao.innerHTML = "Carregando...!";}
            if(ajax.readyState == 4 ) {
                if(ajax.responseXML) {
                    montaComboConstatado(ajax.responseXML,idOpcao);
                }
            }
        }
        var params = "defeito_constatado_grupo="+defeito_constatado_grupo;
        ajax.send(null);
    }
}

function montaComboSolucao(obj){
    var dataArray   = obj.getElementsByTagName("produto");
    if(dataArray.length > 0) {
        for(var i = 0 ; i < dataArray.length ; i++) {
            var item = dataArray[i];
            var codigo    =  item.getElementsByTagName("codigo")[0].firstChild.nodeValue;
            var nome =  item.getElementsByTagName("nome")[0].firstChild.nodeValue;
            idOpcao.innerHTML = "";
            var novo = document.createElement("option");
            novo.setAttribute("id", "opcoes");
            novo.value = codigo;
            novo.text  = nome;
            document.forms[0].solucao_os.options.add(novo);
        }
    } else {
        idOpcao.innerHTML = "Nenhuma solução encontrada";
    }
}

// Defeito Constatado - Combo
function listaConstatado(linha,familia, defeito_reclamado,defeito_constatado) {
    try {
        ajax = new ActiveXObject("Microsoft.XMLHTTP");
    } catch(e) {
        try {
            ajax = new ActiveXObject("Msxml2.XMLHTTP");
        } catch(ex) {
            try {
                ajax = new XMLHttpRequest();
            } catch(exc) {
                alert("Esse browser não tem recursos para uso do Ajax"); ajax = null;
            }
        }
    }

    if (ajax) {
        defeito_constatado.options.length = 1;
        idOpcao  = document.getElementById("opcoes2");
        ajax.open("GET","ajax_defeito_constatado.php?defeito_reclamado="+defeito_reclamado+"&produto_familia="+familia+"&produto_linha="+linha);
        ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

        ajax.onreadystatechange = function() {
            if(ajax.readyState == 1) {
               // idOpcao.innerHTML = "Carregando...!";
            }
            if (ajax.readyState == 4) {
                if (ajax.responseXML) {
                    montaComboConstatado(ajax.responseXML,defeito_constatado);
                } else {
                    idOpcao.innerHTML = "Selecione o <?=$tema?>";
                }
            }
        }
        ajax.send(null);
    }

}

function montaComboConstatado(obj,defeito_constatado) {
    var dataArray = obj.getElementsByTagName("produto");

    $(defeito_constatado).find('option').each(function(){
        $(this).remove();
    });

    if (dataArray.length > 0) {

        var novo = document.createElement("option");
        novo.setAttribute("id", "opcoes2");
        var defeito = "<? echo $defeito_descricao;?>";

        if (defeito.length > 0) {;
            novo.text  = defeito;
            <? if($login_fabrica <> 52){ ?>
                    defeito_constatado.options.add(novo);
                    defeito_constatado.options[0].value="<? echo $defeito_constatado;?>";
            <? } ?>
        } else {
            novo.text  = "Selecione o Defeito";
            novo.setAttribute("value","");
            defeito_constatado.options.add(novo);
        }

        for (var i = 0 ; i < dataArray.length ; i++) {
            //percorre o arquivo XML paara extrair os dados
            var item = dataArray[i];
            var codigo    =  item.getElementsByTagName("codigo")[0].firstChild.nodeValue;
            var nome =  item.getElementsByTagName("nome")[0].firstChild.nodeValue;
            var novo = document.createElement("option");
            novo.setAttribute("id", "opcoes2");
            novo.value = codigo;
            novo.text  = nome;
            defeito_constatado.options.add(novo);//adiciona
        }

    } else {
        defeito_constatado.innerHTML = "Selecione o defeito";
    }

}

function listaDefeitos(valor) {
    //verifica se o browser tem suporte a ajax
    try {
        ajax = new ActiveXObject("Microsoft.XMLHTTP");
    } catch(e) {
        try {
            ajax = new ActiveXObject("Msxml2.XMLHTTP");
        } catch(ex) {
            try {
                ajax = new XMLHttpRequest();
            } catch(exc) {
                alert("Esse browser não tem recursos para uso do Ajax"); ajax = null;
            }
        }
    }
    //se tiver suporte ajax
    if (ajax) {
        //deixa apenas o elemento 1 no option, os outros são excluÃ­dos
        document.forms[0].defeito_reclamado.options.length = 1;
        //opcoes é o nome do campo combo
        idOpcao = document.getElementById("opcoes");
        //ajax.open("POST", "ajax_produto.php", true);
        ajax.open("GET", "ajax_produto.php?produto_referencia="+valor, true);
        ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

        ajax.onreadystatechange = function() {
            if (ajax.readyState == 1) {idOpcao.innerHTML = "Carregando...!";}//enquanto estiver processando...emite a msg
            if (ajax.readyState == 4 ) {
                if(ajax.responseXML) {
                    montaCombo(ajax.responseXML);//após ser processado-chama fun
                } else {
                    idOpcao.innerHTML = "Selecione o defeito";//caso não seja um arquivo XML emite a mensagem abaixo
                }
            }
        }
        //passa o código do produto escolhido
        var params = "produto_referencia="+valor;
        ajax.send(null);
    }
}

function montaCombo(obj){
    var dataArray   = obj.getElementsByTagName("produto");//pega a tag produto
    if(dataArray.length > 0) {//total de elementos contidos na tag cidade
    for(var i = 0 ; i < dataArray.length ; i++) {     //percorre o arquivo XML paara extrair os dados
         var item = dataArray[i];
        //contéudo dos campos no arquivo XML
        var codigo    =  item.getElementsByTagName("codigo")[0].firstChild.nodeValue;
        var nome =  item.getElementsByTagName("nome")[0].firstChild.nodeValue;
        idOpcao.innerHTML = "Selecione o defeito";
        //cria um novo option dinamicamente
        var novo = document.createElement("option");
        novo.setAttribute("id", "opcoes");//atribui um ID a esse elemento
        novo.value = codigo;        //atribui um valor
        novo.text  = nome;//atribui um texto
        document.forms[0].defeito_reclamado.options.add(novo);//adiciona o novo elemento
        }
    } else { idOpcao.innerHTML = "Selecione o defeito";//caso o XML volte vazio, printa a mensagem abaixo
    }
}

/**
* NOVA FUNÇÃO defeitoLista
*/

function defeitoLista(peca,linha,os) {
    var kit     = '';
    var defeito = "defeito_"+linha;
    var op      = "op_"+linha;
    var idOpcao = op;

    if ($('#kit_kit_peca_'+linha)) {
        kit = $('#kit_kit_peca_'+linha).val();
    }

    if (peca != "") {
        $.ajax({
            url:"ajax_defeito2.php",
            dataType: "xml",
            type:"POST",
            data:{
                peca:peca,
                os:os,
                kit_peca:kit
            },
            beforeSend:function(){
                $("#"+defeito).empty();
                $("#"+defeito+" #"+idOpcao).html("carregando...");
            }
        })
        .done(function(xml){
            var option = "<option value=''>Selecione Defeito</option>";
            $(xml).find("produto").each(function(){
                var codigo  = $(this).find("codigo").text();
                var nome    = $(this).find("nome").text();

                option += "<option value="+codigo+">"+nome+"</option>";
            });
            $("#"+defeito).html(option);
        })
        .fail(function(){
            alert("Não foi possível carregar o defeito da peça");
        });
    }
}

function defeitoPeca(peca,linha) {
    try {ajax = new ActiveXObject("Microsoft.XMLHTTP");}
    catch(e) {
        try {ajax = new ActiveXObject("Msxml2.XMLHTTP");}
        catch(ex) { try {ajax = new XMLHttpRequest();}
            catch(exc) {alert("Esse browser não tem recursos para uso do Ajax"); ajax = null;}
        }
    }
    if(peca.length > 0) {
        if(ajax) {
            var defeito = "defeito_"+linha;
            var op = "op_"+linha;
            eval("document.forms[0]."+defeito+".options.length = 1;");
            idOpcao  = document.getElementById(op);
            ajax.open("GET","ajax_defeito_peca.php?peca="+peca);
            ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            ajax.onreadystatechange = function() {
                if(ajax.readyState == 1) {idOpcao.innerHTML = "Carregando...!";}
                if(ajax.readyState == 4 ) {
                    if(ajax.responseXML) {
                        montaComboDefeito(ajax.responseXML,linha);
                    }
                    else {
                        idOpcao.innerHTML = "Nenhum defeito";
                    }
                }
            }
            ajax.send(null);
        }
    }
    <?
        if($login_fabrica <> 120 and $login_fabrica <> 201){
    ?>
     var servico = "servico_"+linha;
     eval("document.forms[0]."+servico+".options.length = 1;");
     <?
    }
    ?>
}

function listaServico(defeito,linha,peca) {
    try {ajax = new ActiveXObject("Microsoft.XMLHTTP");}
    catch(e) {
        try {ajax = new ActiveXObject("Msxml2.XMLHTTP");}
        catch(ex) { try {ajax = new XMLHttpRequest();}
            catch(exc) {alert("Esse browser não tem recursos para uso do Ajax"); ajax = null;}
        }
    }
    if(defeito.length > 0) {
        if(ajax) {
            var servico = "servico_"+linha;
            var op      = "op_"+linha;
        eval("document.forms[0]."+servico+".options.length = 1;");
        idOpcao  = document.getElementById(op);
            ajax.open("GET","ajax_servico_defeito.php?defeito="+defeito+"&peca="+peca);
            ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            ajax.onreadystatechange = function() {
                if(ajax.readyState == 1) {idOpcao.innerHTML = "Carregando...!";}
                if(ajax.readyState == 4 ) {
                    if(ajax.responseXML) {
                        montaComboServicoDefeito(ajax.responseXML,linha);
                    } else {
                        idOpcao.innerHTML = "Nenhum serviço";
                    }
                }
            }
            ajax.send(null);
        }
    }
}
function montaComboServicoDefeito(obj,linha){
    var servico = "servico_"+linha;
    var op_servico = "op_"+linha;
    var dataArray   = obj.getElementsByTagName("produto");
    if(dataArray.length > 0) {
        for(var i = 0 ; i < dataArray.length ; i++) {
            var item = dataArray[i];
            var codigo    =  item.getElementsByTagName("codigo")[0].firstChild.nodeValue;
            var nome =  item.getElementsByTagName("nome")[0].firstChild.nodeValue;

        <?if($login_fabrica == 74) {?>
            idOpcao.innerHTML = "Selecione o defeito";
        <?}?>
            var novo = document.createElement("option");

            novo.setAttribute("id_servico", op_servico);
            novo.value = codigo;
            novo.text  = nome;
            eval("document.forms[0]."+servico+".options.add(novo);");
        }
    } else {
        idOpcao.innerHTML = "Selecione o defeito";
    }
}

function montaComboDefeito(obj,linha) {

    var defeito = "defeito_"+linha;
    var op = "op_"+linha;
    var dataArray   = obj.getElementsByTagName("produto");

    if (dataArray.length > 0) {

        for (var i = 0; i < dataArray.length; i++) {

            var item   = dataArray[i];
            var codigo =  item.getElementsByTagName("codigo")[0].firstChild.nodeValue;
            var nome   =  item.getElementsByTagName("nome")[0].firstChild.nodeValue;

            idOpcao.innerHTML = "Selecione o defeito";
            var novo          = document.createElement("option");

            novo.setAttribute("id", op);//atribui um ID a esse elemento
            novo.value = codigo;        //atribui um valor
            novo.text  = nome;          //atribui um texto

            eval("document.forms[0]."+defeito+".options.add(novo);");//adiciona

        }

    } else {
        idOpcao.innerHTML = "Selecione o defeito";//caso o XML volte vazio, printa a mensagem abaixo
    }

}

function servicoLista(peca,linha) {

    if(peca.length > 0) {
        var servico     = "servico_"+linha;
        var op_servico  = "op_"+linha;
        idOpcao_servico = document.getElementById(op_servico);
        $.ajax({
            type: "GET",
            url: "ajax_servico.php",
            dataType: "xml",
            data: {
                peca:peca
            }
        })
        .done(function(xml) {
            var options = "<option value=''>&nbsp;</option>";
            $(xml).find("produto").each(function(){
                var codigo = $(this).find("codigo").text();
                var nome = $(this).find("nome").text();

                options += "<option value='"+codigo+"' >"+nome+"</option>";
            });
            $("#"+servico).html(options);

        });
    }
}
function montaComboServico(obj,linha){
    var servico = "servico_"+linha;
    var op_servico = "op_"+linha;
    var dataArray   = obj.getElementsByTagName("produto");
    if(dataArray.length > 0) {
        for(var i = 0 ; i < dataArray.length ; i++) {
            var item = dataArray[i];
            var codigo    =  item.getElementsByTagName("codigo")[0].firstChild.nodeValue;
            var nome =  item.getElementsByTagName("nome")[0].firstChild.nodeValue;

            idOpcao_servico.innerHTML = "Selecione o defeito";

            var novo = document.createElement("option");

            novo.setAttribute("id_servico", op_servico);
            novo.value = codigo;
            novo.text  = nome;
            eval("document.forms[0]."+servico+".options.add(novo);");
        }
    } else {
        idOpcao_servico.innerHTML = "Selecione o defeito";
    }
}

function verificaIntegridade(){
    var defeito = $("#defeito_constatado").val();
    var linhas = $("#tbl_integridade tbody tr").length;
    var qtde_linhas = $("#qtde_linhas_defeito").val();

    if(qtde_linhas == 0 && linhas > 0){
        qtde_linhas = linhas;
    }else{
        qtde_linhas++;
    }
    $("#qtde_linhas_defeito").val(qtde_linhas);

    if(qtde_linhas > 1){
        if(defeito == 12485 || defeito == 11792){
            if(confirm("Os defeitos selecionados anteriormente serão exclui­dos. Deseja continuar?")){
                 $('#tbl_integridade').find('tbody tr').remove();
            }else{
                return false;
            }
        }else{
            for(j = 1; j <= qtde_linhas; j++){
                linha_exclui = document.getElementById('integridade_defeito_constatado_'+j);
                if(linha_exclui != null){
                    if(linha_exclui.value == 12485 || linha_exclui.value == 11792){
                        if(confirm("O defeito selecionado anteriormente será exclui­do. Deseja continuar?")){
                            $('#tbl_integridade').find('tbody tr').remove();
                        }else{
                            return false;
                        }
                    }
                }

            }
        }
    }
}

function verificaDuplicidade(defeito_constatado, solucao, xxproduto_linha, defeito_reclamado, xxproduto_familia) {

    var tabela_defeitos = $("#tbl_integridade tbody tr");
    
    var array_defeitos = [];
    
    tabela_defeitos.each(function (index, tr) {

        let tds = $(tr).find("td");

        var i = 1; 
        
        var string; 

        tds.each(function(idx, td) {
 
            if (i == 1) {

                string = $(td).find("input").val();
            }

            if (i == 2) {

                string = string + " - " + $(td).find("input").val();
            }

            if (i == 3) {

                array_defeitos.push(string);

                i = 1;

            } 

            if (i < 3) {

                i++;

            } else {
                
                i = 0;
            }
        });
    });
       
    var ok = true; 

    $.each(array_defeitos, function(indx, def_sol) {

        let defeito_solucao = def_sol.split(" - ");
            
        if (defeito_solucao[0] == defeito_constatado) {

            //if (defeito_solucao[1] == solucao) {

                ok = false;
            //}
        }

    });

    if (ok) {        

        var fornecedor_select = parseInt($("#fornecedor_select").val());
        var pedir_cor_etiqueta = $("#pedir_cor_etiqueta").val(); 

        if(!Number.isInteger(fornecedor_select) && pedir_cor_etiqueta == 'sim'){
            alert("Informe uma cor da etiqueta"); 
            return false; 
        }

        if(fornecedor_select.length >0){
            $("#cor_etiqueta_fornecedor").val(fornecedor_select);
        }        


        adicionaIntegridade(); 
        //$("#fornecedor_select").hide();

	<?php if ($login_fabrica == 30) { ?>
		//$('#solucao_os').empty().append('<option value="' + solucao + '">SELECIONE DEFEITO CONSTATADO</option>');
	<?php } else { ?>
	        listaSolucao(defeito_constatado, xxproduto_linha, defeito_reclamado, xxproduto_familia);
	<?php } ?>

    } else {

        alert("Defeito Constatado já adicionado");
    }
 
}

function adicionaIntegridade() {

    if(document.getElementById('defeito_constatado_codigo').value =="" && document.getElementById('defeito_constatado_descricao').value== "") {
        alert('Selecione o <?=$tema?>');
        return false;
    }
    <? if (in_array($login_fabrica, [2,30,43,59,85])) { ?>
            if(document.getElementById('solucao_os').options[document.getElementById('solucao_os').selectedIndex].text==""){
                alert('Selecione a solução');
                return false
            }
    <? } ?>

    <? if($login_fabrica == 30 ) { ?>
        var verifica = verificaIntegridade();
        if(verifica == false){
            return false;
        }
    <? } ?>


    var tbl = document.getElementById('tbl_integridade');
    var lastRow = tbl.rows.length;
    var iteration = lastRow;

        if (iteration>0){
            document.getElementById('tbl_integridade').style.display = "inline";
        }

        var linha = document.createElement('tr');
        linha.style.cssText = 'color: #000000; text-align: left; font-size:10px';

        // COLUNA 1 - LINHA
        <? if (!in_array($login_fabrica, [2,59])) { ?>
            var celula = criaCelula(document.getElementById('defeito_constatado_codigo').value + '-'+document.getElementById('defeito_constatado_descricao').value);
            celula.style.cssText = 'text-align: left; color: #000000;font-size:10px';
        <? } else { ?>
            var celula = criaCelula('-'+document.getElementById('defeito_constatado_descricao').value);
            celula.style.cssText = 'text-align: left; color: #000000;font-size:10px';
        <? } ?>

        <?php if($login_fabrica == 30 ){ ?>
            var teste = $("input[name='integridade_defeito_constatado_"+iteration+"']" ).val();
        <?php } else {  ?>
            var teste = $('#integridade_defeito_constatado_' + iteration.toString()).val();
        <?php } ?>

        while (typeof(teste) == 'string') {
            iteration++;
            
            teste = $('#integridade_defeito_constatado_' + iteration.toString()).val();
        }

        var el = document.createElement('input');
        el.setAttribute('type', 'hidden');
        el.setAttribute('name', 'integridade_defeito_constatado_' + iteration);
        el.setAttribute('id', 'integridade_defeito_constatado_' + iteration);
        el.setAttribute('value',document.getElementById('defeito_constatado').value);
        celula.appendChild(el);
        linha.appendChild(celula);
    <? if($login_fabrica == 30) { ?>
        var el = document.createElement('input');
        el.setAttribute('type', 'hidden');
        el.setAttribute('name', 'integridade_defeito_descricao_' + iteration);
        el.setAttribute('id', 'integridade_defeito_descricao_' + iteration);
        el.setAttribute('value',document.getElementById('defeito_constatado_descricao').value);
        celula.appendChild(el);
        linha.appendChild(celula);

        var el = document.createElement('input');
        el.setAttribute('type', 'hidden');
        el.setAttribute('name', 'qtde_integridade');
        el.setAttribute('id', 'qtde_integridade');
        el.setAttribute('value',iteration);
        celula.appendChild(el);
        linha.appendChild(celula);
    <? } ?>
        <? if(in_array($login_fabrica, [2,30,43,59,85])) { ?>
            // COLUNA 2 - HD:  67783 ADICIONADO A SOLUÇÃO NA TABELA DE DEFEITOS: DEFEITO + SOLUCAO
            var celula = criaCelula(document.getElementById('solucao_os').options[document.getElementById('solucao_os').selectedIndex].text );
            celula.style.cssText = 'text-align: left; color: #000000;font-size:10px';

            var el = document.createElement('input');
            el.setAttribute('type', 'hidden');
            el.setAttribute('name', 'integridade_solucao_' + iteration);
            el.setAttribute('id', 'integridade_solucao_' + iteration);
            el.setAttribute('value',document.getElementById('solucao_os').value);
            celula.appendChild(el);

            linha.appendChild(celula);
        
        <? } ?>

        <?php if(in_array($login_fabrica, [30])) { ?>

            if($("#pedir_cor_etiqueta").val() == 'sim'){
                var celula = criaCelula(document.getElementById('fornecedor_select').options[document.getElementById('fornecedor_select').selectedIndex].text);
                celula.style.cssText = 'text-align: left; color: #000000;font-size:10px';

                var el = document.createElement('input');
                el.setAttribute('type', 'hidden');
                el.setAttribute('name', 'integridade_cor_fornecedor_' + iteration);
                el.setAttribute('id', 'integridade_cor_fornecedor_' + iteration);
                el.setAttribute('value', document.getElementById('fornecedor_select').value);
                celula.appendChild(el);

                linha.appendChild(celula);
            }else{
                var celula = criaCelula('');
                celula.style.cssText = 'text-align: left; color: #000000;font-size:10px';

                var el = document.createElement('input');
                el.setAttribute('type', 'hidden');
                el.setAttribute('name', 'integridade_cor_fornecedor_' + iteration);
                el.setAttribute('id', 'integridade_cor_fornecedor_' + iteration);
                el.setAttribute('value', '');
                celula.appendChild(el);

                linha.appendChild(celula);
            }
        <?php } ?>


        // coluna 6 - botacao
        var celula = document.createElement('td');
        celula.style.cssText = 'text-align: right; color: #000000;font-size:10px';

        var el = document.createElement('input');
        el.setAttribute('type', 'button');
        el.setAttribute('value','Excluir');
        el.onclick=function(){removerIntegridade(this,'nao');};
        celula.appendChild(el);
        linha.appendChild(celula);

        <? if($login_fabrica == 43 ) { ?>
                var agt = navigator.userAgent.toLowerCase();
                var is_ie = (agt.indexOf("msie")!=-1 && document.all);
                 var celula = document.createElement('td');
                celula.style.cssText = 'text-align: center; color: #000000;font-size:10px';
            if(is_ie){
                radio = document.createElement('<input name="principal" id="principal" type="radio" value="'+document.getElementById('defeito_constatado').value+'"/>');
                celula.appendChild(radio);
                linha.appendChild(celula);
            }else{
                var el = document.createElement('input');
                el.setAttribute('type', 'radio');
                el.setAttribute('name', 'principal');
                el.setAttribute('value',document.getElementById('defeito_constatado').value);
                celula.appendChild(el);
                linha.appendChild(celula);
            }
        <? } ?>

        // finaliza linha da tabela
        var tbody =tbl.getElementsByTagName("tbody")[0];
        tbody.appendChild(linha);
        tbl.appendChild(tbody);

        //document.getElementById('solucao').selectedIndex=0;
        $('#solucao_os').empty();

        if(document.getElementById('defeito_constatado_descricao').value != ""){
            document.getElementById('defeito_constatado_descricao').value = "";
            document.getElementById('defeito_constatado_codigo').value = "";            
        }

       if(document.getElementById('defeito_constatado').value == 12485 || document.getElementById('defeito_constatado').value == 11792){
           $("#arquivo_defeito_constatado_col").show();
           if($('#msg_int').length == 0 ){
               $("#arquivo_defeito_constatado_col").append("<div id='msg_int'></div>");
           }
           if(document.getElementById('defeito_constatado').value == 12485){
               $("#msg_int").html('Favor, anexar a ata ou o termo de audiência');
           } else{
               $("#msg_int").html('Favor, anexar a OS assinada pelo cliente');
           }
       }else{
            $("#arquivo_defeito_constatado_col").hide();
       }
    }

function adicionaIntegridade3() {

    if(document.getElementById('defeito_constatado_codigo').value =="") {
        alert('Selecione o <?=$tema?>');
        return false;
    }

    var tbl = document.getElementById('tbl_integridade');
    var lastRow = tbl.rows.length;
    var iteration = lastRow;

        if (iteration>0){
            document.getElementById('tbl_integridade').style.display = "inline";
        }

        var linha = document.createElement('tr');
        linha.style.cssText = 'color: #000000; text-align: left; font-size:10px';

        // COLUNA 1 - LINHA

        var celula =
        criaCelula(document.getElementById('defeito_constatado_codigo').value + '-'+document.frm_os.defeito_constatado_codigo.options[document.frm_os.defeito_constatado_codigo.selectedIndex].text);
        celula.style.cssText = 'text-align: left; color: #000000;font-size:10px';

        var el = document.createElement('input');
        el.setAttribute('type', 'hidden');
        el.setAttribute('name', 'integridade_defeito_constatado_' + iteration);
        el.setAttribute('id', 'integridade_defeito_constatado_' + iteration);
        el.setAttribute('value',document.getElementById('defeito_constatado_codigo').value);
        celula.appendChild(el);
        linha.appendChild(celula);

        var el = document.createElement('input');
        el.setAttribute('type', 'hidden');
        el.setAttribute('name', 'integridade_cor_fornecedor_' + iteration);
        el.setAttribute('id', 'integridade_cor_fornecedor_' + iteration);
        el.setAttribute('value',document.getElementById('defeito_constatado_codigo').value);
        celula.appendChild(el);
        linha.appendChild(celula);

        // coluna 6 - botacao
        var celula = document.createElement('td');
        celula.style.cssText = 'text-align: right; color: #000000;font-size:10px';

        var el = document.createElement('img');
        el.setAttribute('src','imagens/ico_excluir.gif');
        el.setAttribute('width','13');
        el.onclick=function(){removerIntegridade(this,'nao');};
        celula.appendChild(el);
        linha.appendChild(celula);

        // finaliza linha da tabela
        var tbody =tbl.getElementsByTagName("tbody")[0];
        tbody.appendChild(linha);
        tbl.appendChild(tbody);

        document.getElementById('defeito_constatado_codigo').selectedIndex=0;

    }

var jsonDefeitos = new Array();

function adicionaIntegridade4(){

    if(document.getElementById('defeito_constatado_codigo').value =="") {
        alert('Selecione o <?=$tema?>');
        return false;
    }

    var tbl = document.getElementById('tbl_integridade');
    var lastRow = tbl.rows.length;
    var iteration = lastRow;

    if (iteration>0){
        document.getElementById('tbl_integridade').style.display = "inline";
    }

    var linha = document.createElement('tr');
    linha.style.cssText = 'color: #000000; text-align: left; font-size:10px';

    var defeito_constatado = $("#defeito_constatado_codigo").attr('value');
    var defeito_constatado_codigo = $("#defeito_constatado_codigo option:selected").attr('codigo');
    var defeito_descricao = $("#defeito_constatado_codigo option:selected").text();

    var celula =
        criaCelula(document.getElementById('defeito_constatado_codigo').value + '-'+document.frm_os.defeito_constatado_codigo.options[document.frm_os.defeito_constatado_codigo.selectedIndex].text);
        celula.style.cssText = 'text-align: left; color: #000000;font-size:10px';

        var el = document.createElement('input');
        el.setAttribute('type', 'hidden');
        el.setAttribute('name', 'integridade_defeito_constatado_' + iteration);
        el.setAttribute('id', 'integridade_defeito_constatado_' + iteration);
        el.setAttribute('value',document.getElementById('defeito_constatado_codigo').value);
        celula.appendChild(el);
        var tbody =tbl.getElementsByTagName("tbody")[0];
        tbody.appendChild(el);

        var el = document.createElement('img');
        el.setAttribute('src','imagens/ico_excluir.gif');
        el.setAttribute('width','13');
        el.onclick=function(){
            var codigo_aux = defeito_constatado_codigo;
            removerIntegridade(this,'nao');
            var arrayAux = Array();

            jsonDefeitosAux = $("#defeito_constatado_hidden").val();
            jsonDefeitosAux = JSON.parse(jsonDefeitosAux);

            jsonDefeitosAux.forEach(function(elem){
                if(elem != codigo_aux){
                    arrayAux.push(elem);
                }
            });

            $('#integridade_defeito_constatado_' + iteration).remove();

            $("#defeito_constatado_hidden").val(JSON.stringify(arrayAux));
        };

    var tr = document.createElement('tr');
    var td1 = document.createElement('td');
    td1.innerHTML = defeito_descricao;

    var td2 = document.createElement('td');
    td2.appendChild(el);

    tr.appendChild(td1);
    tr.appendChild(td2);

    $("#tbl_integridade > tbody").append(tr);

    if($("#defeito_constatado_hidden").val() != ""){
        jsonDefeitos = $("#defeito_constatado_hidden").val();
        jsonDefeitos = JSON.parse(jsonDefeitos);
    }else{
        jsonDefeitos = new Array();
    }

    jsonDefeitos.push(defeito_constatado_codigo);

    $("#defeito_constatado_hidden").val(JSON.stringify(jsonDefeitos));

    <?php
    if ($login_fabrica == 131) { ?>
        atualizaCausas();

    <?php
    }?>
}

//hd_chamado=2881143
function adicionaIntegridade2(indice,tabela,defeito_reclamado,defeito_reclamado_desc,defeito_constatado,familia_produto) {

    var parar = 0;
    var tem_defeito = ''; //hd_chamado=2881143
    $("input[rel='defeito_constatado_"+indice+"']").each(function (){
        tem_defeito = 'true';
        if ($(this).val() == defeito_constatado.value){
            parar++;
        }
    });

    var codigoDefeito = defeito_constatado.options[defeito_constatado.selectedIndex].text.split('-');
    codigoDefeito = codigoDefeito[0];

    if(codigoDefeito == '554' && tem_defeito != ""){ //hd_chamado=2881143
        alert('Para selecionar o defeito PRODUTO SEM DEFEITO você deve excluir os defeitos já lançados');
        return false;
    }

    var excluirDefeito = false;
    $("input[name^=i_defeito_constatado]").closest("td").each(function(){

        var splitTextDefeito = $(this).text().split("-");

        if ($.trim(splitTextDefeito[0]) == '554' || $.trim($(this).text()) == 'PRODUTO SEM DEFEITO') {
            excluirDefeito = true;
        }

    });

    if (excluirDefeito) {
        alert('Exclua o defeito constatado "PRODUTO SEM DEFEITO" para adicionar um novo');
        return false;
    }

    if (parar>0){
        alert('<?=$tema?> '+defeito_constatado.options[defeito_constatado.selectedIndex].text+' já inserido')
        return false;
    }
    var tbl       = document.getElementById(tabela);
    var lastRow   = tbl.rows.length;
    var iteration = lastRow;
    if (iteration>0){
        document.getElementById(tabela).style.display = "inline";
    }
    //Cria Linha
    var linha = document.createElement('tr');
    linha.style.cssText = 'color: #000000; text-align: left; font-size:10px';
    var id_defeito = defeito_constatado.value; //hd_chamado=2881143
    // Cria Coluna/
    var celula = document.createElement('td');
    var celula = criaCelula(defeito_constatado.options[defeito_constatado.selectedIndex].text);
    celula.style.cssText = 'text-align: left; color: #000000;font-size:10px;border-bottom: thin dotted #FF0000';
    var el = document.createElement('input');
    el.setAttribute('type', 'hidden');
    
    <?php if ($login_fabrica == 19) {?>
        el.setAttribute('name', 'i_defeito_constatado['+$("#defeito_reclamado_"+indice).val()+'][]');
        el.setAttribute('rel', 'defeito_constatado_' +indice);
        el.setAttribute('id', 'i_defeito_constatado_' +indice+'_'+ iteration);

    <?php } else {?>
        el.setAttribute('name', 'i_defeito_constatado_' +indice+'_'+ iteration);
        el.setAttribute('rel', 'defeito_constatado_' +indice);
        el.setAttribute('id', 'i_defeito_constatado_' +indice+'_'+ iteration);
    <?php }?>

    el.setAttribute('value',defeito_constatado.value);
    celula.appendChild(el);
    linha.appendChild(celula);

    var celula = document.createElement('td');
    celula.style.cssText = 'text-align: right; color: #000000;font-size:10px';
    var el = document.createElement('input');
    el.setAttribute('type', 'button');
    el.setAttribute('value','Excluir');
    el.onclick=function(){
        removerIntegridade2(this,tabela,id_defeito,codigoDefeito); //hd_chamado=2881143 adicionado id_defeito
    };

    celula.appendChild(el);
    linha.appendChild(celula);

    // finaliza linha da tabela
    var tbody = document.createElement('TBODY');
    tbody.appendChild(linha);
    tbl.appendChild(tbody);

        if($("#defeitos_lorenzetti_hidden").val() != ""){
            jsonDefeitos = $("#defeitos_lorenzetti_hidden").val();
            jsonDefeitos = JSON.parse(jsonDefeitos);
        }else{
            jsonDefeitos = new Array();
        }
        jsonDefeitos.push(id_defeito);

        $("#defeitos_lorenzetti_hidden").val(JSON.stringify(jsonDefeitos));
    //  fim hd_chamado=2881143 //

}

function adicionaIntegridade5(){

    if($("#defeito_constatado").val() == ""){
        alert ("Selecione o <?=$tema?>");
        return false;
    }
    var valor   = $("#defeito_constatado").val();
    var texto   = $("#defeito_constatado option:selected").text();
    var linhas  = $("#tbl_integridade tbody tr").length;
    if(linhas > 0){
        $("#tbl_integridade").css("display","inline");
    }
    var add_linha = '';
    add_linha += '<tr id="defeito_constatado_'+valor+'">';
    add_linha += '<td>';
    add_linha += '<input type="hidden" name="integridade_defeito_constatado_'+linhas+'" value="'+valor+'" />';
    add_linha += '<input type="hidden" name="integridade_defeito_descricao_'+linhas+'" value="'+texto+'" />';
    add_linha += '<input type="hidden" name="qtde_integridade" value="'+linhas+'" />';
    add_linha += valor +' - '+ texto;
    add_linha += '</td>';
    add_linha += '<td><input type="button" value="Excluir" onclick="javascript:removerIntegridade(this,\'nao\');" /></td>';
    add_linha += '</tr>';

    $("#tbl_integridade tbody").append(add_linha);
    $("tr [id=defeito_constatado_"+valor+"]").css("color","#000");
    $("tr [id=defeito_constatado_"+valor+"]").css("text-align","left");
    $("tr [id=defeito_constatado_"+valor+"]").css("font-size","10px");
}

    function removerIntegridade(iidd,id_defeito_constatado_reclamado) {

        <? if ($login_fabrica == 43 or $login_fabrica == 85 ) {?>
            if (id_defeito_constatado_reclamado != 'nao') {
                var url = 'excluir_defeito_ajax.php?id='+id_defeito_constatado_reclamado;
                requisicaoHTTP('GET',url,true,'retorno');
                var tbl = document.getElementById('tbl_integridade');
                tbl.deleteRow(iidd.parentNode.parentNode.rowIndex);
            } else {
                var tbl = document.getElementById('tbl_integridade');
                tbl.deleteRow(iidd.parentNode.parentNode.rowIndex);
            }
        <?} else { ?>
            var tbl = document.getElementById('tbl_integridade');

            tbl.deleteRow(iidd.parentNode.parentNode.rowIndex);
            var defeitos_constatados = "";
            defeitos_constatados = JSON.parse($("#defeito_constatado_hidden").val());

            len = defeitos_constatados.length;
            defeitos_constatados_aux = new Array();
            for(i=0;i<len;i++){

                def = defeitos_constatados.pop();
                if(def != id_defeito_constatado_reclamado){
                    defeitos_constatados_aux.push(def);
                }
            }

            $("#defeito_constatado_hidden").val(JSON.stringify(defeitos_constatados_aux));

        <?}?>
    }

    function retorno(campos) {

    }


    function removeChecklistDefeitos(os,check_list_fabrica) {
         $.ajax({
            async: true,
            type: "GET",
            url: "<?=$php_self?>",
            data: {ajax_exclui_checklist_os : true, os:os, check_list_fabrica:check_list_fabrica},
            complete: function(data) {
                
            }
        });
    }
    function removerIntegridade2(iidd,tabela,id_defeito_constatado_reclamado,codigo_defeito){ //hd_chamado=2881143
        if (confirm('Deseja excluir o Defeito? Excluindo as peças lançandas referente ao defeito serão apagadas.')) {
            var tbl = document.getElementById(tabela);
            tbl.deleteRow(iidd.parentNode.parentNode.rowIndex);

            var os = <?php echo $_GET['os']; ?>
            // hd_chamado=2881143 //
                var defeitos_constatados = "";
                defeitos_constatados = JSON.parse($("#defeitos_lorenzetti_hidden").val())
                len = defeitos_constatados.length;
                defeitos_constatados_aux = new Array();
                for(i=0;i<len;i++){
                    def = defeitos_constatados.pop();
                    if(def != id_defeito_constatado_reclamado){
                        defeitos_constatados_aux.push(def);
                    }
                }

                //if(codigo_defeito == '554'){ //hd_chamado=2881143

                //}

                $("#defeitos_lorenzetti_hidden").val(JSON.stringify(defeitos_constatados_aux));
                if(id_defeito_constatado_reclamado.length > 2){
                    jsonDef = new Array();
                    $("input[name^=peca_]").each(function(){
                        var defs = $(this).val();
                        if(defs != ""){
                            jsonDef.push(defs);
                        }
                    });

                    $.ajax({
                        async: true,
                        type: "GET",
                        url: "<?=$php_self?>",
                        data: 'defeito_constatado_pecas='+defeitos_constatados_aux+'&pecas_lancadas='+jsonDef+'&id_defeito_constatado_reclamado='+id_defeito_constatado_reclamado+'&os='+os,
                        complete: function(data) {
                            console.log(data.responseText);
                            data = JSON.parse(data.responseText);
                            $.each( data, function( key, value ) {
                                $("input[name^=peca_]").each(function(){
                                    if($(this).val() == value){
                                        $(this).parent('td').parent().find("input[name^=peca_],[name^=descricao_],[name^=qtde_],[name^=defeito_],[name^=servico_]").val('');
                                    }
                                });
                            });
                        }
                    });
                }else{
                    $("#tablemostrar").find("input[name^=peca_],[name^=descricao_],[name^=qtde_],[name^=defeito_],[name^=servico_]").val('');
                }
            // FIM - hd_chamado=2881143 //
        }
    }

    function criaCelula(texto) {
        var celula = document.createElement('td');
        var textoNode = document.createTextNode(texto);
        celula.appendChild(textoNode);
        return celula;
    }

    function abreComunicado(){
        var ref = document.frm_os.produto_referencia.value;
        if (document.frm_os.produto_referencia.value!=""){
            url = "pesquisa_comunicado.php?produto=" + ref;
            window.open(url,"comm","status=yes,scrollbars=yes,directories=no,width=650,height=400,top=18,left=0");
        }
    }

    function verificaServico(servico,peca){
        var data = new Date();
        if (servico.value == '673' && peca.value.length > 0){
            $.ajax({
                type: "GET",
                url: "<?=$php_self?>",
                data: 'peca_referencia='+peca.value+'&peca_troca=sim&data='+data.getTime(),
                complete: function(http) {
                    results = http.responseText;
                    if (results =='sim'){
                        if(!confirm('Caso seja necessário esta peça para consertar o produto, o produto será trocado e a mão de obra, será de R$ 2,00. Caso consiga consertar o produto sem necessidade de troca desta peça, anote o serviço como ajuste, ou limpeza, ou ressoldagem, e a mão-de-obra será paga integral.')){
                            servico.value="";
                        }
                    }
                }
            });
        }
    }

function fnc_pesquisa_peca_lista_latina (produto_referencia, peca_referencia, peca_descricao, peca_preco, voltagem, tipo, serie,kit_peca,defeito_constatado,i) {

    var fabrica = "<?=$login_fabrica?>";

    var url = "";

    if (tipo == "tudo") {
        url = "peca_pesquisa_lista.php?<?if (strlen($_GET['os'])>0) echo 'os='.$_GET['os'].'&';?>produto=" + produto_referencia + "&descricao=" + peca_referencia.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&serie="+serie.value+"&verifica_serie=sim"+"&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&input_posicao="+i;
    }

    if (tipo == "referencia") {
         url = "peca_pesquisa_lista.php?<?if (strlen($_GET['os'])>0) echo 'os='.$_GET['os'].'&';?>produto=" + produto_referencia + "&peca=" + peca_referencia.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&serie="+serie.value+"&kit_peca="+kit_peca.value+"&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&input_posicao="+i;
    }

    if (tipo == "descricao") {
       url = "peca_pesquisa_lista.php?<?if (strlen($_GET['os'])>0) echo 'os='.$_GET['os'].'&';?>produto=" + produto_referencia + "&descricao=" + peca_descricao.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&serie="+serie.value+"&kit_peca="+kit_peca.value+"&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&input_posicao="+i;
    }

    if (fabrica == 15) {
        url += "&defeito_constatado="+defeito_constatado.value;
    }

    if (peca_referencia.value.length >= 3 || peca_descricao.value.length >= 3) {

        janela = window.open(url, "janela", "  status=yes, scrollbars=yes, directories=no, width=501, height=400, top=18, left=0");

        produto    = produto_referencia;
        referencia = peca_referencia;
        descricao  = peca_descricao;
        preco      = peca_preco;
        kit_peca   = kit_peca;
        janela.focus();

    } else {

        alert("<? if($sistema_lingua == "ES"){
                    echo "Digite al minus 3 caracters";
                }else{
                    echo "Digite pelo menos 3 caracteres!";
                } ?>");

    }

}

function fnc_pesquisa_serie_atlas (serie, produto_os,os) {
    if (serie.value != "") {
        var url = "";
        url = "produto_pesquisa_new_atlas.php?serie=" + serie.value+"&produto_os="+produto_os.value+"&os="+os+ "&form=frm_os";
        janela = window.open(url, "janela", " location=no, status=yes, scrollbars=yes, directories=no, width=600, height=400, top=18, left=0");
        janela.serie       = serie;
        janela.produto_os  = produto_os;
        janela.focus();
    }else{
        alert( 'Favor inserir toda ou parte da informação para realizar a pesquisa' );
        return false;

    }
}

function verifica_atendimento() {

    if (document.getElementById('div_mapa')){
        var ref = $('#tipo_atendimento').val();
        $.get('<?=$PHP_SELF?>',
              {'ajax': 'tipo_atendimento',
               'id'  : ref},
              function(responseText) {
                    var response = responseText.split("|");
                    if ($.trim(response[0]).indexOf('ok') > -1){
                        document.getElementById('div_mapa').style.visibility = "visible";
                        document.getElementById('div_mapa').style.position = 'static';
                        document.getElementById('div_mapa_msg').style.visibility = "visible";
                    }else{
                        document.getElementById('div_mapa').style.visibility = "hidden";
                        document.getElementById('div_mapa').style.position = 'absolute';
                        document.getElementById('div_mapa_msg').style.visibility = "hidden";
                    }
              });
    }
}

</script>

<script language='javascript'><?php
if ($login_fabrica == 52) {?>
    $(document).ready(function() {
        listaSolucaoGrupo(document.frm_os.defeito_constatado_grupo.value,document.frm_os.xxproduto_familia.value);
    });<?php
}?>

function valida_orcamento_bosch_security(){
    var tipo_atendimento    = $("#tipo_atendimento").val();
    var status_checkpoint   = parseInt($("#status_checkpoint").val());
    var total_orcamento = parseFloat($("input[name='total_orcamento']").val());

    //93 - Orçamento

    if (tipo_atendimento == 93 && total_orcamento > 0 && status_checkpoint != 7) {

        var pergunta = confirm("OS FORA DE GARANTIA\n\nSerá enviado o orçameno para o cliente, caso o orçamento esteja correto, favor clique em ok, caso esteja errado, clique em cancelar para corrigir !");

        if (pergunta) {

            if (document.frm_os.btn_acao.value == '') {
                document.frm_os.btn_acao.value = 'gravar' ;
                //document.frm_os.submit()
            } else {
                //alert ('Aguarde submissão')
            }

        } else {
            return false;
        }

    } else {

        if (document.frm_os.btn_acao.value == '') {
            document.frm_os.btn_acao.value='gravar' ;
            //document.frm_os.submit()
        } else {
            //alert ('Aguarde submissão')
        }

    }

}

function mostraOrcamento(servico,linha) {

    var servico = servico;
    var linha   = linha;

    var preco           = document.getElementById('preco_'+linha).value;
    var preco_orcamento = document.getElementById('preco_orcamento_'+linha);
    var div_preco       = document.getElementById("orcamento_mostra_"+linha);
    var div_mo          = document.getElementById('orcamento_mao_obra')

    if (servico == 4247 || servico == 4289) {
        div_preco.style.display = 'block';
        div_mo.style.display    = 'block';
        preco_orcamento.value   = preco;
    } else {
        div_preco.style.display = 'none';
    }

}

function validaSerieEsmaltec(serie, produto, fabrica) {

    var serie   = serie;
    var produto = produto;
    var fabrica = fabrica;
    var url     = 'ajax_pesquisa_serie_esmaltec.php?serie='+serie+'&produto='+produto+'&fabrica='+fabrica;

    if(serie == "00000000000000"){
    alert("Número de série informado irá bloquear o lançamento de peças. É necessário que seja anexado cópia da nota fiscal e foto do produto que comprova falta da etiqueta");
    $("#tablemostrar").hide();
	$("#tablemostrar :input").val("");

    <?php if($login_fabrica == 30){?>
        $("#adicionar_anexo").show();
    <?php } ?>
    return false;
    }

    if (serie.length == 0) {
        return false;
    } else {
        requisicaoHTTP('GET',url,true,'tratadados');
    }
}

function tratadados(campos){
    var arraycampos = campos.split('|');
    if (arraycampos[0]=='ok') {
        return false;
    }
    if(arraycampos[1] != '00000000000000'){
        if (arraycampos[0] == 'erro 1') {
            /*alert ('Número de Série '+arraycampos[1]+' incorreto para o produto informado ');
            $('#produto_serie').val ('');
            $('#produto_serie').focus();*/
        }

        if (arraycampos[0]=='erro 2') {

            if (confirm('Número de Série '+arraycampos[1]+' Fora do Padrão, Deseja colocar a OS para auditoria do inspetor?')==true) {
                return true;
            } else {
                $('#produto_serie').val ('');
                $('#produto_serie').focus();
            }

        }
    }

}

function info(obj,conteudo) {

    var divPop = document.getElementById("pop");
    divPop.style.display = "";
    //divPop.childNodes[0].firstChild.nodeValue = conteudo;
    $("#pop").html(conteudo);
    //obj.appendChild(divPop);
    $("#pop").appendTo(obj);

}

function fechar(){
    $("#pop").hide();
}<?php

#if ($login_fabrica == 30) {?>

    function mudaFocus(linha){
        $("#peca_"+linha).focus();
    }<?php

#}?>

function mostraEstoque(linha){

    peca = $("#peca_"+linha).val();

    if ( $('#tr_estoque_' + linha).css("display")=="none" ){

        $('#tr_estoque_' + linha).slideDown("slow");
        $('#tr_estoque_' + linha).css("display","block");
        $('#ver_estoque_'+linha).html("Esconder <br>&nbsp;&nbsp; Estoque");
        $("#img_arrow_"+linha).attr("src","imagens/barrow_up.png");

        retornaEstoque(peca,linha);

    } else {

        $('#tr_estoque_' + linha).slideUp("slow");
        $("#img_arrow_"+linha).attr("src","imagens/barrow_down.png");

        $('#ver_estoque_'+linha).html("Ver <br>&nbsp;&nbsp; Estoque");

    }

}

function retornaEstoque(peca,linha){

    var curDateTime = new Date();
    $.ajax({
        type: "GET",
        url: "consulta_estoque_ajax.php",
        data: 'peca='+ peca ,
        beforeSend: function(){
            $('#tr_estoque_'+linha).html("&nbsp;&nbsp;Carregando...&nbsp;&nbsp;<br><img src='js/loadingAnimation.gif'> ");
        },
        error: function (){
            $('#tr_estoque_'+linha).html("erro");
        },
        complete: function(http) {
            results = http.responseText;
            $('#tr_estoque_'+linha).html(results);
        }
    });

}

function fnc_pesquisa_peca_lista_masterfrio(produto_referencia, peca_referencia, peca_descricao, peca_preco, voltagem, defeito_constatado, tipo, peca_qtde) {
    var url = "";

    if (tipo == "tudo") {
        url = "<? echo $url;?>.php?<?if (strlen($_GET['os'])>0) echo 'os='.$_GET['os'].'&';?>produto=" + produto_referencia + "&descricao=" + peca_referencia.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&faturado=sim&defeito_constatado="+defeito_constatado.value;
    }

    if (tipo == "referencia") {
        url = "<? echo $url;?>.php?<?if (strlen($_GET['os'])>0) echo 'os='.$_GET['os'].'&';?>produto=" + produto_referencia + "&peca=" + peca_referencia.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&faturado=sim&defeito_constatado="+defeito_constatado.value;
    }

    if (tipo == "descricao") {
        url = "<? echo $url;?>.php?<?if (strlen($_GET['os'])>0) echo 'os='.$_GET['os'].'&';?>produto=" + produto_referencia + "&descricao=" + peca_descricao.value + "&tipo=" + tipo + "&voltagem=" + voltagem.value + "&exibe=<? echo $_SERVER['REQUEST_URI']; ?>&faturado=sim&defeito_constatado="+defeito_constatado.value;
    }<?php

    if ($login_fabrica <> 2) {?>
        if (peca_referencia.value.length >= 3 || peca_descricao.value.length >= 3) {<?php
    }?>

        janela = window.open(url, "janela", "  status=yes, scrollbars=yes, directories=no, width=501, height=400, top=18, left=0");
        produto      = produto_referencia;
        referencia   = peca_referencia;
        descricao    = peca_descricao;
        preco        = peca_preco;
        qtde         = peca_qtde;
        janela.focus(); <?php
if ($login_fabrica <> 2) {?>
    } else {//ELSE JS
        if (!document.getElementById('controle_blur')) {//HD 254266
            alert("<?=($sistema_lingua == 'ES') ? 'Digite al minus 3 caracters' : 'Digite pelo menos 3 caracteres!' ?>");
        } else {
            if (document.getElementById('controle_blur').value == 1) {
                alert("<?=($sistema_lingua == 'ES') ? 'Digite al minus 3 caracters' : 'Digite pelo menos 3 caracteres!' ?>");
            }
        }
    }<?php
}?>
}

function alteraValorAdicional(campo){
    $(campo).parent("td").parent("tr").find("input[name^=custo_adicional]:checked").val(campo.value);
    $("input[name^=custo_adicional]").change();
}

$(function(){
    formataValorAdicional();
    $("input[name^=custo_adicional]").change(function(){
        if( $(this).is(":checked") ){
            $(this).parent("td").parent("tr").find("input[rel=valor_adicional]").show();
        }else{
            $(this).parent("td").parent("tr").find("input[rel=valor_adicional]").hide();
        }
    });

});
function formataValorAdicional(){

   $("input[name^=custo_adicional],input[name^=valor_adicional]").each(function(){
        var json = {};
        var array = new Array();
        var grupo1 = {};
        var grupo2 = {};

        $("input[name^=custo_adicional]").each(function(){
            if( $(this).is(":checked") ){
                var rel = $(this).attr("rel").toString();
                grupo1[rel] = $(this).val();
                $(this).parent("td").parent("tr").find("input[rel=valor_adicional]").show();
            }else{
                $(this).parent("td").parent("tr").find("input[rel=valor_adicional]").hide();
            }
        });

        array.push(grupo1);

        $("input[name^=custo_adicional_outros]").each(function(){
            if( $.trim($(this).val()).length > 0 ){
                var rel = $(this).val().toString();
                grupo2[rel] = $(this).parent("td").parent("tr").find("input[name^=valor_adicional_outros]").val();
            }
        });
        array.push(grupo2);

        json = array;

        $("input[name=valor_adicional_formatado]").val(JSON.stringify(json));
   });
}

function adiciona_linha_valor_adicional() {
    var qtde_linha = $("#table_outros_servicos > tbody > tr").length;
    $("#table_outros_servicos > tbody").append("<tr id='mostrar_adicional_"+(parseInt(qtde_linha)+1)+"'>" + $("tr[id=mostrar_adicional_"+(qtde_linha)+"]").clone().html().replace(/_\d\d?/g,'_'+(parseInt(qtde_linha)+1)) + "</tr>");
    $("input[name=custo_adicional_outros_"+(parseInt(qtde_linha)+1)+"]").val("");
    $("input[name=valor_adicional_outros_"+(parseInt(qtde_linha)+1)+"]").val("");
    $(".novo_valor_adicional").maskMoney({showSymbol:"", symbol:"", decimal:",", precision:2, thousands:".",maxlength:10});
}

function verificaDefeitoConstatado(){
    var defeito = $("#defeito_constatado").val();

    if (defeito == 20934) {
        $('#perguntas').show();
    } else {
        $('#perguntas').hide();
    }

    $.ajax({
        url:"os_item_new.php?ajax_nao_lanca_peca=sim&defeito="+defeito,
        cache:false,
        complete: function(retorno){
            if(retorno.responseText == "f"){
                $("input[id^=peca_]").attr("readonly",true);
                $("input[id^=descricao_]").attr("readonly",true);
                $("img.lanca_peca").hide();
            }else{
                $("input[id^=peca_]").attr("readonly",false);
                $("input[id^=descricao_]").attr("readonly",false);
                $("img.lanca_peca").show();
            }
        }
    });

}

<?php

if (in_array($login_fabrica, array(30,50))) {
?>
    function excluiVisita(os_visita){
        var os = <?=$os?>;
        if(confirm("Tem certeza que deseja excluir a data de agendamento?")){
            $.ajax({
                url:"<?=$PHP_SELF?>",
                type:"POST",
                dataType:"JSON",
                data:{
                    ajax: "agenda_visita",
                    tipo: "apagar",
                    os : os,
                    os_visita: os_visita,
                }
            })
            .done(function(data){
                $("#"+os_visita).remove();
                var qtde_agenda_nova = $("#qtde_agenda").val() - 1;
                $("#qtde_agenda").val(qtde_agenda_nova);
            })
            .fail(function(){
                alert("Não foi possível excluir a data de agendamento");
            });
        }
    }

    $(function(){
        $("#btn_agenda").click(function(){
            var os = <?=$os?>;
            var data_agenda = $("#visita_agendada").val();
            var qtde_agenda = $("#qtde_agenda").val();

            if(qtde_agenda == ""){
                qtde_agenda = 0;
            }

            var numero_visita = parseInt(qtde_agenda ) + 1;
            var justificativa = $('#justificativa_visita').val();

            if(data_agenda != ""){
                <?php if ($login_fabrica == 30) { ?>
                    $.ajax({
                        url: window.location.href,
                        type: 'POST',
                        data:{
                            ajax:"agenda_visita",
                            tipo:"verificar",
                            os:os,
                            data_agenda:data_agenda,
                            justificativa: justificativa
                        },
                        timeout: 8000
                    }).fail(function(){
                        alert('Ocorreu um erro ao tentar agendar uma nova visita');
                    }).done(function(data){
                        data = JSON.parse(data);
                        if (data.ok !== undefined) {
                            grava_agendamento(os, data_agenda, justificativa, numero_visita);
                        }else{
                            alert(data.error);
                        }
                    });
                <?php }else{ ?>
                    grava_agendamento(os, data_agenda, justificativa, numero_visita);
                <?php } ?>
            }else{
                alert("Favor, digitar uma data de atendimento");
            }
        });
    });
    function grava_agendamento(os, data_agenda, justificativa, numero_visita){
        $.ajax({
            url:"<?=$PHP_SELF?>",
            type:"POST",
            dataType:"JSON",
            data:{
                ajax:"agenda_visita",
                tipo:"gravar",
                os:os,
                data_agenda:data_agenda,
                justificativa: justificativa
            }
        })
        .done(function(data){
            $("#div_agenda > table > tbody").append("<tr id='"+data[1]+"'>"
            +"<td>"+numero_visita+"</td>"
            +"<td>"+data_agenda+"</td>"
            +"</tr>");

            $("#visita_agendada").val("");
            $('#justificativa_visita').val("")
            $("#qtde_agenda").val(numero_visita);
        })
        .fail(function(){
            alert("Não foi possível gravar a data de agendamento");
        });
    }
<?
}
?>

    $(function(){
        <?php if (in_array($login_fabrica, array(30,50))) {?>
        $('#visita_agendada').datepick({startDate:'<?php echo $data_abertura;?>', minDate: '<?php echo $data_abertura;?>'});
        <?php }?>

        <?php if ($login_fabrica == 72) {//fputti hd-3130038?>
            $("body #defeito_constatado").on('change', function(){
                var defeito = $(this).val();
                $.ajax({
                    url: '<?php echo $_SERVER[PHP_SELF]; ?>',
                    type: 'POST',
                    data: {
                        ajax_carrega_falha_potencial : true,
                        defeito: defeito
                    },
                    complete: function(data){
                        $(".combo_falha").show();
                        $('#falha_em_potencial').html(data.responseText);
                    }
                });
            });
            $("#solucao_os").change(function(){
                var solucoesPermitidas =  new Array(3042, 3043, 3044, 3045, 3046);
                var solucao = $(this).val();
                if (in_array(solucao,solucoesPermitidas)) {
                    $('#ajuste_realizado').show();
                } else {
                    $('#ajuste_realizado').hide();
                }
            });
            function in_array(search, array) {
                for (i = 0; i < array.length; i++) {
                    if (array[i] == search ) {
                        return true;
                    }
                }
                return false;
            }
        <?php }?>
    });
</script>

<style type="text/css">
        .btn-delete{
            color: #fff;
            background-color: #d9534f;
            border-color: #d43f3a;
            cursor: pointer;
        }
        .btn-delete:hover{
            color: #fff;
            background-color: #d43f3a;
            border-color: #d9534f;
            cursor: pointer;
        }
        #checklist{
            border-color: #fff;
        }
        .txt_checklist{
            background: #5c93e4 !important;
            text-align: left !important;
            font-size: 18px;
            text-transform: uppercase;
            font-weight: bold;
            padding: 10px 0px;
        }

        .t_checklist{
            background-color: #ffffff;
            
            padding: 10px 0px;
        }

        .img_tumb_britania_display:hover{
            -webkit-transform: scale(2.3);
            -ms-transform: scale(2.3);
            transform: scale(2.3);
        }
        .mobile:hover {
          background: #5b5c8d;
        }
        .mobile:active{
          background: #373865;
        }
        .mobile{
          display: inline-flex;
          height: 45px;
          width: 190px;
          background: #373865;
          padding: 5px;
          border-radius: 10px;
          cursor: pointer;
        }
        .google_play{
          margin-left: 10%;
          display: inline-flex;
          height: 45px;
          padding: 5px;
          cursor: pointer;

        }
        .google_play > a >span{
          color: #373865;
        }
        .google_play:hover{
          background: #f3f3f3;
        }
        .mobile > span{
          font-size: 14px;
          float: right;
          margin-top: 14px;
          margin-right: 14px;
          color: #fac814;
        }

        .btn-danger{
            width: 58px;
            height: 25px;
            color: #ffffff;
            text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
            background-color: #da4f49;
            background-image: -moz-linear-gradient(top, #ee5f5b, #bd362f);
            background-image: -o-linear-gradient(top, #ee5f5b, #bd362f);
            background-image: linear-gradient(to bottom, #ee5f5b, #bd362f);
            background-repeat: repeat-x;
            border-color: #bd362f #bd362f #802420;
        }
        .env-code{
          width: 100%;
          border: solid 3px;
          border-color: #373866;
          width: 205px;
          border-radius: 7px;
          margin-top: 10px;
          margin: 0 auto;
        }

        .env-img {
         /*   float: left;*/
            max-width: 150px;
            margin-left: 10px;
            margin-top: 10px;
            display: inline-block;
        }

    #GoogleMapsContainer{
        z-index: 888;
        position: absolute;
        width: 700px;
        height: 400px;
        border: 2px solid #000;
        font-size: 12px;
        margin-left: 80px;
        top: 300px;
    }
    #DirectionPanel{
        width: 250px;
        height: 400px;
        float: right;
        background-color: #fff;
        overflow: auto;
        font: 10px arial;
    }
    #GoogleMaps_antigo{
        width: 450px;
        height: 400px;
        float: left;
        background-color: #fff;
    }

    #GoogleMaps{
        width: 700px;
        height: 400px;
        float: left;
        margin-top: -33px;
        background-color: #fff;
    }

    #fechamapa:hover{
        cursor: pointer;
    }
    .adp-text{
        font: 12px arial;
    }
    .adp-substep{
        font: 12px arial;
    }

     #tab td{
         cursor:help;
     }

     #pop{
         position:absolute;
         background-color:#FF4040;
         font: bold 12px Arial;
         color: #FFFFFF;
     }

    a.lnk:link{
        font-size: 10px;
        font-weight: bold;
        text-decoration: underline;
        color:#FFFF33;
    }
    a.lnk:visited{
        font-size: 10px;
        font-weight: bold;
        text-decoration: underline;
        color:#FFFF33;
    }
    p.c1{
        color:white;
        font:bold 80% Arial,Helvetica,sans-serif;
    }
    a#lnx:link{
        font-weight: bold;
        text-decoration:none;
        color:white;

    }
    a#lnx:hover{
        font-weight: bold;
        text-decoration:underline;
        color:#FFFFAA;
    }
    a#lnx:visited{
        font-weight: bold;
        text-decoration:none;
        color:#FFFFAA;
    }

    .menu_top {
        text-align: center;
        font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
        font-size: 9px;
        font-weight: bold;
        border: 1px solid;
        color:#596d9b;
        background-color: #d9e2ef
    }
    .btn_altera{
        font:bold 11px tahoma,verdana,helvetica;
        padding-left:3px;
        padding-right:3px;
        cursor:pointer;
        overflow:visible;
        outline:0 none;
        background-position: center;
        background-repeat: no-repeat;
    }

    .texto_avulso{
        font: 14px Arial;
        color: rgb(89, 109, 155);
        background-color: #d9e2ef;
        text-align: justify;
        width:700px;
        margin: 0 auto;
        border-collapse: collapse;
        border:1px solid #596d9b;
    }

    .titulo_tabela{
        background-color:#596d9b;
        font: bold 14px "Arial";
        color:#FFFFFF;
        text-align:center;
    }

    .titulo_tabela_2{
        background-color:#eeeeee;
        font: bold 14px "Arial";
        color:#222222;
        text-align:center;
    }

    .formulario{
        background-color:#D9E2EF;
        font:11px Arial;
        text-align:left;
    }

    .msg_erro{
        background-color:#FF0000;
        font: bold 16px "Arial";
        color:#FFFFFF;
        text-align:center;
    }

    .espaco{
        padding: 0 0 0 140px
    }

    .titulo_coluna{
        background-color:#596d9b;
        font: bold 11px "Arial";
        color:#FFFFFF;
        text-align:center;
    }

    table.tabela tr td{
        font-family: verdana;
        font-size: 11px;
        border-collapse: collapse;
        border:1px solid #ACACAC;
        empty-cells:show;
    }

    table#anexos{
        width: 700px !important;
    }

    div#div_agenda{
        overflow:auto;
        width:220px;
        height:100px;
    }

    span.excluir_visita{
        cursor:pointer;
        font-weight:bold;
    }

</style>
<?php
#HD 311411 - Tectoy

if ($login_fabrica == 6) {

    $sqlConserto = "SELECT data_conserto FROM tbl_os WHERE os = $os";
    $resConserto = pg_query($con,$sqlConserto);
    $numConserto = pg_num_rows($resConserto);

    if ($numConserto) {

        $data_conserto = pg_fetch_result($resConserto, 0, 'data_conserto');

        if (strlen($data_conserto) > 0) {?>
            <table border="0" width="700" align="center" class="tabela">
                <tr class="msg_erro">
                    <td>OS com data de conserto informada, para alterações, entrar em contato com o fabricante</td>
                </tr>
            </table><?php
            include_once 'rodape.php';
            exit;
        }

    }

}

#HD 311411 - Fim

$os_item = trim($_GET['os_item']);

$lanca_peca = ($login_fabrica == 6) ? "lanca_peca" : "";

if ($os_item > 0) {
    echo "<FONT COLOR=\"#FF0033\"><B>$msg_erro_item</B></FONT>";
    $msg_erro_item = 0;
}

if (strlen($msg_erro) > 0) {

    ##### Recarrega Form em caso de erro #####
    $os                       = $_POST["os"];
    $defeito_reclamado        = $_POST["defeito_reclamado"];
    $causa_defeito            = $_POST["causa_defeito"];
    $obs                      = $_POST["obs"];
    $aparencia_produto        = $_POST["aparencia_produto"];
    $acessorios               = $_POST["acessorios"];
    $defeito_constatado       = $_POST["defeito_constatado"];
    $solucao_os               = $_POST["solucao_os"];
    $type                     = $_POST["type"];
    $tecnico_nome             = $_POST["tecnico_nome"];
    $tecnico                  = $_POST["tecnico_nome"];
    $valores_adicionais       = $_POST["valores_adicionais"];
    $justificativa_adicionais = $_POST["justificativa_adicionais"];
    $qtde_km                  = $_POST["qtde_km"];
    $peca_serie               = $_POST["peca_serie"];
    $peca_serie_trocada       = $_POST["peca_serie_trocada"];
    $peca_reposicao_estoque   = $_POST["peca_reposicao_estoque"];
    $aguardando_peca_reparo   = $_POST["aguardando_peca_reparo"];
    $produto_serie            = $_POST["produto_serie"]; //HD 196473

    //hd 24288
    //$autorizacao_domicilio    = $_POST["autorizacao_domicilio"];
    $justificativa_autorizacao = $_POST["justificativa_autorizacao"];
    $fabricacao_produto        = $_POST["fabricacao_produto"];
    $codigo_fabricacao         = $_POST["codigo_fabricacao"];
    $defeito_constatado_grupo  = $_POST["defeito_constatado_grupo"];
    $km                        = $_POST["km"];
    $tecnico                   = $_POST["tecnico"];
    $data_fabricacao           = $_POST["data_fabricacao"];
    $data_fab = $data_fabricacao;

    if (strpos ($msg_erro,"Cannot insert a duplicate key into unique index tbl_os_sua_os") > 0) $msg_erro = "Esta ordem de serviço já foi cadastrada";

    echo "<table width='700' border='0' cellpadding='0' cellspacing='0' align='center' class='msg_erro'>";
    echo "<tr>";
    echo "<td height='27' valign='middle' align='center'>";

    //hd 162508
    if($login_fabrica == 19 and strpos($msg_erro,"ERRO_VALOR_PECA_SUPERIOR") > 0) {
        $sql = "INSERT INTO tbl_os_status (
                    os,
                    status_os,
                    observacao,
                    fabrica_status
                ) VALUES (
                    $os,
                    62,
                    'Peça ".$aux_xpeca." com valor maior ou igual a 80% do valor do produto.',
                    $login_fabrica
                )";
        $res      = pg_query($con,$sql);
    }

    //hd 159888

    // retira palavra ERROR:
    if (strpos($msg_erro,"ERROR: ") !== false) {
 //   echo $msg_erro;exit;
        #$erro = "Foi detectada a seguinte divergência: <br>";
        #$msg_erro .= substr($msg_erro, 6);
        #Tirei a concatenação porque estava duplicando a msg de erro HD 171532
        $msg_erro = substr($msg_erro, 6);
        if (strpos($msg_erro,"Existe uma ou mais peças com quantidades maiores que o permitido para o produto.")){
            $msg_erro = "Existe uma ou mais peças com quantidades maiores que o permitido para o produto.";
        }
    }
    // retira CONTEXT:
    if (strpos($msg_erro,"CONTEXT:")) {
        $x = explode('CONTEXT:',$msg_erro);
        $msg_erro = $x[0];
    }
    echo $erro . $msg_erro;

    echo "</td>";
    echo "</tr>";
    echo "</table>";
}

##### COMUNICADOS - INÍCIO #####
#-----------CHAMADO 342629 INICIO-------------
$sql =    "
SELECT * FROM (

SELECT tbl_comunicado.comunicado                                       ,
                tbl_comunicado.descricao                                        ,
                tbl_comunicado.mensagem                                         ,
                tbl_comunicado.extensao                                         ,
                tbl_comunicado.data                                               ,
                tbl_comunicado.produto                                          ,
                tbl_produto.referencia                    AS produto_referencia ,
                tbl_produto.descricao                     AS produto_descricao
        FROM tbl_comunicado
        JOIN tbl_produto ON tbl_produto.produto = tbl_comunicado.produto
        JOIN tbl_os      ON tbl_os.produto = tbl_produto.produto
        WHERE tbl_comunicado.fabrica = $login_fabrica
        AND   tbl_os.os = $os
        AND   tbl_comunicado.obrigatorio_os_produto IS TRUE
    AND   tbl_comunicado.ativo
UNION
SELECT tbl_comunicado.comunicado ,
             tbl_comunicado.descricao ,
             tbl_comunicado.mensagem ,
             tbl_comunicado.extensao ,
                tbl_comunicado.data                                               ,
             tbl_comunicado.produto ,
             tbl_produto.referencia AS produto_referencia ,
             tbl_produto.descricao AS produto_descricao
        FROM tbl_comunicado
        JOIN tbl_comunicado_produto ON tbl_comunicado.comunicado=tbl_comunicado_produto.comunicado
        JOIN tbl_produto ON tbl_produto.produto = tbl_comunicado_produto.produto
        JOIN tbl_os ON tbl_os.produto = tbl_produto.produto
        WHERE tbl_comunicado.fabrica = $login_fabrica
        AND tbl_os.os = $os
        AND tbl_comunicado.obrigatorio_os_produto IS TRUE
    AND tbl_comunicado.ativo
        ) AS dados
        ORDER BY data DESC;";
#-----------CHAMADO 342629 FIM-------------
$res_comun = pg_exec($con,$sql);

#-----------CHAMADO 342629 INICIO-------------
if (pg_numrows($res_comun) > 0){

    echo "<table border='0' width='700' align='center' style='background-color:#FFCC00;'>";
        echo"<tr align='center' valing='middle'>";
            echo"<td align='center' valign='center'>";
                    echo "<table width='650'>";
                    echo "<tr><td align='center'><img src='imagens/esclamachion1.gif'></td>";
                    echo "<td align='left' style='text-align:center;'><b>".traduz('Comunicado referente ao produto')."<br>";
                    echo pg_result($res_comun,0,produto_referencia) . " - " . pg_result($res_comun,0,produto_descricao) . "</b></td></tr>";
                    echo "</table>";

                    echo "<br>";

                    echo "<table width='650' cellspadding='0' cellpadding='0' class='tabela'>";
                        echo "<tr class='titulo_coluna' style='font-weight:bold'>";
                        echo "<td>".traduz('Data')."</td>";
                        echo "<td>".traduz('Título')."</td>";
                        echo "<td>".traduz('Arquivo')."</td>";
                        echo "</tr>";
                        for ($k = 0 ; $k < pg_numrows($res_comun) ; $k++) {
                            $cor = ($k % 2 == 0) ? "#F7F5F0" : "#F1F4FA";
                            echo "<tr class='Conteudo' style='background-color:$cor;'>";
                            #--------CHAMADO 342629-------
                            list($yi, $mi, $di) = explode("-", pg_result($res_comun,$k,data));
                            $data_comunicado = substr($di,0,2)."/".$mi."/".$yi;
							$comunicado = pg_fetch_result($res_comun,$k,'comunicado');

                            echo "<td  align='center' >".$data_comunicado."</td>";
                            #--------------------------------------
                            echo "<td><a href='comunicado_mostra.php?comunicado=" . pg_result($res_comun,$k,comunicado) . "' target='_blank'>" . pg_result($res_comun,$k,descricao) . "</a></td>";
                            echo "<td align='center'>";
                            if (strlen($com_prod = pg_result($res_comun,$k,comunicado)) > 0 && strlen(pg_result($res_comun,$k,extensao)) > 0) {
                                if ($S3_online) {
                                    $s3cp = $s3ve->temAnexos($com_prod); // Comunicado referente a produto.
                                    $linkImgCom = ($s3ve->temAnexo) ? $s3cp->url :
                                                  "comunicados/" . pg_fetch_result($res_comun,$k,comunicado) . "." . pg_fetch_result($res_comun,$k,extensao);
                                    if (!$s3ve->temAnexo and !is_file($linkImgCom))
                                        $linkImgCom = false; //False se não tem arquivo no S3 e não existe o arquivo local

									if(empty($linkImgCom)) {
										$s3ve->set_tipo_anexoS3('Vista Explodida');
										if ($s3ve->temAnexos($comunicado))
											$linkImgCom= $s3ve->url;
									}

                                } else {
                                    $linkImgCom = "comunicados/" . pg_fetch_result($res_comun,$k,comunicado) . "." . pg_fetch_result($res_comun,$k,extensao);
                                    if (!file_exists($linkImgCom))
                                        $linkImgCom = false; // False se não existe o arquivo local
                                }

                                if ($linkImgCom)
                                    echo "<a href='$linkImgCom' target='_blank'>Abrir arquivo</a>";
                            }
                            else "&nbsp;";
                            echo "</td>";
                            echo "</tr>";
                    }
                    echo "</table>";

            echo "<br>";
            echo"<td>";
        echo "<tr>";
    echo "</table>";
#-----------CHAMADO 342629 FIM-------------
    echo "<br>";
}
##### COMUNICADOS - FIM #####

    if($login_fabrica==24){
        $sql = "SELECT tbl_peca.garantia_diferenciada from tbl_lista_basica join tbl_produto using(produto) join tbl_peca using(peca) where tbl_produto.produto='$produto_os' order by tbl_peca.garantia_diferenciada asc";
        $res = pg_query($con,$sql);
        if(pg_num_rows($res)>0){
            $garantia_diferenciada = pg_fetch_result($res,0,garantia_diferenciada);
        }
        if (strlen($garantia_diferenciada) > 0){
            $sql = "SELECT (data_nf + (('$garantia_diferenciada months')::interval))::date as dt_vencimento_garantia_peca,
                            data_abertura,
                            ((data_nf + (('$garantia_diferenciada months')::interval))::date < data_abertura)as venceu
                    FROM tbl_os
                    WHERE os = $os
                    AND fabrica = $login_fabrica";
            $res = pg_query($con,$sql);
            $dt_vencimento_garantia_peca = pg_fetch_result($res,0,dt_vencimento_garantia_peca);
            $data_aber   = pg_fetch_result($res,0,data_abertura);
            $venceu  = pg_fetch_result($res,0,venceu);
            if($venceu=='t'){
                echo "<table width='600' border='0' cellpadding='3' cellspacing='5' align='center' bgcolor='#ecc3c3'>";
                echo "<tr>";
                echo "<td valign='middle' align='center'>";
                echo "<font face='Arial, Helvetica, sans-serif' color='#d03838' size='1'><B>Atenção:</B> Produto comprado a mais de $garantia_diferenciada meses, algumas peças estão fora da garantia</font>";
                echo "</td>";
                echo "</tr>";
                echo "</table>";
            }
        }
        //echo "data do vencimento da garantia de 6 meses($dt_vencimento_garantia_peca), data abertura($data_aber), venceu a garantia de 6 meses e irá aparecer a mensagem? ($venceu)";
    }

    if($login_fabrica == 19 and $tipo_atendimento == 20) {
        echo "<table width='700' align='center' class='msg_erro'><tr><td>";
        echo "Por favor, complete o Laudo Técnico";
        echo "</td></tr></table>";
    }
    if(in_array($login_fabrica, [72])) {
        $data_abertura_new = str_replace('/', '-', $data_abertura);

        if (strtotime($data_abertura_new) < strtotime(date('Y-m-d', strtotime('-30 days')))) {
    ?>
        <script type="text/javascript">
            $(document).ready(function(){
                $('input[type=text]').each(function(){
                    $(this).attr('readonly', 'true');
                });
            });
        </script>
        <?php

            echo "<table width='700' align='center' style='background-color: red; color: white;'><tr><td>";
            echo "Solicitação de peça fora do prazo estabelecido pela a fábrica. Por favor, interagir na ordem de serviço";
            echo "</td></tr></table>";            
        } 
    }
    
    /*HD - 6164934*/
    if (in_array($login_fabrica, array(6, 15, 19, 20, 24))) {
        echo "<table width='700' align='center' class='texto_avulso'>";
        echo "<tr>";
        echo "<td >";
        if($login_fabrica==19){
            echo "Caso algum tipo de defeito Constatado não esteja relacionado nas opções, favor informar o Depto de Assistência Técnica através do e - mail osglorenzetti.com.br, informando qual o número da OS, o produto e qual o defeito que não consta na lista";
        }
        if($login_fabrica==6){
            #Retirado (011) 3823-1713 a pedido - Fabio - 7499
            echo "Caso algum tipo de defeito Constatado não esteja relacionado nas opções, favor informar o Depto de Assistência Técnica através do E-mail : duvidastecnicastectoy.com.br";
        }
        if($login_fabrica==20){
            echo "<b>Caso algum tipo de defeito Constatado não esteja relacionado nas opções, favor informar o Depto de Assistência Técnica através do telefone (019) 3745-2208 ou mesmo através do E-mail : Gustavo.Guerreirobr.bosch.com";
        }
        // if($login_fabrica==3){
        //     echo "Caso algum tipo de defeito Constatado não esteja relacionado nas opções, favor informar através do E-mail : suporte.tecnicobritania.com.br, código Posto, descrição do Produto, defeito reclamado, defeito constatado que não consta na lista, e a solução";
        // }
        if($login_fabrica==15){
            echo "Caso não encontre algum tipo de informação nos campos abaixo, favor nos informar através do e-mail telecontrollatinatec.com.br</font></b>";
        }
        if($login_fabrica==24){
            echo "<b><font face='Arial, Helvetica, sans-serif' color='#465357' size='1'>Caso algum tipo de defeito Constatado não esteja relacionado nas opções, favor informar o Depto de Assistência Técnica através do telefone (031) 3280-1300 ou mesmo através do E-mail : suggar@suggar.com.br </font></b>";
        }
        echo "</td>";
        echo "</tr>";
        echo "</table><br>";
    }

    if ($login_fabrica==19) {
        //ULTIMO STATUS
        $sql_intervencao = "SELECT interv.os
                            FROM (
                                SELECT
                                    ultima.os,
                                    (SELECT status_os FROM tbl_os_status WHERE status_os IN (62,64) AND tbl_os_status.os = ultima.os ORDER BY data DESC LIMIT 1) AS ultimo_status
                                FROM (
                                    SELECT DISTINCT os FROM tbl_os_status WHERE status_os IN (62,64) AND tbl_os_status.fabrica_status=$login_fabrica
                                    and tbl_os_status.os = $os
                                ) ultima
                            ) interv
                            WHERE interv.ultimo_status IN (62)";
        $res_intervencao = pg_query($con, $sql_intervencao);

        if(pg_num_rows($res_intervencao)>0){
            //PEGA O ALERTA
            $res = pg_query($con,"SELECT fn_valida_os($os, $login_fabrica)");
            $msg_alerta = pg_last_notice($con);
            $msg_alerta = trim(substr($msg_alerta,7,strpos($msg_alerta,"CONTEXT:")-7));

            //QUANDO A TELA É CHAMADA E A OS JÁ ESTÁ EM INTERVENÇÃO POR VALOR DE PEÇA SETA A MENSAGEM, POIS A MENSAGEM DO ERRO QUANDO LANÇA A PEÇA VEM DA FUNÇÃO

            if(!isset($msg_alerta{0})) {
                $msg_alerta = "ATENÇÃO: Não fazer reparo neste produto! A Lorenzetti vai analisar a possibilidade de troca deste produto! Aguarde instruções.";
            }

            echo "<script type='text/javascript'>alert(\"$msg_alerta\"); window.location='os_finalizada.php?os=$os';</script>";
        }
    }

    //
    if( in_array($login_fabrica, array(11,172)) ){
        echo "<table width='700' border='0' cellpadding='3' cellspacing='5' align='center' bgcolor='#0000FF'>";
        echo "<tr>";
        echo "<td valign='middle' align='center'>";
            echo "<P class='c1'>Caso algum tipo de <I>Defeito Constatado</I> n&atilde;o esteja relacionado nas op&ccedil;&otilde;es, ou alguma pe&ccedil;a n&atilde;o seja encontrada na <I>LISTA B&Aacute;SICA</I> do produto, favor informar o Dpto. de Assist&ecirc;ncia T&eacute;cnica atrav&eacute;s do email <a id='lnx' href='mailto:apoio_tecnico@lenoxx.com.br'>apoio_tecnico@lenoxx.com.br</A> informando o modelo do produto e a pe&ccedil;a n&atilde;o encontrada.</P>"; //Texto alterado segundo HD 49350, Erasmo [Manuel]
        echo "</td>";
        echo "</tr>";
        echo "</table>";
        echo "<br>";
        if (strlen($os) > 0) { // HD 68996
            $sql = " SELECT comunicado
                     FROM tbl_comunicado
                     JOIN tbl_os USING(produto)
                     WHERE tbl_os.os = $os
                     AND   tbl_os.fabrica = $login_fabrica
                     AND   tbl_comunicado.fabrica = $login_fabrica
                     AND tbl_comunicado.ativo IS TRUE ";
            $res = pg_query($con,$sql);
            if (pg_num_rows($res) > 0) {
                $titulo = " HÁ COMUNICADO PARA ESTE PRODUTO. CLIQUE AQUI PARA LER ";
            }else{
                $titulo = " NÃO HÁ COMUNICADOS PARA ESTE PRODUTO ";
            }
        }
        echo "<img src='imagens/botoes/vista.jpg' height='22px' id='img_comunicado' target='_blank' name='img_comunicado' border='0' align='absmiddle'  title='$titulo' onclick=\"javascript:abreComunicado()\" style='cursor: pointer;'><font color='#FF0000' SIZE='4'>&nbsp;&nbsp;Aviso importante - Produto com dica de conserto, repassar ao técnico.</FONT>";
    }

if (strlen($msg_previsao) > 0) {
    echo "<table width='600' border='0' cellpadding='0' cellspacing='0' align='center' bgcolor='#ffCCCC'>";
    echo "<tr>";
    echo "<td height='27' valign='middle' align='center'>";
    echo "<b><font face='Arial, Helvetica, sans-serif' color='#3333FF'>";
    echo $msg_previsao ;
    echo "</font></b>";
    echo "</td>";
    echo "</tr>";
    echo "</table>";
    echo "<br>";

}

#HD 13618
if ( $login_fabrica==45 AND $troca_obrigatoria == 't'){
    echo "<div style='background-color:#FCDB8F;width:600px;margin:0 auto;text-align:center;padding:5px'>";
    #echo "<p style='font-size:14px;font-weight:bold;margin:0px;'>ESTE PRODUTO É TROCA OBRIGATÓRIA</p>";
    echo "<ul style='font-size:12px;margin:0px;'>";
    echo "    <li>Não são fornecidas peças para este produto.";
    echo "    <li>Se houver necessidade de troca de peça, clique no botão abaixo: ";
    echo "</ul>";
    echo "<input type='button' onClick='fnc_troca($os)' value='Clique aqui para Troca de Produto'>";
    echo "</div>";
}

if($login_fabrica == 42 && $prestacao_servico == 't'){
?>
         <div style='background-color:#FCDB8F;width:600px;margin:0 auto;text-align:center;padding:5px'>
            <p style="font:15px Arial; font-weigth: bold; color: #F00">
                Este lançamento de itens caracterizará um pedidos de peças em garantia ao fabricante, <br />não sendo necessário realizar um novo pedido das peças
            </p>
         </div>
<?
}
if($login_fabrica == 72){
	?>
		 <div style='background-color:#FCDB8F;width:600px;margin:0 auto;text-align:center;padding:5px'>
		    <p style="font:15px Arial; font-weigth: bold; color: #F00">
		    Solicitação de peças está limitada a <strong><?=$qtde_itens_mostrar?></strong> pelo o fabricante. Caso seja necessário mais, contactar a Mallory
		    </p>
		 </div>
	<?php
}
#------------ Pedidos via Distribuidor -----------#
$resX = pg_query($con,"SELECT pedido_via_distribuidor FROM tbl_fabrica WHERE fabrica = $login_fabrica");
if (pg_fetch_result($resX,0,0) == 't') {
    $resX = pg_query($con,"SELECT tbl_posto.nome FROM tbl_posto JOIN tbl_posto_linha ON tbl_posto_linha.distribuidor = tbl_posto.posto WHERE tbl_posto_linha.posto = $login_posto AND tbl_posto_linha.linha = $linha");
//------------HD 341319 INICIO------------
    echo "<table class='texto_avulso' align='center' width='700' border ='0'>";
        echo "<tr>";
    if (pg_num_rows($resX) > 0) {
        echo "<td align='center'>Atenção! Peças da linha <b>$linha_nome</b> serão atendidas pelo distribuidor.<br><font size='+1'>" . pg_fetch_result($resX,0,nome) . "</font></td><p>";
    }else{
        echo "<td align='center'>Peças da linha <b>$linha_nome</b> serão atendidas pelo fabricante.</td><p>";
    }
    echo "</tr>";
    echo "</table>";
//------------HD 341319 FIM------------
}
$sql = "SELECT latitude||','||longitude AS LatLng FROM tbl_posto_fabrica WHERE fabrica = $login_fabrica AND posto = $login_posto";

$res = pg_query($con, $sql);
$LatLngPosto = pg_result($res, 0, 'LatLng');
?>

<input type="hidden" name="fabrica_hidden" class="fabrica_hidden" value="<?php echo $login_fabrica; ?>" />
    <!-- ------------- Formulário | LINHA FIM: 7959 ----------------- -->
<form name="frm_os" id="frm_os" method="post" action="<? echo $php_self.'?'.$_SERVER['QUERY_STRING']?>" enctype="multipart/form-data">

<input type='hidden' name='xtipo_atendimento' id='xtipo_atendimento' value='<?php echo $tipo_atendimento;?>'>
<input type='hidden' name='qtde_item' id='qtde_item' value='<? echo $qtde_item ?>'>
<input type='hidden' name='qtde_item_ant' id='qtde_item_ant' value='<? echo $qtde_item_ant ?>'>
<input type='hidden' name='qtde_mostrar' id='qtde_mostrar' value='<? echo $qtde_itens_mostrar ?>'>
<input type="hidden" name="btn_imprimir" value="">
<input type="hidden" name="btn_acao" value="">
<input type="hidden" name="serie_reoperado" id="serie_reoperado" value="<?php echo $serie_reoperado ?>">
<input type="hidden" name="LatLngPosto" id="LatLngPosto" value="<?=$LatLngPosto;?>">
<!-- HD 882634 -->

<?php
    if($login_fabrica == 137 && $posto_interno == false){
        ?>
        <input type="hidden" name="auditoria_numero_serie" id="auditoria_numero_serie" value="<?=$_POST['auditoria_numero_serie']?>" />
        <?php
    }
?>

<?php if($login_fabrica == 96){
    echo "<input type='hidden' name='status_checkpoint' id='status_checkpoint' value='$status_checkpoint'>";
}

if($login_fabrica == 30 or $login_fabrica == 59 or $login_fabrica == 2) { // HD 46493
        echo "<br />";

        $sql = "SELECT tbl_os.os
                FROM tbl_os
                LEFT JOIN tbl_os_produto USING (os)
                LEFT JOIN tbl_os_item USING (os_produto)
                WHERE tbl_os.os      = $os
                AND   tbl_os.fabrica = $login_fabrica
                AND   tbl_os.defeito_constatado IS NULL
                AND   tbl_os.solucao_os IS NULL
                GROUP BY tbl_os.os
                HAVING count(os_item) = 0 ";
        $res = pg_query($con,$sql);
        echo "<table width='400' border='0' cellpadding='0' cellspacing='1' align='center' bgcolor='#ffffff'>";

        if(pg_num_rows($res)  > 0 ) {
            $os_altera      = pg_fetch_result($res,0,os);
            echo "<tr><td nowrap colspan='3' align='center'> Para alterar o produto desta OS, selecione e clique em <b>'Confirmar alteração do Produto'</b></td></td> ";
            echo "<tr>";
            echo "<td nowrap>";
            echo "<input type='hidden' name='os_altera' value = '$os_altera'>";
            echo "<font size='1' face='Geneva, Arial, Helvetica, san-serif'>Referência do Produto</font><br>";
            echo "<input class='frm' type='text' name='referencia_produto'  id='referencia_produto' size='15' maxlength='20' value='$produto_referencia' onblur=\"this.className='frm'; displayText('&nbsp;');\" onfocus=\"this.className='frm-on';\" displayText('&nbsp;Entre com a referência do produto e clique na lupa para efetuar a pesquisa.');><img src='imagens/lupa.png' border='0' align='absmiddle' onclick=\"javascript: fnc_pesquisa_produto (document.frm_os.referencia_produto,document.frm_os.descricao_produto,'referencia',document.frm_os.produto_voltagem)\" style='cursor: hand'>";
            echo "</td>";
            echo "<td nowrap>";
            echo "<font size='1' face='Geneva, Arial, Helvetica, san-serif'>Descrição do Produto</font><br>";
            echo "<input class='frm' type='text' name='descricao_produto' id='descricao_produto' size='30' value='$produto_descricao' onblur=\"this.className='frm'; displayText('&nbsp;');\" onfocus=\"this.className='frm-on';\" displayText('&nbsp;Digite aqui o modelo do produto e clique na lupa para efetuar a pesquisa.'); ><img src='imagens/lupa.png' border='0' align='absmiddle' onclick=\"javascript: fnc_pesquisa_produto (document.frm_os.referencia_produto,document.frm_os.descricao_produto,'descricao',document.frm_os.produto_voltagem)\"  style='cursor: pointer'></A>";
            echo "<input type='hidden' name='produto_voltagem' value=''>";
            echo "</td>";
            echo "<td><br>";
            echo "<input type='submit' name = 'btn_altera' value='Confirmar alteração do Produto' class='btn_altera'>";
            echo "</td>";
            echo "</tr>";
            echo "</table>";
            echo "<hr></hr>";
        }else{
            echo "<tr>";
            echo "<td nowrap><font size='1' face='Geneva, Arial, Helvetica, san-serif'>Produto</font><br>";
            echo "<font size='2' face='Geneva, Arial, Helvetica, san-serif'><b>";
            echo "$produto_referencia - $produto_descricao";
            echo "</b></font>";
            echo "</td>";
            echo "</tr>";
            echo "</table>";
            echo "<br>";
        }

     }
    #HD 101357
    if($login_fabrica==3){
        echo "<input name='linha_envia' type='hidden' value='".$linha."'>";
    }

    if($fabricas_padrao_itens || $login_fabrica == 95 || $login_fabrica >= 99){
        $width_nova_fabrica = "700px";
    }else{
        $width_nova_fabrica = "90%";

        if ($login_fabrica == 6) {
            $width_nova_fabrica = "1000px";
        }

    }
     ?>

<!----------HD 341319 INICIO---------->

<table width="<?echo $width_nova_fabrica?>" border="0" cellpadding="0" cellspacing="0" align="center" class='formulario'>
<tr>
    <td class='titulo_tabela'>
        <?=traduz("Lançamento de Itens")?>
    </td>
</tr>
<tr>
<!----------HD 341319 FIM---------->
    <td valign="top" align="center">

        <input type="hidden" name="os"        value="<?echo $os?>">
        <input type="hidden" name="voltagem"  value="<?echo $produto_voltagem?>">
        <input type='hidden' name='produto_referencia' value='<? echo $produto_referencia ?>'>

<?php
    if ($usa_versao_produto and isFabrica(120,201)) {
        $versao_produto = serie_produto_versao($produto_os, $produto_serie);
        echo "\n<input type='hidden' name='versao_produto' value='$versao_produto' />\n";
    }
?>
        <p>

<? if ($login_fabrica == 1 or $login_fabrica == 35) { ?>
        <table border="0" cellspacing="0" cellpadding="0" align="center">
        <tr>
            <td nowrap><a href="os_print.php?os=<? echo $os ?>" target="_blank" alt="Imprimir OS"><img src="imagens/btn_imprimir.gif"></a></td>
        </tr>
        </table>
<? } ?>

        <table width="100%" border="0" cellspacing="5" cellpadding="3">
        <?php
        if ($login_fabrica == 6) {
            $td_arg = "style='width: 18%' align='left'";
        } else {
            $td_arg = "nowrap";
        }
        ?>
        <tr>
            <td <?php echo $td_arg ?>>
                <font size="1" face="Geneva, Arial, Helvetica, san-serif">OS</font>
                <br>
                <font size="2" face="Geneva, Arial, Helvetica, san-serif">
                <b>
<?
        if ($login_fabrica == 1) echo $codigo_posto;
        echo $sua_os;
?>
                </b>
                </font>
            </td>
        <? if($login_fabrica == 90){ ?>
            <td>
                <font size="1" face="Geneva, Arial, Helvetica, san-serif">
                Tipo Atendimento</font><br />
                <font size="2" face="Geneva, Arial, Helvetica, san-serif"><b>
                <?php
                    if($tipo_atendimento == 88)
                        echo 'ATENDIMENTO BALCÃO';
                    else if($tipo_atendimento == 89)
                        echo 'ATENDIMENTO COM DESLOCAMENTO';
                ?></b>
                </font>
            </td>
        <? } ?>

        <?php
        if ($login_fabrica == 6) {
            $td_arg = "style='width: 28%' align='left'";
        } else {
            $td_arg = "nowrap";
        }
        ?>
            <td <?php echo $td_arg ?>>
                <font size="1" face="Geneva, Arial, Helvetica, san-serif">Consumidor</font>
                <br>
                <font size="2" face="Geneva, Arial, Helvetica, san-serif">
                <b><? echo substr($consumidor_nome,0,20) ?></b>
                </font>
            </td>

            <? if ($login_fabrica == 19) { ?>
            <td nowrap>
                <font size="1" face="Geneva, Arial, Helvetica, san-serif">Qtde. Produtos</font>
                <br>
                <font size="2" face="Geneva, Arial, Helvetica, san-serif">
                <b>
                <?
                echo $qtde_produtos;
                ?>
                </b>
                </font>
            </td>
            <? } ?>

            <?php
            if ($login_fabrica == 6) {
                $td_arg = "style='width: 28%' align='left'";
            } else {
                $td_arg = "nowrap";
            }
            ?>
            <td <?php echo $td_arg ?>>
                <div id="produto_descricao_opener" style='float:left;'>
                <font size="1" face="Geneva, Arial, Helvetica, san-serif"><?=traduz("Produto")?></font>
                <br>
                <font size="2" face="Geneva, Arial, Helvetica, san-serif">
                <b><?
#------------HD 341319 INICIO------------
                echo "$produto_referencia - ".substr($produto_descricao,0,30) ?></b>
<!-----------HD 341319 FIM---------->
                </font>

                </div>
                <?php

                    if ($login_fabrica == 74) { //hd 377814

                        echo '<div style="text-align:center;font-weight:bold;" id="data_fabricacao_opener">
                                    <input type="hidden" name="data_fabricacao" value="'.$data_fabricacao.'">
                                    Data de Fabricação
                                    <p>'.$data_fabricacao.'</p>
                              </div>';

                    }
                    $sqlv = "SELECT tbl_comunicado.comunicado, extensao
                               FROM tbl_comunicado
                               LEFT JOIN tbl_comunicado_produto USING(comunicado)
                              WHERE fabrica = $login_fabrica
                                AND tipo = 'Vista Explodida'
                                AND ativo
                                AND extensao is not null
                                AND (   tbl_comunicado.produto         = $produto_os
                                     OR tbl_comunicado_produto.produto = $produto_os)";

                    $resv = pg_query($con,$sqlv) ;
                    
                    if (pg_num_rows($resv) > 0) {
                        $vcomunicado             = pg_fetch_result($resv, 0, 'comunicado');
                        $vextensao               = pg_fetch_result($resv, 0, 'extensao');

                        if ($S3_online) {
                            if ($s3ve->temAnexos($vcomunicado))
                                $vista_explodida_produto = $s3ve->url;
                            else
                                $vista_explodida_produto = file_exists("comunicados/$vcomunicado.$vextensao") ? "comunicados/$vcomunicado.$vextensao":false;
                        } else {
                            $vista_explodida_produto = file_exists("comunicados/$vcomunicado.$vextensao") ? "comunicados/$vcomunicado.$vextensao":false;
                        }

                        if($login_fabrica == 45){
                            if ($vista_explodida_produto !== false) {
                                echo "&nbsp;<a href='lbm_impressao.php?produto=$produto_os' target='_blank' style='vertical-align:top;font-size:9px;height:32px;line-height:16px;display:inline-block;width:100px'>
                                        <img src='imagens/botoes/vista_explodida_icone.png' style='float:left' height='32' alt='Vista Explodida' title='Vista Explodida do Produto' />
                                        <span >Vista<br />Explodida</span>
                                    </a>";
                            }
                        }else{
                            if ($vista_explodida_produto !== false) {
                                echo "&nbsp;<a href='$vista_explodida_produto' target='_blank' style='vertical-align:top;font-size:9px;height:32px;line-height:16px;display:inline-block;width:100px'>
                                        <img src='imagens/botoes/vista_explodida_icone.png' style='float:left' height='32' alt='Vista Explodida' title='Vista Explodida do Produto' />
                                        <span >Vista<br />Explodida</span>
                                    </a>";
                            }
                        }
                    }else if(in_array($login_fabrica, array(141,144))){
                        $link_vista_explodida = "";
                        echo "&nbsp;<a href='$link_vista_explodida' target='_blank' style='vertical-align:top;font-size:9px;height:32px;line-height:16px;display:inline-block;width:100px'>
                                <img src='imagens/botoes/vista_explodida_icone.png' style='float:left' height='32' alt='Vista Explodida' title='Vista Explodida do Produto' />
                                <span >Vista<br />Explodida</span>
                            </a>";
                    }
                ?>
            </td>

            <td nowrap>
            <?
            if ($login_fabrica == 1 OR $login_fabrica == 51) {

                echo "<font size=\"1\" face=\"Geneva, Arial, Helvetica, san-serif\">Versão/Type</font>";
                echo "<br>";
        GeraComboType::makeComboType($parametrosAdicionaisObject, $type, null, array("class"=>"frm"));
            echo GeraComboType::getElement();
            }
            ?>
            </td>

            <?  if ((in_array($login_fabrica,array(15,24,30,50,74,85,137))) || ($login_fabrica  == 19 && $produto_linha == 265) || ($login_fabrica == 52 && strlen($produto_serie_db)==0)){
                #HD 345334

                $label_serie = null;
                if ($login_fabrica ==85){
                    $sqlPreSerie = "SELECT serie FROM tbl_hd_chamado_extra WHERE os=$os;";
                    $resPreSerie = pg_query($con,$sqlPreSerie);
                    if(pg_num_rows($resPreSerie)){
                        $serie = pg_fetch_result($resPreSerie,0,'serie');
                        if(trim($serie) != ''){
                            $label_serie = '<font size="1" face="Geneva, Arial, Helvetica, san-serif">* N. de Série informado no CallCenter: <strong>'.$serie.'</strong></font><br />';
                        }
                    }
                }
                if ($login_fabrica == 74) {

                    $sql = "SELECT os FROM tbl_os WHERE os = $os AND status_os_ultimo = 103";
                    $resStatus = pg_query($con,$sql);

                    $block_serie = pg_num_rows($resStatus) > 0 ? 'readonly' : '';

                    /* verifica se Ã© OS vinculada */

                    if($fechamentoOS->isOsVinculada($os)){
                        $arrOS = $fechamentoOS->getArrOS();
                        $sqlVerificaSerie = "SELECT serie from tbl_os where os = '".$arrOS[0]."'";
                        $resVerificaSerie = pg_query($con,$sqlVerificaSerie);
                        if(pg_num_rows($resVerificaSerie) > 0){
                            $produto_serie = pg_fetch_result($resVerificaSerie, 0,"serie");
                            $block_serie = 'readonly';

                        }

                    }
                }
                ?>
                <td nowrap  valign='top'>
                <font size="1" face="Geneva, Arial, Helvetica, san-serif"><?= ($login_fabrica == 137) ? "N. Lote" : "N. Série"; ?></font>
                <br>
                <input type="hidden" name="produto_serie_db" id="produto_serie_db" value="<?= $produto_serie_db; ?>" />
                <input class="frm" type="text" name="produto_serie" id="produto_serie" <?=$block_serie?>
                        size="18" maxlength="20" value="<?=$produto_serie ?>"
                      onblur="this.className='frm';<?if (in_array($login_fabrica, array(30,85))) {?>validaSerieEsmaltec(this.value,<?=$produto_os?>,<?=$login_fabrica?>); <?}?>displayText('&nbsp;');"
                     onfocus="this.className='frm-on'; displayText('&nbsp;Digite aqui o número de série do aparelho.');">

                <br>
                <?php if($login_fabrica == 24){?>
                    <div id="msg_erro_produto_serie"></div>

                <?php } ?>


                <font face='arial' size='1'></font>
                <?= $label_serie;?>
                <div id='dados_1' style='position:absolute; display:none; border: 1px solid #949494;background-color: #f4f4f4;'>
                </div>
            </td>
            <? }else{ ?>

            <?php
            if ($login_fabrica == 6) {
                $td_arg = "style='width: 26%' align='left'";
            } else {
                $td_arg = "nowrap";
            }
            ?>

            <?php if($login_fabrica <> 127){ // HD-2296739 ?>
            <td <?php echo $td_arg ?>>
                <font size="1" face="Geneva, Arial, Helvetica, san-serif">
                    <?
                    if($login_fabrica=="35"){
                        echo "PO#";
                    }else{
                        echo (strlen($produto_serie) > 0) ? ($login_fabrica == 137) ? "Lote" : "N. Série" : "";
                    }
                    ?>
                </font>
                <br>
                <font size="2" face="Geneva, Arial, Helvetica, san-serif">
                <b><? echo $produto_serie ?></b>
        </font>
        <?php $campo_tipo =  (($login_fabrica == 15 and !empty($produto_serie)) or $login_fabrica <> 15) ?'hidden':'text';?>
        <input type="<?=$campo_tipo?>" name="produto_serie" id="produto_serie" value="<?=$produto_serie ?>">

            </td>
            <?
            }
        }
        ?>
        </tr>
    </table><?php
//relacionamento de integridade comeca aqui....
echo "<INPUT TYPE='hidden' name='xxproduto_linha' value='$produto_linha'>";
echo "<INPUT TYPE='hidden' name='xxproduto_familia' value='$produto_familia'>";

//WELLINGTON 20/12/2006 -
//SE FOR LENOXX E TIVER UM DOS DEFEITOS INATIVOS, PREENCHE COM ESPAÇO EM BRANCO PARA PA PREENCHER NOVAMENTE
if ( in_array($login_fabrica, array(11,172)) AND ($defeito_reclamado==3708 or $defeito_reclamado==3710 )) $defeito_reclamado = "";

if ($login_fabrica==15){
    if($os < '2998725') $defeito_reclamado = "";
}

//feito isso pois a britania abre OS para um diagnostico depois os retira e isso estava travando as OS
//Como o diagnostico esta inativo pode seguir a os. 

if(($login_fabrica==6 or $login_fabrica==3 OR $login_fabrica==24) and strlen($defeito_reclamado)>0){
//verifica se o defeito reclamado esta ativo, senao ele pede pra escolher de novo...acontece pq houve a mudança de tela.
    $sql = "SELECT ativo from tbl_defeito_reclamado where defeito_reclamado=$defeito_reclamado";
    $res = pg_query($con,$sql);
    $xativo = pg_fetch_result($res,0, ativo);

    if($xativo=='f'){
        $defeito_reclamado= "null";
    }    

    $sql = "SELECT defeito_reclamado
            FROM tbl_diagnostico
            WHERE fabrica=$login_fabrica
            AND linha = $produto_linha
            AND defeito_reclamado = $defeito_reclamado
            AND familia = $produto_familia
            AND tbl_diagnostico.ativo='t' ";

    $res = @pg_query($con,$sql);

    if (@pg_num_rows($res)) {
        $xativo = pg_fetch_result($res, 0, 'defeito_reclamado');
    } else {
        $xativo = "";
    }

    if($login_fabrica != 3){
        if (strlen($xativo) == 0) {
            $defeito_reclamado = "";
        }
    }
}

//se tiver o defeito reclamado ativo
//HD 351696 InÃ­cio
if ($login_fabrica == 42 || $login_fabrica == 74 || ($fabricas_padrao_itens || $login_fabrica > 99)) {

    $sqlFamilia = "SELECT familia from tbl_diagnostico WHERE familia = ".$produto_familia;
    $resFamilia = @pg_exec($con,$sqlFamilia);

    if (@pg_numrows($resFamilia) > 0) {
        $condFamilia = " AND tbl_diagnostico.familia = $produto_familia";
    }

    if($login_fabrica == 140){
    $sql_linha = "SELECT tbl_produto.linha from tbl_produto join tbl_os on tbl_os.produto = tbl_produto.produto WHERE tbl_os.os = $os AND tbl_os.fabrica = $login_fabrica AND tbl_produto.fabrica_i = $login_fabrica";
    $res_linha = pg_query($con, $sql_linha);
    if(pg_num_rows($res_linha) > 0){
        $condFamilia = " AND tbl_diagnostico.linha = ".pg_fetch_result($res_linha,0,linha);
    }
    }
?>

    <table width='100%' class='formulario'>
        <tr><?php

            if (!in_array($login_fabrica, array(46,81,94,98,99,114)) && ($login_fabrica < 104 OR ($login_fabrica == 115 OR $login_fabrica == 116 OR in_array($login_fabrica,[120,201]))))  {?>

                <td align='left'>
                    <?=traduz("Defeito Reclamado")?> <br /><?php

                    if (!empty($defeito_reclamado) && !in_array($login_fabrica, array(74,101))) {

                        if ($login_fabrica != 120 and $login_fabrica <> 201) {
                            $sql = "SELECT defeito_reclamado, descricao
                                    FROM tbl_defeito_reclamado
                                    WHERE defeito_reclamado = $defeito_reclamado
                                    AND fabrica = $login_fabrica";

                            $res = pg_query($con, $sql);

                            $def_reclamado          = pg_result($res, 0, 'defeito_reclamado');
                            $desc_defeito_reclamado = pg_result($res, 0, 'descricao');

                            echo "<input type='hidden' value='$def_reclamado' name='defeito_reclamado' /><b>$desc_defeito_reclamado</b>";
                        } else {

                            $sql = "SELECT familia
                                      FROM tbl_produto
                                     WHERE referencia = '{$produto_referencia}'
                                       AND fabrica_i  = {$login_fabrica}
                                     LIMIT 1";

                            $res = pg_query($con,$sql);

                            if (pg_num_rows($res) > 0) {
                                $familia = pg_fetch_result($res,0,0);
                                $cond_1 = "AND tbl_produto.familia = {$familia}";
                            }


                            $sql = "SELECT DR.defeito_reclamado,
                                   DR.descricao
                              FROM tbl_diagnostico DI
                              JOIN tbl_defeito_reclamado DR ON DR.defeito_reclamado = DI.defeito_reclamado
                              JOIN tbl_produto              ON tbl_produto.familia  = DI.familia
                             WHERE DI.fabrica = $login_fabrica
                               AND DI.ativo IS TRUE
                               AND tbl_produto.familia = {$familia}
                            UNION
                            SELECT FDR.defeito_reclamado,
                                   DR.descricao
                              FROM tbl_familia_defeito_reclamado FDR
                              JOIN tbl_defeito_reclamado DR
                                    ON DR.defeito_reclamado = FDR.defeito_reclamado
                                   AND DR.fabrica = $login_fabrica
                             ORDER BY descricao";

                            $res         = pg_query($con, $sql);
                            $totalDefRec = pg_num_rows($res);

                            echo "<select name='defeito_reclamado' id='defeito_reclamado' class='frm'>";
                                echo '<option value="">Selecione o Defeito Reclamado</option>';

                                for ($i = 0; $i < $totalDefRec; $i++) {

                                    $def_reclamado          = pg_result($res, $i, 'defeito_reclamado');
                                    $desc_defeito_reclamado = pg_result($res, $i, 'descricao');

                                    $def_selected = ($def_reclamado == $defeito_reclamado) ? "SELECTED" : "";

                                    echo "<option value='$def_reclamado' $def_selected>$desc_defeito_reclamado</option>";

                                }

                            echo "</select>";

                        }

                    } else {

                        $sql = "SELECT tbl_diagnostico.defeito_reclamado       ,
                                       tbl_defeito_reclamado.defeito_reclamado ,
                                       tbl_defeito_reclamado.descricao
                                FROM tbl_diagnostico
                                JOIN tbl_defeito_reclamado USING(defeito_reclamado)
                                WHERE tbl_diagnostico.fabrica = $login_fabrica
                                $condFamilia";


                        $res         = pg_exec($con, $sql);
                        $totalDefRec = pg_numrows($res);

                        echo "<select name='defeito_reclamado' id='defeito_reclamado' class='frm'>";
                            echo '<option value="">Selecione o Defeito Reclamado</option>';//HD 400603

                            for ($i = 0; $i < $totalDefRec; $i++) {

                                $def_reclamado          = pg_result($res, $i, 'defeito_reclamado');
                                $desc_defeito_reclamado = pg_result($res, $i, 'descricao');

                                $def_selected = (in_array($login_fabrica, array(74, 101)) && $def_reclamado == $defeito_reclamado) ? "SELECTED" : "";

                                echo "<option value='$def_reclamado' $def_selected>$desc_defeito_reclamado</option>";

                            }

                        echo "</select>";

                    }?>

                </td><?php

            }

            if (in_array($login_fabrica, array(81, 98, 114)) AND $consumidor_revenda == "R" AND empty($defeito_reclamado_descricao_os)) {?>

                <td align='left'>
                    <?=traduz("Defeito Reclamado")?> <br />
                    <INPUT TYPE='text' name='defeito_reclamado_descricao_os' size='30' value='<?php echo $defeito_reclamado_descricao_os; ?>'>
                </td><?php

            }

            if ($login_fabrica <> 117) {
            ?>
            <td><?php
                if (!empty($defeito_reclamado_descricao_os) && $login_fabrica != 74 && ($fabricas_padrao_itens && ($login_fabrica < 99 || in_array($login_fabrica,array(115,116,117,120,201,121,122,123,124,125,126,129)))) && $login_fabrica != 94) {

                    $sqlDesc = "SELECT defeito_reclamado,
                                       descricao
                                    FROM tbl_defeito_reclamado
                                    WHERE tbl_defeito_reclamado.descricao = '$defeito_reclamado_descricao_os'
                                    AND fabrica = $login_fabrica";

                    $resDesc = pg_exec($con,$sqlDesc);
                    echo (in_array($login_fabrica,array(46,121,122,123,124,125,126,129)))? traduz("Defeito Reclamado")." <br />" : traduz('Defeito Reclamado Cliente').' <br />';
                    if (pg_numrows($resDesc) > 0) {

                        $xdefeito_reclamado           = pg_fetch_result($resDesc, 0, 'defeito_reclamado');
                        $xdefeito_reclamado_descricao = pg_fetch_result($resDesc, 0, 'descricao');

                        if (in_array($login_fabrica, $fabricas_padrao_itens) || $login_fabrica > 99) {
                            echo "<INPUT TYPE='text' readonly name='defeito_reclamado' value='$defeito_reclamado_descricao_os'>";
                        } else {

                            echo "<INPUT TYPE='text' name='defeito_reclamado_descricao_os' size='30' value='$xdefeito_reclamado_descricao' readonly class='frm'>";
                        }

                        echo "<INPUT TYPE='hidden' name='defeito_reclamado' value='$xdefeito_reclamado' class='frm'>";

                    } else {

                        if(in_array($login_fabrica,array(46,115,116,117,120,201,121,122,123,124,125,126,129))){
                            echo "<INPUT TYPE='hidden' name='defeito_reclamado_descricao_os' value='".$defeito_reclamado_descricao_os."' class='frm'>";
                            echo "<span style='font-weight:bold'>".$defeito_reclamado_descricao_os."</span>";
                        }else{
                            echo "<INPUT TYPE='text' name='defeito_reclamado_descricao_os' size='30' value='$defeito_reclamado_descricao_os' ";

                            if (in_array($login_fabrica, array(81, 98, 114))) {
                                echo "readonly";
                            }

                            echo ">";
                        }

                    }

                 }?>
            </td>

            <?php
            }
            if ((!in_array($login_fabrica, array(94)) && $login_fabrica < 104) or in_array($login_fabrica,array(115,116,120,201,121,122,123,124,125,126,129,140))) { // HD 907550, adicionando COBIMEX-114

?>
            <td>
                <?=$tema?><br />
                <select name='defeito_constatado' id='defeito_constatado' class='frm' >
                    <option value=''>Selecione <?=$tema?></option><?php

                            $sql = "SELECT DISTINCT tbl_diagnostico.defeito_constatado       ,
                                           tbl_defeito_constatado.defeito_constatado ,
                                           tbl_defeito_constatado.descricao,
                                           tbl_defeito_constatado.codigo
                                    FROM tbl_diagnostico
                                    JOIN tbl_defeito_constatado USING(defeito_constatado)
                                    WHERE tbl_diagnostico.fabrica = $login_fabrica
                                    $condFamilia
                                    ORDER BY tbl_defeito_constatado.descricao";

                            $res         = pg_exec($con,$sql);
                            $totalDefRec = pg_numrows($res);

                            for ($i = 0; $i < $totalDefRec; $i++) {

                                $def_constatado          = pg_result($res, $i, 'defeito_constatado');
                                $desc_defeito_constatado = pg_result($res, $i, 'descricao');
                                $cod_defeito_constatado = pg_result($res, $i, 'codigo');

                                $defeito_constatado_desc = ($login_fabrica <> 90 && $login_fabrica <> 45) ? $cod_defeito_constatado." - ".$desc_defeito_constatado : $desc_defeito_constatado;

                                echo "<option value='$def_constatado'";
                                if ($def_constatado == $defeito_constatado) {
                                    echo 'selected';
                                }

                                echo " >$defeito_constatado_desc</option>";

                            }?>
                </select>
            </td><?php
            }

    if ($login_fabrica == 42) {
?>
        <td>Filial<br />


            <select name="filial_posto" id="filial_posto" class='frm'>
                <option value=""></option>
                <?

                $sql = "SELECT  tbl_posto_fabrica.nome_fantasia,
                                tbl_posto_filial.filial_posto
                        FROM    tbl_posto_fabrica
                        JOIN    tbl_posto_filial ON tbl_posto_fabrica.posto = tbl_posto_filial.filial_posto
                        WHERE   tbl_posto_fabrica.fabrica   = $login_fabrica
                        AND     tbl_posto_filial.posto      = $login_posto
                        AND     tbl_posto_fabrica.filial    IS TRUE
                        AND     tbl_posto_filial.garantia   IS TRUE
                  ORDER BY      tbl_posto_fabrica.posto;
                ";

                $res = pg_query($con,$sql);

                if (pg_num_rows($res)>0) {
                    for ($i = 0 ; $i < pg_numrows ($res) ; $i++) {
                        $nome_fantasia = pg_result ($res,$i,'nome_fantasia');
                        $posto_distribuidor = pg_result ($res,$i,'filial_posto');

                        $selected_filial = ($filial_posto == $posto_distribuidor) ? "SELECTED" : null;

                        echo "<option value='$posto_distribuidor' $selected_filial>";
                            echo $nome_fantasia;
                        echo "</option>";
                    }
                }
?>
            </select>

    </td>
    <?
    }

            if (in_array($login_fabrica,array(74))) {
                echo "<td>";
                echo "<font size='1' face='Geneva, Arial, Helvetica, san-serif'>Solução</font><BR>";
                echo "<select name='solucao_os' id='solucao_os' class='frm'  style='width:200px;'>";
                    echo "<option value=''>Selecione a Solução</option>";
                    $sql = "SELECT  tbl_solucao.solucao,
                                    tbl_solucao.descricao
                            FROM tbl_diagnostico
                            JOIN tbl_solucao USING(solucao)
                            WHERE tbl_diagnostico.fabrica=$login_fabrica
                            AND tbl_diagnostico.solucao is not null
                            $condFamilia";

                    $res = pg_query($con, $sql);

                    for ($i = 0; $i < pg_numrows($res); $i++) {
                        $solucao           = pg_result($res, $i, 'solucao');
                        $solucao_descricao = pg_result($res, $i, 'descricao');
                        $select            = "";

                        echo "<option id='opcoes' value='$solucao'";

                        if ($solucao == $solucao_os) {
                            $select = "SELECTED";
                        }

                        echo " $select>$solucao_descricao</option>";

                    }
                echo "</select>";

                echo "</td>";

            }?>
        </tr>

    </table><?php

}
//HD 351696 Fim

#HD 670814 - INICIO
$fabricas_defeitos = array(2,5,6,11,19,24,25,26,172);

if ((in_array($login_fabrica,$fabricas_defeitos) && (strlen($defeito_reclamado) > 0 || count($defeito_reclamado) > 0)) || (($login_fabrica>28 && $login_fabrica <> 30 && $login_fabrica <> 42 && $login_fabrica <> 50 && $login_fabrica <> 74 && !$fabricas_padrao_itens && $login_fabrica < 99 ) && strlen(trim($defeito_reclamado)) > 0 ) || $login_fabrica == 96){

#HD 670814 - FIM
    echo "<table width='100%' border='0' cellspacing='5' cellpadding='0'>";
//validações da Lennox
    if( in_array($login_fabrica, array(11,172)) ){
        //aparencia do produto
        echo "<tr>";
        echo "<td><font size='1' face='Geneva, Arial, Helvetica, san-serif'>Aparência do Produto<br></font><input class='frm' type='text' name='aparencia_produto' size='30' value='$aparencia_produto' onblur=\"this.className='frm'; displayText('&nbsp;');\" onfocus=\"this.className='frm-on'; displayText('&nbsp;Texto livre com a aparência externa do aparelho deixado no balcão.');\" </font></td>";

        //acessórios
        echo "<td><font size='1' face='Geneva, Arial, Helvetica, san-serif'>Acessórios<br></font><input class='frm' type='text' name='acessorios' size='30' value='$acessorios' onblur=\"this.className='frm'; displayText('&nbsp;');\" onfocus=\"this.className='frm-on'; displayText('&nbsp;Texto livre com a aparência externa do aparelho deixado no balcão.');\" </td>";
        echo "</tr>";
    }
//validações da Lennox

    echo "<tr>";

    if ($login_fabrica == 6) {
        $width_td = " style='width: 18%' align='left'";
    } else {
        $width_td = "";
    }

    echo "<td $width_td>";
    echo "<font size='1' face='Geneva, Arial, Helvetica, san-serif'>Defeito Reclamado</font><BR>";

    if ($login_fabrica == 19 && is_array($defeito_reclamado)) {
        $defeito_reclamado = current($defeito_reclamado);
    }
    $sql = "SELECT defeito_reclamado,
                    descricao as defeito_reclamado_descricao
            FROM tbl_defeito_reclamado
            WHERE defeito_reclamado= $defeito_reclamado";
    $res = pg_query($con,$sql);

    if(pg_num_rows($res)>0){
        $xdefeito_reclamado = pg_fetch_result($res,0,defeito_reclamado);
        $xdefeito_reclamado_descricao = pg_fetch_result($res,0,defeito_reclamado_descricao);
    }

    if ($login_fabrica == 6) {
        echo "<b>$xdefeito_reclamado - $xdefeito_reclamado_descricao</b>";
    } else {

        if($login_fabrica == 50){
            echo "<INPUT TYPE='text' name='xxdefeito_reclamado' size='30' value='$xdefeito_reclamado_descricao' readonly>";
        }else{
            echo "<INPUT TYPE='text' name='xxdefeito_reclamado' size='30' value='$xdefeito_reclamado - $xdefeito_reclamado_descricao' disabled>";
        }
    }

    echo "<INPUT TYPE='hidden' name='defeito_reclamado' value='$xdefeito_reclamado'>";
    echo "</td>";
    if ($login_fabrica == 52) {
        echo "<td>";
        echo "<font size='1' face='Geneva, Arial, Helvetica, san-serif'>Grupo $tema</font><BR>";

        $sql = "SELECT    defeito_constatado_grupo,
                        grupo_codigo,
                        descricao
                FROM tbl_defeito_constatado_grupo";
        $res = pg_query($con,$sql);

        echo "<select name='defeito_constatado_grupo' id='defeito_constatado_grupo' size='1' class='frm' onchange='listaSolucaoGrupo(this.value,document.frm_os.xxproduto_familia.value);'>";
        echo "<option value=''>selecione</option>";

        if(pg_num_rows($res)>0){

        for ($y = 0 ; $y < pg_num_rows($res) ; $y++ ) {

            $xdefeito_constatado_grupo = pg_fetch_result($res,$y,defeito_constatado_grupo);
            $defeito_constatado_grupo_descricao = pg_fetch_result($res,$y,descricao);
            $grupo_codigo = pg_fetch_result($res,$y,grupo_codigo);

            echo "<option value='$xdefeito_constatado_grupo'"; if ($defeito_constatado_grupo == $xdefeito_constatado_grupo) { echo "SELECTED"; } echo ">$grupo_codigo - $defeito_constatado_grupo_descricao</option>";
        }

        echo "</select>";

        echo "</td>";

        }

    }

    if ($login_fabrica == 19 && verifica_checklist_tipo_atendimento($tipo_atendimento)) {
            $exibeCondicao = "none";
            $xchecked1 = "";
            $xchecked2 = "";
            $xchecked3 = "";
            $xdisabled = "";

            $sqlEXT = "SELECT campos_adicionais  FROM tbl_os_campo_extra WHERE os=$os";
            $resEXT = pg_query($con,$sqlEXT);
            if (pg_num_rows($resEXT) > 0) {
                $campos_adicionais = json_decode(pg_fetch_result($resEXT, 0, 'campos_adicionais'),1);
                if (isset($campos_adicionais["condicao_instalacao"]) && $campos_adicionais["condicao_instalacao"] != "null") {
                    
                    $xcondicao_instalacao = utf8_decode($campos_adicionais["condicao_instalacao"]);
                    $exibeCondicao = "block";

                    $sql_cons = "SELECT DISTINCT
                                        DR.defeito_reclamado,
                                        DR.descricao AS dr_descricao, 
                                        RC.defeito_reclamado,
                                        DC.defeito_constatado,
                                        DC.descricao AS dc_descricao,
                                        DC.codigo AS dc_codigo
                                   FROM tbl_os_defeito_reclamado_constatado RC
                                   JOIN tbl_defeito_reclamado DR ON DR.defeito_reclamado  = RC.defeito_reclamado
                                   JOIN tbl_defeito_constatado DC ON DC.defeito_constatado = RC.defeito_constatado
                                  WHERE RC.os = $os";
                    $res_dr = pg_query($con, $sql_cons);
                    if (pg_num_rows($res_dr) > 0) {

                        $codigo_rc = pg_fetch_result($res_dr, 0, 'dc_codigo');
                        if ($codigo_rc == '554') {
                            $xdisabled = "disabled";
                        }
                        if ($xcondicao_instalacao == "Instalação sem Defeito") {
                            $xchecked1 = "checked";
                        } elseif ($xcondicao_instalacao == "Não Avaliado") {
                            $xchecked2 = "checked";
                        } elseif ($xcondicao_instalacao == "Defeito na Instalação") {
                            $xchecked3 = "checked";
                        }

                    }

                }
            }

            if ($_POST["condicao_instalacao"] == "Instalação sem Defeito") {
                $xchecked1 = "checked";
                $exibeCondicao = "block";
            } elseif ($_POST["condicao_instalacao"] == "Não Avaliado") {
                $xchecked2 = "checked";
                $exibeCondicao = "block";
            } elseif ($_POST["condicao_instalacao"] == "Defeito na Instalação") {
                $xchecked3 = "checked";
                $exibeCondicao = "block";
                $xdisabled = "disabled";
            }

        echo "
            <td align='right'>
                <div class='mostra_condicao' style='text-align:left;font-size: 12px;display:".$exibeCondicao.";'>
                         Condição de Instalação<br />
                        <input type='radio' data-tipo='instalacao_sem_defeito' {$xdisabled} {$xchecked1} name='condicao_instalacao' value='Instalação sem Defeito' id='instalacao_sem_defeito' /> <label for='instalacao_sem_defeito'>Instalação sem Defeito</label><br />
                        <input type='radio' data-tipo='nao_avaliado' {$xdisabled} {$xchecked2} name='condicao_instalacao' value='Não Avaliado' id='nao_avaliado' /> <label for='nao_avaliado'>Não Avaliado</label><br />
                        <input type='radio' data-tipo='defeito_na_instalacao' {$xchecked3} name='condicao_instalacao' value='Defeito na Instalação' id='defeito_na_instalacao' /> <label for='defeito_na_instalacao'>Defeito na Instalação</label><br />
                </div>
            </td>";

    }


    if ($login_fabrica <> 19) {
        if ($login_fabrica == 6) {
            $width_td = " style='width: 28%;' align='left'";
            $width_select = "240px";
        } else {
            $width_td = "";
            $width_select = "140px";
        }

        echo "<td $width_td><font size='1' face='Geneva, Arial, Helvetica, san-serif'> Constatado</font><BR>";

        if ($pedir_defeito_reclamado_descricao == 'f') {            

                $sql = "SELECT     distinct(tbl_diagnostico.defeito_constatado),
                                tbl_defeito_constatado.descricao
                        FROM tbl_diagnostico
                        JOIN tbl_defeito_constatado on tbl_defeito_constatado.defeito_constatado = tbl_diagnostico.defeito_constatado
                        WHERE tbl_diagnostico.fabrica = $login_fabrica
                        AND tbl_diagnostico.ativo='t'  ";
                    if($login_fabrica != 95 && $login_fabrica !=86) { //HD 676195 - gabrielSilveira
                        $sql .= " AND tbl_diagnostico.linha = $produto_linha
                        AND tbl_diagnostico.defeito_reclamado=$defeito_reclamado" ;
                    }

                if (strlen($produto_familia)>0) $sql .=" AND tbl_diagnostico.familia=$produto_familia ";

                if ($login_fabrica == 19) {

                    //hd 3347
                    $sql .= " AND tbl_defeito_constatado.defeito_constatado <> 10820 ";

                    //hd 3470
                    if ($linha <> 261) $sql .= " AND tbl_defeito_constatado.defeito_constatado <> 10823 ";

                }

                if ($login_fabrica == 24) {
                    $sql.="AND tbl_defeito_constatado.ativo ='t'";
                }

                $sql.=" ORDER BY tbl_defeito_constatado.descricao";
            
            if ($login_fabrica == 19 and $tipo_atendimento == 3) {

                $sql = "SELECT tbl_defeito_constatado.*
                        FROM tbl_defeito_constatado
                        WHERE fabrica = $login_fabrica and defeito_constatado in (10021,10546,10547,10548,10549,10550,10551,10552,10545)";

            }//hd1414 takashi 07-03-07

        } else {

            if ($login_fabrica <> 42 && $login_fabrica <> 86 and $login_fabrica <> 74 and $login_fabrica <> 96)
                $cond = "tbl_diagnostico.linha = $produto_linha";
            else
                $cond = '1=1';

            $sql = "SELECT  distinct(tbl_diagnostico.defeito_constatado),
                            tbl_defeito_constatado.descricao
                    FROM tbl_diagnostico
                    JOIN tbl_defeito_constatado on tbl_defeito_constatado.defeito_constatado = tbl_diagnostico.defeito_constatado
                    WHERE $cond
                    AND tbl_diagnostico.ativo='t' ";

            if (strlen($produto_familia) > 0) $sql .=" AND tbl_diagnostico.familia=$produto_familia ";

            if ($login_fabrica == 24){
                $sql.="AND tbl_defeito_constatado.ativo ='t'";
            }

                $sql.=" ORDER BY tbl_defeito_constatado.descricao";

        }

        $res = pg_query($con,$sql);

        if($login_fabrica == 3 and pg_num_rows($res) == 0){
            $sql = "SELECT tbl_defeito_constatado.descricao, tbl_defeito_constatado.defeito_constatado FROM tbl_defeito_constatado WHERE fabrica = $login_fabrica and defeito_constatado = $defeito_constatado ";
            $res = pg_query($con,$sql);
        }



        echo "<select name='defeito_constatado' id='defeito_constatado' size='1' class='frm'  style='width: $width_select;' ";
        if($login_fabrica<>19 and $login_fabrica <> 59 and $login_fabrica <> 86 and $login_fabrica <> 95){
            echo "onchange='listaSolucao(document.frm_os.defeito_constatado.value, document.frm_os.xxproduto_linha.value, document.frm_os.defeito_reclamado.value,  document.frm_os.xxproduto_familia.value);'";
        } else {
            if ($login_fabrica == 59) {
            echo " onchange=\"javascript: getElementById('defeito_constatado_codigo').value = this.value;getElementById('defeito_constatado_descricao').value = this.options[this.selectedIndex].text;\" ";
            }
            if($login_fabrica == 95) {
                echo " onfocus='listaConstatado(document.frm_os.xxproduto_linha.value, document.frm_os.xxproduto_familia.value,document.frm_os.defeito_reclamado.value,this);' ";
            }
            if ($login_fabrica == 86) {
            echo " onchange='javascript: verificaDefeitoConstatado();' ";
            }
        }
        echo ">";

        echo "<option value=''></option>";
        for ($y = 0 ; $y < pg_num_rows($res) ; $y++ ) {
            $xxdefeito_constatado = pg_fetch_result($res,$y,defeito_constatado) ;
            $defeito_constatado_descricao = pg_fetch_result($res,$y,descricao) ;

            echo "<option value='$xxdefeito_constatado'"; if($defeito_constatado==$xxdefeito_constatado) echo "selected"; echo ">$defeito_constatado_descricao</option>";
        }
        echo "</select>";
        echo "</td>";
    }

    if (!in_array($login_fabrica,array(50,52,42,86,74,95))) {

        if ($login_fabrica == 6) {
            $width_td = " style='width: 28%;' align='left'";
            $width_select = "280px";
        } else {
            $width_td = "";
            $width_select = "140px";
        }

        echo "<td $width_td>";
        if ($login_fabrica == 19) {
            echo "<INPUT TYPE='hidden' name='solucao_os' value='367'>";
        } else {

            echo "<font size='1' face='Geneva, Arial, Helvetica, san-serif'>Solução</font><BR>";

            echo "<select name='solucao_os' id='solucao_os' class='frm'  style='width: $width_select;' onfocus='javascript: if (document.frm_os.defeito_constatado.value != \"\") { listaSolucao(document.frm_os.defeito_constatado.value, document.frm_os.xxproduto_linha.value, document.frm_os.defeito_reclamado.value,  document.frm_os.xxproduto_familia.value);}' >";

            $solucao_descricao = '';

            #HD 171607
            if ($login_fabrica == 3 && $controla_estoque != 't') {
                $sql_solucao = " AND tbl_solucao.descricao <> 'Troca de peça do estoque interno'";
            }

            if (strlen($solucao_os) > 0) {

                $sql = "SELECT solucao,
                                descricao
                        FROM tbl_solucao
                        WHERE fabrica=$login_fabrica
                        AND solucao=$solucao_os
                        $sql_solucao";

                $res = pg_query($con, $sql);
                $solucao_descricao = pg_fetch_result($res,0,descricao);

            }

            echo "<option id='opcoes' value='$solucao_os'>$solucao_descricao</option>";
            echo "</select>";

        }
        echo "</td>";

        if ($login_fabrica == 6 AND $coleta_peca == "t") {
            echo '<td style="width: 26%;">';
            if(strtoupper($linha_nome) == "TABLET"){
                echo "NÂº dos Correios <br/>";
                echo "<input type='text' name='numero_correio' class='frm' value='$obs_adicionais' size='15' maxlength='13'>";
            }else{
                echo "&nbsp;";
            }
            echo '</td>';
        }

    if ($login_fabrica == 96) { //HD 399700 : Trocar tipo de Atendimento Bosch Security
        echo "<td align='left'>";
        echo "<font size='1' face='Geneva, Arial, Helvetica, san-serif'>Tipo Atendimento</font><br />";
        echo "<select name='tipo_atendimento' id='tipo_atendimento' class='frm' style='width:180px;'
        onChange='javascript:verifica_atendimento('tipo_atendimento');'>
        <option></option>";

        $sql = "SELECT *
                FROM tbl_tipo_atendimento
                WHERE fabrica = $login_fabrica
                AND   ativo IS TRUE
                $sql_add1
                $sql_deslocamento
                ORDER BY tipo_atendimento ";

        $res = pg_query ($con,$sql) ;
       for ($i = 0 ; $i < pg_num_rows ($res) ; $i++ ) {
            $codigo = str_pad(pg_fetch_result($res, $i, 'codigo'), 2, '0', STR_PAD_LEFT);
            $desc = pg_fetch_result($res, $i, 'descricao');
            $tipo_at= pg_fetch_result($res, $i, 'tipo_atendimento');

            $txt_option = "$codigo - $desc";
            $opt_sel = ($tipo_atendimento == $tipo_at) ? ' SELECTED':'';

            echo "<option value='$tipo_at'$opt_sel>$txt_option</option>";
       }

        echo "</select>";
        echo "</td>";

        //HD 399700 : Combo de Motivo para OS fora de Garantia Bosch Security
            if($tipo_atendimento == 93){
                echo "<td><font size='1' face='Geneva, Arial, Helvetica, san-serif'>Motivo</font> <br />";
                echo "<select name='motivo' class='frm'>";
                    if(strlen($obs_nf) == 0)
                        echo "<option value=''>Selecione um Motivo</option>";

                    echo "<option value='Equipamento fora do Prazo de Garantia' ";
                        if($obs_nf == 'Equipamento fora do Prazo de Garantia') echo  " selected='selected' ";
                    echo ">Equipamento fora do Prazo de Garantia</option>";
                    echo "<option value='Dano Causado não Coberto pela Garantia' ";
                        if($obs_nf == 'Dano Causado não Coberto pela Garantia') echo  " selected='selected' ";
                    echo ">Dano Causado não Coberto pela Garantia</option>";
                echo "</select>";
                echo "</td>";
            }
    }
    }
    echo "</tr>";
    //HD 4291 Paulo
    if($login_posto== 4311 ) {
        echo "<tr><td>";
        echo "<font size='1' face='Geneva, Arial, Helvetica, san-serif'>Box/Prateleira</font><BR>";
        echo "<input type='text' name='prateleira_box' class='frm' value='$prateleira_box' size='8' maxlength='20'>";
        echo "</td>";
        echo "</tr>";
    }
    //Fim
    echo "</table>";
    echo "<BR><BR>";

}

//Verifica OSG-Avaliacao Lorenzetti
if ($login_fabrica == 19) {

    $sql  = "select tbl_os.tipo_atendimento from tbl_os where tbl_os.os = $os";
    $res  = pg_query($con, $sql);
    $tipo = pg_fetch_result($res, 0, 'tipo_atendimento');

    if ($tipo == 77) {
        echo "<font style='font-size: 14px;'><b>OS de GARANTIA<b></font><br>";
        echo "Sim&nbsp; <input type='radio' name='osg' value='4'>&nbsp;&nbsp;&nbsp;Não&nbsp; <input type='radio' name='osg' value='77' checked>";
        echo "<br><br>";
    }

}
//Fim Verifica OSG-Avaliacao Lorenzetti

//FIM se tiver o defeito reclamado ativo
//caso nao achar defeito reclamado

if ((strlen($defeito_reclamado) == 0 OR (in_array($login_fabrica,array(3,30,50,120,201)) AND strlen($defeito_reclamado) > 0)) && !in_array($login_fabrica,array(42,74,96))) {
    echo "<table width='100%' border='0' cellspacing='5' cellpadding='0'>";

    //validacoes lennox
    if ( in_array($login_fabrica, array(11,172)) ) {
        //aparencia do produto
        echo "<td><font size='1' face='Geneva, Arial, Helvetica, san-serif'>Aparência do Produto<br></font><input class='frm' type='text' name='aparencia_produto' size='30' value='$aparencia_produto' onblur=\"this.className='frm'; displayText('&nbsp;');\" onfocus=\"this.className='frm-on'; displayText('&nbsp;Texto livre com a aparência externa do aparelho deixado no balcão.');\" </font></td>";

        //acessórios
        echo "<td><font size='1' face='Geneva, Arial, Helvetica, san-serif'>Acessórios<br></font><input class='frm' type='text' name='acessorios' size='30' value='$acessorios' onblur=\"this.className='frm'; displayText('&nbsp;');\" onfocus=\"this.className='frm-on'; displayText('&nbsp;Texto livre com a aparência externa do aparelho deixado no balcão.');\" </td>";
        echo "</tr>";
    }

    if($inf_valores_adicionais){
    #if(1==1){
        $checked_custo = ($custo_extra == 't') ? "checked" : "";
        $checked_outro_custo = ($outros_custos == 't') ? "checked" : "";
        echo "<tr>";
        echo "<td width='150' nowrap>
                <input type='hidden' name='valor_adicional_formatado' value='$valor_adicional_formatado'>
                <input type='checkbox' name='custo_extra' id='custo_extra' value='t' $checked_custo $bloqueia_valores>".traduz('Valores Adicionais')." <br>";

                if(!in_array($login_fabrica,array(35,125))){ echo "<span id='outros_custos_span' style='display:none;'> <input type='checkbox' name='outros_custos' id='outros_custos' value='t' $checked_outro_custo $bloqueia_valores>Outros valores</span>"; }
                echo "</td>";

        $valor_adicional_formatado = str_replace("\\", "", $valor_adicional_formatado);
        $valor_adicional_formatado = json_decode($valor_adicional_formatado,true);

        $sqlAdicionaisProduto = "SELECT valores_adicionais FROM tbl_produto WHERE produto = $produto_os AND fabrica_i = $login_fabrica AND valores_adicionais notnull";
        $resAdicionaisProduto = pg_query($con,$sqlAdicionaisProduto);
        if(pg_num_rows($resAdicionaisProduto) > 0){
            echo "<td id='descricao_custos_prod' style='display:none;' valign='top'>";
            $valores_adicionais_prod = pg_fetch_result($resAdicionaisProduto, 0, 'valores_adicionais');
            $valores_adicionais_prod = json_decode($valores_adicionais_prod,true);

            echo "<table width='200'>";
            echo "<tr><th align='left'>Serviço do Produto</th><th align='left'>Valor</th>";
            foreach ($valores_adicionais_prod as $key => $value) {
                unset($checked_valor);
                if(!empty($valor_adicional_formatado[0][$key])){
                    $value = $valor_adicional_formatado[0][$key];
                    $checked_valor = "checked";
                }

                echo "<tr>";
                echo "<td>";
                echo "<input type='checkbox' name='custo_adicional[]' rel='$key' value='$value' class='frm' $checked_valor $bloqueia_valores>";
                echo utf8_decode($key);
                echo "</td>";
                echo "<td>";
                echo "<b>$value</b>";
                echo "<input type='hidden' name='' value='$value' size='5' rel='valor_adicional'>";
                echo "</td>";
                echo "</tr>";
            }
            echo "</table>";
            echo "</td>";
        }
        $sqlAdicionais = "SELECT valores_adicionais FROM tbl_fabrica WHERE fabrica = $login_fabrica";
        $resAdicionais = pg_query($con,$sqlAdicionais);
        if(pg_num_rows($resAdicionais) > 0){
            $valores_adicionais = pg_fetch_result($resAdicionais, 0, 'valores_adicionais');
            $valores_adicionais = json_decode($valores_adicionais,true);

            echo "<td id='descricao_custos' style='display:none;' valign='top'>";
            echo "<table width='200'>";
            if($login_fabrica == 35){
                if(count($valores_adicionais) > 0){
                    echo "<tr><th align='left'>Serviço da OS</th><th align='left'>Valor</th>";
                }
            }else{
                echo "<tr><th align='left'>Serviço da OS</th><th align='left'>Valor</th>";
            }

            foreach ($valores_adicionais as $key => $value) {
                $valor = $value['valor'];

                unset($checked_valor);
                if($valor_adicional_formatado[0][$key]){
                    $valor = $valor_adicional_formatado[0][$key];
                    $checked_valor = "checked";
                }

                echo "<tr>";
                echo "<td>";
                echo "<input type='checkbox' name='custo_adicional[]' rel='$key' value='$valor' class='frm' $checked_valor $bloqueia_valores>";
                echo $key;
                echo "</td>";
                echo "<td>";
                if($value['editar'] == 'f'){
                    echo "<input type='hidden' value='$valor' size='5' class='frm $class' rel='valor_adicional'>";
                    echo "<b>$valor</b>";
                }else{
                    $class = ($value['editar'] == 't') ? "novo_valor_adicional" : "";
                    echo "<input type='text'  value='$valor' size='5' class='frm $class' rel='valor_adicional' onblur='alteraValorAdicional(this)' $readonly style='display:none' $bloqueia_valores>";
                }
                echo "</td>";
                echo "</tr>";
            }
            echo "</table>";
            echo "</td>";
        }

        echo "</tr>";

    }

    //validacoes lennox

    if (!in_array($login_fabrica, array(46,81, 98,120,201,121,122,123,124,125,126,129,101))) {

        if ($pedir_defeito_reclamado_descricao == 't') {

            if(in_array($login_fabrica, array(30,50)) AND strlen($defeito_reclamado) > 0){
                $sqlDef = "SELECT descricao FROM tbl_defeito_reclamado WHERE defeito_reclamado = {$defeito_reclamado}";
                $resDef = pg_query($con,$sqlDef);
                $defeito_reclamado_descricao_os = pg_fetch_result($resDef, 0, 'descricao');
            }

            echo "<tr>";
            echo "<td valign='top' align='left'><font size='1' face='Geneva, Arial, Helvetica, san-serif'>".traduz('Defeito Reclamado')."</font><br>";

            if (strpos($sua_os,'-') == FALSE) {//SE FOR DE CONSUMIDOR

                if (strlen($defeito_reclamado_descricao_os) > 0) {
                    echo "<div style='size=11px'><b>$defeito_reclamado_descricao_os</b></div>";
                    echo "<INPUT TYPE='hidden' name='defeito_reclamado'>";
                    echo "<INPUT TYPE='hidden' name='defeito_reclamado_descricao_os' value='$defeito_reclamado_descricao_os'>";
                } else {
                    echo "<div style='size=11px'><b>$defeito_reclamado_descricao_os</b></div>";
                    echo "<INPUT TYPE='text' name='defeito_reclamado_descricao_os' value='$defeito_reclamado_descricao_os'>";
                    echo "<INPUT TYPE='hidden' name='defeito_reclamado'>";
                }

            } else {//SE FOR DE REVENDA

                if (strlen($defeito_reclamado_descricao_os) == 0) {
                    echo "<div style='size=11px'></div>";
                    echo "<INPUT TYPE='text' name='defeito_reclamado_descricao_os' value='{$_POST['defeito_reclamado_descricao_os']}'>";
                    echo "<INPUT TYPE='hidden' name='defeito_reclamado'>";
                } else {
                    echo "<div style='size=11px'><b>$defeito_reclamado_descricao_os</b></div>";
                    echo "<INPUT TYPE='hidden' name='defeito_reclamado'>";
                    echo "<INPUT TYPE='hidden' name='defeito_reclamado_descricao_os' value='$defeito_reclamado_descricao_os'>";
                }

            }

            echo "</td>";

        } else {

            echo "<tr>";
            echo "<td valign='top' align='left'";
            if ($login_fabrica == 95) {
                echo "width='500'";
            }

            echo "><font size='1' face='Geneva, Arial, Helvetica, san-serif'>Defeito Reclamado</font><br>";
            echo "<select name='defeito_reclamado'  class='frm' style='width:220px;' ";
            echo "onfocus='listaDefeitos(document.frm_os.produto_referencia.value);'";

            if ($login_fabrica == 19) echo "onchange='window.location=\"$php_self?os=$os&defeito_reclamado=\"+this.value'";
            echo ">";

            if ($login_fabrica == 3 && strlen($defeito_reclamado) > 0) {

                $defeitoLblQuery = "SELECT descricao 
                               FROM tbl_defeito_reclamado 
                               WHERE defeito_reclamado = $defeito_reclamado";
                
                $defeitoLbl = pg_query($con, $defeitoLblQuery);
                $defeitoLbl = pg_fetch_result($defeitoLbl, 0, 'descricao');

                echo "<option id='opcoes' value='$defeito_reclamado'>$defeitoLbl</option>";

            } else { 
                
                echo "<option id='opcoes' value=''></option>";
            }

            echo "</select>";

            echo "</td>";
        }

        if ($tipo_atendimento == 22) {

            echo "<td><font size='1' face='Geneva, Arial, Helvetica, san-serif'>$tema</font><BR><font color=green size=1><b>Instalação de Purificador</b></font></td>";
            echo "<td><font size='1' face='Geneva, Arial, Helvetica, san-serif'>Solução</font><BR><font color=green size=1><b>Instalação de Purificador</b></font></td>";
            echo "<input type='hidden' name='defeito_constatado' id='defeito_constatado' value='11261'>";
            echo "<input type='hidden' name='solucao_os' id='solucao_os' value='459'>";

        } else {

            //CONSTATADO
            if (!in_array($login_fabrica,array(19,99,140))) {

                if ($pedir_defeito_constatado_os_item <> 'f' OR $login_fabrica <> 5) {

                    $width_td_esmatec = "";
                    if($login_fabrica == 30){
                        $width_td_esmatec = " width='300' ";
                    }

                    echo "<td $width_td_esmatec ><font size='1' face='Geneva, Arial, Helvetica, san-serif'>$tema</font><BR>";

                    if (!in_array($login_fabrica,array(30,43,85,94,95,131,134,144))) {
                        if (in_array($login_fabrica,array(2,45,59,72))) {
                            echo "<input type='hidden' name='defeito_constatado_codigo' id='defeito_constatado_codigo' value=''>";

                            echo "<input type='hidden' name='defeito_constatado_descricao' id='defeito_constatado_descricao' value=''>";
                        }

                        #HD 670814
                        if(($fabricas_padrao_itens || $login_fabrica > 99) && !in_array($login_fabrica, array(94,172))){
                            $onfocus_def_cons = null;
                            $onchange_def_cons = null;
                        }else{
                            if ($login_fabrica == 72) {
                                $xxJS_defeito_reclamado = "null";
                            } else {
                                $xxJS_defeito_reclamado = "";
                            }

                            $onfocus_def_cons  = "listaConstatado(document.frm_os.xxproduto_linha.value, document.frm_os.xxproduto_familia.value,document.frm_os.defeito_reclamado.value,this);";
                            $onchange_def_cons = "javascript: getElementById('defeito_constatado_codigo').value = this.value;getElementById('defeito_constatado_descricao').value = this.options[this.selectedIndex].text;";
                            if($login_fabrica == 50){
                                $onchange_def_cons= " verificaDefeitoConstatado();";
                            }
                        }
                        ?>
                        <select name="defeito_constatado" id="defeito_constatado" class="frm"  onfocus="<?echo $onfocus_def_cons?>" onchange="<?echo $onchange_def_cons?>" style='width: 300px;'>

                            <?php if ($login_fabrica == 3 && strlen($defeito_constatado) > 0) { 

                                $constatadoLblQuery = "SELECT descricao 
                                                       FROM tbl_defeito_constatado 
                                                       WHERE defeito_constatado = $defeito_constatado";
                
                                $constatadoLbl = pg_query($con, $constatadoLblQuery);
                                $constatadoLbl = pg_fetch_result($constatadoLbl, 0, 'descricao');

                                echo "<option id='opcoes' value='$defeito_constatado'>$constatadoLbl</option>";

                            } else { ?> 

                                <option value="">Selecione o <?=$tema?></option>

                            <?php } 
                        #HD 670814
                        if($fabricas_padrao_itens || $login_fabrica > 99){

                            if ($login_fabrica >= 101){

                                $cond_order_by = ($login_fabrica == 137) ? " tbl_defeito_constatado.codigo "  : " tbl_defeito_constatado.descricao ";

                                $sql_cons = "   SELECT DISTINCT(tbl_diagnostico.defeito_constatado),
                                                                tbl_defeito_constatado.codigo,
                                                                tbl_defeito_constatado.descricao,
                                                                tbl_defeito_constatado.defeito_constatado_grupo
                                                FROM            tbl_diagnostico
                                                JOIN            tbl_defeito_constatado ON tbl_diagnostico.defeito_constatado = tbl_defeito_constatado.defeito_constatado AND tbl_defeito_constatado.ativo
                                                LEFT JOIN       tbl_defeito_constatado_grupo ON tbl_defeito_constatado_grupo.defeito_constatado_grupo = tbl_defeito_constatado.defeito_constatado_grupo
                                                WHERE           tbl_diagnostico.familia = $produto_familia
                                                AND             tbl_diagnostico.fabrica = $login_fabrica
                                                ORDER BY        $cond_order_by ";
                            }else{

                                $sql_cons = "SELECT defeito_constatado, descricao
                                                FROM tbl_defeito_constatado
                                                WHERE fabrica = $login_fabrica; ";
                            }

                            $res_cons = pg_query($con, $sql_cons);

                            if (pg_num_rows($res_cons) > 0) {
                                for ($y = 0; $y < pg_num_rows($res_cons) ; $y++){
                                    $defeito_cons = pg_result($res_cons,$y,'defeito_constatado');
                                    $codigo = pg_result($res_cons,$y,'codigo');
                                    $defeito_constatado_desc = pg_fetch_result($res_cons,$y,'descricao');
                                    $selected = ($defeito_constatado == $defeito_cons) ? "SELECTED" : null;

                                    if($login_fabrica == 137){
                                        $defeito_constatado_desc = $codigo." - ".$defeito_constatado_desc;
                                    }

                                    if (in_array($login_fabrica, array(141))) {
                                        $produto_fora_de_garantia = pg_fetch_result($res_cons, $y, "defeito_constatado_grupo");

                                        $attr_produto_fora_garantia = "produto_fora_garantia='$produto_fora_de_garantia'";
                                    }

                                    echo "<option $selected id='opcoes2_$y' value='$defeito_cons' $attr_produto_fora_garantia >$defeito_constatado_desc</option>";
                                }
                            } else {
                                echo "<option id='opcoes2' value=''></option>";
                            }

                        }elseif ($pedir_defeito_reclamado_descricao == 't' AND strlen($defeito_constatado) AND  ( in_array($login_fabrica, array(2, 15, 30, 35, 40, 43, 45, 46, 50, 51, 56)) OR $login_fabrica>56) ) {

                            $sql_cons = "SELECT defeito_constatado, descricao
                                            FROM tbl_defeito_constatado
                                            WHERE defeito_constatado = $defeito_constatado
                                            AND fabrica = $login_fabrica; ";
                                $res_cons = pg_query($con, $sql_cons);

                                if (pg_num_rows($res_cons) > 0) {
                                    $defeito_constatado_desc = pg_fetch_result($res_cons,0,descricao);
                                    echo "<option id='opcoes2' value='$defeito_constatado' selected>$defeito_constatado_desc</option>";
                                } else {
                                    echo "<option id='opcoes2' value=''></option>";
                                }

                        } else {
                            echo "<option id='opcoes2' value=''></option>";
                        }

                    } else {

                        if (strlen($defeito_constatado) > 0) {

                            $sql_cons = "   SELECT  defeito_constatado  ,
                                                    descricao           ,
                                                    codigo
                                            FROM    tbl_defeito_constatado
                                            WHERE   defeito_constatado  = $defeito_constatado
                                            AND     fabrica             = $login_fabrica;
                            ";

                            $res_cons = pg_query($con, $sql_cons);

                            if (pg_num_rows($res_cons) > 0) {
                                $defeito_constatado_descricao = pg_fetch_result($res_cons, 0, 'descricao');
                                $defeito_constatado_codigo    = pg_fetch_result($res_cons, 0, 'codigo');
                                $defeito_constatado_id        = pg_fetch_result($res_cons, 0, 'defeito_constatado');
                            }

                        }
                        echo "<input type='hidden' name='defeito_constatado' id='defeito_constatado' value='$defeito_constatado_id'>";

                        //hd 46589
                        if (!in_array($login_fabrica,array(94,95,131,134,144))) {

                            echo "<input ";if (!in_array($login_fabrica,array(43))) echo "type='text'"; else echo "type='hidden'"; echo " name='defeito_constatado_codigo' id='defeito_constatado_codigo' size='5' value='$aux_defeito_constatado_codigo' onblur=\" pega_dc('$os','defeito_constatado','defeito_constatado_codigo','defeito_constatado_descricao'); \">";if (!in_array($login_fabrica,array(43))) echo "<img src='imagens/lupa.png' onclick='fnc_pesquisa_dc(\"$os\",document.frm_os.defeito_constatado,document.frm_os.defeito_constatado_codigo,document.frm_os.defeito_constatado_descricao)'>&nbsp;";

                            echo "<input type='text' name='defeito_constatado_descricao' id='defeito_constatado_descricao'";if ($login_fabrica==43) echo " size='30'";echo " value='$aux_defeito_constatado_descricao'><img src='imagens/lupa.png' onclick='fnc_pesquisa_dc(\"$os\",document.frm_os.defeito_constatado,document.frm_os.defeito_constatado_codigo,document.frm_os.defeito_constatado_descricao)'>&nbsp;";

                           

                        } else {

                            echo "<select name='defeito_constatado_codigo' id='defeito_constatado_codigo' class='frm'>";
                            echo "<option id='opcoes2' value=''></option>";
                            if ($login_fabrica == 94 OR $login_fabrica == 131 OR $login_fabrica == 134) {

                                // HD 414797 - Para Everest mostrar apenas os defeitos da familia
                                $sql = "SELECT familia
                                            FROM tbl_os
                                            JOIN tbl_produto USING(produto)
                                            WHERE os = $os
                                            AND fabrica = $login_fabrica";
                                $res = pg_query($con,$sql);

                                if(pg_num_rows($res)) {

                                    $order_by = ($login_fabrica == 131) ? "tbl_defeito_constatado.codigo::integer," : "";

                                    $sql_cons = "SELECT tbl_defeito_constatado.defeito_constatado, tbl_defeito_constatado.descricao,tbl_defeito_constatado.codigo
                                                FROM tbl_defeito_constatado
                                                JOIN tbl_diagnostico USING(defeito_constatado)
                                                WHERE tbl_defeito_constatado.fabrica = $login_fabrica
                                                AND tbl_diagnostico.fabrica = $login_fabrica
												AND tbl_diagnostico.ativo
												AND tbl_defeito_constatado.ativo
                                                AND tbl_diagnostico.familia = " . pg_result($res,0,0) . "
                                                ORDER BY $order_by tbl_defeito_constatado.descricao ";

                                }

                            }else

                                $sql_cons = "SELECT defeito_constatado, descricao,codigo
                                            FROM tbl_defeito_constatado
                                            WHERE fabrica = $login_fabrica and ativo is true $cond  order by descricao; ";
                                $res_cons = pg_query($con, $sql_cons);

                                if (pg_num_rows($res_cons) > 0) {
                                    $contar_rescons = pg_num_rows($res_cons);
                                    for($i=0;$i < $contar_rescons; $i++){
                                        $defeito_constatado_desc = pg_fetch_result($res_cons,$i,descricao);
                                        $defeito_constatado      = pg_fetch_result($res_cons,$i,defeito_constatado);
                                        if(in_array($login_fabrica,array(131,134))){
                                            $codigo_defeito          = pg_fetch_result($res_cons,$i,codigo);
                                            $attr = "codigo='".$codigo_defeito."'";
                                            $cod_defeito = "$codigo_defeito - ";
                                        }else{
                                            $cod_defeito = "";
                                            $attr = "";
                                        }

                                        echo "<option id='opcoes2' $attr value='$defeito_constatado'>$cod_defeito $defeito_constatado_desc</option>";
                                    }
                                }else{
                                    echo "<option id='opcoes2' value=''></option>";
                                }
                                echo "</select>";
                            if(in_array($login_fabrica,array(131,134))){
                                echo "&nbsp;<input type='button' onclick=\"javascript: adicionaIntegridade4()\" value='Adicionar' name='btn_adicionar' style='font-size: 9px;'><br>";
                            }else{
                                echo "&nbsp;<input type='button' onclick=\"javascript: adicionaIntegridade3()\" value='Adicionar' name='btn_adicionar' style='font-size:bold 9px;'><br>";
                            }

                        }
                    } 

                    echo "</td>";


                    echo "<td width='700'>";
                         if($login_fabrica == 30){
                                $sqlFornecedor = "SELECT tbl_fornecedor.fornecedor,
                                            tbl_fornecedor.campos_adicionais,
                                            tbl_fornecedor.nome  
                                                FROM tbl_fornecedor 
                                                JOIN tbl_fornecedor_fabrica using(fornecedor) 
                                                WHERE tbl_fornecedor_fabrica.fabrica = $login_fabrica";
                                $resFornecedor = pg_query($con, $sqlFornecedor);

                                for($fo=0; $fo<pg_num_rows($resFornecedor); $fo++){
                                     $nome = pg_fetch_result($resFornecedor, $fo, 'nome');
                                    $campos_adicionais = json_decode(pg_fetch_result($resFornecedor, $fo, 'campos_adicionais'),true);
                                    $cor_etiqueta_id = $campos_adicionais['cor_etiqueta'];

                                    $sqlCor = "SELECT nome_cor FROM tbl_cor WHERE cor = $cor_etiqueta_id AND fabrica = $login_fabrica";
                                    $resCor = pg_query($con, $sqlCor);
                                    $cor_etiqueta = pg_fetch_result($resCor, 0, 'nome_cor');

                                    $fornecedor = pg_fetch_result($resFornecedor, $fo, 'fornecedor');

                                    /*$cor_etiqueta = str_replace("_", " ", $cor_etiqueta);
                                    $cor_etiqueta = ucwords($cor_etiqueta);*/

                                    $optionFornecedor .= "<option value='$fornecedor'> $cor_etiqueta </option>";

                                }

                                echo "<input type='hidden' name='pedir_cor_etiqueta' id='pedir_cor_etiqueta' value=''> "; 
                                echo "<div class='fornecedor_select' style='display:none' > <font size='1' face='Geneva, Arial, Helvetica, san-serif'>Cor Etiqueta</font> <br> 
                                <select id='fornecedor_select' class='frm' >
                                    <option></option>
                                    $optionFornecedor
                                </select>

                                <input type='hidden' name='cor_etiqueta_fornecedor' id='cor_etiqueta_fornecedor' value='$cor_etiqueta_fornecedor'> 
                                </div>
                                ";
                            }
                    echo "</td>";




                    if ($login_fabrica == 72) {//fputti hd-3130038
                        $esconde = "style='display : none;'";
                        if (!empty($defeito_constatado)) {
                            $esconde = '';
                        }
                        echo "<td class='combo_falha' $esconde><font size='1' face='Geneva, Arial, Helvetica, san-serif'>Falha em Potencial</font><BR>";
                        echo "<select name='falha_em_potencial' id='falha_em_potencial'  class='frm' style='width: 220px;'>";
						if(!empty($defeito_constatado)) {
                            $sql = "SELECT
                                    tbl_servico.descricao AS nome_falha,
                                    tbl_defeito_constatado.descricao AS nome_defeito,
                                    tbl_diagnostico.diagnostico,
                                    tbl_diagnostico.defeito_constatado,
                                    tbl_diagnostico.servico
                            FROM    tbl_diagnostico
                            JOIN tbl_servico ON tbl_servico.servico=tbl_diagnostico.servico
                            JOIN tbl_defeito_constatado ON tbl_defeito_constatado.defeito_constatado=tbl_diagnostico.defeito_constatado
                            WHERE tbl_diagnostico.fabrica = $login_fabrica
                            AND  tbl_diagnostico.defeito_constatado = $defeito_constatado
                            ORDER BY tbl_diagnostico.diagnostico DESC;";

							$res   = pg_query($con,$sql);
						}
                        $qtd   = pg_num_rows($res);

                        if ($qtd > 0) {
                            echo "<option value=''> Selecione ...</option>";
                            for ($i=0; $i < $qtd; $i++) {
                                $servico    = pg_fetch_result($res, $i, servico);
                                $nome_falha = pg_fetch_result($res, $i, nome_falha);
                                $selected = ($falha == $servico) ? 'selected="selected"' : '';
                                echo "<option value='".$servico."' ".$selected.">".trim($nome_falha)."</option>";
                            }
                        } else {
                            echo "<option value=''> Nenhuma Falha em Potencial encontrada.</option>";
                        }
                        echo "</select>";
                        echo "</td>";
                    }


                    if (in_array($login_fabrica, array(141))) {
                    ?>
                        <td>
                            Troca de produto<br />
                            <input type="checkbox" name="necessita_troca_produto" value="t" <? if ($necessita_troca_produto == "t") echo "checked"; ?> />
                        </td>
                    <?php
                    }
                }
            }

            if($login_fabrica == 131){
                ?>
                <td>
                    Causa<br />
                    <select onfocus="atualizaCausas()" name='causa_defeito' id='causa_defeito' class='frm' style='width:150px;' >

                        <?php

                        $sql = "SELECT causa_defeito, tbl_causa_defeito.descricao from tbl_os join tbl_causa_defeito using(causa_defeito) where os = $os";
                        $resCausaDefeito = pg_query($con,$sql);

                        if(pg_num_rows($resCausaDefeito) > 0){
                            echo "<option value='".pg_result($resCausaDefeito,0,causa_defeito)."'>".pg_result($resCausaDefeito,0,descricao)."</option>";
                        }else{
                            echo "<option>Selecione uma opção</option>";
                        }
                        ?>
                    </select>
                </td>
                <?php
            }

            if ($login_fabrica == 94) {//HD 415550

                if($posto_interno === true) {

                    $posto_interno = true;
                    $sql = "SELECT mao_de_obra FROM tbl_os WHERE os = $os";
                    $res = pg_query($con,$sql);
                    if(pg_num_rows($res))
                        $mao_de_obra = number_format( pg_result($res,0,0), 2, ',', '' );
                    echo "<td valign='top'>
                            Mão-de-Obra<br />
                            <input type='text' name='valor_mao_de_obra' id='valor_mao_de_obra' value='".$mao_de_obra."' />
                            <input type='hidden' value='t' name='posto_interno'>
                          </td>";

                }

            }//HD 415550 - FIM

            //CONSTATADO
            //SOLUCAO
            echo "<td>";

            if (($login_fabrica == 19 || $fabricas_padrao_itens || $login_fabrica > 99) && !in_array($login_fabrica, array(172))) {

                if (in_array($login_fabrica, $fabricas_padrao_itens) || $login_fabrica > 99) {
                    echo "&nbsp";
        } else {
            if($login_fabrica == 19) {
                echo "<INPUT TYPE='hidden' name='solucao_os' value='367'>";
            }
                }

            } else {

                if ($pedir_solucao_os_item <> 'f' or ( !in_array($login_fabrica,array(5,42,50,86,95,99)) ) ) {
                    echo "<font size='1' face='Geneva, Arial, Helvetica, san-serif'>Solução</font><BR>";

                    #HD 670814
                    if(($fabricas_padrao_itens || $login_fabrica > 99 || $login_fabrica == 30) && !in_array($login_fabrica, array(172))){
                        $onfocus_solucao = null;
                    }else{
                        $onfocus_solucao = "listaSolucao(document.frm_os.defeito_constatado.value, document.frm_os.xxproduto_linha.value, document.frm_os.defeito_reclamado.value,  document.frm_os.xxproduto_familia.value);";

                    }

                    echo "<select name='solucao_os' id='solucao_os' class='frm'  style='width:200px;' onfocus='$onfocus_solucao' >";
                    
                    
                    if ($login_fabrica == 3 && strlen($solucao_os) > 0) {
                        
                        $sqlSolucao = "SELECT descricao FROM tbl_solucao WHERE solucao = $solucao_os";
                        
                        $resSolucao = pg_query($con, $sqlSolucao);

                        $descricaoSolucao = pg_fetch_result($resSolucao, 0, 'descricao');

                        echo "<option id='opcoes' value='$solucao_os'>$descricaoSolucao</option>";
                    }

                    if ($fabricas_padrao_itens || $login_fabrica > 99){

                        $sql_sol = "SELECT solucao, descricao
                                        FROM tbl_solucao
                                        AND fabrica = $login_fabrica
                                        AND ativo='t'
                                        ORDER BY descricao; ";
                        $res_sol = pg_query($con, $sql_sol);
                        if(pg_num_rows($res_sol) > 0){

                            for ($y = 0; $y < pg_num_rows($res_sol); $y++){
                                $sol_os = pg_fetch_result($res_sol,$y,'solucao');
                                $sol_os_desc = pg_fetch_result($res_sol,$y,'descricao');
                                echo "<option id='opcoes_sol_$y' value='$sol_os'>$sol_os_desc</option>";
                            }
                        }else{
                            echo "<option id='opcoes' value=''>Nenhuma Solução Cadastrada</option>";
                        }

                    }elseif($pedir_defeito_reclamado_descricao == 't' AND strlen($solucao_os) > 0 and ( in_array($login_fabrica, array(2, 15, 35, 40, 43, 45, 46, 50, 51, 56)) OR $login_fabrica>56) ) {

                        $sql_cons = "SELECT solucao, descricao
                                        FROM tbl_solucao
                                        WHERE solucao = $solucao_os
                                        AND fabrica = $login_fabrica; ";
                            $res_cons = pg_query($con, $sql_cons);
                            if(pg_num_rows($res_cons) > 0){
                                $solucao_os_desc = pg_fetch_result($res_cons,0,descricao);
                                echo "<option id='opcoes' value='$solucao_os'>$solucao_os_desc</option>";
                            }else{
                                echo "<option id='opcoes' value=''></option>";
                            }

                    } else {

                        if ($login_fabrica == 3 && strlen($solucao_os) > 0) {

                            $solucaoLblQuery = "SELECT descricao 
                                                FROM tbl_solucao 
                                                WHERE solucao = $solucao_os";
                            
                            $solucaoLbl = pg_query($con, $solucaoLblQuery);
                            $solucaoLbl = pg_fetch_result($solucaoLbl, 0, 'descricao');

                            echo "<option id='opcoes' value='$solucao_os'>$solucaoLbl</option>";

                        } else { 
                            
                            echo "<option id='opcoes' value=''></option>";
                        }
                    }

                    echo "</select>";
                }
            }
            echo "</td>";
            //SOLUCAO

            if($login_fabrica == 90) { // HD 311795
                $sql_r = "SELECT recolhimento FROM tbl_os_extra WHERE os = $os";
                $query = pg_query($con,$sql_r);
                $check = pg_fetch_result($query,0,recolhimento);
                $found = FALSE;

                echo '<td>',
                     '  <font size="1"face="Geneva, Arial, Helvetica, san-serif">',
                     '      Recolhimento<br />';

                $opc = 't';
                if($opc == $check){ $checked = 'checked="checked"'; $found = TRUE; }
                else
                    $checked = '';

                echo '      <input type="radio" name="recolhimento" value="sim" '. $checked . ' />Sim&nbsp;';

                $opc = 'f';
                if($opc == $check || $found == FALSE)
                    $checked = 'checked';
                else
                    $checked = '';

                echo     '  <input type="radio" name="recolhimento" value="nao" '.$checked.' /> N&atilde;o&nbsp;',
                     '  </font>',
                     '</td>';
                // HD 321628
                $sql_r = "SELECT
                          CASE WHEN reoperacao_gas IS NULL THEN 'f' ELSE reoperacao_gas END as reop
                          FROM tbl_os_extra
                          WHERE os = $os";
                $query = pg_query($con,$sql_r);
                $check = pg_fetch_result($query,0,reop);

                echo '<td>
                        <font size="1"face="Geneva, Arial, Helvetica, san-serif">
                            Reoperação de Gás<br />';

                $checked = $check == 't' ? 'checked' : '';
                echo '      <input type="radio" name="reop_gas" value="sim" '.$checked.' /> Sim&nbsp;';
                $checked = $check == 'f' ? 'checked' : '';
                echo     '  <input type="radio" name="reop_gas" value="nao" '.$checked.' /> N&atilde;o&nbsp;',
                     '  </font>',
                     '</td>';

            }

        }

        if (in_array($login_fabrica,array(94))) {

                $check_km = ((strlen($msg_erro) > 0 AND $km == 1) OR $qtde_km > 0) ? " checked " : "";
                $style_km = ((strlen($msg_erro) > 0 AND $km == 1) OR $qtde_km > 0) ? " style='display: block' " : " style='display: none' ";
                $readonly = (($login_fabrica == 94 && ($qtde_km != '0' && !empty($qtde_km))) ? "readonly" : "");
                $disabled = (($login_fabrica == 94 && ($qtde_km != '0' && !empty($qtde_km))) ? "disabled" : "");

                echo "<td width='10px;' align='right' valign='top'>
                        Km<br>
                        <input type='checkbox' name='km' id='km' value='1' $disabled onclick='javascript: verificaKM();' $check_km />
                    </td>";
                echo "<td width='70px'>
                        <div id='qtde_km_div' $style_km>
                            Distância<br>
                            <input type='text' name='qtde_km' $readonly id='qtde_km' value='$qtde_km' maxlength='5' style='width: 60px;' />
                        </div>
                    </td>";

        }

        if (in_array($login_fabrica,array(117))) {
                echo "<td>";
                echo "<font size='1' face='Geneva, Arial, Helvetica, san-serif'>Solução</font><BR>";
                echo "<select name='solucao_os' id='solucao_os' class='frm'  style='width:200px;'>";
                    echo "<option value=''>Selecione a Solução</option>";
                    $sql = "SELECT  tbl_solucao.solucao,
                                    tbl_solucao.descricao
                            FROM tbl_diagnostico
                            JOIN tbl_solucao USING(solucao)
                            WHERE tbl_diagnostico.fabrica=$login_fabrica
                            AND tbl_diagnostico.solucao is not null
                            AND tbl_diagnostico.ativo 
                            AND tbl_solucao.ativo IS TRUE 
                            $condFamilia ORDER BY tbl_solucao.descricao";

                    $res = pg_query($con, $sql);

                    for ($i = 0; $i < pg_numrows($res); $i++) {
                        $solucao           = pg_result($res, $i, 'solucao');
                        $solucao_descricao = pg_result($res, $i, 'descricao');
                        $select            = "";

                        echo "<option id='opcoes' value='$solucao'";

                        if ($solucao == $solucao_os) {
                            $select = "SELECTED";
                        }

                        echo " $select>$solucao_descricao</option>";

                    }
                echo "</select>";

                echo "</td>";

        }

        echo "</tr>";

        if ($login_fabrica == 72) {
            $solucoesPermitidas =  array(3042, 3043, 3044, 3045, 3046);
            $disply = (in_array($solucao_os, $solucoesPermitidas)) ? "" :  "none";
            echo '
                <tr id="ajuste_realizado" style="display:'.$disply.';">
                    <td colspan="4" align="center">
                        <font size="1" face="Geneva, Arial, Helvetica, san-serif">Ajuste Realizado</font><BR>
                        <textarea class="frm" style="width:80%;" name="ajusterealizado" id="ajusterealizado"></textarea>
                    </td>
                </tr>
            ';

        }

        echo "</table>";

        if ($login_fabrica == '50') {
            $sql = "SELECT pergunta, descricao FROM tbl_pergunta WHERE fabrica = $login_fabrica AND ativo ORDER BY ordem";
            $qry = pg_query($con, $sql);

            echo '<div id="perguntas" style="display: none; float: left; text-align: left; width: 900px; margin-top: 10px; margin-left: 20px;">';

            $i = 0;
            while ($fetch = pg_fetch_assoc($qry)) {

                $sqlResp = "SELECT txt_resposta FROM tbl_resposta WHERE pergunta = {$fetch['pergunta']} AND os = {$os}";
                $qryResp = pg_query($con, $sqlResp);

                $resp_value = '';
                if ($qryResp) {
                    $resp_value = pg_fetch_result($qryResp, 0, 'txt_resposta');
                }

                echo '<div style="float: left; width: 440px;">' . $fetch['descricao'] . '</div>';
                echo '<div style="float: left; margin-bottom: 5px; width: 460px;">';
                    echo '<input type="hidden" name="pergunta_' . $i . '" value="' . $fetch['pergunta'] . '" />';
                    echo '<input type="text" style="width: 400px;" name="resposta_' . $i . '" value="' . $resp_value . '" >';
                echo '</div>';
                $i++;
            }

            echo '</div><br/>';
        }

    }

} else {

    if ($login_fabrica == 59) {
        echo "<input type='hidden' name='defeito_constatado_codigo' id='defeito_constatado_codigo' value=''>";
        echo "<input type='hidden' name='defeito_constatado_descricao' id='defeito_constatado_descricao' value=''>";
    }

}

if($inf_valores_adicionais){
    echo "<table width='300' id='table_outros_servicos' style='float:left;display:none;' border='0'>";
            echo "<thead>";
            echo "<tr>";
            echo "<th>Serviço</th>";
            echo "<th>Valor</th>";
            echo "<th> <input type='button' value='Adicionar Linha' onclick='javascript: adiciona_linha_valor_adicional();' $bloqueia_valores> </th>";
            echo "</tr>";
            echo "</thead>";
            echo "<tbody>";

    if(count($valor_adicional_formatado[1]) > 0){
        $s = 1;
        foreach ($valor_adicional_formatado[1] as $key => $value) {
            $key = $key;
            echo "<tr id='mostrar_adicional_$s'>";
            echo "<td width='200'>";
            echo "<input type='text' name='custo_adicional_outros_$s' rel='outros_servicos' value='$key' class='frm' $bloqueia_valores>";
            echo "</td>";
            echo "<td>";
            echo "<input type='text' name='valor_adicional_outros_$s' rel='outros_valores' value='$value' size='5' class='frm novo_valor_adicional' $bloqueia_valores>";
            echo "</tr>";
            $s++;
        }
    }else{
        echo "<tr id='mostrar_adicional_1'>";
        echo "<td>";
        echo "<input type='text' name='custo_adicional_outros_1' rel='outros_servicos' value='' onkeyup='retiraAcentos(this)' class='frm' $bloqueia_valores>";
        echo "</td>";
        echo "<td>";
        echo "<input type='text' name='valor_adicional_outros_1' rel='outros_valores' value='' size='5' class='frm novo_valor_adicional' $bloqueia_valores>";
        echo "</tr>";
    }

    echo "</tbody>";

    echo "</table>";
}

if (in_array($login_fabrica, array(2,30,43,59,85,94,95,114,131,134,144))) {
    if (!in_array($login_fabrica,array(94,95,114,131,134,144))) {
        /*
            echo "<input type='button' onclick=\"adicionaIntegridade(); listaSolucao(document.frm_os.defeito_constatado.value, document.frm_os.xxproduto_linha.value, document.frm_os.defeito_reclamado.value,  document.frm_os.xxproduto_familia.value);\" value='Adicionar Defeito' name='btn_adicionar'><br>";
        */

        echo "<input type='button' onclick=\"javascript: verificaDuplicidade($('#defeito_constatado').val(), $('#solucao_os').val(), document.frm_os.xxproduto_linha.value, document.frm_os.defeito_reclamado.value, document.frm_os.xxproduto_familia.value); \" value='Adicionar Defeito' name='btn_adicionar'><br>";

        echo "<input type='hidden' name='qtde_linhas_defeito' id='qtde_linhas_defeito' value=''>";



    }
    if($login_fabrica == 114){
        echo "<input type='button' onclick=\"adicionaIntegridade5()\" value='Adicionar Defeito' name='btn_adicionar'><br>";
    }

    if(in_array($login_fabrica,array(131,134))){
        $sql = "SELECT  ARRAY_TO_STRING(ARRAY_AGG(codigo), '\",\"')
            FROM tbl_os_defeito_reclamado_constatado
            JOIN tbl_defeito_constatado USING (defeito_constatado)
            WHERE os = $os";
        $resd = pg_query($con,$sql);
        if(pg_num_rows($resd) > 0 and strlen(pg_fetch_result($resd,0,0)) > 0) {

            $defeito_constatados = '["'.pg_fetch_result($resd,0,0).'"]';

        }else{
            $defeito_constatados = str_replace('\\', '', $_POST['defeito_constatado_hidden']);
        }
        echo "<input type='hidden' name='defeito_constatado_hidden' id='defeito_constatado_hidden' value='$defeito_constatados' />";

    }

    echo "<table style='font:bold 14px; display:none;' align='center' width='100%' border='0' id='tbl_integridade' cellspacing='3' cellpadding='3'>
            <thead>";

    if (in_array($login_fabrica,array(30,114))) {
        echo "<input type='hidden' name='qtde_integridade' id='qtde_integridade' value='$qtde_integridade' />";
    }

    if ($login_fabrica != 95) {

        echo "<tr bgcolor='#596D9B' style='color:#FFFFFF;'>";
            echo "<td align='center'><b>$tema</b></td>";

    }

    if (in_array($login_fabrica, array(2,30,43,59,85))) {

        echo "<td align='center'><b>Solução</b></td>";
    }

    if (in_array($login_fabrica, array(30))) {

        echo "<td align='center'><b>Cor Etiqueta</b></td>";
    }

    if ($login_fabrica != 95) {

        echo "<td align='center'><b>Ações</b></td>";
    }

    if ($login_fabrica == 43) {

        echo "<td align='center'><b>Principal</b></td>";
    }

    echo "</tr></thead><tbody>";
    //HD 232039: Achei este problema enquanto fazia o chamado e resolvi
    //Não pode ter este código aqui, senão não mostra os defeitos sempre que der erro:
    /*HD:  67783 -  ADICIONADO SOLUÇÃO PARA A NOVA COMPUTADORES*/
    $temDefeitoConstatado = false;
    
    $qtdDefeitos = 1;

    while ($qtdDefeitos != 200) {
      
        if (isset($_POST['integridade_defeito_constatado_' . $qtdDefeitos])) {

            $temDefeitoConstatado = true;

            break;
        }

        $qtdDefeitos++;
    }

    if ($temDefeitoConstatado) {

        $i = 1;

        while ($i != 200) {

            if (isset($_POST['integridade_defeito_constatado_' . $i])) {

                $post_defeito = $_POST['integridade_defeito_constatado_' . $i]; 
                if($login_fabrica == 30){
                    $cod_cor_etiqueta_fornecedor = $_POST["integridade_cor_fornecedor_".$i]; 
                }                

                $query = "SELECT descricao, codigo FROM tbl_defeito_constatado WHERE defeito_constatado = $post_defeito";

                $res = pg_query($con, $query); 
                
                $descricao_solucao = pg_fetch_result($res, 0, descricao);
                $descricao_codigo = pg_fetch_result($res, 0, codigo);
                
                echo "<tr>";
                echo "<td align='left'><font size='1'><input type='hidden' name='integridade_defeito_constatado_" . $i ."' value='$post_defeito'>$descricao_codigo - $descricao_solucao</font></td>";

                $post_solucao = $_POST["integridade_solucao_" . $i]; 

                $sql_solucao = "SELECT descricao FROM tbl_solucao WHERE solucao = $post_solucao";

                $res_solucao = pg_query($con, $sql_solucao);

                $sl_descricao = pg_fetch_result($res_solucao, 0, descricao);

                echo "<td align='left'><font size='1'><input type='hidden' name='integridade_solucao_$i' value='$post_solucao'>$sl_descricao</font></td>";

                if($login_fabrica == 30){
                    if(strlen(trim($cod_cor_etiqueta_fornecedor))>0){
                        $sql_fornecedor = "SELECT nome, campos_adicionais FROM tbl_fornecedor WHERE fornecedor =  ".$cod_cor_etiqueta_fornecedor;
                        $res_fornecedor = pg_query($con, $sql_fornecedor); 
                        if(pg_num_rows($res)>0){
                            $nome_fornecedor = pg_fetch_result($res_fornecedor, 0, 'nome');
                            $campos_adicionais = json_decode(pg_fetch_result($res_fornecedor, 0, 'campos_adicionais'),true);
                            $cor_etiqueta_id = $campos_adicionais['cor_etiqueta'];

                            $sqlCor = "SELECT nome_cor FROM tbl_cor WHERE cor = $cor_etiqueta_id AND fabrica = $login_fabrica";
                            $resCor = pg_query($con, $sqlCor);
                            $cor_etiqueta = pg_fetch_result($resCor, 0, 'nome_cor');

                            /*$cor_etiqueta = str_replace("_", " ", $cor_etiqueta);
                            $cor_etiqueta = ucwords($cor_etiqueta);*/
                        }

                        echo "<td align='left'><font size='1'>$cor_etiqueta</font>
                                <input type='hidden' name='integridade_cor_fornecedor_$i' value='$cod_cor_etiqueta_fornecedor'> 
                            </td>";
                    }else{
                        echo "<td align='left'></td>";
                    }
                }                
                
                echo "<td align='right'><input type='button' onclick='removerIntegridade(this);' value='Excluir'></td>";
                echo "</tr>";

                ?>
                
                <script type="text/javascript">
                    
                    <?php
                        $status = $_POST["solucao_os"];

                        if (!empty($_POST['peca_0'])) {

                            $status = 242;
                        } 
                    ?>

                    //$("#solucao_os").empty().append('<option value="<?= $status ?>">SELECIONE DEFEITO CONSTATADO</option>');

                </script>

            <?php }

            $i++;
        }
        
        echo "<script>document.getElementById('tbl_integridade').style.display = \"inline\";</script>";

    } else {
        if($login_fabrica == 30){
            $campo_campos_adicionais = " tbl_os_defeito_reclamado_constatado.campos_adicionais ,  "; 
        }

        $sql_cons = "SELECT
                    defeito_constatado_reclamado,
                    $campo_campos_adicionais 
                    tbl_defeito_constatado.defeito_constatado,
                    tbl_defeito_constatado.descricao         ,
                    tbl_defeito_constatado.codigo,
                    tbl_solucao.solucao,
                    tbl_solucao.descricao as solucao_descricao
            FROM tbl_os_defeito_reclamado_constatado
            JOIN tbl_defeito_constatado USING(defeito_constatado)
            LEFT JOIN tbl_solucao USING(solucao)
            WHERE os = $os";

        $res_dc = pg_query($con, $sql_cons);

        if (pg_num_rows($res_dc) > 0) {
    // echo "<script>alert('1');</script>";
            for ($x = 0; $x < pg_num_rows($res_dc); $x++) {

                $campos_adicionais = null; 
                $cod_cor_etiqueta_fornecedor = null; 

                $id_defeito_constatado_reclamado = pg_fetch_result($res_dc, $x, 'defeito_constatado_reclamado');
                $dc_defeito_constatado           = pg_fetch_result($res_dc, $x, 'defeito_constatado');
                $dc_solucao                      = pg_fetch_result($res_dc, $x, 'solucao');                
                $campos_adicionais               = json_decode(pg_fetch_result($res_dc, $x, 'campos_adicionais'), true);

                $celular_cor_etiqueta            = null;

                if(isset($campos_adicionais['cor_etiqueta_fornecedor'])){

                    $cod_cor_etiqueta_fornecedor = $campos_adicionais['cor_etiqueta_fornecedor']; 
                    $sqlFornecedor = "SELECT tbl_fornecedor.fornecedor,
                                        tbl_fornecedor.campos_adicionais,
                                        tbl_fornecedor.nome  
                                    FROM tbl_fornecedor 
                                    JOIN tbl_fornecedor_fabrica using(fornecedor) 
                                    WHERE tbl_fornecedor_fabrica.fabrica = $login_fabrica
                                    and tbl_fornecedor.fornecedor = ". $cod_cor_etiqueta_fornecedor ;
                    $resFornecedor = pg_query($con, $sqlFornecedor);

                    for($fo=0; $fo<pg_num_rows($resFornecedor); $fo++){
                        $nome = pg_fetch_result($resFornecedor, $fo, 'nome');
                        $campos_adicionais = json_decode(pg_fetch_result($resFornecedor, $fo, 'campos_adicionais'),true);
                        $cor_etiqueta_id = $campos_adicionais['cor_etiqueta'];

                        $sqlCor = "SELECT nome_cor FROM tbl_cor WHERE cor = $cor_etiqueta_id AND fabrica = $login_fabrica";
                        $resCor = pg_query($con, $sqlCor);
                        $cor_etiqueta = pg_fetch_result($resCor, 0, 'nome_cor');

                        $fornecedor = pg_fetch_result($resFornecedor, $fo, 'fornecedor');

                        /*$celular_cor_etiqueta = str_replace("_", " ", $cor_etiqueta);
                        $celular_cor_etiqueta  = ucwords($celular_cor_etiqueta);*/
                        $celular_cor_etiqueta = $cor_etiqueta;
                    }
                }

                $sqlx = "SELECT defeito_constatado
                        FROM    tbl_os
                        WHERE   os  = $os
                        AND     defeito_constatado = $dc_defeito_constatado";
                $resx = pg_query($con,$sqlx);

                $defeito_principal = 'f';

                if (pg_num_rows($resx) > 0) {
                    $defeito_principal = 't';
                }

                $dc_descricao         = pg_fetch_result($res_dc, $x, 'descricao');
                $dc_codigo            = pg_fetch_result($res_dc, $x, 'codigo');
                $dc_solucao_descricao = pg_fetch_result($res_dc, $x, 'solucao_descricao');

                $aa = $x+1;
                echo "<tr>";
                echo "<td><font size='1'><input type='hidden' name='integridade_defeito_constatado_$aa' value='$dc_defeito_constatado'>$dc_codigo-$dc_descricao</font></td>";

                if (in_array($login_fabrica, array(2,30,43,59,85))) {
                    echo "<td><font size='1'><input type='hidden' name='integridade_solucao_$aa' value='$dc_solucao'>$dc_solucao_descricao</font></td>";
                    if($login_fabrica == 30){
                        echo "<td><font size='1'><input type='hidden' name='integridade_cor_fornecedor_$aa' value='$cod_cor_etiqueta_fornecedor'>$celular_cor_etiqueta</font></td>";
                    }
                }

                if($login_fabrica == 134){
                    $defeitos_constatado_aux[] = $dc_defeito_constatado;
                    echo "<td align='right'><input type='button' onclick='removerIntegridade(this,$dc_codigo);' value='Excluir' ></td>";
                }else{
                    echo "<td align='right'><input type='button' onclick='removerIntegridade(this,$id_defeito_constatado_reclamado);' value='Excluir' ></td>";
                }

                if ($login_fabrica == 43) {

                    echo "<td align='center'><input type='radio' name='principal' value='$dc_defeito_constatado'";
                        if ($defeito_principal == 't') echo " checked ";
                    echo "></td>";

                }

                echo "</tr>";

            }

            echo "<script>document.getElementById('tbl_integridade').style.display = \"inline\";</script>";

        } else {
    // echo "<script>alert('$qtde_integridade');</script>";
            echo "<script>document.getElementById('tbl_integridade').style.display = \"inline\";</script>";

            $itens_integridade           = explode(';', $integridade_defeito_constatado);
            $itens_integridade_descricao = explode(';', $integridade_defeito_descricao);

            for ($f = 0; $f < $qtde_integridade; $f++) {

                $inc = $f+1;

                echo "<tr>";
                    echo "<td><font size='1'>$itens_integridade[$f]-$itens_integridade_descricao[$f]</font>
                    <input type='hidden' name='integridade_defeito_constatado_$inc' id='integridade_defeito_constatado_$inc' value='$itens_integridade[$f]'>
                    <input type='hidden' name='integridade_defeito_descricao_$inc' id='integridade_defeito_descricao_$inc' value='$itens_integridade_descricao[$f]'>
                    </td>";
                echo "<td align='right'><input type='button' onclick='removerIntegridade(this,\"amem\");' value='Excluir' ></td>";
                echo "</tr>";

            }
            $defeitos_aux = json_decode(str_replace('\\', '', $_POST['defeito_constatado_hidden']));
    // echo "<script>alert('$defeitos_aux');</script>";

            foreach ($defeitos_aux as $defeito) {
                if(strlen($defeito) > 0){
                    $defeitos[] = "'".$defeito."'";
                }
            }

            $defeitos = implode(',', $defeitos);
    // echo "<script>alert('$defeitos');</script>";
            if (strlen($defeitos) > 0) {
                $sql = "select defeito_constatado,codigo,descricao from tbl_defeito_constatado where fabrica = $login_fabrica and codigo in($defeitos)";
                $res = pg_query($con,$sql);

                $defeitos_constatados_emtela = array();

                for ($i=0; $i < pg_num_rows($res); $i++) {
                    $defeitos_constatados_emtela[] = pg_result($res,$i,codigo);
                    $inc = $inc + 1;
                    echo "<tr>";
                        echo "<td><font size='1'>".pg_result($res,$i,codigo)." - ".pg_result($res,$i,descricao)."</font>
                        <input type='hidden' name='integridade_defeito_constatado_$inc' id='integridade_defeito_constatado_$inc' value='".pg_result($res,$i,defeito_constatado)."'>
                        <input type='hidden' name='integridade_defeito_descricao_$inc' id='integridade_defeito_descricao_$inc' value='".pg_result($res,$i,descricao)."'>
                        </td>";
                    echo "<td align='right'><input type='button' onclick='removerIntegridade(this,\"amem\");' value='Excluir' ></td>";
                    echo "</tr>";
                }
            }
        }

        if (strlen($msg_erro) > 0) {
            echo "<script>document.getElementById('tbl_integridade').style.display = \"inline\";</script>";

            $itens_integridade           = explode(';', $integridade_defeito_constatado);
            $itens_integridade_descricao = explode(';', $integridade_defeito_descricao);

            for ($f = 0; $f < $qtde_integridade; $f++) {
                if (!strlen($itens_integridade_descricao[$f])) {
                    continue;
                }

                $inc = $f+1;

                echo "<tr>";
                    echo "<td><font size='1'>$itens_integridade_descricao[$f]</font>
                    <input type='hidden' name='integridade_defeito_constatado_$inc' id='integridade_defeito_constatado_$inc' value='$itens_integridade[$f]'>
                    <input type='hidden' name='integridade_defeito_descricao_$inc' id='integridade_defeito_descricao_$inc' value='$itens_integridade_descricao[$f]'>
                    </td>";
                echo "<td align='right'><input type='button' onclick='removerIntegridade(this,\"amem\");' value='Excluir' ></td>";
                echo "</tr>";

            }

            $defeitos_aux = json_decode(str_replace('\\', '', $_POST['defeito_constatado_hidden']));
            $defeitos = array();
            foreach ($defeitos_aux as $defeito) {
                if(strlen($defeito) > 0){
                    $defeitos[] = "'".$defeito."'";
                }

            }

            if(count($defeitos) > 0) {
                $defeitos = implode(',', $defeitos);
            }
        if (strlen(trim($defeitos)) > 0) {
                $sql = "select defeito_constatado,codigo,descricao from tbl_defeito_constatado where fabrica = $login_fabrica and codigo in($defeitos)";
                $res = pg_query($con,$sql);

                $defeitos_constatados_emtela = array();

                for ($i=0; $i < pg_num_rows($res); $i++) {
                    $defeitos_constatados_emtela[] = pg_result($res,$i,codigo);
                    $inc = $inc + 1;
                    echo "<tr>";
                        echo "<td><font size='1'>".pg_result($res,$i,codigo)." - ".pg_result($res,$i,descricao)."</font>
                        <input type='hidden' name='integridade_defeito_constatado_$inc' id='integridade_defeito_constatado_$inc' value='".pg_result($res,$i,defeito_constatado)."'>
                        <input type='hidden' name='integridade_defeito_descricao_$inc' id='integridade_defeito_descricao_$inc' value='".pg_result($res,$i,descricao)."'>
                        </td>";
                    echo "<td align='right'><input type='button' onclick='removerIntegridade(this,\"amem\");' value='Excluir' ></td>";
                    echo "</tr>";
            }
        }

        if($login_fabrica == 134){
            $defeitos = array();
            $defeitos_aux = json_decode(str_replace('\\', '', $_POST['defeito_constatado_hidden']));

            foreach ($defeitos_aux as $defeito) {
                if(strlen($defeito) > 0 && !in_array($defeito, $defeitos_constatados_emtela)){
                $defeitos[] = "'".$defeito."'";
                }
            }

            $defeitos = implode(',', $defeitos);

            //Cache
            if (strlen(trim($defeitos)) > 0) {
                $sql = "select defeito_constatado,codigo,descricao from tbl_defeito_constatado where fabrica = $login_fabrica and codigo in($defeitos)";
                $res = pg_query($con,$sql);

                for ($i=0; $i < pg_num_rows($res); $i++) {
                    $inc = $inc + 1;

                    if(!in_array(pg_result($res,$i,defeito_constatado),$defeitos_constatado_aux) ){
                        echo "<tr>";
                        echo "<td><font size='1'>".pg_result($res,$i,codigo)." - ".pg_result($res,$i,descricao)."</font>
                            <input type='hidden' name='integridade_defeito_constatado_$inc' id='integridade_defeito_constatado_$inc' value='".pg_result($res,$i,defeito_constatado)."'>
                        <input type='hidden' name='integridade_defeito_descricao_$inc' id='integridade_defeito_descricao_$inc' value='".pg_result($res,$i,descricao)."'>
                        </td>";
                        echo "<td align='right'><input type='button' onclick='removerIntegridade(this,\"amem\");' value='Excluir' ></td>";
                        echo "</tr>";
                        }
                }
            }
        }
        }
    }
    echo "</tbody></table>";

}

if ($login_fabrica == 94 && !empty($os)) {//HD 785254

    $sql = "SELECT os FROM tbl_os_campo_extra WHERE os = $os";
    $res = pg_query($con, $sql);

    if (pg_num_rows($res)) {

        echo "<table style='font:bold 14px;float:left' align='center' width='300' border='0' cellspacing='3' cellpadding='3'>";
            echo '<tr>';
                echo '<td>';
                    echo '<font size="1"face="Geneva, Arial, Helvetica, san-serif">Data de Abertura</font>';
                    echo '<br />';
                    echo '<input type="text" name="data_abertura" id="data_abertura" rel="data" maxlength"10" size="12" value="'.$data_abertura.'" />';
                echo '</td>';
            echo '</tr>';
        echo '</table>';

    }

}

if ($login_fabrica == 19) {

    $sql = "SELECT defeito_reclamado FROM tbl_os_defeito_reclamado_constatado WHERE os = $os LIMIT 1";
    $res = pg_query($con,$sql);

    if (pg_num_rows($res) == 0) {

        $sql = "SELECT defeito_reclamado FROM tbl_os WHERE os = $os";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0) {

            $aux_defeito_reclamado = pg_fetch_result($res,0,0);

            if (strlen(trim($aux_defeito_reclamado)) > 0) {

                $sql = "INSERT INTO tbl_os_defeito_reclamado_constatado(
                            os,
                            defeito_reclamado,
                            fabrica
                        ) VALUES (
                            $os,
                            $aux_defeito_reclamado,
                            $login_fabrica
                        )";
                $res = pg_query($con,$sql);

            }

        }

    }

    echo "<table style=' border:#485989 1px solid; font-size:12px;' align='center' width='700' border='0' cellspacing='3' cellpadding='3' bgcolor='#e6eef7'>";
    echo "<thead>";
        echo "<tr bgcolor='#596D9B' style='color:#FFFFFF;'>";
            echo "<td align='center'><b>".traduz('Defeito Reclamado')."</b></td>";
            echo "<td align='center'><b>$tema</b></td>";
            echo "<td align='center'><b>Adicionar</b></td>";
        echo "</tr>";
    echo "</thead>";
    echo "<tbody>";

    $sql_cons = "SELECT DISTINCT
                    DR.defeito_reclamado                  ,
                    DR.descricao           AS dr_descricao
            FROM tbl_os_defeito_reclamado_constatado RC
            LEFT JOIN tbl_defeito_reclamado          DR ON DR.defeito_reclamado  = RC.defeito_reclamado
            WHERE RC.os = $os
            AND   RC.defeito_reclamado IS NOT NULL";

    $res_dr = pg_query($con, $sql_cons);
    $defeitosHidden = array(); //hd_chamado=2881143
    if (pg_num_rows($res_dr) > 0) {

        for ($x = 0; $x < pg_num_rows($res_dr); $x++) {

            $dr_defeito_reclamado = pg_fetch_result($res_dr, $x, 'defeito_reclamado');
            $dr_descricao         = pg_fetch_result($res_dr, $x, 'dr_descricao');

            $aa  = $x + 1;
            $cor = ($x % 2) ? "#e6eef7" : "#FFFFFF";

            echo "<tr bgcolor='$cor'>";
            echo "<td valign='top'>";
                echo "<input type='hidden' name='defeito_reclamado[]' id='defeito_reclamado_$aa' value='$dr_defeito_reclamado'>";
                echo "<input type='hidden' name='defeito_reclamado_descricao[]' id='defeito_reclamado_descricao_$aa' value='$dr_descricao'>";
                echo "$dr_descricao";
            echo "</td>";

            echo "<td>";
            echo "<select name='defeito_constatado_$aa' id='defeito_constatado[]' class='frm' style='width: 220px;' onfocus='listaConstatado(document.frm_os.xxproduto_linha.value, document.frm_os.xxproduto_familia.value,document.frm_os.defeito_reclamado_$aa.value,this);' >";
            echo "<option id='opcoes2' value=''></option>";
            echo "</select>";
                echo "<br><table id='tab_defeitos_$aa' name='tab_defeitos_$aa' style='font-size:12px;display:none' width='100%'>";
                echo "<thead><tr><td></td></tr></thead>";
                echo "<tbody>";
                $sql_cons = "SELECT DISTINCT
                                RC.defeito_reclamado                 ,
                                DC.defeito_constatado                 ,
                                DC.descricao           AS dc_descricao,
                                DC.codigo AS dc_codigo
                        FROM tbl_os_defeito_reclamado_constatado RC
                        JOIN tbl_defeito_constatado              DC ON DC.defeito_constatado = RC.defeito_constatado
                        WHERE RC.os = $os
                        AND   RC.defeito_reclamado = $dr_defeito_reclamado
                        AND   RC.defeito_constatado IS NOT NULL";
                $res_dc = pg_query($con, $sql_cons);
                if (!isset($_POST['i_defeito_constatado'])) {
                    if(pg_num_rows($res_dc) > 0){
                        $contar_resdc = pg_num_rows($res_dc);
                        for($y=0;$y<$contar_resdc;$y++){
                            $dc_defeito_reclamado = pg_fetch_result($res_dc,$y,defeito_reclamado);
                            $dc_defeito_constatado = pg_fetch_result($res_dc,$y,defeito_constatado);
                            $dc_descricao          = pg_fetch_result($res_dc,$y,dc_descricao);
                            $dc_codigo             = pg_fetch_result($res_dc, $y, 'dc_codigo');
                            $defeitosHidden[] = $dc_defeito_constatado; //hd_chamado=2881143
                            $bb = $y+1;
                            echo "<tr>";
                            echo "<td style='text-align: left; color: #000000;font-size:10px;border-bottom: thin dotted #FF0000'><font size='1'><input type='hidden' data-codigo='{$dc_codigo}' name=\"i_defeito_constatado[$dc_defeito_reclamado][]\" id=\"i_defeito_constatado_".$aa."_".$bb."\" rel=\"defeito_constatado_".$aa."\" value='$dc_defeito_constatado'>$dc_descricao</font></td>";
                            echo "<td align='right'><input type='button' onclick='removerIntegridade2(this,\"tab_defeitos_$aa\",\"$dc_defeito_constatado\");' value='Excluir'></td>"; //hd_chamado=2881143 adicionado $dc_defeito_constatado
                            echo "</tr>";
                        }

                        echo "<script>document.getElementById('tab_defeitos_$aa').style.display = \"inline\";</script>";
                    }
                } else {

                    $bb = 1;
                    foreach ($_POST['i_defeito_constatado'][$dr_defeito_reclamado] as $chaveDefeito => $defeitoConstatadoId) {

                        $sqlDadosConstatado = "SELECT defeito_constatado,
                                                      descricao,
                                                      codigo
                                               FROM tbl_defeito_constatado
                                               WHERE defeito_constatado = {$defeitoConstatadoId}
                                               AND fabrica = {$login_fabrica}";
                        $resDadosConstatado = pg_query($con, $sqlDadosConstatado);

                        $defeitoDescricao = pg_fetch_result($resDadosConstatado, 0, 'descricao');
                        $defeitoCodigo    = pg_fetch_result($resDadosConstatado, 0, 'codigo');
                        $defeitosHidden[] = $defeitoConstatadoId;
                        
                        echo "<tr>";
                        echo "<td style='text-align: left; color: #000000;font-size:10px;border-bottom: thin dotted #FF0000'>
                                <font size='1'>
                                    <input type='hidden' data-codigo='{$defeitoCodigo}' name=\"i_defeito_constatado[$dr_defeito_reclamado][]\" id=\"i_defeito_constatado_".$aa."_".$bb."\" rel=\"defeito_constatado_".$aa."\" value='{$defeitoConstatadoId}'>{$defeitoDescricao}
                                </font>
                              </td>";
                        echo "<td align='right'><input type='button' onclick='removerIntegridade2(this,\"tab_defeitos_$aa\",\"$defeitoConstatadoId\");' value='Excluir'></td>";
                        echo "</tr>";
                        $bb++;
                    }

                    echo "<script>document.getElementById('tab_defeitos_$aa').style.display = \"inline\";</script>";
                }
                echo "</tbody>";
                echo "</table>";
            echo "</td>";
            echo "<td valign='top'>";
            echo "<input type='button' data-posicao='$aa' class='btn-add-defeito-constatado' onclick=\"adicionaIntegridade2('$aa','tab_defeitos_$aa',document.frm_os.defeito_reclamado_$aa,document.frm_os.defeito_reclamado_descricao_$aa,document.frm_os.defeito_constatado_$aa, document.frm_os.xxproduto_familia.value)\" value='Adicionar Defeito' name='btn_adicionar'>";
            echo "</td>";

            echo "</tr>";
        }
        $aa++;

    }
    $arrayDefeitosLorenzetti = implode(',', $defeitosHidden); //hd_chamado=2881143
    $defeitoLorenzetti = "[".$arrayDefeitosLorenzetti."]";//hd_chamado=2881143

    echo "<input type='hidden' name='defeitos_lorenzetti_hidden' id='defeitos_lorenzetti_hidden' value='$defeitoLorenzetti' />"; //hd_chamado=2881143
    echo "<input type='hidden' name='defeitos_lorenzetti_hidden_antigo' id='defeitos_lorenzetti_hidden_antigo' value='$defeitoLorenzetti' />"; //hd_chamado=2881143
    echo "</tbody></table>";
}
//fim caso nao achar defeito reclamado
?>
<?php
//relacionamento de integridade termina aqui....

if ($login_fabrica == 30) {//HD 54672?>
    <BR /><BR />
    <table border='0' cellpadding='0' cellspacing='0' align='center'>
        <tr>
            <td align='center' style='font-size: 12px;'>
                <B>Qtde. Itens:</B>&nbsp;<!-- (<?=$qtde_itens_mostrar." / ".$qtde_item?>)-->
                <select size='1' class="frm" name='qtde_itens_mostrar' onChange="javascript: document.frm_os.submit(); ">
                    <option value='5'  <? if ($qtde_itens_mostrar <= 5) echo 'selected'; ?>>05</option><?php
                    for ($val = 10; $val <= $qtde_item; $val+=10) { // o 5 é padrão, o resto vai de 10 em 10
                        echo "\t\t\t\t\t\t<option value='$val'";
                        if ($qtde_itens_mostrar == $val) echo " SELECTED";
                        echo ">$val</option>\n";
                    }?>
                </select>
            </td>
        </tr>
    </table><?php
}

if ($login_fabrica == 3) {?>

    <table width="100%" border="0" cellspacing="5" cellpadding="0">
        <tr>
            <td align="right" nowrap>
                <font size="1" face="Geneva, Arial, Helvetica, san-serif">Qtde. Itens:</font><br>
                <select name="n_itens" size="1" class="frm" onchange='document.location.href="<? echo $php_self ?>?os=<? echo $os ?>&n_itens="+this.value'>
                <option value='3' <? if ($qtde_itens_mostrar==3)echo " selected"; ?>>3</option>
                <option value='5' <? if ($qtde_itens_mostrar==5)echo " selected"; ?>>5</option>
                </select>
            </td>
        </tr>
    </table><?php

}

if ($tipo_atendimento == 22) {

    echo "<center><font color=red size='1'>Não é possí­vel lançar peças numa OS de Instalação</font></center>";

} else {

    if (in_array($login_fabrica, array(15,74,86))) {

        $qtde_item          = ($login_fabrica == 15) ? 150 : 40;
        $qtde_itens_mostrar = ($login_fabrica == 86) ? 40 : $qtde_itens_mostrar;
        $qtde_itens_mostrar = ($login_fabrica == 15) ? 150 : $qtde_itens_mostrar;

        function verifica_option($v1, $v2) {
            if ($v1 == $v2) return " selected ";
        }
        ?>

        <table width="100%" border="0" cellspacing="1" cellpadding="0">
            <tr>
                <td align="right" nowrap>
                    <font size="1" face="Geneva, Arial, Helvetica, san-serif">Qtde. Itens:</font><br>
                    <select name="n_itens" size="1" class="frm" onchange='mostrarLinhas(this.value);'>
                        <?php
                        for ($val = 10; $val <= $qtde_item; $val+=10) {
                            echo "<option value='$val' ".verifica_option($val, $qtde_itens_mostrar).">$val</option>\n";
                        }
                        ?>
                    </select>
                </td>
            </tr>
        </table><?php

    }

    #HD 2838143 visita_agendada
    if ($login_fabrica == 50) {
        $sqlV = "SELECT to_char(data,'DD/MM/YYYY') AS data, os_visita FROM tbl_os_visita WHERE os = {$os} ORDER BY data";
        $resV = pg_query($con,$sqlV);
        ?>
        <table width="100%" border="0" cellspacing="5" cellpadding="0">
            <tr>
                <td>
                    <font size='1' face='Geneva, Arial, Helvetica, san-serif'>Agendar Visita</font><br><input type='text' size='10' value="" name='visita_agendada' id='visita_agendada' /><button type="button" name="btn_agenda" id="btn_agenda">Gravar</button>
                </td>
            </tr>
            <tr>
                <td>
                    <div id="div_agenda">
                        <table border="1" cellspacing="0" cellpadding="0" style="width:200px;">
                            <thead>
                                <th class="titulo_tabela" style="width:33%">Nº Visita</th>
                                <th class="titulo_tabela" style="width:33%">Data</th>
                            </thead>
                            <tbody>
                                <? if (pg_num_rows($resV)) {
                                    $qtde_agenda = pg_num_rows($resV);?>
                                    <? for ($j = 0; $j < $qtde_agenda; $j++) {
                                        $visita_agendada = pg_fetch_result($resV, $j, 'data');
                                        $os_visita = pg_fetch_result($resV, $j, 'os_visita'); ?>
                                        <tr id="<?=$os_visita?>">
                                            <td><?=$j+1?></td>
                                            <td><?=$visita_agendada?></td>
                                        </tr>
                                    <? }
                                }else{
                                    $qtde_agenda = 0;
                                } ?>
                                <input type="hidden" name="qtde_agenda" id="qtde_agenda" value="<?=$qtde_agenda?>" />
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
        </table>
    <? }

    //HD 415550 - Adicionado Everest
    if (in_array($login_fabrica, array(19,30,50,59,3)) or ( in_array($login_fabrica,array(94,141)) && $posto_interno === true)) { ?>

        <table width="100%" border="0" cellspacing="5" cellpadding="0">
            <tr>
            <? if (!in_array($login_fabrica, array(50))) { ?>
                <td align="left" nowrap>
                    <font size="1" face="Geneva, Arial, Helvetica, san-serif">Nome do Técnico</font>
                    <br />
                    <?php
                    if ((in_array($login_fabrica, array(59)) && strlen($tecnico_nome) == 0) || in_array($login_fabrica, array(141,3))) {

                        if(in_array($login_fabrica, array(3))){
                            $sql = "SELECT
                                        tbl_tecnico.tecnico,
                                        tbl_tecnico.nome
                                    FROM tbl_os
                                        JOIN tbl_produto ON tbl_os.produto = tbl_produto.produto AND tbl_produto.fabrica_i = $login_fabrica
                                        JOIN tbl_tecnico  ON  tbl_produto.linha = ANY(tbl_tecnico.linhas)
                                    WHERE
                                        tbl_tecnico.ativo
                                        AND tbl_tecnico.fabrica = {$login_fabrica}
                                        AND tbl_tecnico.posto = {$login_posto}
                                        AND tbl_os.os = $os
                                    ORDER BY tbl_tecnico.nome;";
                        }else{
                            $sql = "SELECT tecnico, nome FROM tbl_tecnico WHERE fabrica = $login_fabrica AND posto = $login_posto and ativo is true";
                        }
                        $res_tecnico = pg_query($con, $sql);

                        if (pg_num_rows($res_tecnico) == 0) {
                            echo "<a href='tecnico_cadastro.php' title='É necessário cadastrar o técnico no Cadastro de Técnicos para continuar' style='font-size:9pt;' target='_blank'>Cadastre um técnico para continuar</a>";
                        } else {
                            echo "<select name='tecnico' id='tecnico' class='frm'>
                                    <option value='null'>SELECIONE UM TÉCNICO</option>";

                                    for ($t = 0; $t < pg_num_rows($res_tecnico); $t++) {

                                        $tecnico_select = pg_result($res_tecnico, $t, 'tecnico');
                                        $nome_select    = pg_result($res_tecnico, $t, 'nome');

                                        if ($tecnico_select == $tecnico) {
                                            $selected = "selected";
                                        } else {
                                            $selected = "";
                                        }

                                        echo " <option value='$tecnico_select' $selected>$nome_select</option>";

                                    }

                                    $help = "Para cadastrar um novo técnico acesse o Menu Cadastro >> Cadastro de Técnicos";

                            echo "</select> <img src='imagens/help.png' style='cursor:pointer' title='$help' onclick=\"alert('$help')\">";

                        }

                    } else { 
                    ?>

                        <input type='text' name='tecnico_nome' size='20' maxlength='20' value='<? echo $tecnico_nome ?>' />
                    <?php

                    }
            }
            ?>

                </td>
            <?php

                #HD 276459 visita_agendada
                if ($login_fabrica == 30) {

                    $sql_om = " SELECT  tbl_os.cliente_admin,
                                        tbl_cliente_admin.nome AS cliente_admin_nome
                                FROM    tbl_os
                                JOIN    tbl_cliente_admin ON tbl_cliente_admin.cliente_admin = tbl_os.cliente_admin
                                WHERE   tbl_os.os = $os";

                    $res_om = pg_exec($con,$sql_om);

                    if (pg_num_rows($res_om) > 0) {
                        $cliente_admin_nome = pg_fetch_result($res_om,0,cliente_admin_nome);
            ?>
                        <td> <font size='1' face='Geneva, Arial, Helvetica, san-serif'>Atendimento para:</font><br><span style="font-weight:bold"><?=$cliente_admin_nome?></span></td>
                <?php
                    }

                    $sqlV = "SELECT to_char(data,'DD/MM/YYYY') AS data, os_visita FROM tbl_os_visita WHERE os = {$os} ORDER BY data";
                    $resV = pg_query($con,$sqlV);

                ?>
                        <td>
                            <table>
                                <tr>
                                    <td>
                                        <font size='1' face='Geneva, Arial, Helvetica, san-serif'>Agendar Visita</font><br><input type='text' size='10' value="" name='visita_agendada' id='visita_agendada' />
                                        <select name='justificativa_visita' id="justificativa_visita" style="width: 105px;">
                                            <option value=""></option>
                                            <?php
                                                $sql = "SELECT
                                                            justificativa,
                                                            descricao
                                                        FROM tbl_justificativa
                                                        WHERE fabrica = {$login_fabrica} AND ativa = true ORDER BY descricao";
                                                $res = pg_query($con, $sql);
                                                for ($i = 0; $i < pg_num_rows($res); $i++) {
                                                    $descricao = pg_fetch_result($res, $i, "descricao");
                                                    $descricao = (mb_detect_encoding($descricao, 'utf-8', true)) ? utf8_decode($descricao) : $descricao;
                                                    echo "<option value='".pg_fetch_result($res, $i, "justificativa")."'>{$descricao}</option>";
                                                }
                                            ?>
                                        </select>
                                        <button type="button" name="btn_agenda" id="btn_agenda">Gravar</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div id="div_agenda">
                                            <table border="1" cellspacing="0" cellpadding="0" style="width:200px;">
                                                <thead>
                                                    <th class="titulo_tabela" style="width:33%">Nº Visita</th>
                                                    <th class="titulo_tabela" style="width:33%">Data</th>
                                                </thead>
                                                <tbody>
                                                    <?
                                                    if(pg_num_rows($resV)){
                                                        $qtde_agenda = pg_num_rows($resV);

                                                        for($j = 0; $j < $qtde_agenda; $j++){
                                                            $visita_agendada = pg_fetch_result($resV, $j, 'data');
                                                            $os_visita = pg_fetch_result($resV, $j, 'os_visita');
                                                    ?>
                                                    <tr id="<?=$os_visita?>">
                                                        <td><?=$j+1?></td>
                                                        <td><?=$visita_agendada?></td>
                                                    </tr>
                                                    <?
                                                        }
                                                    }else{
                                                        $qtde_agenda = 0;
                                                    }
                                                    ?>
                                                    <input type="hidden" name="qtde_agenda" id="qtde_agenda" value="<?=$qtde_agenda?>" />
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </td>
            <?

                }

                $sql_linha_lorenzetti = "SELECT tbl_produto.linha
                        FROM tbl_produto
                        JOIN tbl_linha ON tbl_produto.linha = tbl_linha.linha
                        WHERE referencia = '$produto_referencia'
                        AND fabrica_i = $login_fabrica";

                $res_linha_lorenzetti = pg_query($con, $sql_linha_lorenzetti);

                $linha_lorenzetti = pg_fetch_result($res_linha_lorenzetti, 0, 'linha');

                # HD 44487
                if ($login_fabrica == 19 && ($linha_lorenzetti == 260 || $linha_lorenzetti == 263)) { 
            ?>
                    <td align="center" nowrap>
                        <div id="esconde_data">
                            <font size="1" face="Geneva, Arial, Helvetica, san-serif">Mês e Ano de Fabricação do Produto</font>
                            <br>
                            <input type='text' name='fabricacao_produto' id='fabricacao_produto' size='16' maxlength='20' value='<? echo $fabricacao_produto ?>'>
                        </div>
                        <input type='hidden' name='fabricacao_produto_hidden' id='fabricacao_produto_hidden' size='16' maxlength='20' value="t">
                    </td>
                    <td align="left" nowrap>
                        <input type='checkbox' name='dt_fabricacao_ilegivel' id='dt_fabricacao_ilegivel' value='t'> Data de fabricação ilegível
                    </td>

            <? } 

                if($login_fabrica == 30){
                    $display = ($defeito_constatado == 12485 OR $defeito_constatado == 11792) ? "block" : "none";
            ?>
                    <td id='arquivo_defeito_constatado_col' style='display:<?=$display?>;'>
                        <input type='file' name='arquivo_defeito_constatado'/>
                    </td>
            <? } ?>
            </tr>
            <tr>
            <?
                if ($login_fabrica == 50) {
                    $sqlPostoProximo = "
                        SELECT  JSON_FIELD('posto proximo',tbl_os_campo_extra.campos_adicionais) AS posto_proximo
                        FROM    tbl_os_campo_extra
                        WHERE os = $os
                    ";
                    $resPostoProximo = pg_query($con,$sqlPostoProximo);

                    if (strlen(pg_fetch_result($resPostoProximo,0,posto_proximo)) > 0) {
                        $posto_proximo = 't';
                    } else {
                        $posto_proximo = 'f';
                    }
                }
                if ((in_array($login_fabrica, array(30)) && strlen(trim($qtde_km)) == 0) || ($login_fabrica == 50 && $posto_proximo == 'f')) {

                    if ($login_fabrica != 50) {
                        $sqlPgDeslc = "
                            SELECT  tbl_posto_familia.paga_deslocamento
                            FROM    tbl_posto_familia
                            JOIN    tbl_produto  USING(familia)
                            WHERE   tbl_posto_familia.posto = {$login_posto}
                            AND     tbl_produto.referencia = '{$produto_referencia}';";
                        $resPgDeslc = pg_query($con, $sqlPgDeslc);

                        $paga_deslocamento = pg_fetch_result($resPgDeslc, 0, paga_deslocamento);

                        if ($paga_deslocamento == 't') {
                            $paga_deslocamento = true;
                        } else {
                            $paga_deslocamento = false;
                        }
                    } else {
                        $sqlPostoProximo = "
                            SELECT  JSON_FIELD('posto proximo',tbl_os_campo_extra.campos_adicionais) AS posto_proximo
                            FROM    tbl_os_campo_extra
                            WHERE os = $os
                        ";
                        $resPostoProximo = pg_query($con,$sqlPostoProximo);

                        if (strlen(pg_fetch_result($resPostoProximo,0,posto_proximo)) > 0) {
                            $paga_deslocamento = false;
                        }
                        $paga_deslocamento = true;
                    }
                    if ($paga_deslocamento) {

                        if (strlen($informar_km) > 0) {
                            $checked_km = " CHECKED";
                            $display_km = "block";
                        } else {
                            $checked_km = "";
                            $display_km = "none";
                        } ?>

                        <td>Informar KM: <input type='checkbox' name='informar_km' id='informar_km' value='S' <?= $checked_km; ?>></td>
                        <td>
                            <div id='div_mapa' style='display:<?= $display_km; ?>;width:500px;text-align:left;background:#efefef;border:#999999 1px solid;font-size:10px;padding:5px;' >
                                <b>Para Calcular a distância percorrida pelo técnico para execução do serviço(ida e volta):<br>
                                Preencha todos os campos de endereço acima ou preencha o campo de distância</b>
                                <br><br>
                                <span id="ida_volta"></span> <br />
                                <input type="hidden" name="distancia_km_os" id="distancia_km_os" value="<?=$qtde_km;?>" />
                                <input type="hidden" name="distancia_km_conferencia" id="distancia_km_conferencia" value="<?=$qtde_km;?>" />
                                Distância: <input type='text' name='distancia_km' id='distancia_km' size='10' style="background-color: #fff;" value="<?=$qtde_km;?>" />
                                <input  type="button" onclick="calcRoute();" value="Calcular Distância" size='5' > <img id="loading-map" src="imagens/grid/loading.gif" style="display: none; width: 22px; vertical-align: middle;" >
                                <div id='div_mapa_msg' style='color:#FF0000'></div>
                                <br>
                                <div id='div_end_posto' style='color:#000000'>
                                    <B>Endereço do posto:</b>
                                    <u>
                                        <?if(strlen($endereco_posto)>0){
                                            echo $endereco_posto;
                                        }?>
                                    </u>
                                </div>
                            </div>
                            <div id="GoogleMapsContainer" style="display: none;">
                                <div style="margin-top: 5px; margin-left: 5px; float: right; z-index: 9999999; position: relative; background-color: white;" id="fechamapa" onclick="fechaMapa();"><img src="./admin/imagens/close_black_opaque.png" /></div>
                                <div id="GoogleMaps"></div>
                                <div id="DirectionPanel"></div>
                            </div>

                        </td>
                    <? }
                 } else if (in_array($login_fabrica, array(30,50)) && strlen(trim($qtde_km)) > 0) { ?>
                    <input type='hidden' name='distancia_km' id='distancia_km' size='10' value='<?= $qtde_km; ?>' />
                <? } ?>
            </tr>
        </table>
    <? }

    $aux_array = array("[", "]");
    $aux_defeitoLorenzetti = str_replace($aux_array, "", $defeitoLorenzetti);

    if($login_fabrica == 19 && verifica_checklist_tipo_atendimento($tipo_atendimento)) { //HD-2881143NEW

    	if(!empty($aux_defeitoLorenzetti)) {
            //somente essa funcionalidade para estes tipos de atendimento
            $codigo_tipo_atendimento_aceito = ["2","3","4","7","8","15","16","20"];

            $sqlTipo = "SELECT codigo
                          FROM tbl_tipo_atendimento 
                         WHERE fabrica = {$login_fabrica} 
                           AND tipo_atendimento = {$tipo_atendimento}";
            $resTipo = pg_query($con, $sqlTipo); 

            if (pg_num_rows($resTipo) > 0) {
                $codigoTipo = pg_fetch_result($resTipo, 0, 'codigo');

                if (in_array($codigoTipo, $codigo_tipo_atendimento_aceito)) {

                    $defeito_in = json_decode($defeitoLorenzetti,true);
                    $defeito_in = implode(',', $defeito_in);
                    $sql_list = "
                                 SELECT 
                                      tbl_checklist_fabrica.codigo,
                                      tbl_checklist_fabrica.descricao,
                                      tbl_checklist_fabrica.checklist_fabrica,
                                      tbl_os_defeito_reclamado_constatado.defeito_constatado,
                                      tbl_os_defeito_reclamado_constatado.defeito_reclamado,
                                      tbl_os_defeito_reclamado_constatado.checklist_fabrica AS checklist_loren
                                 FROM tbl_checklist_fabrica
                                 JOIN tbl_os_defeito_reclamado_constatado ON tbl_os_defeito_reclamado_constatado.checklist_fabrica = tbl_checklist_fabrica.checklist_fabrica
                                  AND tbl_os_defeito_reclamado_constatado.os = $os
                                WHERE tbl_checklist_fabrica.fabrica = $login_fabrica
                                  --AND tbl_checklist_fabrica.defeito_constatado IN ($defeito_in)
                                  AND tbl_checklist_fabrica.familia = $produto_familia
                                  AND tbl_os_defeito_reclamado_constatado.defeito_constatado IN ($defeito_in)";
                    $res_list = pg_query($con, $sql_list);
                    if(pg_num_rows($res_list) > 0){
                        $rows = pg_num_rows($res_list);

                        $selecionadosIDS  = [];
                        $selecionadosDESC = [];

                        for ($i=0; $i < $rows; $i++) {
                            $xdefeito_constatado = pg_fetch_result($res_list, $i, 'defeito_constatado');
                            $xdefeito_reclamado  = pg_fetch_result($res_list, $i, 'defeito_reclamado');
                            $checklist_fabrica   = pg_fetch_result($res_list, $i, 'checklist_fabrica');
                            $codigo              = pg_fetch_result($res_list, $i, 'codigo');
                            $descricao           = pg_fetch_result($res_list, $i, 'descricao');
             
                            $selecionadosIDS[$i]  = $checklist_fabrica;
                            $selecionadosDESC[$i] = $codigo.' - '. utf8_encode($descricao);

                        }

                        echo '
                        <script>
                            $(window).on("load", function() {
                                retornaCheckList(\''.json_encode($selecionadosIDS).'\', \''.json_encode($selecionadosDESC).'\', \''.$xdefeito_reclamado.'\', \''.$xdefeito_constatado.'\', true, "'.$os.'");
                            });
                        </script>
                        ';

                    }

                }

            }
    	}
    }
?>
<div id="t_checklist">
<?php
if ($login_fabrica == 19 && isset($_POST['check_list_fabrica']) && verifica_checklist_tipo_atendimento($tipo_atendimento)) { ?>
    <table id="checklist" class="formulario" width="700" cellspacing="0" cellpadding="1" border="1" align="center">
            <table width="700" align="center" id="checklist" border="1" cellspacing="0" cellpadding="1" class="formulario">
                <tbody>
                    <tr>
                        <td class="titulo_tabela" valign="middle" colspan="5">
                            <label style="margin:auto;font:14px Arial">Checklist:</label>
                        </td>
                    </tr>
                    <tr class="titulo_tabela_2"><td class="tal">Checklist</td><td width="10%">Ação</td></tr>
                    <tbody id="show">
                    <?php

                        foreach ($_POST['check_list_fabrica'] as $checkReclamado => $arrCheckConstatado) {

                            foreach ($arrCheckConstatado as $checkConstatado => $arrChecklistId) {

                                    foreach ($arrChecklistId as $checklistId) {

                                        $sqlDadosChecklist = "SELECT descricao,
                                                                     codigo
                                                              FROM tbl_checklist_fabrica
                                                              WHERE checklist_fabrica = {$checklistId}
                                                              AND fabrica = {$login_fabrica}";
                                        $resDadosChecklist = pg_query($con, $sqlDadosChecklist);

                                        $descricaoChecklist = pg_fetch_result($resDadosChecklist, 0, 'descricao');
                                        $codigoChecklist    = pg_fetch_result($resDadosChecklist, 0, 'codigo');

                                    ?>

                                        <tr class="t_checklist tr_check trchk-<?= $checklistId ?>">
                                            <td class="tal">
                                                <input type="hidden" class="check_list_fabrica" name="check_list_fabrica[<?= $checkReclamado ?>][<?= $checkConstatado ?>][]" value="<?= $checklistId ?>">
                                                <input type="checkbox" checked disabled name="check_list_fabrica_'<?= $checkReclamado ?>'_'<?= $checkConstatado ?>'_'<?= $checklistId ?>'"> <?= $codigoChecklist." - ".$descricaoChecklist ?>
                                            </td>
                                            <td>
                                                <button type="button" data-os="<?= $os ?>" data-constatado="<?= $checkConstatado ?>" data-reclamado="<?= $checkReclamado ?>" data-posicao="<?= $checklistId ?>" class="btn btn-delete btn-remove-item-checklist">Excluir</button>
                                            </td>
                                        </tr>    

                                <?php
                                }
                            }

                        } ?>
                    </tbody>
            </tbody>
        </table>
    </table>
<?php
} ?>
</div>
<?php
}
    if ($login_fabrica == 94) {

        $qtde_item = 100;
        $qtde_itens_mostrar = 20;
?>

        <table width="99.9%" border="0" cellspacing="0" cellpadding="0" >
            <tr>
                <td align="right" nowrap>
                    <font size="1" face="Geneva, Arial, Helvetica, san-serif">Qtde. Itens:</font><br>
                    <select name="n_itens" size="1" class="frm" onchange='javascript:mostrarLinhas(this.value);'><?php
                        for ($val = 20; $val <= $qtde_item; $val+=20) {
                            if ($val > $linhas_item)
                            {
                                echo "<option value='$val'>$val</option>\n";
                            }
                        }
                        ?>
                    </select>
                </td>
            </tr>
        </table><?php

    }

        ### LISTA ITENS DA OS QUE POSSUI PEDIDOS
        if (strlen($os) > 0) {
            if($login_fabrica == 50 OR $login_fabrica == 52){
                $condServico = " OR tbl_servico_realizado.peca_estoque IS TRUE ";
                $left = "LEFT ";
            }
            $sql = "SELECT  tbl_os_item.os_item                                 ,
                            tbl_os_item.pedido                                  ,
                            tbl_pedido.pedido_blackedecker  AS pedido_blackedecker,
                            tbl_os_item.qtde                                    ,
                            tbl_os_item.causa_defeito                           ,
                            tbl_peca.referencia                                 ,
                            tbl_peca.descricao                                  ,
                            tbl_peca.devolucao_obrigatoria                      ,
                            tbl_defeito.defeito                                 ,
                            tbl_defeito.descricao AS defeito_descricao          ,
                            tbl_causa_defeito.descricao AS causa_defeito_descricao,
                            tbl_produto.referencia AS subconjunto               ,
                            tbl_os_produto.produto                              ,
                            tbl_os_produto.serie                                ,
                            tbl_servico_realizado.servico_realizado             ,
                            tbl_servico_realizado.descricao AS servico_descricao,
                            tbl_os_item.peca_serie_trocada
                    FROM    tbl_os
                    JOIN   (SELECT os FROM tbl_os WHERE os = $os AND fabrica = $login_fabrica) oss ON tbl_os.os = oss.os
                    JOIN    tbl_os_produto             ON tbl_os.os = tbl_os_produto.os
                    JOIN    tbl_os_item                ON tbl_os_produto.os_produto = tbl_os_item.os_produto
                    JOIN    tbl_produto                ON tbl_os_produto.produto = tbl_produto.produto
                    JOIN    tbl_peca                   ON tbl_os_item.peca = tbl_peca.peca
                    JOIN    tbl_pedido                 ON tbl_os_item.pedido       = tbl_pedido.pedido
                    LEFT JOIN    tbl_defeito           USING (defeito)
                    LEFT JOIN    tbl_causa_defeito     ON tbl_os_item.causa_defeito = tbl_causa_defeito.causa_defeito
                    LEFT JOIN    tbl_servico_realizado USING (servico_realizado)
                    WHERE   tbl_os.os      = $os
                    AND     tbl_os.fabrica = $login_fabrica
                    AND     tbl_os_item.pedido NOTNULL
                    ORDER BY tbl_os_item.os_item ASC;";

            $res = pg_query($con,$sql) ;

            if(pg_num_rows($res) > 0) {

                echo "<table width='100%' border='0' cellspacing='2' cellpadding='0' class='tabela'>";
                echo "<tr height='20'>";
                $colspan = 4;
                if($informatica == 't' AND $login_fabrica != 127){
                    $colspan = 5;
                    echo "<INPUT TYPE='hidden' NAME='informatica' VALUE='t'>";
                }
                if ($login_fabrica == 51){
                    $colspan = 5;
                }
                echo "<td align='center' colspan='$colspan' class='titulo_coluna'>Pedidos enviados ao fabricante</td>";

                echo "</tr>";
                echo "<tr height='20' bgcolor='#666666'>";

                echo "<td align='center' class='titulo_coluna'>Pedido</td>";
                echo "<td align='center' class='titulo_coluna'>Referência</td>";
                echo "<td align='center' class='titulo_coluna'>Descrição</td>";
                echo "<td align='center' class='titulo_coluna'>Qtde</td>";
                if ($login_fabrica == 51){
                    echo "<td align='center' class='titulo_coluna'>Retornável</td>";
                }
                if($informatica == 't' AND $login_fabrica != 127){
                    echo "<td align='center' class='titulo_coluna'>N. Série Peça Trocada</td>";
                }

                echo "</tr>";

                $itemTemPedido = pg_num_rows($res);
                for ($i = 0 ; $i < pg_num_rows($res) ; $i++) {
                    $cor = ($i % 2) ? "#F7F5F0" : "#F1F4FA";
                    $faturado      = pg_num_rows($res);
                    $fat_pedido    = pg_fetch_result($res,$i,pedido);
                    $fat_pedido_blackedecker = pg_fetch_result($res,$i,pedido_blackedecker);
                    $fat_peca      = pg_fetch_result($res,$i,referencia);
                    $fat_descricao = pg_fetch_result($res,$i,descricao);
                    $fat_qtde      = pg_fetch_result($res,$i,qtde);

                    $peca_serie_trocadax = pg_fetch_result($res,$i,peca_serie_trocada);
                    $os_item       = pg_fetch_result($res,$i,os_item);

                    $devolucao_obrigatoria = pg_fetch_result($res,$i,devolucao_obrigatoria);

                    if ($devolucao_obrigatoria == "t"){
                        $devolucao_obrigatoria = "Sim";
                    }else{
                        $devolucao_obrigatoria = "Não";
                    }

                    echo "<tr height='20' bgcolor='$cor' style='text-align:justify;'>";

                    echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'>";
                    if ($login_fabrica == 1) {
                        echo $fat_pedido_blackedecker;
                    } else {
                        echo $fat_pedido;
                    }
                    echo "</font></td>";
                    echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'>$fat_peca</font></td>";
                    echo "<td align='left'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'>$fat_descricao</font></td>";
                    echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'>$fat_qtde</font></td>";

                    if ($login_fabrica == 51){
                        echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'>$devolucao_obrigatoria</font></td>";
                    }

                    //HD 38818 4/9/2008 ----------------------------
                    if($informatica == 't' AND $login_fabrica != 127){
                        echo "</td>";
                        echo "<td align='center'>";
                        echo "<INPUT TYPE='hidden' NAME='os_item_$i' id='os_item_$i' VALUE='$os_item'>";
                        ?>
                        <INPUT TYPE='text' NAME='peca_serie_trocada_<?=$i?>' id='peca_serie_trocada_<?=$i?>' value='<? echo $peca_serie_trocadax; ?>' size='13' maxlength='20' <? echo "onblur=\"javascript:atualizaserietrocada('os_item_$i','peca_serie_trocada_$i', $i)\""; ?> >
                        <div id='retorno_serie_<?=$i?>' style='position:absolute; display:none; border: 1px solid #949494;background-color: #F1F0E7;width:150px;'>
                        </div>
                        <?
                        echo "</td>";
                    }

                    echo "</tr>";
                }

                echo "</table>";

            }

        }

        //HD 745514 - Latinatec - lista OS's que fizeram baixa do estoque (tbl_servico_realizado.peca_estoque = true)
        if (($login_fabrica == 15 or $login_fabrica == 50 or $login_fabrica == 52) and strlen($os) > 0) {

            $sql = "SELECT
                        tbl_os_item.peca,
                        tbl_estoque_posto_movimento.qtde_saida,
                        tbl_peca.referencia,
                        tbl_peca.descricao,
                        tbl_servico_realizado.descricao as servico_realizado

                    FROM tbl_os

                    JOIN tbl_os_produto         on (tbl_os.os = tbl_os_produto.os and tbl_os.produto = tbl_os_produto.produto and tbl_os.fabrica=$login_fabrica)
                    JOIN tbl_os_item            on (tbl_os_produto.os_produto = tbl_os_item.os_produto)
                    JOIN tbl_servico_realizado  on (tbl_os_item.servico_realizado = tbl_servico_realizado.servico_realizado)
                    JOIN tbl_peca               on (tbl_os_item.peca = tbl_peca.peca)
                    JOIN tbl_estoque_posto_movimento on (tbl_os_item.peca = tbl_estoque_posto_movimento.peca and tbl_os.os = tbl_estoque_posto_movimento.os and tbl_os.posto = tbl_estoque_posto_movimento.posto)

                    WHERE tbl_os.fabrica = $login_fabrica
                    AND tbl_os.os = $os
                    AND tbl_os_item.pedido is null
                    AND (tbl_estoque_posto_movimento.qtde_saida > 0 and tbl_estoque_posto_movimento.qtde_entrada is null)
                    AND tbl_estoque_posto_movimento.fabrica = $login_fabrica
                    AND tbl_servico_realizado.peca_estoque is true

                    ";
            $res = pg_query($con,$sql);

            if (pg_num_rows($res) > 0) { ?>
            <table class="tabela" cellpadding="0" cellspacing="2" width="100%" border="0">
                <tr class='titulo_tabela'>
                    <td colspan="4">
                        Peças com Troca do Estoque Interno
                    </td>
                </tr>
                <tr class='titulo_coluna'>
                    <td>Referência</td>
                    <td>Descricao</td>
                    <td>Qtde.</td>
                    <td>Serviço Realizado</td>
                </tr><?php
                for ($i = 0; $i < pg_num_rows($res); $i++){

                    $cor = ($i % 2) ? "#F1F4FA" : "#F7F5F0";

                    $troca_peca                 = pg_result($res,$i,'peca');
                    $troca_qtde_saida           = pg_result($res,$i,'qtde_saida');
                    $troca_referencia           = pg_result($res,$i,'referencia');
                    $troca_descricao            = pg_result($res,$i,'descricao');
                    $troca_servico_realizado    = pg_result($res,$i,'servico_realizado');
                ?>
                    <tr bgcolor="<?echo $cor?>">
                        <td>
                            <?echo $troca_referencia ?>
                        </td>

                        <td>
                            <?echo $troca_descricao ?>
                        </td>

                        <td>
                            <?echo $troca_qtde_saida ?>
                        </td>

                        <td>
                            <?echo $troca_servico_realizado ?>
                        </td>
                    </tr><?php
                }?>

            </table>
            <br /><?php
            }
        }

        ### LISTA ITENS DA OS QUE ESTÃO COMO NÃO LIBERADAS PARA PEDIDO EM GARANTIA
        if (strlen($os) > 0){
            $sql = "SELECT  tbl_os_item.os_item                                 ,
                            tbl_os_item.obs                                     ,
                            tbl_os_item.qtde                                    ,
                            tbl_peca.referencia                                 ,
                            tbl_peca.descricao                                  ,
                            tbl_defeito.defeito                                 ,
                            tbl_defeito.descricao AS defeito_descricao          ,
                            tbl_produto.referencia AS subconjunto               ,
                            tbl_os_produto.produto                              ,
                            tbl_os_produto.serie                                ,
                            tbl_servico_realizado.servico_realizado             ,
                            tbl_servico_realizado.descricao AS servico_descricao
                    FROM    tbl_os
                    JOIN   (SELECT os FROM tbl_os WHERE os = $os AND fabrica = $login_fabrica) oss ON tbl_os.os = oss.os
                    JOIN    tbl_os_produto             ON tbl_os.os = tbl_os_produto.os
                    JOIN    tbl_os_item                ON tbl_os_produto.os_produto = tbl_os_item.os_produto
                    JOIN    tbl_produto                ON tbl_os_produto.produto = tbl_produto.produto
                    JOIN    tbl_peca                   ON tbl_os_item.peca = tbl_peca.peca
                    LEFT JOIN    tbl_pedido            ON tbl_os_item.pedido       = tbl_pedido.pedido
                    LEFT JOIN    tbl_defeito           USING (defeito)
                    LEFT JOIN    tbl_servico_realizado USING (servico_realizado)
                    WHERE   tbl_os.os      = $os
                    AND     tbl_os.fabrica = $login_fabrica
                    AND     tbl_os_item.liberacao_pedido           IS FALSE
                    AND     tbl_os_item.liberacao_pedido_analisado IS TRUE
                    ORDER BY tbl_os_item.os_item ASC;";
            $res = pg_query($con,$sql) ;

            $sqlOrcamento = "SELECT tbl_orcamento_item.orcamento_item           ,
                            tbl_orcamento_item.qtde                             ,
                            tbl_peca.referencia                                 ,
                            tbl_peca.descricao                                  ,
                            tbl_produto.referencia AS subconjunto               ,
                            tbl_os.produto                                      ,
                            tbl_os.serie                                        ,
                            tbl_orcamento_item.pedido                           ,
                            tbl_servico_realizado.servico_realizado             ,
                            tbl_servico_realizado.descricao AS servico_descricao
                    FROM    tbl_os
                    JOIN   (SELECT os FROM tbl_os WHERE os = $os AND fabrica = $login_fabrica) oss ON tbl_os.os = oss.os
                    JOIN    tbl_orcamento              ON tbl_orcamento.os = tbl_os.os
                    JOIN    tbl_orcamento_item         ON tbl_orcamento_item.orcamento = tbl_orcamento.orcamento
                    JOIN    tbl_produto                ON tbl_os.produto = tbl_produto.produto
                    JOIN    tbl_peca                   ON tbl_orcamento_item.peca   = tbl_peca.peca
                    LEFT JOIN    tbl_pedido            ON tbl_orcamento_item.pedido = tbl_pedido.pedido
                    LEFT JOIN    tbl_servico_realizado USING (servico_realizado)
                    WHERE   tbl_os.os      = $os
                    AND     tbl_os.fabrica = $login_fabrica
                    AND     tbl_orcamento_item.pedido           NOTNULL
                    ORDER BY tbl_orcamento_item.orcamento_item ASC;";
            $resOrca = pg_query($con,$sqlOrcamento) ;

            if(pg_num_rows($res) > 0 OR pg_num_rows($resOrca) > 0) {
                $col = 4;
                if($login_fabrica == 14){ $col = 5; }
                echo "<table width='100%' border='3' cellspacing='2' cellpadding='0'>\n";
                echo "<tr height='20' bgcolor='#666666'>\n";

                if ($login_fabrica <> 6) {
                    echo "<td align='center' colspan='$col'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#ffffff'><b>Peças que não irão gerar pedido em garantia </b></font></td>\n";
                }else{
                    echo "<td align='center' colspan='$col'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#ffffff'><b>Peças pendentes</b></font></td>\n";
                }

                echo "</tr>\n";
                echo "<tr height='20' bgcolor='#666666'>\n";

                echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#ffffff'><b>Pedido</b></font></td>\n";
                echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#ffffff'><b>Referência</b></font></td>\n";
                echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#ffffff'><b>Descrição</b></font></td>\n";
                echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#ffffff'><b>Qtde</b></font></td>\n";
                if($login_fabrica == 14){ echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#ffffff'><b>Excluir</b></font></td>\n";    }
                echo "</tr>\n";

                for ($i = 0 ; $i < pg_num_rows($res) ; $i++) {
                    $recusado      = pg_num_rows($res);
                    $rec_item      = pg_fetch_result($res,$i,os_item);
                    $rec_obs       = pg_fetch_result($res,$i,obs);
                    $rec_peca      = pg_fetch_result($res,$i,referencia);
                    $rec_descricao = pg_fetch_result($res,$i,descricao);
                    $rec_qtde      = pg_fetch_result($res,$i,qtde);

                    echo "<tr height='20' bgcolor='#FFFFFF'>";
                    echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'>$rec_obs</font></td>\n";
                    echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'>$rec_peca</font></td>\n";
                    echo "<td align='left'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'>$rec_descricao</font></td>\n";
                    echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'>$rec_qtde</font></td>\n";
                    if($login_fabrica == 14){
                        echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'><a href='$php_self?os=$os&os_item=$rec_item'><IMG SRC=\"imagens/btn_excluir.gif\" ALT=\"Excluir\"></font></a></td>";
                    }
                    echo "</tr>\n";
                }

                for ($i = 0 ; $i < pg_num_rows($resOrca) ; $i++) {
                        $recusado      = pg_num_rows($resOrca);
                        $rec_item      = pg_fetch_result($resOrca,$i,orcamento_item);
                        $rec_peca      = pg_fetch_result($resOrca,$i,referencia);
                        $rec_pedido    = pg_fetch_result($resOrca,$i,pedido);
                        $rec_descricao = pg_fetch_result($resOrca,$i,descricao);
                        $rec_qtde      = pg_fetch_result($resOrca,$i,qtde);

                        echo "<tr height='20' bgcolor='#FFFFFF'>";

                        echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'>$rec_pedido</font></td>\n";
                        echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'>$rec_peca</font></td>\n";
                        echo "<td align='left'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'>$rec_descricao</font></td>\n";
                        echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'>$rec_qtde</font></td>\n";

                        echo "</tr>\n";
                }
                echo "</table>\n";
            }
        }

        ### LISTA ITENS DA OS FORAM LIBERADAS E AINDA NÃO POSSEM PEDIDO
        if (strlen($os) > 0){
            $sql = "SELECT  tbl_os_item.os_item                                 ,
                            tbl_os_item.obs                                     ,
                            tbl_os_item.qtde                                    ,
                            tbl_peca.referencia                                 ,
                            tbl_peca.descricao                                  ,
                            tbl_defeito.defeito                                 ,
                            tbl_defeito.descricao AS defeito_descricao          ,
                            tbl_produto.referencia AS subconjunto               ,
                            tbl_os_produto.produto                              ,
                            tbl_os_produto.serie                                ,
                            tbl_servico_realizado.servico_realizado             ,
                            tbl_servico_realizado.descricao AS servico_descricao
                            ,peca_reposicao_estoque,
                            aguardando_peca_reparo
                    FROM    tbl_os
                    JOIN   (SELECT os FROM tbl_os WHERE os = $os AND fabrica = $login_fabrica) oss ON tbl_os.os = oss.os
                    JOIN    tbl_os_produto             ON tbl_os.os = tbl_os_produto.os
                    JOIN    tbl_os_item                ON tbl_os_produto.os_produto = tbl_os_item.os_produto
                    JOIN    tbl_produto                ON tbl_os_produto.produto = tbl_produto.produto
                    JOIN    tbl_peca                   ON tbl_os_item.peca = tbl_peca.peca
                    LEFT JOIN    tbl_pedido            ON tbl_os_item.pedido       = tbl_pedido.pedido
                    LEFT JOIN    tbl_defeito           USING (defeito)
                    LEFT JOIN    tbl_servico_realizado USING (servico_realizado)
                    WHERE   tbl_os.os      = $os
                    AND     tbl_os.fabrica = $login_fabrica
                    AND     tbl_os_item.pedido           ISNULL
                    AND     tbl_os_item.liberacao_pedido IS TRUE
                    ORDER BY tbl_os_item.os_item ASC;";
            $res = pg_query($con,$sql) ;

            if(pg_num_rows($res) > 0) {
                echo "<table width='70%' border='0' cellspacing='2' cellpadding='0'>\n";
                echo "<tr height='20' bgcolor='#666666'>\n";

                echo "<td align='center' colspan='$col'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#ffffff'><b>Peças aprovadas aguardando pedido</b></font></td>\n";

                echo "</tr>\n";
                echo "<tr height='20' bgcolor='#666666'>\n";

                echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#ffffff'><b>Pedido</b></font></td>\n";
                echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#ffffff'><b>Referência</b></font></td>\n";
                echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#ffffff'><b>Descrição</b></font></td>\n";
                echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#ffffff'><b>Qtde</b></font></td>\n";

                echo "</tr>\n";

                for ($i = 0 ; $i < pg_num_rows($res) ; $i++) {
                        $recusado      = pg_num_rows($res);
                        $rec_item      = pg_fetch_result($res,$i,os_item);
                        $rec_peca      = pg_fetch_result($res,$i,referencia);
                        $rec_descricao = pg_fetch_result($res,$i,descricao);
                        $rec_qtde      = pg_fetch_result($res,$i,qtde);

                        echo "<tr height='20' bgcolor='#FFFFFF'>";

                        echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'>$rec_obs</font></td>\n";
                        echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'>$rec_peca</font></td>\n";
                        echo "<td align='left'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'>$rec_descricao</font></td>\n";
                        echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#000000'>$rec_qtde</font></td>\n";

                        echo "</tr>\n";
                }
                echo "</table>\n";
            }
        }

        if (strlen($os) > 0 AND strlen($msg_erro) == 0){
            if ($os_item_aparencia == 't' AND $posto_item_aparencia == 't' and $os_item_subconjunto == 'f') {
                $sql = "SELECT  tbl_peca.peca
                        FROM    tbl_peca
                        JOIN    tbl_lista_basica USING (peca)
                        JOIN    tbl_produto      ON tbl_produto.produto = tbl_lista_basica.produto
                        WHERE   tbl_produto.produto     = $produto_os
                        AND     tbl_peca.fabrica        = $login_fabrica
                        AND     tbl_peca.item_aparencia = 't'
                        ORDER BY tbl_peca.referencia;";
                $resX = pg_query($con,$sql);
                $inicio_itens = pg_num_rows($resX);
            }else{
                $inicio_itens = 0;
            }

            //HD 745514 - var para usar na SQL abaixo para nao pegar itens que tenham peças com serviço de troca do estoque interno
            if ($login_fabrica == 15 or $login_fabrica == 50){

                $estoque_latinatec = " AND (tbl_servico_realizado.peca_estoque is null or tbl_servico_realizado.peca_estoque is false) ";

            }

            if($login_fabrica == 35){
                $campos_cadence = " tbl_servico_realizado.peca_estoque,
            tbl_servico_realizado.troca_de_peca, ";
            }

            $sql = "SELECT  tbl_os_item.os_item,
                            tbl_os_item.pedido,
                            tbl_os_item.qtde,
                            tbl_os_item.causa_defeito,
                            tbl_os_item.posicao,
                            tbl_os_item.admin as admin_peca,
                            tbl_os_item.peca_serie,
                            tbl_os_item.peca_serie_trocada,
                            tbl_os_item.fornecedor,
                            tbl_os_item.obs,
                            tbl_peca.referencia,
                            tbl_peca.descricao,
                            tbl_defeito.defeito,
                            tbl_defeito.descricao AS defeito_descricao,
                            tbl_causa_defeito.descricao AS causa_defeito_descricao,
                            tbl_produto.referencia AS subconjunto,
                            tbl_os_produto.os_produto,
                            tbl_os_produto.produto,
                            tbl_os_produto.serie,
                            tbl_servico_realizado.servico_realizado,
                            $campos_cadence
                            tbl_servico_realizado.descricao AS servico_descricao,
                            tbl_os_item.peca_reposicao_estoque,
                            tbl_os_item.aguardando_peca_reparo,
                            tbl_peca.parametros_adicionais as peca_pa,
                            tbl_os_item.parametros_adicionais as os_item_pa,
                            tbl_peca.promocao_site
                    FROM    tbl_os
                    JOIN   (SELECT os FROM tbl_os WHERE os = $os AND fabrica = $login_fabrica) oss ON tbl_os.os = oss.os
                    JOIN    tbl_os_produto             ON tbl_os.os = tbl_os_produto.os
                    JOIN    tbl_os_item                ON tbl_os_produto.os_produto = tbl_os_item.os_produto
                    JOIN    tbl_produto                ON tbl_os_produto.produto = tbl_produto.produto
                    JOIN    tbl_peca                   ON tbl_os_item.peca = tbl_peca.peca
                    LEFT JOIN    tbl_pedido                 ON tbl_os_item.pedido       = tbl_pedido.pedido
                    LEFT JOIN    tbl_defeito           USING (defeito)
                    LEFT JOIN    tbl_causa_defeito     ON tbl_os_item.causa_defeito = tbl_causa_defeito.causa_defeito
                    LEFT JOIN    tbl_servico_realizado USING (servico_realizado)
                    WHERE   tbl_os.os      = $os
                    AND     tbl_os.fabrica = $login_fabrica
                    AND     tbl_os_item.pedido           ISNULL
                    AND     tbl_os_item.liberacao_pedido IS FALSE
                    $estoque_latinatec
                    ORDER BY tbl_os_item.os_item;";
            $res = pg_query($con,$sql) ;
            $fim_itens = 0;
            if (pg_num_rows($res) > 0) {
                $fim_itens = $inicio_itens + pg_num_rows($res);
                //$qtde_item = $qtde_item + $inicio_itens ;

                $i = 0;
                //hd 44118 - tem que zerar a variável, senão o php não entende que é um array, pois já foi usada anteriormente variável com este nome
                // MLG - apaga a variável da memória
                unset($os_item);
                $qtde = array();
                $descricao = array();
                for ($k = $inicio_itens ; $k < $fim_itens ; $k++) {
                    $os_item[$k]                 = pg_fetch_result($res,$i,os_item);
                    $os_produto[$k]              = pg_fetch_result($res,$i,os_produto);
                    $pedido[$k]                  = pg_fetch_result($res,$i,pedido);
                    $peca[$k]                    = pg_fetch_result($res,$i,referencia);
                    $qtde[$k]                    = pg_fetch_result($res,$i,qtde);
                    $produto[$k]                 = pg_fetch_result($res,$i,subconjunto);
                    $serie[$k]                   = pg_fetch_result($res,$i,serie);
                    $posicao[$k]                 = pg_fetch_result($res,$i,posicao);
                    $descricao[$k]               = pg_fetch_result($res,$i,descricao);
                    $defeito[$k]                 = pg_fetch_result($res,$i,defeito);
                    $pcausa_defeito[$k]          = pg_fetch_result($res,$i,causa_defeito);
                    $causa_defeito_descricao[$k] = pg_fetch_result($res,$i,causa_defeito_descricao);
                    $defeito_descricao[$k]       = pg_fetch_result($res,$i,defeito_descricao);
                    $servico[$k]                 = pg_fetch_result($res,$i,servico_realizado);

                    if($login_fabrica == 35){
                        $peca_estoque[$k]               = pg_fetch_result($res,$i,peca_estoque);
                        $troca_de_peca[$k]              = pg_fetch_result($res,$i,troca_de_peca);
                    }


                    $peca_serie[$k]              = pg_fetch_result($res,$i,peca_serie);
                    $peca_serie_trocada[$k]      = pg_fetch_result($res,$i,peca_serie_trocada);
                    $servico_descricao[$k]       = pg_fetch_result($res,$i,servico_descricao);
                    $admin_peca[$k]              = pg_fetch_result($res,$i,admin_peca);
                    if (strlen($admin_peca[$k])==0) { $admin_peca[$k]="P"; }
                    $peca_reposicao_estoque[$k]  = pg_fetch_result($res,$i,peca_reposicao_estoque);
                    $aguardando_peca_reparo[$k]  = pg_fetch_result($res,$i,aguardando_peca_reparo);

                    if (in_array($login_fabrica,array(3,30,35,91))) {
                        $pa = pg_result($res, $i, "peca_pa");
                        $pa = json_decode($pa, true);

                        if (in_array($login_fabrica, array(30))) {
                            $obs_os_item[$k] = pg_fetch_result($res, $i, obs);
                        }

                        $kit_peca[$i] = $pa["kit_peca"];
                        if($login_fabrica == 91){
                            $fornecedor[$i] = pg_fetch_result($res,$i,fornecedor);
                        }
                    }

                    if ($login_fabrica == 35) {
                        $po_peca_usa[$i] = pg_fetch_result($res, $i, "promocao_site");

                        if($po_peca_usa[$i] == "t"){
                            $parametros_adicionais = pg_fetch_result($res, $i, os_item_pa);
                            $parametros_adicionais = json_decode($parametros_adicionais, true);
                            $po_peca[$i] = $parametros_adicionais['po_peca'];
                        }
                    }

                    if ($login_fabrica == 24) {
                        $osItem_pa = pg_fetch_result($res, $i, "os_item_pa");
                        $osItem_pa = json_decode($osItem_pa, true);

                        $excluida_auditoria[$k] = (isset($osItem_pa['excluida_auditoria'])) ? "sim" : "";
                    }

                    if ($login_fabrica == 3) {
                        $txt_serial_lcd[$i] = $peca_serie[$k];

                        $peca_pa = pg_fetch_result($res, $i, "peca_pa");
                        $peca_pa = json_decode($peca_pa, true);

                        $serial_lcd[$k] = $peca_pa["serial_lcd"];

                        if ($peca_pa["upload_fotos"] == "t") {
                            $qtde_fotos[$k] = $peca_pa["qtde_fotos"];
                        }

                        $os_item_pa = pg_fetch_result($res, $i, "os_item_pa");
                        $os_item_pa = json_decode($os_item_pa, true);

                        $item_foto_upload[$i] = $os_item_pa["item_foto_upload"];
                        $foto_upload[$i] = $os_item_pa["foto_upload"];
                    }

                    $i++;
                }
            }else{
                // HD 73196 - MLG - A variável tem que ser apagada também para esta iteração
                unset($os_item);
                for ($i = 0 ; $i < $qtde_item ; $i++) {
                    $os_item[$i]                = $_POST["os_item_"        . $i];
                    $orcamento_item[$i]         = $_POST["orcamento_item_" . $i];
                    $os_produto[$i]             = $_POST["os_produto_"     . $i];
                    $produto[$i]                = $_POST["produto_"        . $i];
                    $serie[$i]                  = $_POST["serie_"          . $i];
                    $posicao[$i]                = $_POST["posicao_"        . $i];
                    $peca[$i]                   = $_POST["peca_"           . $i];
                    $descricao[$i]              = $_POST["descricao_"      . $i];
                    $qtde[$i]                   = $_POST["qtde_"           . $i];
                    $defeito[$i]                = $_POST["defeito_"        . $i];
                    $pcausa_defeito[$i]         = $_POST["pcausa_defeito_" . $i];
                    $servico[$i]                = $_POST["servico_"        . $i];
                    $peca_serie[$i]             = $_POST["peca_serie_"     . $i];
                    $peca_serie_trocada[$i]     = $_POST["peca_serie_trocada_" . $i];
                    $admin_peca[$i]             = $_POST["admin_peca_"     . $i];
                    $peca_reposicao_estoque[$i] = $_POST["peca_reposicao_estoque_" . $i];
                    $aguardando_peca_reparo[$i] = $_POST["aguardando_peca_reparo_" . $i];
                    $qtde_estoque[$i]           = $_POST["qtde_estoque_"     . $i];

                    if (in_array($login_fabrica,array(3,30,91))) {
                        $kit_peca[$i] = $xkit_peca[$i] = $_POST["kit_kit_peca_" . $i];
                        if (in_array($login_fabrica, array(30))) {
                            $obs_os_item[$i] = $_POST["obs_os_item_".$i];
                        }
                        if($login_fabrica == 91){
                            $fornecedor[$i] = $_POST['fornecedor_'.$i];
                        }
                    }

                    if (strlen($peca[$i]) > 0 and empty($kit_peca[$i])) {
                        $sql = "SELECT  tbl_peca.referencia,
                                        tbl_peca.descricao
                                FROM    tbl_peca
                                WHERE   tbl_peca.fabrica    = $login_fabrica
                            AND     tbl_peca.referencia = '".$peca[$i]."';";
                        $resX = pg_query($con,$sql) ;

                        if (pg_num_rows($resX) > 0) {
                            $descricao[$i] = trim(pg_fetch_result($resX,0,descricao));
                        }
                    }

                    if (!empty($kit_peca[$i]) and (in_array($login_fabrica,array(3,30,91)))) {
                        $sql = "SELECT descricao
                                FROM tbl_kit_peca
                                WHERE fabrica = $login_fabrica
                                AND kit_peca = {$kit_peca[$i]}";
                        $resX = pg_query($con, $sql);

                        if (pg_num_rows($resX) > 0) {
                            $descricao[$i] = pg_fetch_result($resX, 0, "descricao");
                        }
                    }
                }
            }

            # Pega itens do Orçamento
            $sql = "SELECT  tbl_orcamento_item.orcamento_item                                  ,
                            tbl_orcamento_item.peca                                            ,
                            tbl_orcamento_item.qtde                                            ,
                            tbl_orcamento_item.preco                                           ,
                            tbl_orcamento_item.preco_venda                                     ,
                            tbl_orcamento_item.defeito                                         ,
                            tbl_orcamento_item.servico_realizado                               ,
                            tbl_peca.referencia                                                ,
                            tbl_peca.descricao                                                 ,
                            tbl_defeito.descricao                   AS defeito_descricao
                    FROM    tbl_orcamento
                    JOIN    tbl_orcamento_item         ON tbl_orcamento_item.orcamento = tbl_orcamento.orcamento
                    JOIN    tbl_peca                   ON tbl_peca.peca                = tbl_orcamento_item.peca
                    LEFT JOIN    tbl_defeito           ON tbl_defeito.defeito          = tbl_orcamento_item.defeito
                    WHERE   tbl_orcamento.os      = $os
                    AND     tbl_orcamento.empresa = $login_fabrica
                    AND     tbl_orcamento_item.pedido IS NULL
                    ORDER BY tbl_orcamento_item.orcamento_item;";
            $res = pg_query($con,$sql) ;

            if (pg_num_rows($res) > 0) {
                $qtde_itens_orcado = pg_num_rows($res);
                $i = 0;
                // HD 354997 - MLG - A variável tem que ser apagada também para esta iteração
                unset($os_item);
                for ($j = $fim_itens; $j < $fim_itens + $qtde_itens_orcado ; $j++) {

                    $orcamento_item[$j]          = trim(pg_fetch_result($res,$i,orcamento_item));
                    $os_item[$j]                 = "";
                    $os_produto[$j]              = "";
                    $pedido[$j]                  = "";
                    $peca[$j]                    = trim(pg_fetch_result($res,$i,referencia));
                    $qtde[$j]                    = trim(pg_fetch_result($res,$i,qtde));
                    $preco[$j]                   = trim(pg_fetch_result($res,$i,preco));
                    $preco_venda[$j]             = trim(pg_fetch_result($res,$i,preco_venda));
                    $produto[$j]                 = "";
                    $serie[$j]                   = "";
                    $posicao[$j]                 = "";
                    $descricao[$j]               = trim(pg_fetch_result($res,$i,descricao));
                    $defeito[$j]                 = trim(pg_fetch_result($res,$i,defeito));
                    $pcausa_defeito[$j]          = "";
                    $causa_defeito_descricao[$j] = "";
                    $defeito_descricao[$j]       = "";
                    $servico[$j]                 = trim(pg_fetch_result($res,$i,servico_realizado));
                    $servico_descricao[$j]       = "";
                    $admin_peca[$j]              = "";
                    if (strlen($admin_peca[$j])==0) { $admin_peca[$j]="P"; }
                    $i++;
                $preco[$j] = number_format($preco[$j],2,',','.');
                $preco_venda[$j] = number_format($preco_venda[$j],2,',','.');
                }
            }
        }else{
                       // HD 354997 - MLG - A variável tem que ser apagada também para esta iteração
        unset($os_item);
        unset($descricao);

            for ($i = 0 ; $i < $qtde_item ; $i++) {
                $os_item[$i]                         = $_POST["os_item_"            .$i];
                $orcamento_item[$i]                  = $_POST["orcamento_item_"     .$i];
                $os_produto[$i]                      = $_POST["os_produto_"         .$i];
                $produto[$i]                         = $_POST["produto_"            .$i];
                $serie[$i]                           = $_POST["serie_"              .$i];
                $posicao[$i]                         = $_POST["posicao_"            .$i];
                $peca[$i]                            = $_POST["peca_"               .$i];
                $qtde[$i]                            = $_POST["qtde_"               .$i];
                $defeito[$i]                         = $_POST["defeito_"            .$i];
                $pcausa_defeito[$i]                  = $_POST["pcausa_defeito_"     .$i];
                $servico[$i]                         = $_POST["servico_"            .$i];
                $peca_serie[$i]                      = $_POST["peca_serie_"         .$i];
                $descricao[$i]                       = $_POST['descricao_'          .$i];
                $xkit_peca[$i]                       = $_POST["kit_kit_peca_"       .$i];
                $xreparo_estoque[$i]                 = $_POST['reparo_estoque_'     .$i];
                $peca_serie_trocada[$i]              = $_POST["peca_serie_trocada_" .$i];
                $admin_peca[$i]                      = $_POST["admin_peca_"         .$i];

                if (in_array($login_fabrica,array(3,30,91))) {
                    $kit_peca[$i]  = $xkit_peca[$i]  = $_POST["kit_kit_peca_"       .$i];
                    if (in_array($login_fabrica, array(30))) {
                        $obs_os_item[$i]             = $_POST["obs_os_item_"        .$i];
                    }
                    if ($login_fabrica == 91) {
                        $fornecedor[$i]              = $_POST['fornecedor_'         .$i];
                    }
                }

                if ($login_fabrica == 3 && strlen($os_item[$i]) > 0) {
                    $sqlPA                           = "SELECT parametros_adicionais FROM tbl_os_item WHERE os_item = {$os_item[$i]}";
                    $resPA                           = pg_query($con, $sqlPA);

                    $os_item_pa                      = pg_fetch_result($resPA, 0, "parametros_adicionais");
                    $os_item_pa                      = json_decode($os_item_pa, true);

                    $item_foto_upload[$i]            = $os_item_pa["item_foto_upload"];
                    $foto_upload[$i]                 = $os_item_pa["foto_upload"];
                }

                if(in_array($login_fabrica,[120,201])){
                    $qtde_estoque[$i]                = $_POST["qtde_estoque_" .$i];
                }

                if ($login_fabrica == 24) {
                    if ($xreparo_estoque[$i] == "peca_reposicao_estoque") {
                        $peca_reposicao_estoque[$i]  = "t";
                    } else {
                        $peca_reposicao_estoque[$i]  = "f";
                    }

                    if ($xreparo_estoque[$i] == "aguardando_peca_reparo") {
                        $aguardando_peca_reparo[$i]  = "t";
                    } else {
                        $xaguardando_peca_reparo     = "f";
                    }
                }

                if (empty($peca[$i]) and empty($kit_peca[$i])) {
                    $sql = "SELECT  tbl_peca.referencia,
                                    tbl_peca.descricao
                            FROM    tbl_peca
                            WHERE   tbl_peca.fabrica    = $login_fabrica
                            AND     tbl_peca.referencia = '" .$peca[$i]."';";
                    $resX = pg_query($con,$sql);
                    if (pg_num_rows($resX) > 0) {
                        $descricao[$i]               = trim(pg_fetch_result($resX,0,descricao));
                    }
                }

                if (!empty($kit_peca[$i]) and (in_array($login_fabrica,array(3,30,91)))) {
                    $sql = "SELECT descricao
                            FROM tbl_kit_peca
                            WHERE fabrica = $login_fabrica
                            AND kit_peca = {$kit_peca[$i]}";
                    $resX = pg_query($con, $sql);

                    if (pg_num_rows($resX) > 0) {
                        $descricao[$i] = pg_fetch_result($resX, 0, "descricao");
                    }
                }
            }
        }
        if ($login_fabrica == 3 || $login_fabrica == 43) {//HD 255541

            echo "<table width='800px' border='0' cellspacing='1' cellpadding='2'>";
            echo "<tr height='10' bgcolor='#17203E' style='font: normal bold 13px Geneva, Arial, Helvetica, san-serif;'>";
            echo "<td align='center' style='color:#1ebb1e'>Apenas uma peça.<br>OS com pedido aprovado</td>";
            echo "<td align='center' style='color:#ffff00'>Duas peças.<br>OS e pedidos sujeitos a análise</td>";
            echo "<td align='center' style='color:#ff0000'>Três ou mais peças.<br>OS e pedidos sujeitos a auditoria</td>";
        }

        if ($login_fabrica == 3) {

            $objDataAbertura = new DateTime($data_aberturax);
            $objDataAtual    = new DateTime(date("Y-m-d"));

            $intervaloDatas = $objDataAbertura->diff($objDataAtual);

            $totalDiasAberto = $intervaloDatas->days;

            if ($totalDiasAberto > 30) {

                $hidePecas = "style='display: none;'";

            ?>
                <br />
                <div style="width: 700px;background-color: lightblue;color: darkblue;font-size: 16px;font-weight: bolder;">
                    <br />
                    Ordem de serviço aberta a mais de 30 dias, tempo de solicitação de peças esgotado! <br /><br />Favor solicitar peça via Help-desk, informando a justificativa da solicitação
                    <br /><br />
                </div>
                <br />
            <?php
            }

        }

        echo "<table width='100%' border='0' cellspacing='2' cellpadding='0' id='tablemostrar' {$hidePecas}>";

        echo "<tr height='30' class='titulo_coluna'>";

        if ($os_item_subconjunto == 't') {
            echo "<td align='center'><b>Subconjunto</b></td>";
        }

        if($login_fabrica == 56){
            echo "<td align='center'><b>N. Série</b></td>";
        }

        if ($os_item_serie == 't' AND $os_item_subconjunto == 't') {
            echo "<td align='center'><b>";
            if($login_fabrica==35){
                echo "PO#";
            }else{
                echo "N. Série";
            }
            echo "</b></font></td>";
        }

        #HD 132467
        if($login_fabrica==19){
            $sql ="select tipo_atendimento
            from tbl_os
            where os = $os";
            $res = pg_query($con, $sql);

            if(pg_num_rows($res)>0){
                $tipo_atendimento_x = pg_fetch_result($res,0,tipo_atendimento);
            }
        }

        if($login_fabrica==19 AND ($tipo_atendimento_x==34 OR $tipo_atendimento_x==19 OR $tipo_atendimento_x==33)){
            #HD 132467
            $block_item='DISABLED';
        }else{
            $block_item='';
        }

        if ($login_fabrica == 14) echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif' color='#ffffff'><b>Posição</b></font></td>";

        if ($login_fabrica == 15 || $login_fabrica == 24 || $login_fabrica == 91) {
            echo "<td align='center' style='width:30%;'><b>&nbsp; Descrição &nbsp;</b></td>";
        }else{
            echo "<td align='center' style='width:150px'><b>&nbsp; ".traduz('Código')." &nbsp;</b></td>";
        }
        if ($login_fabrica ==14) $link_suffix = "_subconjunto";
        $link_param = "?produto=$produto_os";
        if ($login_fabrica == 6) $link_param .= "&os=$os";
        if (!(in_array($login_fabrica, [141]) && $posto_interno)) {
            echo "<td align='center'>\n";
            if ( in_array($login_fabrica, array(11,172)) ) { // 19/01/2010 HD 192641 - Lenoxx não mostra lista básica do produto
                echo "<span style='color:white;font-size:10px'>Lista <br> Básica</span>\n";
            } else if($login_fabrica) {
                echo "<a href='peca_consulta_por_produto".$link_suffix.".php".$link_param."' ".
                     "title='".traduz('Clique para abrir a lista básica do produto')."' ".
                     "class='lnk' target='_blank'>".
                     "LISTA BÁSICA</a>\n";
            }
            echo "</td>\n";
        }

        if ($login_fabrica == 15 || $login_fabrica == 24 || $login_fabrica == 91) {
        $checa_todas = $_POST['checa_all_pre_peca'];
        $checked = (!empty($checa_todas)) ? ' checked ':'';
            echo "<td align='center'>";
        echo ($login_fabrica == 15 and in_array($login_posto,array(6359,10950,10952,20235,2405,5551,12008,11946,11467,10806,11958,11946,11471,11732,118825,359970,343192,393942))) ? "<input type='checkbox' onclick='javascript:allPrePeca()' name='checa_all_pre_peca' value='todas' $checked>":'';
        echo "<b>Código</b></td>";
        }else{
            if ($login_fabrica == 6) {
                $width_td_desc = "style='width: 280px;'";
            } else {
                $width_td_desc = "width='60'";
            }

            echo "<td align='center' $width_td_desc><b>".traduz('Descrição')."</b></td>";
        }
        if ($login_fabrica==30 && $controla_estoque == 't'){
            echo "<td align='center' style='width:75px'> Estoque </td>";
        }
        //HD 38818 4/9/2008 ----------------------------
        if($informatica == 't' AND $login_fabrica != 127){
            echo "<td align='center'><b>N. Série Peça</b></td>";
        }
        if ($pergunta_qtde_os_item == 't') {
            if ($login_fabrica == 6) {
                $width_qtde = "60px";
            } else {
                $width_qtde = "100px";
            }
            echo "<td align='center' style='width: $width_qtde; '><b>Qtde</b></td>";
        }

        if ($pedir_causa_defeito_os_item == 't' AND $login_fabrica<>20) {
            echo "<td align='center'><b>Causa</b></td>";
        }
    if($login_fabrica == 91){
?>
        <td style="text-align:center;font-weight:bold;">Fornecedor da peça no produto</td>
<?
    }
    if((!in_array($login_fabrica,array(96,95)) and !$fabricas_padrao_itens && $login_fabrica < 99) || in_array($login_fabrica, array(106,120,201,172)) ){
        echo "<td align='center'><b>Defeito</b>";
        if($login_fabrica == 15 and  in_array($login_posto,array(6359,10950,10952,20235,2405,5551,12008,11946,11467,10806,11958,11946,11471,11732,118825,359970,343192,393942))){
            echo "<br/><select class='frm' onChange='javascript:allPreDefeito(this.value)' style='width:170px;'>";
            echo "<option></option>";
            $sql = "SELECT *
                        FROM   tbl_defeito
                        WHERE  tbl_defeito.fabrica = $login_fabrica
                        AND    tbl_defeito.ativo IS TRUE
                        ORDER BY descricao ";
            $zres = pg_query($con,$sql);
            if(pg_num_rows($zres)>0){
                $contar_zres = pg_num_rows($zres);
                for($z=0;$contar_zres>$z;$z++){
                    $zdefeito   = pg_fetch_result($zres,$z,defeito);
                    $zdescricao = pg_fetch_result($zres,$z,descricao);
                    echo "<option value='$zdefeito'>$zdescricao</option>";
                }
            }
            echo "</select>";
        }
        echo "</td>";
    }
        echo "<td align='center'><b>";
        echo ($login_fabrica == 96)?"Free of charge":traduz("Serviço"); # HD 390996
        echo "</b></td>";

        //HD 38818 4/9/2008 ----------------------------
        if($informatica == 't' AND $login_fabrica != 127){
            echo "<td align='center' colspan='2'><b>N. Série Peça Trocada</b></td>";
        }
        //---------------------

        echo "</tr>";

if ($login_fabrica==6 or ($login_fabrica == 15 and in_array($login_posto, array(6359,10950,10952,20235,2405,5551,12008,11946,11467,10806,11958,11946,11471,11732,118825,359970,343192,393942)) and $consumidor_revenda == 'R')){
/*HD 2599, 15180, 11/12/2009-HD 183336*/
    if($login_fabrica==6){
    $sql = "SELECT tbl_peca.peca, tbl_peca.referencia, tbl_peca.descricao, tbl_lista_basica.qtde
            , tbl_lista_basica.serie_inicial, tbl_lista_basica.serie_final, ' ' as produto_serie_inicial, ' ' as  produto_serie_final
            FROM  tbl_lista_basica
            JOIN  tbl_peca using(peca)
            WHERE tbl_lista_basica.fabrica = $login_fabrica
            AND   tbl_lista_basica.produto = $produto_os
            AND   tbl_peca.item_aparencia  = 'f'
            AND   tbl_peca.pre_selecionada = 't'
            ORDER by tbl_peca.referencia; ";
    }else{
        //  14/01/2010 HD 189523 - Lista básica não filtra por $serie[1]
        //HD 196225: Mudar ordenação da lista básica para OS de revenda
        $sql = "SELECT produto FROM tbl_os WHERE os = $os";
        $res = pg_query($con,$sql);
        $produto_id = pg_result($res,0,0);
        //HD 671900
        $sin = "";
        $sout = "";
        if ($login_fabrica == 15) {
            $sql_in = "tbl_kit_peca_produto.serie_inicial, ";
            $sql_out = "tbl_kit_peca_produto.serie_final, ";

        }

        $sql = "SELECT tbl_kit_peca.referencia,
                       tbl_kit_peca.descricao,
                       $sql_in
                       $sql_out
                       tbl_kit_peca.kit_peca
                FROM tbl_kit_peca
                JOIN tbl_kit_peca_produto ON tbl_kit_peca_produto.kit_peca = tbl_kit_peca.kit_peca
                WHERE tbl_kit_peca_produto.fabrica = $login_fabrica
                AND tbl_kit_peca_produto.produto = $produto_id
                ORDER BY tbl_kit_peca.descricao"; //die;
        $res = pg_query($con,$sql);
        $total_kit = pg_num_rows($res);
        for($i=0;$i < $total_kit;$i++) {

            $cor = ($i % 2) ? "#F1F4FA" : "#F7F5F0";
            $kit_peca_id    = pg_fetch_result($res,$i,'kit_peca');
            $descricao_kit  = pg_fetch_result($res,$i,'descricao');
            $referencia_kit = pg_fetch_result($res,$i,'referencia');
            if ($login_fabrica == 15) {
                $s_in = pg_fetch_result($res,$i,'serie_inicial');
                $s_out =  pg_fetch_result($res,$i,'serie_final');
            }
            $check_kit =  (isset($_POST['pre_kit_' . $i])) ? 'checked' : '';
            if ($login_fabrica == 15 && !valida_kit_latinatec($produto_serie, $s_in, $s_out)) {
                continue;
            } else {
                echo "<tr bgcolor='$cor'>";
                    echo "<td style='font-size:9px;' colspan='2'>$referencia_kit - " . $descricao_kit . "</td>";
                    echo "<td align='center'>
                            <input type='checkbox' $check_kit name='pre_kit_$i' value='$kit_peca_id' /> &nbsp;<font size='-2' color='#000000' face='arial'> $referencia_kit </font>";
                    echo '  <input type="hidden" name="pre_total_kit" value="'.$total_kit.'" />
                            <input type="hidden" name="descricao_kit_'.$i.'" value="'.$descricao_kit.'" />
                          </td>
                          <td align="center">';
                                echo "<select name='pre_defeito_kit_$i' class='frm' style='width:170px;'>";
                                    echo "<option></option>";
                                    $sql = "SELECT defeito,descricao
                                            FROM   tbl_defeito
                                            WHERE  tbl_defeito.fabrica = $login_fabrica
                                            AND    tbl_defeito.ativo IS TRUE
                                            ORDER BY descricao ";
                                    $zres = pg_query($con,$sql);
                                    if(pg_num_rows($zres)>0){
                                        $contar_Zres_0 = pg_num_rows($zres);
                                        for($z=0;$contar_Zres_0>$z;$z++){
                                            $zdefeito   = pg_fetch_result($zres,$z,defeito);
                                            $zdescricao = pg_fetch_result($zres,$z,descricao);

                                            $opt_sel = ($_POST['pre_defeito_kit_' . $i] == $zdefeito)?" SELECTED":"";
                                            echo "<option value='$zdefeito'$opt_sel>$zdescricao</option>";
                                        }
                                    }
                    echo '      </select>
                        </td>
                        <td align="center">';
                        echo "<select class='frm' size='1' name='pre_servico_kit_$i'  style='width:200px;'>";
                            echo "<option value=''>Selecione Serviço</option>";
                            $sql = "SELECT servico_realizado, descricao
                                    FROM tbl_servico_realizado
                                    WHERE tbl_servico_realizado.fabrica = $login_fabrica
                                    AND tbl_servico_realizado.ativo IS TRUE
                                    ORDER BY descricao desc";

                            $zres = pg_query($con,$sql);
                            if(pg_num_rows($zres)>0){
                                $contar_Zres_1 = pg_num_rows($zres);
                                for($z=0;$contar_Zres_1>$z;$z++){
                                    $zservico_realizado   = pg_fetch_result($zres,$z,servico_realizado);
                                    $zdescricao = pg_fetch_result($zres,$z,descricao);

                                    $opt_sel = ($_POST['pre_servico_kit_' . $i] == $zservico_realizado)?" SELECTED":"";
                                    echo "<option value='$zservico_realizado'$opt_sel>$zdescricao</option>";

                                }
                            }
                echo "      </select>
                        </td>
                </tr>";

                $sql2 = "SELECT descricao, qtde
                         FROM tbl_kit_peca_peca
                         JOIN tbl_peca USING (peca)
                         WHERE kit_peca = " . $kit_peca_id;
                $res2 = pg_query($con,$sql2);
                $contador_res2 = pg_num_rows($res2);
                for($j = 0; $j < $contador_res2; $j++) {

                    $desc_peca_kit = pg_result($res2,$j,0);
                    $qtde_peca_kit = pg_result($res2,$j,1);

                    echo '
                        <tr bgcolor='.$cor.'>
                            <td  colspan="5" style="font-size:9px;"><input type="text" size="3" readonly name="qtde_peca_kit" value="'.$qtde_peca_kit.'" />  '.$desc_peca_kit.'</td>
                        </tr>
                    ';

                }
            }

        }

        $sql = "SELECT tbl_peca.peca, tbl_peca.referencia, tbl_peca.descricao, tbl_lista_basica.qtde,
                tbl_lista_basica.serie_inicial, tbl_lista_basica.serie_final,
                tbl_produto.serie_inicial AS produto_serie_inicial, tbl_produto.serie_final AS produto_serie_final, tbl_lista_basica.somente_kit
                FROM tbl_lista_basica
                JOIN tbl_peca     USING(peca)
                JOIN tbl_produto ON tbl_produto.produto = tbl_lista_basica.produto
                WHERE tbl_lista_basica.fabrica = $login_fabrica
                AND   tbl_lista_basica.produto = $produto_os
                ORDER by tbl_peca.descricao; ";
    }
    $res = pg_query($con,$sql);
    $lbm_itens = pg_num_rows($res);
    if($lbm_itens>0){

        for($x=0; $lbm_itens>$x; $x++){
            $ypeca_referencia        = pg_fetch_result($res,$x,referencia);
            $ypeca_descricao        = pg_fetch_result($res,$x,descricao);
            $yqtde                    = pg_fetch_result($res,$x,qtde);
            $ypeca                    = pg_fetch_result($res,$x,peca);
            $l_serie_inicial        = pg_fetch_result($res,$x,serie_inicial);
            $l_serie_final            = pg_fetch_result($res,$x,serie_final);
            $p_serie_inicial        = pg_fetch_result($res,$x,produto_serie_inicial);
            $p_serie_final            = pg_fetch_result($res,$x,produto_serie_final);
            if($login_fabrica == 15)
                $somente_kit = pg_fetch_result($res,$x,somente_kit);

            $sql_depara = "SELECT para FROM tbl_depara WHERE de='$ypeca_referencia' AND fabrica=15";

            $res_depara = pg_query($con,$sql_depara);
            $para_itens = pg_num_rows($res_depara);
            if ($para_itens > 0 ){
                $para = pg_result($res_depara,0, para);
            }
//  14/01/2010 HD 189523 - Para a Latinatec -Não mostra as peças que não correspondem com a série/versão do produto
            if ($login_fabrica == 15) {
             //echo "$produto_serie,$p_serie_inicial,$p_serie_final,$l_serie_inicial,$l_serie_final"; die;
                unset($cor_fundo); #HD 335128 Cor de fundo caso a peça nao esteja na versao
                if (!valida_serie_latinatec($produto_serie,$l_serie_inicial,$l_serie_final))  $cor_fundo = '#FCC';#HD 335128 Cor de fundo caso a peça nao esteja na versao
            }
            $pre_peca_x_checked    = ($_POST["pre_peca_$x"]==$ypeca)?" CHECKED":"";
            $valor_pre_defeito_x= (isset($_POST["pre_defeito_$x"]))?$_POST["pre_defeito_$x"]:"";
            $valor_pre_servico_x= (isset($_POST["pre_servico_$x"]))?$_POST["pre_servico_$x"]:"";
            $cor = ($x % 2) ? "#F7F5F0" : "#F1F4FA";

            $cor = ($cor_fundo) ? $cor_fundo : $cor; #HD 335128 Cor de fundo caso a peça nao esteja na versao
            if ($cor == '#FCC'){
                echo " <tr style='background-color:$cor; cursor:help;'>" ;
            }else{
                echo "<tr style='background-color:$cor'>";
            }
            if($login_fabrica <> 15){
                echo "<td align='center' width='30%' ><input class='frm' type='checkbox' name='pre_peca_$x' value='$ypeca'>&nbsp;<font face='arial' size='-2' color='#000000'> $ypeca_referencia </font> ";
                echo "</td>";
            }else{

                if ($cor == '#FCC'){
                    echo "<td onmouseover=\"info(this,'Esta peça não pertence a versão do produto com o número de série $produto_serie')\"  onmouseout='fechar()'>
                        <font face='arial' size='-2' color='#000000'>$ypeca_descricao</font>";
                }else{
                echo "<td align='left'><font face='arial' size='-2' color='#000000'>$ypeca_descricao</font>";
                }
                if (strlen($para)>0) #HD 335128 CONDICAO DE - PARA
                {
                    echo "&nbsp;<font style='font: bold 12px Arial; color:#FF0000'>Mudou para $para</font>";

                }#HD 335128
                if($somente_kit == 't') // HD 671900
                    echo '&nbsp;<font style="font: bold 12px Arial; color:#FF0000">Somente Kit</font>';
                echo "</td>";
            }

            echo "<td width='60' align='center'></TD>";
            if($login_fabrica <> 15){
                echo "<td align='center'><font face='arial' size='-2' color='#000000'>$ypeca_descricao</font></td>\n";
            }else{
                if (strlen($para)>0 || $somente_kit == 't') #HD 335128 CONDICAO DE - PARA // HD 671900 Somente Kit
                {
                    if ($cor == '#FCC'){
                        echo "<td align='center' onmouseover=\"info(this,'Esta peça não pertence a versão do produto com o número de série $produto_serie')\"  onmouseout='fechar()' ><input DISABLED class='frm' type='checkbox' name='pre_peca_$x' value='$ypeca'$pre_peca_x_checked>";
                        echo "&nbsp;<font face='arial' size='-2' color='#000000'> $ypeca_referencia </font> </td>";

                    }else{

                    echo "<td align='center' align='center'><input DISABLED class='frm' type='checkbox' name='pre_peca_$x' value='$ypeca'$pre_peca_x_checked>";
                    echo "&nbsp;<font face='arial' size='-2' color='#000000'> $ypeca_referencia </font> </td>";
                    }
                }else{#HD 335128
                    if ($cor == '#FCC'){
                        echo "<td align='center' onmouseover=\"info(this,'Esta peça não pertence a versão do produto com o número de série $produto_serie')\"  onmouseout='fechar()'><input class='frm' type='checkbox' name='pre_peca_$x' value='$ypeca'$pre_peca_x_checked>";
                        echo "&nbsp;<font face='arial' size='-2' color='#000000'> $ypeca_referencia </font> </td>";

                    }else{

                    echo "<td align='center'><input class='frm' type='checkbox' name='pre_peca_$x' rel='check_peca'  value='$ypeca'$pre_peca_x_checked>";
                    echo "&nbsp;<font face='arial' size='-2' color='#000000'> $ypeca_referencia </font> </td>";
                    }
                }
            }

            if($login_fabrica <> 15){
                echo "<td align='center'><font face='arial' size='-2' color='#000000'>$yqtde</font><input type='hidden' name='pre_qtde_$x' value='$yqtde'></td>\n";
            }else{
                echo "<input type='hidden' name='pre_qtde_$x' value='$yqtde'>\n";
            }

            if ($cor == '#FCC'){
                        echo "<td align='center' onmouseover=\"info(this,'Esta peça não pertence a versão do produto com o número de série $produto_serie')\"  onmouseout='fechar()'>";
            }else{

            echo "<td align='center'>";
            }
            if (strlen($para)>0 || $somente_kit == 't') #HD 335128 CONDICAO DE - PARA
            {
                echo "<select DISABLED name='pre_defeito_$x' class='frm' style='width:170px;'>";
                echo "</select>";
            }else{ #HD 335128
            echo "<select name='pre_defeito_$x' rel='pre_defeito' class='frm' style='width:170px;'>";
            echo "<option></option>";
            if($login_fabrica <> 15){
                $sql = "SELECT     tbl_defeito.defeito,
                                tbl_defeito.descricao
                        FROM tbl_peca_defeito
                        JOIN tbl_defeito using(defeito)
                        WHERE peca = $ypeca
                        AND tbl_peca_defeito.ativo = 't'
                        ORDER BY tbl_defeito.descricao";
            }else{
                $sql = "SELECT *
                        FROM   tbl_defeito
                        WHERE  tbl_defeito.fabrica = $login_fabrica
                        AND    tbl_defeito.ativo IS TRUE
                        ORDER BY descricao ";
            }
            $zres = pg_query($con,$sql);
            if(pg_num_rows($zres)>0){
                $contador_zres_3 = pg_num_rows($zres);
                for($z=0;$contador_zres_3>$z;$z++){
                    $zdefeito   = pg_fetch_result($zres,$z,defeito);
                    $zdescricao = pg_fetch_result($zres,$z,descricao);
                    $opt_sel = ($valor_pre_defeito_x == $zdefeito)?" SELECTED":"";
                    echo "<option value='$zdefeito'$opt_sel>$zdescricao</option>";
                }
            }
            echo "</select>";
            echo "</td>";
            }
            if (strlen($para)>0 and $login_fabrica == 15){ #HD 335128 CONDICAO DE - PARA
                if ($cor == '#FCC'){
                        echo "<td align='center' onmouseover=\"info(this,'Esta peça não pertence a versão do produto com o número de série $produto_serie')\"  onmouseout='fechar()'>";
                        echo "<select DISABLED class='frm' size='1' name='pre_servico_$x'  style='width:200px;'>";
                        echo "</select>";
                        echo "</td>";
                }else{
                echo "<td align='center'>";
                echo "<select DISABLED class='frm' size='1' name='pre_servico_$x'  style='width:200px;'>";
                echo "</select>";
                echo "</td>";
                }

            }else{
                if ($cor == '#FCC'){
                        echo "<td align='center' onmouseover=\"info(this,'Esta peça não pertence a versão do produto com o número de série $produto_serie')\"  onmouseout='fechar()'>";
                }else{
                echo "<td align='center'>";
                }
                if($login_fabrica <> 15){
                    echo "<select class='frm' size='1' name='pre_servico_$x'  style='width:150px;'>";
                }else{
                    echo "<select class='frm' size='1' name='pre_servico_$x'  style='width:200px;'>";
                }
                echo "<option></option>";
                if($login_fabrica <> 15){
                    $sql = "SELECT tbl_servico_realizado.servico_realizado,
                                    tbl_servico_realizado.descricao
                            FROM tbl_peca_servico
                            JOIN tbl_servico_realizado using(servico_realizado)
                            WHERE tbl_peca_servico.ativo = 't'
                            AND tbl_peca_servico.peca = $ypeca";

                    if (strlen($os_revenda)==0){
                        $sql .=" AND tbl_servico_realizado.descricao NOT ILIKE '%pedido Faturado%' ";
                        $sql .=" AND tbl_servico_realizado.descricao NOT ILIKE '%peça do Estoque%' ";
                    }

                    $sql .= "ORDER BY tbl_servico_realizado.descricao";

                }else{
                    $sql = "SELECT *
                            FROM tbl_servico_realizado
                            WHERE tbl_servico_realizado.fabrica = $login_fabrica
                            AND tbl_servico_realizado.ativo IS TRUE
                            ORDER BY descricao";
                }
                $zres = pg_query($con,$sql);
                if(pg_num_rows($zres)>0){
                    $contador_zres_4 = pg_num_rows($zres);
                    for($z=0;$contador_zres_4>$z;$z++){
                        $zservico_realizado   = pg_fetch_result($zres,$z,servico_realizado);
                        $zdescricao = pg_fetch_result($zres,$z,descricao);
                        $ztrocapeca = pg_fetch_result($zres,$z,troca_de_peca);
                        if($ztrocapeca == 't' AND $login_fabrica == 15){
                            echo "<option value='$zservico_realizado' selected> $zdescricao</option>";
                        }else{
                            $opt_sel = ($valor_pre_servico_x == $zservico_realizado)?" SELECTED":"";
                            echo "<option value='$zservico_realizado'$opt_sel>$zdescricao</option>";
                        }
                    }
                }
                echo "</select>";
                echo "</td>";
                echo "</tr>";
            }
            $para = '';
        }
        echo "<input type='hidden' name='pre_total' value='$x'>\n";
    }
/*HD 2599*/
}
        $loop = $qtde_item;
        if ($login_fabrica==3 ){
            $sql = "SELECT  count(*) as contador
                    FROM    tbl_os
                    JOIN tbl_os_produto ON tbl_os_produto.os = tbl_os.os
                    JOIN tbl_os_item      ON tbl_os_item.os_produto = tbl_os_produto.os_produto
                    WHERE   tbl_os.os  = $os
                    AND     tbl_os.fabrica = $login_fabrica";
            $res = pg_query($con,$sql);
            $num = pg_fetch_result($res,0,contador) - $numero_pecas_faturadas;
            $loop = $qtde_itens_mostrar - $numero_pecas_faturadas;
            if ($loop<$num)
            $loop = $num;

        }

        if($login_fabrica== 45){
            $sql="SELECT qtde_os_item
                    FROM tbl_posto_fabrica
                    WHERE posto   = $login_posto
                    AND   fabrica = $login_fabrica";
            $res = pg_query($con,$sql);
            $loop = pg_fetch_result($res,0,qtde_os_item);
        }

        if($login_fabrica == 15 ) {
            $loop = $qtde_itens_mostrar;
        }

        if(in_array($login_fabrica,array(30,72))) {
            if($login_fabrica == 30 && strlen($qtde_itens_mostrar)==0) {
                $qtde_itens_mostrar = 5;
            }else{
                $loop = $qtde_itens_mostrar;
            }

            $sql = "SELECT  count(*) as contador
                    FROM    tbl_os
                    JOIN tbl_os_produto ON tbl_os_produto.os = tbl_os.os
                    JOIN tbl_os_item      ON tbl_os_item.os_produto = tbl_os_produto.os_produto
                    WHERE   tbl_os.os  = $os
                    AND     tbl_os.fabrica = $login_fabrica";
            $res = pg_query($con,$sql);
            $num = pg_fetch_result($res,0,contador);
//    Qtde de linhas para mostrar sempre múltiplo de 10... desde que não seja menor q 5
            if($login_fabrica == 30){
                $num = ($num>5) ? round($num/10)*10 : 5;
            }
            $loop = ($qtde_itens_mostrar <= $num)?$num:$qtde_itens_mostrar;
        }

        if($login_fabrica == 6 AND $posto_item_aparencia == 't') {
            $loop = $loop+7;
        }

        #if( in_array( $login_fabrica, array( 90 , 91 ) ) ) {
        #    $loop = 10;
        #}

        if($login_fabrica == 85 and ($login_posto == 60908 || $login_posto == 6359)) //HD 675212
            $loop = 30;

        // if($login_fabrica == 42) HD-2589331
        //     $loop= 15;

        //USADO PARA FAZER O LAÇO QUANDO EXISTIR UM ITEM DE APARENCIA E INCREMENTAR EM QTDE_ITENS
        $qtde_item_aparencia="0";

        $offset = 0;

        if ($login_fabrica == 3) {
            echo "<input type='hidden' id='loop' value='$loop' />";
        }

        if($login_fabrica == 24 or $login_fabrica > 100){
            if($loop_itens > 0){
                $loop = $loop_itens + 1;
            }
        }

        // LIMITA EM 1 ITEM PARA A FÁBRICA (129) RINNAL HD-2471645
        if ($login_fabrica == 129) {
            $loop = 1;
        }
        for ($i = 0 ; $i < $loop ; $i++) {
            $cor="";
            if ($login_fabrica == 3 || $login_fabrica == 43) {//HD 255541
                $cor=" bgcolor='#FF6666'";
                if ($i==0) {
                    $cor=" bgcolor='#99FF99'";
                    if ($numero_pecas_faturadas==1) $cor=" bgcolor='#FFFF99'";
                }
                if ($i==1) {
                     $cor=" bgcolor='#FFFF99'";
                    if ($numero_pecas_faturadas==1) $cor=" bgcolor='#FF6666'";
                }
                if ($numero_pecas_faturadas>=2) $cor=" bgcolor='#FF6666'";
            }

            echo "<tr $cor id='mostrar_$i' style='text-align:justify;' alt='$i'>";
                if (in_array($login_fabrica,array(3,30,91))) {

                    echo "<input type='hidden' name='kit_kit_peca_{$i}' value='{$kit_peca[$i]}'>";
                }
                echo "<input type='hidden' name='os_produto_$i' value='{$os_produto[$i]}'>\n";
                echo "<input type='hidden' name='os_item_$i'    value='{$os_item[$i]}'>\n";
                echo "<input type='hidden' name='excluida_auditoria_$i'    value='{$excluida_auditoria[$i]}'>\n";
                echo "<input type='hidden' name='orcamento_item_$i' value='{$orcamento_item[$i]}'>\n";
                echo "<input type='hidden' name='descricao'>";
                echo "<input type='hidden' name='preco'>";
                echo "<input type='hidden' name='preco_$i' value='{$preco[$i]}' id='preco_$i'>";
                echo "<input type='hidden' name='admin_peca_$i' value='{$admin_peca[$i]}'>";
                echo "<input type='hidden' name='qtde_fotos_$i' value='{$qtde_fotos[$i]}' />";
                echo "<input type='hidden' name='serial_lcd_$i' value='{$serial_lcd[$i]}' />";
                echo "<input type='hidden' id='input_refpeca_$i' value='$peca[$i]'>";
            if($login_fabrica == 74){
                echo "<input type='hidden' id='depara_auditoria_$i' name='depara_auditoria_$i' value='$depara_auditoria' />";
            }
//             echo $os_item_subconjunto;
            if ($os_item_subconjunto == 'f') {
                echo "<input type='hidden' name='produto_$i' value='$produto_referencia'>";
            } elseif ($os_item_subconjunto == 't'){
                echo "<td align='left' nowrap>";
                echo "<select class='frm' size='1' name='produto_$i'>";
                #echo "<option></option>";

                $sql = "SELECT  tbl_produto.produto   ,
                                tbl_produto.referencia,
                                tbl_produto.descricao
                        FROM    tbl_subproduto
                        JOIN    tbl_produto ON tbl_subproduto.produto_filho = tbl_produto.produto
                        WHERE   tbl_subproduto.produto_pai = $produto_os
                        ORDER BY tbl_produto.referencia;";
                $resX = pg_query($con,$sql) ;

                echo "<option value='$produto_referencia' ";
                if ($produto[$i] == $produto_referencia) echo " selected ";
                echo " >$produto_descricao</option>";

                for ($x = 0 ; $x < pg_num_rows($resX) ; $x++ ) {
                    $sub_produto    = trim (pg_fetch_result($resX,$x,produto));
                    $sub_referencia = trim (pg_fetch_result($resX,$x,referencia));
                    $sub_descricao  = trim (pg_fetch_result($resX,$x,descricao));

                    if ($login_fabrica == 14 AND substr ($sub_referencia,0,3) == "499" ){
                        $sql = "SELECT  tbl_produto.produto   ,
                                        tbl_produto.referencia,
                                        tbl_produto.descricao
                                FROM    tbl_subproduto
                                JOIN    tbl_produto ON tbl_subproduto.produto_filho = tbl_produto.produto
                                WHERE   tbl_subproduto.produto_pai = $sub_produto
                                ORDER BY tbl_produto.referencia;";
                        $resY = pg_query($con,$sql) ;
                        echo "<optgroup label='" . $sub_referencia . " - " . substr($sub_descricao,0,25) . "'>" ;
                        for ($y = 0 ; $y < pg_num_rows($resY) ; $y++ ) {
                            $sub_produto    = trim (pg_fetch_result($resY,$y,produto));
                            $sub_referencia = trim (pg_fetch_result($resY,$y,referencia));
                            $sub_descricao  = trim (pg_fetch_result($resY,$y,descricao));

                            echo "<option ";
                            if (trim ($produto[$i]) == $sub_referencia) echo " selected ";
                            echo " value='" . $sub_referencia . "'>" ;
                            echo $sub_referencia . " - " . substr($sub_descricao,0,25) ;
                            echo "</option>";
                        }
                        echo "</optgroup>";
                    }else{
                        echo "<option ";
                        if (trim ($produto[$i]) == $sub_referencia) echo " selected ";
                        echo " value='" . $sub_referencia . "'>" ;
                        echo $sub_referencia . " - " . substr($sub_descricao,0,25) ;
                        echo "</option>";
                    }
                }

                echo "</select>";
                if ($login_fabrica == 14) {
                    echo " <img src='imagens/lupa.png' border='0' align='absmiddle' onclick='javascript: fnc_pesquisa_peca_lista_sub (document.frm_os.produto_$i.value, document.frm_os.posicao_$i, document.frm_os.peca_$i, document.frm_os.descricao_$i)' alt='Clique para abrir a lista básica do produto selecionado' style='cursor:pointer;'>";
                }
                echo "</td>\n";
            }

            if ($os_item_subconjunto == 'f') {
                $xproduto = $produto[$i];
                echo "<input type='hidden' name='serie_$i'>\n";
            } elseif ($os_item_subconjunto == 't'){
                if ($os_item_serie == 't') {
                    echo "<td align='left'><input class='frm' type='text' name='serie_$i' size='9' value='$serie[$i]'></td>\n";
                }
            }

            if($login_fabrica == 56){
                    echo "<td align='left'><input class='frm' type='text' name='serie_$i' size='9' value='$serie[$i]'></td>\n";
            }

            /* Rotina para verificação de comunicados por Peça - HD 19052 */
            if (strlen($peca[$i])>0 and $login_fabrica == 50){
                $sql ="SELECT count(*)
                        FROM  tbl_comunicado
                        LEFT JOIN tbl_comunicado_peca USING(comunicado)
                        LEFT JOIN tbl_peca PC_1  ON PC_1.peca = tbl_comunicado_peca.peca and PC_1.fabrica = $login_fabrica
                        LEFT JOIN tbl_peca PC_2  ON PC_2.peca = tbl_comunicado.peca and PC_2.fabrica = $login_fabrica

                        WHERE tbl_comunicado.fabrica = $login_fabrica
                        AND   tbl_comunicado.ativo  IS TRUE
                        AND ( tbl_comunicado.posto = $login_posto OR tbl_comunicado.posto IS NULL)
                        AND (PC_1.referencia = '$peca[$i]' OR PC_2.referencia = '$peca[$i]')";
                $resComunicado = pg_query($con,$sql) ;
                $tem_comunicado = trim(pg_fetch_result($resComunicado,0,0));
            }else{
                $tem_comunicado = 0;
            }
// echo $os_item_aparencia ."--".$posto_item_aparencia.">>".$os_item_subconjunto;
            if ($os_item_aparencia == 't' AND $posto_item_aparencia == 't' and $os_item_subconjunto == 'f') {    // HD 7033 16/11/2007
                $sql = "SELECT  tbl_peca.peca      ,
                                tbl_peca.referencia,
                                tbl_peca.descricao ,
                                tbl_lista_basica.qtde
                        FROM    tbl_peca
                        JOIN    tbl_lista_basica USING (peca)
                        JOIN    tbl_produto      ON tbl_produto.produto = tbl_lista_basica.produto
                        WHERE   tbl_produto.produto     = $produto_os
                        AND     tbl_peca.fabrica        = $login_fabrica";
                        if ($login_fabrica==6 and strlen($produto_serie)>0) {
                        $sql .= " AND     tbl_lista_basica.serie_inicial < '$produto_serie'
                                  AND     tbl_lista_basica.serie_final > '$produto_serie'";
                        }
                        $sql .= " AND     tbl_peca.item_aparencia = 't'
                        ORDER BY tbl_peca.referencia
                        LIMIT 1 OFFSET $offset;";
                $resX = pg_query($con,$sql) ;
                if (pg_num_rows($resX) > 0) {

                    $qtde_item_aparencia++;
                    $xpeca       = trim(pg_fetch_result($resX,0,peca));
                    $xreferencia = trim(pg_fetch_result($resX,0,referencia));
                    $xdescricao  = trim(pg_fetch_result($resX,0,descricao));
                    $xqtde       = trim(pg_fetch_result($resX,0,qtde));

                    if ($peca[$i] == $xreferencia)
                        $check = " checked ";
                    else
                        $check = "";

                    if ($login_posto == 427) $check = " checked ";

                    echo "<td align='left'><div style='margin-left: 5px'><input class='frm' type='checkbox' name='peca_$i' value='$xreferencia' $check>&nbsp;<font face='arial' size='-2' color='#000000'>$xreferencia</font></div></td>\n";

                    echo "<td width='60' align='left'>";
                    //echo "<img src='imagens/btn_lista.gif' border='0' align='absmiddle' onclick='javascript: fnc_pesquisa_lista_basica (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco , document.frm_os.voltagem, \"referencia\")' alt='LISTA BÁSICA' style='cursor:pointer;'>";
                    echo "</TD>";
                    echo "<td align='left'><div style='margin-left: 5px'><font face='arial' size='-2' color='#000000'>$xdescricao</font></div></td>\n";
                    echo "<td align='center'><font face='arial' size='-2' color='#000000'>$xqtde</font><input type='hidden' name='qtde_$i' value='$xqtde'></td>\n";

                    if ($login_fabrica == 6) {
                        if (strlen($defeito[$i]) == 0) $defeito[$i] = 78 ;
                        if (strlen($servico[$i]) == 0) $servico[$i] = 1 ;
                    }
                }else{

                        echo "<td align='left' nowrap>&nbsp;&nbsp;<input class='frm' type='text' name='peca_$i' size='15' value='$peca[$i]' alt='LISTA BÁSICA'><img src='imagens/lupa.png' border='0' align='absmiddle' onclick='javascript: fnc_pesquisa_peca_lista (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco , document.frm_os.voltagem, \"tudo\" ,document.frm_os.qtde_$i, null, document.frm_os.qtde_fotos_$i,document.frm_os.serial_lcd_$i, $i)' alt='Clique para efetuar a pesquisa' style='cursor:pointer;'></td>";
    //takashi chamado 300 12-07
                        echo "<td width='60' align='center'><img src='imagens/btn_lista.gif' class='$lanca_peca' border='0' align='absmiddle' onclick='javascript: fnc_pesquisa_lista_basica (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco , document.frm_os.voltagem, \"referencia\",document.frm_os.qtde_$i,document.frm_os.qtde_fotos_$i,document.frm_os.serial_lcd_$i, $i)' alt='LISTA BÁSICA' style='cursor:pointer;'></TD>";
    //takashi chamado 300 12-07
                        if ($login_fabrica == 6) {
                            $width_desc_text = "style='width: 240px;'";
                        } else {
                            $width_desc_text = "size='25'";
                        }

                        echo "<td align='left' nowrap>&nbsp;&nbsp;<input class='frm' type='text' name='descricao_$i' $width_desc_text value='$descricao[$i]'>&nbsp;<img src='imagens/lupa.png' border='0' align='absmiddle' onclick='javascript: fnc_pesquisa_peca_lista (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco , document.frm_os.voltagem, \"descricao\" ,document.frm_os.qtde_$i, null, document.frm_os.qtde_fotos_$i,document.frm_os.serial_lcd_$i, $i)' alt='Clique para efetuar a pesquisa' style='cursor:pointer;'></td>";
                        if ($pergunta_qtde_os_item == 't') {
                            echo "<td align='center'><input class='frm' type='text' name='qtde_$i' size='3' value='$qtde[$i]'></td>\n";
                        }
                    }
            }else{

                if ($login_fabrica == 14) {
                    echo "<td align='left'><input class='frm' type='text' name='posicao_$i' size='5' maxlength='5' value='$posicao[$i]'></td>\n";
                } else if ($login_fabrica == 24) { //hd 12634 29/1/2008
                    echo "<input class='frm' type='hidden' name='posicao_$i' size='5' maxlength='5' value='$posicao[$i]'>";
                } else {
                    echo "<input type='hidden' name='posicao_$i'>\n";
                }
//takashi 04-04-07 hd 1819

                // LATINA codigo e descrição são invertidos - HD 4981
                // alterar aki tem que altera mais a baixo tbm!!! é o mesmo código
                $cor_coluna = ($i % 2) ? "#F1F4FA" : "#F7F5F0";

                if ($login_fabrica == 15  ) {//HD 258901

                    echo "<td align='left' bgcolor='$cor_coluna'><input class='frm' type='text' name='descricao_$i' size='45' value='$descricao[$i]'>&nbsp;<img src='imagens/lupa.png' border='0' align='absmiddle'";
                     echo " onclick='javascript: fnc_pesquisa_peca_lista_latina (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco , document.frm_os.voltagem, \"descricao\",document.frm_os.produto_serie ,document.frm_os.kit_peca_$i".(($login_fabrica == 15) ? ", document.frm_os.defeito_constatado,$i" : ", '', $i").")'";
                    echo " alt='Clique para efetuar a pesquisa' style='cursor:pointer;'></td>\n";

                } else if ($login_fabrica == 24 or $login_fabrica == 91 ) {

                    echo "<td align='left' bgcolor='$cor_coluna'><input class='frm' type='text' name='descricao_$i' size='45' value='$descricao[$i]'>&nbsp;<img src='imagens/lupa.png' border='0' align='absmiddle'";
                    echo " onclick='javascript: fnc_pesquisa_lista_basica_suggar (document.getElementsByName(\"produto_{$i}\")[0].value , document.getElementsByName(\"peca_{$i}\") , document.getElementsByName(\"descricao_{$i}\") , {$i}, document.getElementsByName(\"preco_{$i}\") , document.getElementsByName(\"voltagem\"), \"descricao\", document.getElementsByName(\"kit_peca_{$i}\"),\"$i\")'";
                    echo " alt='Clique para efetuar a pesquisa' style='cursor:pointer;'></td>\n";

//                 } else if($login_fabrica == 95) {
                } else if($login_fabrica == 74) {
                    $onclick_limpa_movimentacao = "onChange='limpaMovimentacaoEstoque($i)'";

                    echo "<td width='200' align='left' bgcolor='$cor_coluna' nowrap> <input $onclick_limpa_movimentacao class='frm' type='text' name='peca_$i' $block_item id='peca_$i'size='15' value='$peca[$i]'>&nbsp;<img src='imagens/lupa.png' border='0' align='absmiddle'
                    onclick='javascript: fnc_pesquisa_lista_serie($i,document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.produto_serie, \"referencia\", document.frm_os.qtde_$i)' alt='LISTA BÁSICA' style='cursor:pointer;'></TD>";

                } else {
                    if($login_fabrica == 131){
                        $defeito_hiden = "<input type='hidden' name='defeito_$i' />";
                    }else{
                        $defeito_hiden = "";
                    }

                    $call_defeito_lista = '';
                    if ($login_fabrica == '30') {
                        $call_defeito_lista = " onChange='defeitoLista(document.frm_os.peca_$i.value,$i,$os)' ";
                    }

                    if($login_fabrica == 50){
                        if(strlen(trim($peca[$i]))>0){
                            $sql_dev_obrig = "select devolucao_obrigatoria from tbl_peca where referencia = '$peca[$i]' and fabrica = $login_fabrica ";
                            $res_dev_obrig = pg_query($con, $sql_dev_obrig);
                            if(pg_num_rows($res_dev_obrig)>0){
                                $devolucao_obrig = pg_fetch_result($res_dev_obrig, 0, devolucao_obrigatoria);
                            }
                            if($devolucao_obrig == 't'){
                                $rel = "rel='sim'";
                                $msg_dev_obrig = "<tr><td id='dev_obrig_$i' colspan='4' style='color:#ff0000;'>PEÇA DE RETORNO OBRIGATÓRIO, FAVOR NÃO DESCARTA-LA E DEVOLVE-LA AO FABRICANTE.</td></tr>";
                            }else{
                                $rel = "";
                                $msg_dev_obrig = "";
                            }
                        }else{
                            $rel = "";
                            $msg_dev_obrig = "";
                        }
                    }

                    echo "<td align='left' nowrap bgcolor='$cor_coluna'>
                    $defeito_hiden
                    <input class='frm' type='text' name='peca_$i' $block_item id='peca_$i'size='15' value='$peca[$i]' $rel "; echo " "; if($login_fabrica==30 or $login_fabrica ==43) echo " onfocus=\"pega_peca('$os','peca_$i','descricao_$i','$i');\" onblur=\"pega_peca('$os','peca_$i','descricao_$i','$i'); atualizaQtde(document.frm_os.peca_$i,document.frm_os.qtde_$i);\" ";

                    echo $call_defeito_lista;

                    if ($login_fabrica == 50) echo " onBlur='checarComunicado($i);' onkeyup=\"limpaDefeito($i);\"  ";

                    echo ">&nbsp;<img src='imagens/lupa.png' border='0' align='absmiddle'  ";

                    //hd 12634 29/1/2008
                    if ($login_fabrica == 40) echo " onclick='javascript: fnc_pesquisa_peca_lista_masterfrio (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i, document.frm_os.preco_$i , document.frm_os.voltagem, document.frm_os.defeito_constatado, \"referencia\", document.frm_os.qtde_$i)'";
                    if ($login_fabrica == 14) echo " onclick='javascript: fnc_pesquisa_peca_lista_intel (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.posicao_$i , \"referencia\")'";
                    if (in_array($login_fabrica,[120,201]))echo " onclick='javascript: fnc_pesquisa_peca_lista (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco_$i , document.frm_os.voltagem,\"referencia\", document.frm_os.qtde_$i, \"\", document.frm_os.qtde_estoque_$i)'";

                    //hd_chamado=2881143
                    if($login_fabrica == 19)echo " onclick='javascript: fnc_pesquisa_lista_basica_lorenzetti (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco_$i , document.frm_os.voltagem,\"referencia\",document.frm_os.qtde_$i,document.frm_os.defeitos_lorenzetti_hidden.value,document.frm_os.qtde_fotos_$i, document.frm_os.serial_lcd_$i, $i)'";
                    // fim hd_chamado=2881143
                    if(in_array($login_fabrica,array(131,134)))echo " onclick='javascript: pesquisaPecaDefeito (document.frm_os.peca_$i,document.frm_os.descricao_$i,$i,document.frm_os.produto_$i.value)'";
                    else if ($login_fabrica == 141 && $posto_interno)
                        echo " onclick='fnc_pesquisa_peca_lista_unicoba (\"referencia\" , $i, document.frm_os.peca_$i)'";
                    else
                        echo " onclick='javascript: fnc_pesquisa_peca_lista (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco_$i , document.frm_os.voltagem,\"referencia\", document.frm_os.qtde_$i,null,document.frm_os.qtde_fotos_$i, document.frm_os.serial_lcd_$i, $i)'";
                    echo " alt='Clique para efetuar a pesquisa' style='cursor:pointer;'>";
                    //takashi 11-07 chamado 300

                    /* Rotina para verificação de comunicados por Peça - HD 19052 */
                    $style_img_comunicado = ($tem_comunicado == 0) ? "visibility:hidden;" : '';

                    echo "<img id='imagem_comunicado_$i' src='imagens/warning.png' style='$style_img_comunicado cursor: pointer;' aling='absmiddle' onclick='javascript:abreComunicadoPeca($i)'>";
                    echo "</td>\n";

                }
                    /* ***** Botão Lista Básica ***** */

                if ($login_fabrica == 6) {
                    echo "<td width='60' align='center' bgcolor='$cor_coluna'><img src='imagens/btn_lista.gif' class='$lanca_peca' border='0' align='absmiddle' onclick='javascript: fnc_pesquisa_lista_basica2(document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco , document.frm_os.voltagem, \"referencia\")' alt='LISTA BÁSICA' style='cursor:pointer;'></TD>";
                } else {
                    //hd 12634 29/1/2008
                    if ($login_fabrica == 24 ) {//HD 258901
                        echo "<td width='60' align='center'><img src='imagens/btn_lista.gif' border='0' align='absmiddle' onclick='javascript: fnc_pesquisa_lista_basica_suggar (document.getElementsByName(\"produto_{$i}\")[0].value , document.getElementsByName(\"peca_{$i}\") , document.getElementsByName(\"descricao_{$i}\") , document.getElementsByName(\"posicao_{$i}\") , document.getElementsByName(\"preco_{$i}\") , document.getElementsByName(\"voltagem\"), \"referencia\", document.getElementsByName(\"kit_peca_{$i}\"),\"$i\")' alt='LISTA BÁSICA' style='cursor:pointer;'></TD>";
                    } else if ($login_fabrica == 15) {
                        echo "<td width='60' align='center' bgcolor='$cor_coluna'><img src='imagens/btn_lista.gif' border='0' align='absmiddle' onclick='javascript: fnc_pesquisa_lista_basica_latina (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco , document.frm_os.voltagem, \"referencia\", document.frm_os.produto_serie, document.frm_os.kit_peca_$i, document.frm_os.defeito_constatado, $i)' alt='LISTA BÁSICA' style='cursor:pointer;'></TD>";
                    } else if($login_fabrica == 91) {
                        echo "<td width='60' align='center' bgcolor='$cor_coluna'><img src='imagens/btn_lista.gif' border='0' align='absmiddle' onclick='javascript: fnc_pesquisa_lista_basica_latina (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco , document.frm_os.voltagem, \"referencia\", document.frm_os.produto_serie, document.frm_os.kit_peca_{$i},document.frm_os.defeito_constatado, {$i})' alt='LISTA BÁSICA' style='cursor:pointer;'></TD>";
                        //takashi 11-07 chamado 300
//                     } elseif($login_fabrica == 95) { //HD 383844
                    } else if($login_fabrica == 74 or in_array($login_fabrica,[120,201])) {
                        echo "<td width='60' align='center' bgcolor='$cor_coluna'><img src='imagens/btn_lista.gif' border='0' align='absmiddle' onclick='javascript: fnc_pesquisa_lista_serie($i,document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.produto_serie, \"tudo\", document.frm_os.qtde_$i)' alt='LISTA BÁSICA' style='cursor:pointer;' ></TD>";
                    }elseif (strlen($block_item) > 0) {
                        echo "<td width='60' align='center'><img src='imagens/btn_lista.gif' border='0' align='absmiddle' alt='LISTA BÁSICA' style='cursor:pointer;'></TD>";
                    }elseif(in_array($login_fabrica,[120,201])){
                        echo "<td width='60' align='center' bgcolor='$cor_coluna'><img src='imagens/btn_lista.gif' border='0' align='absmiddle' onclick='javascript: fnc_pesquisa_lista_basica (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco_$i , document.frm_os.voltagem, \"referencia\",document.frm_os.qtde_$i, \"\", document.frm_os.qtde_estoque_$i)' alt='LISTA BÁSICA' style='cursor:pointer;'></TD>";
                    }elseif($login_fabrica == 131 || $login_fabrica == 134){
                      echo "<td width='60' align='center' bgcolor='$cor_coluna'><img src='imagens/btn_lista.gif' border='0' align='absmiddle' onclick=\"javascript: pesquisaPecaDefeito (document.frm_os.peca_$i , document.frm_os.descricao_$i ,$i, document.frm_os.produto_$i.value,'lista')\" alt='LISTA BÁSICA' style='cursor:pointer;'></TD>";
                    }elseif($login_fabrica == 19){//hd_chamado=2881143
                        echo "<td width='60' align='center' bgcolor='$cor_coluna'><img src='imagens/btn_lista.gif' border='0' align='absmiddle' onclick='javascript: fnc_pesquisa_lista_basica_lorenzetti (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco_$i , document.frm_os.voltagem, \"referencia\",document.frm_os.qtde_$i,document.frm_os.defeitos_lorenzetti_hidden.value,null,document.frm_os.qtde_fotos_$i,document.frm_os.serial_lcd_$i, $i)' alt='LISTA BÁSICA' style='cursor:pointer;'></TD>";
                    }elseif($login_fabrica == 141 && $posto_interno){
                        // para nao mostrar o botao de lista basica
                    }else{
                        echo "<td width='60' align='center' bgcolor='$cor_coluna'><img src='imagens/btn_lista.gif' border='0' align='absmiddle' onclick='javascript: fnc_pesquisa_lista_basica (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco_$i , document.frm_os.voltagem, \"referencia\",document.frm_os.qtde_$i,null,null,document.frm_os.qtde_fotos_$i,document.frm_os.serial_lcd_$i, $i)' alt='LISTA BÁSICA' style='cursor:pointer;'></TD>";
                        //takashi 11-07 chamado 300
                    }
                }

                // LATINA codigo e descrição são invertidos - HD 4981
                // alterar aki tem que altera mais a acima tbm!!! é o mesmo código
                if ($login_fabrica == 15) {//HD 258901
                    echo "<td align='center' nowrap bgcolor='$cor_coluna'>
                    <input class='frm' type='text' name='peca_$i' size='15' value='$peca[$i]'"; echo " >&nbsp;<img src='imagens/lupa.png' border='0' align='absmiddle'";
                    echo " onclick='javascript: fnc_pesquisa_peca_lista_latina (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco , document.frm_os.voltagem, \"referencia\",document.frm_os.produto_serie ,document.frm_os.kit_peca_$i, document.frm_os.defeito_constatado, $i)'";
                    echo " alt='Clique para efetuar a pesquisa' style='cursor:pointer;'>";
                    echo "</td>\n";
                } else if ($login_fabrica == 24 or $login_fabrica == 91) {

                    echo "<td align='center' nowrap bgcolor='$cor_coluna'><input class='frm' type='text' name='peca_$i' size='15' value='$peca[$i]'";
                    echo " >&nbsp;<img src='imagens/lupa.png' border='0' align='absmiddle'";
                    echo " onclick='javascript: fnc_pesquisa_lista_basica_suggar (document.getElementsByName(\"produto_{$i}\")[0].value , document.getElementsByName(\"peca_{$i}\") , document.getElementsByName(\"descricao_{$i}\") , {$i} , document.getElementsByName(\"preco_{$i}\") , document.getElementsByName(\"voltagem\"), \"referencia\", document.getElementsByName(\"kit_peca_{$i}\"),\"$i\")'";
                    echo " alt='Clique para efetuar a pesquisa' style='cursor:pointer;'>";

//                 } else if ($login_fabrica == 95) {
                } else if($login_fabrica == 74) {
                    echo "<td align='center' bgcolor='$cor_coluna' nowrap> <input class='frm' type='text' name='descricao_$i' $block_item id='descricao_$i'size='40' value='$descricao[$i]'>&nbsp;<img src='imagens/lupa.png' border='0' align='absmiddle'
                    onclick='fnc_pesquisa_lista_serie($i,document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.produto_serie, \"descricao\", document.frm_os.qtde_$i)' alt='LISTA BÁSICA' style='cursor:pointer;'></TD>";

                } else {
                    $val_descricao = (is_array($descricao)) ? $descricao[$i] : '';
                    echo "<td align='center' nowrap bgcolor='$cor_coluna'><input class='frm' type='text' name='descricao_$i' id='descricao_$i' $block_item size='25' value='$val_descricao' ";
                    if ($login_fabrica == 50) echo " onBlur='checarComunicado($i);'  ";
                    echo ">&nbsp;";

                    if($login_fabrica != 140){

                        echo "<img src='imagens/lupa.png' class='$lanca_peca' border='0' align='absmiddle'";
                        //hd 12634 29/1/2008
                        if ($login_fabrica == 14) echo " onclick='fnc_pesquisa_peca_lista_intel (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.posicao_$i , \"descricao\")'";
                        if (in_array($login_fabrica,[120,201]))echo " onclick='javascript: fnc_pesquisa_peca_lista (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco_$i , document.frm_os.voltagem,\"descricao\", document.frm_os.qtde_$i, \"\", document.frm_os.qtde_estoque_$i)'";
                        else if ($login_fabrica <> 30) {
                            if ($login_fabrica == 131 || $login_fabrica == 134){
                                echo " onclick='javascript: pesquisaPecaDefeito (document.frm_os.peca_$i,document.frm_os.descricao_$i,$i,document.frm_os.produto_$i.value)'";
                            } elseif ($login_fabrica == 40) {
                                echo " onclick='fnc_pesquisa_peca_lista_masterfrio (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco_$i , document.frm_os.voltagem,document.frm_os.defeito_constatado,  \"descricao\", document.frm_os.qtde_$i)'";
                            }elseif($login_fabrica == 19){//hd_chamado=2881143
                                echo " onclick='fnc_pesquisa_lista_basica_lorenzetti (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco_$i , document.frm_os.voltagem,\"descricao\", document.frm_os.qtde_$i, document.frm_os.defeitos_lorenzetti_hidden.value, document.frm_os.qtde_fotos_$i, document.frm_os.serial_lcd_$i, $i)'";
                            } else if ($login_fabrica == 141 && $posto_interno) {
                                echo " onclick='fnc_pesquisa_peca_lista_unicoba (\"descricao\" , $i, document.frm_os.descricao_$i)'";
                            } else {
                                echo " onclick='fnc_pesquisa_peca_lista (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco_$i , document.frm_os.voltagem,\"descricao\", document.frm_os.qtde_$i, $i, document.frm_os.qtde_fotos_$i, document.frm_os.serial_lcd_$i, $i);mudaFocus($i)'";
                            }
                        } else {
                            echo " onclick='fnc_pesquisa_peca_lista (document.frm_os.produto_$i.value , document.frm_os.peca_$i , document.frm_os.descricao_$i , document.frm_os.preco_$i , document.frm_os.voltagem,\"descricao\", document.frm_os.qtde_$i, $i, document.frm_os.qtde_fotos_$i, document.frm_os.serial_lcd_$i, $i);mudaFocus($i)'";
                        }

                        echo " alt='Clique para efetuar a pesquisa' style='cursor:pointer;'>";

                    }

                    echo "</td>\n";

                }

                //HD 38818 4/9/2008 ----------------------------
                if ($informatica == 't' and $login_fabrica != 127) {

                    echo "</td>";
                        echo "<td align='center' nowrap bgcolor='$cor_coluna'>";
                        echo "<input class='frm' type='text' name='peca_serie_$i' id='peca_serie_$i' size='13' $block_item maxlength='20' value='$peca_serie[$i]' ";
                        echo ">&nbsp;<img src='imagens/lupa.png' class='$lanca_peca' border='0' align='absmiddle'";
                        echo " onclick='javascript: fnc_pesquisa_peca_serie (document.frm_os.peca_serie_$i.value, document.frm_os.peca_$i,document.frm_os.descricao_$i  )'";
                        echo " alt='Clique para efetuar a pesquisa' style='cursor:pointer;'></td>\n";

                }
                //----------------------------------------------

                if ($pergunta_qtde_os_item == 't') {

                    #HD 159888 INICIO
                    if ($login_fabrica == 30 && $controla_estoque == 't') {
                        $display = ($qtde[$i]) ? "display:block" : "display:none";
                        echo "<td align='center' bgcolor='$cor_coluna' style='font:bold 10px Arial !important;'><label id='ver_estoque_$i' style='cursor:pointer;$display;' onclick='mostraEstoque($i);'>Ver <br>&nbsp;&nbsp; Estoque</label><img src='imagens/barrow_down.png' id='img_arrow_$i' style='$display'></td>";
                    }

                    #HD 159888 FIM
                    #3150158
                    $onclick_limpa_movimentacao = (in_array($login_fabrica,array(35,72,74))) ? "onChange='limpaMovimentacaoEstoque($i)'": "";

                    if($login_fabrica == 134 && $controla_estoque != "t"){
                        $onclick_limpa_movimentacao = (in_array($login_fabrica,array(134))) ? "onChange='verificaEstoqueMinimo($(\"#peca_$i\").val());limpaMovimentacaoEstoque($i)'": $onclick_limpa_movimentacao;
                    }

                    echo "<td align='center' bgcolor='$cor_coluna'>";
                        echo "<input class='frm' type='text' id='qtde_$i' name='qtde_$i' size='3' value='".$qtde[$i]."' $block_item $onclick_limpa_movimentacao>";
                    echo "</td>\n";

                }

            }

            #------------------- Causa do Defeito no Item --------------------
            if ($pedir_causa_defeito_os_item == 't' and $login_fabrica <> 20) {

                echo "<td align='center'>";
                echo "<select class='frm' size='1' name='pcausa_defeito_$i'>";
                echo "<option selected></option>";

                # HD 44571
                if ($login_fabrica == 5) {
                    $cond_mondialcausa = "AND causa_defeito = 1";
                }

                $sql = "SELECT * FROM tbl_causa_defeito WHERE fabrica = $login_fabrica $cond_mondialcausa ORDER BY codigo, descricao";
                $res = pg_query($con,$sql) ;

                for ($x = 0; $x < pg_num_rows($res); $x++) {

                    echo "<option ";
                    if ($pcausa_defeito[$i] == pg_fetch_result($res,$x,causa_defeito)) echo " selected ";
                    echo " value='" . pg_fetch_result($res,$x,causa_defeito) . "'>" ;
                    echo pg_fetch_result($res,$x,codigo) ;
                    echo " - ";
                    echo pg_fetch_result($res,$x,descricao) ;
                    echo "</option>";

                }

                echo "</select>";
                echo "</td>\n";

            }

            if($login_fabrica == 91){
?>
                <td style="text-align:center;background-color:<?=$cor_coluna?>">
                    <select class="frm" name="fornecedor_<?=$i?>">
                        <option id="op_<?=$i?>" value=""></option>
<?
                if($peca[$i] > 0){
                    $sqlF = "
                        SELECT  tbl_fornecedor_peca.fornecedor  AS retorno_fornecedor_peca      ,
                                tbl_fornecedor.nome             AS retorno_fornecedor_peca_nome
                        FROM    tbl_fornecedor_peca
                        JOIN    tbl_fornecedor  ON  tbl_fornecedor.fornecedor   = tbl_fornecedor_peca.fornecedor
                        JOIN    tbl_peca        ON  tbl_peca.peca               = tbl_fornecedor_peca.peca
                                                AND tbl_peca.referencia         = '$peca[$i]'
                        WHERE   tbl_fornecedor_peca.fabrica = $login_fabrica
                    ";
                    $resF = pg_query($con,$sqlF);
                    if(pg_numrows($resF) > 0){
                        $contador_resF = pg_numrows($resF);
                        for($f = 0; $f < $contador_resF; $f++){
                            $retorno_fornecedor_peca = pg_fetch_result($resF,$f,retorno_fornecedor_peca);
                            if($retorno_fornecedor_peca == $fornecedor[$i]){
                                $selected = "selected = 'selected'";
                            }else{
                                $selected = "";
                            }
?>
                        <option value="<?=$retorno_fornecedor_peca?>" <?=$selected?>><?=pg_fetch_result($resF,$f,retorno_fornecedor_peca_nome)?></option>
<?
                        }
                    }
                }
?>
                    </select>
                </td>
<?
            }

            #------------------- Defeito no Item --------------------

            if ((!in_array($login_fabrica,array(96,95)) and !$fabricas_padrao_itens && $login_fabrica < 99) || in_array($login_fabrica, array(91,106,120,201,172)) ) {
                echo "<td align='center' bgcolor='$cor_coluna'>";
                /*INTEGRIDADE DE PEÇAS COMECA AQUI - TAKASHI HD 1950*/
                if (in_array($login_fabrica,array(6,24,50,74,91,120,201))) {

                    # HD 51163 - Colormaq
                    echo "<select name='defeito_$i' id='defeito_$i' onblur='Verifica_dev_obrig($i)' class='frm' style='width:";

                    if ($login_fabrica == 6) {
                        echo "220px;";
                    } else {
                        echo "150px;";
                    }

                    if ($login_fabrica == 74) {
                        echo "' onfocus='defeitoPeca(document.frm_os.peca_$i.value,$i);'";
                    } else {
                        echo "' onfocus='defeitoLista(document.frm_os.peca_$i.value,$i,$os);'";
                    }

                    echo "' onfocus='defeitoLista(document.frm_os.peca_$i.value,$i,$os);'";

                    if ($login_fabrica == 50) {
                        echo " onClick='javascript:checarComunicado($i);'  ";
                    }

                    echo " >";
                    echo "<option id='op_$i' value=''></option>";

                    if (strlen($defeito[$i]) > 0) {

                        $sql = "SELECT tbl_defeito.defeito, tbl_defeito.descricao,
                                    tbl_defeito.codigo_defeito
                                FROM   tbl_defeito
                                WHERE  tbl_defeito.fabrica = $login_fabrica
                                AND    tbl_defeito.defeito = $defeito[$i]
                                AND    tbl_defeito.ativo IS TRUE
                                ORDER BY descricao";

                        $res = pg_query($con,$sql);

                        if (pg_num_rows($res) > 0) {

                            echo "<option value='" . pg_fetch_result($res,0,defeito) . "' SELECTED>";

                            if (($login_fabrica == 50) and (strlen(trim (pg_fetch_result($res,0,codigo_defeito))) > 0)) {

                                echo pg_fetch_result($res,0,codigo_defeito);
                                echo " - " ;

                            }

                            echo pg_fetch_result($res,0,descricao)."</option>";

                        }

                    }

                    echo "</select>";

                } else {

                    echo "<select class='frm' size='1' name='defeito_$i' id='defeito_$i' $block_item>";
                    echo "<option selected></option>";

                    $rows = 0;
                    if ($login_fabrica == '30') {
                        $sql = "
                            SELECT  tbl_defeito.descricao,
                                    tbl_defeito.defeito,
                                    tbl_defeito.codigo_defeito
                            FROM    tbl_defeito
                            JOIN tbl_peca_defeito ON tbl_peca_defeito.defeito = tbl_defeito.defeito
                            JOIN tbl_familia_peca ON tbl_familia_peca.familia_peca = tbl_peca_defeito.familia_peca
                            JOIN tbl_peca_familia ON tbl_peca_familia.familia_peca = tbl_familia_peca.familia_peca
                            JOIN tbl_peca ON tbl_peca.peca = tbl_peca_familia.peca
                            WHERE tbl_defeito.fabrica = $login_fabrica
                            AND tbl_defeito.ativo = 't'
                            AND tbl_peca.referencia = '$peca[$i]'
                            ORDER BY tbl_defeito.descricao
                        ";
                        $res = pg_query($con,$sql);
                        $rows = pg_num_rows($res);
                    }

                    if ($rows == 0) {
                        $sql = "SELECT *
                                FROM   tbl_defeito
                                WHERE  tbl_defeito.fabrica = $login_fabrica
                                AND    tbl_defeito.ativo IS TRUE
                                ORDER BY descricao";

                        $res = pg_query($con,$sql) ;
                    }

                    for ($x = 0; $x < pg_num_rows($res); $x++) {

                        echo "<option ";
                        if ($defeito[$i] == pg_fetch_result($res,$x,defeito)) echo " selected ";
                        echo " value='" . pg_fetch_result($res,$x,defeito) . "'>" ;

                        if (strlen(trim (pg_fetch_result($res,$x,codigo_defeito))) > 0) {
                            echo pg_fetch_result($res,$x,codigo_defeito) ;
                            echo " - " ;
                        }

                        echo pg_fetch_result($res,$x,descricao) ;
                        echo "</option>";

                    }

                    echo "</select>";

                }

                /*INTEGRIDADE DE PEÇAS TERMINA AQUI - TAKASHI HD 1950*/
                echo "</td>\n";

            }

            echo "<td align='center' bgcolor='$cor_coluna'>";


            /*INTEGRIDADE DE PEÇAS x SOLUÇÃO COMECA AQUI - TAKASHI HD 2504*/

            if (in_array($login_fabrica,array(6,125))) {
                echo "<select class='frm' size='1' name='servico_$i' id='servico_$i' style='width:170px;' onfocus='servicoLista(document.frm_os.peca_$i.value,$i);'  ";
                if($login_fabrica == 125){
                    echo " onchange='adiciona_linha($(this).attr(\"alt\"));showAnexoPecaCritica($(this).val(),{$i});verificaPecaCritica($(this).val(),{$i},{$_GET['os']})'";
                }
                echo "rel='servicos_realizados' alt='$i'>";
                if($login_fabrica == 125){
                    $peca_ant="";
                    $peca_atual = $peca[$i];
                }

                echo "<option selected></option>";
                if (!empty($servico[$i])){
                    $sql = "SELECT  tbl_servico_realizado.descricao,
                                    tbl_servico_realizado.servico_realizado
                            FROM    tbl_servico_realizado
                            WHERE   tbl_servico_realizado.fabrica           = $login_fabrica
                            AND     tbl_servico_realizado.ativo             IS TRUE
                            AND     tbl_servico_realizado.servico_realizado = $servico[$i]
                      ORDER BY      descricao";
                    $res = pg_query($con,$sql) ;
                    if(pg_num_rows($res)>0){
                        if($login_fabrica == 125){
                           //verifica se peça é critica
                            $sqlPecaCritica = " SELECT  referencia
                                                FROM    tbl_peca
                                                WHERE   fabrica                 = $login_fabrica
                                                AND     tbl_peca.referencia     = '{$peca[$i]}'
                                                AND     tbl_peca.peca_critica   IS TRUE";
                            $resPecaCritica = pg_query($con, $sqlPecaCritica);

                            if(pg_num_rows($resPecaCritica) > 0){
                                $amazonTC->getObjectList("peca_critica-{$os}-{$peca[$i]}-{$i}",false,"","");
                                $object = $amazonTC->files[0];
                                if(!(strlen($object) > 0) ){
                                    $arrPecaCriticaSemFoto[] = array('i' => $i, "referencia" => $peca[$i], "servico"=>$servico[$i]);
                                }else{
                                    //tem foto passa o servico
                                    $arrPecaCriticaGeraPedido[$i] = $servico[$i];
                                }
                            }
                        }
                        echo "<option id='op_$i' value='" . pg_fetch_result($res,0,servico_realizado) . "' SELECTED>".pg_fetch_result($res,0,descricao)."</option>";

                    }
                }

                echo "</select>";


            } else {

                if(in_array($login_fabrica,array(74,134))){
                    #3150158
                    $onchange_limpa_movimentacao = (in_array($login_fabrica,array(74))) ? "onChange='limpaMovimentacaoEstoque($i)'": "";
                    if($login_fabrica == 134 && $controla_estoque != "t"){
                        $onchange_limpa_movimentacao = (in_array($login_fabrica,array(134))) ? "onChange='verificaEstoqueMinimo($(\"#peca_$i\").val());limpaMovimentacaoEstoque($i)'": $onclick_limpa_movimentacao;
                    }
                }
                if($login_fabrica == 50){ //HD-3246942
                    $comunicado_fora_garantia = "onChange='comunicado_fora_garantia($i);'";
                }

                echo "<select class='frm' size='1' name='servico_$i' id='servico_$i' rel='servicos_realizados' $block_item alt='".($i)."' $onchange_limpa_movimentacao $comunicado_fora_garantia ";

                if ($login_fabrica == 3) echo "style='width: 350px";

                if (in_array($login_fabrica,array(46,52,104,115,116,117,120,201,121,122,123,124,125,126,127,128))) {

                    echo " onchange='adiciona_linha($(this).attr(\"alt\"));'";
                }
                if ($login_fabrica == 45 or $login_fabrica ==24) {
                    echo " onchange='mostraOrcamento(this.value,$i); adiciona_linha($(this).attr(\"alt\"));' ";
                }
                if($login_fabrica == 74){
                    echo " onfocus='listaServico(document.frm_os.defeito_$i.value,$i,'');'";
                }
                if(in_array($login_fabrica,[120,201])){
                    echo " onfocus='listaServico(document.frm_os.defeito_$i.value,$i,document.frm_os.peca_$i.value);'";
                }
                if($login_fabrica == 131){
                    echo " onfocus='listaServico(document.frm_os.defeito_constatado_hidden.value,$i,\"\");'";
                }

        echo ">";

    if($login_fabrica <> 94){
        echo "<option id='op_$i' value='' selected>Selecione Serviço</option>";
    }else if($login_fabrica == 94 AND $posto_interno === false){
        echo "<option id='op_$i' value='' selected>Selecione Serviço</option>";
    }

    if($login_fabrica == 134 and $controla_estoque <> 't'){
        $cond_recompra = " AND tbl_servico_realizado.peca_estoque is not true ";
    }

        $sql = "SELECT *
                FROM   tbl_servico_realizado
                WHERE  tbl_servico_realizado.fabrica = $login_fabrica
                $cond_recompra ";

        if ($login_fabrica == 30) {
            $sql_posto = "SELECT tipo_posto
                            FROM tbl_posto_fabrica
                            WHERE fabrica = {$login_fabrica}
                            AND posto = {$login_posto}";
            $res_posto = pg_query($con, $sql_posto);

            $xtipo_posto = pg_fetch_result($res_posto, 0, "tipo_posto");

            if ($xtipo_posto == 368) {
                $sql .= " AND tbl_servico_realizado.servico_realizado NOT IN (549) ";
            }

        }

        if ($login_pede_peca_garantia == 't' AND !in_array($login_fabrica,array(1,24,11,15,30,46,52,85,42,91,72,95,104,115,116,117,120,201,121,122,123,124,125,126,129,132,139,141,144,172))){
            $sql .= "AND tbl_servico_realizado.descricao NOT ILIKE 'troca%' ";
        }

        if($login_fabrica == 42 AND in_array($tipo_atendimento,array(133,134))){
            $sql .= "AND tbl_servico_realizado.descricao <> 'Troca do Acessório' ";
        }
        if($login_fabrica == 42){
            if($prestacao_servico != 't'){
                $sql .= "   AND tbl_servico_realizado.descricao NOT LIKE '%(Gera Pedido)'
                            AND tbl_servico_realizado.gera_pedido IS NOT TRUE
                ";
            }else{
              $sql .= "  AND tbl_servico_realizado.servico_realizado NOT IN(621,10611)";
            }
        }
        /* HD 415550 */
        if($login_fabrica == 94) {

            $val_posto_interno = ($posto_interno === true) ? 'TRUE' : 'FALSE';
            $sql .= " AND posto_interno IS " . $val_posto_interno . " ";

        }
        /* HD 415550 - FIM */

        if ($login_fabrica == 1) {

            if ($login_reembolso_peca_estoque == 't') {
                $sql .= "AND (tbl_servico_realizado.descricao NOT ILIKE 'troca%' ";
                $sql .= "OR tbl_servico_realizado.descricao ILIKE 'subst%') ";
                if (strlen($linha) > 0) $sql .= " AND (tbl_servico_realizado.linha = '$linha' OR tbl_servico_realizado.linha is null) ";
            } else {
                $sql .= "AND (tbl_servico_realizado.descricao ILIKE 'troca%' ";
                $sql .= "OR tbl_servico_realizado.descricao NOT ILIKE 'subst%') ";
            }
        }

        if ($login_fabrica == 20) $sql .=" AND tbl_servico_realizado.solucao IS TRUE ";

        if (strlen($os_revenda) == 0) {
            $sql .=" AND tbl_servico_realizado.descricao NOT ILIKE '%pedido Faturado%'  ";
            if ($login_fabrica <> 3 and $login_fabrica <> 104 and $login_fabrica <> 74){
                $sql .= " AND tbl_servico_realizado.descricao NOT ILIKE '%peça do Estoque%' ";
            }
            if($login_fabrica == 134){
                if($controla_estoque == "t"){
                    $sql .= " AND tbl_servico_realizado.descricao NOT ILIKE '%Troca de peça%'  ";
                }
            }
        }


        if ($login_fabrica == 40) {
            $sqlf = " SELECT familia
                    FROM tbl_os
                    JOIN tbl_produto USING(produto)
                    WHERE os = $os";

            $resf    = pg_query($con,$sqlf);
            $familia = pg_fetch_result($resf,0,familia);

            if (!in_array($familia,array(810,2462,2463))) {
                $sql.= " AND tbl_servico_realizado.descricao not ilike '%recarga de g%' ";
            }
        }

        // Samuel 26/12/2008 - nao deixar o servico realizado 733 usado para troca de produto.
        // Quando for trocar o produto, trocar o servico realizado 673 para 733, assim não vai
        // embarcar novamente peças canceladas.

        if(!empty($os_item[$i]) AND $login_fabrica == 74){
             $sql .= "AND (tbl_servico_realizado.ativo OR tbl_servico_realizado.peca_estoque)";
        }elseif(!in_array($login_fabrica, [35,123])){
            $sql .= " AND tbl_servico_realizado.ativo  IS TRUE ";
        }

        if(in_array($login_fabrica, [11,123,172])){
            if($servico_descricao[$i] == 'Cancelado'){
                $sql .= " AND tbl_servico_realizado.descricao = 'Cancelado' ";
            }elseif(strlen(trim($servico[$i]))>0){
                $sql .= " AND tbl_servico_realizado.servico_realizado = ".$servico[$i];
            }else{
                $sql .= " AND tbl_servico_realizado.ativo  IS TRUE ";
            }
        }
        

        $sql .= " AND tbl_servico_realizado.servico_realizado NOT IN  (733)";

                if($login_fabrica == 91){ //HD 367935
                        $sqlServico = "SELECT tbl_posto_fabrica.tipo_posto ,
                                       tbl_tipo_posto.posto_interno
                                    FROM tbl_posto_fabrica
                                    JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto
                                      AND tbl_posto_fabrica.fabrica = $login_fabrica
                                    WHERE tbl_posto_fabrica.posto = $login_posto
                                    AND tbl_tipo_posto.descricao = 'Rede Autorizada'";

                        $resServico = pg_exec($con,$sqlServico);

                        if (pg_numrows($resServico) > 0) {
                            $sql .=" AND tbl_servico_realizado.descricao <> 'Requisição de Peças'  ";
                        }

                }

                if($login_fabrica == 42 and $tipo_atendimento == 104){
                    $sqlServicoRealizado = ',621';
                }else if($login_fabrica == 42 and $tipo_atendimento != 104){
                    $sqlServicoRealizado = ',10972';
                }

                $sql .= " AND tbl_servico_realizado.servico_realizado not in (4247,4289{$sqlServicoRealizado})";

                if($login_fabrica == 42 and $tipo_atendimento <> 104){
                     $sql .= " AND tbl_servico_realizado.garantia_acessorio IS NOT TRUE";
                }

                if (strlen($linha) > 0) $sql .= " AND (tbl_servico_realizado.linha = '$linha' OR tbl_servico_realizado.linha is null) ";

                if($login_fabrica == 30 AND !empty($servico[$i])){
                    $sql .= " OR tbl_servico_realizado.servico_realizado = {$servico[$i]} ";
                }

                if($login_fabrica == 35 ){
                    if( $troca_de_peca[$i] == 't' AND $peca_estoque[$i] == 't'){
                    $sql .= " AND tbl_servico_realizado.troca_de_peca IS TRUE
                              AND  tbl_servico_realizado.peca_estoque IS TRUE ";
                    }else{
                        $sql .= " AND tbl_servico_realizado.ativo   IS TRUE ";
                    }
                }

                $sql .= " ORDER BY descricao ";

                if($login_fabrica == 131){#2913367

                    $sqld = "SELECT  tbl_defeito_constatado.codigo
                        FROM tbl_os_defeito_reclamado_constatado
                        JOIN tbl_defeito_constatado USING (defeito_constatado)
                        WHERE tbl_os_defeito_reclamado_constatado.os = $os";
                    $resd = pg_query($con,$sqld);

                    if(pg_num_rows($resd) > 0){
                        $count_defeito = pg_num_rows($resd);
                        $array_defeitos = array();

                        for ($d=0; $d < $count_defeito; $d++) {
                            $array_defeitos[] = "'".pg_fetch_result($resd, $d, 'codigo')."'";
                        }
                        $xdefeito_constatados = implode(',', $array_defeitos);
                        if(count($array_defeitos) > 0) {
                            $sqld2 = "SELECT  defeito
                                FROM tbl_defeito
                                WHERE fabrica = $login_fabrica
                                AND   codigo_defeito in ($xdefeito_constatados)";
                            $resd2 = pg_query($con,$sqld2);
                            if(pg_num_rows($resd2) > 0) {
                                $xdefeitos = pg_fetch_all_columns($resd2);
                                $all_defeitos = implode(",",$xdefeitos);

                                $sql = "SELECT DISTINCT  tbl_servico_realizado.descricao,
                                    tbl_servico_realizado.servico_realizado
                                    FROM  tbl_defeito_servico_realizado
                                    JOIN  tbl_servico_realizado using(servico_realizado)
                                    JOIN  tbl_defeito on tbl_defeito.defeito = tbl_defeito_servico_realizado.defeito
                                    AND   tbl_defeito_servico_realizado.defeito in ($all_defeitos)
                                    AND   tbl_defeito.fabrica = $login_fabrica
                                    WHERE tbl_defeito.ativo IS TRUE
                                    AND   tbl_defeito_servico_realizado.ativo IS TRUE
                                    AND   tbl_servico_realizado.ativo IS TRUE
                                    ORDER BY tbl_servico_realizado.descricao";
                            }
                        }
                    }
                }
                
                $res = pg_query($con,$sql) ;

                if (pg_num_rows($res) == 0 && ($login_fabrica != 94 && $posto_interno !== true ) ) {

                       $sql = "SELECT *
                            FROM   tbl_servico_realizado
                            WHERE  tbl_servico_realizado.fabrica = $login_fabrica ";

                    if ($login_pede_peca_garantia == 't' AND !in_array($login_fabrica,array(1,24,15,30))) {
                        $sql .= "AND tbl_servico_realizado.descricao NOT ILIKE 'troca%' ";
                    }

                    if ($login_fabrica == 1) {

                        if ($login_reembolso_peca_estoque == 't') {
                            $sql .= "AND (tbl_servico_realizado.descricao NOT ILIKE 'troca%' ";
                            $sql .= "OR tbl_servico_realizado.descricao ILIKE 'subst%') ";
                        } else {
                            $sql .= "AND (tbl_servico_realizado.descricao ILIKE 'troca%' ";
                            $sql .= "OR tbl_servico_realizado.descricao NOT ILIKE 'subst%') ";
                        }

                    }

                    if ($login_fabrica == 20) $sql .= " tbl_servico_realizado.solucao IS TRUE ";

                    if (strlen($os_revenda) == 0) {
                        $sql .=" AND tbl_servico_realizado.descricao NOT ILIKE '%pedido Faturado%' ";
                        $sql .=" AND tbl_servico_realizado.descricao NOT ILIKE '%peça do Estoque%' ";
                    }

                    if(pg_numrows($resServico) == 0){
                        $sql .=" AND tbl_servico_realizado.descricao <> 'Requisição de Peças'  ";
                    }

                    if($login_fabrica == 42 AND $tipo_atendimento <> 104){
                        $sql .= " AND tbl_servico_realizado.garantia_acessorio IS NOT TRUE ";
                    }

                    $sql .=    " AND tbl_servico_realizado.linha IS NULL";

                    $sql .= " ORDER BY descricao ";

                    $res = pg_query($con,$sql);
                }
                if($login_fabrica == 125){
                    $peca_ant="";
                    $peca_atual = $peca[$i];
                }

                if (in_array($login_fabrica,[120,201]) && !empty($peca[$i])) {
                    $sql = "
                        SELECT  tbl_servico_realizado.descricao,
                                tbl_servico_realizado.servico_realizado
                        FROM    tbl_servico_realizado
                        JOIN    tbl_peca_defeito USING(servico_realizado)
                        JOIN    tbl_peca USING(peca)
                        WHERE   defeito             = ".$defeito[$i]."
                        AND     tbl_peca.referencia = '".$peca[$i]."'
                        AND     tbl_peca.fabrica    = $login_fabrica
                    ";
                    $res = pg_query($con,$sql);
                }
                for ($x = 0; $x < pg_num_rows($res); $x++) {
                    echo "<option ";
                    if ($servico[$i] == pg_fetch_result($res,$x,servico_realizado) /*OR ($login_fabrica==5 AND pg_fetch_result($res,$x,gera_pedido)=='t')*/) {
                            if($login_fabrica == 125){
                               //verifica se peça é critica
                                $sqlPecaCritica = " SELECT  referencia
                                        FROM tbl_peca
                                        WHERE fabrica = $login_fabrica AND
                                              tbl_peca.referencia = '{$peca[$i]}' AND
                                              tbl_peca.peca_critica is true";
                                $resPecaCritica = pg_query($con, $sqlPecaCritica);

                                if(pg_num_rows($resPecaCritica) > 0){
                                    $amazonTC->getObjectList("peca_critica-{$os}-{$peca[$i]}-{$i}",false,"","");
                                    $object = $amazonTC->files[0];
                                    if(!(strlen($object) > 0) ){
                                        $arrPecaCriticaSemFoto[] = array('i' => $i, "referencia" => $peca[$i], "servico"=>$servico[$i]);
                                    }else{
                                        //tem foto passa o servico

                                        $arrPecaCriticaGeraPedido[$i] = $servico[$i];

                                    }

                                }

                            }
                                echo " selected ";
                    }
                    if (in_array($login_fabrica, [141]) && pg_fetch_result($res, $x, 'descricao') == 'Recompra') {
                        continue;
                    }
                    echo " value='" . pg_fetch_result($res,$x,servico_realizado) . "'>" ;
                    echo pg_fetch_result($res,$x,descricao) ;
                    if (pg_fetch_result($res,$x,gera_pedido) == 't' AND $login_fabrica == 6) echo " - GERA PEDIDO DE PEÇA ";
                    echo "</option>";
                }
                # HD 289283
                if($login_fabrica == 91 and $login_tipo_posto == 270) {
                    echo "<option value='10129' ";
                    if ($servico[$i] == 10129) echo " selected ";
                    echo " >Troca de peça NÃO gerando pedido</option>";
                }

                echo "</select>";
                if ($login_fabrica == 74) {
                    echo "<img id='loading_$i' style='display: none; vertical-align: middle; height: 20px; width: 20px; margin-left: 10px;' src='imagens/loading_indicator_big.gif' />";
                }
            }

            if($login_fabrica == 35){
                $displayPOPeca = ($po_peca_usa[$i] == "t") ? "block" : "none";

                echo "
                    <br />
                    <div id='po_peca_{$i}' style='display: $displayPOPeca;'>
                        <strong>PO-Peça:</strong> <input type='text' name='po_peca_{$i}' value='$po_peca[$i]' />
                    </div>
                ";
            }

            if ($login_fabrica == 3) {
                $displayQF   = ($qtde_fotos[$i] > 0 and $servico[$i] == "20") ? "block" : "none";
                $displaySLCD = ($serial_lcd[$i] == "t" and $servico[$i] == "20") ? "block" : "none";
            ?>
                <br />

                <style>
                    .loadImg {
                        width: 48px;
                        height: 48px;
                        position: relative;
                        display: none;
                    }

                    #upload_mini img {
                        width: 48px;
                        height: 48px;
                        margin-left: 10px;
                        position: relative;
                        border-width: 0.5px;
                        border-style: solid;
                        border-color: #000;
                    }
                    .link_clique{
                        color: #d90000;
                    }
                    .titulo_foto{
                        font-size: 12px;
                        margin-top: 10px;
                        background: #d90000;
                        color: #fff;
                        padding: 5px 10px;
                    }
                </style>

                <div name="upload_fotos_<?=$i?>" style="width: 100%; display: <?=$displayQF?>;" >
                    <h4 class="titulo_foto" >Upload fotos</h4><br />
                    <img class="loadImg" src="imagens/loading_indicator_big.gif" />
                    <table width="100%">
                        <tr>
                            <td colspan="100%" align="center">Dúvidas sobre este Procedimento? <a href="image/img_britania/guia_rma_rev.pdf" target="_blank" class="link_clique"><b>Clique aqui!</b></a></td>
                        </tr> 
                    <tbody id="upload_mini">

                    <?php
                        $todas_anexadas = 0;
                        $img_exemp = ["defeito_tela_inteira.png", "etiq_fabricante_display.png","etiq_fabricante_display_rasurada.png","etiq_pci_opencell.png","atencao-teste.png"];
                        $label_exemp = ["Defeito Tela Inteira", "Etiq Fabricante Display"," Etiq Fabricante Display Rasurada","Etiq PCI OpenCell","Etiq PCI OpenCell Rasurada"];
                        if ($qtde_fotos[$i] > 0) {
                            for ($k = 0; $k < $qtde_fotos[$i]; $k++) {
                                $anexa_imagem = true;

                                if ($foto_upload[$i][$k]["upload"] == "t") {
                                    $anexa_imagem = false;
                                    $todas_anexadas++;
                                }

                                if ($anexa_imagem == true) {
                                    $image_file = "image/img_britania/".$img_exemp[$k];
                                    //$image_file = "image/foto.png";

                                    if ($temp_uploaded[$i][$k]["upload"] == "t") {
                                        $temp_uploaded[$i][$k]["upload"];
                                        $ext        = $temp_uploaded[$i][$k]["ext"];
                                        $image_file = $amazonTC->getLink("thumb_{$os}-{$peca[$i]}-{$i}-{$k}.{$ext}", true, $year, $month);
                                    }

                                    echo "<tr><td><img class='img_tumb_britania_display' id='img_{$i}_{$k}' src='{$image_file}' style='cursor: pointer;' title='Clique para adicionar uma foto' onclick='javascript: if (ajax_process == false) { $(\"input[name=file_{$i}_{$k}]\").click(); } else { alert(\"Espere o upload atual finalizar\"); }' />";
                                    echo "<input type='hidden' name='temp_uploaded_{$i}_{$k}' value='".(($temp_uploaded[$i][$k]["upload"] == "t") ? "t" : "f")."' />";
                                    echo "<input type='hidden' name='temp_uploaded_ext_{$i}_{$k}' value='{$temp_uploaded[$i][$k]["ext"]}' /></td><td>".$label_exemp[$k]."</td></tr>";
                                }
                            }

                            if(count($qtde_fotos[$i]) == $todas_anexadas){
                                echo "Todas as imagens da peça já foram anexadas";
                            }
                        }
                        ?>
                    </tbody>
                    </table>
                </div>

                <span name="serial_lcd_<?=$i?>" style="display: <?=$displaySLCD?>;">
                    <br />
                    Serial da Peça:&nbsp;
                    <span id="input_serial_lcd" style="display: inline;">
                        <input type='text' name='txt_serial_lcd_<?=$i?>' value="<?=$txt_serial_lcd[$i]?>" />
                    </span>
                </span>
            <?
            }

            echo "</td>\n";

            if ($login_fabrica == 3 or $login_fabrica == 45 or $login_fabrica == 24) {

                echo "<td align='center' nowrap>";

                if (($login_fabrica == 3 or $login_fabrica == 45 or $login_fabrica == 24) AND ($servico[$i] == 643 OR $servico[$i] == 644 or $servico[$i] == 4247 or $servico[$i] == 4289)) {
                    echo " <div id='orcamento_mostra_$i'>";
                } else {
                    echo " <div id='orcamento_mostra_$i' style='font-size:10px; display: none'>";
                }
                echo "R$<input type='text' readonly size='5' name='preco_orcamento_$i' id='preco_orcamento_$i' value='".$preco[$i]."' onBlur='checarNumero(this)' title='Preço de Tabela da Fabrica'> - R$<input type='text' size='5' name='preco_venda_orcamento_$i' id='preco_venda_orcamento_$i' value='".$preco_venda[$i]."' onBlur='checarNumero(this)' title='Preço de venda ao Consumidor'>";
                //echo "<img  id='imagem_ajuda_$i' onMouseOut=\"HideHelp('ajuda_$i')\" onMouseOver=\"ShowHelp('ajuda_$i', 'Preço', 'Preencha este campo se esta peça será cobrada do consumidor.')\" src='imagens/help1.gif' width='24' height='16' border='0' style='display:none'><div style='display:none' id='ajuda_$i'></div>";
                echo "<a href=\"javascript:alert('Preencha este campo com o valor da peça que será utilizada para venda pelo cliente/revenda')\"><img  id='imagem_ajuda_$i' src='imagens/help1.gif' width='24' height='16' align='absmiddle' border='0' ></a>";

                echo "</div>";

                echo "</TD>";

            }

            //HD 107982 2009-07-20 ---------------------------
            if ($login_fabrica == 24) {
                echo "<td nowrap align='center'>";
                    echo "<input type='radio' name='reparo_estoque_$i' value='peca_reposicao_estoque'";
                    if($peca_reposicao_estoque[$i]=="t") echo "checked";
                    echo " title='Repor Estoque'>";
                    echo "<font size='-1'>Repor Estoque</font>";
                    echo "&nbsp;";
                    echo "<input type='radio' name='reparo_estoque_$i' value='aguardando_peca_reparo'";
                    if($aguardando_peca_reparo[$i]=="t") echo "checked";
                    echo " title='Aguardando peça para reparo'>";
                    echo "<font size='-1'>Aguardando peça para reparo</font>";
                echo "</td>";
            }
            //----------------------------------------------

            //HD 38818 4/9/2008 ----------------------------
            if ($informatica == 't' AND $login_fabrica != 127) {
                echo "</td>";
                echo "<td align='center'>";
                    echo "<INPUT TYPE='text' NAME='peca_serie_trocada_$i' value='$peca_serie_trocada[$i]' size='13' maxlength='20'>";
                echo "</td>";
            }
            //----------------------------------------------
            echo "</tr>\n";

            if($login_fabrica == 50){
                echo $msg_dev_obrig;
                echo "<tr><td id='dev_obrig_$i' colspan='4' style='color:#ff0000; display:none '>PEÇA DE RETORNO OBRIGATÓRIO, FAVOR NÃO DESCARTA-LA E DEVOLVE-LA AO FABRICANTE.</td></tr>";
            }

            if ($login_fabrica==30 ){
                echo "<tr>";
                    echo "<td colspan='100%'>";
                        echo "<div style='display:none;width:100%' rel=''  id='tr_estoque_$i'>";
                        echo "</div>";
                    echo "</td>";
                echo "</tr>";
            }

            if (in_array($login_fabrica, array(30)) && (in_array($i, $linhaPecaDuplicada) || strlen($obs_os_item[$i]) > 0)){
                echo "<tr>";
                    echo "<td colspan='3' align='right'>Motivo do lançamento duplicado de peças:</td>";
                    echo "<td colspan='3'>";
                        echo "<textarea name='obs_os_item_$i' cols='64' rows='3' maxlength='255' class='frm'>$obs_os_item[$i]</textarea>";
                    echo "</td>";
                echo "</tr>";
            }

            if ( $login_fabrica==120 ){

                echo "<tr>";
                    echo "<td colspan='100%'>";
                        echo "<input type='hidden' name='qtde_estoque_$i' id='qtde_estoque_$i' value='{$qtde_estoque[$i]}'>";
                        echo "<div style='display:none;width:100%;color:#FF0000; text-align:center;font-weight:bold;' rel=''  id='div_estoque_$i'>";
                        echo "</div>";
                    echo "</td>";
                echo "</tr>";
            }

            if (in_array($login_fabrica,array(3,15,24,30,91))) {
                echo "<tr>
                        <td colspan='100%'>

                            <div id='kit_peca_$i'><input type='hidden' name='kit_peca_$i' value='kit_peca_$i'>";
                if (!empty($xkit_peca[$i])) {

                   $sql = " SELECT tbl_peca.peca      ,
                                    tbl_peca.referencia,
                                    tbl_peca.descricao,
                                    tbl_kit_peca_peca.qtde
                            FROM    tbl_kit_peca_peca
                            JOIN    tbl_peca USING(peca)
                            WHERE   fabrica = $login_fabrica
                            AND     kit_peca = $xkit_peca[$i]
                            ORDER BY tbl_peca.peca";
                    $res = pg_query($con,$sql);
                    if (pg_num_rows($res) > 0) {
                            echo "<table>";
                                if ($login_fabrica == 91 || $login_fabrica <> 3) {
                                    echo "<tr>
                                            <td colspan='100%'>
                                                <input type='hidden' name='kit_kit_peca_$i' value='$xkit_peca[$i]'>
                                            </td>
                                        </tr>";
                                }
                        for ($k = 0; $k < pg_num_rows($res); $k++) {
                            $kit_peca_peca = pg_fetch_result($res,$k,'peca');
                            $kit_peca_qtde = pg_fetch_result($res,$k,'qtde');

                            if ($_POST["kit_peca_$kit_peca_peca"]) {
                                $checked = "checked";
                            } else {
                                $checked = "";
                            }

                            echo "<tr style='font-size: 11px'>";
                                echo "<td>";
                                echo "<input type='".((in_array($login_fabrica,array(3,15,30,91))) ? 'hidden' : 'checkbox')."' name='kit_peca_$kit_peca_peca' $checked value='$kit_peca_peca'>";
                                    echo "<input type='text' name='kit_peca_qtde_$kit_peca_peca' id='kit_peca_qtde_$kit_peca_peca' value='" . $_POST["kit_peca_qtde_$kit_peca_peca"] . "' size='5' onkeyup=\"re = /\D/g; this.value = this.value.replace(re, '');\" readonly='readonly'> x ";
                                echo "</td>";
                                echo "<td> - ";
                                echo pg_fetch_result($res,$k,'descricao');
                                echo "</td>";

                            if ($login_fabrica == 91) {

                                $sqlFor = "SELECT tbl_fornecedor_peca.fornecedor AS retorno_fornecedor_peca, tbl_fornecedor.nome AS retorno_fornecedor_peca_nome
                                            FROM tbl_fornecedor_peca
                                            JOIN tbl_fornecedor  ON  tbl_fornecedor.fornecedor = tbl_fornecedor_peca.fornecedor AND tbl_fornecedor_peca.peca = $kit_peca_peca
                                            WHERE tbl_fornecedor_peca.fabrica = $login_fabrica";

                                $resFor  = pg_query($con, $sqlFor);
                                $retornoFor = pg_fetch_all($resFor);
                                unset($optionFornecedor);
                                foreach($retornoFor as $chave => $v){
                                    $optionFornecedor .= "<option value='".$v['retorno_fornecedor_peca']."'>".$v['retorno_fornecedor_peca_nome']."</option>";
                                }

                                echo "<td>
                                        <select name='kit_fornecedor_$kit_peca_peca' id='kit_fornecedor_$kit_peca_peca'>
                                            <option value='' selected>Selecione um fornecedor</option>
                                            {$optionFornecedor}
                                        </select>
                                    </td>";

                                $sqlDef = " SELECT  tbl_defeito.descricao      ,
                                                    tbl_defeito.defeito        ,
                                                    tbl_defeito.codigo_defeito ,
                                                    tbl_peca_defeito.ativo
                                            FROM    tbl_peca_defeito
                                            JOIN    tbl_defeito ON  tbl_defeito.defeito = tbl_peca_defeito.defeito
                                                                AND tbl_defeito.fabrica = {$login_fabrica}
                                            JOIN    tbl_peca    ON  tbl_peca.peca       = tbl_peca_defeito.peca
                                                                AND tbl_peca.fabrica    = {$login_fabrica}
                                                                AND tbl_peca.peca       = $kit_peca_peca
                                            WHERE   tbl_peca_defeito.ativo = 't'
                                            AND     tbl_defeito.ativo      = 't'
                                    ORDER BY      tbl_peca.descricao,
                                                    tbl_defeito.descricao";

                                $resDef  = pg_query($con, $sqlDef);
                                $retornoDef = pg_fetch_all($resDef);
                                unset($optionDefeito);

                                foreach($retornoDef as $chave => $v){
                                    $optionDefeito .= "<option value='".$v['defeito']."'>".$v['codigo_defeito']." - ".$v['descricao']."</option>";
                                }

                                echo "<td>
                                        <select name='kit_defeito_$kit_peca_peca' id='kit_defeito_$kit_peca_peca'>
                                            <option value='' selected>Selecione um defeito</option>
                                            ".$optionDefeito."
                                        </select>
                                    </td>";
                            }
                            echo "</tr>";
                        }
                        echo "<tr><td><input type='button' name='remove_kit' value='X' onclick='limpa_kit($i)'></td></tr>";
                        echo "</table>";
                    }
                }
                    echo "</div>

                    </td>
                </tr>";
            }
            $offset = $offset + 1;
        }

        echo "</table>";

        ?>

    </td>
</tr>
<?php
    if(!empty($os)){
?>
        <script type='text/javascript'>
            <?php
            if(!in_array($login_fabrica,array(24,129,42,72))){
            ?>
                $(function(){
                    var linhas = $("#tablemostrar tr[id^=mostrar]").length;
                    adiciona_linha(linhas);

                    <?php if(in_array($login_fabrica,[120,201])){ ?>
                            var linhas = $("#tablemostrar tr[id^=mostrar]").length;
                            for(z = 0; z < linhas; z++){
                                verifica_estoque_peca(z);
                            }
                    <?php } ?>
                });
            <?php } ?>

<?php
    }
    if ($login_fabrica == 129 && $itemTemPedido > 0) {
?>
$(function(){
    $("#tablemostrar").hide();
});
<?php
    }
?>
        </script>
</table>
<!-- FIM DO FORMULÁRIO -->

<?php
//}//tipo atendimento de instalação termina aqui?>

<table>
    <tr>
        <td><BR></td>
    </tr>
</table><?php

if ($login_fabrica == 3 AND $linha == 335 AND $login_posto == 6359) { //HD 20682 20/6/2008

    $sql = "SELECT tbl_os.os             ,
                tbl_os.posto             ,
                tbl_os.tipo_atendimento  ,
                (SELECT status_os FROM tbl_os_status WHERE tbl_os.os = tbl_os_status.os AND status_os IN (98,99,101) ORDER BY data DESC LIMIT 1) AS status_os
            FROM tbl_os
            WHERE tbl_os.os               = $os
            AND   tbl_os.posto            = $login_posto
            ";

    $res = pg_query($con, $sql);

    if (pg_num_rows($res) > 0) {

        $status_os         = pg_fetch_result($res, 0, 'status_os');
        $tipo_atendimento  = pg_fetch_result($res, 0, 'tipo_atendimento');

        if ($tipo_atendimento == 37) {

            $domicilio = "checked";

            if ($status_os == 98) {
                $campos_domicilio = " readonly='readonly' ";
                $check_domicilio  = " disabled ";
                $alerta_domicilio = " onClick=\"alert('A OS foi para aprovação. Aguarde ser analisada.')\" ";
            }

            if ($status_os == 99) {
                $campos_domicilio = " readonly='readonly' ";
                $alerta_domicilio = " onClick=\"alert('Não é possÃ­vel alterar essa informação. A Kilometragem já foi aprovada!')\" ";
            }

        } else {
            $mostra_dados_domicilio = " display:none; ";
        }

        if ($status_os == 99) {
            echo "<input type='hidden' name='atendimento_domicilio' value='t'>";
        } else {?>
            <INPUT TYPE='checkbox' <?=$check_domicilio?> NAME='atendimento_domicilio' value='t' <?=$domicilio?> onClick="mostraDomicilio(this,'tbl_domicilio')" >
            <font size='1' face='Geneva, Arial, Helvetica, san-serif'>Atendimento Domicilio</font><?php
        }
        echo "<INPUT TYPE='hidden' NAME='status_os' VALUE='$status_os'>";?>
            <table width='800' align='center' border='1' bordercolor='#666666' cellspacing='0' cellpadding='2' style='<?=$mostra_dados_domicilio?>' id='tbl_domicilio'>
            <tr>
                <td width='100%' align='center'  bgcolor='#666666' colspan='4'>
                    <font size='2' face='Geneva, Arial, Helvetica, san-serif' color='#FFFFFF'>Atendimento Domicilio</font>
                </td>
            </tr>
            <tr>
                <td>
                    <table width='795' align='center' border='0' cellspacing='0' cellpadding='2'>
                        <tr>
                            <td width='25%'>
                                <FONT SIZE="1">Kilometragem:</FONT>
                                <INPUT TYPE="text" NAME="qtde_km" value="<?=$qtde_km ?>" size="5" maxlength="10" class="frm" <?=$campos_domicilio?> <?=$alerta_domicilio?> />
                            </td><?php
                            //hd 24288
                            //<td >
                            //    <FONT SIZE="1">Número de Autorização:</FONT>
                            //    <INPUT TYPE="text" NAME="autorizacao_domicilio" value="<? echo $autorizacao_domicilio ?><?//" size="10" maxlength="15" class="frm" <?=$campos_domicilio?> <?//=$alerta_domicilio?><?//>
                            //</td>?>
                            <td nowrap>
                                <FONT SIZE="1">Justificativa da Kilometragem:</FONT>
                                <INPUT TYPE="text"  NAME="justificativa_autorizacao"  value="<? echo $justificativa_autorizacao ?>" size="70" maxlength="255" class="frm" <?=$campos_domicilio?> <?=$alerta_domicilio?>>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table><?php

        echo '<table>';
            echo '<tr>';
                echo '<td><BR></td>';
            echo '</tr>';
        echo '</table>';

        $sql = "SELECT  tbl_os.os                            ,
                        (SELECT tbl_status_os.descricao FROM tbl_status_os where tbl_status_os.status_os = tbl_os_status.status_os) AS status_os ,
                        tbl_os_status.observacao              ,
                        to_char(tbl_os_status.data, 'dd/mm/yyy') AS data
                        FROM tbl_os
                LEFT JOIN tbl_os_status USING(os)
                WHERE tbl_os.os    = $os
                AND   tbl_os.posto = $login_posto
                AND   tbl_os_status.status_os IN(
                        SELECT status_os
                        FROM tbl_os_status
                        WHERE tbl_os.os = tbl_os_status.os
                        AND status_os IN (98,99,101) ORDER BY data DESC
                )";

        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0) {

            echo "<table width='650' align='center' border='0' bordercolor='#666666' cellspacing='2' cellpadding='1'>";
                echo "<tr>";
                    echo "<td align='center'  bgcolor='#666666' colspan='5'>";
                        echo "<font size='2' face='Geneva, Arial, Helvetica, san-serif' color='#FFFFFF'>Historico Atendimento Domicilio</font>";
                    echo "</td>";
                echo "</tr>";
                echo "<tr>";
                    echo "<td align='center'  bgcolor='#666666'>";
                        echo "<font size='2' face='Geneva, Arial, Helvetica, san-serif' color='#FFFFFF'>Status</font>";
                    echo "</td>";
                    echo "<td align='center'  bgcolor='#666666'>";
                        echo "<font size='2' face='Geneva, Arial, Helvetica, san-serif' color='#FFFFFF'>Justificativa Autorização</font>";
                    echo "</td>";
                    echo "<td align='center'  bgcolor='#666666'>";
                        echo "<font size='2' face='Geneva, Arial, Helvetica, san-serif' color='#FFFFFF'>Data</font>";
                    echo "</td>";
                echo "</tr>";
                for ($x = 0; $x < pg_num_rows($res); $x++) {

                    $status_os  = pg_fetch_result($res, $x, 'status_os');
                    $observacao = pg_fetch_result($res, $x, 'observacao');
                    $data       = pg_fetch_result($res, $x, 'data');

                    if ($x % 2 == 0) $cor = "#B4D6E1";
                    else             $cor = "#D7D7D7";

                    echo "<tr bgcolor='$cor'>";
                        echo "<td><font size='1' face='Geneva, Arial, Helvetica, san-serif'>$status_os</font></td>";
                        echo "<td><font size='1' face='Geneva, Arial, Helvetica, san-serif'>$observacao</font></td>";
                        echo "<td align='center'><font size='1' face='Geneva, Arial, Helvetica, san-serif'>$data</font></td>";
                    echo "</tr>";

                }
            echo "</table>";

        }
    }
}?>

<table width='700' align='center' border='0' cellspacing='0' cellpadding='5'><?php
if ($login_fabrica == 19) { ?>
    <tr>
        <td height="27" valign="middle" align="center" bgcolor="#FFFFFF">
            <br>
            <FONT SIZE="1">Quilometragem:</FONT>
            <br>
            <INPUT TYPE="text" NAME="qtde_km" value="<? echo $qtde_km ?>" size="5" maxlength="10" class="frm">
            <br><br>
        </td>
    </tr><?php
}

if (($ip == "201.27.214.156") or ($ip == "200.228.76.116")) {

    if ($login_fabrica == 15) {?>
        <tr>
            <td height="27" valign="middle" align="center" colspan="3" bgcolor="#FFFFFF">
                <table width='40%' align='center' border='0' cellspacing='0' cellpadding='3' bgcolor="#B63434">
                    <tr>
                        <td valign="middle" align="RIGHT">
                            <FONT SIZE="1" color='#FFFFFF'>***Data Fechamento:   </FONT>
                        </td>
                        <td valign="middle" align="LEFT">
                            <INPUT TYPE="text" NAME="data_fechamento" value="<?=$data_fechamento;?>" size="12" maxlength="10" class="frm">
                            <br />
                            <font size='1' color='#FFFFFF'>dd/mm/aaaa</font>
                        </td>
                    </tr>
                </table>
            </td>
        </tr><?php
    }

}

if (($login_fabrica == 3 or $login_fabrica == 45 or $login_fabrica == 24) AND $login_posto == 6359) {?>
    <tr>
        <td height="27" valign="middle" align="center" colspan="3" bgcolor="#FFFFFF">
            <div id='orcamento_mao_obra' <? if (strlen($orcamento)==0){ echo "style='display:none'";} ?>>
            <table width='55%' align='center' border='0' cellspacing='0' cellpadding='3' bgcolor="#244D8A">
                <tr>
                    <td valign="middle" align="RIGHT">
                        <FONT SIZE="1" color='#FFFFFF'>Valor da Mão de Obra do Orçamento: </FONT>
                    </td>
                    <td valign="middle" align="LEFT">
                        <INPUT TYPE="text" NAME="valor_mo_orcamento" value="<? echo $valor_mo_orcamento; ?>" size="12" maxlength="10" class="frm" onBlur='checarNumero(this)' />
                        <a href="javascript:alert('Valor de Mão de Obra do Orçamento somente para O.S. que não utilizarem peças em garantia.')"><img  id='imagem_ajuda_$i' src='imagens/help1.gif' width='24' height='16' align='absmiddle' border='0' /></a>
                    </td>
                </tr>
                <tr>
                    <td colspan='2' align='center'>
                        <FONT SIZE="1" color='#FFFFFF'>* O Valor de mão de obra do orçamento é apenas para controle do posto. Este valor não será lançado em extrato.
                        </FONT>
                    </td>
                </tr><?php
                if ($login_fabrica != 45 and $login_fabrica != 24) {?>
                    <tr>
                        <td valign="middle" align="RIGHT">
                            <FONT SIZE="1" color='#FFFFFF'>Aprovado: </FONT>
                        </td>
                        <td valign="middle" align="LEFT">
                            <FONT SIZE="1" color='#FFFFFF'>
                                Sim
                                <INPUT TYPE="radio" NAME="orcamento_aprovado" value='' <? if ($aprovado=='t'){echo " CHECKED ";}?> />
                                &nbsp;&nbsp;
                                Não
                                <INPUT TYPE="radio" NAME="orcamento_aprovado" value='t' <? if ($aprovado=='f'){echo " CHECKED ";}?> />
                            </FONT>
                        </td>
                    </tr>
                    <tr>
                        <td colspan='2' align='center'>
                            <b style='color:#FFFFFF;font-size:12px'><?php
                                if ($aprovado == 't') {
                                    echo "Orçamento aprovado em $data_aprovacao";
                                } else if ($aprovado == 'f') {
                                    echo "Orçamento <b style='color:red'>REPROVADO</b> em $data_reprovacao pelo motivo: '$motivo_reprovacao' ";
                                } else {
                                    echo "Orçamento não aprovado/reprovado";
                                }?>
                            </b>
                        </td>
                    </tr><?php
                }?>
            </table>
        </td>
    </tr><?php
}

if ($login_fabrica == 96 and $tipo_atendimento == 93) {

    $sql = " SELECT
            total           ,
            total_horas     ,
            prazo_retorno
        FROM tbl_orcamento_os_fabrica
        WHERE os = $os
            AND   fabrica = $login_fabrica";

    $res = pg_query($con,$sql);

    if (pg_num_rows($res) > 0) {
        $prazo_retorno   = pg_fetch_result($res,0,'prazo_retorno');
        $total_orcamento = pg_fetch_result($res,0,'total');
        $total_horas     = pg_fetch_result($res,0,'total_horas');
        $total_orcamento = number_format($total_orcamento,2,",",".");
    }?>

    <table width='40%' align='center' border='0' cellspacing='0' cellpadding='3' >
        <tr>
            <td valign="middle" align="RIGHT">
                <FONT SIZE="1" >Total do Orçamento</FONT>
            </td>
            <td valign="middle" align="LEFT">
                <INPUT TYPE="text" NAME="total_orcamento" rel='numero' value="<?=$total_orcamento;?>" size="12" maxlength="10" class="frm">
            </td>
        </tr>
        <tr>
            <td valign="middle" align="RIGHT">
                <FONT SIZE="1" >Total Horas</FONT>
            </td>
            <td valign="middle" align="LEFT">
                <INPUT TYPE="text" NAME="total_horas" rel='numero' value="<?=$total_horas;?>" size="12" maxlength="10" class="frm">
            </td>
        </tr>
        <tr>
            <td valign="middle" align="RIGHT">
                <FONT SIZE="1" >Prazo de Retorno</FONT>
            </td>
            <td valign="middle" align="LEFT">
                <input type="text" name="prazo_retorno" value="<?=$prazo_retorno;?>" size="12" maxlength="3" class="frm">
            </td>
        </tr>
    </table>
    <br/><?php

}

#HD 1263047 Laudo Técnico Rinnai
if ($login_fabrica == 129) {
    if (!$_POST) {
        $sql = "SELECT
                    titulo AS key,
                    observacao AS value
                FROM tbl_laudo_tecnico_os
                WHERE fabrica = $login_fabrica
                AND os = $os";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0) {
            for ($i = 0; $i < pg_num_rows($res); $i++) {
                $key   = pg_fetch_result($res, $i, "key");
                $value = pg_fetch_result($res, $i, "value");

                $laudo_tecnico[$key] = $value;
            }
        }
    }

    include_once "laudo_tecnico_rinnai.php";
}

//HD 81926
if (in_array($login_fabrica, array(1, 58))
    or ($login_fabrica == 19 and $tipo_atendimento == 2)
    or ($login_fabrica == 19 and $tipo_atendimento == 20)) {
    $sql = "SELECT tbl_laudo_tecnico_os.* FROM tbl_laudo_tecnico_os WHERE os = $os ORDER BY ordem, laudo_tecnico_os;";

    $res = pg_query($con, $sql);

    if (pg_num_rows($res) > 0) {

        echo "<br />";

        echo "<table align='center' width='700' style=' border:#485989 1px solid; font-size:12px;' border='0' borderstyle='collapse' cellspacing='3' cellpadding='3' bgcolor='#e6eef7'>";
            echo "<tr bgcolor='#596D9B' style='color:#FFFFFF;'>";
                echo "<td colspan='3' style='font-size: 12px' align='center'><b>LAUDO TÉCNICO</b></td>";
            echo "</tr>";
            echo "<tr bgcolor='#596D9B' style='color:#FFFFFF;'>";
                echo "<td>QUESTÃO</td>";
                echo "<td>AFIRMAÇÃO</td>";
                echo "<td>RESPOSTA</td>";
            echo "</tr>";

        for ($i = 0; $i < pg_num_rows($res); $i++) {

            $laudo      = pg_fetch_result($res, $i, 'laudo_tecnico_os');
            $titulo     = pg_fetch_result($res, $i, 'titulo');
            $afirmativa = pg_fetch_result($res, $i, 'afirmativa');
            $observacao = pg_fetch_result($res, $i, 'observacao');

            $cor = "#F7F5F0";

            if ($i % 2 == 0) {
                $cor = '#F1F4FA';
            }

            echo "<tr bgcolor='$cor'>";
                echo "<td align='left'><font size='-2' color='#939393'><b>$titulo</b></font></td>";
                if (strlen($afirmativa) > 0) {
                    echo "<td align='center' width='10' nowrap><font size='-3'>";
                    echo ($afirmativa == 't') ? 'Sim' : 'Não';
                    echo "</font></td>";
                } else {
                    echo "<td align='center' width='10'>&nbsp;</td>";
                }
                if (strlen($observacao) > 0) {
                    echo "<td align='left' size='350'><font size='-3'>$observacao</font></td>";
                } else {
                    echo "<td align='left' width='350'>&nbsp;</td>";
                }
            echo "</tr>";

        }

        echo "</table>";
        echo "<input type='hidden' name='digitou_laudo' id='digitou_laudo' value='s'>";

    } else {

        echo "<br />";
        echo "<table align='center' width='700' style=' border:#485989 1px solid; font-size:12px;' border='0' borderstyle='collapse' cellspacing='3' cellpadding='3' bgcolor='#e6eef7'>";
            echo "<tr bgcolor='#596D9B' style='color:#FFFFFF;'>";
                echo "<td colspan='3' style='font-size: 12px' align='center'><b>LAUDO TÉCNICO</b></td>";
            echo "</tr>";
            echo "<tr bgcolor='#596D9B' style='color:#FFFFFF;'>";
                echo "<td>QUESTÃO</td>";
                echo "<td>AFIRMAÇÃO</td>";
                echo "<td>RESPOSTA</td>";
            echo "</tr>";

        if ($login_fabrica == 19 and $tipo_atendimento <> 20) {
            $sql = "SELECT tbl_laudo_tecnico.* FROM tbl_laudo_tecnico WHERE linha = $produto_linha AND ordem NOT IN (11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27) ORDER BY ordem;";
            $res = pg_query($con,$sql);

        } elseif ($login_fabrica == 19 and $tipo_atendimento == 20) {
            $sql = "SELECT tbl_laudo_tecnico.* FROM tbl_laudo_tecnico WHERE linha = $produto_linha ORDER BY ordem;";
            $res = pg_query($con,$sql);
        } else {

            $sql = "SELECT tbl_laudo_tecnico.* FROM tbl_laudo_tecnico WHERE produto = $produto_os ORDER BY laudo_tecnico;";
            $res = pg_query($con,$sql);

            if (pg_num_rows($res) == 0) {

                $sql = "SELECT tbl_laudo_tecnico.* FROM tbl_laudo_tecnico WHERE familia = $produto_familia ORDER BY laudo_tecnico;";
                $res = pg_query($con,$sql);

            }

        }

        if (pg_num_rows($res) > 0) {

            for ($i = 0; $i < pg_num_rows($res); $i++) {

                $laudo      = pg_fetch_result($res,$i,'laudo_tecnico');
                $titulo     = pg_fetch_result($res,$i,'titulo');
                $afirmativa = pg_fetch_result($res,$i,'afirmativa');
                $observacao = pg_fetch_result($res,$i,'observacao');
                $ordem      = pg_fetch_result($res,$i,'ordem');

                #Recarrega o form
                $afirmativa_laudo = $_POST["afirmativa_$laudo"];
                $observacao_laudo = $_POST["observacao_$laudo"];
                $ordem_laudo      = $_POST["ordem_$laudo"];

                echo "<tr bgcolor='#FFFFFF'>";
                    echo "<td align='left' nowrap><font size='-2'><b>$titulo<INPUT TYPE='hidden' value='$ordem' NAME='ordem_$laudo'></b></font></td>";
                    if ($afirmativa == 't') {
                        echo "<td align='left' nowrap><font size='-2'><INPUT TYPE='radio' NAME='afirmativa_$laudo'";
                        if ($afirmativa_laudo == 't') echo "checked='checked'";
                        echo " value='t'>Sim <INPUT TYPE='radio' NAME='afirmativa_$laudo'";
                        if ($afirmativa_laudo == 'f') echo " checked='checked'";
                        echo " value='f'> Não</font></td>";
                    } else {
                        echo "<td align='left'>&nbsp;</td>";
                    }

                    if ($observacao == 't') {
                        echo "<td align='left'><font size='-2'><INPUT TYPE='text' size='50' maxlength='256' value='$observacao_laudo' NAME='observacao_$laudo'></font></td>";
                    } else {
                        echo "<td align='left'>&nbsp;</td>";
                    }

                echo "</tr>";

            }

        }

        echo "</table>";
        echo "<input type='hidden' name='digitou_laudo' id='digitou_laudo' value='n' />";

    }

}

if($login_fabrica == 52){ ?>

<table width='700' align='center' border='0' cellspacing='0' cellpadding='5' class="formulario">
<tr>
    <td  class='titulo_tabela' valign="middle">
        <label style="margin:auto;font:14px Arial">Nome do técnico</label>
    </td>
    <td  class='titulo_tabela' valign="middle">
        <label style="margin:auto;font:14px Arial">RG do técnico</label>
    </td>
</tr>
<tr>
    <td  align="center" style="padding: 10px 10px 10px 10px;">
        <input type="text" name="nome_tecnico" value="<?php echo $nome_tecnico; ?>"  />
    </td>
    <td  align="center" style="padding: 10px 10px 10px 10px;">
        <input type="text" name="rg_tecnico" value="<?php echo $rg_tecnico; ?>" maxlength="14" />
    </td>
</tr>
</table>
<br/><br />
<?php }
if($login_fabrica == 125){ ?>
<div name="container_btn_anexar_img" id='container_btn_anexar_img' >
    <span id="msg_peca_critica" style="display: none">Foi inserida uma peça crítica.<br/> Obrigatório anexar uma foto da peça danificada para uma pré-análise do fabricante <br/><br/></span>
    <?  if(strlen($msg_erro) > 0){

                //para cada item lançado, verifica se ha uma foto correspondente
                for ($i = 0; $i < $qtde_item; $i++) {
                                  //se foi inserida imagem
                    if(isset($_POST["peca_critica_{$i}"]) && strlen($_POST["peca_critica_{$i}"]) > 0 ){
                        $qtde_fotos_pecas_criticas++;

                        $os = $_POST["os"];
                        $linhaPeca = $i;
                        $referencia_peca = $_POST["peca_{$i}"];
                        $descricao_peca = $_POST["descricao_{$i}"];
                        $ext = $_POST["peca_critica_ext_{$i}"];

                        //verifica se peça é critica
                        $sqlPecaCritica = " SELECT  referencia
                                FROM tbl_peca
                                WHERE fabrica = $login_fabrica AND
                                      tbl_peca.referencia = '{$referencia_peca}' AND
                                      tbl_peca.peca_critica is true";
                        $resPecaCritica = pg_query($con, $sqlPecaCritica);
                        //se for peca critica
                        if(pg_num_rows($resPecaCritica) > 0 ){

                            $amazonTC->getObjectList("peca_critica-{$os}-{$referencia_peca}-",true,"","");

                            $pathinfo = pathinfo($amazonTC->files[0]);
                            $dadosPeca = explode("-", $pathinfo["filename"] );
                            $linhaPeca = $dadosPeca[3];
                            //se há imagem e servico gerar pedido
                            if(strlen($linhaPeca)> 0 && in_array($_POST["servico_".$i], $servicosGeramPedido) ){
                                $link = $amazonTC->getLink("thumb_".$pathinfo["basename"]);
                                ?>

                                    <!-- <div id="item_img_peca_critica_<?=$linhaPeca?>" >
                                        <span>Referência Peça: <?=$referencia_peca?></span>
                                        <img id="mini_anexar_img_<?=$linhaPeca?>" name="mini_anexar_img_<?=$linhaPeca?>" src="<?=$link?>" title="Clique aqui para inserir a imagem" alt="Clique aqui para inserir a imagem" onclick='javascript: $("#img_peca_critica_<?=$linhaPeca?>").click();'></img>
                                        <input type="hidden" value="true" id="peca_critica_<?=$linhaPeca?>" name="peca_critica_<?=$linhaPeca?>" />
                                        <input type="hidden" value="<?=$pathinfo["extension"]?>" id="peca_critica_ext_<?=$linhaPeca?>" name="peca_critica_ext_<?=$linhaPeca?>" />
                                    </div>
                                    <br/> -->

                        <?  }else{
                                //para cada peca critica sem foto
                                foreach ($arrPecaCriticaSemFoto as $posicaoReferencia) {
                                    $linhaPeca = $posicaoReferencia["i"];
                                    $referencia_peca = $posicaoReferencia["referencia"];
                                    //verifica se servico gera pedido para abrir os inputs
                                    if(in_array($_POST["servico_".$i], $servicosGeramPedido)){?>

                                       <!--  <div id="item_img_peca_critica_<?=$linhaPeca?>">
                                            <span>Referência Peça: <?=$referencia_peca?></span>
                                            <img id="mini_anexar_img_<?=$linhaPeca?>" name="mini_anexar_img_<?=$linhaPeca?>" src="image/foto.png" title="Clique aqui para inserir a imagem" alt="Clique aqui para inserir a imagem" onclick='javascript: $("#img_peca_critica_<?=$linhaPeca?>").click();' style="display: none"></img>
                                            <button type="button" id="btn_anexar_img_<?=$linhaPeca?>" name="btn_anexar_img_<?=$linhaPeca?>" title="Clique aqui para inserir a imagem" alt="Clique aqui para inserir a imagem" onclick="$('#img_peca_critica_<?=$linhaPeca?>').click();" >Inserir Anexo</button>
                                            <input type="hidden" value="true" id="peca_critica_<?=$linhaPeca?>" name="peca_critica_<?=$linhaPeca?>" />
                                            <input type="hidden" value="<?=$pathinfo["extension"]?>" id="peca_critica_ext_<?=$linhaPeca?>" name="peca_critica_ext_<?=$linhaPeca?>" />
                                        </div>
                                        <br/> -->

                            <?      //senao monta inputs escondidos
                                    }else{?>
                                        <!-- <div id="item_img_peca_critica_<?=$linhaPeca?>" style="display: none">
                                            <span>Referência Peça: <?=$referencia_peca?></span>
                                            <img id="mini_anexar_img_<?=$linhaPeca?>" name="mini_anexar_img_<?=$linhaPeca?>" src="image/foto.png" title="Clique aqui para inserir a imagem" alt="Clique aqui para inserir a imagem" onclick='javascript: $("#img_peca_critica_<?=$linhaPeca?>").click();' style="display: none"></img>
                                            <button type="button" id="btn_anexar_img_<?=$linhaPeca?>" name="btn_anexar_img_<?=$linhaPeca?>" title="Clique aqui para inserir a imagem" alt="Clique aqui para inserir a imagem" onclick="$('#img_peca_critica_<?=$linhaPeca?>').click();" >Inserir Anexo</button>
                                            <input type="hidden" value="true" id="peca_critica_<?=$linhaPeca?>" name="peca_critica_<?=$linhaPeca?>" />
                                            <input type="hidden" value="<?=$pathinfo["extension"]?>" id="peca_critica_ext_<?=$linhaPeca?>" name="peca_critica_ext_<?=$linhaPeca?>" />
                                        </div>
                                        <br/> -->
                            <?      }
                                }
                            }

                        }
                    }else{
                        $qtde_fotos_pecas_criticas++;

                        $os = $_POST["os"];
                        $linhaPeca = $i;
                        $referencia_peca = $_POST["peca_{$i}"];
                        $descricao_peca = $_POST["descricao_{$i}"];
                        $ext = $_POST["peca_critica_ext_{$i}"];

                        //verifica se peça é critica
                        $sqlPecaCritica = " SELECT  referencia
                                FROM tbl_peca
                                WHERE fabrica = $login_fabrica AND
                                      tbl_peca.referencia = '{$referencia_peca}' AND
                                      tbl_peca.peca_critica is true";
                        $resPecaCritica = pg_query($con, $sqlPecaCritica);
                        //se for critica e servico for gerar pedido
                        if((pg_num_rows($resPecaCritica) > 0 ) && in_array($_POST["servico_".$i], $servicosGeramPedido) ){ ?>

                            <!-- <div id="item_img_peca_critica_<?=$linhaPeca?>">
                                <span>Referência Peça: <?=$referencia_peca?></span>
                                <img id="mini_anexar_img_<?=$linhaPeca?>" name="mini_anexar_img_<?=$linhaPeca?>" src="image/foto.png" title="Clique aqui para inserir a imagem" alt="Clique aqui para inserir a imagem" onclick='javascript: $("#img_peca_critica_<?=$linhaPeca?>").click();' style="display: none"></img>
                                <button type="button" id="btn_anexar_img_<?=$linhaPeca?>" name="btn_anexar_img_<?=$linhaPeca?>" title="Clique aqui para inserir a imagem" alt="Clique aqui para inserir a imagem" onclick="$('#img_peca_critica_<?=$linhaPeca?>').click();" >Inserir Anexo</button>
                                <input type="hidden" value="true" id="peca_critica_<?=$linhaPeca?>" name="peca_critica_<?=$linhaPeca?>" />
                                <input type="hidden" value="<?=$pathinfo["extension"]?>" id="peca_critica_ext_<?=$linhaPeca?>" name="peca_critica_ext_<?=$linhaPeca?>" />
                            </div>
                            <br/> -->
                <?      }else if(pg_num_rows($resPecaCritica) > 0 ){ ?>
                            <!-- <div id="item_img_peca_critica_<?=$linhaPeca?>" style="display: none">
                                <span>Referência Peça: <?=$referencia_peca?></span>
                                <img id="mini_anexar_img_<?=$linhaPeca?>" name="mini_anexar_img_<?=$linhaPeca?>" src="image/foto.png" title="Clique aqui para inserir a imagem" alt="Clique aqui para inserir a imagem" onclick='javascript: $("#img_peca_critica_<?=$linhaPeca?>").click();' style="display: none"></img>
                                <button type="button" id="btn_anexar_img_<?=$linhaPeca?>" name="btn_anexar_img_<?=$linhaPeca?>" title="Clique aqui para inserir a imagem" alt="Clique aqui para inserir a imagem" onclick="$('#img_peca_critica_<?=$linhaPeca?>').click();" >Inserir Anexo</button>
                                <input type="hidden" value="true" id="peca_critica_<?=$linhaPeca?>" name="peca_critica_<?=$linhaPeca?>" />
                                <input type="hidden" value="<?=$pathinfo["extension"]?>" id="peca_critica_ext_<?=$linhaPeca?>" name="peca_critica_ext_<?=$linhaPeca?>" />
                            </div>
                            <br/> -->
                       <? }

                    }
                }

        }else{
            //verifica se tem imagens de peças criticas
            $sqlPecaCritica = " SELECT  referencia
                                FROM tbl_os_item
                                JOIN tbl_os_produto ON tbl_os_produto.os_produto = tbl_os_item.os_produto
                                JOIN tbl_os ON tbl_os.os = tbl_os_produto.os
                                JOIN tbl_peca ON tbl_peca.peca = tbl_os_item.peca
                                WHERE fabrica_i = $login_fabrica AND
                                      tbl_os.os = $os AND
                                      tbl_peca.peca_critica is true";

            $res = pg_query($con,$sqlPecaCritica);
            $qtde_pecas_criticas = pg_num_rows($res);
            for ($i = 0; $i < $qtde_pecas_criticas; $i++) {

                $referencia_peca_critica = pg_fetch_result($res, $i, "referencia");

                $amazonTC->getObjectList("peca_critica-{$os}-{$referencia_peca_critica}-",false,"","");
                $pathinfo = pathinfo($amazonTC->files[0]);
                $dadosPeca = explode("-", $pathinfo["filename"] );
                $linhaPeca = $dadosPeca[3];
                $link = $amazonTC->getLink("thumb_".$pathinfo["basename"]);

                if(strlen($linhaPeca)>0 && in_array($arrPecaCriticaGeraPedido[$linhaPeca], $servicosGeramPedido) ){

                ?>

                    <!-- <div id="item_img_peca_critica_<?=$linhaPeca?>" >
                        <span>Referência Peça: <?=$referencia_peca_critica?></span>
                        <img id="mini_anexar_img_<?=$linhaPeca?>" name="mini_anexar_img_<?=$linhaPeca?>" src="<?=$link?>" title="Clique aqui para inserir a imagem" alt="Clique aqui para inserir a imagem" onclick='javascript: $("#img_peca_critica_<?=$linhaPeca?>").click();'></img>
                        <input type="hidden" value="true" id="peca_critica_<?=$linhaPeca?>" name="peca_critica_<?=$linhaPeca?>" />
                        <input type="hidden" value="<?=$pathinfo["extension"]?>" id="peca_critica_ext_<?=$linhaPeca?>" name="peca_critica_ext_<?=$linhaPeca?>" />
                    </div>
                    <br/> -->    <?
                }else if(strlen($linhaPeca)>0 && !in_array($arrPecaCriticaGeraPedido[$linhaPeca], $servicosGeramPedido)){

                ?>

                    <!-- <div id="item_img_peca_critica_<?=$linhaPeca?>" style="display: none">
                        <span>Referência Peça: <?=$referencia_peca_critica?></span>
                        <img id="mini_anexar_img_<?=$linhaPeca?>" name="mini_anexar_img_<?=$linhaPeca?>" src="<?=$link?>" title="Clique aqui para inserir a imagem" alt="Clique aqui para inserir a imagem" onclick='javascript: $("#img_peca_critica_<?=$linhaPeca?>").click();'></img>
                        <input type="hidden" value="true" id="peca_critica_<?=$linhaPeca?>" name="peca_critica_<?=$linhaPeca?>" />
                        <input type="hidden" value="<?=$pathinfo["extension"]?>" id="peca_critica_ext_<?=$linhaPeca?>" name="peca_critica_ext_<?=$linhaPeca?>" />
                    </div>
                    <br/> -->    <?
                }

            }
            foreach ($arrPecaCriticaSemFoto as $posicaoReferencia) {
                $linhaPeca = $posicaoReferencia["i"];
                $referencia_peca = $posicaoReferencia["referencia"];
                $servico =  $posicaoReferencia["servico"];

                 if(in_array( $servico,$servicosGeramPedido )  ) {

                    ?>

                    <!-- <div id="item_img_peca_critica_<?=$linhaPeca?>">
                        <span>Referência Peça: <?=$referencia_peca?></span>
                        <img id="mini_anexar_img_<?=$linhaPeca?>" name="mini_anexar_img_<?=$linhaPeca?>" src="image/foto.png" title="Clique aqui para inserir a imagem" alt="Clique aqui para inserir a imagem" onclick='javascript: $("#img_peca_critica_<?=$linhaPeca?>").click();' style="display: none"></img>
                        <button type="button" id="btn_anexar_img_<?=$linhaPeca?>" name="btn_anexar_img_<?=$linhaPeca?>" title="Clique aqui para inserir a imagem" alt="Clique aqui para inserir a imagem" onclick="$('#img_peca_critica_<?=$linhaPeca?>').click();" >Inserir Anexo</button>
                        <input type="hidden" value="true" id="peca_critica_<?=$linhaPeca?>" name="peca_critica_<?=$linhaPeca?>" />
                        <input type="hidden" value="<?=$pathinfo["extension"]?>" id="peca_critica_ext_<?=$linhaPeca?>" name="peca_critica_ext_<?=$linhaPeca?>" />
                    </div>
                    <br/> -->
        <?      }else{

            ?>
                    <!-- <div id="item_img_peca_critica_<?=$linhaPeca?>" style="display: none">
                        <span>Referência Peça: <?=$referencia_peca?></span>
                        <img id="mini_anexar_img_<?=$linhaPeca?>" name="mini_anexar_img_<?=$linhaPeca?>" src="image/foto.png" title="Clique aqui para inserir a imagem" alt="Clique aqui para inserir a imagem" onclick='javascript: $("#img_peca_critica_<?=$linhaPeca?>").click();' style="display: none"></img>
                        <button type="button" id="btn_anexar_img_<?=$linhaPeca?>" name="btn_anexar_img_<?=$linhaPeca?>" title="Clique aqui para inserir a imagem" alt="Clique aqui para inserir a imagem" onclick="$('#img_peca_critica_<?=$linhaPeca?>').click();" >Inserir Anexo</button>
                        <input type="hidden" value="true" id="peca_critica_<?=$linhaPeca?>" name="peca_critica_<?=$linhaPeca?>" />
                        <input type="hidden" value="<?=$pathinfo["extension"]?>" id="peca_critica_ext_<?=$linhaPeca?>" name="peca_critica_ext_<?=$linhaPeca?>" />
                    </div>
                    <br/> --> <?
                }
            }

        }

    ?>
    <input type="hidden" value="<?=$qtde_pecas_criticas?>" id="qtde_pecas_criticas" name="qtde_pecas_criticas"/>

    <div id="item_img_peca_critica" style="display: none">
        <div id="item_img_peca_critica_linhaI" style="display: none">
            <span>Referência Peça: referencia</span>
            <img id="mini_anexar_img_linhaI" name="mini_anexar_img_linhaI" src="image/foto.png" title="Clique aqui para inserir a imagem" alt="Clique aqui para inserir a imagem" style="display: none"></img>
            <button type="button" id="btn_anexar_img_linhaI" name="btn_anexar_img_linhaI" title="Clique aqui para inserir a imagem" alt="Clique aqui para inserir a imagem" onclick="$('#img_peca_critica_linhaI').click();" >Inserir Anexo</button>
            <input type="hidden" value="" id="peca_critica_linhaI" name="peca_critica_linhaI"/>
            <input type="hidden" value="<?=$pathinfo["extension"]?>" id="peca_critica_ext_linhaI" name="peca_critica_ext_linhaI"/>
        </div>
        <br/>

    </div>
</div>

<? }

if($login_fabrica == 140){

    if($entrega_tecnica == "t"){

?>

        <table width='700' align='center' border='0' cellspacing='0' cellpadding='5' class="formulario">

            <tr>
                <td class='titulo_tabela' valign="middle" colspan="2">
                    <label style="margin:auto;font:14px Arial">Laudo Técnico:</label>
                </td>
            </tr>

            <tr>
                <td align="center" width="50%">

                    <?php

                        $sqlv = "SELECT
                                    tbl_comunicado.comunicado,
                                    extensao
                                FROM tbl_comunicado
                                LEFT JOIN tbl_comunicado_produto USING(comunicado)
                                WHERE
                                    fabrica = $login_fabrica
                                    AND tipo = 'Laudo Tecnico'";

                        $resv = pg_query($con,$sqlv) ;

                        if (pg_num_rows($resv) > 0) {
                            $vcomunicado             = pg_fetch_result($resv, 0, 'comunicado');
                            $vextensao               = pg_fetch_result($resv, 0, 'extensao');

                            if ($S3_online) {
                                if($s3ve->temAnexos($vcomunicado))
                                    $vista_explodida_produto = $s3ve->url;
                                else
                                    $vista_explodida_produto = file_exists("comunicados/$vcomunicado.$vextensao") ? "comunicados/$vcomunicado.$vextensao":false;
                            }else{
                                $vista_explodida_produto = file_exists("comunicados/$vcomunicado.$vextensao") ? "comunicados/$vcomunicado.$vextensao":false;
                            }

                            if ($vista_explodida_produto !== false) {
                                echo "
                                    <a href='$vista_explodida_produto' target='_blank' style='vertical-align:top;font-size:9px;height:32px;line-height:16px;display:inline-block;width:100px'>
                                        <img src='imagens/botoes/vista_explodida_icone.png' style='float:left' height='32' alt='Vista Explodida' title='Vista Explodida do Produto' />
                                        <span >Laudo<br />Técnico</span>
                                    </a>";
                            }

                        }

                    ?>

                </td>

                <td>

                    <strong>Upload de Laudo Técnico</strong> <br />
                    <input type="file" name="laudo_tecnico" id="laudo_tecnico" />

                </td>

            </tr>
        </table>

        <br />

<?php

    }
}

if ($login_fabrica != 104) {
?>

<table width='700' align='center' border='0' cellspacing='0' cellpadding='5' class="formulario">
<tr>
    <td class='titulo_tabela' valign="middle" colspan="5">
        <label style="margin:auto;font:14px Arial"> <?php echo (in_array($login_fabrica, array(101))) ? "Descrição detalhada do problema:" : traduz("Observação:"); ?> </label>
    </td>
</tr>
<?php

if ($login_fabrica == 30){

?>
<tr>
    <td>

        <label style="text-align:justify !important;font:12px Arial">
        <?
           $sql_obs_os = "SELECT tbl_os.obs || '\nMotivo: ' || tbl_os.observacao AS obs from tbl_os where os=$os";
           $res_obs_os = pg_query($con,$sql_obs_os);
           $obs_os = pg_fetch_result($res_obs_os, 0, 'obs');

        ?>
        </label>
    </td>
</tr>
<?}
    if($obs == 'null' OR $obs == "NULL"){
        $obs = "";
    }
?>
<tr>
    <td align="center" style='padding-top:1em'>
    <textarea name="obs" cols="64" rows='3' maxlength="255" class="frm"><?php echo $obs  ?></textarea><?php
        if ($login_fabrica <> 19) {//hd3335?>
        <p style='color:red;margin: 1em'>
            <?fecho(array('o.campo.observacao.e.somente.para.o.controle.do.posto.autorizado',
                          'o.fabricante.nao.se.responsabilizara.pelos.dados.aqui.digitados', 'sep'=>'<br />'), $con);?>
        </p>
    <?php }?>
    </td>
</tr>
</table>
<br/><?
}//fecha if != 104
if(in_array($login_fabrica, array(11,126,172)) || ($login_fabrica == 137 && $posto_interno == true)) { ?>
    <? if((strlen($msg_erro)>0 )&& ($erro_upload != "true")) { ?>
        <table width="700"><?

        foreach ($arrLinks as $key => $values) {?>
            <tr>
                <td align="center"><label style="position:relative;top:-3px;left:-10px;font-size:10px;font-family:verdana,arial,helvetica,sans-serif">Anexo: </label>

                    <?//se para a $key há um link, abre tag img para imagem
                    if(strlen($values["link"]) > 0 ){
                        $pathinfo = pathinfo($values["link"]);
                        list($ext,$params) = explode("?", $pathinfo["extension"]);
                        if($ext == "pdf"){ ?>
                            <a href="<?=$values["link"]?>">
                                <img id="<?=$key?>" name="<?=$key?>" alt="Baixar Anexo" src="imagens/adobe.JPG"/>
                                <img id="<?=$key?>" name="<?=$key?>" alt="Baixar Anexo" src="<?=$values["link"]?>"></img>
                            </a>
                        <? }else{ ?>
                            <img id="<?=$key?>" name="<?=$key?>" alt="Baixar Anexo" src="<?=$values["link"]?>"></img>
                        <? } ?>
                        <input type="hidden" value="<?=$values['name']?>" name="tmp_<?=$key?>">

                   <? }else{?>
                        <input type="file" class="frm" name="<?=$key?>" id="<?=$key?>"/> <?
                   }?>
                </td>
           </tr><?
        }?>
        <table> <?
    }else{ ?>
        <table width="700">
            <tr>
                <td  align="center">
                <?
                    $amazonTC->getObjectList("anexo_os_item_{$login_fabrica}_{$os}_img_os_item_1",false,"","");

                    $link = '';
                    $file = $amazonTC->files[0];

                    if (!empty($file)) {
                        $link  = $amazonTC->getLink(basename($file));
                        $thumb = $amazonTC->getLink("thumb_".basename($file));
                    }
                    $pathinfo = pathinfo($link);
                    list($ext,$params) = explode("?", $pathinfo["extension"]);

                    if(strlen($link) > 0){ ?>
                        <label style="position:relative;top:-3px;left:-10px;font-size:10px;font-family:verdana,arial,helvetica,sans-serif"> Anexo: </label>
                        <a href="<?=$link?>">
                            <? if($ext == "pdf"){ ?>
                                <img id="img_os_item_1" name="img_os_item_1" alt="Baixar Anexo" src="imagens/adobe.JPG"/>
                            <? }else{ ?>
                                <img id="img_os_item_1" name="img_os_item_1" alt="Baixar Anexo" src="<?=$thumb?>"/>
                            <? } ?>
                        </a>    
                   <? }else{ 
                        if($login_fabrica != 3) { ?>
                        <label style="position:relative;top:-3px;left:-10px;font-size:10px;font-family:verdana,arial,helvetica,sans-serif"> Inserir Anexo: </label>
                        <input type="file" class="frm" name="img_os_item_1" id="img_os_item_1"/>
                  <?    }
                      } ?>
                </td>
            </tr>
            <tr>
                <?php if($login_fabrica != 137){ ?>
                <td  align="center">
                <?
                    $amazonTC->getObjectList("anexo_os_item_{$login_fabrica}_{$os}_img_os_item_2",false,"","");

                    $link = '';
                    $file = $amazonTC->files[0];

                    if (!empty($file)) {
                        $link  = $amazonTC->getLink(basename($file));
                        $thumb = $amazonTC->getLink("thumb_".basename($file));
                    }
                    $pathinfo = pathinfo($link);
                    list($ext,$params) = explode("?", $pathinfo["extension"]);
                    if(strlen($link) > 0){ ?>
                        <label style="position:relative;top:-3px;left:-10px;font-size:10px;font-family:verdana,arial,helvetica,sans-serif"> Anexo: </label>
                        <a href="<?=$link?>">
                         <? if($ext == "pdf"){ ?>
                            <img id="img_os_item_2" name="img_os_item_2" alt="Baixar Anexo" src="imagens/adobe.JPG"/>
                        <? }else{ ?>
                            <img id="img_os_item_2" name="img_os_item_2" alt="Baixar Anexo" src="<?=$thumb?>"/>
                        <? } ?>

                        </a>
                   <? }else{
                         if($login_fabrica != 126 AND $login_fabrica != 3){
                          ?>
                        <label style="position:relative;top:-3px;left:-10px;font-size:10px;font-family:verdana,arial,helvetica,sans-serif"> Inserir Anexo: </label>
                        <input type="file" class="frm" name="img_os_item_2" id="img_os_item_2"/>
                <?    }
                  }
                ?>

                </td>
            <?php } ?>
            </tr>
        </table>
<?php  } ?>
<?php } ?>
<script type="text/javascript">setupZoom();</script>
<?php
    if($login_fabrica == 52){

        $sqlKm = "SELECT qtde_km_calculada,mao_de_obra FROM tbl_os WHERE os = $os";
        $resKm = pg_query($con,$sqlKm);
        $qtde_km_calculada = pg_result($resKm,0,qtde_km_calculada);
        $mao_de_obra = pg_result($resKm,0,mao_de_obra);

        if($qtde_km_calculada <= 0){
            $sqlC = "UPDATE tbl_os_extra SET
                            valor_por_km = x.valor_km,
                            qtde_km      = x.qtde_km
                        FROM (
                            SELECT tbl_os_extra.os, tbl_posto_fabrica.valor_km, tbl_os.qtde_km
                            FROM tbl_os
                            JOIN tbl_os_extra USING(os)
                            JOIN tbl_posto_fabrica ON tbl_posto_fabrica.posto = tbl_os.posto AND tbl_posto_fabrica.fabrica = $login_fabrica
                            WHERE  tbl_os.os = $os
                            AND    tbl_os.fabrica = $login_fabrica
                            AND    tbl_os.qtde_km > 0
                            AND    tbl_posto_fabrica.valor_km > 0
                        ) x
                        WHERE tbl_os_extra.os = x.os;";
            $resC = pg_query($con,$sqlC);

            $sqlD = "UPDATE tbl_os SET qtde_km_calculada = (x.qtde_km * x.valor_por_km)
                        FROM (
                            SELECT tbl_os.os, tbl_os_extra.qtde_km, tbl_os_extra.valor_por_km
                            FROM tbl_os
                            JOIN tbl_os_extra USING(os)
                            WHERE  tbl_os.os = $os
                            AND    tbl_os.fabrica = $login_fabrica
                            AND    tbl_os_extra.qtde_km > 0
                            AND    tbl_os_extra.valor_por_km > 0
                        ) x
                        WHERE tbl_os.os = x.os";
            $resD = pg_query($con,$sqlD);

            $sqlKm = "SELECT qtde_km_calculada FROM tbl_os WHERE os = $os";
            $resKm = pg_query($con,$sqlKm);

            $qtde_km_calculada = pg_result($resKm,0,qtde_km_calculada);
        }

        if($mao_de_obra <= 0){
            $sqlM = "UPDATE tbl_os set
                            mao_de_obra = ROUND(x.mao_de_obra::numeric,2)
                        FROM (
                            SELECT tbl_os.os, tbl_produto.mao_de_obra
                            FROM tbl_os
                            JOIN  tbl_os_extra USING(os)
                            JOIN  tbl_produto ON tbl_os.produto = tbl_produto.produto
                            WHERE   tbl_os_extra.os      = $os
                            AND     tbl_os.produto       = tbl_produto.produto
                            AND     tbl_os.fabrica       = $login_fabrica
                        ) x
                        WHERE x.os = tbl_os.os;";
            $resM = pg_query($con,$sqlM);

            $sqlKm = "SELECT mao_de_obra FROM tbl_os WHERE os = $os";
            $resKm = pg_query($con,$sqlKm);

            $mao_de_obra = pg_result($resKm,0,mao_de_obra);
        }

        $total_os = $mao_de_obra + $qtde_km_calculada;

?>
        <tr>
            <td colspan="5" align="center" >
                <input type="button" value="Valores da OS" onclick="javascript: if(document.getElementById('valores_os').style.display == 'none'){document.getElementById('valores_os').style.display = 'block';} else {document.getElementById('valores_os').style.display = 'none';}">

                <table id="valores_os" border="0" class="tabela" style="display:none;">
                    <caption class="titulo_tabela">Valores da OS</caption>
                    <tr>
                        <td colspan='2'>
                                <table align="center">
                                <tr>
                                    <td style="color:red;font-weight:bold">* <?fecho('valores.sujeito.a.alteracao.ate.fechamento.do.extrato', $con);?></td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td><b>Serviço executado</b></td>
                        <td>R$ <?php echo number_format($mao_de_obra,2,',','.') ;?></td>
                    </tr>
                    <tr>
                        <td><b>Quilometragem</b></td>
                        <td>R$ <?php echo number_format($qtde_km_calculada,2,',','.') ;?></td>
                    </tr>
                    <tr class="titulo_coluna">
                        <td>Total da OS</td>
                        <td>R$ <?php echo number_format($total_os,2,',','.') ;?></td>
                    </tr>
                </table>
            </td>
        </tr>
<?php
    }

if ($fabrica_exclui_anexo) { ?>
<script type='text/javascript' src='js/anexaNF_excluiAnexo.js'></script>
<? } ?>
<div id="anexos">

<?php if (!$fabricaFileUploadOS) { ?>
<table width='700' id="input_anexos">
<tr>
    <td align="center" width="100%" colspan="100%">
    <?php
        //Agora, B&D quer só para revenda... e manter as Consumidor já cadastradas

        if ($anexaNotaFiscal) {
            $temImg = ($S3_online) ? temNF($os, 'count') : 0;

            if($temImg) {
                $retorna_link = $fabrica_exclui_anexo ? "linkEx" : "link";
                echo temNF($os, $retorna_link);
                echo $include_imgZoom;
                if ($login_fabrica == 6) {
                    echo "</td></tr>\n<tr><td align='center' width='100%'>" . $inputNotaFiscal;
                }
                echo "<input type='hidden' name='anexo_os_item' value='1' />";
            }

            // if (($anexa_duas_fotos and $temImg < LIMITE_ANEXOS) or $temImg == 0 or($login_fabrica == 30 and $_POST['produto_serie'] == '00000000000000' and $temImg < 3)) {
            if (true) {

                if( !in_array($login_fabrica, array(11,172)) ){

                    if($login_fabrica == 15){
                        $obg = "  <strong style='color: #ff0000;'>*</strong> &nbsp; ";
                    }

                    if ($login_fabrica == '30') {

                        if($temImg > 0 ){
                            $qtde_anexos = $temImg + 1;
                        }else{
                            $qtde_anexos = 1;
                        }
                        $inputNotaFiscalTpl = str_replace('foto_nf', 'foto_nf[@ID@]', $inputNotaFiscal);

                        $inputNotaFiscalTpl = str_replace('Anexar NF legível:', '', $inputNotaFiscalTpl);

                        echo str_replace('@ID@', '0', $inputNotaFiscalTpl);


                        if($_POST['produto_serie'] == '00000000000000'){
                            echo "<br><bR>";

                            for($qtde_campos_anexo = $qtde_anexos; $qtde_campos_anexo <3; $qtde_campos_anexo++){
                                $inputNotaFiscalTpl = str_replace('foto_nf', "foto_nf[$qtde_campos_anexo]", $inputNotaFiscal);

                              echo $inputNotaFiscalTpl = str_replace('Anexar NF legível:', '', $inputNotaFiscalTpl);
                              echo "<br><bR>";
                            }
                        }

                        $inputNotaFiscalTpl = str_replace('file', '@TYPE@', $inputNotaFiscalTpl);

                        $anexoTpl = '
                            <tr id="anexoTpl" style="display: none">
                                <td height="27" valign="middle" align="center" bgcolor="#FFFFFF">
                                ' . $inputNotaFiscalTpl . '
                                </td>
                            </tr>
                            ';



                        echo "<input type='hidden' id='qtde_anexos' name='qtde_anexos' value='$qtde_anexos' />";
                    } else {
                        if (in_array($login_fabrica, [123])) {
                            if (data_corte_termo($os)) {

                                $mimeTypes = array(
                                                        'jpg'  => 'image/jpeg',
                                                        'jpeg' => 'image/jpeg',
                                                        'gif'  => 'image/gif',
                                                        'png'  => 'image/png',
                                                        'pdf'  => 'application/pdf',
                                                        'xml'  => 'application/xml',
                                                        'doc'  => 'application/msword',
                                                        'docx' => 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                                    );
                                $tiposAdmitidos = implode(',', $mimeTypes);
                                $obg = "  <strong style='color: #ff0000;'>*</strong> &nbsp; ";
                                $input_termo = " <label style='position:relative;top:-3px;left:-10px;font-size:10px;font-family:verdana,arial,helvetica,sans-serif$bold'title='Formatos válidos JPG, PNG, PDF, XML e DOC.'>
                Anexar Termo Ent:</label><span style='color:red;font-weight:bold'
                                    title='Formatos válidos JPG, PNG, PDF, XML e DOC.'><img src='imagens/help.png' /></span>
            <input type='file' name='foto_termo' class='frm' accept='$tiposAdmitidos' /><br> ";
                                echo "</td></tr>\n<tr><td align='center' width='100%'>" . $input_termo;
                            }
                            echo "</td></tr>\n<tr><td align='center' width='100%'>" . $inputNotaFiscal;
                        } else {
                            echo "</td></tr>\n<tr><td align='center' width='100%'> $obg " . $inputNotaFiscal;
                        }


                    }

                }
            }
        }

        ?>
    </td>
</tr>
<tr>
    <td>

<?php 
}
// Removido temporariamente para Correção.  
if ($fabricas_image_uploader) {?>
    <div id="env-qrcode" style="display:none">
        <div class='env-code'>
            <img style="width: 200px;" src="">
        </div>
    </div>
    <!-- <img id="btn-qrcode-request" src="imagens/btn_imageuploader.gif" onclick="getQrCode()" alt="Fazer Upload via Image Uploader" border="0" style="cursor: pointer;border: 1px solid #888;">-->
    <div style="width:920px;text-align:center">
        <span class="mobile" id="btn-qrcode-request" onclick="getQrCode()">
            <img style="width: 45px; float: left" alt="Fazer Upload via Mobile" src="imagens/icone_mobile.png">
            <span><?=traduz("Anexar via Mobile")?></span>
        </span>
        <span class="google_play" id="btn-google-play">
            <a class="g_play" target="_BLANK" href="https://play.google.com/store/apps/details?id=br.com.telecontrol.imageuploader">
                <img style="width: 45px; float: left" alt="Fazer Upload via Mobile" src="imagens/icone_google_play.png">
                <span style="margin-top: 17px;float: left;font-size: 12px; color: #373865;"><?=traduz("Baixar Aplicativo Image Uploader")?></span>
            </a>
        </span>
    </div>
    <div id="env-images"></div>
    <?php
      echo $include_imgZoom;
    }
    ?>
</td>
</tr>
<tr>
    <td colspan='*'>&nbsp;</td>
</tr>
<?php

if (strlen($orientacao_sac) > 0 && !in_array($login_fabrica, array(11,172)) ) {?>
    <tr>
        <td valign="middle" align="center" width="100%" bgcolor="#eeeeee">
            <b>Orientação do SAC ao Posto Autorizado</b>
                <br /><br />
                <?php echo ($orientacao_sac == 'null') ? "" : $orientacao_sac;?>
                <br /><br />
        </td>
    </tr>
<?php
}
?>
</table>
</div>

<? if(in_array($login_fabrica, array(42))) {
if(in_array($login_fabrica, array(42))) {
    //verifica se tem imagem na OS
    $amazonTC->getObjectList("anexo_os_{$login_fabrica}_{$os}_img_os_");
    $files_anexo_os = $amazonTC->files;

    //verifica se tem imagem no OS Item
    $amazonTC->getObjectList("anexo_os_item_{$login_fabrica}_{$os}_img_os_item_");
    $files_anexo_os_item = $amazonTC->files;

    //verifica se tem imagem no OS Revenda
    $sqlSuaOS = "   SELECT sua_os
                    FROM tbl_os
                    WHERE tbl_os.os = {$os} AND
                        fabrica = {$login_fabrica}";
    $resSuaOs = pg_query($con,$sqlSuaOS);
    $suaOs = pg_fetch_result($resSuaOs, 0, "sua_os");
    list($suaOs,$digito) = explode("-", $suaOs);

    $sqlOsRevenda = "   SELECT os_revenda
                        FROM tbl_os_revenda
                        WHERE sua_os = '{$suaOs}' AND
                            fabrica = {$login_fabrica}";

    $resOsRevenda = pg_query($con,$sqlOsRevenda);
    if(pg_num_rows($resOsRevenda) > 0){
        $osRevenda = pg_fetch_result($resOsRevenda, 0, "os_revenda");
        $amazonTC->getObjectList("anexo_os_revenda_{$login_fabrica}_{$osRevenda}_img_os_revenda_");
        $files_anexo_os_revenda = $amazonTC->files;
    }
    if((count($files_anexo_os_item) > 0) ||  (count($files_anexo_os) > 0) ||  (count($files_anexo_os_revenda) > 0)){
?>
<br/>
<table width='700px' border='0' cellspacing='1' cellpadding='2' align='center'  class='formulario'>
  <thead>
      <tr>
          <th class='titulo_tabela' style="text-align: center !important;" colspan="4">Anexos</th>
      </tr>
  </thead>
  <tr>

      <? if(count($files_anexo_os) > 0){
              $div_anexo_os = '';
              $ver_anexo_os = '';
            $arr_docs = array("pdf", 'doc', 'docx');
            foreach ($files_anexo_os as $key => $path) {
                $basename = basename($path);
                $thumb = $amazonTC->getLink("thumb_".$basename, false, "", "");
                $full  = $amazonTC->getLink($basename, false, "", "");
                $pathinfo = pathinfo($full);
                list($ext,$params) = explode("?", $pathinfo["extension"]);

                $tag_abre = '<a href="' . $full . '">';
                $tag_fecha = '</a>';
                ?>

                 <td  align="center" class='conteudo' style="text-align: center !important;">
                   <?php echo $tag_abre ?>
                      <? if($ext == "pdf"){ ?>
                          <img alt="Baixar Anexo" src="imagens/adobe.JPG" title="Clique para ver a imagem em uma escala maior" style="width: 100px; height: 90px;" />
                      <?}else{ ?>
                          <img alt="Baixar Anexo" src="<?=$thumb?>" title="Clique para ver a imagem em uma escala maior" style="width: 100px; height: 90px;" />
                      <? } ?>
                  <?php echo $tag_fecha ?> <br/><br/>
                  <button type="button" onclick="deletarImagemOS(this, '<?=$basename?>', 'os_<?php echo $key ?>')">Apagar anexo</button>
                 </td><?
            }
          }

          if(count($files_anexo_os_item) > 0){

              $div_anexo_os_item = '';
              $ver_anexo_os_item = '';

            foreach ($files_anexo_os_item as $key => $path) {
                $basename = basename($path);
                $thumb = $amazonTC->getLink($basename, false, "", "");
                $full  = $amazonTC->getLink($basename, false, "", "");
                $pathinfo = pathinfo($full);
                list($ext,$params) = explode("?", $pathinfo["extension"]);
                  $tag_abre = '<a href="' . $full . '">';
                  $tag_fecha = '</a>';

                  ?>

                <td  align="center" class='conteudo' style="text-align: center !important;">
                 <?php echo $tag_abre ?>
                      <? if($ext == "pdf"){ ?>
                          <img alt="Baixar Anexo" src="imagens/adobe.JPG" title="Clique para ver a imagem em uma escala maior" style="width: 32px; height: 32px;" />
                      <?}else{ ?>
                          <img alt="Baixar Anexo" src="<?=$thumb?>" title="Clique para ver a imagem em uma escala maior" style="width: 100px; height: 90px;" />
                      <? } ?>
                  <?php echo $tag_fecha ?>
                  <br/><br/>
                      <button type="button" onclick="deletarImagemOS(this,'<?=$basename?>', 'os_item_<?php echo $key ?>')">Apagar anexo</button>
                </td><?
             }
          }

          if(count($files_anexo_os_revenda) > 0){
            foreach ($files_anexo_os_revenda as $path) {
                $basename = basename($path);
                $thumb = $amazonTC->getLink($basename, false, "", "");
                $full  = $amazonTC->getLink($basename, false, "", "");
                $pathinfo = pathinfo($full);
                list($ext,$params) = explode("?", $pathinfo["extension"]);
                  ?>

                <td  align="center" class='conteudo' style="text-align: center !important;">
                  <a href="<?=$full?>" >
                      <? if($ext == "pdf"){ ?>
                          <img alt="Baixar Anexo" src="imagens/adobe.JPG" title="Clique para ver a imagem em uma escala maior" style="width: 32px; height: 32px;" />
                      <?}else{ ?>
                          <img alt="Baixar Anexo" src="<?=$thumb?>" title="Clique para ver a imagem em uma escala maior" style="width: 100px; height: 90px;" />
                      <? } ?>
                  </a>
                  <br/><br/>
                      <button type="button" onclick="deletarImagemOS(this,'<?=$basename?>')">Apagar anexo</button>
                </td><?
             }
          } ?>
  </tr>

</table><br/>
<?php
    echo $div_anexo_os;
    echo $div_anexo_os_item;
    }
    }
} ?>

<?php
if ($login_fabrica == '30') {
    echo '<div align="center" id="adicionar_anexo" style="display:none;"><input value="Adicionar novo arquivo" onclick="addAnexoUpload()" type="button"></div>';
    echo '<table>' , $anexoTpl , '</table>';
}
?>

<?
if ($login_fabrica == 6) {
    $qtde_item = $qtde_item +$qtde_item_aparencia;
}

if (( in_array($login_fabrica, array(10,11,172)) ) AND $login_posto == 6359) {?>
<br />
    <style type="text/css">
        body {
            margin: 0px;
        }

        .msg_erro{
            background-color:#FF0000;
            font: bold 16px "Arial";
            color:#FFFFFF;
            text-align:center;
        }

        .titulo {
            font-family: Arial;
            font-size: 7pt;
            text-align: right;
            color: #000000;
            background: #D6CBA9;
        }
        .titulo2 {
            font-family: Arial;
            font-size: 7pt;
            text-align: center;
            color: #000000;
            background: #ced7e7;
        }
        .titulo3 {
            font-family: Arial;
            font-size: 10px;
            text-align: right;
            color: #000000;
            background: #E9DACD;
            height:16px;
            padding-left:5px
        }

        .inicio {
            font-family: Arial;
            FONT-SIZE: 8pt;
            font-weight: bold;
            text-align: left;
            color: #FFFFFF;
        }

        .conteudo {
            font-family: Arial;
            FONT-SIZE: 8pt;
            font-weight: bold;
            text-align: left;
            background: #F4F7FB;
        }

        .justificativa{
            font-family: Arial;
            FONT-SIZE: 10px;
            background: #F4F7FB;
        }

        .Tabela{
            border:1px solid #d2e4fc;
            background-color:#666666;
            }

        .subtitulo {
            font-family: Verdana;
            FONT-SIZE: 9px;
            text-align: left;
            background: #F4F7FB;
            padding-left:5px
        }
        .inpu{
            border:1px solid #666666;
        }
    </style>

    <TABLE width='700' border='0' cellspacing='1' cellpadding='0' align='center' class='Tabela'>
        <TR>
        <TD><font size='2' color='#FFFFFF'><center><b><?=mb_strtoupper(traduz('interagir.na.os'))?></b></center></font></TD>
        </TR>
        <TR>
            <TD class='conteudo'><br />
                <TABLE align='center' border='0' cellspacing='0' cellpadding='0'>
                    <TR>
                        <TD><INPUT TYPE="text" NAME="interacao_msg" size='70'>&nbsp;<INPUT TYPE="checkbox" NAME="interacao_exigir_resposta" value='t'>&nbsp;<font size='1'>Enviar p/ o fabricante.</font></TD>
                    </TR>
                </TABLE>
                <br /><?php

                $sql = "SELECT os_interacao,
                               TO_CHAR(data,'DD/MM/YYYY HH24:MI') AS data,
                               comentario,
                               tbl_admin.nome_completo
                          FROM tbl_os_interacao
                     LEFT JOIN tbl_admin ON tbl_admin.admin = tbl_os_interacao.admin
                         WHERE os = $os
                           AND interno IS FALSE
                      ORDER BY os_interacao DESC;";

                $res = pg_query($con,$sql);

                if (pg_num_rows($res) > 0) {

                    for ($i = 0; $i < pg_num_rows($res); $i++) {
                        $os_interacao     = pg_fetch_result($res,$i,os_interacao);
                        $interacao_msg    = pg_fetch_result($res,$i,comentario);
                        $interacao_data   = pg_fetch_result($res,$i,data);
                        $interacao_nome   = pg_fetch_result($res,$i,nome_completo);

                        if ($i == 0) {
                            echo "<br />";
                            echo "<table width='100%' border='0' cellspacing='0' cellpadding='0' align='center'>";
                                echo "<tr height='18'>";
                                    echo "<td width='18' bgcolor='#F5E8CF'>&nbsp;</td>";
                                    echo "<td align='left'><font size='1'><b>&nbsp; Interação do fabricante.</b></font></td>";
                                echo "</tr>";
                            echo "</table>";

                            echo "<TABLE width='100%' border='0' cellspacing='1' cellpadding='0' align='center'  class='Tabela' >";
                                echo "<tr align='center'>";
                                    echo "<td class='titulo'><CENTER>NÂº</CENTER></td>";
                                    echo "<td class='titulo'><CENTER>Data</CENTER></td>";
                                    echo "<td class='titulo'><CENTER>Mensagem</CENTER></td>";
                                    echo "<td class='titulo'><CENTER>Fabrica</CENTER></td>";
                                echo "</tr>";
                        }

                        if (strlen($interacao_nome) > 0) {
                            $cor = "style='font-family: Arial; FONT-SIZE: 8pt; font-weight: bold; text-align: left; background: #F5E8CF;'";
                        } else {
                            $cor = "class='conteudo'";
                        }

                        echo "<tr>";
                            echo "<td width='25' $cor>"; echo pg_num_rows($res) - $i; echo "</td>";
                            echo "<td width='90' $cor nowrap>$interacao_data</td>";
                            echo "<td $cor>$interacao_msg</td>";
                            echo "<td $cor nowrap>$interacao_nome</td>";
                        echo "</tr>";
                    }

                    echo "</TABLE>";

                }

                echo '<br />';
            echo '</TD>';
        echo '</TR>';
    echo '</TABLE>';
    echo '<br />';

}


 /**
  * @author William Castro <william.castro@telecontrol.com.br>
  * hd-6639553 -> Box Uploader
  *
  */  

if ($fabricaFileUploadOS) {

    $boxUploader = array(
      "div_id" => "div_anexos",
      "prepend" => $anexo_prepend,
      "context" => "os",
      "unique_id" => $tempUniqueId,
      "hash_temp" => $anexoNoHash,
      "reference_id" => 0
    );

    include "box_uploader.php";
}

    if ($login_fabrica == 80) {?> <br />
        <table class='formulario' width='300'>
            <tr>
                <td class='titulo_tabela' align='center'>Data de Envio</td>
            </tr>
            <tr>
                <td class='table_line2' align='center'>
                    <input type='text' name='data_envio' id='data_envio' class='frm' size='12' value='<?=$data_envio;?>'>
                </td>
            </tr>
            <tr>
                <td class='titulo_tabela' class='conteudo'>Número do Rastreamento do SEDEX</td>
            </tr>
            <tr>
                <td class='table_line2' align='center'>
                    <input type='text' name='rastreamento_envio' size='30' class="frm" value='<?=$rastreamento_envio;?>'>
                </td>
            </tr>
        </table><?php
    }

    if ( in_array($login_fabrica, array(11,172)) && strlen($os) > 0) {
        $sql = "select tbl_os.os
                    from tbl_os
                    join tbl_os_produto using(os)
                    join tbl_os_item using(os_produto)
                    where tbl_os.os = $os;";
        $res = pg_query($con,$sql);
        if (pg_num_rows($res) > 0) {
            $existe_item = pg_fetch_result($res,0,os);
            echo "<input type='hidden' value='$existe_item' name='existe_item'>";
        } else {
            echo "<input type='hidden' value='0' name='existe_item'>";
        }
    }?>
    <div style='margin-top: 5px'>

            <?php  if ($login_fabrica == 96) {?>
                <input type='button' value='GRAVAR' class="verifica_servidor" rel="frm_os" style='cursos:pointer;'  ALT="Gravar itens da Ordem de Serviço" title='Gravar itens da Ordem de Serviço' ONCLICK="javascript: valida_orcamento_bosch_security();" >
            <?php }else{
                    if(in_array($login_fabrica,array(35,120,201,125,131,139))){
                        $onclick = "formataValorAdicional(); ";
                    }
                ?>
                <!-- HD 342629 -->
                <?php
                if($login_fabrica == 74){
                ?>
                    <button type='button' name="btn_gravar" value='GRAVAR' class="verifica_servidor" rel="frm_os"  style='cursos:pointer;'  ALT="Gravar itens da Ordem de Serviço" title='Gravar itens da Ordem de Serviço' >GRAVAR</button>
                <?php
                }else if($login_fabrica == 117){
                        $sql = "SELECT status_os
                                FROM tbl_os_status
                                WHERE status_os IN (64,62,81)
                                AND tbl_os_status.os =  $os
                                AND tbl_os_status.fabrica_status = $login_fabrica
                                ORDER BY data DESC LIMIT 1";
                        $res = pg_query($con,$sql);
                        $status_os = pg_fetch_result($res,0, 'status_os');

                          if((pg_num_rows($res) > 0) AND ($status_os == 64 OR $status_os == 81) ){

                            ?>
                            <script>
                                $(function () {
                                        $("button[name=btn_gravar_elgin]").bind("verificaAlteracao", function () {

                                                if (confirm("Essa OS entrará em Intervenção novamente, e irá aguardar a aprovação o da fábrica. Deseja gravar?" )) {
                                                    $(this).unbind("verificaAlteracao");
                                                    $("button[name=btn_gravar_elgin]").attr("class","verifica_servidor");
                                                    document.frm_os.btn_acao.value='gravar' ;
                                                    $(this).click(function (){
                                                        $(this).trigger("verifica_servidor");
                                                    });
                                                    $("button[name=btn_gravar_elgin]").click();
                                                } else {
                                                    window.location = "os_press.php?os=<?php echo $os;?>";
                                                }
                                        });

                                        $("button[name=btn_gravar_elgin]").click(function () {
                                            $(this).trigger("verificaAlteracao");
                                        });
                                });
                        </script>
                            <button type='button' name="btn_gravar_elgin" value='GRAVAR' rel="frm_os"  style='cursos:pointer;'  ALT="Gravar itens da Ordem de Serviço" title='Gravar itens da Ordem de Serviço' >GRAVAR</button>

                        <?php

                        }else{
                          ?>
                            <button type='button' name="btn_gravar" value='GRAVAR' class="verifica_servidor" rel="frm_os"  style='cursos:pointer;'  ALT="Gravar itens da Ordem de Serviço" title='Gravar itens da Ordem de Serviço' ONCLICK="javascript: <?=$onclick?> if (document.frm_os.btn_acao.value == '' ) { document.frm_os.btn_acao.value='gravar' ; }" >GRAVAR</button>
                        <?php
                        }
                }else{
                    ?>
                    <?php if($login_fabrica == 134){
                        echo "<input type='hidden' name='posto_id' id='posto_id' value='$login_posto'>";
                    } 

                          if ($login_fabrica == 24) {

                    ?>
                            <button type='button' name="btn_gravar" value='GRAVAR' rel="frm_os"  style='cursos:pointer;'  ALT="Gravar itens da Ordem de Serviço" title='Gravar itens da Ordem de Serviço' ONCLICK="javascript: verifica_qtde_peca()">GRAVAR</button>
                            <input type="hidden" id="qtde_peca_lancada" name="qtde_peca_lancada" value="">
                    <?php
                          } else {
                    ?>
                            <button type='button' name="btn_gravar" value='GRAVAR' class="verifica_servidor" rel="frm_os"  style='cursos:pointer;'  ALT="Gravar itens da Ordem de Serviço" title='Gravar itens da Ordem de Serviço' ONCLICK="javascript: <?=$onclick?> if (document.frm_os.btn_acao.value == '' ) { document.frm_os.btn_acao.value='gravar' ; }">GRAVAR</button>
                    <?php
                          }
                }
                ?>

            <? } ?>

            <?php
            if ($login_fabrica == 3) {?> &nbsp;&nbsp;&nbsp;

            <!-- HD 342629 -->
            <input type='button' value='FECHAR' style='cursos:pointer;' class="verifica_servidor" rel="frm_os"  ALT="Gravar itens da Ordem de Serviço" title='Gravar itens da Ordem de Serviço' onclick="javascript: if (document.frm_os.btn_acao.value == '' ) { document.frm_os.btn_acao.value='gravar' ; document.frm_os.btn_imprimir.value='imprimir' ; } ">

            <? } ?>
        </div>
</table>
<?php
  if($_POST['objectid'] == ""){
      $objectId = md5($login_fabrica.$login_posto.date('dmyhis').rand(1,10000));
  }else{
      $objectId = $_POST['objectid'];
  }
  ?>
  <input type="hidden" id="objectid"  name="objectid" value="<?php echo $objectId; ?>">
</form>
<?
if ($login_fabrica == 3) {
    $sql = "SELECT DATE_PART('YEAR', data_digitacao) AS year, DATE_PART('MONTH', data_digitacao) AS month
            FROM tbl_os
            WHERE fabrica = $login_fabrica
            AND os = $os";
    $res = pg_query($con, $sql);

    $year  = pg_fetch_result($res, 0, "year");
    $month = pg_fetch_result($res, 0, "month");
?>
    <div id="file_forms" style="display: block;">
        <?
        for ($i = 0; $i < $loop; $i++) {
            if ($qtde_fotos[$i] > 0) {
                for ($k = 0; $k < $qtde_fotos[$i]; $k++) {
                    $anexa_imagem = true;

                    if ($foto_upload[$i][$k]["upload"] == "t") {
                        $anexa_imagem = false;
                    }

                    if ($anexa_imagem == true) {
                    ?>
                        <form id="file_form_<?=$i?>_<?=$k?>" name="file_form_<?=$i?>_<?=$k?>" action="temp_upload.php" method="post" enctype="multipart/form-data" style="display: none;">
                            <input type="hidden" name="os" value="<?=$os?>" />
                            <input type="hidden" name="i" value="<?=$i?>" />
                            <input type="hidden" name="k" value="<?=$k?>" />
                            <input type="hidden" name="year" value="<?=$year?>" />
                            <input type="hidden" name="month" value="<?=$month?>" />
                            <input type="hidden" name="peca" value="<?=$peca[$i]?>" />
                            <input type="file" form="file_form_<?=$i?>_<?=$k?>" name="file_<?=$i?>_<?=$k?>" value="" onchange="$('div[name=upload_fotos_<?=$i?>]').find('img.loadImg').show(); ajax_process = true; $('#file_form_<?=$i?>_<?=$k?>').submit();" />
                        </form>
                    <?
                    }
                }
            }
        }

?>
        <div id="filesFormModel">
            <form id="file_form_linhaI_fotoK" name="file_form_linhaI_fotoK" action="temp_upload.php" method="post" enctype="multipart/form-data" style="display: none;">
                <input type="hidden" name="os" value="OSNumber" />
                <input type="hidden" name="i" value="linhaI" />
                <input type="hidden" name="k" value="fotoK" />
                <input type="hidden" name="year" value="<?=$year?>" />
                <input type="hidden" name="month" value="<?=$month?>" />
                <input type="hidden" name="peca" value="pecaRef" />
                <input type="file" form="file_form_linhaI_fotoK" name="file_linhaI_fotoK" value="" />
            </form>
        </div>
    </div>
<?
}

if($login_fabrica == 125){ ?>

<div id="form_upload_peca_critica" style="display: block; display: none;">
<?  if(strlen($msg_erro)>0){

            //para cada item lançado, verifica se ha uma foto correspondente
            for ($i = 0; $i < $qtde_item; $i++) {

                if(isset($_POST["peca_critica_{$i}"]) && strlen($_POST["peca_critica_{$i}"]) > 0){
                    $qtde_fotos_pecas_criticas++;

                    $os = $_POST["os"];
                    $linhaPeca = $i;
                    $referencia_peca = $_POST["peca_{$i}"];
                    $descricao_peca = $_POST["descricao_{$i}"];
                    $ext = $_POST["peca_critica_ext_{$i}"];

                    //verifica se peça é critica
                    $sqlPecaCritica = " SELECT  referencia
                            FROM tbl_peca
                            WHERE fabrica = $login_fabrica AND
                                  tbl_peca.referencia = '{$referencia_peca}' AND
                                  tbl_peca.peca_critica is true";
                    $resPecaCritica = pg_query($con, $sqlPecaCritica);

                    if(pg_num_rows($resPecaCritica) > 0){
                        $referencia_peca = pg_fetch_result($resPecaCritica, 0, "referencia");
                        ?>
                            <!-- <form id="upload_peca_critica_<?=$linhaPeca?>" name="upload_peca_critica_<?=$linhaPeca?>" action="upload_peca_critica.php" method="post" enctype="multipart/form-data" >
                                <input type="hidden" class="frm_upload_peca_critica" name="i" value="<?=$linhaPeca?>" />
                                <input type="hidden" class="frm_upload_peca_critica" name="referencia_peca_critica_<?=$linhaPeca?>" id="referencia_peca_critica_<?=$linhaPeca?>" value="<?=$referencia_peca?>" />
                                <input type="hidden" class="frm_upload_peca_critica" name="os" id="os" value="<?=$os?>" />
                                <input type="file" class="frm_upload_peca_critica" form="upload_peca_critica_<?=$linhaPeca?>" name="img_peca_critica_<?=$linhaPeca?>" id="img_peca_critica_<?=$linhaPeca?>" value="" onchange="$('#btn_anexar_img_<?=$linhaPeca?>').hide(); $('#mini_anexar_img_<?=$linhaPeca?>').show(); $('#mini_anexar_img_<?=$linhaPeca?>').attr('src', 'imagens/ajax-loader.gif'); $('#upload_peca_critica_<?=$linhaPeca?>').submit(); "/>
                            </form> -->

                    <?
                    }
                }else{
                        $qtde_fotos_pecas_criticas++;

                        $os = $_POST["os"];
                        $linhaPeca = $i;
                        $referencia_peca = $_POST["peca_{$i}"];
                        $descricao_peca = $_POST["descricao_{$i}"];
                        $ext = $_POST["peca_critica_ext_{$i}"];

                        //verifica se peça é critica
                        $sqlPecaCritica = " SELECT  referencia
                                FROM tbl_peca
                                WHERE fabrica = $login_fabrica AND
                                      tbl_peca.referencia = '{$referencia_peca}' AND
                                      tbl_peca.peca_critica is true";
                        $resPecaCritica = pg_query($con, $sqlPecaCritica);

                        if(pg_num_rows($resPecaCritica) > 0){
                            $referencia_peca = pg_fetch_result($resPecaCritica, 0, "referencia");?>
                            <!-- <form id="upload_peca_critica_<?=$linhaPeca?>" name="upload_peca_critica_<?=$linhaPeca?>" action="upload_peca_critica.php" method="post" enctype="multipart/form-data" >
                                <input type="hidden" class="frm_upload_peca_critica" name="i" value="<?=$linhaPeca?>" />
                                <input type="hidden" class="frm_upload_peca_critica" name="referencia_peca_critica_<?=$linhaPeca?>" id="referencia_peca_critica_<?=$linhaPeca?>" value="<?=$referencia_peca?>" />
                                <input type="hidden" class="frm_upload_peca_critica" name="os" id="os" value="<?=$os?>" />
                                <input type="file" class="frm_upload_peca_critica" form="upload_peca_critica_<?=$linhaPeca?>" name="img_peca_critica_<?=$linhaPeca?>" id="img_peca_critica_<?=$linhaPeca?>" value="" onchange="$('#btn_anexar_img_<?=$linhaPeca?>').hide(); $('#mini_anexar_img_<?=$linhaPeca?>').show(); $('#mini_anexar_img_<?=$linhaPeca?>').attr('src', 'imagens/ajax-loader.gif'); $('#upload_peca_critica_<?=$linhaPeca?>').submit(); "/>
                            </form> -->
                <?      }
                    }
            }

    }else{
        //verifica se tem imagens de peças criticas
        $sqlPecaCritica = " SELECT  referencia
                            FROM tbl_os_item
                            JOIN tbl_os_produto ON tbl_os_produto.os_produto = tbl_os_item.os_produto
                            JOIN tbl_os ON tbl_os.os = tbl_os_produto.os
                            JOIN tbl_peca ON tbl_peca.peca = tbl_os_item.peca
                            WHERE fabrica_i = $login_fabrica AND
                                  tbl_os.os = $os AND
                                  tbl_peca.peca_critica is true ";

            $res = pg_query($con,$sqlPecaCritica);
            $qtde_pecas_criticas = pg_num_rows($res);
            for ($i = 0; $i < $qtde_pecas_criticas; $i++) {

                $referencia_peca_critica = pg_fetch_result($res, $i, "referencia");
                //peca_critica-{$os}
                $amazonTC->getObjectList("peca_critica-{$os}-{$referencia_peca_critica}-",false,"","");
                $pathinfo = pathinfo($amazonTC->files[0]);
                $dadosPeca = explode("-", $pathinfo["filename"] );
                $linhaPeca = $dadosPeca[3];
                if(strlen($linhaPeca) > 0 && in_array($arrPecaCriticaGeraPedido[$i], $servicosGeramPedido) ){ ?>

                    <!-- <form id="upload_peca_critica_<?=$linhaPeca?>" name="upload_peca_critica_<?=$linhaPeca?>" action="upload_peca_critica.php" method="post" enctype="multipart/form-data" >
                        <input type="hidden" class="frm_upload_peca_critica" name="i" value="<?=$linhaPeca?>" />
                        <input type="hidden" class="frm_upload_peca_critica" name="referencia_peca_critica_<?=$linhaPeca?>" id="referencia_peca_critica_<?=$linhaPeca?>" value="<?=$referencia_peca_critica?>" />
                        <input type="hidden" class="frm_upload_peca_critica" name="os" id="os" value="<?=$os?>" />
                        <input type="file" class="frm_upload_peca_critica" form="upload_peca_critica_<?=$linhaPeca?>" name="img_peca_critica_<?=$linhaPeca?>" id="img_peca_critica_<?=$linhaPeca?>" value="" onchange="$('#btn_anexar_img_<?=$linhaPeca?>').hide(); $('#mini_anexar_img_<?=$linhaPeca?>').show();$('#mini_anexar_img_<?=$linhaPeca?>').attr('src', 'imagens/ajax-loader.gif'); $('#upload_peca_critica_<?=$linhaPeca?>').submit(); "/>
                    </form> -->
            <? }else {
                    if(strlen($linhaPeca)>0 && !in_array($arrPecaCriticaGeraPedido[$linhaPeca], $servicosGeramPedido)){

                ?>

                    <!-- <form id="upload_peca_critica_<?=$linhaPeca?>" name="upload_peca_critica_<?=$linhaPeca?>" action="upload_peca_critica.php" method="post" enctype="multipart/form-data" >
                            <input type="hidden" class="frm_upload_peca_critica" name="i" value="<?=$linhaPeca?>" />
                            <input type="hidden" class="frm_upload_peca_critica" name="referencia_peca_critica_<?=$linhaPeca?>" id="referencia_peca_critica_<?=$linhaPeca?>" value="<?=$referencia_peca_critica?>" />
                            <input type="hidden" class="frm_upload_peca_critica" name="os" id="os" value="<?=$os?>" />
                            <input type="file" class="frm_upload_peca_critica" form="upload_peca_critica_<?=$linhaPeca?>" name="img_peca_critica_<?=$linhaPeca?>" id="img_peca_critica_<?=$linhaPeca?>" value="" onchange="$('#btn_anexar_img_<?=$linhaPeca?>').hide(); $('#mini_anexar_img_<?=$linhaPeca?>').show();$('#mini_anexar_img_<?=$linhaPeca?>').attr('src', 'imagens/ajax-loader.gif'); $('#upload_peca_critica_<?=$linhaPeca?>').submit(); "/>
                        </form> -->
                        <?
                }
                }
            }
            foreach ($arrPecaCriticaSemFoto as $posicaoReferencia) {
                        $linhaPeca = $posicaoReferencia["i"];
                        $referencia_peca_critica = $posicaoReferencia["referencia"];    ?>

                        <!-- <form id="upload_peca_critica_<?=$linhaPeca?>" name="upload_peca_critica_<?=$linhaPeca?>" action="upload_peca_critica.php" method="post" enctype="multipart/form-data" >
                            <input type="hidden" class="frm_upload_peca_critica" name="i" value="<?=$linhaPeca?>" />
                            <input type="hidden" class="frm_upload_peca_critica" name="referencia_peca_critica_<?=$linhaPeca?>" id="referencia_peca_critica_<?=$linhaPeca?>" value="<?=$referencia_peca_critica?>" />
                            <input type="hidden" class="frm_upload_peca_critica" name="os" id="os" value="<?=$os?>" />
                            <input type="file" class="frm_upload_peca_critica" form="upload_peca_critica_<?=$linhaPeca?>" name="img_peca_critica_<?=$linhaPeca?>" id="img_peca_critica_<?=$linhaPeca?>" value="" onchange="$('#btn_anexar_img_<?=$linhaPeca?>').hide(); $('#mini_anexar_img_<?=$linhaPeca?>').show();$('#mini_anexar_img_<?=$linhaPeca?>').attr('src', 'imagens/ajax-loader.gif'); $('#upload_peca_critica_<?=$linhaPeca?>').submit(); "/>
                        </form> -->
                <?  }
    }?>
     <div id="model_form_peca_critica" style="display: none;">

        <form id="upload_peca_critica_linhaI" name="upload_peca_critica_linhaI" action="upload_peca_critica.php" method="post" enctype="multipart/form-data">
            <input type="hidden" name="i" value="linhaI" />
            <input type="hidden" name="referencia_peca_critica_linhaI" id="referencia_peca_critica_linhaI" value="pecaReferencia" />
            <input type="hidden" name="os" id="os" value="OSNumber" />
            <input type="file" form="upload_peca_critica_linhaI" name="img_peca_critica_linhaI" id="img_peca_critica_linhaI" value="" />
        </form>
    </div>
</div>
<? } ?>
 <div id="pop" style="display:none; width:auto;">

    <div>&nbsp;</div>

 </div>
<p>

<? if ($login_fabrica == 50) {
    $sql = "SELECT
                    contato_endereco,
                    contato_numero,
                    contato_bairro,
                    contato_cidade,
                    contato_estado,
                    contato_email,
                    contato_fone_comercial
                FROM tbl_posto_fabrica
                WHERE posto = {$login_posto}
                AND fabrica = {$login_fabrica};";

    $resm = pg_query($con, $sql);

    if (pg_num_rows($resm) > 0) {
        $posto_endereco = pg_fetch_result($resm,0,'contato_endereco');
        $posto_numero= pg_fetch_result($resm,0,'contato_numero');
        $posto_bairro = pg_fetch_result($resm,0,'contato_bairro');
        $posto_endereco_tab = $posto_endereco . ', ' . $posto_numero . ' - ' . $posto_bairro;
        $posto_cidade_tab = pg_fetch_result($resm,0,'contato_cidade');
        $posto_estado_tab = pg_fetch_result($resm,0,'contato_estado');
        $posto_fone_tab = pg_fetch_result($resm,0,'contato_fone_comercial');
        $posto_email_tab = pg_fetch_result($resm,0,'contato_email');

    }
} 

?>
<input type="hidden" name="contato_endereco" id="contato_endereco" value="<?= $posto_endereco; ?>" />
<input type="hidden" name="contato_numero" id="contato_numero" value="<?= $posto_numero; ?>" />
<input type="hidden" name="contato_bairro" id="contato_bairro" value="<?= $posto_bairro; ?>" />
<input type="hidden" name="contato_cidade" id="contato_cidade" value="<?= $posto_cidade_tab; ?>" />
<input type="hidden" name="contato_estado" id="contato_estado" value="<?= $posto_estado_tab; ?>" />

<input type="hidden" name="consumidor_endereco" id="consumidor_endereco" value="<?= $consumidor_endereco; ?>" />
<input type="hidden" name="consumidor_numero" id="consumidor_numero" value="<?= $consumidor_numero; ?>" />
<input type="hidden" name="consumidor_bairro" id="consumidor_bairro" value="<?= $consumidor_bairro; ?>" />
<input type="hidden" name="consumidor_cidade" id="consumidor_cidade" value="<?= $consumidor_cidade; ?>" />
<input type="hidden" name="consumidor_estado" id="consumidor_estado" value="<?= $consumidor_estado; ?>" />

<!--
<link href="https://developers.google.com/maps/documentation/javascript/examples/default.css" rel="stylesheet">
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&language=pt-br&key=AIzaSyC5AsH3NU-IwraXqLAa1qbXxyjklSVP-cQ"></script>
-->
<!-- MapBox -->
<link href="plugins/leaflet/leaflet.css?<?=date('s');?>" rel="stylesheet" type="text/css" />
<script src="plugins/leaflet/leaflet.js?<?=date('s');?>" ></script>
<script src="plugins/leaflet/map.js?<?=date('s');?>" ></script>
<script src="plugins/mapbox/geocoder.js?<?=date('s');?>"></script>
<script src="plugins/mapbox/polyline.js?<?=date('s');?>"></script>

<script type="text/javascript">

    var erroCadastro = "<?= strlen($msg_erro); ?>";

    function siglaEstado(sigla){

        switch(sigla){
            case "AC" : sigla = "Acre"; break;
            case "AL" : sigla = "Alagoas"; break;
            case "AP" : sigla = "Amapá"; break;
            case "AM" : sigla = "Amazonas"; break;
            case "BA" : sigla = "Bahia"; break;
            case "CE" : sigla = "Ceará"; break;
            case "DF" : sigla = "Distrito Federal"; break;
            case "ES" : sigla = "Espí­rito Santo"; break;
            case "GO" : sigla = "Goiás"; break;
            case "MA" : sigla = "Maranhão"; break;
            case "MT" : sigla = "Mato Grosso"; break;
            case "MS" : sigla = "Mato Grosso do Sul"; break;
            case "MG" : sigla = "Minas Gerais"; break;
            case "PA" : sigla = "Pará"; break;
            case "PB" : sigla = "Paraí­ba"; break;
            case "PR" : sigla = "Paraná"; break;
            case "PE" : sigla = "Pernambuco"; break;
            case "PI" : sigla = "Piauí­"; break;
            case "RJ" : sigla = "Rio de Janeiro"; break;
            case "RN" : sigla = "Rio Grande do Norte"; break;
            case "RS" : sigla = "Rio Grande do Sul"; break;
            case "RO" : sigla = "Rondônia"; break;
            case "RR" : sigla = "Roraima"; break;
            case "SC" : sigla = "Santa Catarina"; break;
            case "SP" : sigla = "São Paulo"; break;
            case "SE" : sigla = "Sergipe"; break;
            case "TO" : sigla = "Tocantins"; break;
        }

        return sigla;

    }

    function retiraAcentos(palavra){

        var com_acento = 'áàãâäéèêëíìîïóòõôöúùûüçÁÀÃÂÄÉÈÊËÍÌÎÏÓÒÕÖÔÚÙÛÜÇ';
        var sem_acento = 'aaaaaeeeeiiiiooooouuuucAAAAAEEEEIIIIOOOOOUUUUC';
        var newPalavra = "";

        for(i = 0; i < palavra.length; i++) {
            if (com_acento.search(palavra.substr(i,1)) >= 0) {
                newPalavra += sem_acento.substr(com_acento.search(palavra.substr(i,1)),1);
            }
            else{
                newPalavra += palavra.substr(i,1);
            }
        }

        return newPalavra.toUpperCase();
    }

    /* INICIO - MAPBOX */
    var geocoder, latlon, c_lat, c_lon, LatLngPosto;
    var Map, Markers, Route, Geocoder, geometry;

    function calcRoute(){
        var type = arguments[0];
        var textIdaVolta = "";

        $('#ida_volta').html("");

        /* validacoes */
        /*if($('#consumidor_cidade').val() == ""){
            alert("Por favor insira a cidade do Consumidor!");
            $(this).focus();
            return;
        }

        if($('#consumidor_estado').val() == ""){
            alert("Por favor insira o estado do Consumidor!");
            $(this).focus();
            return;
        }*/

        var cidadeConsumidor = "";
        var estadoConsumidor = "";

        $('#distancia_km').val('');
        $('#div_end_posto').html('');
        $('#div_mapa_msg').html('');

        var posto = "";
        var consumidor = "";


        if($('#contato_endereco').val() != "" ||
            $('#contato_cidade').val() != "" ||
            $('#contato_estado').val() == ""){

            if($('#contato_endereco').val() != ""){
                posto += " "+document.getElementById("contato_endereco").value;
            }
            if($('#contato_numero').val() != ""){
                posto += " "+document.getElementById("contato_numero").value;
            }

            posto += ", "+document.getElementById("contato_cidade").value;
            posto += ", "+document.getElementById("contato_estado").value;
            posto += ", Brasil";
        }else if($('#contato_cep').val() != ""){
            posto = $('#contato_cep').val();
        }else{
            alert("Dados insuficientes do Posto para realizar Rota e Calculo da Distância, por favor verificar se há endereço, cidade, estado e CEP.");
            return;
        }
      if (type =='cep' && $('#consumidor_cep').val() != "") {
          consumidor = $('#consumidor_cep').val();
          consumidor = "cep: "+ consumidor.replace('.','');
          consumidor += ", "+document.getElementById("consumidor_cidade").value;
          consumidor += ", "+document.getElementById("consumidor_estado").value;
          consumidor += ", Brasil";

      }else{
        if($('#consumidor_endereco').val() != "" || $('#consumidor_cidade').val() != "" || $('#consumidor_estado').val() != ""){
          if($('#consumidor_endereco').val() != "") { consumidor += " "+document.getElementById("consumidor_endereco").value; }

            /*if($('#consumidor_numero').val() != ""){
              if(!verificarNumero(document.getElementById("consumidor_numero").value)){
                consumidor += " "+document.getElementById("consumidor_numero").value;
              }
            }*/

          // if($('#consumidor_bairro').val() != "") { consumidor += ", "+document.getElementById("consumidor_bairro").value; }

          consumidor += (consumidor != "") ? ", " : "";
          consumidor += document.getElementById("consumidor_cidade").value;
          consumidor += ", "+document.getElementById("consumidor_estado").value;
          consumidor += ", Brasil";

          /* Cidade e Estado Consumidor */
          cidadeConsumidor = $('#consumidor_cidade').val();
          estadoConsumidor = $('#consumidor_estado').val();

        }else if($('#consumidor_cep').val() != ""){
          consumidor = $('#consumidor_cep').val();
        }else{
          alert("Dados insuficientes do Consumidor para realizar Rota e Calculo da Distância, por favor verificar se há endereço, cidade, estado e CEP.");
          return;
        }
      }
        if(posto == ""){
            alert('Endereço do Posto não localizado! Por favor verifique se os dados es corretos!');
            return;
        }

        if(consumidor == ""){
            if($('#consumidor_cep').val() == ""){
                alert('Por favor insira o Consumidor');
                $('#consumidor_nome').focus();
                return;
            }else{
                consumidor = $('#consumidor_cep').val();
            }
        }

        function liberar_campoKM_posto(){
          <?php
            if(in_array($login_fabrica, array(120,201))){
          ?>
              $('#distancia_km').val("0").prop({readonly:false});
          <?php
            }
          ?>

        }

        var Contato_endereco = $('#contato_endereco').val();
        var Contato_cidade   = $('#contato_cidade').val();
        var Contato_estado   = $('#contato_estado').val();
        var Contato_numero   = $('#contato_numero').val();
        var Contato_bairro   = $('#contato_bairro').val();
        var Contato_cep      = $('#contato_cep').val();

        var Consumidor_endereco = $('#consumidor_endereco').val();
        var Consumidor_cidade   = $('#consumidor_cidade').val();
        var Consumidor_estado   = $('#consumidor_estado').val();
        var Consumidor_numero   = $('#consumidor_numero').val();
        var Consumidor_bairro   = $('#consumidor_bairro').val();
        var Consumidor_cep      = $('#consumidor_cep').val();

        var Pais = "Brasil";

        var endereco = Contato_endereco+" "+Contato_numero+" "+Contato_bairro+" "+Contato_cidade+" "+Contato_estado;

        if (typeof Map !== "object") {
            Map      = new Map("GoogleMaps");
            Markers  = new Markers(Map);
            Router   = new Router(Map);
            Geocoder = new Geocoder();
        }

        $('#loading-map').show();

        try {
            Geocoder.setEndereco({
                endereco: Consumidor_endereco,
                numero: Consumidor_numero,
                bairro: Consumidor_bairro,
                cidade: Consumidor_cidade,
                estado: Consumidor_estado,
                pais: Pais
            });

            request = Geocoder.getLatLon();

            request.then(
                function(resposta) {

                    LatLngPosto = $('#LatLngPosto').val();

                    c_lat  = resposta.latitude;
                    c_lon  = resposta.longitude;
                    latlon = c_lat+","+c_lon;

                    $.ajax({
                        url: "controllers/TcMaps.php",
                        type: "POST",
                        data: {ajax: "route", origem: LatLngPosto, destino: latlon, ida_volta: "sim"},
                        timeout: 60000
                    }).done(function(data){
                        data = JSON.parse(data);

                        geometry = data.rota.routes[0].geometry;
                        var kmtotal = data.total_km.toFixed(2);

                        $('#ida_volta').html('<strong>Ida:</strong> '+data.km_ida+" &nbsp; <strong>Volta:</strong> "+data.km_volta);
                        $('#distancia_km_conferencia').val(kmtotal);
                        $('#distancia_km').val(kmtotal);
                        $('#div_mapa_msg').html('Distância calculada <a href= "javascript: vermapa();">Ver mapa</a>');
                        $('#div_end_posto').html("<strong>Endereço do Posto:</strong> "+endereco);
                        $('#loading-map').hide();
                    }).fail(function(){
                        $('#loading-map').hide();
                        alert('Erro ao tentar calcular a rota!');
                    });
                },
                function(erro) {
                    $('#loading-map').hide();
                    alert(erro);
                }
            );
        } catch(e) {
            $('#loading-map').hide();
            alert(e.message);
        }
    }

    function vermapa(){
        $("#GoogleMapsContainer").css({'display' : 'block'});

        Map.load();

        var LatLngSplit = LatLngPosto.split(',');

        /* Marcar pontos no mapa */
        Markers.remove();
        Markers.clear();
        Markers.add(c_lat, c_lon, "blue", "Cliente");
        Markers.add(LatLngSplit[0], LatLngSplit[1], "red", "Posto");
        Markers.render();
        Markers.focus();

        Router.remove();
        Router.clear();
        Router.add(Polyline.decode(geometry));
        Router.render();
    }
    /* FIM - MAPBOX*/

    $('#GoogleMapsContainer').css({'display' : 'none'});

        var directionsDisplay;
        //var directionsService = new google.maps.DirectionsService();
        var map;

        function initialize() {

            directionsDisplay = new google.maps.DirectionsRenderer();
            var mapOptions = {
              zoom: 7,
              mapTypeId: google.maps.MapTypeId.ROADMAP,
              center: new google.maps.LatLng(41.850033, -87.6500523)
            };
            map = new google.maps.Map(document.getElementById('GoogleMaps'),
                mapOptions);

            directionsDisplay.setMap(map);

        }

        /* calCRoute */
        var qtdVezesRota = 0;

        var alterarDistanciaVezes = 0;

        var googleNaoEncontrou = 0;

    function calcRoute_ANTIGO(){

        var textIdaVolta = "";

        $('#ida_volta').html("");

        /* validacoes */
        if($('#consumidor_cidade').val() == ""){
            alert("Por favor insira a cidade do Consumidor!");
            $(this).focus();
            return;
        }

        if($('#consumidor_estado').val() == ""){
            alert("Por favor insira o estado do Consumidor!");
            $(this).focus();
            return;
        }

        var cidadeConsumidor = "";
        var estadoConsumidor = "";

        $('#distancia_km').val('');
        $('#div_end_posto').html('');
        $('#div_mapa_msg').html('');

        var posto = "";
        var consumidor = "";


        if($('#contato_endereco').val() != "" || $('#contato_cidade').val() != "" || $('#contato_estado').val() == ""){
            if($('#contato_endereco').val() != ""){ posto += " "+document.getElementById("contato_endereco").value; }
            if($('#contato_numero').val() != ""){ posto += " "+document.getElementById("contato_numero").value; }
            // if($('#contato_bairro').val() != ""){ posto += ", "+document.getElementById("contato_bairro").value; }
            posto += ", "+document.getElementById("contato_cidade").value;
            posto += ", "+document.getElementById("contato_estado").value;
            posto += ", Brasil";
        }else if($('#contato_cep').val() != ""){
            posto = $('#contato_cep').val();
        }else{
            alert("Dados insuficientes do Posto para realizar Rota e Calculo da Distância, por favor verificar se há endereço, cidade, estado e CEP.");
            return;
        }

        if($('#consumidor_endereco').val() != "" || $('#consumidor_cidade').val() != "" || $('#consumidor_estado').val() != ""){
            if($('#consumidor_endereco').val() != "") { consumidor += " "+document.getElementById("consumidor_endereco").value; }
            if($('#consumidor_numero').val() != "") { consumidor += " "+document.getElementById("consumidor_numero").value; }
            // if($('#consumidor_bairro').val() != "") { consumidor += ", "+document.getElementById("consumidor_bairro").value; }
            consumidor += ", "+document.getElementById("consumidor_cidade").value;
            consumidor += ", "+document.getElementById("consumidor_estado").value;
            consumidor += ", Brasil";

            /* Cidade e Estado Consumidor */
            cidadeConsumidor = $('#consumidor_cidade').val();
            estadoConsumidor = $('#consumidor_estado').val();

        }else if($('#consumidor_cep').val() != ""){
            consumidor = $('#consumidor_cep').val();
        }else{
            alert("Dados insuficientes do Consumidor para realizar Rota e Calculo da Distância, por favor verificar se há endereço, cidade, estado e CEP.");
            return;
        }

        if(posto == ""){
            alert('Endereço do Posto não localizado! Por favor verifique se os dados es corretos!');
            return;
        }

        if(consumidor == ""){
            if($('#consumidor_cep').val() == ""){
                alert('Por favor insira o Consumidor');
                $('#consumidor_nome').focus();
                return;
            }else{
                consumidor = $('#consumidor_cep').val();
            }
        }

        /* Quilometragem da Rota */

        var service = new google.maps.DistanceMatrixService();
        service.getDistanceMatrix(
        {
            origins: [posto],
            destinations: [consumidor],
            travelMode: google.maps.TravelMode.DRIVING,
            unitSystem: google.maps.UnitSystem.METRIC,
            avoidHighways: false,
            avoidTolls: false
        }, callback);

        function callback(response, status) {
            if (status != google.maps.DistanceMatrixStatus.OK) {
              alert('Error was: ' + status);
            } else {

                var results = response.rows[0].elements;
                var destino = response.destinationAddresses;
                destino = destino.toString();

                if(results[0].status == "OK"){

                    var cidadesIguais = 0;
                    var estadosIguais = 0;

                    /* Reescreve a Sigla do estado para o nome completo */
                    estadoConsumidor = siglaEstado(estadoConsumidor);

                    var comp1   = new Array();
                    var comp2   = new Array();
                    var seq     = 0;

                    destino = destino.replace(/\d{5}-\d{3},/g,'');
                    destino = destino.replace(/-/g,',');
                    comp1 = destino.split(",");
                    var c1 = comp1.length;

                    var cidadeComp = "";
                    var estadoComp = "";

                    if(comp1[c1-3] !== undefined){ cidadeComp = comp1[c1-3]; }
                    if(comp1[c1-2] !== undefined){ estadoComp = comp1[c1-2]; }

                    if(cidadeComp.length > 0){
                        cidadeComp = retiraAcentos(cidadeComp);
                        cidadeConsumidor = retiraAcentos(cidadeConsumidor);
                    }

                    if(estadoComp.length > 0){
                        estadoComp = siglaEstado(estadoComp);
                        estadoComp = retiraAcentos(estadoComp);
                        estadoConsumidor = retiraAcentos(estadoConsumidor);
                    }

                    /* Compara se a cidade e o estado estão corretos */
                    if(estadoComp.length > 0){
                        if(estadoComp.trim() == estadoConsumidor.trim() || cidadeComp.trim() == cidadeConsumidor.trim()){
                            cidadesIguais++;
                            estadosIguais++;
                        }
                    }

                    if(cidadesIguais == 0 && estadosIguais == 0){
                        if(cidadeComp.trim().length > 0){
                            if(cidadeComp.trim() == cidadeConsumidor.trim()){
                                cidadesIguais++;
                            }
                        }
                        if(estadoComp.trim() == estadoConsumidor.trim()){
                            estadosIguais++;
                        }
                    }

                    var kmtotal1 = results[0].distance.value;

                    // getRouteInverse(kmtotal1, consumidor, posto);

                    /* Realiza a rota inversa */
                    var service2 = new google.maps.DistanceMatrixService();

                    function callback2(response2, status2){

                        if (status2 != google.maps.DistanceMatrixStatus.OK) {
                            var kmtotal = 0;
                            kmtotal = kmtotal1.toFixed(2);
                            kmtotal = kmtotal.toString();
                            kmtotal = kmtotal.replace(".", ",");

                        }else{

                            var results = response2.rows[0].elements;

                            if(results[0].status == "OK"){

                                var kmtotal = 0;
                                var kmtotal2 = results[0].distance.value;
                                kmtotal = (kmtotal1 + kmtotal2) / 1000;

                                kmtotal = kmtotal.toFixed(2);
                                kmtotal = kmtotal.toString();
                                kmtotal = kmtotal.replace(".", ",");

                                kmtotal1 = kmtotal1 / 1000;
                                kmtotal1 = kmtotal1.toFixed(2);
                                kmtotal1 = kmtotal1.toString();
                                kmtotal1 = kmtotal1.replace(".", ",");

                                kmtotal2 = kmtotal2 / 1000;
                                kmtotal2 = kmtotal2.toFixed(2);
                                kmtotal2 = kmtotal2.toString();
                                kmtotal2 = kmtotal2.replace(".", ",");

                                <?php
                                    if(strlen($qtde_km) > 0 || strlen($msg_erro) > 0){

                                        if(strlen($msg_erro) > 0){
                                            $distancia_km = $qtd_km;
                                            echo "alterarDistanciaVezes++;";
                                        };

                                        ?>

                                        if(qtdVezesRota == 0){

                                            if(alterarDistanciaVezes > 0){
                                                textIdaVolta = '<strong>Ida:</strong> '+kmtotal1+" &nbsp; <strong>Volta:</strong> "+kmtotal2;
                                                $('#ida_volta').html(textIdaVolta);
                                            }else{
                                                alterarDistanciaVezes++;
                                            }

                                            $('#distancia_km').val("");
                                            $('#distancia_km_conferencia').val("");
                                            $('#distancia_km').val("<?=$qtde_km;?>");
                                            $('#distancia_km_conferencia').val("<?=$qtde_km;?>");

                                            <?php
                                            if(strlen($msg_erro) > 0){
                                                ?>
                                                    if(erroCadastro > 0){
                                                        $('#distancia_km').val(kmtotal);
                                                        $('#distancia_km_conferencia').val(kmtotal);
                                                    }

                                                <?php
                                            }
                                            ?>
                                            var comp = compara();

                                            if(cidadesIguais != 0 && estadosIguais != 0){

                                                if(comp == 2){
                                                    $('#div_mapa_msg').html('Distância calculada <a href= "javascript: vermapa();">Ver mapa</a>');
                                                    $('#div_end_posto').html("<strong>Endereço do Posto:</strong> "+posto);
                                                }else{
                                                    $('#div_mapa_msg').html('A distância percorrida pelo técnico estará sujeito a auditoria');
                                                }
                                            }else{

                                                if(googleNaoEncontrou != 0){
                                                    $('#distancia_km').val("0");
                                                    $('#distancia_km_conferencia').val("0");
                                                    $('#div_mapa_msg').html("");
                                                    $('#div_end_posto').html("");
                                                    $('#ida_volta').html("");
                                                    if($('#tipo_atendimento').val() == 71){
                                                        alert('Endereço não localizado pelo Google Maps, por favor insira manualmente.');
                                                    }
                                                }

                                                googleNaoEncontrou++;

                                            }

                                            qtdVezesRota++;
                                        }else{
                                            $('#distancia_km').val("");
                                            $('#distancia_km').attr('value', kmtotal);

                                            if(alterarDistanciaVezes > 0){
                                                textIdaVolta = '<strong>Ida:</strong> '+kmtotal1+" &nbsp; <strong>Volta:</strong> "+kmtotal2;
                                                $('#ida_volta').html(textIdaVolta);
                                            }else{
                                                alterarDistanciaVezes++;
                                            }

                                            var comp = compara();

                                            if(cidadesIguais != 0 && estadosIguais != 0){
                                                if(comp == 2){
                                                    $('#div_mapa_msg').html('Distância calculada <a href= "javascript: vermapa();">Ver mapa</a>');
                                                    $('#div_end_posto').html("<strong>Endereço do Posto:</strong> "+posto);
                                                }else{
                                                    $('#div_mapa_msg').html('A distância percorrida pelo técnico estará sujeito a auditoria');
                                                }
                                            }else{

                                                if(googleNaoEncontrou != 0){
                                                    $('#distancia_km').val("0");
                                                    $('#distancia_km_conferencia').val("0");
                                                    $('#div_mapa_msg').html("");
                                                    $('#div_end_posto').html("");
                                                    $('#ida_volta').html("");
                                                    if($('#tipo_atendimento').val() == 71){
                                                        alert('Endereço não localizado pelo Google Maps, por favor insira manualmente.');
                                                    }
                                                }

                                                googleNaoEncontrou++;

                                            }
                                        }
                                        <?php
                                    }else{
                                        ?>
                                        if(cidadesIguais != 0 && estadosIguais != 0){

                                            textIdaVolta = '<strong>Ida:</strong> '+kmtotal1+" &nbsp; <strong>Volta:</strong> "+kmtotal2;
                                            $('#ida_volta').html(textIdaVolta);

                                            $('#distancia_km').val(kmtotal);
                                            $('#distancia_km_conferencia').val(kmtotal);
                                            $('#div_mapa_msg').html('Distância calculada <a href= "javascript: vermapa();">Ver mapa</a>');
                                            $('#div_end_posto').html("<strong>Endereço do Posto:</strong> "+posto);

                                        }else{

                                            $('#ida_volta').html("");

                                            $('#distancia_km').val("0");
                                            $('#distancia_km_conferencia').val("0");
                                            $('#div_mapa_msg').html('');
                                            $('#div_end_posto').html("");

                                            if($('#tipo_atendimento').val() == 71){
                                                alert('Endereço não localizado pelo Google Maps, por favor insira manualmente.');
                                            }
                                        }
                                <?php
                                    }
                                ?>

                            }
                        }
                    }

                    service2.getDistanceMatrix(
                    {
                        origins: [consumidor],
                        destinations: [posto],
                        travelMode: google.maps.TravelMode.DRIVING,
                        unitSystem: google.maps.UnitSystem.METRIC,
                        avoidHighways: false,
                        avoidTolls: false
                    }, callback2);

                }else{
                    $('#ida_volta').html("");
                    $('#distancia_km').val('');
                    $('#div_mapa_msg').html('');
                    $('#div_end_posto').html("<strong>Endereço do Posto:</strong> <em style='color: #ff0000;'>Não localizado</em>");
                    if(!$('#posto_nome').val() == ""){
                        alert('Endereço não localizado! Por favor verifique se os dados(Endereço, Cidade, Estado e CEP) do Consumidor e Posto estão corretos.');
                    }
                }
            }
        }

    }

    <? if (in_array($login_fabrica, array(30,50)) && strlen(trim($qtde_km)) == 0) { ?>
        <?php if($login_fabrica != 50){ ?>
            window.onload = calcRoute();
        <?php } else if($consumidor_revenda != "R" && $login_fabrica == 50){ ?>
            window.onload = calcRoute();
        <?php } ?>
    <? } ?>

    function vermapa_ANTIGO(){

        var posto = "";
        var consumidor = "";

        $("#GoogleMapsContainer").css({'display' : 'block', 'margin-left' : '-20%'});

        directionsDisplay = new google.maps.DirectionsRenderer();
        var mapOptions = {
          zoom: 7,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          center: new google.maps.LatLng(41.850033, -87.6500523)
        };
        var map = new google.maps.Map(document.getElementById('GoogleMaps'),
            mapOptions);

        directionsDisplay.setMap(map);
        directionsDisplay.setPanel(document.getElementById('DirectionPanel'));

        if($('#contato_endereco').val() != "" || $('#contato_cidade').val() != "" || $('#contato_estado').val() == ""){
            posto += document.getElementById("contato_endereco").value;
            if($('#contato_numero').val() != ""){ posto += " "+document.getElementById("contato_numero").value; }
            if($('#contato_bairro').val() != ""){ posto += ", "+document.getElementById("contato_bairro").value; }
            posto += ", "+document.getElementById("contato_cidade").value;
            posto += ", "+document.getElementById("contato_estado").value;
        }else if($('#contato_cep').val() != ""){
            posto = $('#contato_cep').val();
        }else{
            alert("Dados insuficientes do Posto para realizar Rota e Calculo da Distância, por favor verificar se há endereço, cidade, estado e CEP.");
            return;
        }

        if($('#consumidor_endereco').val() != "" || $('#consumidor_cidade').val() != "" || $('#consumidor_cidade').val() != ""){
            consumidor += document.getElementById("consumidor_endereco").value;
            if($('#consumidor_numero').val() != "") { consumidor += " "+document.getElementById("consumidor_numero").value; }
            if($('#consumidor_bairro').val() != "") { consumidor += " "+document.getElementById("consumidor_bairro").value; }
            consumidor += ", "+document.getElementById("consumidor_cidade").value;
            consumidor += ", "+document.getElementById("consumidor_estado").value;
        }else if($('#consumidor_cep').val() != ""){
            consumidor = $('#consumidor_cep').val();
        }else{
            alert("Dados insuficientes do Consumidor para realizar Rota e Calculo da Distância, por favor verificar se há endereço, cidade, estado e CEP.");
            return;
        }

        if(posto == ""){
            alert('Endereço do Posto não localizado! Por favor verifique se os dados es corretos!');
            return;
        }

        if(consumidor == ""){
            if($('#consumidor_cep').val() == ""){
                alert('Por favor insira o Consumidor');
                $('#consumidor_nome').focus();
                return;
            }else{
                consumidor = $('#consumidor_cep').val();
            }
        }

        var start = posto;
        var end = consumidor;

        var request = {
              origin: start,
              destination: end,
              travelMode: google.maps.DirectionsTravelMode.DRIVING
            };
            directionsService.route(request, function(response, status) {
              if (status == google.maps.DirectionsStatus.OK) {

                directionsDisplay.setDirections(response);

            }
        });

    }

    function fechaMapa(){

        $("#GoogleMapsContainer").css({'display' : 'none'});

    }

    function compara(){

        var campo1 = "";
        var campo2 = "";

        campo1 = $('#distancia_km_conferencia').val();
        campo2 = $('#distancia_km').val();

        var num1 = campo1.replace(".",",");
        var num2 = campo2.replace(".",",");

        if(num1 != num2){
            return 1;
        }else{
            return 2;
        }

    }

    $("#informar_km").click(function(){
        if($(this).is(":checked")){
            $("#div_mapa").css({'display' : 'block'});
        }else{
            $("#div_mapa").css({'display' : 'none'});
        }
    });

</script>

<?php if ($login_fabrica == 30) { ?>
        <script> 
            $(document).ready(function(){
                getSolucoes();
            });
        </script>
<?php } ?>

<? include_once "rodape.php";

function validaIntervencao($os){
    global $con;
    global $login_fabrica;
    if(!in_array($login_fabrica,array(6))){
        return;
    }
    if(emIntervencao($os) || !temPecaCritica($os)){
        return;
    }
    $result = pg_query($con,'BEGIN TRANSACTION');
    if(!$result)
        throw new Exception(pg_last_error($con));
    try{
        $sql = 'INSERT INTO tbl_os_status (os,status_os,data,observacao) values ($1,$2,current_timestamp,$3)';
        $params = array($os,62,'Peça da O.S. com intervenção da fábrica.');
        $result = pg_query_params($con,$sql,$params);
        if(!$result)
            throw new Exception(pg_last_error($con));
        $result = pg_query($con,'COMMIT TRANSACTION');
        if(!$result)
            throw new Exception(pg_last_error($con));
    }
    catch(Exception $ex){
        pg_query($con,'ROLLBACK TRANSACTION');
        throw $ex;
    }
}

function emIntervencao($os){
    global $con;
    $sql = 'SELECT status_os = 62 FROM tbl_os_status WHERE os = $1 ORDER BY data DESC LIMIT 1;';
    $params = array($os);
    $result = pg_query_params($con,$sql,$params);
    if(!$result)
        throw new Exception(pg_last_error($con));
    if(pg_num_rows($result) == 0)
        return false;
    $intervencao = pg_fetch_result($result,0,0);
    return $intervencao;
}

function temPecaCritica($os){
    global $con;
    global $login_fabrica;
    $sql = 'SELECT tbl_os.os,COUNT(*),SUM(tbl_os_item.qtde)
            FROM tbl_os
            INNER JOIN tbl_os_produto
                ON (tbl_os.os = tbl_os_produto.os)
            INNER JOIN tbl_os_item
                ON (tbl_os_produto.os_produto = tbl_os_item.os_produto)
            INNER JOIN tbl_peca
                ON (tbl_os_item.peca = tbl_peca.peca AND tbl_os.fabrica = tbl_peca.fabrica)
            WHERE tbl_os.os = $1
            AND tbl_os.fabrica = $2
            AND tbl_peca.peca_critica = true
            GROUP BY tbl_os.os';
    $params = array($os,$login_fabrica);
    $result = pg_query_params($con,$sql,$params);
    if(!$result)
        throw new Exception(pg_last_error($con));
    if(pg_num_rows($result) == 0)
        return false;
    $assoc = pg_fetch_assoc($result);
    if($assoc['count'] >0 && $assoc['sum'] >0 ) 
        return true;
    return false;
}
