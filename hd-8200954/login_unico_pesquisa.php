<?include 'dbconfig.php';include 'includes/dbconnect-inc.php';include "login_unico_autentica_usuario.php";$q = strtolower($_GET["q"]);if (isset($_GET["q"])){	$login_fabrica = 45;	$tipo_busca    = $_GET["busca"];	$tipo          = $_GET["tipo"];	$produto       = $_GET["produto"];	if (strlen($q)>2){		//--== Inicio da Busca de Peças ==--		if($tipo=="peca"){			$sql = "SELECT   tbl_posto_fabrica.item_aparencia,						 tbl_posto_fabrica.tabela				FROM     tbl_posto				JOIN     tbl_posto_fabrica USING(posto)				WHERE    tbl_posto.posto           = $login_posto				AND      tbl_posto_fabrica.fabrica = $login_fabrica";			$res = pg_exec ($con,$sql);			if (pg_numrows ($res) > 0) {				$item_aparencia = pg_result($res,0,item_aparencia);				$tabela         = pg_result($res,0,tabela);			}			if ($item_aparencia == 'f') $sql_add .= " AND item_aparencia IS FALSE ";			if ($tipo_busca=='referencia')   $sql_add .= " AND UPPER(TRIM(referencia)) ILIKE UPPER(TRIM('%$q%')) ";			if ($tipo_busca=='descricao')    $sql_add .= " AND UPPER(TRIM(descricao)) ILIKE UPPER(TRIM('%$q%')) ";			$sql =	"SELECT z.peca                                ,							z.referencia       AS peca_referencia ,							z.descricao        AS peca_descricao  ,							z.bloqueada_garantia                  ,							z.peca_fora_linha                     ,							z.de                                  ,							z.para                                ,							z.peca_para                           ,							tbl_peca.descricao AS para_descricao  ,							z.libera_garantia					FROM (							SELECT  y.peca               ,									y.referencia         ,									y.descricao          ,									y.bloqueada_garantia ,									y.peca_fora_linha    ,									tbl_depara.de        ,									tbl_depara.para      ,									tbl_depara.peca_para ,									y.libera_garantia							FROM (									SELECT  x.peca                                      ,											x.referencia                                ,											x.descricao                                 ,											x.bloqueada_garantia                        ,											tbl_peca_fora_linha.peca AS peca_fora_linha ,											tbl_peca_fora_linha.libera_garantia									FROM (											SELECT  tbl_peca.peca              ,													tbl_peca.referencia        ,													tbl_peca.descricao         ,													tbl_peca.bloqueada_garantia											FROM  tbl_peca 											WHERE fabrica = $login_fabrica											AND   ativo                    IS     TRUE											AND   tbl_peca.produto_acabado IS NOT TRUE											$sql_add									) AS x									LEFT JOIN tbl_peca_fora_linha ON tbl_peca_fora_linha.peca = x.peca							) AS y							LEFT JOIN tbl_depara ON tbl_depara.peca_de = y.peca							JOIN tbl_lista_basica ON y.peca = tbl_lista_basica.peca							WHERE produto = $produto					) AS z					LEFT JOIN tbl_peca ON tbl_peca.peca = z.peca_para					ORDER BY z.referencia, z.descricao";			$res = @pg_exec($con,$sql);			$res = pg_exec($con,$sql);			if (pg_numrows ($res) > 0) {				for ($i=0; $i<pg_numrows ($res); $i++ ){					$peca       = trim(pg_result($res,$i,peca));					$descricao  = trim(pg_result($res,$i,peca_descricao));					$referencia = trim(pg_result($res,$i,peca_referencia));					echo "$peca|$referencia|$descricao|<span style='font-size:10px;font-family:verdana;'>$referencia - $descricao</span>\n";				}			}		}		//--== Fim da Busca de Peças ==--		//--== Inicio da Busca de Produtos ==--		if($tipo=="produto"){			$sql = "				SELECT  PR.produto   ,						PR.descricao ,						PR.referencia,						FA.nome      				FROM tbl_produto PR				JOIN tbl_linha   LI USING(linha)				JOIN tbl_fabrica FA USING(fabrica)				WHERE  fabrica=45				";			if ($tipo_busca == "codigo") $sql .= " AND UPPER(PR.referencia) LIKE UPPER('%$q%') ";			else                         $sql .= " AND UPPER(PR.descricao)  LIKE UPPER('%$q%') ";			$res = pg_exec($con,$sql);			if (pg_numrows ($res) > 0) {				for ($i=0; $i<pg_numrows ($res); $i++ ){					$produto    = trim(pg_result($res,$i,produto));					$descricao  = trim(pg_result($res,$i,descricao));					$referencia = trim(pg_result($res,$i,referencia));					$fabrica    = trim(pg_result($res,$i,nome));					if($cor<>'#FFFFFF') $cor = "#FFFFFF";					else                $cor = "#EEEEEE";					echo "$produto|$referencia|$descricao|$fabrica|<span style='font-size:10px;font-family:verdana;'>$referencia - $descricao<br>Fabricante: $fabrica</div>\n";				}			}		}		//--== Fim da Busca de Produtos ==--		//--== Inicio da Busca de RG ==--		if($tipo=="rg"){			$sql = "SELECT  RI.produto_rg_item,							RI.rg             ,							RI.codigo_barra					FROM tbl_produto_rg      RG					JOIN tbl_produto_rg_item RI USING(produto_rg)					WHERE RG.posto   = $login_posto					AND   RI.produto IS NULL					AND   RI.rg ILIKE '%$q%'";			$res = pg_exec($con,$sql);			if (pg_numrows ($res) > 0) {				for ($i=0; $i<pg_numrows ($res); $i++ ){					$produto_rg_item = trim(pg_result($res,$i,produto_rg_item));					$rg              = trim(pg_result($res,$i,rg));					$codigo_barra    = trim(pg_result($res,$i,codigo_barra));					if($cor<>'#FFFFFF') $cor = "#FFFFFF";					else                $cor = "#EEEEEE";					echo "$produto_rg_item|$rg|$codigo_barra|xxx|<span style='font-size:10px;font-family:verdana;'>RG: $rg - Código Barra: $codigo_barra</div>\n";				}			}		}		//--== Fim da Busca de RG ==--	}	exit;}?>