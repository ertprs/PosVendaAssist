<?include 'dbconfig.php';include 'includes/dbconnect-inc.php';include 'autentica_usuario.php';include "cabecalho-ajax.php";if (isset($_GET["q"])){	$q      = strtolower($_GET["q"]);	if (strlen($q)>2){		$y = trim (strtoupper ($q));		$palavras = explode(' ',$y);		$count = count($palavras);		$sql_and = "";		for($i=0 ; $i < $count ; $i++){			if(strlen(trim($palavras[$i]))>0){				$referencia_pesquisa = trim($palavras[$i]);				$referencia_pesquisa = str_replace (' ','',$referencia_pesquisa);				$referencia_pesquisa = str_replace ('-','',$referencia_pesquisa);				$referencia_pesquisa = str_replace ('\'','',$referencia_pesquisa);				$referencia_pesquisa = str_replace ('.','',$referencia_pesquisa);				$referencia_pesquisa = str_replace ('/','',$referencia_pesquisa);				$referencia_pesquisa = str_replace ('\\','',$referencia_pesquisa);				$sql_and .= " AND (tbl_peca.descricao ILIKE '%".trim($palavras[$i])."%' OR tbl_peca.referencia_pesquisa ILIKE '%$referencia_pesquisa%' )";			}		}	if ($login_tipo_posto <> 236) { 		$sql_cond = "AND   tbl_peca.produto_acabado IS NOT TRUE ";	}		$sql = "SELECT	tbl_peca.peca, 						tbl_peca.descricao, 						tbl_peca.referencia				FROM tbl_peca				WHERE   fabrica = $login_fabrica $sql_and				and tbl_peca.fabrica = $login_fabrica				and tbl_peca.ativo IS TRUE				$sql_cond				ORDER BY tbl_peca.referencia				LIMIT 15";				echo `echo "$sql" > /tmp/x.x2`;				//var_dump($sql);		$res = pg_exec($con,$sql);		//		echo nl2br($sql);		if (pg_numrows ($res) > 0) {			for ($i=0; $i<pg_numrows ($res); $i++ ){				$mudou= "";				$peca         = trim(pg_result($res,$i,peca));				$referencia   = trim(pg_result($res,$i,referencia));				$descricao    = trim(pg_result($res,$i,descricao));				$sqldepara = "SELECT  tbl_depara.para,							tbl_peca.descricao,							tbl_peca.referencia				FROM    tbl_depara				JOIN    tbl_peca on tbl_peca.referencia = tbl_depara.para and tbl_peca.fabrica = $login_fabrica				WHERE   tbl_depara.de    = '$referencia'				AND     tbl_depara.fabrica = $login_fabrica;";				$res1 = pg_query ($con,$sqldepara);				if (pg_num_rows($res1) > 0) {					$xpeca_para            = trim(pg_fetch_result ($res1,0,para));					$xreferencia_peca_para = trim(pg_fetch_result ($res1,0,referencia));					$xdescricao_peca_para  = trim(pg_fetch_result ($res1,0,descricao));					$cor = "#00B95C";					$cod = $xpeca_para;					$mudou = 'SIM';				}				#HD 343316				$sql_fora_linha = " SELECT * 									FROM tbl_peca_fora_linha 									WHERE fabrica = $login_fabrica 									AND referencia = '$referencia'								  ";				$res_fora_linha = pg_query($con,$sql_fora_linha);												if ($cor <> "#FFFFFF") {					$cor =  "#FFFFFF";				}else{					$cor =  "#EEEEEE";				}				if ($mudou == 'SIM') {					if (pg_numrows($res_fora_linha)>0){						$sql_fora_linha2 = "							SELECT * 									FROM tbl_peca_fora_linha 									WHERE fabrica = $login_fabrica 									AND referencia = '$xreferencia_peca_para'						";						$res_fora_linha2 = pg_query($con,$sql_fora_linha2);						if (pg_num_rows($res_fora_linha2)>0){							echo " | | |<span style='font-size:10px;font-family:verdana;color:red;background-color:$cor '> a pe&ccedila $referencia  mudou para -> $xreferencia_peca_para - mas ambas est&atildeo fora de linha</span>\n";						}else{							echo "$xpeca_para|$xreferencia_peca_para|$xreferencia_peca_para - $xdescricao_peca_para |<span style='font-size:10px;font-family:verdana;color:red;background-color:$cor'>a pe&ccedila $referencia - $descricao mudou para -> $xreferencia_peca_para - $xdescricao_peca_para </span>\n";						}											}else{													echo "$xpeca_para|$xreferencia_peca_para|$xreferencia_peca_para - $xdescricao_peca_para |<span style='font-size:10px;font-family:verdana;color:red;background-color:$cor'>a pe&ccedila $referencia - $descricao mudou para -> $xreferencia_peca_para - $xdescricao_peca_para </span>\n";					}				}else {					if (pg_numrows($res_fora_linha)>0){						echo " | | |<span style='font-size:10px;font-family:verdana;color:red;background-color:$cor '> a pe&ccedila $referencia - $descricao - est&aacute fora de linha</span>\n";					}else{						echo "$peca|$referencia|$referencia - $descricao |<span style='font-size:10px;font-family:verdana;'>$referencia - $descricao </span>\n";						}									}			}		}else{			echo "| | |Pe&ccedil;a n&atilde;o encontrada";		}	}}?>