<?php
header("X-Frame-Options: ALLOW-FROM https://midea.cscloud.biz");
// HD 706810 SEGUNDO O HD 424887, a fricon deveria ficar sem integridade de defeito_reclamado.
//E foi esquecido de colocar nesta tela também
$fabricas_defeito_reclamado_sem_integridade = array();
$fabricas_validam_campos_obrigatorios = array(11,81,114,153,155,157,158,165,172,191);
$fab_usa_tipo_cons = array(51); // HD 317864
$programa_insert = $_SERVER['PHP_SELF'];

include 'dbconfig.php';
include 'includes/dbconnect-inc.php';
include '../class/json.class.php';

$admin_privilegios="call_center";
include 'autentica_admin.php';
include_once '../class/communicator.class.php';
require_once '../helpdesk.inc.php';
require_once '../funcoes.php';

if ($atendimentoML == true) {
    require '../classes/Posvenda/Meli/meli.php';
}

if(in_array($login_fabrica, [169,170])){
    include_once '../classes/Mirrors/Queue/PushQueue.php';
}

if ($integracaoTelefonia === true OR $atendimentoML == true OR $atendimentoFacebook == true) {
    include '../plugins/fileuploader/TdocsMirror.php';
}

use Posvenda\Cockpit;
use Posvenda\TcMaps;

if(in_array($login_fabrica,[180,181,182])){
  
  if(strlen($_GET['callcenter']) > 0){

    $cond = "?callcenter=".$_GET['callcenter'];

  }

  header("Location:callcenter_interativo_new_lam.php$cond");

  exit;
}

if($_POST['ajax_tipo_protocolo_classificacao']){

    $tipo_protocolo = $_POST['tipo_protocolo'];

    $sql = "SELECT tbl_hd_classificacao.hd_classificacao,
                    tbl_hd_classificacao.descricao
            FROM tbl_hd_classificacao
            JOIN tbl_hd_tipo_chamado_vinculo USING(hd_classificacao)
            JOIN tbl_hd_tipo_chamado USING(hd_tipo_chamado)
            WHERE tbl_hd_tipo_chamado.fabrica = {$login_fabrica}
            AND tbl_hd_tipo_chamado_vinculo.hd_tipo_chamado = {$tipo_protocolo}
	    AND tbl_hd_classificacao.ativo IS TRUE";
    $res = pg_query($con,$sql);

    if(pg_num_rows($res) > 0){

        $retorno = "<option value=''>Escolha</option>";

        foreach (pg_fetch_all($res) as $key => $value) {
            $retorno .= "<option value='".$value['hd_classificacao']."'>".$value['descricao']."</option>";
        }

    }

    echo $retorno; exit;
}

if($_POST['ajax_tipo_protocolo_origem']){

    $tipo_protocolo = $_POST['tipo_protocolo'];

    $sql = "SELECT tbl_hd_chamado_origem.hd_chamado_origem,
                    tbl_hd_chamado_origem.descricao
            FROM tbl_hd_chamado_origem
            JOIN tbl_hd_tipo_chamado_vinculo USING(hd_chamado_origem)
            JOIN tbl_hd_tipo_chamado USING(hd_tipo_chamado)
            WHERE tbl_hd_tipo_chamado.fabrica = {$login_fabrica}
            AND tbl_hd_tipo_chamado_vinculo.hd_tipo_chamado = {$tipo_protocolo}";
    $res = pg_query($con,$sql);

    if(pg_num_rows($res) > 0){

        $retorno = "<option value=''>Escolha</option>";

        foreach (pg_fetch_all($res) as $key => $value) {
            $retorno .= "<option value='".$value['hd_chamado_origem']."'>".$value['descricao']."</option>";
        }

    }

    echo $retorno; exit;
}

if (!empty($_REQUEST['ajax_recarrega_estados_pais'])) {
    $paisHD = $_REQUEST['pais'];
    $resEstadosDoPais = getListaDeEstadosDoPais($paisHD);

    echo json_encode($resEstadosDoPais);
    exit;
}

if ($_POST['ajax_verifica_assistencia_cidade'] == true) {

    $produtoId        = $_POST['produto_id'];
    $linhaProduto     = $_POST['linha_produto'];
    $cidadeConsumidor = $_POST['cidade_consumidor'];
    $estadoConsumidor = $_POST['estado_consumidor'];

    if (empty($produtoId)) {

        $referenciaProd = trim($_POST['produto_referencia']);

        $sql = "SELECT produto
                FROM tbl_produto
                WHERE UPPER(referencia) = UPPER('{$referenciaProd}')
                AND fabrica_i = {$login_fabrica}";
        $res = pg_query($con, $sql);

        $produtoId = pg_fetch_result($res, 0, 'produto');

    }

    $retorno = retorna_dados_analise_obrigatoria($produtoId, $linhaProduto, $cidadeConsumidor, $estadoConsumidor);

    exit(json_encode($retorno));
}

if (isset($_POST["verifica_cnpj_bloqueio"])) {

    $cnpj = str_replace([".","-","/"], "", $_POST["cnpj"]);

    $sql = "SELECT tbl_revenda_fabrica.data_bloqueio
            FROM tbl_revenda_fabrica 
            INNER JOIN tbl_revenda on tbl_revenda.revenda = tbl_revenda_fabrica.revenda
            WHERE fabrica = $login_fabrica
            AND tbl_revenda.cnpj = '{$cnpj}'
            AND tbl_revenda_fabrica.data_bloqueio IS NOT NULL";
    $res = pg_query($con, $sql);

    $retorno = [
        "bloqueada" => false
    ];
    if (pg_num_rows($res) > 0) {

        $retorno = [
            "bloqueada" => true
        ];

    }

    exit(json_encode($retorno));

}

if($_POST['ajax_prorroga_providencia'] == true){
    $hd_chamado = $_POST['hd_chamado'];

    $sql = "SELECT prazo_dias FROM tbl_hd_motivo_ligacao INNER JOIN tbl_hd_chamado_extra USING(hd_motivo_ligacao) WHERE hd_chamado = {$hd_chamado}";
    $res = pg_query($con, $sql);

    if(strlen(pg_last_error()) == 0){
        
        $prazo_dias = pg_fetch_result($res, 0, 'prazo_dias');

        if(strlen(pg_last_error()) == 0){
	    $sql = "SELECT fn_calcula_previsao_retorno(current_date,{$prazo_dias},{$login_fabrica})::date AS data_providencia";
            $res = pg_query($con,$sql);
	    $data_providencia = pg_fetch_result($res, 0, 'data_providencia');
	    list($a,$m,$d) = explode("-",$data_providencia);
	    $data_providencia = "$d/$m/$a";
        }
    }

    if(strlen(pg_last_error()) > 0){
        exit(json_encode(array("erro" => true, "msg" => "Erro ao alterar providencia")));
    }else{
        exit(json_encode(array("erro" => false, "msg" => $data_providencia)));
    }

}

if($_POST['ajax_verifica_situacao_providencia'] == true){
    $hd_chamado = $_POST['hd_chamado'];
    $providencia = $_POST['providencia'];
    $status   = $_POST['status'];

    if(!empty($hd_chamado)){
        $sql = "SELECT hd_motivo_ligacao FROM tbl_hd_chamado_extra WHERE hd_chamado = {$hd_chamado}";
        $res = pg_query($con,$sql);
        $hd_motivo_ligacao = pg_fetch_result($res, 0, 'hd_motivo_ligacao');
    }

    $sql = "SELECT campos_adicionais FROM tbl_hd_motivo_ligacao WHERE hd_motivo_ligacao = {$providencia}";
    $res = pg_query($con, $sql);

    if(strlen(pg_last_error()) == 0){
        
        $campos_adicionais = json_decode(pg_fetch_result($res, 0, 'campos_adicionais'),true);

        if(count($campos_adicionais['situacoes']) > 0 AND !in_array($status,$campos_adicionais['situacoes'])){
            exit(json_encode(array("erro" => true, "msg" => "A providencia informada nao pode ser utilizada com o status atual do atendimento","anterior" => $hd_motivo_ligacao)));
        }else{
            exit(json_encode(array("erro" => false)));
        }

    }

    exit(json_encode(array("erro" => false)));

}

if(array_key_exists("ajax_verifica_fabrica", $_POST)) {
    if($_POST['fabrica_atendimento'] == $login_fabrica) {
        echo "true";
    } else {
        echo "false";
    }
    exit;
}

if ($_POST["ajax_remove_hd_item"] == true) {

	$hd_chamado_item = $_POST["hd_chamado_item"];

	$sql = "DELETE FROM tbl_hd_chamado_item WHERE hd_chamado_item = {$hd_chamado_item}";

	$res = pg_query($con, $sql);
	if (pg_last_error()) {
		exit(json_encode(array("erro" => true, "msg" => pg_last_error())));
	} else {
		exit(json_encode(array("erro" => false, "msg" => "Removido com sucesso")));
	}

}

if(isset($_POST["ajax_busca_familias_produto"])){

    $referenciaProdutoFamilia = $_POST['referencia_produto_familia'];

    $sqlFamiliaProduto = "SELECT tbl_familia.familia,tbl_familia.descricao FROM tbl_familia 
                          JOIN tbl_produto ON tbl_familia.fabrica = tbl_produto.fabrica_i AND
                                              tbl_familia.familia = tbl_produto.familia AND
                                              tbl_familia.fabrica = {$login_fabrica} AND
                                              tbl_produto.referencia = '{$referenciaProdutoFamilia}'";

    $resFamiliaProduto = pg_query($con, $sqlFamiliaProduto);

    if(pg_num_rows($resFamiliaProduto) > 0){

        $resultFamiliaProduto = [
            'familia' => pg_fetch_result($resFamiliaProduto, 0, 'familia'), 
            'descricao' => utf8_encode(pg_fetch_result($resFamiliaProduto, 0, 'descricao'))
        ];

        exit(json_encode(array('result' => $resultFamiliaProduto)));

    }else{
        exit(json_encode(array('result' => false)));
    }
}

if(isset($_POST["ajax_busca_voucher_ativo"])){

    $familiaProduto = $_POST['familia_produto'];
    $sqlVoucherAtivo = "SELECT voucher, codigo FROM tbl_voucher WHERE fabrica = {$login_fabrica} AND familia = {$familiaProduto} AND upper(status) = 'ATIVO'";
    $resVoucherAtivo = pg_query($con, $sqlVoucherAtivo);

    if(pg_num_rows($resVoucherAtivo) > 0){
        exit(json_encode(['id_voucher' => pg_fetch_result($resVoucherAtivo, 0, 'voucher'), 'codigo' => pg_fetch_result($resVoucherAtivo, 0, 'codigo')]));
    }else{
        exit(json_encode(['codigo' => false]));
    }
}

if ($login_fabrica == 189){

    $sqlOrigemTrava = "SELECT hd_chamado_origem FROM tbl_hd_chamado_origem WHERE fabrica={$login_fabrica} AND TRIM(UPPER(fn_retira_especiais(descricao))) IN ('FALE CONOSCO','NAO PROCEDE','INDICACAO DE REPRESENTANTE','INDICACAO DE REVENDA','ATENDENTE TELECONTROL');";
    $resOrigemTrava = pg_query($con, $sqlOrigemTrava);
    $array_trava_origem = [];
    if (pg_num_rows($resOrigemTrava) > 0) {
        foreach (pg_fetch_all($resOrigemTrava) as $key => $value) {
            $array_trava_origem[] = $value["hd_chamado_origem"];
        }
    }

    if (isset($_GET["ajax"]) && $_GET["ajax"] == "carrega_classificacao") {
        $origem = $_GET["origem"];

        $sql = "SELECT tbl_hd_classificacao.hd_classificacao, tbl_hd_classificacao.descricao
                  FROM tbl_hd_fluxo_atendimento
                  JOIN tbl_hd_classificacao ON tbl_hd_classificacao.hd_classificacao=tbl_hd_fluxo_atendimento.hd_classificacao AND tbl_hd_classificacao.fabrica={$login_fabrica}
                 WHERE tbl_hd_fluxo_atendimento.fabrica = {$login_fabrica}
                   AND tbl_hd_fluxo_atendimento.hd_chamado_origem = {$origem}
                   AND tbl_hd_fluxo_atendimento.hd_classificacao IS NOT NULL";

        $res = pg_query($con, $sql);
        if (pg_num_rows($res) > 0) {
            $option .= "<option value=''>Escolha ...</option>";
            foreach (pg_fetch_all($res) as $key => $row) {
                $option .= "<option value='".$row["hd_classificacao"]."'>".$row["descricao"]."</option>";
            }
        } else {
            $option .= "<option value=''>Nenhum registro encontrado</option>";
        }
        exit($option);

    }
    if (isset($_GET["ajax"]) && $_GET["ajax"] == "carrega_subclassificacao") {

        $hd_classificacao = $_GET["hd_classificacao"];

        $sql = "SELECT tbl_hd_subclassificacao.hd_subclassificacao, tbl_hd_subclassificacao.descricao
                  FROM tbl_hd_fluxo_atendimento
                  JOIN tbl_hd_subclassificacao ON tbl_hd_subclassificacao.hd_subclassificacao=tbl_hd_fluxo_atendimento.hd_subclassificacao AND tbl_hd_subclassificacao.fabrica={$login_fabrica}
                 WHERE tbl_hd_fluxo_atendimento.fabrica = {$login_fabrica}
                   AND tbl_hd_fluxo_atendimento.hd_classificacao = {$hd_classificacao}
                   AND tbl_hd_fluxo_atendimento.hd_subclassificacao IS NOT NULL";

        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0) {
            $option .= "<option value=''>Escolha ...</option>";
            foreach (pg_fetch_all($res) as $key => $row) {
                $option .= "<option value='".$row["hd_subclassificacao"]."'>".$row["descricao"]."</option>";
            }
        } else {
            $option .= "<option value=''>Nenhum registro encontrado</option>";
        }
        exit($option);

    }
    if (isset($_GET["ajax"]) && $_GET["ajax"] == "carrega_providencia") {

        $hd_subclassificacao = $_GET["hd_subclassificacao"];

        $sql = "SELECT tbl_hd_motivo_ligacao.hd_motivo_ligacao, tbl_hd_motivo_ligacao.descricao
                  FROM tbl_hd_fluxo_atendimento
                  JOIN tbl_hd_motivo_ligacao ON tbl_hd_motivo_ligacao.hd_motivo_ligacao=tbl_hd_fluxo_atendimento.hd_motivo_ligacao AND tbl_hd_motivo_ligacao.fabrica={$login_fabrica}
                 WHERE tbl_hd_fluxo_atendimento.fabrica = {$login_fabrica}
                   AND tbl_hd_fluxo_atendimento.hd_subclassificacao = {$hd_subclassificacao}
                   AND tbl_hd_fluxo_atendimento.hd_motivo_ligacao IS NOT NULL";

        $res = pg_query($con, $sql);
        if (pg_num_rows($res) > 0) {
            $option .= "<option value=''>Escolha ...</option>";
            foreach (pg_fetch_all($res) as $key => $row) {
                $option .= "<option value='".$row["hd_motivo_ligacao"]."'>".$row["descricao"]."</option>";
            }
        } else {
            $option .= "<option value=''>Nenhum registro encontrado</option>";
        }
        exit($option);
    }
    if (isset($_GET["ajax"]) && $_GET["ajax"] == "carrega_custos_atendimentos") {

        function geraValorReais($valor) {
            $valorTratado = 'R$ '.number_format($valor, 2, ',', '.');
            return $valorTratado;
        }

        $sql = "SELECT
                       tbl_hd_chamado_custo.hd_chamado_categoria_custo,
                       tbl_hd_chamado_custo.taxa_banco,
                       tbl_hd_chamado_custo.juros,
                       tbl_hd_chamado_custo.frete_ida,
                       tbl_hd_chamado_custo.frete_volta,
                       tbl_hd_chamado_custo.reentrega,
                       tbl_hd_chamado_custo.reprocesso,
                       tbl_hd_chamado_custo.extras,
                       tbl_hd_chamado_categoria_custo.descricao
                  FROM tbl_hd_chamado_custo
                  JOIN tbl_hd_chamado_categoria_custo USING(hd_chamado_categoria_custo,fabrica)
                 WHERE tbl_hd_chamado_custo.fabrica = {$login_fabrica}
                   AND tbl_hd_chamado_custo.hd_chamado = ".$_GET['callcenter']."

                   ORDER BY tbl_hd_chamado_categoria_custo.descricao ASC
                   ";

        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0) {
            $conteudo = "<table>
                            <thead>
                                <tr>
                                    <th class='titulo_coluna titulo_viapol'>Setor</th>
                                    <th class='titulo_coluna titulo_viapol'>Taxa Banco</th>
                                    <th class='titulo_coluna titulo_viapol'>Juros</th>
                                    <th class='titulo_coluna titulo_viapol'>Frete Ida</th>
                                    <th class='titulo_coluna titulo_viapol'>Frete Volta</th>
                                    <th class='titulo_coluna titulo_viapol'>Reentrega</th>
                                    <th class='titulo_coluna titulo_viapol'>Reprocesso / Descarte</th>
                                    <th class='titulo_coluna titulo_viapol'>Custos Extras</th>
                                    <th class='titulo_coluna titulo_viapol'>Subtotal</th>
                                    <th class='titulo_coluna titulo_viapol'>ação</th>
                                </tr>
                            </thead>
                            <tbody>

            ";
            foreach (pg_fetch_all($res) as $key => $row) {
                $retorno[$row["descricao"]]["total_taxa_banco"] += $row["taxa_banco"];
                $retorno[$row["descricao"]]["total_juros"] += $row["juros"];
                $retorno[$row["descricao"]]["total_frete_ida"] += $row["frete_ida"];
                $retorno[$row["descricao"]]["total_frete_volta"] += $row["frete_volta"];
                $retorno[$row["descricao"]]["total_reentrega"] += $row["reentrega"];
                $retorno[$row["descricao"]]["total_reprocesso"] += $row["reprocesso"];
                $retorno[$row["descricao"]]["total_extras"] += $row["extras"];
                $retorno[$row["descricao"]]["hd_chamado_categoria_custo"] = $row["hd_chamado_categoria_custo"];

            }
            foreach ($retorno as $key => $row) {
                $subtotal = ($row["total_taxa_banco"]+$row["total_juros"]+$row["total_frete_ida"]+$row["total_frete_volta"]+$row["total_reentrega"]+$row["total_reprocesso"]+$row["total_extras"]);
                $conteudo .= "
                            <tr>
                                <td class='conteudo_viapol'>".$key."</td>
                                <td class='tac conteudo_viapol'>".geraValorReais($row["total_taxa_banco"])."</td>
                                <td class='tac conteudo_viapol'>".geraValorReais($row["total_juros"])."</td>
                                <td class='tac conteudo_viapol'>".geraValorReais($row["total_frete_ida"])."</td>
                                <td class='tac conteudo_viapol'>".geraValorReais($row["total_frete_volta"])."</td>
                                <td class='tac conteudo_viapol'>".geraValorReais($row["total_reentrega"])."</td>
                                <td class='tac conteudo_viapol'>".geraValorReais($row["total_reprocesso"])."</td>
                                <td class='tac conteudo_viapol'>".geraValorReais($row["total_extras"])."</td>
                                <td class='tac conteudo_viapol'>".geraValorReais($subtotal)."</td>
                                <td class='tac conteudo_viapol'><button data-setor='".$row['hd_chamado_categoria_custo']."' data-chamado='".$_GET['callcenter']."' class='btn_editar btn_edita_custo_atendimento' type='button'>Editar</button></td>
                            </tr>";
            }

            $conteudo .= "</tbody></table>";
        } else {
            $conteudo = "";
        }
        exit($conteudo);

    }
}

if ($login_fabrica == 178){
    if (isset($_POST["ajax_busca_defeito_reclamado"]) && !empty($_POST["produto"])) {

        $produto = $_POST["produto"];

        $joinFamilia = "
            INNER JOIN tbl_familia ON tbl_familia.familia = tbl_diagnostico.familia AND tbl_familia.fabrica = {$login_fabrica}
            INNER JOIN tbl_produto ON tbl_produto.familia = tbl_familia.familia AND tbl_produto.fabrica_i = {$login_fabrica}
        ";
        $whereProduto = "
            AND tbl_produto.produto = {$produto}
        ";
        $sql = "SELECT
                DISTINCT tbl_defeito_reclamado.defeito_reclamado,
                tbl_defeito_reclamado.codigo,
                tbl_defeito_reclamado.descricao
            FROM tbl_diagnostico
            INNER JOIN tbl_defeito_reclamado ON tbl_defeito_reclamado.defeito_reclamado = tbl_diagnostico.defeito_reclamado AND tbl_defeito_reclamado.fabrica = {$login_fabrica} AND tbl_defeito_reclamado.ativo IS TRUE
            {$joinLinhaFamilia}
            $joinFamilia
            WHERE tbl_diagnostico.fabrica = {$login_fabrica}
            $whereProduto
            AND tbl_diagnostico.ativo IS TRUE
            ORDER BY tbl_defeito_reclamado.codigo ASC, tbl_defeito_reclamado.descricao ASC";
        $res = pg_query($con, $sql);
        $defeitos_reclamados = array();

        if(pg_num_rows($res) > 0){
            for($i = 0; $i < pg_num_rows($res); $i++){
                $defeito_reclamado = pg_fetch_result($res, $i, "defeito_reclamado");
                $descricao         = pg_fetch_result($res, $i, "descricao");
                $codigo            = pg_fetch_result($res, $i, "codigo");
                $defeitos_reclamados[] = array("defeito_reclamado" => utf8_encode($defeito_reclamado), "descricao" => utf8_encode($descricao));
            }
        }else{
            $defeitos_reclamados[] = array("defeito_reclamado" => "", "descricao" => "");
        }
        exit(json_encode(array("defeitos_reclamados" => $defeitos_reclamados)));
    }
}

if ($_POST['ajax_admin_providencia'] && $_POST['hd_motivo_ligacao']) {
    $resultAdmin      = array();
    $hd_motivo_ligacao = $_POST['hd_motivo_ligacao'];

    if (!empty($hd_motivo_ligacao)) {
	$whereMotivoLigacao = "AND tbl_admin_atendente_estado.hd_motivo_ligacao = {$hd_motivo_ligacao}";
    }

    $sqlAdmin = "
            SELECT DISTINCT tbl_admin.admin, tbl_admin.login, tbl_admin.nome_completo
            FROM tbl_admin
            JOIN tbl_admin_atendente_estado ON tbl_admin_atendente_estado.admin = tbl_admin.admin
                AND tbl_admin_atendente_estado.fabrica = $login_fabrica
            WHERE tbl_admin.fabrica = $login_fabrica
            AND tbl_admin.ativo is true
	    {$whereMotivoLigacao}
            AND tbl_admin_atendente_estado.hd_classificacao = $hd_classificacao
            AND (privilegios like '%call_center%' or privilegios like '*')
            ORDER by tbl_admin.login ";
    $resAdmin = pg_query($con, $sqlAdmin);

    if (pg_num_rows($resAdmin) > 0){
        for ($i=0; $i < pg_num_rows($resAdmin); $i++) {
            $resultAdmin[] = array("admin" => utf8_encode(pg_result($resAdmin,$i,'nome_completo')), "id" => pg_fetch_result($resAdmin, $i, 'admin'));
        }
        exit(json_encode(array("ok" => 'success', "usuarioAdmin" => $resultAdmin)));
    }else{
        exit(json_encode(array("ok" => 'error')));
    }
}

if (isset($_POST['ajax_providencia_nivel3'])) {

    $hd_motivo_ligacao = $_POST['hd_motivo_ligacao'];

    $sqlProv = "SELECT hd_providencia, descricao
                FROM tbl_hd_providencia
                WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}
                AND ativo IS TRUE";
    $resProv = pg_query($con, $sqlProv);

    $sqlVerificaCortesia = "SELECT hd_motivo_ligacao
                            FROM tbl_hd_motivo_ligacao
                            WHERE categoria = 't'
                            AND hd_motivo_ligacao = {$hd_motivo_ligacao}";
    $resVerificaCortesia = pg_query($sqlVerificaCortesia);

    $cortesia = (pg_num_rows($resVerificaCortesia) > 0);

    if (pg_num_rows($resProv) > 0) {

        $dadosProv = pg_fetch_all($resProv);
        $arrayDados = [];
        foreach ($dadosProv as $chave => $valor) {
            $arrayDados[$chave] = ['descricao' => utf8_encode($valor['descricao']), 'hd_providencia' => $valor['hd_providencia']];
        }

        exit(json_encode([
            "retorno"  => $arrayDados,
            "cortesia" => $cortesia
        ]));

    } else {

        exit(json_encode([
            "retorno"  => "nao_encontrado",
            "cortesia" => $cortesia
        ]));

    }

}

if ($login_fabrica == 183){
    $sql_sup = "SELECT admin FROM tbl_admin WHERE fabrica = {$login_fabrica} AND tbl_admin.admin = {$login_admin} AND tbl_admin.callcenter_supervisor IS TRUE ";
    $res_sup = pg_query($con, $sql_sup);

    if(pg_num_rows($res_sup) > 0){
        $admin_supervisor_callcenter = pg_fetch_result($res_sup, 0, 'admin');
    }

    if (strlen($_GET['data_nf']) > 0){
        $xdata_nf = $_GET['data_nf'];
        $xdata_nf = explode('-', $xdata_nf);
        $data_nf = $xdata_nf[2].'/'.$xdata_nf[1].'/'.$xdata_nf[0];
    }

    if (strlen($_GET['consumidor_fone2']) > 0){
        $consumidor_fone2 = substr($_GET['consumidor_fone2'],3);
    }
}

if (isset($_POST['scriptFalhaProd'])) {
    $produto = $_POST['produto'];

    $queryProd = "SELECT tp.produto,
                         tp.referencia,
                         tp.descricao,
                         tf.familia
                  FROM tbl_produto tp
                  JOIN tbl_familia tf ON tf.familia = tp.familia
                  WHERE tp.produto = {$produto}
                  AND tp.fabrica_i = {$login_fabrica}";
    $resProd = pg_query($con, $queryProd);
    $prodQuery = pg_fetch_result($resProd, 0, 'produto');
    $familyQuery = pg_fetch_result($resProd, 0, 'familia');

    $queryScript = "SELECT script_falha,
                           json_script,
                           json_execucao_script,
                           familia
                    FROM tbl_script_falha
                    WHERE fabrica = {$login_fabrica}
                    AND (familia = {$familyQuery} OR (familia = {$familyQuery} AND produto = {$prodQuery}))";
    $resScript = pg_query($con, $queryScript);
    $response = pg_fetch_assoc($resScript);

    $jsonScript = [
        'json_script' => json_decode(utf8_encode($response['json_script']), true),
        'json_execucao_script' => json_decode(utf8_encode($response['json_execucao_script']), true),
        'script_falha' => $response['script_falha'],
        'familia' => $response['familia']
    ];

    echo json_encode($jsonScript);
    exit;
}

if (isset($_POST['searchFrase'])) {
    $respFrase = explode("@", $_POST['resposta'])[1];

    $specialChars =   array_flip(get_html_translation_table(HTML_ENTITIES, ENT_COMPAT | ENT_HTML401, "ISO-8859-1"));
    $respFrase = strtr($respFrase, $specialChars);
    $respFrase = retira_acentos($respFrase);

    $frase = strtolower(preg_replace("/<[a-z]+>|<\/[a-z]+>|<[a-z]+\s\/>/i", "", $respFrase));

    $queryFrase = "SELECT
                        frase
                    FROM tbl_frase_callcenter
                    WHERE fabrica = {$login_fabrica}
                    AND lower(fn_retira_especiais(titulo)) ILIKE '%{$frase}%'";
    $result = pg_query($con, $queryFrase);
    $resultFrase = pg_fetch_result($result, 0, 'frase');
    $resultFrase = preg_replace("/<[a-z]+>|<\/[a-z]+>|<[a-z]+\s\/>/i", "", $resultFrase);

    echo $resultFrase;
    exit;
}

if (isset($_POST['assinaturaML'])) {
    $callTemp = $_POST['callcenter'];

    $queryAss = "SELECT
                    parametros_adicionais
                FROM tbl_fabrica
                WHERE fabrica = {$login_fabrica}";
    $result = pg_query($con, $queryAss);
    $resultAss = pg_fetch_result($result, 0, "parametros_adicionais");
    $resultAss = json_decode($resultAss, true);

    $message = $resultAss['callcenterAssinaturaAtendente'][0];

    $queryDados = "SELECT
                        nome_completo
                    FROM tbl_admin
                    WHERE admin = {$login_admin}
                    AND fabrica = {$login_fabrica}";
    $result = pg_query($con, $queryDados);
    $resultDados = pg_fetch_result($result, 0, "nome_completo");

    if (strlen(pg_last_error()) > 0) {
        $assinatura['error'] = pg_last_error();
    } else {
        $assinatura['message'] = str_replace("@atendente", iconv('ISO-8859-1', 'UTF-8', $resultDados), $message);
        $assinatura['message'] = preg_replace("/<[a-z]+>|<\/[a-z]+>|<[a-z]+\s\/>/i", "", $assinatura['message']);
        $assinatura['message'] = iconv('ISO-8859-1', 'UTF-8', $assinatura['message']);
    }

    echo json_encode($assinatura);
    exit;
}

if (isset($_POST['saudacaoML'])) {
    $callTemp = $_POST['callcenter'];
    $consumidor = $_POST['consumidor'];

    $querySaud = "SELECT
                        parametros_adicionais
                    FROM tbl_fabrica
                    WHERE fabrica = {$login_fabrica}";
    $result = pg_query($con, $querySaud);
    $resultSaud = pg_fetch_result($result, 0, 'parametros_adicionais');
    $resultSaud = json_decode($resultSaud, true);

    if (strlen(pg_last_error()) > 0) {
        $saudacao['error'] = pg_last_error();
    } else {
        $message = $resultSaud['callcenterSaudacaoInicial'][0];
        $saudacao['message'] = str_replace('@consumidor', $consumidor, $message);
        $saudacao['message'] = preg_replace("/<[a-z]+>|<\/[a-z]+>|<[a-z]+\s\/>/i", "", $saudacao['message']);
        $saudacao['message'] = iconv('ISO-8859-1', 'UTF-8', $saudacao['message']);
    }

    echo json_encode($saudacao);
    exit;
}

if(array_key_exists("ajax_discar", $_POST)) {

    $consultar = "SELECT external_id FROM tbl_admin WHERE fabrica = $login_fabrica AND login = '{$login_login}';";

    $res_consultar = pg_query($con, $consultar);

    if (pg_numrows($res_consultar) > 0) {
        $external_id = pg_fetch_result($res_consultar, 0, external_id);

        if (empty($external_id)) {
            echo json_encode(['exception' => 'Usuário não vinculado com telefonia']);
            exit;
        }

        try {
            $curl = curl_init();

            curl_setopt_array($curl, array(
            CURLOPT_URL => "https://api2.telecontrol.com.br/telefonia/discar",
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => "",
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 90,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => "POST",
            CURLOPT_POSTFIELDS => json_encode([
                'numerodiscar' => $_POST['numerodiscar'],
                "externalId" => $external_id,
                'fabricaTelecontrol' => $login_fabrica
            ]),
            CURLOPT_HTTPHEADER => array(
                "Access-Application-Key: 084f77e7ff357414d5fe4a25314886fa312b2cff",
                "Access-Env: PRODUCTION",
                "Cache-Control: no-cache",
                "Content-Type: application/json"
                ),
            ));

            $response = curl_exec($curl);
            $err = curl_error($curl);

            $objdiscar = json_decode($response,1);

            if (array_key_exists("exception", $objdiscar)) {
                echo json_encode(['exception' => 'Ocorreu um erro ao efetuar a ligação']);
                curl_close($curl);
                exit;
            } else {

                //$unique_id = $objdiscar->{'unique_id'};
                $unique_id = $objdiscar['unique_id'];

                $chamado_item = "INSERT INTO tbl_hd_chamado_item (hd_chamado, comentario, admin, interno, status_item, atendimento_telefone)
                             VALUES ({$_POST['hdchamado']}, 'DIRECT', $login_admin, true, 'Aberto', true) RETURNING hd_chamado_item;";

                $res_chamado = pg_query($con, $chamado_item);
                $linha = pg_fetch_result($res_chamado, 0, 'hd_chamado_item');

                $consulta = "INSERT INTO tbl_hd_chamado_item_externo (fabrica, hd_chamado_item, hd_chamado, id_ligacao)
                         VALUES ({$login_fabrica}, {$linha}, '{$_POST['hdchamado']}', '{$unique_id}');";

                $res_consulta = pg_query($con, $consulta);

                curl_close($curl);
                echo json_encode(['message' => 'success']);
            }
        } catch (Exception $e) {
            echo $e->getMessage();
        }
    }
    exit;
}

$dateRegEx = '^(([0-2]\d|3[01])\W(0[1-9]|1[0-2])\W((19|20|21)\d{2}))\s(([0-1]\d|2[0-3]):[0-5]\d:[0-5]\d)$';

// Parametrização por fábrica
$fab_nova_filial   = in_array($login_fabrica, array(156)); // 2016-03-10 filiais em tbl_filial
// HD 2398072 10/06/2015 - Lenoxx - aumentar o nº de anexos por atendimento
//$max_anexos = ($login_fabrica == 11) ? 10 : 3;
switch ($login_fabrica) {
    case 88:
        $max_anexos = 5;
        break;
    case 11:
    case 171:
    case 172:
        $max_anexos = 10;
        break;
    case 176:
        $max_anexos = 10;
        break;
    case 30:
        $max_anexos = 6;
        break;
    default:
        $max_anexos = 3;
        break;
}
$fab_filtra_prod_familia = in_array($login_fabrica, array(156));

/* Fabricas que enviam SMS no Call-Center */

$sql_fabrica_sms = "SELECT fabrica FROM tbl_fabrica WHERE api_secret_key_sms NOTNULL AND fabrica NOT IN (11,101,172)";
$res_fabrica_sms = pg_query($con, $sql_fabrica_sms);

$fabricas_sms = array();

for ($i = 0; $i < pg_num_rows($res_fabrica_sms); $i++) {
    $fabricas_sms[] = pg_fetch_result($res_fabrica_sms, $i, "fabrica");
}

if (in_array($login_fabrica, array(169, 170))) {

    if ($_POST['ajax'] == "sim" AND $_POST["acao"] == "pesquisa_agenda_bloqueio"){#monteiro ->agendamento bloqueio
        $id_posto_tab   = $_POST["id_posto_tab"];
        $mapa_linha     = $_POST["mapa_linha"];
        $dados_bloqueio = array();

        $sql = "SELECT
                ab.data_inicio,
                ab.data_final,
                descricao,
                ab.linha
            FROM tbl_tecnico_agenda_bloqueio ab
            LEFT JOIN tbl_posto_fabrica pf ON pf.posto = {$id_posto_tab} AND pf.fabrica = {$login_fabrica}
            LEFT JOIN tbl_posto p ON p.posto = pf.posto
            WHERE ab.fabrica = {$login_fabrica}
            AND (ab.linha->>'linhas' ilike '%{$mapa_linha}%' OR ab.linha IS NULL OR ab.linha = '{}')
            AND (
                    ab.data_inicio::date BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '2 MONTHS'
                OR  ab.data_final::date BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '2 MONTHS'
            )
            AND (
                ab.posto = p.posto
                OR ab.estado = p.estado
                OR ab.cidade = (
                    SELECT cidade
                    FROM tbl_cidade
                    WHERE UPPER(fn_retira_especiais(nome)) = UPPER(fn_retira_especiais(p.cidade))
                    AND UPPER(estado) = UPPER(p.estado)
                )
                OR (ab.posto IS NULL AND ab.estado IS NULL AND ab.cidade IS NULL)
            )";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0){
            for ($i=0; $i < pg_num_rows($res); $i++) {
                $dados_bloqueio[] = array(
                    "data_inicio" => pg_fetch_result($res,$i,'data_inicio'),
                    "data_final"  => pg_fetch_result($res,$i,'data_final'),
                    "descricao"   => pg_fetch_result($res,$i,'descricao'),
                    "linha"       => pg_fetch_result($res,$i,'linha')
                );
            }
            echo json_encode($dados_bloqueio);
        }else{
            echo json_encode(array("messageError" => "Nenhum bloqueio encontrado"));
        }
        exit;
    }

    $mes = date("m");

    if ($mes == 12) {
        $data_inicio = date("Y-{$mes}-1");
        $mes = 1;
        $ano = date("Y");
        $ano++;
        $data_fim = date("Y-m-t", strtotime(date("{$ano}-{$mes}-1")));
    } else {
        $data_inicio = date("Y-{$mes}-1");
        $mes++;
        $data_fim = date("Y-m-t", strtotime(date("Y-{$mes}-1")));
    }

    $sqlFeriado = "
        SELECT data
        FROM tbl_feriado
        WHERE fabrica = {$login_fabrica}
        AND (data BETWEEN '{$data_inicio}' AND '{$data_fim}')
    ";
    $resFeriado = pg_query($con, $sqlFeriado);
    $feriados = array_map(function($f) {
        return date("d/m/Y", strtotime($f["data"]));
    }, pg_fetch_all($resFeriado));
    $feriados = json_encode($feriados);
}

/* Fabricas que enviam SMS no Call-Center */

if(isset($_POST["buscaSolucao"])){
    $marca_produto = $_POST['marca_produto'];

    $sql = " SELECT
                tbl_diagnostico.diagnostico,
                tbl_solucao.solucao,
                tbl_solucao.descricao as descricao_solucao
                FROM tbl_diagnostico
                INNER JOIN tbl_solucao using(solucao)
                WHERE tbl_diagnostico.fabrica = $login_fabrica
                AND solucao is not null
                AND marca = $marca_produto
                AND tbl_diagnostico.ativo is true  ";
    $res = pg_query($con, $sql);
     echo "<option value=''>Solução</option>";
    for($i=0; $i<pg_num_rows($res); $i++){
        $diagnostico        = pg_fetch_result($res, $i, diagnostico);
        $solucao            = pg_fetch_result($res, $i, solucao);
        $descricao_solucao  = pg_fetch_result($res, $i, descricao_solucao);

        echo "<option value='$solucao'>$descricao_solucao </option>";
    }

exit;
}

if(isset($_POST["montaSolucao"])){
    $ref = $_POST['ref'];
    if (!empty($ref)) {
        $sql_marca_produto = "SELECT marca
                                FROM tbl_produto
                                WHERE referencia = '$ref'
                                AND fabrica_i = $login_fabrica";
        $res_marca_produto = pg_query($con, $sql_marca_produto);
        if (pg_num_rows($res_marca_produto) > 0) {
            $marca_produto = pg_fetch_result($res_marca_produto, 0, 'marca');

            $sql = " SELECT
                        tbl_diagnostico.diagnostico,
                        tbl_solucao.solucao,
                        tbl_solucao.descricao as descricao_solucao
                        FROM tbl_diagnostico
                        INNER JOIN tbl_solucao using(solucao)
                        WHERE tbl_diagnostico.fabrica = $login_fabrica
                        AND solucao is not null
                        AND marca = $marca_produto
                        AND tbl_diagnostico.ativo is true  ";
            $res = pg_query($con, $sql);
            echo "<option value=''>Solução</option>";
            for($i=0; $i<pg_num_rows($res); $i++){
                $diagnostico        = pg_fetch_result($res, $i, diagnostico);
                $solucao            = pg_fetch_result($res, $i, solucao);
                $descricao_solucao  = pg_fetch_result($res, $i, descricao_solucao);

                echo "<option value='$solucao'>$descricao_solucao </option>";
            }
        }
    }
exit;
}

if ($_POST["ajax_interage_upload_arquivo"] == true) {
    $nome_arquivo = $_POST['nome_arquivo'];
    $callcenter = $_POST['callcenter'];

    $status_hd_item = "Aberto";
    if (in_array($login_fabrica, array(151))) {
        $query_select_status = "SELECT status
                                FROM tbl_hd_chamado
                                WHERE hd_chamado = {$callcenter}
                                AND fabrica_responsavel = {$login_fabrica};";
        $result_status = pg_query($con, $query_select_status);
        if (strlen(pg_last_error()) == 0) {
            $status_hd_item = pg_fetch_result($result_status, 0, 'status');
        }
    }

    if (!empty($nome_arquivo)) {
        $sql = "INSERT INTO tbl_hd_chamado_item(
                            hd_chamado   ,
                            data         ,
                            comentario   ,
                            admin        ,
                            interno      ,
                            status_item
                        ) values (
                            $callcenter       ,
                            current_timestamp ,
                            'Arquivo anexado: $nome_arquivo pelo(a) usuário(a) <b>$login_login</b> ',
                            $login_admin      ,
                            't'               ,
                            '{$status_hd_item}'
                        )";

                        $res = pg_query($con,$sql);
                        $msg_erro .= pg_errormessage($con);

                        if (strlen($msg_erro) == 0) {
                            $return = array("erro" => false);
                        }else{
                            $return = array("erro" => true);
                        }
    }
    exit(json_encode($return));
}

if ($_POST["ajax_interage_upload_arquivo_excluir"] == true) {
    $tdocsId = $_POST['tdocsId'];
    $callcenter = $_POST['callcenter'];

    $status_hd_item = "Aberto";
    if (in_array($login_fabrica, array(151))) {
        $query_select_status = "SELECT status
                                FROM tbl_hd_chamado
                                WHERE hd_chamado = {$callcenter}
                                AND fabrica_responsavel = {$login_fabrica};";
        $result_status = pg_query($con, $query_select_status);
        if (strlen(pg_last_error()) == 0) {
            $status_hd_item = pg_fetch_result($result_status, 0, 'status');
        }
    }

    if (!empty($tdocsId)) {
        $sql_tdocs = " SELECT json_field('filename',obs) as nome_arquivo
                       FROM tbl_tdocs
                       WHERE fabrica = $login_fabrica
                       AND tdocs_id = '$tdocsId' ";

        $res_tdocs = pg_query($con,$sql_tdocs);

        if (pg_num_rows($res_tdocs) > 0){
            $nome_arquivo = pg_fetch_result($res_tdocs, 0, 'nome_arquivo');
            if (!empty($nome_arquivo)){
                $sql = "INSERT INTO tbl_hd_chamado_item(
                            hd_chamado   ,
                            data         ,
                            comentario   ,
                            admin        ,
                            interno      ,
                            status_item
                        ) values (
                            $callcenter       ,
                            current_timestamp ,
                            'Anexo: $nome_arquivo excluÃ­do pelo(a) usuário(a) <b>$login_login</b> ',
                            $login_admin      ,
                            't'               ,
                            '{$status_hd_item}'
                        )";

                        $res = pg_query($con,$sql);
                        $msg_erro .= pg_errormessage($con);

                        if (strlen($msg_erro) == 0) {
                            $return = array("erro" => false);
                        }else{
                            $return = array("erro" => true);
                        }
            }else{
                $return = array("erro" => true);
            }

        }else{
            $return = array("erro" => true);
        }
    }else{
        $return = array("erro" => true);
    }
    exit(json_encode($return));
}

function retorna_dados_analise_obrigatoria($produtoId, $linhaProduto, $cidadeConsumidor, $estadoConsumidor) {
    global $con, $login_fabrica;

    $retorno = [];
    if (!empty($produtoId) && !empty($linhaProduto) && !empty($cidadeConsumidor)) {

        $sqlProdutoAnalise = "SELECT parametros_adicionais
                              FROM tbl_produto
                              WHERE produto = {$produtoId}";
        $resProdutoAnalise = pg_query($con, $sqlProdutoAnalise);

        $arrAdicionais = json_decode(pg_fetch_result($resProdutoAnalise, 0, 'parametros_adicionais'), true);

        $sql = "SELECT DISTINCT tbl_posto_fabrica.posto
                FROM tbl_posto
                JOIN tbl_posto_fabrica ON tbl_posto_fabrica.posto = tbl_posto.posto AND tbl_posto_fabrica.fabrica = {$login_fabrica}
                WHERE tbl_posto_fabrica.divulgar_consumidor IS TRUE
                AND tbl_posto.posto <> 6359
                AND tbl_posto_fabrica.credenciamento = 'CREDENCIADO'
                AND tbl_posto.posto IN (SELECT DISTINCT posto FROM tbl_posto_fabrica JOIN tbl_posto_linha USING(posto) WHERE linha IN ({$linhaProduto}) AND fabrica = {$login_fabrica})
                AND UPPER(tbl_posto_fabrica.contato_cidade) = UPPER('{$cidadeConsumidor}')
                AND UPPER(tbl_posto_fabrica.contato_estado) = UPPER('{$estadoConsumidor}')
                ";
        $res = pg_query($con, $sql);

        $retorno = [
            "tem_posto" => false,
        ];
        if (pg_num_rows($res) > 0) {
            $retorno = [
                "tem_posto" => true
            ];
        }

        $retorno["analise_obrigatoria"] = (boolean) $arrAdicionais["analise_obrigatoria"];

    }

    return $retorno;
}

function calcula_horas_uteis($ini_exp, $fim_exp, $data_prov, $prazo) {
    global $con, $login_fabrica;

    if (strtotime($data_prov) > strtotime($fim_exp)) {

        $sqlCal         = pg_query($con, "SELECT extract(epoch FROM (SELECT '$data_prov'::timestamp - '{$fim_exp}'::timestamp))/3600 AS prazoNaoUsado");
        $prazoNaoUsado  = round(pg_fetch_result($sqlCal, 0, 'prazoNaoUsado'));

        $dias = 1; 
        $prazoN = $prazoNaoUsado;

        if ($prazoNaoUsado > 8) {
            while($prazoN > 8) {
                $prazoN = $prazoN - 8;
                $dias++;
            }
        }

        // Pega o próximo dia Ãºtil 
        $sqlDt = "SELECT fn_calcula_previsao_retorno(current_date,$dias,$login_fabrica)::date AS data";
        $resDt = pg_query($con, $sqlDt);
        $dataUtil = pg_fetch_result($resDt, 0, 'data');

        /*$ini_exp   = date('Y-m-d H:i:s', strtotime(date("$ini_exp")." +1 day"));
        $fim_exp   = date('Y-m-d H:i:s', strtotime(date("$fim_exp")." +1 day"));*/

        $hIni = date('H:i:s', strtotime(date("$ini_exp")));
        $hFin = date('H:i:s', strtotime(date("$fim_exp")));

        $ini_exp = $dataUtil.' '.$hIni;
        $fim_exp = $dataUtil.' '.$hFin;

        $sqlCal   = pg_query($con, "SELECT '$ini_exp'::timestamp + INTERVAL '{$prazoN} hours' AS data_px");
        $data_px  = pg_fetch_result($sqlCal, 0, 'data_px');

        #return calcula_horas_uteis($ini_exp, $fim_exp, $data_px, $prazoNaoUsado);
        return $data_px;

    } else {
        return $data_prov;
    }
}

function valida_distancia(
    $endereco = null,
    $numero = null,
    $bairro = null,
    $cep = null,
    $cidade = null,
    $estado = null,
    $pais = "Brasil",
    $posto = null
) {
    global $login_fabrica, $con;

    $sqlTipoPosto = "
        SELECT tp.tipo_revenda
        FROM tbl_posto_fabrica pf
        INNER JOIN tbl_tipo_posto tp ON tp.tipo_posto = pf.tipo_posto AND tp.fabrica = $login_fabrica
        WHERE pf.fabrica = $login_fabrica
        AND pf.posto = $posto
    ";
    $resTipoPosto = pg_query($con, $sqlTipoPosto);

    if (!pg_num_rows($resTipoPosto)) {
        throw new Exception("Erro ao validar distÃ¢ncia");
    }

    $tipo_revenda = pg_fetch_result($resTipoPosto, 0, 'tipo_revenda');

    if ($tipo_revenda == "t") {
        return 0;
    }

    $oTcMaps = new TcMaps($login_fabrica, $con);

    $response = $oTcMaps->geocode($endereco, $numero, $bairro, $cidade, $estado, $pais, $cep);
    $lat = $response['latitude'];
    $lng = $response['longitude'];

    if (!empty($lat) AND !empty($lng)){
        $sql = "
            SELECT DISTINCT
                tbl_posto.posto,
                tbl_posto_fabrica.latitude AS lat,
                tbl_posto_fabrica.longitude AS lng,
                (111.045 * DEGREES(ACOS(COS(RADIANS({$lat})) * COS(RADIANS(tbl_posto_fabrica.latitude)) * COS(RADIANS(tbl_posto_fabrica.longitude) - RADIANS({$lng})) + SIN(RADIANS({$lat})) * SIN(RADIANS(tbl_posto_fabrica.latitude))))) AS distancia
            FROM tbl_posto
            JOIN tbl_posto_fabrica ON tbl_posto_fabrica.posto = tbl_posto.posto AND tbl_posto_fabrica.fabrica = $login_fabrica
            WHERE tbl_posto.posto = {$posto} ";
        $res = pg_query($con, $sql);

        $distancia = pg_fetch_result($res, 0, 'distancia');
        return $distancia;
    }else{
        throw new Exception("Latitude e longitude não encontrada, tente novamente!");
    }
}

if ($_POST['valida_distancia'] == "sim"){
    try {
        $endereco = $_POST['endereco'];
        $numero   = $_POST['numero'];
        $bairro   = $_POST['bairro'];
        $cep      = $_POST['cep'];
        $cidade   = $_POST['local_cidade'];
        $estado   = $_POST['local_estado'];
        $pais     = 'Brasil';
        $posto    = $_POST['posto'];

        $distancia = valida_distancia(
            $endereco,
            $numero,
            $bairro,
            $cep,
            $cidade,
            $estado,
            $pais,
            $posto
        );

        exit(json_encode(array(
            "ok" => $distancia
        )));
    } catch(Exception $e) {
        exit(json_encode(array(
            "error" => utf8_encode($e->getMessage())
        )));
    }
}

if (in_array($login_fabrica, array(169,170))){
    $sqlValidaJornada = "
            SELECT
                tbl_hd_jornada.produto,
                tbl_cidade.nome AS cidade,
                tbl_hd_jornada.estado
            FROM tbl_hd_jornada
            LEFT JOIN tbl_cidade ON tbl_cidade.cidade = tbl_hd_jornada.cidade
            WHERE fabrica = {$login_fabrica} ";
    $resValidaJornada = pg_query($con, $sqlValidaJornada);
    if (pg_num_rows($resValidaJornada) > 0){
        $results = pg_fetch_all($resValidaJornada);
        $result_jornada = json_encode($results);
    }
}

if ($_POST['verifica_script'] == 'true') {
    $defeito_reclamado  = $_POST['defeito_reclamado'];
    $produto            = $_POST['produto'];

    if(strlen(trim($produto)) > 0){
        $sql = "SELECT tbl_familia.familia
                FROM tbl_produto
                JOIN tbl_familia ON tbl_familia.familia = tbl_produto.familia AND tbl_familia.fabrica = {$login_fabrica}
                WHERE fabrica = {$login_fabrica}
                AND produto = {$produto}";
        $res = pg_query($con, $sql);
        if(pg_num_rows($res) > 0){
            $familia = pg_fetch_result($res, 0, 'familia');
        }else{
            $msg_erro = "familia não encontrada";
        }
    }

    if(strlen(trim($msg_erro)) == 0){
        if(strlen(trim($defeito_reclamado)) > 0 AND strlen(trim($familia)) > 0){
            $sql = "SELECT  tbl_script_falha.script_falha,
                            tbl_script_falha.json_script,
                            tbl_script_falha.json_execucao_script
                    FROM tbl_script_falha
                    WHERE tbl_script_falha.fabrica = {$login_fabrica}
                    AND tbl_script_falha.familia = {$familia}
                    AND tbl_script_falha.defeito_reclamado = {$defeito_reclamado}";
            $res = pg_query($con, $sql);

            $json_script = pg_fetch_result($res, 0, 'json_script');
            $json_execucao_script = pg_fetch_result($res, 0, 'json_execucao_script');

            $json_script = str_replace("<br/>", '\n', $json_script);
            $json_execucao_script = str_replace("<br/>", '\n', $json_execucao_script);

            if(pg_num_rows($res) > 0){
                $result = array("resultado" => "ok", "script_falha" => utf8_encode(pg_fetch_result($res, $i, script_falha)), "json_script" => utf8_encode($json_script), "json_execucao_script" => utf8_encode($json_execucao_script), "familia" => utf8_encode($familia));
                exit(json_encode($result));
            }else{
                exit(json_encode(array("resultado" => 'no')));
            }
        }else{
            exit(json_encode(array("resultado" => 'no')));
        }
    }else{
        exit(json_encode(array("resultado" => 'no')));
    }
    exit;
}

if ($_POST['ajax'] && $_POST['classificacao']) {
    if($login_fabrica >= 169){
        if(in_array($login_fabrica, array(169,170))){
                $result = array();
                $resultAdmin = array();
                $xclassificacao = $_POST["classificacao"];
		$xnatureza      = $_POST["natureza"];
		$providencia    = $_POST["providencia"];
                $ajax_providencia = "false";

                if(strlen(trim($xnatureza)) > 0){
                    $sql_natureza = "SELECT natureza FROM tbl_natureza WHERE fabrica = {$login_fabrica}
                                        AND ativo IS TRUE AND nome = '{$xnatureza}'";
                    $res_natureza = pg_query($con, $sql_natureza);

                    if(pg_num_rows($res_natureza) > 0){
                        $ajax_providencia = 'true';
                        $id_natureza = pg_fetch_result($res_natureza, 0, 'natureza');

                        $cond_natureza = " AND tbl_hd_motivo_ligacao.natureza = {$id_natureza} ";
                    }
		}

		if(!empty($providencia)){
			$condProv =" AND tbl_admin_atendente_estado.hd_motivo_ligacao = {$providencia} ";
		}

                $sqlAdmin = "
                        SELECT tbl_admin.admin, tbl_admin.login, tbl_admin.nome_completo
                        FROM tbl_admin
                        JOIN tbl_admin_atendente_estado ON tbl_admin_atendente_estado.admin = tbl_admin.admin
                            AND tbl_admin_atendente_estado.fabrica = $login_fabrica
                        WHERE tbl_admin.fabrica = $login_fabrica
                        AND tbl_admin.ativo is true
                        AND tbl_admin_atendente_estado.hd_classificacao = $xclassificacao
			AND (privilegios like '%call_center%' or privilegios like '*')
			$condProv
                        ORDER by tbl_admin.login ";
                $resAdmin = pg_query($con, $sqlAdmin);

                if (pg_num_rows($resAdmin) > 0){
                    for ($i=0; $i < pg_num_rows($resAdmin); $i++) {
                        $resultAdmin[] = array("admin" => utf8_encode(pg_result($resAdmin,$i,'nome_completo')), "id" => pg_fetch_result($resAdmin, $i, 'admin'));
                    }
                }

                $sql = "SELECT  tbl_hd_motivo_ligacao.natureza,
                                tbl_hd_motivo_ligacao.hd_motivo_ligacao,
                                tbl_hd_motivo_ligacao.descricao,
                                tbl_natureza.nome,
                                tbl_hd_motivo_ligacao.categoria,
                                tbl_hd_motivo_ligacao.prazo_dias,
                                tbl_hd_motivo_ligacao.abre_os
                        FROM tbl_hd_motivo_ligacao
                        JOIN tbl_natureza ON tbl_natureza.natureza = tbl_hd_motivo_ligacao.natureza
                            AND tbl_natureza.fabrica = {$login_fabrica}
                        WHERE tbl_hd_motivo_ligacao.fabrica = {$login_fabrica}
                        AND tbl_hd_motivo_ligacao.hd_classificacao = {$xclassificacao}
                        AND tbl_hd_motivo_ligacao.ativo IS TRUE
                        $cond_natureza
                        ORDER BY tbl_hd_motivo_ligacao.descricao ASC";
                $res = pg_query($con, $sql);
                if(pg_num_rows($res) > 0){

                    if($ajax_providencia == "false"){
                        for ($i=0; $i < pg_num_rows($res); $i++) {
                            $result[] = array("tabs" => utf8_encode(pg_result($res,$i,'nome')));
                        }
                    }else{
                        for ($i=0; $i < pg_num_rows($res); $i++) {
                            $result[] = array("os_cortesia" => utf8_encode(pg_fetch_result($res, $i, categoria)),"abre_os" => utf8_encode(pg_fetch_result($res, $i, abre_os)), "prazo_dias" => utf8_encode(pg_fetch_result($res, $i, prazo_dias)), "motivo_ligacao" => utf8_encode(pg_result($res,$i,hd_motivo_ligacao)), "descricao" => utf8_encode(pg_result($res,$i,descricao)));
                        }
                    }
                    exit(json_encode(array("ok" => $result, "usuarioAdmin" => $resultAdmin)));
                    #exit(json_encode(array("ok" => $result)));
                }else{
                    exit(json_encode(array("no" => 'false')));
                }
        }else{
            $result = array();
            $sql = "SELECT hd_motivo_ligacao, descricao FROM tbl_hd_motivo_ligacao WHERE fabrica = {$login_fabrica} AND ativo IS TRUE AND hd_classificacao = ".$_POST['classificacao'].";";
            $res = pg_query($con,$sql);
            if (pg_num_rows($res) > 0) {
                for ($i=0; $i < pg_num_rows($res); $i++) {
                    $result[] = array("motivo_ligacao" => utf8_encode(pg_result($res,$i,hd_motivo_ligacao)), "descricao" => utf8_encode(pg_result($res,$i,descricao)));
                }
                exit(json_encode(array("ok" => $result)));
            }
            exit(json_encode(array("no" => 'false')));
        }
    }else{
        if ($_POST['ajax'] && $_POST['classificacao']) {
            $sql = "SELECT hd_motivo_ligacao FROM tbl_hd_motivo_ligacao WHERE fabrica = {$login_fabrica} AND hd_classificacao = ".$_POST['classificacao'].";";

            $res = pg_query($con,$sql);
            if (pg_num_rows($res) > 0) {
                exit(json_encode(array("ok" => pg_fetch_result($res,0,'hd_motivo_ligacao'))));
            }
            exit(json_encode(array("no" => 'false')));
        }
    }

}

if ($_POST['ajax'] && $_POST['posto']) {
    $sql = "SELECT posto, digita_os, json_field('digita_os_consumidor',parametros_adicionais) as digita_os_consumidor
            FROM tbl_posto_fabrica
            WHERE codigo_posto = '{$_POST['posto']}' AND fabrica = {$login_fabrica}";

    $res = pg_query($con,$sql);
    if (pg_num_rows($res) > 0) {
        $digita_os = pg_fetch_result($res, 0, 'digita_os');
        $digita_os_consumidor = pg_fetch_result($res,0, 'digita_os_consumidor');
        if($digita_os =='t' or $digita_os_consumidor == 't')
            exit(json_encode(array("ok" => 'true')));
    }
    exit(json_encode(array("no" => 'false')));
}

if ($_POST['ajax_valida_os']) {
    $return = array();
    $os = $_POST['os'];
    $sql = "SELECT os
            FROM tbl_os
            WHERE tbl_os.fabrica = {$login_fabrica}
            AND (tbl_os.os = {$os} OR tbl_os.sua_os='{$os}')";
    $res = pg_query($con,$sql);

    if (pg_num_rows($res) == 0) {
        $return = array("error" => true, "mensagem" => "ERRO: OS invalida");
    } else {
        $return = array("success" => true, "mensagem" => "OK: OS valida");

    }

    exit(json_encode($return));
}

if (isset($_POST['ajax_remove_os']) && $_POST['ajax_remove_os']) {
    pg_query($con, 'BEGIN');

    $os         = $_POST['os'];
    $hd_chamado = $_POST['callcenter'];

    $sql = "SELECT status FROM tbl_hd_chamado WHERE hd_chamado = {$hd_chamado}";
    $res = pg_query($con,$sql);
    $status_item = pg_fetch_result($res, 0, 'status');

    if ($login_fabrica == 35) {
        $sql = "
            UPDATE  tbl_hd_chamado_extra
            SET     os          = NULL
            WHERE   hd_chamado  = $hd_chamado
            AND     os = $os
        ";
    } else {
        $sql = "DELETE FROM tbl_hd_chamado_item WHERE hd_chamado = $hd_chamado AND os = $os;";
    }

    pg_query($con, $sql);

    if (strlen(pg_last_error()) > 0) {
        pg_query($con, 'ROLLBACK');
        exit(json_encode(array("error" => utf8_encode("Ocorreu um erro ao tentar deletar a ordem de serviço selecionada"))));
    }
    $sql = "INSERT INTO tbl_hd_chamado_item(
                hd_chamado,
                admin,
                interno,
                status_item,
                comentario
            )values(
                $hd_chamado,
                $login_admin,
                true,
                '$status_item',
                'A Ordem de Serviço $os foi desvinculada do atendimento'
            )";
    pg_query($con, $sql);
    if (strlen(pg_last_error()) > 0) {
        pg_query($con, 'ROLLBACK');
        exit(json_encode(array("error" => utf8_encode("Ocorreu um erro ao tentar deletar a ordem de serviço selecionada"))));
    }
    pg_query($con, 'COMMIT');
    exit(json_encode(array("ok" => utf8_encode("ok"))));
}

if (in_array($login_fabrica, array(24))) {
    // fn_valida_consumidor
    if($_POST['valida_consumidor_cpf'] == "ok" AND $_POST['ajax'] == true){
        $cpf_consumidor = str_replace(array(".","-"), "", $_POST['cpf_consumidor']);
        $nome_consumidor = $_POST['nome_consumidor'];

        $sql_cpf = "SELECT  tbl_hd_chamado.hd_chamado,
                            tbl_hd_chamado_extra.nome AS consumidor_nome,
                            tbl_hd_chamado_extra.cpf
                        FROM tbl_hd_chamado
                            JOIN tbl_hd_chamado_extra USING(hd_chamado)
                        WHERE tbl_hd_chamado.fabrica = {$login_fabrica}
                            AND tbl_hd_chamado_extra.cpf = '{$cpf_consumidor}'
                            AND tbl_hd_chamado_extra.nome <> '{$nome_consumidor}'
                            AND tbl_hd_chamado.data::date BETWEEN (CURRENT_DATE - INTERVAL '1 year') AND CURRENT_DATE ;";
        $res_cpf = pg_query($con,$sql_cpf);

        if (pg_last_error() > 0) {
            $msg_error = "errosql|Problema na validação do CPF!";
        } else {
            if (pg_num_rows($res_cpf) == 0) {
                $msg_error = "ok|Validação ok!";
            } else {
                $nome_consumidor_ant = array();
                for ($i=0; $i < pg_num_rows($res_cpf); $i++) {
                    $nome_consumidor_ant[] = pg_fetch_result($res_cpf, $i, consumidor_nome) ;
                }
                $msg_error = "erro|CPF existente para Consumidor: ".implode(" / ", $nome_consumidor_ant)."\n\nDeseja continuar?";
            }
        }

        if(strlen($msg_error) > 0){
            echo $msg_error;
        }
        exit;
    }
}

function abreOSPostoInterno($hd_chamado,$hd_chamado_item = null, $produto_sem_retorno = false)
{
    global $con, $login_fabrica, $login_admin;

    $sql = "SELECT posto_fabrica FROM tbl_fabrica WHERE fabrica = {$login_fabrica}";
    $res = pg_query($con,$sql);
    $erro = pg_last_error();
    $condEx   = "";
    $joinEX   = "";

    if (pg_num_rows($res) > 0) {

        $posto = pg_fetch_result($res,0,'posto_fabrica');
        if (in_array($login_fabrica, array(151)) AND strlen($hd_chamado_item) > 0) {
            $camposEx = "
            tbl_hd_chamado_item.produto,
            tbl_hd_chamado_item.serie,
            tbl_hd_chamado_item.defeito_reclamado,
            tbl_hd_chamado_item.defeito_reclamado_descricao,
            tbl_hd_chamado_item.nota_fiscal,
            tbl_hd_chamado_item.data_nf,
            ";
            $joinEX   = " LEFT JOIN tbl_hd_chamado_item ON tbl_hd_chamado.hd_chamado=tbl_hd_chamado_item.hd_chamado";
            $condEx   = " AND tbl_hd_chamado_item.produto is not null AND tbl_hd_chamado_item.hd_chamado_item={$hd_chamado_item}";
        } else {
            $camposEx = "
            tbl_hd_chamado_extra.produto,
            tbl_hd_chamado_extra.serie,
            tbl_hd_chamado_extra.defeito_reclamado,
            tbl_hd_chamado_extra.defeito_reclamado_descricao,
            tbl_hd_chamado_extra.nota_fiscal,
            tbl_hd_chamado_extra.data_nf,
            ";
        }

        if(in_array($login_fabrica, array(169,170))){ //HD-3590498
            $sql_at = "SELECT tipo_atendimento FROM tbl_tipo_atendimento
                    WHERE fabrica = {$login_fabrica} AND fora_garantia IS NOT TRUE
                    AND km_google IS NOT TRUE AND grupo_atendimento = 'P'";
            $res_at = pg_query($con, $sql_at);
            if(pg_num_rows($res_at) > 0){
                $id_atendimento = pg_fetch_result($res_at, 0, 'tipo_atendimento');
            }else{
                $msg_erro .= "Erro ao encontrar tipo de atendimento";
            }

            $campo_insert_tipo_atendimento = "tipo_atendimento";
            $value_insert_tipo_atendimento = $id_atendimento;
        }else{
            $campo_insert_defeito_constatado = "defeito_constatado,";
            $campo_insert_tipo_atendimento = "tipo_atendimento";

            $value_insert_defeito_constatado = "25817,";
            $value_insert_tipo_atendimento = "207";

            if ($login_fabrica == 151 && $produto_sem_retorno == true) {
                $value_insert_tipo_atendimento = "336";//id de produtcao
                //$value_insert_tipo_atendimento = "363";
            }
        }

        if (in_array($login_fabrica, array(151)) AND $produto_sem_retorno) {
            $posto = "tbl_hd_chamado_extra.posto";
        }

        $sql = "
            INSERT INTO tbl_os
                (fabrica,
                posto,
                data_abertura,
                consumidor_nome,
                consumidor_cidade,
                consumidor_estado,
                consumidor_fone,
                consumidor_cpf,
                consumidor_endereco,
                consumidor_numero,
                consumidor_cep,
                consumidor_complemento,
                consumidor_bairro,
                consumidor_email,
                consumidor_celular,
                consumidor_fone_comercial,
                consumidor_revenda,
                revenda,
                revenda_nome,
                revenda_cnpj,
                revenda_fone,
                produto,
                serie,
                defeito_reclamado,
                defeito_reclamado_descricao,
                nota_fiscal,
                data_nf,
                admin,
                hd_chamado,
                obs,
                validada,
                $campo_insert_defeito_constatado
                $campo_insert_tipo_atendimento
                ) SELECT
                    $login_fabrica,
                    $posto,
                    CURRENT_DATE,
                    tbl_hd_chamado_extra.nome,
                    tbl_cidade.nome,
                    tbl_cidade.estado,
                    tbl_hd_chamado_extra.fone,
                    tbl_hd_chamado_extra.cpf,
                    tbl_hd_chamado_extra.endereco,
                    tbl_hd_chamado_extra.numero,
                    tbl_hd_chamado_extra.cep,
                    tbl_hd_chamado_extra.complemento,
                    tbl_hd_chamado_extra.bairro,
                    tbl_hd_chamado_extra.email,
                    tbl_hd_chamado_extra.celular,
                    tbl_hd_chamado_extra.fone2,
                    tbl_hd_chamado_extra.consumidor_revenda,
                    tbl_hd_chamado_extra.revenda,
                    tbl_hd_chamado_extra.revenda_nome,
                    tbl_hd_chamado_extra.revenda_cnpj,
                    tbl_revenda.fone,
                    {$camposEx}
                    $login_admin,
                    $hd_chamado,
                    'Ordem de Serviço aberta pelo CallCenter, atendimento $hd_chamado',
                    CURRENT_TIMESTAMP,
                    $value_insert_defeito_constatado
                    $value_insert_tipo_atendimento
                FROM tbl_hd_chamado
                JOIN tbl_hd_chamado_extra ON tbl_hd_chamado.hd_chamado=tbl_hd_chamado_extra.hd_chamado
                {$joinEX}
                LEFT JOIN tbl_revenda ON tbl_hd_chamado_extra.revenda=tbl_revenda.revenda
                LEFT JOIN tbl_cidade ON tbl_hd_chamado_extra.cidade=tbl_cidade.cidade
                WHERE tbl_hd_chamado.hd_chamado = {$hd_chamado}
                {$condEx}
            RETURNING os;
        ";

        $res = pg_query($con, $sql);
        $erro .= pg_last_error();
        $os = pg_fetch_result($res, 0, 0);

        $sql  = "SELECT hd_chamado FROM tbl_hd_chamado_troca WHERE hd_chamado = $hd_chamado ";
        $resx = pg_query($con, $sql);
        $erro .= pg_last_error();

        if (pg_num_rows($resx) == 0) {
                $sql = "INSERT INTO tbl_hd_chamado_troca ( hd_chamado ) values ( $hd_chamado )";
                $res = pg_query($con, $sql);
                $erro = pg_last_error();
        }

        if (in_array($login_fabrica, array(151)) AND strlen($hd_chamado_item) > 0) {
            $sql = "UPDATE tbl_hd_chamado_item SET os = {$os} WHERE hd_chamado = {$hd_chamado} AND hd_chamado_item  = {$hd_chamado_item}";
            $resX= pg_query($con, $sql);
            $erro .= pg_last_error();

            $sql = "SELECT os FROM tbl_os where os = $os and length(trim(nota_fiscal)) = 0 ";
            #$resx = pg_query($con,$sql);

            if(pg_num_rows($resx) > 0) {
                #$erro .= "Favor informar a nota fiscal e data de nf ";
            }
        } else {
            $sql = "UPDATE tbl_hd_chamado_extra SET os = {$os} WHERE hd_chamado = {$hd_chamado}";
            $resX= pg_query($con, $sql);
            $erro .= pg_last_error();
        }

        $sql = "UPDATE tbl_os SET sua_os = '{$os}' WHERE os = {$os}";
        $res = pg_query($con, $sql);
        $erro .= pg_last_error();

        $sql = "INSERT INTO tbl_os_extra(os) VALUES({$os})";
        $res = pg_query($con, $sql);
        $erro .= pg_last_error();

        $sql = "SELECT status FROM tbl_hd_chamado WHERE hd_chamado = {$hd_chamado}";
        $res = pg_query($con,$sql);
        $status_item = pg_fetch_result($res, 0, 'status');

        if(!in_array($login_fabrica, array(169,170)) && $produto_sem_retorno === false){ //HD-3590498
            $campo_insert_os_produto = ", defeito_constatado";
            $campo_value_os_produto = ", 25817";
        }

        $sql = "
            INSERT INTO tbl_os_produto
                (
                    os,
                    produto,
                    serie
                    $campo_insert_os_produto
                )
            SELECT
                os,
                produto,
                serie
                $campo_value_os_produto
            FROM tbl_os
            WHERE os = {$os};
        ";

        $res = pg_query($con, $sql);

        $erro .= pg_last_error();

        $sql = "INSERT INTO tbl_hd_chamado_item
            (hd_chamado, interno, comentario, status_item)
            VALUES
            ({$hd_chamado}, TRUE, 'Foi aberta uma Ordem de Serviço para o Atendimento. OS: {$os}','{$status_item}')";
        $res = pg_query($con, $sql);
        $erro .= pg_last_error();

        if (in_array($login_fabrica, array(151)) AND $produto_sem_retorno) {
            enviaEmailEComunicado($hd_chamado, $os);
        }
        return $erro;

    }

}

function classificacao_anterior ($id_hd_chamado, $xcallcenter)
{
     global $con, $login_fabrica;

     if (!empty($id_hd_chamado) && !empty($xcallcenter)) {
        $sql_classificacao_anterior = " SELECT hd_classificacao
                                        FROM tbl_hd_chamado
                                        WHERE hd_chamado = $xcallcenter
                                        AND fabrica = $login_fabrica
                    AND hd_classificacao IS NOT NULL";
        $res_classificacao_anterior = pg_query($con, $sql_classificacao_anterior);
        if (pg_num_rows($res_classificacao_anterior) > 0) {
            $classificacao_anterior = pg_fetch_result($res_classificacao_anterior, 0, 'hd_classificacao');

            if ($id_hd_chamado != $classificacao_anterior) {
                $sql_desc_classificacao_anterior = "SELECT descricao, hd_classificacao
                                                    FROM tbl_hd_classificacao
                                                    WHERE hd_classificacao in ($classificacao_anterior, $id_hd_chamado)
                                                    AND fabrica = $login_fabrica";
                $res_desc_classificacao_anterior = pg_query($con, $sql_desc_classificacao_anterior);
                if (pg_num_rows($res_desc_classificacao_anterior) > 0) {
                    for ($c=0; $c < pg_num_rows($res_desc_classificacao_anterior); $c++) {
                        if (pg_fetch_result($res_desc_classificacao_anterior, $c, 'hd_classificacao') == $id_hd_chamado) {
                            $desc_classificacao_nova = pg_fetch_result($res_desc_classificacao_anterior, $c, 'descricao');
                        } else {
                            $desc_classificacao_antiga = pg_fetch_result($res_desc_classificacao_anterior, $c, 'descricao');
                        }
                    }
                    $msg_interacao_classificacao = "<li>Campo <strong>Classificação do Atendimento</strong> alterado de <em>{$desc_classificacao_antiga}</em> para <em>{$desc_classificacao_nova}</em></li>";
                } else {
                    return false;
                }
            } else {
                return false;
            }
        } else {
            return false;
        }
     } else {
        return false;
     }
     return $msg_interacao_classificacao;
}

function abreOSPostoTelaNova($hd_chamado, $posto)
{

    global $con, $login_fabrica, $login_admin;

    $sql = "
        INSERT INTO tbl_os (fabrica,
                posto,
                data_abertura,
                consumidor_nome,
                consumidor_cidade,
                consumidor_estado,
                consumidor_fone,
                consumidor_cpf,
                consumidor_endereco,
                consumidor_numero,
                consumidor_cep,
                consumidor_complemento,
                consumidor_bairro,
                consumidor_email,
                consumidor_celular,
                consumidor_fone_comercial,
                consumidor_revenda,
                revenda,
                revenda_nome,
                revenda_cnpj,
                revenda_fone,
                produto,
                serie,
                defeito_reclamado,
                defeito_reclamado_descricao,
                nota_fiscal,
                data_nf,
                admin,
                hd_chamado,
                obs,
                validada,
                qtde_km
        ) SELECT $login_fabrica,
                $posto,
                CURRENT_DATE,
                tbl_hd_chamado_extra.nome,
                tbl_cidade.nome,
                tbl_cidade.estado,
                tbl_hd_chamado_extra.fone,
                tbl_hd_chamado_extra.cpf,
                tbl_hd_chamado_extra.endereco,
                tbl_hd_chamado_extra.numero,
                tbl_hd_chamado_extra.cep,
                tbl_hd_chamado_extra.complemento,
                tbl_hd_chamado_extra.bairro,
                tbl_hd_chamado_extra.email,
                tbl_hd_chamado_extra.celular,
                tbl_hd_chamado_extra.fone2,
                'C',
                tbl_hd_chamado_extra.revenda,
                tbl_hd_chamado_extra.revenda_nome,
                tbl_hd_chamado_extra.revenda_cnpj,
                tbl_revenda.fone,
                tbl_hd_chamado_extra.produto,
                tbl_hd_chamado_extra.serie,
                tbl_hd_chamado_extra.defeito_reclamado,
                tbl_hd_chamado_extra.defeito_reclamado_descricao,
                tbl_hd_chamado_extra.nota_fiscal,
                tbl_hd_chamado_extra.data_nf,
                $login_admin,
                $hd_chamado,
                'Ordem de Serviço aberta pelo CallCenter, atendimento $hd_chamado',
                CURRENT_TIMESTAMP,
                tbl_hd_chamado_extra.qtde_km
        FROM tbl_hd_chamado
        JOIN tbl_hd_chamado_extra ON tbl_hd_chamado.hd_chamado=tbl_hd_chamado_extra.hd_chamado
        LEFT JOIN tbl_revenda ON tbl_hd_chamado_extra.revenda=tbl_revenda.revenda
        LEFT JOIN tbl_cidade ON tbl_hd_chamado_extra.cidade=tbl_cidade.cidade
        WHERE tbl_hd_chamado.hd_chamado = {$hd_chamado}
        RETURNING os";
    $res = pg_query($con, $sql);

    $erro .= pg_last_error();
    $os = pg_fetch_result($res, 0, 0);

    $sql  = "SELECT hd_chamado FROM tbl_hd_chamado_troca WHERE hd_chamado = $hd_chamado ";
    $resx = pg_query($con, $sql);
    $erro .= pg_last_error();

    if (pg_num_rows($resx) == 0) {
        $sql = "INSERT INTO tbl_hd_chamado_troca ( hd_chamado ) values ( $hd_chamado )";
        $res = pg_query($con, $sql);
        $erro = pg_last_error();
    }

    $sql = "UPDATE tbl_hd_chamado_extra SET os = {$os} WHERE hd_chamado = {$hd_chamado}";
    $resX = pg_query($con, $sql);
    $erro .= pg_last_error();

    $sql = "UPDATE tbl_os SET sua_os = '{$os}' WHERE os = {$os}";
    $res = pg_query($con, $sql);
    $erro .= pg_last_error();

    $sql = "INSERT INTO tbl_os_extra(os) VALUES({$os})";
    $res = pg_query($con, $sql);
    $erro .= pg_last_error();

    $sql = "SELECT status FROM tbl_hd_chamado WHERE hd_chamado = {$hd_chamado}";
    $res = pg_query($con,$sql);
    $status_item = pg_fetch_result($res, 0, 'status');

    $sql = "INSERT INTO tbl_os_produto
    (
        os,
        produto,
        serie
    )
    SELECT
        os,
        produto,
        serie
    FROM tbl_os
    WHERE os = {$os}";
    $res = pg_query($con, $sql);
    $erro = pg_last_error();

    $sql = "INSERT INTO tbl_hd_chamado_item
        (hd_chamado, interno, comentario, status_item)
        VALUES
        ({$hd_chamado}, TRUE, 'Foi aberta uma Ordem de Serviço para o Atendimento. OS: {$os}','{$status_item}')";
    $res = pg_query($con, $sql);
    $erro .= pg_last_error();

    if ($login_fabrica == 50) {
        $qry = pg_query($con, "SELECT fn_valida_os_reincidente($os, $login_fabrica)");
        $erro .= pg_last_error();
    }



    return $erro;

}

function abreOSFilial($hd_chamado, $posto)
{
    global $con, $login_fabrica, $login_admin;

    $sql = "INSERT INTO tbl_os (fabrica,
                posto,
                data_abertura,
                consumidor_nome,
                consumidor_cidade,
                consumidor_estado,
                consumidor_fone,
                consumidor_cpf,
                consumidor_endereco,
                consumidor_numero,
                consumidor_cep,
                consumidor_complemento,
                consumidor_bairro,
                consumidor_revenda,
                revenda,
                revenda_nome,
                revenda_cnpj,
                revenda_fone,
                produto,
                serie,
                defeito_reclamado,
                defeito_reclamado_descricao,
                nota_fiscal,
                data_nf,
                admin,
                hd_chamado,
                obs,
                validada,
                qtde_km
            ) SELECT $login_fabrica,
                $posto,
                CURRENT_DATE,
                tbl_filial.nome,
                tbl_cidade.nome,
                tbl_cidade.estado,
                tbl_filial.telefone,
                tbl_filial.cnpj,
                tbl_filial.endereco,
                tbl_filial.numero,
                tbl_filial.cep,
                tbl_filial.complemento,
                tbl_filial.bairro,
                'C',
                tbl_hd_chamado_extra.revenda,
                tbl_hd_chamado_extra.revenda_nome,
                tbl_hd_chamado_extra.revenda_cnpj,
                tbl_revenda.fone,
                tbl_hd_chamado_extra.produto,
                tbl_hd_chamado_extra.serie,
                tbl_hd_chamado_extra.defeito_reclamado,
                tbl_hd_chamado_extra.defeito_reclamado_descricao,
                tbl_hd_chamado_extra.nota_fiscal,
                tbl_hd_chamado_extra.data_nf,
                $login_admin,
                $hd_chamado,
                'Ordem de Serviço aberta pelo CallCenter, atendimento $hd_chamado',
                CURRENT_TIMESTAMP,
                tbl_hd_chamado_extra.qtde_km
            FROM tbl_filial
            JOIN tbl_cidade ON tbl_cidade.cidade = tbl_filial.cidade
            JOIN tbl_hd_chamado_extra_filial USING(filial)
            JOIN tbl_hd_chamado_extra ON tbl_hd_chamado_extra_filial.hd_chamado=tbl_hd_chamado_extra.hd_chamado
            LEFT JOIN tbl_revenda ON tbl_hd_chamado_extra.revenda=tbl_revenda.revenda
            WHERE tbl_hd_chamado_extra_filial.hd_chamado = $hd_chamado
        RETURNING os";
    $res = pg_query($con, $sql);
    $erro .= pg_last_error();
    $os = pg_fetch_result($res, 0, 0);

    $sql  = "SELECT hd_chamado FROM tbl_hd_chamado_troca WHERE hd_chamado = $hd_chamado ";
    $resx = pg_query($con, $sql);
    $erro .= pg_last_error();

    if (pg_num_rows($resx) == 0) {
        $sql = "INSERT INTO tbl_hd_chamado_troca ( hd_chamado ) values ( $hd_chamado )";
        $res = pg_query($con, $sql);
        $erro = pg_last_error();
    }

    $sql = "UPDATE tbl_hd_chamado_extra SET os = {$os} WHERE hd_chamado = {$hd_chamado}";
    $resX = pg_query($con, $sql);
    $erro .= pg_last_error();

    $sql = "UPDATE tbl_os SET sua_os = '{$os}' WHERE os = {$os}";
    $res = pg_query($con, $sql);
    $erro .= pg_last_error();

    $sql = "INSERT INTO tbl_os_extra(os) VALUES({$os})";
    $res = pg_query($con, $sql);
    $erro .= pg_last_error();

    $sql = "SELECT status FROM tbl_hd_chamado WHERE hd_chamado = {$hd_chamado}";
    $res = pg_query($con,$sql);
    $status_item = pg_fetch_result($res, 0, 'status');

    $sql = "INSERT INTO tbl_os_produto
    (
        os,
        produto,
        serie
    )
    SELECT
        os,
        produto,
        serie
    FROM tbl_os
    WHERE os = {$os}";
    $res = pg_query($con, $sql);
    $erro = pg_last_error();

    $sql = "INSERT INTO tbl_hd_chamado_item
        (hd_chamado, interno, comentario, status_item)
        VALUES
        ({$hd_chamado}, TRUE, 'Foi aberta uma Ordem de Serviço para o Atendimento. OS: {$os}','{$status_item}')";
    $res = pg_query($con, $sql);
    $erro .= pg_last_error();

    return $erro;
}

function grava_chamado_item_externo($hd_chamado, $hd_chamado_item) {
    global $con, $login_fabrica;

    $sqlExterno = "INSERT INTO tbl_hd_chamado_item_externo (fabrica,hd_chamado,hd_chamado_item) VALUES({$login_fabrica},".$hd_chamado.",".$hd_chamado_item.")";
    $resExterno = pg_query($con, $sqlExterno);

    if (pg_last_error()) {
        return false;
    }

    return true;

}

function verifica_origem_atendimento($origem) {
    global $con, $login_fabrica;

    $sql = "SELECT descricao FROM tbl_hd_chamado_origem WHERE fabrica={$login_fabrica} AND hd_chamado_origem = {$origem}";
    $res = pg_query($con,$sql);
    if (pg_last_error() || pg_num_rows($res) == 0) {
        return false;
    }
    $descricao = pg_fetch_result($res, 0, 'descricao');

    return strtolower(retira_acentos($descricao));

}

function valida_celular($celular) {

    if (strlen($celular) > 0) {
        $phoneUtil = \libphonenumber\PhoneNumberUtil::getInstance();

        $celular          = $phoneUtil->parse("+55".$celular, "BR");
        $isValid          = $phoneUtil->isValidNumber($celular);
        $numberType       = $phoneUtil->getNumberType($celular);
        $mobileNumberType = \libphonenumber\PhoneNumberType::MOBILE;

        if (!$isValid || $numberType != $mobileNumberType) {
            return "número de Celular inválido <br />";
        }

    }
}

function valida_cep($cep) {
    global $con;

    if (strlen($cep) > 0) {
        $cep = preg_replace("/\D/", "", $cep);

        $sql = "SELECT cep FROM tbl_cep WHERE cep = '{$cep}'";
        $res = pg_query($con, $sql);

        if (!pg_num_rows($res)) {
            return "CEP Inválido <br>";
        }
    }
}

function verifica_cliente($dados){
    global $con, $login_fabrica;

    $sql = "SELECT cliente FROM tbl_cliente WHERE cpf = '{$dados['cpf']}'";
    $res = pg_query($con,$sql);

    if(pg_num_rows($res) > 0){
        $cliente = pg_fetch_result($res, 0, 'cliente');

        $sql = "SELECT cliente FROM tbl_fabrica_cliente WHERE cliente = {$cliente} AND fabrica = {$login_fabrica}";
        $res = pg_query($con,$sql);

        if(pg_num_rows($res) == 0){

            $sql = "INSERT INTO tbl_fabrica_cliente(cliente,fabrica) VALUES($cliente,$login_fabrica)";
            $res = pg_query($con,$sql);

        }
    }else{
        $endereco = substr($dados['endereco'],0,60);
        $complemento = substr($dados['complemento'],0,30);

        $sql = "INSERT INTO tbl_cliente( nome,
            cpf,
            rg,
            cep,
            cidade,
            bairro,
            endereco,
            numero,
            complemento,
            fone,
            email
        ) VALUES(
            '{$dados['nome']}',
            '{$dados['cpf']}',
            '{$dados['rg']}',
            '{$dados['cep']}',
            '{$dados['cidade']}',
            '{$dados['bairro']}',
            '$endereco',
            '{$dados['numero']}',
            '{$complemento}',
            '{$dados['fone']}',
            '{$dados['email']}'
        ) RETURNING cliente";
        $res = pg_query($con,$sql);
        $msg_erro .= pg_last_error();
        $cliente = pg_fetch_result($res, 0, 'cliente');

        if(!empty($cliente)) {
            $sql = "INSERT INTO tbl_fabrica_cliente(cliente,fabrica) VALUES($cliente,$login_fabrica)";
            $res = pg_query($con,$sql);
            $msg_erro .= pg_last_error();
        }
    }

}

//HD 235203: Alterar assuntos Fale Conosco e CallCenter
//           Ã no arquivo abaixo que é definido o array $assuntos
include_once("callcenter_suggar_assuntos.php");
// include_once '../class/email/mailer/class.phpmailer.php';
include "../class/email/PHPMailer/PHPMailerAutoload.php";
$mailer = new PHPMailer(); //Class para envio de email com autenticação no servidor
$mailTc = new TcComm($externalId);//classe

function enviaEmailEComunicado($hd_chamado, $os) {
    global $con, $mailTc, $login_fabrica, $clogin_fabrica_nome;
    $subject = "Nova OS :: Call-center $clogin_fabrica_nome;";

    $sql = " SELECT tbl_posto_fabrica.codigo_posto AS codigo_posto,
                    tbl_posto.nome AS posto_nome,
                    tbl_posto.email AS posto_email,
                    tbl_fabrica.nome AS fabrica_nome,
                    TO_CHAR(tbl_hd_chamado.data, 'DD/MM/YY HH24:MI') AS data_atendimento,
                    tbl_hd_chamado_extra.nome,
                    tbl_hd_chamado_extra.endereco,
                    tbl_hd_chamado_extra.numero,
                    tbl_hd_chamado_extra.complemento,
                    tbl_hd_chamado_extra.bairro,
                    tbl_cidade.nome AS cidade_nome,
                    tbl_cidade.estado,
                    tbl_hd_chamado_extra.revenda_nome,
                    tbl_revenda.cnpj AS revenda_cnpj,
                    tbl_admin.nome_completo AS admin_nome,
                    tbl_admin.email AS admin_email,
                    tbl_hd_chamado_extra.posto,
                    tbl_produto.referencia AS produto_referencia,
                    tbl_produto.descricao AS produto_nome
               FROM tbl_hd_chamado
               JOIN tbl_hd_chamado_extra ON tbl_hd_chamado.hd_chamado=tbl_hd_chamado_extra.hd_chamado
               JOIN tbl_hd_chamado_item ON tbl_hd_chamado_item.hd_chamado=tbl_hd_chamado.hd_chamado
               JOIN tbl_posto ON tbl_hd_chamado_extra.posto=tbl_posto.posto
               JOIN tbl_posto_fabrica ON tbl_posto.posto=tbl_posto_fabrica.posto
               JOIN tbl_fabrica ON tbl_posto_fabrica.fabrica=tbl_fabrica.fabrica
               JOIN tbl_produto ON tbl_hd_chamado_item.produto=tbl_produto.produto
          LEFT JOIN tbl_cidade ON tbl_hd_chamado_extra.cidade=tbl_cidade.cidade
          LEFT JOIN tbl_revenda ON tbl_hd_chamado_extra.revenda=tbl_revenda.revenda
               JOIN tbl_admin ON tbl_hd_chamado.admin=tbl_admin.admin
              WHERE tbl_hd_chamado.hd_chamado=$hd_chamado
                AND tbl_hd_chamado.fabrica=$login_fabrica
                AND tbl_produto.fabrica_i=$login_fabrica
                AND tbl_hd_chamado_item.os=$os
                AND tbl_posto_fabrica.fabrica=$login_fabrica ";

    $res = pg_query($con, $sql);

    if (pg_num_rows($res)) {

        $email_os_codigo_posto     = pg_fetch_result($res, 0, 'codigo_posto');
        $email_os_posto_nome       = pg_fetch_result($res, 0, 'posto_nome');
        $email_os_posto_email       = pg_fetch_result($res, 0, 'posto_email');
        $email_os_fabrica_nome     = pg_fetch_result($res, 0, 'fabrica_nome');
        $email_os_data_atendimento = pg_fetch_result($res, 0, 'data_atendimento');
        $email_os_nome             = pg_fetch_result($res, 0, 'nome');
        $email_os_endereco         = pg_fetch_result($res, 0, 'endereco');
        $email_os_numero           = pg_fetch_result($res, 0, 'numero');
        //$email_os_complemento    = pg_fetch_result($res, 0, 'complemento');
        $email_os_bairro           = pg_fetch_result($res, 0, 'bairro');
        $email_os_bairro           = preg_replace("/'/g","",$email_os_bairro);
        $email_os_cidade_nome      = pg_fetch_result($res, 0, 'cidade_nome');
        $email_os_cidade_nome      = preg_replace("/'/g","",$email_os_cidade_nome);
        $email_os_estado           = pg_fetch_result($res, 0, 'estado');
        $email_os_revenda_nome     = pg_fetch_result($res, 0, 'revenda_nome');
        $email_os_revenda_cnpj     = pg_fetch_result($res, 0, 'revenda_cnpj');
        $email_os_admin_nome       = pg_fetch_result($res, 0, 'admin_nome');
        $email_os_admin_email      = pg_fetch_result($res, 0, 'admin_email');
        $email_os_dados_produto    = pg_fetch_result($res, 0, 'produto_referencia') .' - ' . pg_fetch_result($res, 0, 'produto_nome');
        $comunicado_posto          = pg_fetch_result($res, 0, 'posto');

        $email_endereco            = "";
        if ($email_os_endereco)     $email_endereco .= $email_os_endereco;
        if ($email_os_numero)       $email_endereco .= ", " . $email_os_numero;
        if ($email_os_complemento)  $email_endereco .= " " . $email_os_complemento;
        if ($email_os_bairro)       $email_endereco .= " - " . $email_os_bairro;
        if ($email_os_cidade_nome)  $email_endereco .= " - " . $email_os_cidade_nome;
        if ($email_os_estado)       $email_endereco .= " - " . $email_os_estado;
        if ($email_os_revenda_cnpj) $email_os_revenda_cnpj = " - " . $email_os_revenda_cnpj;

        $message = "Autorizada $email_os_codigo_posto - $email_os_posto_nome <br />
                    O Callcenter da Fábrica $email_os_fabrica_nome, abriu um atendimento que se tornou uma OS para ser atendido pelo seu posto autorizado.  <br />
                    Segue as informações da OS: <br /><br />
                    Atendimento do Call-Center nº $hd_chamado - Aberto por $email_os_admin_nome em $email_os_data_atendimento
                    número da OS: $os <br />
                    Produto: $email_os_dados_produto <br />
                    Consumidor: $email_os_nome ($email_endereco) <br />
                    Revenda: $email_os_revenda_cnpj $email_os_revenda_nome <br />
            Favor completar este atendimento o mais rápido possÃ­vel, e qualquer dÃºvida,";

    if($login_fabrica == 151){
        $message .= " entrar em contato 0800 345 4589 ";
    }else{
        $message .= " entrar em contato com $email_os_admin_nome Callcenter";
    }

        $emailDestinatario[] = $email_os_posto_email;
        $emailDestinatario[] = $email_os_admin_email;

        $res = $mailTc->sendMail(
            $emailDestinatario,
            $subject,
            $message,
            $externalEmail
        );
    }

    $ea_email = false;
    $ea_email_assunto = $email_os_fabrica_nome . ' - Nova Ordem de Serviço aberta pelo Call-center';
    $ea_email_mensagem = '';
    $ea_email_remetente = '';

    $subject = substr($subject, 0, 50);

    $peca                       = "null";
    $produto                    = "null";
    $aux_familia                = "null";
    $aux_linha                  = "null";
    $aux_extensao               = "null";
    $aux_descricao              = $subject;
    $aux_mensagem               = $message;
    $aux_tipo                   = "Comunicado";
    $posto                      = $comunicado_posto;
    $aux_obrigatorio_os_produto = "'f'";
    $aux_obrigatorio_site       = "'t'";
    $aux_tipo_posto             = "null";
    $aux_ativo                  = "'t'";
    $aux_estado                 = "null";
    $aux_pais                   = "'BR'";
    $remetente_email            = "$email_os_admin_email";
    $pedido_faturado            = "'f'";
    $pedido_em_garantia         = "'f'";
    $digita_os                  = "'f'";
    $reembolso_peca_estoque     = "'f'";

    $sql = "INSERT INTO tbl_comunicado (
                peca                   ,
                produto                ,
                familia                ,
                linha                  ,
                extensao               ,
                descricao              ,
                mensagem               ,
                tipo                   ,
                fabrica                ,
                obrigatorio_os_produto ,
                obrigatorio_site       ,
                posto                  ,
                tipo_posto             ,
                ativo                  ,
                estado                 ,
                pais                   ,
                remetente_email        ,
                pedido_faturado        ,
                pedido_em_garantia     ,
                digita_os              ,
                reembolso_peca_estoque
                {$campo_lu_tecnico}
            ) VALUES (
                $peca                       ,
                $produto                    ,
                $aux_familia                ,
                $aux_linha                  ,
                $aux_extensao               ,
                '$aux_descricao'            ,
                '$aux_mensagem'             ,
                '$aux_tipo'                 ,
                $login_fabrica              ,
                $aux_obrigatorio_os_produto ,
                $aux_obrigatorio_site       ,
                $posto                      ,
                $aux_tipo_posto             ,
                $aux_ativo                  ,
                $aux_estado                 ,
                $aux_pais                   ,
                '$remetente_email'          ,
                $pedido_faturado            ,
                $pedido_em_garantia         ,
                $digita_os                  ,
                $reembolso_peca_estoque
                {$valor_lu_tecnico}
            );";
    $res = pg_query($con, $sql);
    $msg_erro .= pg_errormessage($con);

}

if($login_fabrica == 85 AND strlen($_GET['os']) AND strlen($_GET['callcenter']) > 0 ){
    $xos = $_GET['os'];
}

// HD 2398072 10/06/2015 - Lenoxx - aumentar o nº de anexos por atendimento
//$max_anexos = ($login_fabrica == 11) ? 10 : 3;

if ($_POST['ajax_carrega_posto']) {

    $consumidor_estado = $_POST['consumidor_estado'];
    $consumidor_cidade = $_POST['consumidor_cidade'];
    $dadosPosto        = array();

    $sql = "SELECT tbl_posto_fabrica.codigo_posto,
                   tbl_posto.posto,
                   tbl_posto.nome,
                   tbl_posto_fabrica.contato_fone_comercial,
                   tbl_posto_fabrica.contato_email
          FROM tbl_posto_fabrica_ibge
          JOIN tbl_posto_fabrica_ibge_tipo ON tbl_posto_fabrica_ibge_tipo.posto_fabrica_ibge_tipo=tbl_posto_fabrica_ibge.posto_fabrica_ibge_tipo
          JOIN tbl_posto ON tbl_posto.posto=tbl_posto_fabrica_ibge.posto
          JOIN tbl_posto_fabrica ON tbl_posto_fabrica.posto=tbl_posto.posto AND tbl_posto_fabrica.fabrica={$login_fabrica}
          LEFT JOIN tbl_cidade ON tbl_cidade.cidade=tbl_posto_fabrica_ibge.cidade
          WHERE tbl_posto_fabrica_ibge.fabrica = {$login_fabrica}
          AND tbl_cidade.nome = '{$consumidor_cidade}'
          AND tbl_cidade.estado = '{$consumidor_estado}'
          AND tbl_posto_fabrica_ibge_tipo.nome = 'Postagem'
          AND tbl_posto_fabrica_ibge_tipo.fabrica = {$login_fabrica}";

    $res = pg_query($con, $sql);

    if(pg_num_rows($res) == 0){
    $sql = "SELECT tbl_posto_fabrica.codigo_posto,
        tbl_posto.posto,
        tbl_posto.nome,
        tbl_posto_fabrica.contato_fone_comercial,
        tbl_posto_fabrica.contato_email
        FROM tbl_posto_fabrica_ibge
        JOIN tbl_posto_fabrica_ibge_tipo ON tbl_posto_fabrica_ibge_tipo.posto_fabrica_ibge_tipo=tbl_posto_fabrica_ibge.posto_fabrica_ibge_tipo
        JOIN tbl_posto ON tbl_posto.posto=tbl_posto_fabrica_ibge.posto
        JOIN tbl_posto_fabrica ON tbl_posto_fabrica.posto=tbl_posto.posto AND tbl_posto_fabrica.fabrica={$login_fabrica}
        WHERE tbl_posto_fabrica_ibge.fabrica = {$login_fabrica}
        AND tbl_posto_fabrica_ibge.estado = '{$consumidor_estado}'
        AND tbl_posto_fabrica_ibge.cidade IS NULL
        AND tbl_posto_fabrica_ibge_tipo.nome = 'Postagem'
        AND tbl_posto_fabrica_ibge_tipo.fabrica = {$login_fabrica}";
    $res = pg_query($con, $sql);
    }

    if (pg_num_rows($res)) {
        $dadosPosto = array(
                            "posto" => pg_fetch_result($res, 0, "posto"),
                            "codigo_posto" => pg_fetch_result($res, 0, "codigo_posto"),
                            "nome" => pg_fetch_result($res, 0, "nome"),
                            "fone" => pg_fetch_result($res, 0, "contato_fone_comercial"),
                            "email" => pg_fetch_result($res, 0, "contato_email")
                        );
    }

    exit(json_encode($dadosPosto));
}

if ($_POST["ajax_verifica_atendimento_serie"]) {
    $serie = $_POST['serie'];

    if (strlen($serie) > 0) {

        $sql = "SELECT tbl_hd_chamado.hd_chamado
                FROM tbl_hd_chamado
                JOIN tbl_hd_chamado_item USING(hd_chamado)
                JOIN tbl_produto USING(produto)
                WHERE tbl_hd_chamado.fabrica_responsavel = $login_fabrica
                AND tbl_hd_chamado.status = 'Aberto'
                AND tbl_produto.fabrica_i = $login_fabrica
                AND tbl_hd_chamado_item.serie = '$serie'
                ORDER BY tbl_hd_chamado.hd_chamado DESC limit 1;";
        $res = pg_query($con,$sql);

        if(pg_num_rows($res) > 0){
            $return = array("error" => pg_fetch_result($res,0,'hd_chamado') );
        }else{
            $sql = "SELECT tbl_hd_chamado.hd_chamado
                    FROM tbl_hd_chamado
                    JOIN tbl_hd_chamado_extra USING(hd_chamado)
                    JOIN tbl_produto USING(produto)
                    WHERE tbl_hd_chamado.fabrica_responsavel = $login_fabrica
                    AND tbl_hd_chamado.status = 'Aberto'
                    AND tbl_produto.fabrica_i = $login_fabrica
                    AND tbl_hd_chamado_extra.serie = '$serie'
                    ORDER BY tbl_hd_chamado.hd_chamado DESC limit 1;";
            $res = pg_query($con,$sql);

            if(pg_num_rows($res) > 0){
                $return = array("error" => pg_fetch_result($res,0,'hd_chamado') );
            } else {
                $return = array("success" => "cliente sem atendimento");
            }
        }
    }else{
        $return = array("success" => "cliente sem atendimento" );
    }

    exit(json_encode($return));

}

if( $_POST['ajax_verifica_atendimento'] == true AND isset($_POST['cpf_consumidor'])){
    $consumidor_cpf      = $_POST['cpf_consumidor'];
    $nota_fiscal         = trim($_POST['nota_fiscal']);
    $produto_referencia  = $_POST['produto_referencia'];
    $serie               = $_POST['serie'];

    if(strlen($nota_fiscal) > 0){
        $campo_nf = " AND tbl_hd_chamado_extra.nota_fiscal = '$nota_fiscal' ";
    }

    if(strlen($consumidor_cpf) > 0 && is_null($serie) && is_null($produto_referencia)){
        if(in_array($login_fabrica, array(169,170))){
            $sql = "SELECT admin FROM tbl_admin WHERE fabrica = {$login_fabrica} AND tbl_admin.admin = {$login_admin} AND tbl_admin.callcenter_supervisor IS TRUE ";
            $res = pg_query($con, $sql);

            if(pg_num_rows($res) > 0){
                $return = array("success" => "cliente sem atendimento" );
            }else{
                $sql = "SELECT tbl_hd_chamado.hd_chamado
                    FROM tbl_hd_chamado
                    JOIN tbl_hd_chamado_extra USING(hd_chamado)
                    WHERE tbl_hd_chamado.fabrica = {$login_fabrica}
                    AND tbl_hd_chamado.status = 'Aberto'
                    AND tbl_hd_chamado_extra.cpf = '".preg_replace("/\D/","",$consumidor_cpf)."'
                    $campo_nf
                    ORDER BY tbl_hd_chamado.hd_chamado DESC limit 1";
                $res = pg_query($con,$sql);
                if(pg_num_rows($res) > 0){
                    $return = array("error" => pg_fetch_result($res,0,'hd_chamado') );
                }else{
                    $return = array("success" => "CPF/cnpj sem atendimento");
                }
            }
        }else{
            $sql = "SELECT tbl_hd_chamado.hd_chamado
                FROM tbl_hd_chamado
                JOIN tbl_hd_chamado_extra USING(hd_chamado)
                WHERE tbl_hd_chamado.fabrica = {$login_fabrica}
                AND tbl_hd_chamado.status = 'Aberto'
                AND tbl_hd_chamado_extra.cpf = '".preg_replace("/\D/","",$consumidor_cpf)."'
                $campo_nf
                ORDER BY tbl_hd_chamado.hd_chamado DESC limit 1";
            $res = pg_query($con,$sql);
            if(pg_num_rows($res) > 0){
                $return = array("error" => pg_fetch_result($res,0,'hd_chamado') );
            }else{
                $return = array("success" => "CPF/cnpj sem atendimento");
            }
        }
    } elseif (strlen($produto_referencia) > 0 && strlen($serie) > 0) {

        $sql = "SELECT tbl_hd_chamado.hd_chamado
                FROM tbl_hd_chamado
                JOIN tbl_hd_chamado_item USING(hd_chamado)
                JOIN tbl_produto USING(produto)
                WHERE tbl_hd_chamado.fabrica_responsavel = $login_fabrica
                AND tbl_hd_chamado.status = 'Aberto'
                AND tbl_produto.referencia = '$produto_referencia'
                AND tbl_produto.fabrica_i = $login_fabrica
                AND tbl_hd_chamado_item.serie = '$serie'
                ORDER BY tbl_hd_chamado.hd_chamado DESC limit 1;";
        $res = pg_query($con,$sql);

        if(pg_num_rows($res) > 0){
            $return = array("error" => pg_fetch_result($res,0,'hd_chamado') );
        }else{
            $return = array("success" => "Referência/Serie sem atendimento");
        }
    }else{
        $return = array("success" => "cliente sem atendimento" );
    }

    exit(json_encode($return));
}

if (isset($_GET['ajax']) && isset($_GET['hdanterior']) && isset($_GET['resp'])) {//HD 277105

    if ($_GET['ajax'] != 'sim' || empty($_GET['hdanterior']) || empty($_GET['resp']) )
        return 'Erro com os parÃ¢metros. Verifique os dados na url.';

    $aRespostas = hdBuscarRespostas($_GET['hdanterior'], false, true);

    if (!empty($aRespostas)) {

        $sql = 'SELECT categoria FROM tbl_hd_chamado
                WHERE hd_chamado = ' . $_GET['hdanterior'] . ' AND fabrica = ' . $login_fabrica . 'LIMIT 1';

        $res         = pg_query($con, $sql);
        $assunto_cat = pg_result($res, 0, 'categoria');

        foreach ($assuntos as $categoria_assunto => $itens_categoria_assunto) {

            foreach ($itens_categoria_assunto as $label_assunto => $bd_assunto) {

                if ($bd_assunto == $assunto_cat) {
                    $categoria               = $label_assunto;
                    $achou_categoria_assunto = true;
                }

            }

        }

        echo '<tr class="resp'.$_GET['resp'].'"  bgcolor="#A0BFE0"><td colspan="4"><b>Assunto: ' . $categoria . '</b></td></tr>';

        foreach ($aRespostas as $iResposta=>$aResposta): ?>
            <tr class="resp<?=$_GET['resp']?>" bgcolor="#A0BFE0">
                <td colspan="4">
                                Resposta <strong><?php echo $iResposta + 1; ?></strong>
                                Por <strong><?php echo ( ! empty($aResposta['atendente']) ) ? $aResposta['atendente'] : $aResposta['posto_nome'] ; ?></strong>
                                em <?php echo $aResposta['data']; ?> </td>
                </td>
            </tr>

            <?php if ( $aResposta['interno'] == 't' ): ?>
            <? if($login_fabrica != 74){ ?>
                <tr class="resp<?=$_GET['resp']?>">
                    <td align="center" bgcolor="#EFEBCF" colspan="4"> Chamado Interno </td>
                </tr>
            <? } ?>
            <?php endif; ?>
            <?php if ( in_array($aResposta['status_item'],array('Cancelado','Resolvido','RESOLVIDO')) ): ?>
            <tr class="resp<?=$_GET['resp']?>">
                <td align="center" colspan="4" bgcolor="#EFEBCF" > <?php echo $aResposta['status_item']; ?> </td>
            </tr>
            <?php endif; ?>
            <tr class="resp<?=$_GET['resp']?>">
                <td align="left" colspan="4" bgcolor="#FFFFFF" style="border-bottom:1px solid black;">
                    <?php
                        if (in_array($login_fabrica, [186])) {
                            $respostaBase64 = $aResposta['comentario'];
                            $respostaBase64 = explode(':', $respostaBase64);

                            if (base64_decode(trim($respostaBase64[1]), true)) {
                                $aResposta['comentario'] = $respostaBase64[0] . ': ' . base64_decode($respostaBase64[1]);
                            }

                            $aResposta['comentario']     = utf8_decode($aResposta['comentario']);
                        }
                    ?>
                    <?php echo nl2br($aResposta['comentario']); ?>
                </td>
            </tr><?php
        endforeach;
    }
    else
        echo '<tr class="resp'.$_GET['resp'].' "><td colspan="4">Não foram feitas InteraçÃµes nesse Chamado<td></td></tr>';
    return;

}
$troca_reembolso = "";
if(in_array($login_fabrica, array(85, 151))){
    $sql_admin = "SELECT parametros_adicionais FROM tbl_admin WHERE admin = $login_admin";
    $res_admin = pg_query($con, $sql_admin);
    if(pg_num_rows($res)> 0){

        if($login_fabrica == 85){
            $parametros_adicionais = json_decode(pg_fetch_result($res_admin, 0, 'parametros_adicionais'), true);
            $somente_visualiza_call_center = $parametros_adicionais['somente_visualiza_call_center'];
        }

        if($login_fabrica == 151){
            $parametros_adicionais_admin = json_decode(pg_fetch_result($res_admin, 0, 'parametros_adicionais'), true);
            $troca_reembolso = $parametros_adicionais_admin['troca_reembolso'];
        }
    }
}

if(isset($_POST['envia_email_atlas']) AND $login_fabrica == 74 and !empty($callcenter)){

    $sql = "SELECT tbl_hd_chamado_extra.nome,
            TO_CHAR(tbl_hd_chamado_extra.data_nascimento, 'DD/MM/YYYY') as data_nascimento,
            tbl_hd_chamado_extra.cpf,
            tbl_hd_chamado_extra.email,
            tbl_hd_chamado_extra.fone,
            tbl_hd_chamado_extra.cep,
            tbl_hd_chamado_extra.endereco,
            tbl_hd_chamado_extra.numero,
            tbl_hd_chamado_extra.complemento,
            tbl_hd_chamado_extra.bairro,
            tbl_cidade.nome as nome_cidade,
            tbl_cidade.estado,
            tbl_hd_chamado_extra.fone2,
            tbl_hd_chamado_extra.celular,
            tbl_hd_chamado_extra.posto
        FROM tbl_hd_chamado
        JOIN tbl_hd_chamado_extra ON tbl_hd_chamado_extra.hd_chamado = tbl_hd_chamado.hd_chamado
        JOIN tbl_cidade ON tbl_cidade.cidade = tbl_hd_chamado_extra.cidade
        WHERE tbl_hd_chamado.fabrica = $login_fabrica
        AND tbl_hd_chamado.hd_chamado = $callcenter";
    $res = pg_query($con, $sql);

    if(pg_num_rows($res) > 0){
        $consumidor_nome        = pg_fetch_result($res, 0, 'nome');
        $consumidor_nascimento  = pg_fetch_result($res, 0, 'data_nascimento');
        $consumidor_cpf         = pg_fetch_result($res, 0, 'cpf');
        $consumidor_email       = pg_fetch_result($res, 0, 'email');
        $consumidor_fone        = pg_fetch_result($res, 0, 'fone');
        $consumidor_cep         = pg_fetch_result($res, 0, 'cep');
        $consumidor_endereco    = pg_fetch_result($res, 0, 'endereco');
        $consumidor_numero      = pg_fetch_result($res, 0, 'numero');
        $consumidor_complemento = pg_fetch_result($res, 0, 'complemento');
        $consumidor_bairro      = pg_fetch_result($res, 0, 'bairro');
        $consumidor_estado      = pg_fetch_result($res, 0, 'estado');
        $consumidor_cidade      = pg_fetch_result($res, 0, 'nome_cidade');
        $consumidor_fone2       = pg_fetch_result($res, 0, 'fone2');
        $consumidor_fone3       = pg_fetch_result($res, 0, 'celular');
        $posto                 = pg_fetch_result($res, 0, 'posto');

        $sql = "SELECT
                tbl_posto.nome,
                tbl_posto.cnpj,
                tbl_posto.email,
                tbl_posto.ie,
                tbl_posto.fone,
                tbl_posto_fabrica.contato_cep,
                tbl_posto_fabrica.contato_endereco,
                tbl_posto_fabrica.contato_numero,
                tbl_posto_fabrica.contato_complemento,
                tbl_posto_fabrica.contato_bairro,
                tbl_posto_fabrica.contato_estado,
                tbl_posto_fabrica.contato_cidade
            FROM tbl_posto_fabrica
                INNER JOIN tbl_posto ON tbl_posto.posto = tbl_posto_fabrica.posto
            WHERE tbl_posto_fabrica.fabrica = $login_fabrica
                AND tbl_posto_fabrica.posto = $posto";
        $resPosto = pg_query($con,$sql);

        if(pg_num_rows($resPosto) > 0){
            $posto_nome        = pg_escape_string(pg_fetch_result($resPosto, 0, "nome"));
            $posto_cnpj        = pg_fetch_result($resPosto, 0, "cnpj");
            $posto_email       = pg_fetch_result($resPosto, 0, "email");
            $posto_ie          = pg_fetch_result($resPosto, 0, "ie");
            $posto_fone        = pg_fetch_result($resPosto, 0, "fone");
            $posto_cep         = pg_fetch_result($resPosto, 0, "contato_cep");
            $posto_endereco    = pg_escape_string(pg_fetch_result($resPosto, 0, "contato_endereco"));
            $posto_numero      = pg_fetch_result($resPosto, 0, "contato_numero");
            $posto_complemento = pg_escape_string(pg_fetch_result($resPosto, 0, "contato_complemento"));
            $posto_bairro      = pg_escape_string(pg_fetch_result($resPosto, 0, "contato_bairro"));
            $posto_estado      = pg_fetch_result($resPosto, 0, "contato_estado");
            $posto_cidade      = pg_fetch_result($resPosto, 0, "contato_cidade");
        }

        $sqlAdmin = "SELECT nome_completo, email FROM tbl_admin WHERE fabrica = $login_fabrica AND admin = $login_admin";
        $resAdmin = pg_query($con, $sqlAdmin);

        $nome_admin = pg_fetch_result($resAdmin, 0, 'nome_completo');
        $email_admin = pg_fetch_result($resAdmin, 0, 'email');

        $from_fabrica  = 'cadastro@atlas.ind.br, mentor@atlas.ind.br';
        $from_fabrica_descricao = "Atendimento ATLAS";

        $assunto  = $nome_admin.' - Atendimento '.$callcenter;

        $mensagem = "<strong>Dados do Consumidor</strong><br><br>";
        $mensagem .= "<strong>Nome:</strong> $consumidor_nome  <strong>Data Nascimento:</strong> $consumidor_nascimento <br>";
        $mensagem .= "<strong>CPF:</strong> $consumidor_cpf  <strong>Email:</strong> $consumidor_email <br>";
        $mensagem .= "<strong>Fone:</strong> $consumidor_fone  <strong>CEP:</strong> $consumidor_cep <br>";
        $mensagem .= "<strong>Endereço:</strong> $consumidor_endereco  <strong>Numero:</strong> $consumidor_numero  <strong>Complemento:</strong> $consumidor_complemento <br>";
        $mensagem .= "<strong>Bairro:</strong> $consumidor_bairro  <strong>Estado:</strong> $consumidor_estado  <strong>Cidade:</strong> $consumidor_cidade <br>";
        $mensagem .= "<strong>Fone Comercial:</strong> $consumidor_fone2  <strong>Celular:</strong> $consumidor_fone3 <br><br>";

        $mensagem .= "<strong>Dados de Entrega</strong><br><br>";
        $mensagem .= "<strong>Nome PA:</strong> $posto_nome<br>";
        $mensagem .= "<strong>CNPJ/CÓD:</strong> $posto_cnpj  <strong>Email:</strong> $posto_email <br>";
        $mensagem .= "<strong>IE:</strong> $posto_ie  <br>";
        $mensagem .= "<strong>Fone:</strong> $posto_fone  <strong>CEP:</strong> $posto_cep  <br>";
        $mensagem .= "<strong>Endereço:</strong> $posto_endereco  <strong>Numero:</strong> $posto_numero  <strong>Complemento:</strong> $posto_complemento <br>";
        $mensagem .= "<strong>Bairro:</strong> $posto_bairro  <strong>Estado:</strong> $posto_estado  <strong>Cidade:</strong> $posto_cidade <br>";

        $headers  = "MIME-Version: 1.0 \r\n";
        $headers .= "Content-type: text/html \r\n";
        $headers .= "From: $from_fabrica_descricao <$email_admin> \r\n";

       // mail('<'.$from_fabrica.'>', $assunto, utf8_encode($mensagem), $headers);
        $mailTc = new TcComm($externalId);
        $res = $mailTc->sendMail(
            'cadastro@atlas.ind.br',
            $assunto,
            $mensagem,
            $externalEmail
        );

    }else{
        $msg_erro .= "Erro ao enviar o Email";
    }
}

if (isset($_POST['ajax_garantia']) AND $login_fabrica == 74) {
    //pesquisa a serie da garantia adicional
    $serie_ga = $_POST['ajax_garantia'];

    $sql_s = "SELECT
                      tbl_hd_chamado.hd_chamado
                    FROM tbl_hd_chamado
                      JOIN tbl_hd_chamado_extra USING(hd_chamado)
                    WHERE tbl_hd_chamado_extra.serie = '{$serie_ga}'
                      AND tbl_hd_chamado.categoria = 'garantia_adicional'
                      AND tbl_hd_chamado.fabrica_responsavel = {$login_fabrica}; ";
    $res_s = pg_query($con,$sql_s);

    if (pg_num_rows($res_s) > 0) {
        $res_hd = array();
        for ($s=0; $s < pg_num_rows($res_s) ; $s++) {
            $hd_chamado_g = pg_fetch_result($res_s, $s, hd_chamado);
            $res_hd[] = $hd_chamado_g;
        }
        $res_hd = implode(",", $res_hd);
        echo "<p style='color:red'><strong>Serie com Garantia Adicional - Protocolo: ".$res_hd."</strong></p>";
    }
    exit;
}

if(isset($_POST['ajax-estado'])){

    $estado = $_POST['ajax-estado'];

    $sql = "
        SELECT DISTINCT(tbl_ibge.cidade) AS cidade, tbl_ibge.cod_ibge AS cod
        FROM tbl_ibge
        JOIN tbl_posto_fabrica_ibge ON tbl_posto_fabrica_ibge.cod_ibge = tbl_ibge.cod_ibge AND tbl_posto_fabrica_ibge.fabrica = $login_fabrica
        WHERE tbl_ibge.estado = '$estado'
        ORDER BY tbl_ibge.cidade
    ";
    $res = pg_query($con, $sql);

    if(pg_num_rows($res)){

        $est = "<option value=''></option>";

        while($data = pg_fetch_object($res)){
            $est .= "<option value='".$data->cod."'>".$data->cidade."</option>";
        }

        echo $est;

    }else{
        echo "<option value=''>Nenhuma cidade localiza</option>";
    }

    exit;
}

if(isset($_POST['ajax-cidade'])){

    $cidade = $_POST['ajax-cidade'];
     if(isset($_POST['bairro']) || isset($_POST['bairro_escolhido'])){
        $campoAdd = ",tbl_posto_fabrica_ibge.bairro ";
     }else{
        $campoAdd = "";
     }

    $orderby = (isset($_POST['bairro_escolhido'])) ? "nome_posto" : "tbl_posto_fabrica_ibge.bairro";
    $sql = "
        SELECT tbl_posto.nome AS nome_posto, tbl_posto.posto AS cod_posto, tbl_posto.cidade AS cidade $campoAdd
        FROM tbl_ibge
        JOIN tbl_posto_fabrica_ibge ON tbl_posto_fabrica_ibge.cod_ibge = tbl_ibge.cod_ibge AND tbl_posto_fabrica_ibge.fabrica = $login_fabrica
        JOIN tbl_posto ON tbl_posto.posto = tbl_posto_fabrica_ibge.posto
        WHERE tbl_ibge.cod_ibge = '$cidade'
        ORDER BY $orderby";

    $res = pg_query($con, $sql);

    if(pg_num_rows($res)){

        $est = "<option value=''></option>";

        if($login_fabrica == 74){
            if(isset($_POST['bairro'])){
                $arrayBairros = array();
                $auxBairros = array();

                while($data = pg_fetch_object($res)){
                    if($data->bairro != ""){

                        if(!strstr($data->bairro, "{")){

                            $arrayBairro[$data->cod_posto] = json_decode($data->bairro);
                            $arrayBairros = array_merge($arrayBairros,$arrayBairro[$data->cod_posto]);

                        }

                    }
                }

                $est .= "<option  value='todos'>Todos bairros</option>";
                sort($arrayBairros);
                foreach ($arrayBairros as $bairro) {
                    if(!empty($bairro)){
                        if(!in_array($bairro, $auxBairros)){
                            $auxBairros[] = $bairro;
                            $est .= "<option  value='".md5(trim($bairro))."'>".utf8_decode($bairro)."</option>";
                        }
                    }
                }
                echo $est;exit;

            }elseif(isset($_POST['bairro_escolhido'])){
                $bairroEscolhido = $_POST['bairro_escolhido'];
                if($bairroEscolhido == "todos"){

                    while($data = pg_fetch_object($res)){
                        if(strlen($data->cidade) == 0){
                            $data->cidade = "Cidade não informada";
                        }

                        $est .= "<option bairro='".$data->bairro."' value='".$data->cod_posto."'>".$data->nome_posto." - ".$data->cidade."</option>";
                    }
                }else{

                    $resPostos = pg_fetch_all($res);
                    sort($resPostos);

                    foreach ($resPostos as $posto) {
                        if($posto['bairro'] != ""){
                            $arrayBairros[$posto['cod_posto']] = json_decode($posto['bairro'], true);
                        }
                    }

                    $postos = array();
                    foreach ($arrayBairros as $posto => $bairros) {
                        for($i=0;$i<count($bairros);$i++){
                            if($bairroEscolhido == md5(trim($bairros[$i]))){

                                $postos[] = $posto;
                            }
                        }
                    }

                    for($i=0;$i<count($resPostos);$i++){
                        if(in_array($resPostos[$i]['cod_posto'],$postos)){
                            if(strlen($resPostos[$i]['cidade']) == 0){
                                $resPostos[$i]['cidade'] = "Cidade não informada";
                            }

                            $est .= "<option  value='".$resPostos[$i]['cod_posto']."'>".$resPostos[$i]['nome_posto']." - ".$resPostos[$i]['cidade']."</option>";

                        }
                    }
                }

            }else{
                while($data = pg_fetch_object($res)){
                    if(strlen($data->cidade) == 0){
                        $data->cidade = "Cidade não informada";
                    }

                    $est .= "<option bairro='".$data->bairro."' value='".$data->cod_posto."'>".$data->nome_posto." - ".$data->cidade."</option>";
                }
            }

        }else{
            while($data = pg_fetch_object($res)){
                if(strlen($data->cidade) == 0){
                    $data->cidade = "Cidade não informada";
                }

                $est .= "<option  value='".$data->cod_posto."'>".$data->nome_posto." - ".$data->cidade."</option>";
            }
        }

        echo $est;

    }else{
        echo "<option value=''>Nenhuma cidade localiza</option>";
    }

    exit;
}

function retira_acentos($texto){
    $array1 = array('á', 'Ã ', 'Ã¢', 'ã', 'Ã¤', 'é', 'Ã¨', 'ê', 'Ã«', 'Ã­', 'Ã¬', 'Ã®', 'Ã¯', 'ó', 'Ã²', 'Ã´', 'Ãµ', 'Ã¶', 'Ãº', 'Ã¹', 'Ã»', 'Ã¼', 'ç' , 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã', 'Ã','Âº','&','%','$','?','@', '\'');
    $array2 = array('a', 'a', 'a', 'a', 'a', 'e', 'e', 'e', 'e', 'i', 'i', 'i', 'i', 'o', 'o', 'o', 'o', 'o', 'u', 'u', 'u', 'u', 'c' , 'A', 'A', 'A', 'A', 'A', 'E', 'E', 'E', 'E', 'I', 'I', 'I', 'I', 'O', 'O', 'O', 'O', 'O', 'U', 'U', 'U', 'U', 'C','_','_','_','_','_','_' ,'');
    return str_replace( $array1, $array2, $texto );
}

function retira_especiais($texto){
    return str_replace("-", " " ,str_replace(array(".", ","), "", $texto));
}

if (!empty($_COOKIE['debug'])) $debug = ($_COOKIE['debug']=='true');

if ($login_fabrica == 3) {
    if (strlen($callcenter) > 0) header ("Location:callcenter_interativo_new_britania.php?callcenter=$callcenter");
    else                         header ('Location:callcenter_interativo_new_britania.php');
    exit;
}else if($login_fabrica == 5){
    if (strlen($callcenter) > 0) header ("Location:callcenter_interativo_new_mondial.php?callcenter=$callcenter");
    else                         header ('Location:callcenter_interativo_new_mondial.php');
    exit;
}

$fab_usa_tipo_cons = array(51); // HD 317864

if ($_GET["continuar_chamado"] && $_GET["Id"]) {

    $hd_chamado = $_GET["Id"];

    $sql = "SELECT hd_chamado FROM tbl_hd_chamado
            WHERE  hd_chamado = $hd_chamado
            AND    fabrica = $login_fabrica
            AND    fabrica_responsavel = $login_fabrica";

    $res = pg_query($con, $sql);

    if (pg_num_rows($res)) {

        $sql = "BEGIN TRANSACTION";
        $res = pg_query($con, $sql);
        $msg_erro[] = pg_errormessage($con);

        $sql = "INSERT INTO tbl_hd_chamado (
                    admin,
                    posto,
                    titulo,
                    status,
                    atendente,
                    fabrica_responsavel,
                    categoria,
                    duracao,
                    exigir_resposta,
                    fabrica,
                    empregado,
                    orcamento,
                    pessoa,
                    sequencia_atendimento,
                    tipo_chamado,
                    cliente,
                    cliente_admin,
                    hd_chamado_anterior
                ) SELECT
                    $login_admin,
                    posto,
                    titulo,
                    'Aberto',
                    $login_admin,
                    fabrica_responsavel,
                    categoria,
                    duracao,
                    exigir_resposta,
                    fabrica,
                    empregado,
                    orcamento,
                    pessoa,
                    sequencia_atendimento,
                    tipo_chamado,
                    cliente,
                    cliente_admin,
                    $hd_chamado
            FROM tbl_hd_chamado
            WHERE hd_chamado = $hd_chamado ";
        $res = pg_query($con, $sql);
        $msg_erro[] = pg_errormessage($con);

        $res = pg_query($con, "SELECT CURRVAL('seq_hd_chamado')");
        $hd_chamado_novo = pg_result($res, 0, 0);
        $msg_erro[] = pg_errormessage($con);

        if($login_fabrica == 24){

            include_once "../class/aws/s3_config.php";

            include_once S3CLASS;
            if(!isset($s3)){
                $s3 = new AmazonTC('callcenter', (int) $login_fabrica);
            }

            $s3->getObjectList("{$hd_chamado}-", false);

            $file_links = $s3->getLinkList($s3->files);
            $cont = 0;

            foreach($file_links as $linha){

                $linha = explode("/", $linha);
                $linha = explode("?", $linha[7]);

                $arquivo[$cont]['file_orig'] = $linha[0];
                $linha_new = str_replace("$hd_chamado", "$hd_chamado_novo", $linha[0]);
                $arquivo[$cont]['file_new'] = $linha_new;
                $cont++;
            }
            $s3->copyObject($arquivo, null, null);
        }
        if (in_array($login_fabrica, array(169, 170))) {
            $campo_tipo_atendimento = ', tipo_atendimento';
        } else {
            $campo_qtde_km = ", qtde_km";
            $valor_qtde_km = ", qtde_km";
        }

        $sql = "INSERT INTO tbl_hd_chamado_extra (
                    hd_chamado,
                    reclamado,
                    defeito_reclamado,
                    serie,
                    hora_ligacao,
                    produto,
                    posto,
                    os,
                    receber_info_fabrica,
                    consumidor_revenda,
                    origem,
                    revenda,
                    revenda_nome,
                    data_nf,
                    nota_fiscal,
                    nome,
                    endereco,
                    numero,
                    complemento,
                    bairro,
                    cep,
                    fone,
                    fone2,
                    email,
                    cpf,
                    rg,
                    cidade,
                    abre_os,
                    defeito_reclamado_descricao,
                    numero_processo,
                    tipo_registro,
                    celular,
                    revenda_cnpj,
                    atendimento_callcenter,
                    contato_nome,
                    marca
                {$campo_qtde_km}
                    {$campo_tipo_atendimento}
            ) SELECT $hd_chamado_novo,
                reclamado,
                defeito_reclamado,
                serie,
                hora_ligacao,
                produto,
                posto,
                os,
                receber_info_fabrica,
                consumidor_revenda,
                origem,
                revenda,
                revenda_nome,
                data_nf,
                nota_fiscal,
                nome,
                endereco,
                numero,
                complemento,
                bairro,
                cep,
                fone,
                fone2,
                email,
                cpf,
                rg,
                cidade,
                'f',
                defeito_reclamado_descricao,
                numero_processo,
                tipo_registro,
                celular,
                revenda_cnpj,
                atendimento_callcenter,
                contato_nome,
                marca
        {$valor_qtde_km}
                {$campo_tipo_atendimento}
        FROM tbl_hd_chamado_extra
        WHERE hd_chamado=$hd_chamado ";
         //echo nl2br($sql);exit;
        $res = pg_query($con, $sql);
        $msg_erro[] = pg_errormessage($con);

        //if ($login_fabrica != 24) {

        if($login_fabrica == 24){
            $status_item = " status_item ,";
            $tincaso = " tincaso, ";
            $value_tincaso = " CASE
WHEN tincaso is not null THEN
tincaso
ELSE
'$hd_chamado'
END AS tincaso ,  "        ;
        }else{
            $status_item = "'Aberto',";

        }

            if($login_fabrica == 24){
                $tempo_interacao = 'null';
            }else{
                $tempo_interacao = 'tempo_interacao';
            }

            $sql = "INSERT INTO tbl_hd_chamado_item (
                        hd_chamado,
                        data,
                        comentario,
                        admin,
                        posto,
                        interno,
                        status_item,
                        empregado,
                        pessoa,
                        termino,
                        tempo_interacao,
                        enviar_email,
                        atendimento_telefone,
                        produto,
                        serie,
                        $tincaso
                        defeito_reclamado
                    ) SELECT
                        $hd_chamado_novo,
                        data,
                        comentario,
                        admin,
                        posto,
                        interno,
                        $status_item
                        empregado,
                        pessoa,
                        termino,
                        $tempo_interacao,
                        enviar_email,
                        atendimento_telefone,
                        produto,
                        serie,
                        $value_tincaso
                        defeito_reclamado
                FROM tbl_hd_chamado_item
                WHERE hd_chamado = $hd_chamado ";

            $res = pg_query($con, $sql);
            $msg_erro[] = pg_errormessage($con);

            $query_tdocs = "INSERT INTO tbl_tdocs (
                tdocs_id,
                fabrica,
                contexto,
                situacao,
                obs,
                referencia,
                referencia_id
            ) (SELECT
                tdocs_id,
                fabrica,
                contexto,
                situacao,
                obs,
                referencia,
                $hd_chamado_novo
                FROM tbl_tdocs
                WHERE referencia_id = $hd_chamado);";
            $result = pg_query($con, $query_tdocs);
            $msg_erro[] = pg_errormessage($con);

        //}

        $msg_erro = implode("", $msg_erro);

        if (strlen($msg_erro)) {

            $sql = "ROLLBACK TRANSACTION";
            $res = pg_query($con, $sql);
            header("location:" . $PHP_SELF);
            die;

        } else {

            $sql = "COMMIT TRANSACTION";
            $res = pg_query($con, $sql);
            $novo_hd = '';
            if ($login_fabrica == 24) {
                $novo_hd = "&novo_hd=sim";
            }
            header("location:" . $PHP_SELF . "?callcenter=$hd_chamado_novo".$novo_hd);
            die;

        }

    } else {

        header("location:" . $PHP_SELF);
        die;

    }

}

//AJAX PARA RETORNAR O GRID COM AS PESQUISAS DE SATISFACAO DA FRICON - HD 925147
if (isset($_GET['showPesquisa']) and $login_fabrica == 52) {

    $pesquisa = $_GET['pesquisa'];
    $hd_chamado = $_GET['hd_chamado'];

    /*PEGA O TEXTO DE AJUDA na tbl_pesquisa.texto_ajuda*/
    $sql = "SELECT tbl_pesquisa.texto_ajuda FROM tbl_pesquisa WHERE pesquisa = $pesquisa and fabrica=$login_fabrica";
    $res = pg_query($con,$sql);
    $texto_ajuda = (pg_num_rows($res) > 0) ? pg_fetch_result($res,0,0) : '' ;

    $sql = "SELECT  tbl_pesquisa_pergunta.ordem,
            tbl_pergunta.pergunta,
            tbl_pergunta.descricao,
            tbl_pergunta.tipo_resposta,
            tbl_tipo_resposta.tipo_descricao,
            tbl_pesquisa.pesquisa
        FROM tbl_pesquisa_pergunta

        INNER JOIN tbl_pergunta using(pergunta)
        INNER JOIN tbl_pesquisa using(pesquisa)
        LEFT JOIN tbl_tipo_resposta on (tbl_pergunta.tipo_resposta = tbl_tipo_resposta.tipo_resposta)

        WHERE tbl_pesquisa.pesquisa = $pesquisa
        and tbl_pesquisa.fabrica = $login_fabrica
        and tbl_pergunta.ativo is true ORDER BY tbl_pesquisa_pergunta.ordem";

    $res = pg_query($con,$sql);

    $html_pesquisa .= ' <script type="text/javascript" src="js/jquery.maskedinput2.js"></script>
                        <script type="text/javascript" src="../plugins/jquery/datepick/jquery.datepick.js"></script>
                        <script type="text/javascript" src="../plugins/jquery/datepick/jquery.datepick-pt-BR.js"></script>
                        <link rel="stylesheet" type="text/css" href="../plugins/jquery/datepick/telecontrol.datepick.css" />
                        <script>
                        $(function() {

                            $(".date").datepick({startDate:"01/01/2000"});
                            $(".date").mask("99/99/9999");

                        });
                        </script>';

    $html_pesquisa .= '<table width="900px" class="tabela table_perguntas_fricon_pesquisa" border="0" cellpadding="2" cellspacing="2" style="margin:auto;background-color: #F4E6D7;font-size:10px" >';
    //exibe o texto de ajuda
    $html_pesquisa .= '
            <tr>
                <td colspan="100%">
                    '.nl2br($texto_ajuda).'
                </td>
            </tr>';
    if (pg_num_rows($res)>0) {

        $i = 0;
        $respostasPergunta = array();
        //percorre o array da consulta principal 1Âê vez para jogar as respostas em um array
        foreach (pg_fetch_all($res) as $key) {
            $sql = "SELECT pergunta, txt_resposta,tipo_resposta_item
                FROM tbl_resposta
                WHERE pergunta = {$key['pergunta']}
                AND pesquisa = {$pesquisa}
                and hd_chamado = $hd_chamado
                ORDER BY pergunta";
            $resRespostas = pg_query($con,$sql);

            if (pg_num_rows($resRespostas)>0) {
                foreach (pg_fetch_all($resRespostas) as $keyRespostas) {
                    if (!empty($keyRespostas['tipo_resposta_item'])) {

                        $respostasPergunta[$key['pesquisa']][$key['pergunta']]['respostas'][] = $keyRespostas['tipo_resposta_item'];

                    }else{
                        $respostasPergunta[$key['pesquisa']][$key['pergunta']]['respostas'][] = $keyRespostas['txt_resposta'];
                    }
                }
            }
        }
        //percorre a segunda vez para montar o formulário
        foreach (pg_fetch_all($res) as $key) {

            $cor = ($i % 2) ? "#E4E9FF" : "#F3F3F3";

            $html_pesquisa .= "
                    <tr bgcolor='$cor'>
                        <td style='text-align:center;padding: 0px 10px 0px 10px' >
                            <input type='hidden' name='perg_".$i."' value='".$key['pergunta']."' placeholder=''>
                            <input type='hidden' name='hidden_$i' value='".$key['tipo_descricao']."' >
                            <label > ".$key['ordem']." </label>
                        </td>
                        <td  align='left' nowrap  style='text-align:justify;padding: 0px 10px 0px 10px' >
                            ".$key['descricao']."
                        </td>";

            if (!empty($key['tipo_resposta'])) {

                $sql = "SELECT tbl_tipo_resposta_item.descricao,
                        tbl_tipo_resposta.label_inicio,
                        tbl_tipo_resposta.label_fim,
                        tbl_tipo_resposta.label_intervalo,
                        tbl_tipo_resposta.tipo_descricao,
                        tbl_tipo_resposta_item.tipo_resposta_item
                    FROM tbl_tipo_resposta
                    LEFT JOIN    tbl_tipo_resposta_item using(tipo_resposta)
                    WHERE tbl_tipo_resposta.tipo_resposta = ".$key['tipo_resposta']."
                    AND tbl_tipo_resposta.fabrica = $login_fabrica
                    ORDER BY tbl_tipo_resposta_item.ordem ";

                $res = pg_query($con,$sql);
                if (pg_num_rows($res)>0) {
                    for ($x=0; $x < pg_num_rows($res); $x++) {

                        if (!empty($respostasPergunta)) {
                            $disabled = 'disabled="DISABLED"';
                        }

                        $item_tipo_resposta_desc            = pg_fetch_result($res, $x, 'descricao');
                        $item_tipo_resposta_tipo            = pg_fetch_result($res, $x, 'tipo_descricao');
                        $item_tipo_resposta_label_inicio    = pg_fetch_result($res, $x, 'label_inicio');
                        $item_tipo_resposta_label_fim       = pg_fetch_result($res, $x, 'label_fim');
                        $item_tipo_resposta_label_intervalo = pg_fetch_result($res, $x, 'label_intervalo');
                        $tipo_resposta_item_id              = pg_fetch_result($res, $x, 'tipo_resposta_item');

                        if (in_array($item_tipo_resposta_tipo, array('checkbox','radio'))) {
                            $colspan = '';
                            $width = '';
                        }else{
                            $colspan = '100%';
                        }

                        $html_pesquisa .= "<td align='center' nowrap colspan='$colspan' >";

                        if ($item_tipo_resposta_tipo == 'radio' or $item_tipo_resposta_tipo == 'checkbox') {
                            $value_resposta = $tipo_resposta_item_id;
                        }else{
                            $value_resposta = $item_tipo_resposta_desc;
                        }

                        switch ($item_tipo_resposta_tipo) {

                            case 'radio':
                                $html_pesquisa .= $item_tipo_resposta_desc;
                                $value_resposta = $tipo_resposta_item_id;

                                if (is_array($respostasPergunta) and !empty($respostasPergunta)) {

                                    if (in_array($tipo_resposta_item_id,$respostasPergunta[$key['pesquisa']][$key['pergunta']]['respostas'])) {
                                        $checked_radio = "checked='CHECKED'";
                                    }

                                }

                                $html_pesquisa .= ' <input  type="'.$item_tipo_resposta_tipo.'"  style="width:'.$width.'" name="perg_opt'.$key['pergunta'].'"  class="frm" value="'.$value_resposta.'" '.$checked_radio.$disabled.' />';

                                break;

                            case 'text':

                                $item_tipo_resposta_desc = $key['txt_resposta'];
                                $disabled_resposta = "disabled='DISABLED'";
                                $value_resposta = $item_tipo_resposta_desc;
                                if (is_array($respostasPergunta) and !empty($respostasPergunta)){
                                    if (!empty($respostasPergunta[$key['pesquisa']][$key['pergunta']]['respostas'])) {
                                        $value_resposta = $respostasPergunta[$key['pesquisa']][$key['pergunta']]['respostas'][0];
                                    }
                                }
                                $html_pesquisa .= ' <input  type="'.$item_tipo_resposta_tipo.'"  style="width:'.$width.'" name="perg_opt'.$key['pergunta'].'"  class="frm" value="'.$value_resposta.'" '.$disabled.' />';

                                break;

                            case 'range':

                                $value_resposta = $item_tipo_resposta_desc;

                                for ($z=$item_tipo_resposta_label_inicio; $z <= $item_tipo_resposta_label_fim ; $z+=$item_tipo_resposta_label_intervalo) {

                                    if (is_array($respostasPergunta) and !empty($respostasPergunta)){
                                        if (in_array($z,$respostasPergunta[$key['pesquisa']][$key['pergunta']]['respostas'])) {
                                            $checked_radio = "checked='CHECKED'";
                                        }else{
                                            $checked_radio = "";
                                        }
                                    }

                                    $html_pesquisa .= $z.' <input type="radio" name="perg_opt'.$key['pergunta'].'" value="'.$z.'" '.$checked_radio.$disabled.' /> &nbsp; &nbsp;';

                                }

                                break;

                            case 'checkbox':

                                $html_pesquisa .= $item_tipo_resposta_desc;
                                $value_resposta = $tipo_resposta_item_id;
                                if (is_array($respostasPergunta) and !empty($respostasPergunta)){
                                    if (in_array($tipo_resposta_item_id,$respostasPergunta[$key['pesquisa']][$key['pergunta']]['respostas'])) {
                                        $checked_radio = "checked='CHECKED'";
                                    }
                                }
                                $html_pesquisa .= ' <input  type="'.$item_tipo_resposta_tipo.'"  style="width:'.$width.'" name="perg_opt_checkbox_'.$key['pergunta'].'_'.$i.'_'.$value_resposta.'"  class="frm" value="'.$value_resposta.'" '.$checked_radio.$disabled.' />';

                                break;

                            case 'textarea':

                                if (is_array($respostasPergunta) and !empty($respostasPergunta)){
                                    if (!empty($respostasPergunta[$key['pesquisa']][$key['pergunta']]['respostas'])) {
                                        $value_resposta = $respostasPergunta[$key['pesquisa']][$key['pergunta']]['respostas'][0];
                                    }
                                }
                                $html_pesquisa .= ' <textarea name="perg_opt'.$key['pergunta'].'" class="frm" '.$disabled.' style="width:90%" >'.$value_resposta.'</textarea> ';
                                break;

                            case 'date':

                                if (is_array($respostasPergunta) and !empty($respostasPergunta)){
                                    if (!empty($respostasPergunta[$key['pesquisa']][$key['pergunta']]['respostas'])) {
                                        $value_resposta = $respostasPergunta[$key['pesquisa']][$key['pergunta']]['respostas'][0];
                                    }
                                }

                                $width="";
                                $html_pesquisa .= ' <input  type="text"  style="width:'.$width.'" name="perg_opt'.$key['pergunta'].'"  class="frm date" value="'.$value_resposta.'" '.$disabled.' />';

                                break;

                            default:

                                break;

                        }

                        $html_pesquisa .= '</td>';
                        unset($checked_radio);
                    }

                }

            }else{
                $html_pesquisa .= "<td colspan='3'>&nbsp; </td>";
            }

            $html_pesquisa .= "
                    </tr>";
            $i++;

        }

    }

    if (is_array($respostasPergunta) and empty($respostasPergunta)) {
        $html_pesquisa .= '<tr><td colspan="100%">
            <input type="hidden" name="qtde_perg" value="'.$i.'">
            <input type="button" value="Gravar" class="btn_grava_pesquisa_fricon" rel="'.$pesquisa.'">
            <div class="td_btn_gravar_pergunta"></div>
        </td></tr>';

    }
    $html_pesquisa .= "</table>";
    echo $html_pesquisa;
    exit();
} // FIM showPesquisa FRICON

//HD 895693
if ($_GET['ajax'] && $_GET['gravaPerguntasFricon'] && $login_fabrica == 52){

    $erro          = array();
    $hdChamado     = $_GET['hdChamado'];
    $qtde_perg     = $_GET['qtde_perg'];
    $pesquisa      = $_GET['pesquisa'];
    $arrayCheckbox = array();

    foreach ($_GET as $keyPost => $valuePost) {

        $keyExplode = explode("_",$keyPost);

        if($keyExplode[2]=='checkbox'){
            $arrayCheckbox[$keyExplode[3]][] = $keyExplode[5];

        }

    }

    $res = pg_query($con,'BEGIN');

    for ($i=0; $i < $qtde_perg; $i++) {

        $pergunta = $_GET['perg_'.$i];
        $tipo_resposta = $_GET['hidden_'.$i];

        $resposta = (isset($_GET['perg_opt'.$pergunta])) ? utf8_decode(trim($_GET['perg_opt'.$pergunta])) : '';

        if (in_array($tipo_resposta, array('text','range','textarea','date'))) {

            $txt_resposta = $resposta;
            $resposta = 'null';
        }

        if ( is_array($arrayCheckbox[$pergunta]) and $tipo_resposta == 'checkbox' and count($arrayCheckbox[$pergunta])>0 ) {

            foreach ($arrayCheckbox[$pergunta] as $value) {
                $resposta = $value;

                $sqlItens = "SELECT tbl_tipo_resposta_item.descricao FROM tbl_tipo_resposta_item where tipo_resposta_item = ".$value;
                $resItens = pg_query($con,$sqlItens);

                if (pg_num_rows($resItens)>0) {

                    $txt_resposta = pg_fetch_result($resItens,0,0);

                }else{
                    $txt_resposta = '';
                }

                $sql = "INSERT INTO tbl_resposta (
                        pergunta,
                        hd_chamado,
                        txt_resposta,
                        tipo_resposta_item,
                        pesquisa,
                        admin,
                        data_input
                    )VALUES(
                        $pergunta,
                        $hdChamado,
                        '$txt_resposta',
                        $resposta,
                        '$pesquisa',
                        $login_admin,
                        CURRENT_TIMESTAMP
                    )
                    ";
                $res = pg_query($con,$sql);

            }
            continue ;
        }

        if (!empty($resposta) and $resposta != 'null') {

            $sqlItens = "SELECT tbl_tipo_resposta_item.descricao FROM tbl_tipo_resposta_item where tipo_resposta_item = $resposta";
            $resItens = pg_query($con,$sqlItens);

            if (pg_num_rows($resItens)>0) {

                $txt_resposta = pg_fetch_result($resItens,0,0);

            }else{

                $txt_resposta = $resposta;

            }

        }
        $sql = "INSERT INTO tbl_resposta (
                    pergunta,
                    hd_chamado,
                    txt_resposta,
                    tipo_resposta_item,
                    pesquisa,
                    admin,
                    data_input
                )VALUES(
                    $pergunta,
                    $hdChamado,
                    '$txt_resposta',
                    $resposta,
                    '$pesquisa',
                    $login_admin,
                    current_timestamp
                )
                ";
        $res = pg_query($con,$sql);

        if (pg_last_error($con)){
            $erro[] = pg_last_error($con) ;
        }

    }
    if (count($erro)>0){
        $erro = implode('<br>ttt', $erro);
        if(strpos($erro, 'syntax erro') > 0 ){
            $erro = "Favor preencher todas as respostas da pesquisa";
        }
        $res = pg_query($con,'ROLLBACK TRANSACTION');
    }else{
        $res = pg_query($con,'COMMIT TRANSACTION');
    }

    if ($erro){
        echo "1|$erro";
    }else{
        echo "0|Sucesso";
    }

    exit;

} // FIM HD 895693

if ($_GET['ajax'] && $_GET['combo_motivo']){
    $tipo = $_GET['tipo'];
    $motivo = $_GET['motivo'];

    if($tipo == 'R'){
        $categoria = 'Revenda';
    }else if($tipo == 'P'){
        $categoria = 'Posto Autorizado';
    }else if($tipo == 'T'){
        $categoria = 'Representante';
    }
    $sql = "SELECT hd_motivo_ligacao,descricao FROM tbl_hd_motivo_ligacao WHERE fabrica = $login_fabrica AND categoria = '$categoria' ORDER BY descricao";
    $res = pg_query($con,$sql);
    $options .="<option value=''>Escolha</option>";
    if(pg_num_rows($res) > 0){
        for($i = 0; $i < pg_num_rows($res); $i++){

            $hd_motivo_ligacao  = pg_fetch_result($res,$i,'hd_motivo_ligacao');
            $descricao          = pg_fetch_result($res,$i,'descricao');

            $selected = ($hd_motivo_ligacao == $motivo) ? "SELECTED" : "";

            $options .= "<option value='{$hd_motivo_ligacao}' {$selected}>{$descricao}</option>";
        }
    }else{
        $options = "<option value=''></option>";
    }

    echo $options;
    exit;

}

// !129655
// HD 129655 - Gravar faq para dÃºvida de produtos
/**
 * Insere as dÃºvidas do produto pesquisadas.
 *
 * @return boolean Se true a função gravou as DÃºvidas
 * @author Augusto Pascutti <augusto.pascutti@telecontrol.com.br>
 */
function gravarFaq() {
    global $con,$hd_chamado,$msg_erro;

    if ( empty($hd_chamado) || $hd_chamado <= 0 ) {
        $msg_erro .= "<p>Não foi possÃ­vel gravar dÃºvidas do produto, número do chamado não informado. $hd_chamado</p>";
        return false;
    }

    if ( isset($_POST['faq']) && count($_POST['faq']) > 0 && is_array($_POST['faq']) ) {
        $aFaqs = array();

        foreach ( $_POST['faq'] as $xfaq ) {
            $xfaqs = explode("-", $xfaq);
            $xfaq = (int) $xfaqs[0];
            $xfaq_solucao = $xfaqs[1];
            $aFaqs[] = "({$hd_chamado},{$xfaq},{$xfaq_solucao})";
        }
        @pg_query($con,"DELETE FROM tbl_hd_chamado_faq WHERE hd_chamado = {$hd_chamado}");
        $sql = "INSERT INTO tbl_hd_chamado_faq (hd_chamado,faq, faq_solucao) VALUES " . implode(',',$aFaqs);
        $res = @pg_query($con,$sql);
        if ( is_resource($res) && pg_affected_rows($res) > 0 ) {
            return true;
        }
        $msg_erro .= "<p>Erro ao inserir as dÃºvidas.</p>";
        return false;
    }
}

if($novaTelaOs == true){
    function gravarNovoFaq() {
        global $con,$hd_chamado,$msg_erro;

        if ( empty($hd_chamado) || strlen($hd_chamado) == 0) {
            $msg_erro .= "<p>Não foi possÃ­vel gravar dÃºvidas do produto, número do chamado não informado. $hd_chamado</p>";
            return false;
        }

        pg_query($con,"DELETE FROM tbl_hd_chamado_faq WHERE hd_chamado = {$hd_chamado}");

        if(pg_last_error() > 0){
            $msg_erro .="<p>Erro ao inserir as dÃºvidas.</p>";
            return false;
        }

        foreach ($_POST as $key => $value ) {
            if (preg_match("/^faq_causa_/", $key)) {
                list($faq, $faq_solucao) = explode("|",$value);
                $sql = "INSERT INTO tbl_hd_chamado_faq (hd_chamado,faq, faq_solucao) VALUES ($hd_chamado, $faq, $faq_solucao)";
                pg_query($con,$sql);

                if ( pg_last_error() > 0 ) {
                    $msg_erro .= "<p>Erro ao inserir as dÃºvidas.</p>";
                    return false;
                }
            }
        }

        return true;
    }
}
// fim HD 129655

# Pesquisa pelo AutoComplete AJAX
$q = strtolower($_GET["q"]);
if (isset($_GET["q"])){
    $busca      = $_GET["busca"];
    $tipo_busca = $_GET["tipo_busca"];

    if($login_fabrica == 189){
        $tipoCliente = mb_strtolower($_GET["tipoCliente"]);
        if(strlen($tipoCliente)>0){
            $condTipo_cliente = " and parametros_adicionais::JSON->>'tipo_cliente' = '$tipoCliente' ";
        }
    }

    if (in_array($login_fabrica, array(169,170))) {
        $instalador = $_GET["instalador"];
    }

    if (strlen($q)>2){

        //HD 204082: Busca de revenda para fabricas >= 81 e Telecontrol Net
        if ($tipo_busca=="revenda"){

            $sql = "SELECT tbl_revenda.revenda, tbl_revenda.cnpj, tbl_revenda.nome
                    FROM tbl_revenda
                    JOIN tbl_revenda_compra USING(revenda)
                    WHERE tbl_revenda_compra.fabrica = $login_fabrica ";

            if ($busca == "codigo"){
                $sql .= " AND tbl_revenda.cnpj like '%$q%' ";
            }else{
                $sql .= " AND UPPER(tbl_revenda.nome) ilike UPPER('%$q%') ";
            }

            $res = pg_query($con,$sql);
            if (pg_num_rows ($res) > 0) {
                for ($i=0; $i<pg_num_rows ($res); $i++ ){
                    $revenda = trim(pg_fetch_result($res,$i,revenda));
                    $cnpj    = trim(pg_fetch_result($res,$i,cnpj));
                    $nome    = trim(pg_fetch_result($res,$i,nome));
                    echo "$revenda|$cnpj|$nome";
                    echo "\n";
                }
            }
        }

        if ($tipo_busca=="revenda_geral"){

            if($login_fabrica == 15) {
                $cond_join = " JOIN tbl_revenda_fabrica ON tbl_revenda.revenda=tbl_revenda_fabrica.revenda and tbl_revenda_fabrica.fabrica = $login_fabrica ";
            }

            $cond_campo = ($login_fabrica == 15) ? " tbl_revenda_fabrica.contato_razao_social as nome" : " tbl_revenda.nome";
            $sql = "SELECT  tbl_revenda.revenda,
                            tbl_revenda.cnpj,
                            tbl_cidade.nome AS cidade_nome,
                            $cond_campo";
            if($login_fabrica == 74){
                $sql .= ", tbl_revenda.fone ";
            }
            $sql .=" FROM tbl_revenda
                    LEFT JOIN tbl_cidade ON tbl_revenda.cidade = tbl_cidade.cidade
                    $cond_join
                    WHERE cnpj_validado
                    ";

            if ($busca == "codigo"){
                $sql .= " AND tbl_revenda.cnpj like '%$q%' ";
            }else{
                $sql .= " AND (tbl_revenda.nome ilike '%$q%' ";
                $sql .= " OR tbl_cidade.nome ilike '%$q%' ";
                $sql .= " OR tbl_revenda.nome || ' - ' || tbl_cidade.nome ilike '%$q%') ";
            }

            $usa_rev_fabrica = in_array($login_fabrica, array(184,191,200));

            if ($usa_rev_fabrica) {
                if ($busca == "codigo"){
                    $whereAdc = " AND tbl_revenda_fabrica.cnpj  ~* '^$q'";
                }else{
                    $whereAdc = " AND tbl_revenda_fabrica.contato_razao_social ~* '$q'";
                }
                $sql = "SELECT
                            tbl_revenda_fabrica.revenda,
                            tbl_revenda_fabrica.contato_razao_social AS nome,
                            tbl_revenda_fabrica.cnpj                ,
                            tbl_cidade.estado                       ,
                            tbl_cidade.nome AS cidade_nome           ,
                            tbl_cidade.cidade AS cidade             ,
                            tbl_revenda_fabrica.contato_fone AS fone
                    FROM tbl_revenda_fabrica
                    LEFT JOIN tbl_cidade ON tbl_cidade.cidade = tbl_revenda_fabrica.cidade
                    $whereAdc
                    AND tbl_revenda_fabrica.fabrica = $login_fabrica
                    ORDER BY tbl_cidade.estado, tbl_cidade.cidade, contato_razao_social";
            }

            $sql .= " LIMIT 10 ";

            $res = pg_query($con,$sql);
            if (pg_num_rows ($res) > 0) {
                for ($i=0; $i<pg_num_rows ($res); $i++ ){
                    $revenda = trim(pg_fetch_result($res,$i,revenda));
                    $cnpj    = trim(pg_fetch_result($res,$i,cnpj));
                    $nome    = trim(pg_fetch_result($res,$i,nome));
                    $cidade_nome = trim(pg_fetch_result($res,$i,cidade_nome));
                    if($login_fabrica == 74){
                        $fone_revenda = trim(pg_fetch_result($res,$i,fone));
                        echo "$revenda|$cnpj|$nome|$cidade_nome|$fone_revenda";
                    }else{
                        echo "$revenda|$cnpj|$nome|$cidade_nome";
                    }
                    echo "\n";
                }
            }
        }

        if ($tipo_busca=="revenda_os"){
            $sql = "SELECT tbl_revenda.revenda, tbl_revenda.cnpj, tbl_revenda.nome
                    FROM tbl_revenda
                    JOIN tbl_revenda_compra USING(revenda)
                    WHERE UPPER(tbl_revenda.nome) ilike UPPER('%$q%') ";

            $res = pg_query($con,$sql);
            if (pg_num_rows ($res) > 0) {
                for ($i=0; $i<pg_num_rows ($res); $i++ ){
                    $revenda = trim(pg_fetch_result($res,$i,revenda));
                    $cnpj    = trim(pg_fetch_result($res,$i,cnpj));
                    $nome    = trim(pg_fetch_result($res,$i,nome));
                    echo "$revenda|$cnpj|$nome";
                    echo "\n";
                }
            }
        }

        if ($tipo_busca=="posto"){

            $sql_fones_adicionail = "";
            if($login_fabrica == 30){
                $sql_fone_adicional = ',tbl_posto_fabrica.contato_fone_residencial AS telefone2
                                       ,tbl_posto_fabrica.contato_cel AS telefone3
                                       ,(SELECT tbl_tipo_posto.descricao FROM tbl_tipo_posto WHERE tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto) AS tipo_posto';
            }

            if(in_array($login_fabrica,array(30,74,156))){
                $campos_elgin .= ", tbl_posto_fabrica.contato_endereco,";
                $campos_elgin .= "tbl_posto_fabrica.contato_numero,";
                $campos_elgin .= "tbl_posto_fabrica.contato_bairro,";
                $campos_elgin .= "tbl_posto_fabrica.contato_cidade,";
              $campos_elgin .= "tbl_posto_fabrica.contato_estado,";
              $campos_elgin .= "tbl_posto_fabrica.obs";
            }

            if ($login_fabrica == 162) {
                $campos_posto_interno   = ",\ntbl_fabrica.posto_fabrica AS posto_interno";
                $join_posto_interno     = " LEFT JOIN tbl_fabrica ON tbl_fabrica.posto_fabrica = tbl_posto.posto";
            }

                $wherePosto = "AND tbl_posto_fabrica.credenciamento IN ('CREDENCIADO', 'EM DESCREDENCIAMENTO')";

            if($login_fabrica == 42){
                $wherePostoPatam = " and tbl_posto_fabrica.tipo_posto = 236 ";
            }

            if($login_fabrica == 189){
                $join_tipo_posto = " join tbl_tipo_posto on tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto  ";
                $campo_tipo_posto = "tbl_tipo_posto.descricao as descricao_tipo_posto,  ";
            }

            $sql = "SELECT tbl_posto.posto,
                    tbl_posto.cnpj,
                    tbl_posto.nome,
                    tbl_posto_fabrica.credenciamento,
                    tbl_posto_fabrica.codigo_posto,
                    tbl_posto_fabrica.nome_fantasia,
                    $campo_tipo_posto
                    case when contato_telefones[1] notnull then contato_telefones[1] else tbl_posto.fone end as fone,
                    tbl_posto_fabrica.contato_fone_comercial as contato_fone_comercial,
                    tbl_posto_fabrica.contato_email as contato_email,
                    tbl_posto_fabrica.contato_email as email
                    $campos_elgin
                    $sql_fone_adicional
                    $campos_posto_interno
                    FROM tbl_posto
                    $join_posto_interno
                    $join_tipo_posto
                    JOIN tbl_posto_fabrica ON tbl_posto_fabrica.posto = tbl_posto.posto
                    WHERE tbl_posto_fabrica.fabrica = $login_fabrica
                    {$wherePosto}
                    {$condTipo_cliente}
                    {$wherePostoPatam}";

            if ($busca == "codigo"){
                    $sql .= " AND tbl_posto_fabrica.codigo_posto ilike '%$q%' ";
            }else{
                $sql .= "  AND (
                                UPPER(tbl_posto.nome) like UPPER('%$q%')
                            OR  UPPER(tbl_posto_fabrica.nome_fantasia) like UPPER('%$q%')
                                )";
            }
            #echo nl2br( $sql );
            $res = pg_query($con,$sql);

            if (pg_num_rows ($res) > 0) {
                for ($i=0; $i<pg_num_rows ($res); $i++ ){
                    $posto         = trim(pg_fetch_result($res,$i,posto));
                    $cnpj          = trim(pg_fetch_result($res,$i,cnpj));
                    $nome          = trim(pg_fetch_result($res,$i,nome));
                    $codigo_posto  = trim(pg_fetch_result($res,$i,codigo_posto));
                    $nome_fantasia = trim(pg_fetch_result($res,$i,nome_fantasia));
                    $credenciamento = pg_fetch_result($res,$i,"credenciamento");
                    $descricao_tipo_posto = pg_fetch_result($res, $i, 'descricao_tipo_posto');

                    if(in_array($login_fabrica,array(30,74,156))){
                        $contato_endereco = trim(pg_fetch_result($res,$i,contato_endereco));
                        $contato_numero = trim(pg_fetch_result($res,$i,contato_numero));
                        $contato_bairro = trim(pg_fetch_result($res,$i,contato_bairro));
                        $contato_cidade = trim(pg_fetch_result($res,$i,contato_cidade));
                        $contato_estado = trim(pg_fetch_result($res,$i,contato_estado));
                        $obs_posto      = trim(pg_fetch_result($res,$i,obs));
                    }

                    $fone = trim(pg_fetch_result($res,$i,fone));
                    $fone_2 = trim(pg_fetch_result($res,$i,contato_fone_comercial));
                    if($login_fabrica == 30){
                        $telefone2 = trim(pg_fetch_result($res,$i,telefone2));
                        $telefone3 = trim(pg_fetch_result($res,$i,telefone3));
                        $tipo_posto = trim(pg_fetch_result($res,$i,tipo_posto));
                    }

                    $email  = trim(pg_fetch_result($res,$i,email));
                    $email_2 = trim(pg_fetch_result($res,$i,contato_email));

                    if ($login_fabrica == 162) {
                        $posto_interno_ac = pg_fetch_result($res,$i,posto_interno);
                    }

                    if(strlen($fone_2) > 0){
                        echo "$posto|$cnpj|$codigo_posto|$nome|$nome_fantasia|$fone_2|$email_2|$contato_endereco|$contato_numero|$contato_bairro|$contato_cidade|$contato_estado";
                    }else{
                        echo "$posto|$cnpj|$codigo_posto|$nome|$nome_fantasia|$fone|$email_2|$contato_endereco|$contato_numero|$contato_bairro|$contato_cidade|$contato_estado";
                    }
                    if($login_fabrica == 30){
                        echo "|".$telefone2."|".$telefone3."|".$tipo_posto;
                    }
                    if ($login_fabrica == 162) {
                        echo "|".$posto_interno_ac;
                    }
                    echo "|".$credenciamento;

                    if($login_fabrica == 30){
                        echo "|".$obs_posto;
                    }

                    if($login_fabrica == 189){
                        echo "|". $descricao_tipo_posto;
                    }

                    echo "\n";
                }
            }
        }

        if ($tipo_busca=="mapa_cidade"){

            $sql = "SELECT      DISTINCT tbl_posto.cidade
                    FROM        tbl_posto_fabrica
                    JOIN tbl_posto using(posto)
                    WHERE       tbl_posto_fabrica.fabrica = $login_fabrica
                    AND         tbl_posto.cidade ILIKE UPPER('%$q%')
                    ORDER BY    tbl_posto.cidade";

            $res = pg_query($con,$sql);
            if (pg_num_rows ($res) > 0) {
                for ($i=0; $i<pg_num_rows ($res); $i++ ){
                    $mapa_cidade        = trim(pg_fetch_result($res,$i,cidade));
                    echo "$mapa_cidade";
                    echo "\n";
                }
            }
        }
    }

    if ($tipo_busca=="cliente_admin"){
            $y = trim(strtoupper($q));
            $palavras = explode(' ',$y);
            $count = count($palavras);
            $sql_and = "";
            for($i=0 ; $i < $count ; $i++){
                if(strlen(trim($palavras[$i]))>0){
                    $cnpj_pesquisa = trim($palavras[$i]);
                    $cnpj_pesquisa = str_replace (' ','',$cnpj_pesquisa);
                    $cnpj_pesquisa = str_replace ('-','',$cnpj_pesquisa);
                    $cnpj_pesquisa = str_replace ('\'','',$cnpj_pesquisa);
                    $cnpj_pesquisa = str_replace ('.','',$cnpj_pesquisa);
                    $cnpj_pesquisa = str_replace ('/','',$cnpj_pesquisa);
                    $cnpj_pesquisa = str_replace ('\\','',$cnpj_pesquisa);
                    $sql_and .= " AND (tbl_cliente_admin.nome ILIKE '%".trim($palavras[$i])."%'
                                      OR  tbl_cliente_admin.cnpj ILIKE '%$cnpj_pesquisa%' OR tbl_cliente_admin.cidade ILIKE '%".trim($palavras[$i])."%')";
                    if (strlen($cidade) > 0) {
                        $sql_and .= " AND tbl_cliente_admin.cidade ILIKE '%".trim($cidade)."%'";
                    }
                }
            }

            $sql = "SELECT      tbl_cliente_admin.cliente_admin,
                                tbl_cliente_admin.nome,
                                tbl_cliente_admin.codigo,
                                tbl_cliente_admin.cnpj,
                                tbl_cliente_admin.abre_os_admin,
                                tbl_cliente_admin.cidade
                    FROM        tbl_cliente_admin
                    WHERE       tbl_cliente_admin.fabrica = $login_fabrica
                    $sql_and
                    LIMIT 30";
            $res = pg_query($con,$sql);
            if (pg_num_rows ($res) > 0) {
                for ($i=0; $i<pg_num_rows ($res); $i++ ){
                    $cliente_admin      = trim(pg_fetch_result($res,$i,cliente_admin));
                    $nome               = trim(pg_fetch_result($res,$i,nome));
                    $codigo             = trim(pg_fetch_result($res,$i,codigo));
                    $cnpj               = trim(pg_fetch_result($res,$i,cnpj));
                    $cidade             = trim(pg_fetch_result($res,$i,cidade));
                    $abre_os_admin      = trim(pg_fetch_result($res,$i,abre_os_admin));

                    echo "$cliente_admin|$cnpj|$codigo|$nome|$cidade|$abre_os_admin";
                    echo "\n";
                }
            }
        }

        if ($tipo_busca == "localizar") {

                $y = trim (strtoupper ($q));
                $palavras = explode(' ',$y);
                $count = count($palavras);
                $sql_and = "";

                for ($i = 0 ; $i < $count; $i++) {

                    if (strlen(trim($palavras[$i])) > 0) {

                        $cnpj_pesquisa = trim($palavras[$i]);
                        $cnpj_pesquisa = str_replace(' ','',$cnpj_pesquisa);
                        $cnpj_pesquisa = str_replace('-','',$cnpj_pesquisa);
                        $cnpj_pesquisa = str_replace('\'','',$cnpj_pesquisa);
                        $cnpj_pesquisa = str_replace('.','',$cnpj_pesquisa);
                        $cnpj_pesquisa = str_replace('/','',$cnpj_pesquisa);
                        $cnpj_pesquisa = str_replace('\\','',$cnpj_pesquisa);

                        $sql_and .= " AND (tbl_hd_chamado_extra.nome ILIKE '%".trim($palavras[$i])."%'
                                          OR  tbl_hd_chamado_extra.cpf ILIKE '%".trim($palavras[$i])."%' OR tbl_hd_chamado_extra.fone ILIKE '%".trim($palavras[$i])."%' OR tbl_hd_chamado_extra.nota_fiscal ILIKE '%".trim($palavras[$i])."%' OR tbl_hd_chamado_extra.serie ILIKE '%".trim($palavras[$i])."%' OR tbl_os.sua_os ILIKE'%".trim($palavras[$i])."%' OR tbl_hd_chamado_extra.cep ILIKE '%".$cnpj_pesquisa."%')";
                    }
                }

                $sql = "SELECT      tbl_hd_chamado.hd_chamado,
                                    tbl_hd_chamado_extra.serie,
                                    tbl_hd_chamado_extra.nota_fiscal,
                                    tbl_hd_chamado_extra.nome,
                                    tbl_hd_chamado_extra.cpf,
                                    tbl_hd_chamado_extra.rg,
                                    tbl_hd_chamado_extra.endereco,
                                    tbl_hd_chamado_extra.email,
                                    tbl_hd_chamado_extra.numero,
                                    tbl_hd_chamado_extra.complemento,
                                    tbl_hd_chamado_extra.bairro,
                                    tbl_cidade.nome as nome_cidade,
                                    tbl_cidade.estado,
                                    tbl_os.sua_os,
                                    tbl_hd_chamado_extra.cep,
                                    tbl_hd_chamado_extra.fone,
                        FROM        tbl_hd_chamado JOIN tbl_hd_chamado_extra using(hd_chamado)
                        LEFT JOIN tbl_os USING(os)
                        LEFT JOIN tbl_cidade USING (cidade)
                        WHERE       tbl_hd_chamado.fabrica = $login_fabrica
                        $sql_and limit 30";

                $res = pg_query($con,$sql);
                if (pg_num_rows ($res) > 0) {
                    for ($i=0; $i<pg_num_rows ($res); $i++ ){
                        $hd_chamado        = trim(pg_fetch_result($res,$i,hd_chamado));
                        $nome              = trim(pg_fetch_result($res,$i,nome));
                        $serie             = trim(pg_fetch_result($res,$i,serie));
                        $cpf               = trim(pg_fetch_result($res,$i,cpf));
                        $rg               = trim(pg_fetch_result($res,$i,rg));
                        $email               = trim(pg_fetch_result($res,$i,email));
                        $nota_fiscal       = trim(pg_fetch_result($res,$i,nota_fiscal));
                        $fone              = trim(pg_fetch_result($res,$i,fone));
                        $endereco          = trim(pg_fetch_result($res,$i,endereco));
                        $numero            = trim(pg_fetch_result($res,$i,numero));
                        $complemento       = trim(pg_fetch_result($res,$i,complemento));
                        $cep               = trim(pg_fetch_result($res,$i,cep));
                        $sua_os            = trim(pg_fetch_result($res,$i,sua_os));
                        $bairro            = trim(pg_fetch_result($res,$i,bairro));
                        $cidade            = trim(pg_fetch_result($res,$i,nome_cidade));
                        $estado            = trim(pg_fetch_result($res,$i,estado));

                        echo "$hd_chamado|$cpf|$nome|$serie|$nota_fiscal|$fone|$sua_os|$cep|$endereco|$numero|$bairro|$complemento|$cidade|$estado|$rg|$email";
                        echo "\n";
                    }
                }
        }

    exit;
}

$title = "Atendimento Call-Center";
$layout_menu = 'callcenter';

function converte_data($date)
{
    $date = explode("-", preg_replace('/\//', '-', $date));
    $date2 = ''.$date[2].'-'.$date[1].'-'.$date[0];
    if (sizeof($date)==3)
        return $date2;
    else return false;
}

function acentos1( $texto ){
    $array1 = array("", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "" , "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "","","" );
    $array2 = array("", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "" ,"", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "","","");
    return str_replace( $array1, $array2, $texto );
}

function acentos3( $texto ){
 $array1 = array("", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "" , "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "","","" );
 $array2 = array("A", "A", "A", "A", "A", "E", "E", "E", "E", "I", "I", "I", "I", "O", "O", "O", "O", "O", "U", "U", "U", "U", "C" , "A", "A", "A", "A", "A", "E", "E", "E", "E", "I", "I", "I", "I", "O", "O", "O", "O", "O", "U", "U", "U", "U", "C","N","N" );
 return str_replace( $array1, $array2, $texto );
}

if (!function_exists('date_to_timestamp')) {
    function date_to_timestamp($fecha='hoje') { // $fecha formato YYYY-MM-DD H24:MI:SS ou DD-MM-YYYY H24:MI:SS
        if ($fecha=="hoje") $fecha= date('Y-m-d H:i:s');
        list($date, $time)        = explode(' ', $fecha);
        list($year, $month, $day) = preg_split('/[\/|\.|-]/', $date);
        if (strlen($year)==2 and strlen($day)==4) list($day,$year) = array($year,$day); // Troca a ordem de dia e ano, se precisar
        if ($time=="") $time = "00:00:00";
        list($hour, $minute, $second) = explode(':', $time);
        return mktime((int) $hour, (int) $minute, (int) $second, (int) $month, (int) $day, (int) $year);
    }
}

function valida_login_fabrica($hd_chamado = "") {
    global $con,$login_fabrica;
    $msg_login = "";

    $sql_fabrica_hd = "SELECT fabrica FROM tbl_hd_chamado WHERE hd_chamado = $hd_chamado AND fabrica IN (11,172)";
    $res_fabrica_hd = pg_query($con, $sql_fabrica_hd);
    if ($login_fabrica != pg_fetch_result($res_fabrica_hd, 0, 'fabrica')) {
        $msg_login = "Usuário Não Está Logado Na Fábrica Do Chamado.<br>";
    }
    return $msg_login;
}

if (!function_exists('checaCPF')) {
    function checaCPF  ($cpf,$return_str = true, $use_savepoint = false){
       global $con, $login_fabrica; // Para conectar com o banco...
            $cpf = preg_replace("/\D/","",$cpf);   // Limpa o CPF
    //  23/12/2009 HD 186382 - a função pula as pré-OS anteriores Ã  hoje...
            if ((($login_fabrica==52  and strlen($_REQUEST['pre_os'])>0) or
                $login_fabrica==11 or $login_fabrica == 172) and
                date_to_timestamp($_REQUEST['data_abertura'])<date_to_timestamp('24/12/2009')) return $cpf;
            if (!$cpf or $cpf == '' or (strlen($cpf) != 11 and strlen($cpf) != 14)) return false;

            if(strlen($cpf) > 0){
                $res_cpf = @pg_query($con,"SELECT fn_valida_cnpj_cpf('$cpf')");
                if ($res_cpf === false) {
                    $cpf_erro = pg_last_error($con);
                    return ($return_str) ? $cpf_erro : false;
                }
            }
            return $cpf;

    }
}
include_once '../helpdesk/mlg_funciones.php';

$indicacao_posto = $_GET['indicacao_posto'];

if (strlen($indicacao_posto) == 0) {
    $relatorio_completo_callcenter = $_POST['indicacao_posto'];
}

if (strlen($indicacao_posto) == 0) {
    $indicacao_posto = 'f';
}

$atendimento_callcenter = (strlen($_GET['atendimento_callcenter']) > 0) ? trim($_GET['atendimento_callcenter']) : trim($_POST['atendimento_callcenter']);

$btn_acao = $_POST['btn_acao'];

$data_consertado = '';

if (strlen($btn_acao) > 0) {
    
    $callcenter         = $_POST['callcenter'];
    $hd_chamado         = $callcenter;
    $tab_atual          = $_POST['tab_atual'];
    $status_interacao   = $_POST['status_interacao'];
    $transferir         = $_POST['transferir'];
    $intervensor        = $_POST['intervensor'];
    $chamado_interno    = $_POST['chamado_interno'];
    $envia_email        = $_POST['envia_email'];
    $marca              = $_POST['marca'];
    $integracaoSocial   = false;

    $motivo_contato_callcenter = $_POST['motivo_contato_callcenter'];
    $mostra_providencia_nivel3 = $_POST['mostra_providencia_nivel3'];

    if (strlen($callcenter) > 0) {
        $iOrigemCodigo = $_POST['origem'];

		if(is_int($iOrigemCodigo)) {
			$qOrigem = "SELECT
				thco.descricao
			FROM tbl_hd_chamado_origem thco
			WHERE thco.hd_chamado_origem = $1";

			$iResOrigem = pg_query_params($con, $qOrigem, [$iOrigemCodigo]);
			$iOrigem = pg_fetch_result($iResOrigem, 0, 'descricao');
		}
        if (
            ($atendimentoML || $atendimentoFacebook || $atendimentoIG) &&
            (preg_match("/mercado livre|facebook|instagram/", strtolower($iOrigem)))
        ) {
            $integracaoSocial = true;
        }
    }

    if ($login_fabrica == 30 and isset($_POST['codigo_posto_tab'])) {
        $codigo_logomarca = $_POST['logomarca'];
        $codigoPosto = $_POST['codigo_posto_tab'];

        $sqlCredenciamento = "SELECT posto , codigo_posto, credenciamento
                              FROM tbl_posto_fabrica
                              WHERE codigo_posto = '$codigoPosto'
                              AND fabrica = $login_fabrica";

        $resCredenciamento = pg_query($con, $sqlCredenciamento);

        $statusCredenciamento = pg_fetch_result($resCredenciamento, 0, credenciamento);

        if ($statusCredenciamento != "CREDENCIADO") {

            $msg_erro .= " Posto autorizado selecionado está Â¿Em DescredenciamentoÂ¿ ou Â¿DescredenciadoÂ¿.<br>";
        }
    }

    if ($controle_distrib_telecontrol && strlen(trim($callcenter)) > 0 && is_numeric($callcenter)) {
        $msg_erro = valida_login_fabrica($callcenter);
    }

    if ($atendimentoML == true) {
        $envia_melibre      = $_POST['envia_melibre'];
        $melibre_attachment = $_FILES['melibre_attachment'];
    }

    if (in_array($login_fabrica, [166,174,186])) {
        $tipo_venda         = $_POST['tipo_venda'];
    }

    if($login_fabrica == 189){
        $prioridade                 = $_POST["prioridade"];
        $analise_reclamacao         = $_POST["analise_reclamacao"];
        $tipo_cliente               = $_POST["tipo_cliente"];
        $tipo_posto                 = $_POST["tipo_posto"];
        $nome_representante         = $_POST["nome_representante"];
        $celular_representante      = $_POST["celular_representante"];
        $nome_empresa               = $_POST["nome_empresa"];
        $codigo_cliente_revenda               = $_POST["codigo_cliente_revenda"];
        $manual_nome_repre            = $_POST["manual_nome_repre"];
        $manual_email_repre            = $_POST["manual_email_repre"];
        $manual_cod_transp            = $_POST["manual_cod_transp"];
        $manual_nome_transp            = $_POST["manual_nome_transp"];
        $manual_contato_transp            = $_POST["manual_contato_transp"];
        $manual_fone_transp            = $_POST["manual_fone_transp"];
        $manual_end_transp            = $_POST["manual_end_transp"];
        $manual_cod_transp_redespacho            = $_POST["manual_cod_transp_redespacho"];
        $manual_nome_transp_redespacho            = $_POST["manual_nome_transp_redespacho"];
        $manual_contato_transp_redespacho            = $_POST["manual_contato_transp_redespacho"];
        $manual_fone_transp_redespacho            = $_POST["manual_fone_transp_redespacho"];
        $manual_end_transp_redespacho            = $_POST["manual_end_transp_redespacho"];

        $mercado_gerencia               = $_POST["mercado_gerencia"];
        $planta               = $_POST["planta"];
        $envia_email_representante  = $_POST["envia_email_representante"];
        $email_representante        = $_POST["email_representante"];
        $cte_1                  = $_POST["cte_1"];
        $cte_2                  = $_POST["cte_2"];
        $n_ordem_entrada_1      = $_POST["n_ordem_entrada_1"];
        $n_ordem_entrada_2      = $_POST["n_ordem_entrada_2"];
        $n_remessa_1            = $_POST["n_remessa_1"];
        $n_remessa_2            = $_POST["n_remessa_2"];
        $n_nf_entrada_1         = $_POST["n_nf_entrada_1"];
        $n_nf_entrada_2         = $_POST["n_nf_entrada_2"];
    }

    if($login_fabrica == 35){
        $nota_fiscal = $_POST['nota_fiscal'];
        if(strlen($nota_fiscal) == 0){
            $msg_erro .= " Informe a NF de Compra.<br>";
        }
    }

    if ($login_fabrica == 24) {
        $tbl_atual = $_POST['tab_atual'];
        if (empty($_POST['callcenter_assunto'][$tbl_atual])) {
            $msg_erro .= "Informe um assunto<br>";
        }
    }

    if($login_fabrica == 81){
        $solucao = $_POST["solucao"];
        if(empty($solucao)) {
            $msg_erro .= "Informe a solução<br>";
        }
    }

    if ($login_fabrica == 151) {
        $abre_os_mondial        = $_POST['abre_os_mondial'];
        if($abre_os_mondial == 't' && (strlen(trim($_POST["posto_nome_tab"])) == 0 OR strlen(trim($_POST["codigo_posto_tab"])) == 0)){
            $msg_erro .= "Informe os dados do Posto Autorizado <br/>";
        }
    }
    if ($login_fabrica == 165) {
        $mapa_estado_tec        = $_POST['mapa_estado'];
        $mapa_cidade_tec        = $_POST['mapa_cidade'];

        if ($mapa_estado_tec == "00") {
            $msg_erro .= "Informe o estado em mapa da rede <br>";
        }

        if (empty($mapa_cidade_tec)) {
            $msg_erro .= "Informe a cidade em mapa da rede <br>";
        }
    }

    if ($login_fabrica == 189) {
        if(strlen(trim($_POST['reclamado_produto'])) == 0){
            $msg_erro .= "Informe a Descrição do Atendimento <br/>";
        }
        if(strlen(trim($_POST['consumidor_revenda'])) == 0){
            $msg_erro .= "Informe a Tipo <br/>";
        }
        if(strlen(trim($_POST['origem'])) == 0){
            $msg_erro .= "Informe  Depto. Gerador da RRC <br/>";
        }
        if(strlen(trim($_POST['hd_subclassificacao'])) == 0){
            $msg_erro .= "Informe Especificação de Referência de Registro <br/>";
        }

        if (!in_array(trim($_POST['origem']), $array_trava_origem) && (strlen(trim($_POST['manual_cod_transp'])) == 0 || strlen(trim($_POST['manual_nome_transp'])) == 0)) {
            $msg_erro .= "Informe Cód. Transp. e ou Nome Transp.  <br/>";
        }

        $consumidor_cnpj_valida = $_POST["consumidor_cpf_cnpj"];
        $cnpj_valida            = preg_replace("/\D/","",$_POST['consumidor_cpf']);

        if ($consumidor_cnpj_valida == "R" && strlen(trim($cnpj_valida)) == 0) {
            $msg_erro .= "Informe o CNPJ do consumidor.  <br/>";
        }
    }

    if($login_fabrica == 74){
        $referencia = $_POST['produto_referencia'];

        if(strlen(trim($referencia))>0){
            $sql_linha = "select numero_serie_obrigatorio
                            from
                        tbl_produto
                        where tbl_produto.referencia = '$referencia'
                        and tbl_produto.fabrica_i = $login_fabrica  ";
            $res_linha = pg_query($con, $sql_linha);

            if(pg_num_rows($res_linha)> 0){
                $numero_serie_obrigatorio = pg_fetch_result($res_linha, 0, 'numero_serie_obrigatorio');
            }

            if(strlen(trim($serie))== 0 AND $numero_serie_obrigatorio == 't'){
                $msg_erro = "Por favor informa o número de série do produto. <br>";
            }
        }
    }

    if($login_fabrica == 160 or $replica_einhell){
        $versao             = $_POST["versao"];
        $numero_processo    = $_POST["numero_processo"];
        $data_conciliacao   = $_POST["data_conciliacao"];
        $data_julgamento    = $_POST["data_julgamento"];
    }

    $hd_chamado_anterior_n = $_POST['hd_chamado_anterior_n'];

    if ($marca <= 0) {
        $marca = 'NULL';
    }

    $filial_id          = ($_POST['encaminha_filial']) ? preg_replace('/\D/', '', $_POST['filial_id']) : 'NULL';
    $data_providencia   = is_date($_POST['data_providencia'], 'EUR', 'ISO') ? : 'NULL';

    if ($pesquisaSatisfacao && in_array($login_fabrica, array(35,157))) {

        if (strlen($callcenter) > 0 && strtoupper($status_interacao) == "RESOLVIDO") {

            $sqlPesquisaSa = "SELECT  hd.hd_chamado
                                FROM tbl_hd_chamado hd
                                JOIN tbl_resposta r ON r.hd_chamado = hd.hd_chamado
                                JOIN tbl_pesquisa_formulario pf ON pf.pesquisa_formulario = r.pesquisa_formulario
                                JOIN tbl_pesquisa p ON p.pesquisa = r.pesquisa
                               WHERE hd.hd_chamado = {$callcenter}
                                 AND p.categoria='callcenter'
                                 AND p.ativo IS TRUE
                                 AND p.fabrica={$login_fabrica}";
            $resPesquisaSa = pg_query($con, $sqlPesquisaSa);

            if (pg_num_rows($resPesquisaSa) == 0) {

                $sqlx = "SELECT tbl_pesquisa.pesquisa, tbl_pesquisa_formulario.pesquisa_formulario
                           FROM tbl_pesquisa
                           JOIN tbl_pesquisa_formulario ON tbl_pesquisa_formulario.pesquisa=tbl_pesquisa.pesquisa  AND tbl_pesquisa_formulario.ativo IS TRUE
                          WHERE tbl_pesquisa.categoria='callcenter'
                            AND tbl_pesquisa.ativo IS TRUE
                            AND tbl_pesquisa.fabrica={$login_fabrica}";
                $resx = pg_query($con, $sqlx);
                if (pg_num_rows($resx) > 0) {
                    $xpesquisa = pg_fetch_result($resx, 0, 'pesquisa');
                    $xpesquisa_formulario = pg_fetch_result($resx, 0, 'pesquisa_formulario');

                    $sqly = " INSERT INTO tbl_resposta (
                                                        pesquisa_formulario,
                                                        hd_chamado,
                                                        pesquisa,
                                                        data_input,
                                                        sem_resposta,
                                                        admin
                                                    ) VALUES (
                                                        $xpesquisa_formulario,
                                                        $callcenter,
                                                        $xpesquisa,
                                                        CURRENT_TIMESTAMP,
                                                        TRUE,
                                                        $login_admin
                                                    )";
                    $resy = pg_query($con, $sqly);
                    if (pg_last_error($con)){
                        $msg_erro .= " Erro na inserção da resposta <br>";
                    }
                }
            }
        }
    }

    if (strlen($callcenter) > 0 && $login_fabrica == 176 && strtoupper($status_interacao) == "RESOLVIDO") {

        $sqlOS = "SELECT tbl_os.os
                     FROM tbl_hd_chamado_extra
                     JOIN tbl_os USING(os)
                    WHERE tbl_hd_chamado_extra.hd_chamado = $callcenter
                      AND tbl_hd_chamado_extra.os IS NOT NULL
                      AND tbl_os.data_fechamento IS NULL
                      AND tbl_os.finalizada IS NULL
                      AND tbl_os.excluida = 'f'";
        $resOs = pg_query($con, $sqlOS);

        if (pg_num_rows($resOs) > 0) {
            $msg_erro .= "Não é possÃ­vel finalizar esse atendimento, pois existe uma OS vinculada que está com status em aberto";
        }
    }
    if ($login_fabrica == 74 and $status_interacao == "RESOLVIDO") {
        $data_consertado = $_POST["data_consertado"];

        $qry = pg_query(
            $con,
            "SELECT tbl_os.data_abertura,
                tbl_os.os
            FROM tbl_hd_chamado_extra
            JOIN tbl_os USING(os)
            JOIN tbl_produto ON tbl_os.produto = tbl_produto.produto
            JOIN tbl_linha USING(linha)
            WHERE tbl_hd_chamado_extra.hd_chamado = $callcenter
            AND LOWER(tbl_linha.nome) = 'fogo'"
        );

        $os_fechar = null;

        if (pg_num_rows($qry) == 1) {
            if (empty($data_consertado)) {
                $msg_erro .= "Preenchimento obrigatório: <strong>Data Consertado</strong>";
            } else {
                $dtdc = DateTime::createFromFormat('d/m/Y', $data_consertado);

                // DateTime aceita uma data inválida passada como parÃ¢metro e a transforma em uma válida
                if ($dtdc->format("d/m/Y") == $data_consertado) {
                    $dtda = new DateTime(pg_fetch_result($qry, 0, 'data_abertura'));

                    if ($dtdc < $dtda) {
                        $msg_erro .= "Data Consertado não pode ser inferior a data de abertura da OS";
                    } else {
                        $data_consertado = $dtdc->format('Y-m-d');
                        $os_fechar = pg_fetch_result($qry, 0, 'os');
                    }
                } else {
                    $msg_erro .= "Data inválida: <strong>Data Consertado</strong>";
                }
            }
        }
    }

    if ($login_fabrica == 24 and !empty($hd_chamado) ) {
        $sql = "SELECT status FROM tbl_hd_chamado WHERE fabrica = $login_fabrica AND hd_chamado = $hd_chamado AND UPPER(status) = 'RESOLVIDO'";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0) {
             $chamado_resolvido_reabertura = true;
             $chamado_resolvido_reabertura_admin = $login_admin;
        } else {
            $chamado_resolvido_reabertura = false;
        }
    }

    if ($login_fabrica == 24) {
        $ligacao_agendada = $_POST["ligacao_agendada"];

        if (strlen($_POST["ligacao_agendada"]) > 0) {
            list($dmsd, $dmsm, $dmsa) = explode("/", $ligacao_agendada);

            if(!checkdate($dmsm, $dmsd, $dmsa)) {
                $msg_erro .= 'Data para ligação agendada inválida';
            } else {
                $aux_ligacao_agendada = "{$dmsa}-{$dmsm}-{$dmsd}";
            }
        }
    }
    if ($login_fabrica == 15) {
        $xdata_retorno = $data_retorno ;
        if (isset($_POST["data_retorno"])){
            $data_retorno = $_POST["data_retorno"];
            if (strlen($_POST["data_retorno"]) > 0) {
                list($dmsd, $dmsm, $dmsa) = explode("/", $data_retorno);

                if(!checkdate($dmsm, $dmsd, $dmsa)) {
                    $msg_erro .= 'Data para ligação agendada inválida';
                } else {
                    $aux_data_retorno = "{$dmsa}-{$dmsm}-{$dmsd}";
                }
            }
        }
        if (($status_interacao == "Retorno") AND(strlen($_POST["data_retorno"])) == 0 ){
            $msg_erro .= " Data Retorno Obrigatório ";
        }

        if ($status_interacao == "Retorno" && $_POST["data_retorno_alterou"] == "t" && strtotime($aux_data_retorno) < strtotime("today")) {
            $msg_erro .= " Data Retorno não pode ser anterior a data atual ";
        }

        if (isset($_POST["data_retorno"])){
            $consumidor_nascimento = $_POST['consumidor_nascimento'];

            if (strlen($consumidor_nascimento) == 0) {
                $consumidor_nascimento_query = "NULL";
            } else {
                $consumidor_nascimento_query = "'".converte_data($consumidor_nascimento)."'";
            }
        }
    }

    if ($login_fabrica == 85) {
        $atendimento_ambev      = $_POST["atendimento_ambev"];
        $atendimento_ambev_nome = utf8_encode($_POST["atendimento_ambev_nome"]);
        $nome_fantasia          = $_POST["nome_fantasia"];
        $consumidor_cpf_cnpj    = $_POST["consumidor_cpf_cnpj"];
        $data_fabricacao_ambev  = $_POST["data_fabricacao_ambev"];
        $data_previsao_ambev    = $_POST['data_previsao_ambev'];
        $atendimento_contratual = $_POST['atendimento_contratual'];

        if ($atendimento_contratual == "t") {
            $codigo_cliente_contratual = $_POST['codigo_cliente_contratual'];
            $nome_cliente_contratual   = $_POST['nome_cliente_contratual'];
            $id_cliente_contratual     = $_POST['id_cliente_contratual'];
            $xid_cliente_contratual    = $id_cliente_contratual;

            if (empty($codigo_cliente_contratual) || empty($nome_cliente_contratual) || empty($id_cliente_contratual)) {
                $msg_erro .= "Informe o cliente para Garantia Contratual<br />";
            }
        } else {
            $xid_cliente_contratual = "null";
        }

        if ($_POST["check_tecnico_esporadico"]) {
            $aux_check_tec_esp = "checked";
        }

        if ($_POST["tecnico_esporadico_id"] != "") {
            $tecnico_esporadico_id = $_POST["tecnico_esporadico_id"];
        }

        if ($_POST["tecnico_esporadico"] != "") {
            $tecnico_esporadico = $_POST["tecnico_esporadico"];
        }

        if ($_POST["codigo_tecnico_esporadico"] != "") {
            $codigo_tecnico_esporadico = $_POST["codigo_tecnico_esporadico"];
        }

        if ($_POST["valor_servico_combinado"] != "") {
            $valor_servico_combinado = $_POST["valor_servico_combinado"];
        }

        if ($_POST["garantia_estendida_check"] != "") {
            $garantia_estendida_ambev  = $_POST["garantia_estendida_check"];
        } else {
            $garantia_estendida_ambev  = "f";
        }

        if ($_POST["garantia_contratual_check"] != "") {
            $garantia_contratual_cliente  = $_POST["garantia_contratual_check"];
        } else {
            $garantia_contratual_cliente  = "f";
        }

        if (!strlen($atendimento_contratual)) {
            $msg_erro .= 'Selecione se o atendimento é garantia contratual ou não <br />';
        }

        if ($login_fabrica == 85) {

            if (empty($data_previsao_ambev)) {

                $msg_erro .= "Por favor inserir a Data de Previsão<br>";
            }

            $dataValidar = explode("/", $data_previsao_ambev);
//            $dataValidar = checkdate($dataValidar[0], $dataValidar[1], $dataValidar[2]);

 //           if (strlen($data_previsao_ambev) > 10 || !$dataValidar) {

   //             $msg_erro .= "Por favor inserir a Data de Previsão válida<br>";
     //       }

        }

        if (!strlen($atendimento_ambev)) {
                $msg_erro .= 'Selecione se é atendimento ambev ou não <br />';
        } else {
            if ($atendimento_ambev == "t") {
                $codigo_ambev            = utf8_encode($_POST["codigo_ambev"]);
                $data_encerramento_ambev = $_POST["data_encerramento_ambev"];
                if(!strlen($atendimento_ambev_nome)){
                    $msg_erro .= "Escreva o nome no atendimento ambev";
                }

                $sql = "SELECT cliente_admin FROM tbl_cliente_admin WHERE fabrica = 85 AND codigo = 'ambev'";
                $res = pg_query($con, $sql);
                if(pg_num_rows($res) > 0 ) {
                    $cliente_admin_ambev = pg_fetch_result($res, 0, "cliente_admin");
                }else{
                    $msg_erro = "Não foi encontrado nenhum cliente admin com código 'ambev', favor cadastrar";
                }
            }
        }
    }

    if (strlen($envia_email) == 0) {
        $xenvia_email = "'f'";
    } else {
        $xenvia_email = "'t'";
    }

    if (in_array($login_fabrica, $fabricas_validam_campos_obrigatorios)) {
        if ($hd_chamado){
            $sql = "SELECT '2012-08-14 00:00:00' > tbl_hd_chamado.data as data
                    FROM tbl_hd_chamado
                    WHERE hd_chamado = $hd_chamado";
            $res = pg_query($con,$sql);
            if (pg_fetch_result($res, 0, 0) == 't') {
                $fabricas_validam_campos_obrigatorios = array();
            }
        }
    }

    if ($login_fabrica == 24) {

        $pedir_produto = false;

        if ($_POST['orientacao_uso'] == 't') {

            $orientacao_uso = 't';

            if ( $_POST['abre_os'] == 't') {

                $msg_erro .= 'Não é possÃ­vel abrir Pré-OS com Orientação ao Consumidor selecionado.';

            }

        } else {

            $orientacao_uso = 'f';

        }

        if ($indicacao_posto == 't') {
            $callcenter_assunto = "produto_local_de_assistencia";
        } else if(isset($_POST['callcenter_assunto'])) {
            $callcenter_assunto = trim($_POST["callcenter_assunto"]["$tab_atual"]);
        }

        if (strlen($callcenter_assunto) == 0) {
            $categoria = $_POST['tab_atual'];
        } else {
            $categoria = $callcenter_assunto;
        }

        foreach ($assuntos as $categoria_assunto => $itens_categoria_assunto) {

            foreach ($itens_categoria_assunto as $label_assunto => $bd_assunto) {
                if ($bd_assunto == $categoria) {
                    $categoria_assunto_seleciona = $categoria_assunto;
                }

            }

        }

        switch ($categoria_assunto_seleciona) {

            case 'PRODUTOS':
                if ($tab_atual == 'reclamacao_produto') {
                    $pedir_produto = true;
                } else {
                    $categoria = '';
                }
            break;

            case 'MANUAL':
                if ($tab_atual == 'reclamacao_produto') {
                    $pedir_produto = true;
                } else {
                    $categoria = '';
                }
            break;

            case 'EMPRESA':
                if ($tab_atual == 'reclamacao_empresa') {
                } else {
                    $categoria = '';
                }
            break;

            case 'ASSISTÃNCIA TÃCNICA':
                if ($tab_atual == 'reclamacao_at') {
                } else {
                    $categoria = '';
                }
            break;

            case 'REVENDA':
                if ($tab_atual == 'onde_comprar') {
                } else {
                    $categoria = '';
                }
            break;

            case 'PROCON':
                if ($tab_atual == 'procon'){
                } else {
                    $categoria = '';
                }

            default:
                $categoria = '';
        }

    }

    if (in_array($login_fabrica, [35]) && !empty($hd_chamado)) {

        $arrayCamposExtra = [];

        $sqlCampos = "SELECT array_campos_adicionais FROM tbl_hd_chamado_extra WHERE hd_chamado = {$hd_chamado}";
        $resCampos = pg_query($con, $sqlCampos);

        $arrayCamposExtra = json_decode(pg_fetch_result($resCampos, 0, "array_campos_adicionais"), true);

        if (!empty($cnpj_emitente_nf)) {
            $arrayCamposExtra["cnpj_emitente_nf"] = str_replace([".","/","-"], "", trim($cnpj_emitente_nf));
        }

        $sqlVerificaReembolso = "SELECT hd_motivo_ligacao
                         FROM tbl_hd_motivo_ligacao
                         WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}
                         AND (descricao = 'Ressarcimento'
                         OR descricao = 'Reembolso ( boleto E-com)')";
        $resVerificaReembolso = pg_query($con, $sqlVerificaReembolso);

        if (pg_num_rows($resVerificaReembolso) > 0 && !empty($valor_ressarcimento_reembolso)) {

            $arrayCamposExtra["valor_ressarcimento_reembolso"] = $valor_ressarcimento_reembolso;

        }

        $arrayCamposExtra = json_encode($arrayCamposExtra);

        $sqlCampoUpd = "UPDATE tbl_hd_chamado_extra SET array_campos_adicionais = '{$arrayCamposExtra}'
                        WHERE hd_chamado = {$hd_chamado}";
        $resCampoUpd = pg_query($con, $sqlCampoUpd);

    }


    if($login_fabrica == 129 && strlen($hd_chamado) > 0){

        $sql_campos_adicionais = "SELECT array_campos_adicionais FROM tbl_hd_chamado_extra WHERE hd_chamado = {$hd_chamado}";
        $res_campos_adicionais = pg_query($con, $sql_campos_adicionais);

        $campos_adicioanais = pg_fetch_result($res_campos_adicionais, 0, "array_campos_adicionais");

        $campos_adicioanais = json_decode($campos_adicioanais, true);

        if(!isset($campos_adicioanais["caminho_arquivo"])){

            $sql_ramal = "SELECT nome_completo, ramal FROM tbl_admin WHERE admin = {$login_admin} AND fabrica = {$login_fabrica}";
            $res_ramal = pg_query($con, $sql_ramal);

            $nome_completo = pg_fetch_result($res_ramal, 0, "nome_completo");
            list($nome_admin, $sobrenome) = explode(" ", $nome_completo);
            $nome_admin = ucwords(strtolower($nome_admin));

            $ramal = pg_fetch_result($res_ramal, 0, "ramal");

            if(strlen(trim($ramal)) > 0){

                /* Ex: Cristiane_R683.exp */
                $caminho_arq = "/mnt/ftp-fabricantes/rinnai/sac/";
                $url_arquivo = "{$caminho_arq}{$nome_admin}_R{$ramal}.exp";

                if(file_exists($url_arquivo)){
                    $dados_ramal = file_get_contents($url_arquivo);

                    if(strlen(trim($dados_ramal)) > 0){

                        list($inicio, $vazio1, $caminho_arquivo, $vazio2, $telefone) = explode("\n", $dados_ramal);

                        /* Seleciona os dados */
                        list($str_inicio, $inicio) = explode(" - ", $inicio);
                        $dados_ramal_inicio = trim($inicio);

                        list($str_caminho_arquivo, $caminho_arquivo) = explode(" - ", $caminho_arquivo);
                        $dados_ramal_caminho_arquivo = trim(str_replace("\\", "\\\\", $caminho_arquivo));

                        list($str_telefone, $telefone) = explode(" - ", $telefone);
                        $dados_ramal_telefone = trim($telefone);

                        /* Fim - Seleciona os dados */

                        if(strlen(trim($campos_adicioanais)) > 0){

                            $campos_adicioanais = json_decode($campos_adicioanais, true);

                            $campos_adicioanais["inicio"]           = $dados_ramal_inicio;
                            $campos_adicioanais["caminho_arquivo"]  = $dados_ramal_caminho_arquivo;
                            $campos_adicioanais["telefone"]         = $dados_ramal_telefone;

                            $campos_adicioanais = str_replace("\\", "\\\\", json_encode($campos_adicioanais));

                        }else{

                            $dados = array(
                                "inicio"          => $dados_ramal_inicio,
                                "caminho_arquivo" => $dados_ramal_caminho_arquivo,
                                "telefone"        => $dados_ramal_telefone
                            );

                            $campos_adicioanais = str_replace("\\", "\\\\", json_encode($dados));

                        }

                        $sql_dados_ramal = "UPDATE tbl_hd_chamado_extra SET array_campos_adicionais = '{$campos_adicioanais}' WHERE hd_chamado = {$hd_chamado}";
                        $res_dados_ramal = pg_query($con, $sql_dados_ramal);

                        if(strlen(pg_last_error($con)) == 0){

                            unlink($url_arquivo);

                        }
                    }
                }
            }
        }
    }

    if ($login_fabrica == 11 or $login_fabrica == 172) {//HD 53881 27/11/2008

        $tipo_reclamacao = $_POST['tipo_reclamacao'];

        if(strlen($callcenter) == 0 OR !empty($_POST['protocolo_id'])){
            $hd_motivo_ligacao = $_POST['hd_motivo_ligacao'];
            if($tab_atual == 'reclamacao_produto' AND empty($hd_motivo_ligacao)){
                $msg_erro = 'Escolha o motivo da ligação <br />';
            }
        }

        if ($tab_atual == 'reclamacao_at' AND strlen($tipo_reclamacao) == 0) {
            $msg_erro = 'Escolha o Tipo da Reclamação <br />';
        }

        $sub_tipo_reclamacao = array('mau_atendimento','posto_nao_contribui','demonstra_desorg','possui_bom_atend','demonstra_org','reclamacao_at_info');

        if (in_array($tipo_reclamacao, $sub_tipo_reclamacao)) {
            $tab_atual = $tipo_reclamacao;
        }

        $reclamado = $_POST['reclamado_at'];

        if (strlen($reclamado) > 0) {
            $xreclamado = "'$reclamado'";
        } else {
            $xreclamado = 'null';
        }

    }

    if (strlen($chamado_interno) > 0) {
        $xchamado_interno = "'t'";
    } else {
        $xchamado_interno = "'f'";
    }

    if ($login_fabrica == 174 && strlen($_POST['enviar_email']) > 0){
        $xchamado_interno = "'f'";
    }

	if (strlen($transferir) == 0) {
		if(!in_array($login_fabrica, array(24,30,74,151,161,164,169,170,183))){
            // Transfere automático para o admin que interagiu.
            $xtransferir = $login_admin;
        }
    } else {
        $xtransferir = $transferir;
    }

    if (strlen($status_interacao) > 0) {
        $xstatus_interacao = "'".$status_interacao."'";
    } else {
        $xstatus_interacao = "''";
    }

    if (strlen($tab_atual) == 0 and $login_fabrica == 25) {
        $tab_atual = "extensao";
    }

    if (strlen($tab_atual) == 0 and $login_fabrica <> 25) {
        $tab_atual = "reclamacao_produto";
    }

    $xconsumidor_revenda = "'C'";

    if (strlen(trim($_POST['consumidor_revenda'])) > 0 and $login_fabrica != 156) {
        $xconsumidor_revenda = "'".trim($_POST['consumidor_revenda'])."'";
    }

    if(in_array($login_fabrica,array(30,74,156))){
        $tipo_atendimento_elgin = $_POST['consumidor_revenda'];
    }

    if (in_array($login_fabrica, array(169,170))) {
        $garantia_estendida_tempo = $_POST["garantia_estendida_tempo"];

        $tipo_protocolo = $_POST['tipo_protocolo'];

        if(strlen($tipo_protocolo) == 0){
            $msg_erro .= "Informe o campo Protocolo via<br>";
        }
    }

    if(in_array($login_fabrica, array(169,170)) || $usaOrigemCadastro){
        $xorigem = trim($_POST['origem']);
        if(!empty($xorigem)) {
            $sqlOrigem = "SELECT tbl_hd_chamado_origem.hd_chamado_origem, tbl_hd_chamado_origem.descricao
                        FROM tbl_hd_chamado_origem
                        WHERE tbl_hd_chamado_origem.fabrica = {$login_fabrica}
                        AND tbl_hd_chamado_origem.hd_chamado_origem = {$xorigem}";
            $resOrigem = pg_query($con, $sqlOrigem);

            $origem_nome = strtolower(pg_fetch_result($resOrigem, 0, 'descricao'));
            $xorigem = "'".pg_fetch_result($resOrigem, 0, 'descricao')."'";
            $id_xorigem = pg_fetch_result($resOrigem, 0, 'hd_chamado_origem');
        } elseif ($login_fabrica == 81) {
                $msg_erro .= "Informe uma origem do atendimento <br />";
        } else {
            if ($login_fabrica == 175 OR $login_fabrica == 189){
                    $id_xorigem = "null";
                    $xorigem = "null";
                }
        }

    }else{
        $xorigem             = "'".trim($_POST['origem'])."'";
    }
    if (in_array($login_fabrica, [177,186,195]) && $xorigem == '') {
        $xorigem = "null";
    }
    if (in_array($login_fabrica, [184,191,198,200]) && $xorigem == '') {
        $msg_erro .= "Informe uma origem do atendimento <br />";
    }
    $receber_informacoes = $_POST['receber_informacoes'];
    $hora_ligacao        = $_POST['hora_ligacao'];

    if (strlen($hora_ligacao) == 0) {
        $xhora_ligacao = "null";
    } else {
        list($h,$m) = explode(":",$hora_ligacao);
        if($h >= 24 OR $m >= 60){
            $msg_erro .= "Horário de contato inválido {$hora_ligacao} <br />";
        }else{
            $xhora_ligacao = "'$hora_ligacao".":00'";
        }
    }

    $defeito_reclamado      = $_POST['defeito_reclamado'];
    $consumidor_nome        = trim($_POST['consumidor_nome']);
    $contato_nome           = trim($_POST['contato_nome']);
    $cliente                = trim($_POST['cliente']);

    if ($login_fabrica != 161 || ($login_fabrica == 161 && $_POST["consumidor_pais"] == 'BR')) {

        $valida_cpf_cnpj = verificaCpfCnpj(preg_replace("/\D/","",$_POST['consumidor_cpf']));

        if(empty($valida_cpf_cnpj)){
            $consumidor_cpf         = checaCPF($_POST['consumidor_cpf'],false);
        }else{
            $msg_erro .= $valida_cpf_cnpj."<br>";
        }
    }
    
    $atendimento_callcenter = trim($_POST['atendimento_callcenter']);
    $atendimento_callcenter = (empty($atendimento_callcenter)) ? 'f' : 't';
    $hd_motivo_ligacao      = (empty($hd_motivo_ligacao)) ? 'null' : $hd_motivo_ligacao;

    if(in_array($login_fabrica,array(50,129,162))){
        if(strlen(trim($defeito_reclamado))==0 and $tab_atual == 'reclamacao_produto'){
            $msg_erro .= " Por favor informar o Defeito Reclamado. <br />";
        }
    }

    if(in_array($login_fabrica,array(167,184,186,200,203))){
        if(strlen(trim($_POST['produto_referencia'])) > 0 OR strlen(trim($_POST['produto_nome'])) > 0){
            if(strlen(trim($defeito_reclamado))==0 and $tab_atual == 'reclamacao_produto'){
                $msg_erro .= " Por favor informar o Defeito Reclamado. <br />";
            }
        }
    }

    if(in_array($login_fabrica,array(184,200)) && strlen(trim($_POST['reclamado_produto'])) == 0){
        $msg_erro .= "Informe a Descrição do Atendimento <br/>";
    }

	if ($login_fabrica != 161 || ($login_fabrica == 161 && $_POST["consumidor_pais"] == 'BR')) {

        if (is_numeric($consumidor_cpf)) {

            $mask = (strlen($consumidor_cpf) == 14) ? '/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/':'/(\d{3})(\d{3})(\d{3})(\d{2})/';
            $fmt  = (strlen($consumidor_cpf) == 14) ? '$1.$2.$3/$4-$5':'$1.$2.$3-$4';

            $consumidor_cpf = preg_replace($mask, $fmt, $consumidor_cpf);

        } else {

            $consumidor_cpf  = 'null';

            //28/12/2009 - Lembrando que só deve dar erro se o usuário digitou um CPF/CNPJ...
            if (strlen($_POST['consumidor_cpf']) != 0) {
                $msg_erro .= "CPF / CNPJ do consumidor inválido <br />";
            }
        }
    }

    if($login_fabrica != 85){
        $consumidor_rg      = trim($_POST['consumidor_rg']);
        $consumidor_rg      = preg_replace("/\W/","",$consumidor_rg);
    }
    $consumidor_email       = trim($_POST['consumidor_email']);
    $consumidor_fone        = trim($_POST['consumidor_fone']);
    $consumidor_fone        = str_replace("'","",$consumidor_fone);
    $consumidor_fone2       = trim($_POST['consumidor_fone2']);
    $consumidor_fone2       = str_replace("'","",$consumidor_fone2);
    $consumidor_fone3       = trim($_POST['consumidor_fone3']);
    $consumidor_fone3       = str_replace("'","",$consumidor_fone3);
    $consumidor_cep         = trim($_POST['consumidor_cep']);
    $consumidor_cep         = substr(preg_replace( '/[^0-9]+/', '', $consumidor_cep), 0, 8);
    $consumidor_endereco    = str_replace("'", "", trim($_POST['consumidor_endereco']));
    $consumidor_numero      = trim($_POST['consumidor_numero']);
    $consumidor_numero      = str_replace("'","",$consumidor_numero);
    $consumidor_complemento = trim($_POST['consumidor_complemento']);
    $consumidor_bairro      = trim($_POST['consumidor_bairro']);
    $consumidor_bairro      = pg_escape_string($con, $consumidor_bairro);
    $consumidor_bairro      =   substr($consumidor_bairro,0,60);
    $consumidor_cidade      = str_replace("'", "", trim(strtoupper($_POST['consumidor_cidade'])));
    $consumidor_cidade      = str_replace("\\", "", $consumidor_cidade);
    $consumidor_estado      = trim(strtoupper($_POST['consumidor_estado']));
    $origem                 = $_POST['origem'];
    $consumidor_revenda     = $_POST['consumidor_revenda'];
    $consumidor_cpf_cnpj    = $_POST['consumidor_cpf_cnpj'];
    $cnpj_revenda           = preg_replace("/\D/", "", $_POST['cnpj_revenda']);
    $nome_revenda           = substr($_POST['nome_revenda'], 0, 50);
    $hd_motivo_ligacao      = $_POST['hd_motivo_ligacao'];
	$posto = $_POST["posto_banco"];
    $pedido_venda           = $_POST['pedido_venda'];
    $resposta_consumidor    = utf8_encode($_POST['resposta_consumidor']);
    $nf_venda               = $_POST['nf_venda'];

    $duvida_consumidor      = $_POST['duvida_consumidor'];

    if ($login_fabrica == 152) {

        if ($duvida_consumidor == 'TE') {
            $equipamentoeconsumivel = $_POST['equipamento_consumidor'];
        }elseif ($duvida_consumidor == 'TC') {
            $equipamentoeconsumivel  = $_POST['consumivel_consumidor'];
        }
        $equi_com = true;
    }

    $tipo_atendimento_consumidor = $_POST['tipo_atendimento_consumidor'];
    $desbloqueia_obrigatorios = false;


    if ($login_fabrica == 30) {
        $xos_c_troca = $_POST['os_c_troca'];
    }

    if(in_array($login_fabrica, array(169,170))){

        switch($_POST["tab_atual"]) {
                case "reclamacao_produto":
                    $hd_motivo_ligacao = $_POST["hd_motivo_ligacao"];
                    $hd_providencia_callcenter = $_POST["providencia_nivel3_reclamacao_produto"];
                    break;

                case "reclamacao_empresa":
                    $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_reclamacao_empresa"];
                    $hd_providencia_callcenter = $_POST["providencia_nivel3_reclamacao_empresa"];
                    break;

                case "reclamacao_at":
                    $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_reclamacao_at"];
                    $hd_providencia_callcenter = $_POST["providencia_nivel3_reclamacao_at"];
                    break;

                case "duvida_produto":
                    $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_duvida_produto"];
                    $hd_providencia_callcenter = $_POST["providencia_nivel3_duvida_produto"];
                    break;

                case "sugestao":
                    $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_sugestao"];
                    $hd_providencia_callcenter = $_POST["providencia_nivel3_sugestao"];
                    break;

                case "onde_comprar":
                    $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_onde_comprar"];
                    $hd_providencia_callcenter = $_POST["providencia_nivel3_onde_comprar"];
                    break;

                case "indicacao_at":
                    $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_indicacao_at"];
                    $hd_providencia_callcenter = $_POST["providencia_nivel3_indicacao_at"];
                    break;

                case "informacao":
                    $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_informacao"];
                    $hd_providencia_callcenter = $_POST["providencia_nivel3_informacao"];
                    break;

                default:
                    $hd_motivo_ligacao = null;
                    break;
        }

        $abre_os_preos = $_POST['abre_os_preos'];

        if (in_array($_REQUEST['hd_classificacao'], array(181,182,183,184,186,188,189,190,191,200))) {
            $desbloqueia_obrigatorios = true;
        }
    }

    if($login_fabrica == 125 ){

        if (empty($consumidor_revenda)) {
            $msg_erro .= "Informe o tipo de atendimento <br />";
        }

        if($consumidor_revenda == "C"){
            array_push($fabricas_validam_campos_obrigatorios, 125);
        }
    }

    if($login_fabrica == 50 AND strlen(trim($hd_motivo_ligacao)) == 0){#HD-3283170
        $msg_erro .= "Informe o tipo de atendimento <br />";
    }

    /*HD - 4329748*/
    if ((in_array($login_fabrica, array(81,114,123,125,147,160,191,198)) or $replica_einhell) && empty($_POST["hd_classificacao"])) {
        $msg_erro .= "Por favor informe a classificação do atendimento <br />";
    }


    if (!$integracaoSocial) {

        if ($moduloProvidencia AND !in_array($login_fabrica,array(164,171,178,183,184,186,190,194,195,198,200)) and strlen(trim($hd_motivo_ligacao))==0 && (!in_array($login_fabrica,array(35,160,174)) || (in_array($login_fabrica,array(35,160,174)) && $tab_atual == 'reclamacao_produto'))) {
            if ($login_fabrica == 189) {
              $msg_erro .= "Por favor informe a ação do atendimento. <br />";
            } else {
              $msg_erro .= "Por favor informe a providência do atendimento.<br />";
            }
        }
    }


    if ($login_fabrica == 152 && strlen($tipo_atendimento_consumidor) == 0) {
        $msg_erro .= "Por favor selecione o tipo do atendimento. <br />";
    }
    if ($login_fabrica == 152 && strlen($duvida_consumidor) == 0) {
        $msg_erro .= "Por favor selecione a dÃºvida. <br />";
    }
    if ($login_fabrica == 152 && $duvida_consumidor == 'TE') {
        if (strlen($equipamentoeconsumivel) == 0) {
            $msg_erro .= "Por favor selecione um Equipamento. <br />";
        }
    }
    if ($login_fabrica == 152 && $duvida_consumidor == 'TC') {
        if (strlen($equipamentoeconsumivel) == 0) {
            $msg_erro .= "Por favor selecione um ConsumÃ­vel. <br />";
        }
    }

    if (in_array($login_fabrica, [169,170])) {
        if ($mostra_providencia_nivel3 == 'sim' && empty($hd_providencia_callcenter)) {
            $msg_erro .= "Preencha o campo providência nÃ­vel 3<br>";
        }
    }


    if (in_array($login_fabrica, [166,174]) AND empty($tipo_venda) AND strlen($callcenter) == 0) {

        $msg_erro .= "Por favor, selecione a referência do atendimento. <br />";
    }

    if (in_array($login_fabrica, [186]) AND empty($tipo_venda) AND strlen($callcenter) == 0 AND strlen($_POST["origem"]) > 0) {

        $sqlOrigem = "SELECT descricao FROM tbl_hd_chamado_origem WHERE fabrica={$login_fabrica} AND hd_chamado_origem=".$_POST["origem"];
        $resOrigem = pg_query($con, $sqlOrigem );
        if (pg_num_rows($resOrigem) > 0) {
            $nomeOrigem = trim(pg_fetch_result($resOrigem, 0, 'descricao'));

            if ($nomeOrigem == "Mercado Livre") {
                $msg_erro .= "Por favor, selecione a referência do atendimento. <br />";
            }

        }
    }

    // echo $_POST['consumidor_cidade']." - ".$consumidor_cidade;exit;
    if ($login_fabrica == 86) {
        if( ($consumidor_revenda == 'R' OR $consumidor_revenda == 'T' OR $consumidor_revenda == 'P') AND empty($hd_motivo_ligacao)){
            $msg_erro = "Informe o motivo do atendimento <br>";
        }
    }

    $hd_motivo_ligacao = (empty($hd_motivo_ligacao)) ? "NULL" : $hd_motivo_ligacao;
    if (strlen($cnpj_revenda)) {

        $valida_cpf_cnpj = verificaCpfCnpj(preg_replace("/\D/","",$cnpj_revenda));

        if(empty($valida_cpf_cnpj)){
            @$res_cnpj_revenda = pg_query($con, "SELECT fn_valida_cnpj_cpf('$cnpj_revenda')");

            if (pg_errormessage($con)) {
                #$msg_erro = "CNPJ da revenda inválido";
                $last_error = substr(pg_errormessage($con), 6);
                $last_error = explode("CONTEXT", $last_error);

                $msg_erro = "Erro na validação do CNPJ da Revenda: ".$last_error[0];
            }
        }else{
			if(strpos($valida_cpf_cnpj,'Quantidade de d') !== false) {
				$msg_erro .= "CNPJ da revenda inválida ";
			}else{
				$msg_erro .= $valida_cpf_cnpj;
			}
        }

    }else{
        if($login_fabrica == 85){
            if (!empty($_POST["check_tecnico_esporadico"])) {
                if (empty($_POST["codigo_tecnico_esporadico"])) {
                    $aux_campos = "o código";
                }

                if (empty($_POST["valor_servico_combinado"])) {
                    $aux_campos .= (strlen($aux_campos) > 0) ? ", o nome" : "o nome";
                }

                if (empty($_POST["valor_servico_combinado"])) {
                    $aux_campos .= (strlen($aux_campos) > 0) ? " e o valor do serviço" : "o valor do serviço";
                }

                if (!empty($aux_campos)) {
                    if (strlen($msg_erro) > 0 && !preg_match('<br>', $msg_erro)) $msg_erro .= "<br>";
                    $msg_erro .= "Por favor digite ". $aux_campos ." do técnico esporádico <br>";
                }
            }

            $msg_erro .= "O campo CNPJ de revenda é obrigatório <br />";
        }
    }

    if($login_fabrica == 74 and (empty($nome_revenda) or empty($cnpj_revenda))) {
        $msg_erro .= "Informe o nome da revenda <br />";
    }

    if ($login_fabrica == 74 and empty($_POST['data_prov'])) {
        $msg_erro .= "Informe a Data Providência.<br />";
    }
    if ($login_fabrica == 74 and empty($_POST['consumidor_cep'])) {
        $msg_erro .= "Informe o cep do consumidor <br />";
    }
    if($login_fabrica == 81){
        $solucao_post = $_POST["solucao"];
        $sqlSolucao = " SELECT
                            tbl_diagnostico.diagnostico,
                            tbl_solucao.solucao,
                            tbl_solucao.descricao as descricao_solucao
                            FROM tbl_diagnostico
                            INNER JOIN tbl_solucao using(solucao)
                            inner join tbl_produto on tbl_produto.marca = tbl_diagnostico.marca
                            WHERE tbl_diagnostico.fabrica = $login_fabrica
                            AND solucao is not null
                            AND tbl_produto.referencia = '$produto_referencia'
                            AND tbl_diagnostico.ativo is true ";
        $resSolucao = pg_query($con, $sqlSolucao);
         $optionSolucao = "<option value=''>Solução</option>";
        for($i=0; $i<pg_num_rows($resSolucao); $i++){
            $diagnostico        = pg_fetch_result($resSolucao, $i, diagnostico);
            $solucao_db            = pg_fetch_result($resSolucao, $i, solucao);
            $descricao_solucao  = pg_fetch_result($resSolucao, $i, descricao_solucao);

            if($solucao_db == $solucao_post){
                $selected = " selected ";
            }else{
                $selected = " ";
            }
            $optionSolucao .=  "<option value='$solucao_db' $selected>$descricao_solucao </option>";
        }
    }

    // HD 6871803: Verificando número de série, bloqueado para a Imbera
        if (in_array($login_fabrica, [158]) && $abre_ordem_servico == 't') {
            $val_serie = $_POST['serie'];

            if (!empty($val_serie)) {
                $sql_num_serie = "SELECT ns.serie
                                FROM tbl_numero_serie AS ns
                                    INNER JOIN tbl_serie_controle AS sc ON sc.serie = ns.serie AND sc.fabrica = {$login_fabrica}
                                WHERE   ns.fabrica = {$login_fabrica}
                                    AND ns.serie   = '{$val_serie}';";
                $res_num_serie = pg_query($con, $sql_num_serie);

                if (pg_num_rows($res_num_serie) > 0) {
                    $msg_erro .= "número de série do produto está bloqueado, favor entrar em contato com o fabricante. <br />";
                }
            }
        }

     if (in_array($login_fabrica, [198])) {
        if (!empty($_POST['produto_referencia'])) {

            if (empty($defeito_reclamado) && empty($hd_extra_defeito)) {
                $msg_erro .= "Informe o Defeito Reclamado <br />";
            }

        }

        if ($abre_os == 't') {
            if (empty($consumidor_nome)) {
                $msg_erro .= "Informe o nome do consumidor <br />";
            }
            
            if (empty($consumidor_email)) {
                $msg_erro .= "Informe o email do consumidor <br />";
            }

            if(empty($consumidor_email) > 0) {
                if(!filter_var($consumidor_email,FILTER_VALIDATE_EMAIL)){
                    $msg_erro .= "O email do consumidor é inválido <br />";
                }
            }

            if (empty($consumidor_cep)) {
                $msg_erro .= "Informe o cep do consumidor <br />";
            }

            if (empty($consumidor_endereco)) {
                $msg_erro .= "Informe o endereco do consumidor <br />";
            }

            if (empty($consumidor_numero)) {
                $msg_erro .= "Informe o número endereco do consumidor <br />";
            }

            if (empty($consumidor_bairro)) {
                $msg_erro .= "Informe o bairro do consumidor <br />";
            }

            if (empty($consumidor_estado)) {
                $msg_erro .= "Informe o estado (UF) do consumidor <br />";
            }
        }
    }
    
    if (in_array($login_fabrica, $fabricas_validam_campos_obrigatorios)) {
        if (empty($consumidor_nome)) {
            $msg_erro .= "Informe o nome do consumidor <br />";
        }

        if (empty($cliente_nome_admin) && $login_fabrica == 158) {
            $msg_erro .= "Informe o Cliente Imbera <br />";
        }

        if (strlen($cliente_nome_admin) > 0 && $login_fabrica == 158) {
            $sqlImb = "SELECT *
                      FROM tbl_cliente_admin
                     WHERE cliente_admin = {$cliente_admin}
                       AND fabrica = $login_fabrica";
            $resImb = pg_query($con,$sqlImb);
            if (pg_num_rows($resImb) == 0) {
                $msg_erro = "Cliente Imbera <b>'$cliente_nome_admin'</b> não encontrado <br />";
            }
        }


        if (empty($consumidor_email) && !in_array($login_fabrica, array(11,157,158,165,172,191))) {
            $msg_erro .= "Informe o email do consumidor <br />";
        }

        if(in_array($login_fabrica, [144, 138]) && strlen($consumidor_email) > 0){
            if(!filter_var($consumidor_email,FILTER_VALIDATE_EMAIL)){
                $msg_erro .= "O email do consumidor é inválido <br />";
            }
        }

        if (empty($consumidor_cep) && !in_array($login_fabrica, array(157,158))) {
            $msg_erro .= "Informe o cep do consumidor <br />";
        }

        if (empty($consumidor_endereco)) {
            $msg_erro .= "Informe o endereco do consumidor <br />";
        }

        if (empty($consumidor_numero) and !in_array($login_fabrica, array(157))) {
            $msg_erro .= "Informe o número endereco do consumidor <br />";
        }

        if (empty($consumidor_bairro) and !in_array($login_fabrica, array(157))) {
            $msg_erro .= "Informe o bairro do consumidor <br />";
        }

        if (empty($consumidor_estado)) {
            $msg_erro .= "Informe o estado (UF) do consumidor <br />";
        }

        if (empty($consumidor_cidade)) {
            if (($login_fabrica == 52 && $_POST["consumidor_pais"] == 'BR') || $login_fabrica != 52) {
                $msg_erro .= "Informe a cidade do consumidor <br />";
            }
        }

        if (!strlen($consumidor_fone) && in_array($login_fabrica, array(157))) {
            $msg_erro .= "Informe o Telefone do Cliente <br />";
            if ($login_fabrica == 157) {
                $fabricas_validam_campos_obrigatorios = array();
            }
        }

	if (empty($consumidor_fone) && empty($consumidor_fone2) && empty($consumidor_fone3) && in_array($login_fabrica, array(191))){
		$msg_erro .= "Informe o Telefone do Cliente <br />";
	}

        if ($login_fabrica == 158) {
            $abre_os_admin = $_POST['abre_os_admin'];

            if (empty($origem)) {
                $msg_erro .= "Informe uma origem do atendimento <br />";
            }

            if (empty($consumidor_revenda)) {
                $msg_erro .= "Informe o tipo do atendimento <br />";
            }
        }

    }

    if ($login_fabrica == 178){
        $id_os_revenda    = $_POST["id_os_revenda"];
        $id_classificacao = $_POST["hd_classificacao"];

        $valida_campos    = false;

        $sql = "SELECT hd_classificacao FROM tbl_hd_classificacao WHERE fabrica = $login_fabrica AND hd_classificacao = $id_classificacao AND obriga_campos = 't'";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0){
            $valida_campos = true;
        }else if ($_POST["abre_ordem_servico"] == 't'){
            $valida_campos = true;
        }

        if ($valida_campos === true){
            if (empty($consumidor_cpf) || $consumidor_cpf == "null") {
                $msg_erro .= "Informe o CPF/CNPJ <br>";
            }

            if (empty($_POST["consumidor_nascimento"]) AND $_POST["consumidor_revenda"] == "t"){
                $msg_erro .= "Informe a data de nascimento <br/>";
            }

            if (empty($consumidor_cep)){
                $msg_erro .= "Por favor informe o CEP do consumidor <br/>";
            }
            if (empty($consumidor_endereco)){
                $msg_erro .= "Por favor informe o endereço do consumidor <br/>";
            }
            if (empty($consumidor_numero)){
                $msg_erro .= "Por favor informe o número do consumidor <br/>";
            }
            if (empty($consumidor_bairro)){
                $msg_erro .= "Por favor informe o bairro do consumidor <br/>";
            }
            if (empty($consumidor_email)) {
                $msg_erro .= "Informe o email do consumidor <br />";
            }
            if(strlen($consumidor_email) > 0){
                if(!filter_var($consumidor_email,FILTER_VALIDATE_EMAIL)){
                    $msg_erro .= "O email do consumidor é inválido <br />";
                }
            }
            if (strlen($consumidor_estado) == 0) {
                $msg_erro .= "Por favor selecione o estado<br>";
            }
            if (strlen($consumidor_cidade) == 0) {
                $msg_erro .= "Por favor inserir a cidade<br>";
            }
        }

        if (strlen(trim($_POST["consumidor_nascimento"])) > 0 AND strlen(trim($_POST["consumidor_nascimento"])) != 10){
            $msg_erro .= "Data de nascimento inválida <br/>";
        }

        if (empty($xorigem)){
            $msg_erro .= "Informe a origem do atendimento <br/>";
        }

        if (empty($consumidor_fone) AND empty($consumidor_fone2) AND empty($consumidor_fone3)){
            $msg_erro .= "Informe telefone do consumidor <br/>";
        }
        if (empty($consumidor_revenda)){
            $msg_erro .= "Informe o tipo <br/>";
        }
        if(strlen(trim($_POST['reclamado_produto'])) == 0){
            $msg_erro .= "Informe a Descrição do Atendimento <br/>";
        }
        if(empty($_POST['hd_classificacao'])){
            $msg_erro .= "Informe a classificação do atendimento <br/>";
        }
    }

    if ($login_fabrica == 194){
        if (empty($_POST['hd_classificacao'])){
            $msg_erro .= "Por favor informe a classificação do atendimento <br/>";
        }
    }

    if ($login_fabrica == 183){ //valida campos Itatiaia
        $id_zendesk = $_POST["id_zendesk"];

        $dev_transportadora = $_POST['dev_transportadora'];
        $dev_motorista      = $_POST['dev_motorista'];
        $dev_aprovador      = $_POST['dev_aprovador'];
        $pedido_sap         = $_POST['pedido_sap'];

        if (!empty($_POST['hd_classificacao'])){
            $sql = "SELECT descricao FROM tbl_hd_classificacao WHERE fabrica = $login_fabrica AND hd_classificacao = {$_POST['hd_classificacao']}";
            $res = pg_query($con, $sql);

            if (pg_num_rows($res) > 0){
                $hd_classificacao_descricao = pg_fetch_result($res, 0, "descricao");
                $hd_classificacao_descricao = retira_acentos($hd_classificacao_descricao);
                $hd_classificacao_descricao = strtolower($hd_classificacao_descricao);
            }

            if ($hd_classificacao_descricao == "ocorrencia tecnica"){
                if (strlen(trim($_POST['serie'])) == 0){
                    $msg_erro .= "Para a classificação selecionada é obrigatório preencher o número de série do produto. <br/>";
                }
            }

            if (empty($_POST['consumidor_nome'])){
                $msg_erro .= "Por favor informe o nome do consumidor <br/>";
            }

            if (empty($_POST['consumidor_endereco'])){
                $msg_erro .= "Por favor informe o endereço do consumidor <br/>";
            }

            if (empty($_POST['consumidor_numero'])){
                $msg_erro .= "Por favor informe o número do consumidor <br/>";
            }

            if (empty($_POST['consumidor_bairro'])){
                $msg_erro .= "Por favor informe o bairro do consumidor <br/>";
            }

            if (empty($_POST['consumidor_cidade'])){
                $msg_erro .= "Por favor informe a cidade do consumidor <br/>";
            }

            if (empty($_POST['consumidor_estado'])){
                $msg_erro .= "Por favor informe o estado do consumidor <br/>";
            }

            if (empty($_POST['hd_motivo_ligacao'])){
                $msg_erro .= "Por favor informe a providência do atendimento <br/>";
            }

            if (empty($_POST['resposta']) AND !empty($callcenter)){
                $msg_erro .= "Por favor informe a resposta do atendimento <br/>";
            }


            if (empty($_POST['reclamado_produto']) > 0){
                $msg_erro .= "Por favor informe a descrição do atendimento <br/>";
            }

            $sql_admin_atendente = "
                SELECT tbl_admin_atendente_estado.admin
                FROM tbl_admin_atendente_estado
                WHERE tbl_admin_atendente_estado.fabrica = $login_fabrica
                AND tbl_admin_atendente_estado.hd_classificacao = {$_POST['hd_classificacao']}
                AND tbl_admin_atendente_estado.hd_motivo_ligacao = {$_POST['hd_motivo_ligacao']}";
            $res_admin_atendente = pg_query($con,$sql_admin_atendente);

            if (pg_num_rows($res_admin_atendente) > 0){
                $admin_atendente = pg_fetch_all_columns($res_admin_atendente);

                if (!in_array($login_admin, $admin_atendente)){
                    if (empty($_POST['transferir'])){
                        $msg_erro .= "Para a providência selecionada, selecione um responsável para transferir o atendimento <br/>";
                    }
                }
            }
        }else{
            $msg_erro .= "Por favor informe a classificação do atendimento <br/>";
        }

        if ($_POST['abre_ordem_servico'] == "t"){
            if (empty($_POST['tipo_atendimento_os'])){
                $msg_erro .= "Por favor informe o tipo de atendimento da Ordem de Serviço <br/>";
            }else{
                $tipo_atendimento_os = $_POST["tipo_atendimento_os"];
            }
        }

        if (empty($_POST['status_interacao'])){
            $msg_erro .= "Por favor informe a situação do atendimento <br/>";
        }
    }

    if (in_array($login_fabrica, array(176))) {
        if (empty($consumidor_nome)) {
            $msg_erro .= "Informe o nome do consumidor <br />";
        }
        if (!strlen($consumidor_fone)) {
            $msg_erro .= "Informe o Telefone do Cliente <br />";
        }
        if (empty($consumidor_cpf) || $consumidor_cpf == "null") {
            $msg_erro .= "O CPF informado é inválido <br>";
        }

        if(strlen(trim($_POST['reclamado_produto'])) == 0){
            $msg_erro .= "Informe a Descrição do Atendimento <br/>";
        }
    }

    if (in_array($login_fabrica, array(190))) {
        if (empty($consumidor_nome)) {
            $msg_erro .= "Informe o nome do consumidor <br />";
        }

        if (empty($consumidor_cpf) || $consumidor_cpf == "null") {
            $msg_erro .= "O CPF informado é inválido <br>";
        }

        if (empty($consumidor_cep)){
            $msg_erro .= "Por favor informe o CEP do consumidor <br/>";
        }
        if (empty($consumidor_endereco)){
            $msg_erro .= "Por favor informe o endereço do consumidor <br/>";
        }
        if (empty($consumidor_numero)){
            $msg_erro .= "Por favor informe o número do consumidor <br/>";
        }
        if (empty($consumidor_bairro)){
            $msg_erro .= "Por favor informe o bairro do consumidor <br/>";
        }
      
        if (strlen($consumidor_estado) == 0) {
            $msg_erro .= "Por favor selecione o estado<br>";
        }

        if (strlen($consumidor_cidade) == 0) {
            $msg_erro .= "Por favor inserir a cidade<br>";
        }
        if (strlen($origem) == 0) {
            $msg_erro .= "Por favor escolha um Origem<br>";
        }
        if (strlen($consumidor_revenda) == 0) {
            $msg_erro .= "Informe o tipo <br/>";
        }

        if(strlen(trim($_POST['reclamado_produto'])) == 0){
            $msg_erro .= "Informe a Descrição do Atendimento <br/>";
        }
        if ($_POST["abre_ordem_servico"] == 't'){
 /*       
            if(strlen(trim($_POST["produto_referencia"])) == 0 OR strlen(trim($_POST["produto_nome"])) == 0){
                $msg_erro .= "Informe o Produto <br/>";
            }

            if(strlen(trim($_POST['defeito_reclamado'])) == 0){
                $msg_erro .= "Selecione o defeito reclamado <br/>";
            }

            if(strlen(trim($_POST["nota_fiscal"])) == 0){
                $msg_erro .= "Informe a nota fiscal do Produto <br/>";
            }

            if(strlen(trim($data_nf)) == 0){
                $msg_erro .= "Informe a data da nota fiscal do Produto <br/>";
            }

            if(strlen(trim($_POST["cnpj_revenda"])) == 0 OR strlen(trim($_POST["nome_revenda"])) == 0){
                $msg_erro .= "Informe os dados da Revenda <br/>";
            }*/

            if (empty($_POST['tipo_atendimento_os'])){
                $msg_erro .= "Por favor informe o tipo de atendimento da Ordem de Serviço <br/>";
            }else{
                $tipo_atendimento_os = $_POST["tipo_atendimento_os"];
                $tipo_atendimento_grohe = $_POST["tipo_atendimento_os"];
            }


        }
    }

	if (in_array($login_fabrica, array(195))) {
        if (empty($consumidor_nome)) {
            $msg_erro .= "Informe o nome do consumidor <br />";
        }

        if (empty($consumidor_cpf) || $consumidor_cpf == "null") {
            $msg_erro .= "Informe o CPF <br>";
        }
/*
        if (strlen($consumidor_estado) == 0) {
            $msg_erro .= "Por favor selecione o estado<br>";
        }

        if (strlen($consumidor_cidade) == 0) {
            $msg_erro .= "Por favor inserir a cidade<br>";
        }
    */
        if (empty($consumidor_fone) AND empty($consumidor_fone2) AND empty($consumidor_fone3)){
            $msg_erro .= "Informe telefone do consumidor <br/>";
        }
        /*
        if (strlen($origem) == 0) {
            $msg_erro .= "Por favor escolha um Origem<br>";
        }

        if (strlen($consumidor_revenda) == 0) {
            $msg_erro .= "Informe o tipo <br/>";
        }

        if(empty($_POST['hd_classificacao'])){
            $msg_erro .= "Informe a classificação do atendimento <br/>";
        }
        */
        if(strlen(trim($_POST['reclamado_produto'])) == 0){
            $msg_erro .= "Informe a Descrição do Atendimento <br/>";
        }
        if ($_POST["abre_ordem_servico"] == 't'){
            if (empty($_POST['tipo_atendimento_os'])){
                $msg_erro .= "Por favor informe o tipo de atendimento da Ordem de Serviço <br/>";
            }else{
                $tipo_atendimento_os = $_POST["tipo_atendimento_os"];
                $tipo_atendimento_grohe = $_POST["tipo_atendimento_os"];
            }
        }
    }

    if (in_array($login_fabrica, [175])) {

        if ($tab_atual == 'reclamacao_produto' && empty($_POST['reclamado_produto'])) {
            $msg_erro .= "Informe a Descrição do Atendimento <br/>";
        }

    }

    if (in_array($login_fabrica, array(174,176))) {
        if (!preg_match("/mercado livre/", strtolower($origem_nome))) {
            if (!empty($_POST['produto_referencia']) && ($abre_os == "t" || in_array($login_fabrica, [174]))) {
                if (!in_array($login_fabrica, [174])) {
                    if (empty($hd_extra_defeito) AND empty($defeito_reclamado)) {
                            $msg_erro .= "Informe o Defeito Reclamado ou Informe a Reclamação do Cliente <br />";
                    }
                } else if (in_array($login_fabrica, [174]) && $origem != 67 && $tab_atual == 'reclamacao_produto') {
                    if (empty($defeito_reclamado)) {
                        $msg_erro .= 'Preencha o campo "Defeitos Reclamados" na aba referente<br />';
                    }

                    if (empty($hd_extra_defeito)) {
                        $msg_erro .= 'Preencha o campo "Reclamação Cliente" na aba referente<br />';
                    }
                }
            }
        }
    }

    if ($login_fabrica == 162 ) {
        if (empty($origem)) {
            $msg_erro .= "Informe uma origem do atendimento <br />";
        }
    }

    if (in_array($login_fabrica, [24,145,198])) {
        if (!strlen(trim($_POST["consumidor_cpf"]))) {
            $msg_erro .= "Por favor informe o CPF do consumidor <br />";
        }

        if (in_array($login_fabrica, [198])) {
            if (!strlen($consumidor_fone)) {
                $msg_erro .= "Informe o Telefone do consumidor <br />";
            }

            if (!strlen($_POST['reclamado_produto'])) {
                $msg_erro .= "Informe a Descrição do Atendimento <br />";
            }
        }
    }

    if($login_fabrica == 30 and empty($callcenter)){
       if (!strlen(trim($_POST["consumidor_cpf"]))) {
            $msg_erro .= "Por favor informe o CPF do consumidor <br />";
        }
    }

    if($login_fabrica == 52){

        if (strlen($hd_classificacao) > 0) {
            $aux_sql = "SELECT descricao FROM tbl_hd_classificacao WHERE fabrica = $login_fabrica AND ativo IS TRUE AND hd_classificacao = $hd_classificacao";
            $aux_res = pg_query($con, $aux_sql);
            $aux_val = pg_fetch_result($aux_res, 0, 'descricao');
            $aux_val = str_replace("ç", "c", $aux_val);
            $aux_val = str_replace("Ã", "C", $aux_val);
            $aux_val = str_replace("ã", "a", $aux_val);
            $aux_val = str_replace("Ã", "A", $aux_val);
            $aux_val = strtoupper($aux_val);

            if ($aux_val == "ORIENTACAO") {
                $hd_orientacao    = true;
                $consumidor_fone  = trim($_POST["consumidor_fone"]);
                $consumidor_fone2 = trim($_POST["consumidor_fone2"]);
                $consumidor_fone3 = trim($_POST["consumidor_fone3"]);

                if (strlen($consumidor_fone) == 0 && strlen($consumidor_fone2) == 0 && strlen($consumidor_fone3) == 0) {
                    $msg_erro = "Informe ao menos um telefone para contato<br>";
                }
            }
        } else {
            $hd_orientacao = false;
        }

        if(strlen($_POST['consumidor_pais']) == 0 && $hd_orientacao == false) {
            $msg_erro .= "Informe o paÃ­s do cliente <br>";
        } else {
            $consumidor_pais = $_POST["consumidor_pais"];

            if ($consumidor_pais == "BR") {
                if (strlen(trim($_POST['consumidor_cep'])) == 0) {
                    $msg_erro .= "Por favor informe CEP do consumidor <br />";
                }

                if(strlen($_POST['consumidor_cpf']) == 0){
                    $msg_erro .= "Informe o CPF / CNPJ do Cliente <br />";
                }
            }
        }

        if(strlen($_POST['ponto_referencia']) == 0 && $hd_orientacao == false){
            $msg_erro .= "Informe o Ponto de Referência <br />";
        }

    }

    if(in_array($login_fabrica, [167, 203])){ //HD-3428316

        if (!strlen($consumidor_cpf) || $consumidor_cpf == "null") {
            $msg_erro .= "Informe o CPF do Cliente <br>";
        }

        if (!strlen($consumidor_fone) && !strlen($consumidor_fone2) && !strlen($consumidor_fone3)) {
            $msg_erro .= "Informe o Telefone do Cliente <br >";
        }

        if (empty($consumidor_email)) {
            $msg_erro .= "Informe o email do consumidor <br />";
        }
        if(strlen($consumidor_email) > 0){
            if(!filter_var($consumidor_email,FILTER_VALIDATE_EMAIL)){
                $msg_erro .= "O email do consumidor é inválido <br />";
            }
        }
    }

    if (in_array($login_fabrica, array(139,165))) {

        if ($login_fabrica != 165) {
            if (!strlen($consumidor_cpf) || $consumidor_cpf == "null") {
                #$msg_erro .= "Informe o CPF / CNPJ do Cliente <br>";
            }

            if (!strlen($consumidor_fone) && !strlen($consumidor_fone3)) {
                $msg_erro .= "Informe o Telefone do Cliente <br >";
            }

            if (!strlen($consumidor_fone) && !strlen($consumidor_fone3) && $login_fabrica != 139) {
                $msg_erro .= "Informe o Celular do Cliente <br >";
            }

            if ((!strlen(trim($_POST["nota_fiscal"])) || $_POST["nota_fiscal"] == "null") && $login_fabrica != 139) {
                $msg_erro .= "Informe a Nota Fiscal <br >";
            }

            if (!strlen(trim($_POST["data_nf"])) && $login_fabrica != 139) {
                $msg_erro .= "Informe a Data da Nota Fiscal <br >";
            }

        }

        /*if ($login_fabrica == 139) {
            if (!strlen(trim($_POST["cnpj_revenda"])) && !strlen(trim($_POST["nome_revenda"]))) {
                $msg_erro .= "Informe o cnpj ou nome da revenda <br >";
            }

            if (!strlen($consumidor_email)) {
                $msg_erro .= "Informe o Email do Cliente <br >";
            }
            if (!strlen(trim($_POST["produto_referencia"])) || !strlen(trim($_POST["produto_nome"]))) {
                $msg_erro .= "Informe a referência e descrição do produto <br >";
            }
        }*/
    }

    if($login_fabrica == 148){ //HD-2915463
        if (empty($consumidor_email)) {
            $msg_erro .= "Informe o email do consumidor <br />";
        }

        if(strlen($consumidor_email) > 0){
            if(!filter_var($consumidor_email,FILTER_VALIDATE_EMAIL)){
                $msg_erro .= "O email do consumidor é inválido <br />";
            }
        }
    }

    if (in_array($login_fabrica, [35])) {

        $cnpj_emitente_nf = $_POST["cnpj_emitente_nf"];
        $valor_ressarcimento_reembolso = trim(str_replace("R$", "", $_POST["valor_ressarcimento_reembolso"]));

        if (empty($cnpj_emitente_nf)) {

            $msg_erro .= "Informe o CNPJ emitente <br />";

        }

        if ($_POST["tab_atual"] == "reclamacao_produto" && !empty($hd_motivo_ligacao)) {

            $sqlVerificaReembolso = "SELECT hd_motivo_ligacao
                                     FROM tbl_hd_motivo_ligacao
                                     WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}
                                     AND (descricao = 'Ressarcimento'
                                     OR descricao = 'Reembolso ( boleto E-com)')";
            $resVerificaReembolso = pg_query($con, $sqlVerificaReembolso);

            if (pg_num_rows($resVerificaReembolso) > 0 && empty($valor_ressarcimento_reembolso)) {

                $msg_erro .= "Informe o valor do ressarcimento/reembolso <br />";

            }

        }

    }

    //hd-3624967 - fputti
    if (in_array($login_fabrica, array(171,174))) {
        if ($login_fabrica == 171){
            $pressao_agua_mca       = $_POST['pressao_agua_mca'];
            $projeto                = $_POST['projeto'];
            $tipo_atendimento_grohe = $_POST['tipo_atendimento_grohe'];

            $projeto = (empty($projeto)) ? 'f' : $projeto;

            if (empty($consumidor_email)) {
                $msg_erro .= "Informe o E-mail do Cliente <br>";
            }

            if (empty($consumidor_cpf) || $consumidor_cpf == "null") {
                $msg_erro .= "O CPF informado é inválido <br>";
            }

            if ((empty($consumidor_cpf_cnpj) || $consumidor_cpf_cnpj == "null") && empty($_GET['callcenter'])) {
                $msg_erro .= "Informe o CPF/CNPJ do Cliente <br>";
            }

            if (empty($consumidor_nome)) {
                $msg_erro .= "Informe o nome do consumidor <br />";
            }
        }

        if (!empty($_POST['produto_referencia']) && !in_array($login_fabrica, array(174,176))) {
            if (empty($defeito_reclamado)) {
                $msg_erro .= "Informe o Defeito Reclamado <br />";
            }
        }


        if ($login_fabrica == 174) {
            if((isset($_POST['abre_os']) AND $_POST['abre_os'] == 't')){
                if(strlen(trim($_POST["produto_referencia"])) == 0 OR strlen(trim($_POST["produto_nome"])) == 0){
                    $msg_erro .= "Informe o Produto <br/>";
                }

                if(strlen(trim($_POST["posto_nome_tab"])) == 0 OR strlen(trim($_POST["codigo_posto_tab"])) == 0){
                    $msg_erro .= "Informe os dados do Posto Autorizado <br/>";
                }
            }

            $obg = false;
            if ($_POST['valida_obrigatorio'] != 't'){  $obg = false; }
            if ($_POST['valida_obrigatorio'] != 't' && ($_POST['abre_os_check'] == 'true' || $_POST['abre_os'] == 'true')){ $obg = true; }
            if ($_POST['valida_obrigatorio'] == 't' || $_POST['abre_os_check'] == 'true'){  $obg = true; }
            if ($integracaoSocial) { $obg = false; }

            if ($obg === true)
            {
                if (empty($consumidor_cpf) || $consumidor_cpf == "null") {
                   # $msg_erro .= "Informe o CPF/CNPJ do Cliente <br>";
                }
                if (empty($consumidor_cep)) {
                    $msg_erro .= "Informe o cep do consumidor <br />";
                }

                if (empty($consumidor_endereco)) {
                    $msg_erro .= "Informe o endereco do consumidor <br />";
                }

                if (empty($consumidor_numero)) {
                    $msg_erro .= "Informe o número do consumidor <br />";
                }

                if (empty($consumidor_bairro)) {
                    $msg_erro .= "Informe o Bairro do consumidor <br />";
                }

                if (empty($consumidor_estado)) {
                    $msg_erro .= "Informe o Estado (UF) do consumidor <br />";
                }

                if (empty($consumidor_cidade)) {
                    if (($login_fabrica == 52 && $_POST["consumidor_pais"] == 'BR') || $login_fabrica != 52) {
                        $msg_erro .= "Informe a Cidade do consumidor <br />";
                    }
                }
            } else {
                if (empty($consumidor_nome)) {
                    $msg_erro .= "Informe o nome do consumidor <br />";
                }
            }
        } else {
            if (!$integracaoSocial) {
                if (empty($consumidor_cpf) || $consumidor_cpf == "null") {
                    $msg_erro .= "Informe o CPF/CNPJ do Cliente <br>";
                }
                if (empty($consumidor_cep)) {
                    $msg_erro .= "Informe o cep do consumidor <br />";
                }

                if (empty($consumidor_endereco)) {
                    $msg_erro .= "Informe o endereco do consumidor <br />";
                }

                if (empty($consumidor_numero)) {
                    $msg_erro .= "Informe o número do consumidor <br />";
                }

                if (empty($consumidor_bairro)) {
                    $msg_erro .= "Informe o Bairro do consumidor <br />";
                }

                if (empty($consumidor_estado)) {
                    $msg_erro .= "Informe o Estado (UF) do consumidor <br />";
                }

                if (empty($consumidor_cidade)) {
                    if (($login_fabrica == 52 && $_POST["consumidor_pais"] == 'BR') || $login_fabrica != 52) {
                        $msg_erro .= "Informe a Cidade do consumidor <br />";
                    }
                }
            }
        }

        if ($login_fabrica == 171){
            if (empty($consumidor_fone)) {
                $msg_erro .= "Informe o Telefone do consumidor <br />";
            }
            if (empty($consumidor_fone3)) {
                $msg_erro .= "Informe o Telefone Celular do consumidor <br />";
            }
            if(isset($_POST['abre_ordem_servico']) AND $_POST['abre_ordem_servico'] == 't' AND !empty($tipo_atendimento_grohe)){

                $sqlTipoAtendimento = "SELECT tipo_atendimento
                                       FROM tbl_tipo_atendimento
                                       WHERE tipo_atendimento = {$tipo_atendimento_grohe}
                                       AND km_google IS TRUE";
                $resTipoAtendimento = pg_query($con, $sqlTipoAtendimento);
                if (pg_num_rows($resTipoAtendimento) > 0) {
                    if(strlen(trim($_POST["data_agendamento_ordem"])) == 0){
                        $msg_erro .= "É necessário informar uma data de agendamento para abertura de Ordem de serviço <br/>";
                    }
                    if (strlen(trim($_POST['periodo'])) == 0){
                        $msg_erro .= "É necessário informar um perÃ­odo para o agendamento <br/>";
                    }
                }
            }
        }
    }
    if (in_array($login_fabrica, array(173))) {

        if (empty($consumidor_cpf) || $consumidor_cpf == "null") {
            $msg_erro .= "O CPF informado é inválido <br>";
        }

        if (empty($consumidor_cep)) {
            $msg_erro .= "Informe o cep do consumidor <br />";
        }

        if (empty($consumidor_endereco)) {
            $msg_erro .= "Informe o endereco do consumidor <br />";
        }

        if (empty($consumidor_numero)) {
            $msg_erro .= "Informe o número do consumidor <br />";
        }

        if (empty($consumidor_bairro)) {
            $msg_erro .= "Informe o Bairro do consumidor <br />";
        }

        if (empty($consumidor_fone) && empty($consumidor_fone2) && empty($consumidor_fone3)) {
            $msg_erro .= "Informe ao menos um Telefone do consumidor <br />";
        }

        if (!empty($_POST['produto_referencia'])) {

            if (empty($defeito_reclamado) && empty($hd_extra_defeito)) {
                $msg_erro .= "Informe o Defeito Reclamado <br />";
            }

        }
    }

    if (in_array($login_fabrica, array(174)))
    {
        if (empty($_POST["consumidor_revenda"])) {
            $msg_erro .= "Selecione o tipo do atendimento<br>";
        }

        if ($emitir_laudo == 't')
        {
            if (strlen($consumidor_nome) == 0) {
                $msg_erro .= "Por favor informe o nome do consumidor<br>";
            }
            if (strlen($consumidor_cpf) == 0) {
                $msg_erro .= "Por favor informe o cpf do consumidor<br>";
            }
            if (strlen($consumidor_email) == 0) {
                $msg_erro .= "Por favor informe o e-mail do consumidor<br>";
            }
            if(strlen($_POST["produto_referencia"]) == 0){
                $msg_erro .= "Por favor informe o Produto <br />";
            }

            if ($origem_nome != 'reclame aqui' || $origem_nome != 'Reclame Aqui')
            {
                if(strlen(trim($_POST["nota_fiscal"])) == 0){
                    $msg_erro .= "Informe a nota fiscal do Produto <br/>";
                }
                if(strlen(trim($_POST["cnpj_revenda"])) == 0 OR strlen(trim($_POST["nome_revenda"])) == 0){
                    $msg_erro .= "Informe os dados da Revenda <br/>";
                }
            }

        }

        /*HD - 4299566*/
        if (empty($_POST["origem"])) {
            $msg_erro .= "Selecione a origem do Atendimento <br>";
        }
    }

    if ($login_fabrica == 186){
         $sql = "SELECT obriga_campos from tbl_hd_classificacao where fabrica = $login_fabrica and hd_classificacao = ".$_POST['hd_classificacao'];
        $res = pg_query($con, $sql);
        if(pg_num_rows($res)>0){
            $obriga_campos = pg_fetch_result($res, 0, 'obriga_campos');
        }

        if (!$integracaoSocial && $obriga_campos == 't') {
            if (empty($consumidor_cpf) || $consumidor_cpf == "null") {
                $msg_erro .= "Informe o CPF/CNPJ <br>";
            }
            if (empty($consumidor_fone3) || $consumidor_fone3 == "null") {
                $msg_erro .= "Informe o Celular <br>";
            }

            if (empty($consumidor_cep)) {
                $msg_erro .= "Informe o cep do consumidor <br />";
            }

            if (empty($consumidor_endereco)) {
                $msg_erro .= "Informe o endereco do consumidor <br />";
            }

            if (empty($consumidor_numero)) {
                $msg_erro .= "Informe o número do consumidor <br />";
            }

            if (empty($consumidor_bairro)) {
                $msg_erro .= "Informe o Bairro do consumidor <br />";
            }
            if (empty($consumidor_cidade)) {
                $msg_erro .= "Informe o Cidade do consumidor <br />";
            }
            if (empty($consumidor_estado)) {
                $msg_erro .= "Informe o Estado do consumidor <br />";
            }

            if (empty($consumidor_estado)) {
                $msg_erro .= "Informe a providência do atendimento. <br />";
            }
        }
    }

    if (in_array($login_fabrica, [198])) {
        if ((isset($_POST['abre_os']) AND $_POST['abre_os'] == 't')) {
            if (strlen(trim($_POST["produto_referencia"])) == 0 OR strlen(trim($_POST["produto_nome"])) == 0) {
                $msg_erro .= "Informe o Produto <br/>";
            }

            if (strlen(trim($_POST["posto_nome_tab"])) == 0 OR strlen(trim($_POST["codigo_posto_tab"])) == 0) {
                $msg_erro .= "Informe os dados do Posto Autorizado <br/>";
            }
        }
    }

    if ($_POST["abre_os"] == 't') {

        $sql = "SELECT obriga_campos from tbl_hd_classificacao where fabrica = $login_fabrica and hd_classificacao = ".$_POST['hd_classificacao'];
        $res = pg_query($con, $sql);
        if(pg_num_rows($res)>0){
            $obriga_campos = pg_fetch_result($res, 0, 'obriga_campos');
        }

        if($obriga_campos == 't'){
            if (empty($consumidor_cpf) || $consumidor_cpf == "null") {
                $msg_erro .= "Informe o CPF/CNPJ <br>";
            }

            if (empty($consumidor_cep)) {
                $msg_erro .= "Informe o cep do consumidor <br />";
            }

            if (empty($consumidor_endereco)) {
                $msg_erro .= "Informe o endereco do consumidor <br />";
            }

            if (empty($consumidor_numero)) {
                $msg_erro .= "Informe o número do consumidor <br />";
            }

            if (empty($consumidor_bairro)) {
                $msg_erro .= "Informe o Bairro do consumidor <br />";
            }
            if (empty($consumidor_cidade)) {
                $msg_erro .= "Informe o Cidade do consumidor <br />";
            }
            if (empty($consumidor_estado)) {
                $msg_erro .= "Informe o Estado do consumidor <br />";
            }
            if ($_POST["abre_os"] == 't') {

                if (empty($consumidor_revenda)) {
                    $msg_erro .= "Informe o Tipo <br />";
                }
                if (empty($origem)) {
                    $msg_erro .= "Informe a Origem <br />";
                }
            }
        }

        if ($login_fabrica == 139) {
            $sql_linha_p =  "   SELECT  tbl_produto.linha AS linha_produto
                                FROM tbl_produto
                                JOIN tbl_posto_linha ON tbl_produto.linha = tbl_posto_linha.linha AND tbl_posto_linha.ativo                            
                                WHERE tbl_produto.fabrica_i = {$login_fabrica}
                                AND tbl_produto.referencia = '$produto_referencia'
                                AND tbl_posto_linha.posto = ".$_POST['posto_tab'];
            $res_linha_p =  pg_query($con, $sql_linha_p);
            
            if (pg_last_error()) {
                $msg_erro .= "Erro ao Buscar Linha do Posto e Produto. <br />";
            }
            
            if (pg_num_rows($res_linha_p) == 0) {
                $msg_erro .= "Posto não Atende a Linha do Produto. <br />";
            }
        }
    }

	if ($indicacao_posto == 't' and $login_fabrica <> 24) {

        $consumidor_nome    = 'Indicação de Posto';
        $consumidor_fone    = '00000000000';
        $consumidor_estado  = '00';
        $consumidor_cidade  = 'Indicação de Posto';
        $consumidor_revenda = 'Indicação de Posto';
        $origem             = 'Indicação de Posto';
        $consumidor_cpf     = '00000000000';
        $consumidor_cep     = '00000000';
        $produto_referencia = 'Indicação de Posto';
        $hora_ligacao       = '00:00';

    } else if ($indicacao_posto == 't' and $login_fabrica == 24) {

        if (strlen($_POST['produto_referencia']) == 0 or strlen($_POST['produto_nome']) == 0) {
            $msg_erro .= "Por favor, informe a referência e a descrição do Produto ";
        }

    }

    if ($login_fabrica == 24) {

        if ($pedir_produto) {

            if (strlen($_POST['produto_referencia']) == 0 or strlen($_POST['produto_nome']) == 0) {
                $msg_erro .= "Por favor, informe a referência e a descrição do Produto";
            }
        }
    }

    $consumidor_nome = substr($consumidor_nome, 0, 50);
    $consumidor_nome = preg_replace("/\t/","",$consumidor_nome);
    $xconsumidor_nome        = (strlen($consumidor_nome)==0)  ? "null" : "'".$consumidor_nome."'";
    
    if ($login_fabrica != 161 || ($login_fabrica == 161 && $_POST["consumidor_pais"] == 'BR')) {

        $valida_cpf_cnpj = verificaCpfCnpj(preg_replace("/\D/","",$consumidor_cpf));
        if(empty($valida_cpf_cnpj)){
            $xconsumidor_cpf     = (!is_numeric(checaCPF($consumidor_cpf)) and strlen(trim($consumidor_cpf)) != 0) ? "null" : "'".checaCPF($consumidor_cpf)."'";

            /*HD - 6277889*/
            $alterarCPFConsumidor = false;

            if ($login_fabrica == 151 && $xconsumidor_cpf != "null" and strlen($xconsumidor_cpf) > 0) {
                $aux_sql = "SELECT cpf FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter";
                $aux_res = pg_query($con, $aux_sql);
                $aux_row = pg_fetch_result($aux_res, 0, 'cpf');

                if (strlen($aux_row) > 0 && $aux_row != str_replace(array("'", '"'), "", $xconsumidor_cpf)) {
                    $alterarCPFConsumidor = true;
                    $CPFConsumidorAntigo  = $aux_row;
                    $CPFConsumidorNovo    = str_replace("'", "", $xconsumidor_cpf);
                }
            }
        }else{
            $msg_erro .= $valida_cpf_cnpj;
        }
    } else {
        $xconsumidor_cpf = "'".$consumidor_cpf."'";
    }

    $consumidor_fone  = preg_replace("/\D/","",$consumidor_fone);
    $consumidor_fone2 = preg_replace("/\D/","",$consumidor_fone2);
    $consumidor_fone3 = preg_replace("/\D/","",$consumidor_fone3);

    if(!empty($consumidor_email) and strtolower(trim($consumidor_email)) != "null") {
        $sql = "SELECT fn_valida_email('$consumidor_email',true)";
        $res = pg_query($con,$sql);
        if(pg_fetch_result($res,0,0) == 'f') {
            $msg_erro = "Email do consumidor inválido <br />";
        }
    }

    $xconsumidor_rg          = (strlen($consumidor_rg)          == 0) ? 'null' : "'$consumidor_rg'";
    $xconsumidor_email       = (strlen($consumidor_email)       == 0) ? 'null' : "'$consumidor_email'";
    $xconsumidor_fone        = (strlen($consumidor_fone)        == 0) ? 'null' : "'$consumidor_fone'";
    $xconsumidor_fone2       = (strlen($consumidor_fone2)       == 0) ? 'null' : "'$consumidor_fone2'";
    $xconsumidor_fone3       = (strlen($consumidor_fone3)       == 0) ? 'null' : "'$consumidor_fone3'";
    $xconsumidor_cep         = (strlen($consumidor_cep)         == 0) ? 'null' : "'$consumidor_cep'";
    $xconsumidor_endereco    = (strlen($consumidor_endereco)    == 0) ? 'null' : "'$consumidor_endereco'";
    $xconsumidor_numero      = (strlen($consumidor_numero)      == 0) ? 'null' : "'$consumidor_numero'";
    $xconsumidor_complemento = (strlen($consumidor_complemento) == 0) ? 'null' : "'$consumidor_complemento'";
    $xconsumidor_bairro      = (strlen($consumidor_bairro)      == 0) ? 'null' : "'$consumidor_bairro'";
    $xconsumidor_cidade      = (strlen($consumidor_cidade)      == 0) ? 'null' : "'$consumidor_cidade'";
    $xconsumidor_estado      = (strlen($consumidor_estado)      == 0) ? 'null' : "'$consumidor_estado'";

    if(empty($hd_chamado)) {

        if(in_array($login_fabrica,array(30,151))){
            $msg_erro .= valida_cep($consumidor_cep);
            $msg_erro .= valida_celular($consumidor_fone3);
        }else if ($login_fabrica != 161 || ($login_fabrica == 161 && $consumidor_pais == 'BR')){
            $msg_erro .= valida_celular($consumidor_fone3);
        }
    }

    if(in_array($login_fabrica,array(169,170))){
        
        if(!empty($tipo_protocolo)){

            $sqlTipoProtocolo = "SELECT * FROM tbl_hd_tipo_chamado WHERE hd_tipo_chamado = {$tipo_protocolo} AND fabrica = {$login_fabrica} AND lower(fn_retira_especiais(descricao)) = 'ecommerce' ";
            $resTipoProtocolo = pg_query($con,$sqlTipoProtocolo);

            if(pg_num_rows($resTipoProtocolo) > 0){

                $camposProtocoloEcommerce = true;

                $msg_erro = pg_last_error();

                #$msg_erro .= (strlen($consumidor_cpf) == 0) ? "Informe o CPF/CNPJ do consumidor <br>" : $valida_cpf_cnpj;
                #$msg_erro .= (strlen($consumidor_nome) == 0) ? "Informe o nome do consumidor <br>" : "";
                #$msg_erro .= (strlen($consumidor_fone) == 0 && strlen($consumidor_fone2) == 0 && strlen($consumidor_fone3) == 0) ? "Informe pelo menos um número de telefone<br>" : "";
                #$msg_erro .= (strlen($consumidor_email) == 0) ? "Informe o E-mail do consumidor<br>" : "";
                #$msg_erro .= (strlen($consumidor_cep) == 0) ? "Informe o CEP do consumidor<br>" : "";
                #$msg_erro .= (strlen($consumidor_endereco) == 0) ? "Informe o endereço do consumidor<br>" : "";
                #$msg_erro .= (strlen($consumidor_numero) == 0) ? "Informe o número do endereço do consumidor<br>" : "";
                #$msg_erro .= (strlen($consumidor_bairro) == 0) ? "Informe o bairro do consumidor<br>" : "";
                #$msg_erro .= (strlen($consumidor_cidade) == 0) ? "Informe a cidade do consumidor<br>" : "";
                #$msg_erro .= (strlen($consumidor_estado) == 0) ? "Informe o estado do consumidor<br>" : "";
                $msg_erro .= (strlen($origem) == 0) ? "Informe a Origem do atendimento<br>" : "";
                $msg_erro .= (strlen($_POST['hd_classificacao']) == 0) ? "Informe a Classificação do atendimento<br>" : "";
                $msg_erro .= (strlen($_POST['hd_motivo_ligacao_informacao']) == 0) ? "Informe a Providência do atendimento<br>" : "";
                $msg_erro .= (strlen($_POST['pedido_ecommerce']) == 0) ? "Informe o número do pedido<br>" : "";
                #$msg_erro .= (strlen($_POST['produto_referencia']) == 0) ? "Informe o produto<br>" : "";
                #$msg_erro .= (strlen($_POST['cnpj_revenda']) == 0) ? "Informe a revenda<br>" : "";
                #$msg_erro .= (strlen($_POST['nota_fiscal']) == 0) ? "Informe o número da nota fiscal<br>" : "";
                #$msg_erro .= (strlen($_POST['data_nf']) == 0) ? "Informe a data da nota fiscal<br>" : "";
                #$msg_erro .= (strlen($_POST['reclamacao_informacao']) == 0) ? "Preencha o campo Informação<br>" : "";
            }

        }
    }

    if ($login_fabrica == 52) {

        if (!empty($_POST['ponto_referencia'])) {
            $xconsumidor_ponto_referencia   = "'".trim($_POST['ponto_referencia'])."'";
        } else {
            $xconsumidor_ponto_referencia = 'null';
        }

        $campos_adicionais2 = array();

		if (!empty($_POST['operadora_celular'])){
			$campos_adicionais2["operadora"]		 		= trim($_POST['operadora_celular']);
		}else{
			$campos_adicionais2["operadora"]		 		= "";
		}
	}

    if ($login_fabrica == 183){
        if (!empty($_POST['ponto_referencia'])) {
            $xconsumidor_ponto_referencia   = "'".trim($_POST['ponto_referencia'])."'";
        } else {
            $xconsumidor_ponto_referencia = 'null';
        }
    }

    if($login_fabrica == 30){
        $dadosDiferenteEsmaltec = $_POST["dadosDiferenteEsmaltec"];
        $anexoEsmaltec = $_POST["anexoEsmaltec"];

        if(strlen(trim($anexoEsmaltec))==0 and $dadosDiferenteEsmaltec == true){
            $msg_erro .= "Informe o anexo da nota fiscal <br>";
        }
    }

    if (in_array($login_fabrica,array(3,24,35,85,94,129,145,151,157,161)) || ($login_fabrica == 5 && $indicacao_posto == 'f') || in_array($login_fabrica, [169,170]) && $camposProtocoloEcommerce != true) {//HD 48900 58796
        if (!in_array($login_fabrica,array(35,94,145,157,162,161))) {

            if (strlen($consumidor_nome) == 0 && $desbloqueia_obrigatorios === false) {
                $msg_erro .= "Por favor inserir o nome do consumidor<br> ";
            } else {
                $consumidor_nome = substr($consumidor_nome, 0, 50);
            }

            if (strlen($consumidor_cep) == 0 && !in_array($login_fabrica,array(24,85,169,170))) {
                $msg_erro .= "Por favor inserir o CEP do consumidor <br>";
            }

            if (strlen($consumidor_bairro) == 0 && $desbloqueia_obrigatorios === false) {
                if (in_array($login_fabrica, array(169,170))){
                    if ($origem_nome != 'email' AND $tab_atual != 'sugestao'){
                        $msg_erro .= "Por favor inserir o bairro do consumidor <br>";
                    }
                }else{
                    $msg_erro .= "Por favor inserir o bairro do consumidor <br>";
                }
            }

            if (strlen($consumidor_endereco) == 0 && $desbloqueia_obrigatorios === false) {
                if (in_array($login_fabrica, array(169,170))){
                    if ($origem_nome != 'email' AND $tab_atual != 'sugestao'){
                        $msg_erro .= "Por favor inserir o endereco do consumidor <br>";
                    }
                }else{
                    $msg_erro .= "Por favor inserir o endereco do consumidor <br>";
                }
            }

            if (strlen($consumidor_numero) == 0 AND $login_fabrica == 151) {
                $msg_erro .= "Por favor inserir o número do consumidor <br>";
            }

            if (strlen($consumidor_fone) == 0 AND $login_fabrica != 151 AND $login_fabrica != 169 AND $login_fabrica != 170) {
                if($login_fabrica == 85){
                    if(strlen($_POST['consumidor_fone3'] == 0)){
                         $msg_erro .= "Por favor inserir o telefone do consumidor <br>";
                    } 
                }else{
                    $msg_erro .= "Por favor inserir o telefone do consumidor <br>";
                }
            }

            if(in_array($login_fabrica, array(169,170))){
                $setor_atividade = $_POST["setor_atividade"];
                $garantia_estendida = $_POST["garantia_estendida"];
                $os_cortesia = $_POST['os_cortesia'];

                if(strlen(trim($consumidor_cpf)) == 0 OR $consumidor_cpf == "null" AND $origem_nome != "email"){
                    if ($tab_atual != 'onde_comprar' AND $tab_atual != 'sugestao' AND $tab_atual != 'duvida_produto'
                        AND $tab_atual != 'indicacao_at' AND $tab_atual != 'informacao'){
                        $msg_erro .= "Informe o CPF do Cliente <br>";
                    }
                }

                if (($tab_atual == 'onde_comprar' OR $tab_atual == 'duvida_produto' OR $tab_atual == 'indicacao_at') && $desbloqueia_obrigatorios === false){
                    if(strlen(trim($_POST["produto_referencia"])) == 0 OR strlen(trim($_POST["produto_nome"])) == 0){
                        $msg_erro .= "Informe o Produto <br/>";
                    }
                }

                if((isset($_POST['abre_os']) AND $_POST['abre_os'] == 't') OR (isset($_POST['abre_ordem_servico']) AND $_POST['abre_ordem_servico'] == 't')){
                    if(strlen(trim($_POST["produto_referencia"])) == 0 OR strlen(trim($_POST["produto_nome"])) == 0){
                        $msg_erro .= "Informe o Produto <br/>";
                    }

                    if(strlen(trim($_POST['defeito_reclamado'])) == 0){
                        $msg_erro .= "Selecione o defeito reclamado <br/>";
                    }

                    if(strlen(trim($_POST["nota_fiscal"])) == 0){
                        $msg_erro .= "Informe a nota fiscal do Produto <br/>";
                    }

                    if(strlen(trim($data_nf)) == 0){
                        $msg_erro .= "Informe a data da nota fiscal do Produto <br/>";
                    }

                    if(strlen(trim($_POST["cnpj_revenda"])) == 0 OR strlen(trim($_POST["nome_revenda"])) == 0){
                        $msg_erro .= "Informe os dados da Revenda <br/>";
                    }

                    if (!strlen(trim($_POST["posto_nome_tab"]))) {
                        $_POST["posto_nome_tab"] = $_POST["posto_nome"];
                    }

                    if (!strlen(trim($_POST["codigo_posto_tab"]))) {
                        $_POST["codigo_posto_tab"] = $_POST["codigo_posto"];
                    }

                    if(strlen(trim($_POST["posto_nome_tab"])) == 0 OR strlen(trim($_POST["codigo_posto_tab"])) == 0){
                        if ($_POST['bloqueia_campos_dealer'] == 'true'){
                            $msg_erro .= "O DEALER efetuou tentativa de abertura de O.S na Central de Relacionamento da Midea Carrier <br/>
                                        ORIENTAÇÕES - Abertura de O.S Dealer com privilégios de acesso - alterar classificação do atendimento.<br/>";
                        }else{
                            $msg_erro .= "Informe os dados do Posto Autorizado <br/>";
                        }
                    } else {
                        $sqlPosto = "SELECT posto FROM tbl_posto_fabrica WHERE fabrica = $login_fabrica AND UPPER(codigo_posto) = UPPER('{$_POST['codigo_posto_tab']}')";
                        $resPosto = pg_query($con, $sqlPosto);
                        $resPosto = pg_fetch_assoc($resPosto);

                        if (empty($resPosto)) {
                            $msg_erro = "Erro ao buscar informações do Posto Autorizado<br />";
                        }
                    }

                    if(strlen(trim($_POST["data_agendamento_ordem"])) == 0){
                        $msg_erro .= "É necessário informar uma data de agendamento para abertura de Ordem de serviço <br/>";
                    }

                    if(isset($_POST['abre_ordem_servico']) AND $_POST['abre_ordem_servico'] == 't'){
                        if(strlen(trim($_POST["periodo"])) == 0){
                            $msg_erro .= "É necessário informar um perí­odo para o agendamento <br/>";
                        }
                    }
                }

                /*if(strlen(trim($transferir)) > 0){
                    $sql_prazo_dias = "SELECT prazo_dias FROM tbl_hd_motivo_ligacao
                                        WHERE fabrica = {$login_fabrica} AND hd_motivo_ligacao = '{$hd_motivo_ligacao}' AND prazo_dias = 0";
                    $res_prazo_dias = pg_query($con, $sql_prazo_dias);
                    if(pg_num_rows($res_prazo_dias) > 0){
                        $msg_erro .= " Não pode ser realizado uma transferência do atendimento para a providência selecionada ";
                    }
                }*/

                if(strlen(trim($consumidor_numero)) == 0 AND $origem_nome != 'email'){
                    if ($tab_atual != 'onde_comprar' AND $tab_atual != 'sugestao' AND $tab_atual != 'duvida_produto'
                        AND $tab_atual != 'indicacao_at' AND $tab_atual != 'informacao'){
                        $msg_erro .= "Por favor inserir o número do consumidor <br>";
                    }
                }

                if(strlen(trim($script_falha)) > 0){
                    $script_falha = $_POST['script_falha'];
                }

                if(strlen(trim($_POST['json_script'])) > 0){
                    $json_script = $_POST['json_script'];
                }

                if(strlen(trim($_POST['json_execucao_script'])) > 0){
                    $json_execucao_script = $_POST['json_execucao_script'];
                }

                if(strlen(trim($_POST['familia_script'])) > 0){
                    $familia_script = $_POST['familia_script'];
                }

                if(strlen(trim($_POST['script_resolution'])) > 0){
                    $script_resolution = $_POST['script_resolution'];
                }
                if(strlen(trim($_POST['ultima_pergunta_script'])) > 0){
                    $ultima_pergunta_script = $_POST['ultima_pergunta_script'];
                }
                if(strlen(trim($_POST['ultima_resposta_script'])) > 0){
                    $ultima_resposta_script = $_POST['ultima_resposta_script'];
                }
                if(strlen(trim($_POST['ultima_instrucao_script'])) > 0){
                    $ultima_instrucao_script = $_POST['ultima_instrucao_script'];
                }

                $valida_senha_supervisor = $_POST["valida_senha_supervisor"];
                $admin_supervisor = $_POST["admin_supervisor"];

                $tem_jornada = $_POST['tem_jornada'];

                if(strlen(trim($consumidor_fone3)) == 0 && $origem_nome != 'email'){
                    $msg_erro .= "Por favor inserir o celular do consumidor <br>";
                }
                if(strlen(trim($_POST["hd_classificacao"])) == 0){
                    $msg_erro .= "Por favor selecionar uma classificação para o atendimento <br>";
                }

                if(strlen(trim($_POST["reclamado_produto"])) == 0 AND $tab_atual == 'reclamacao_produto'){
                    $msg_erro .= "Por favor preencher o campo Informações Complementares <br>";
                }

                if (!empty($_POST["hd_classificacao"]) && empty($_POST["script_resolution"])) {

                    $hd_classificacao = $_POST["hd_classificacao"];

                    if(strlen(trim($produto)) > 0 AND strlen(trim($defeito_reclamado)) > 0){
                        $sql = "SELECT tbl_familia.familia
                                FROM tbl_produto
                                JOIN tbl_familia ON tbl_familia.familia = tbl_produto.familia AND tbl_familia.fabrica = {$login_fabrica}
                                WHERE fabrica = {$login_fabrica}
                                AND produto = {$produto}";
                        $res = pg_query($con, $sql);
                        $id_familia = pg_fetch_result($res, 0, 'familia');

                        $sqlScript = "
                            SELECT script_falha FROM tbl_script_falha
                            WHERE familia = {$id_familia}
                            AND defeito_reclamado = {$defeito_reclamado}
                            AND fabrica = {$login_fabrica}
                        ";

                        $resScript = pg_query($con, $sqlScript);

                        if(pg_num_rows($resScript) > 0){
                            $sqlScriptObrigatorio = "
                                SELECT hd_classificacao
                                FROM tbl_hd_classificacao
                                WHERE fabrica = {$login_fabrica}
                                AND hd_classificacao = {$hd_classificacao}
                                AND script_falha IS TRUE
                            ";
                            $resScriptObrigatorio = pg_query($con, $sqlScriptObrigatorio);

                            if (pg_num_rows($resScriptObrigatorio)) {
                                $msg_erro .= "Para a classificação selecionada é obrigatório a finalização do script de falha<br />";
                            }
                        }
                    }
                }

                switch($_POST["tab_atual"]) {
                        case "reclamacao_produto":
                            $hd_motivo_ligacao = $_POST["hd_motivo_ligacao"];
                            $hd_providencia_callcenter = $_POST["providencia_nivel3_reclamacao_produto"];
                            break;

                        case "reclamacao_empresa":
                            $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_reclamacao_empresa"];
                            $hd_providencia_callcenter = $_POST["providencia_nivel3_reclamacao_empresa"];
                            break;

                        case "reclamacao_at":
                            $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_reclamacao_at"];
                            $hd_providencia_callcenter = $_POST["providencia_nivel3_reclamacao_at"];
                            break;

                        case "duvida_produto":
                            $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_duvida_produto"];
                            $hd_providencia_callcenter = $_POST["providencia_nivel3_duvida_produto"];
                            break;

                        case "sugestao":
                            $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_sugestao"];
                            $hd_providencia_callcenter = $_POST["providencia_nivel3_sugestao"];
                            break;

                        case "onde_comprar":
                            $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_onde_comprar"];
                            $hd_providencia_callcenter = $_POST["providencia_nivel3_onde_comprar"];
                            break;

                        case "indicacao_at":
                            $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_indicacao_at"];
                            $hd_providencia_callcenter = $_POST["providencia_nivel3_indicacao_at"];
                            break;

                        case "informacao":
                            $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_informacao"];
                            $hd_providencia_callcenter = $_POST["providencia_nivel3_informacao"];
                            break;

                        default:
                            $hd_motivo_ligacao = null;
                            break;
                }

                if (!empty($hd_motivo_ligacao)) {
                    $os = $_POST["os"];

                    $sqlOsObrigatoria = "
                        SELECT os_obrigatoria
                        FROM tbl_hd_motivo_ligacao
                        WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}
                        AND os_obrigatoria IS TRUE
                    ";
                    $resOsObrigatoria = pg_query($con, $sqlOsObrigatoria);

                    if (pg_num_rows($resOsObrigatoria) > 0 && empty($os)) {
                        $msg_erro .= "Para a providência selecionada é obrigatório vincular uma ordem de serviço<br />";
                    }
                }
            }

            if (strlen($consumidor_fone3) == 0 AND $login_fabrica == 151) {
                $msg_erro .= "Por favor inserir o celular do consumidor <br>";
            }

            if (strlen($consumidor_estado) == 0 && $desbloqueia_obrigatorios === false) {
                if (in_array($login_fabrica, array(169,170))){
                    if ($origem_nome != "email" AND $tab_atual != 'sugestao'){
                        $msg_erro .= "Por favor selecione o estado <br>";
                    }
                }else{
                    $msg_erro .= "Por favor selecione o estado <br>";
                }
            }

            if (strlen($consumidor_cidade) == 0 && $desbloqueia_obrigatorios === false) {
                if (in_array($login_fabrica, array(169,170))){
                    if ($origem_nome != 'email' AND $tab_atual != 'sugestao'){
                        $msg_erro .= "Por favor inserir a cidade <br>";
                    }
                }else{
                    $msg_erro .= "Por favor inserir a cidade <br>";
                }
            }

            if (strlen(trim($_POST['consumidor_revenda'])) == 0) {
                if (in_array($login_fabrica, array(169,170))){
                    if ($origem_nome != 'email'){
                        if ($tab_atual != 'onde_comprar' AND $tab_atual != 'sugestao' AND $tab_atual != 'duvida_produto' AND $tab_atual != 'indicacao_at' AND $tab_atual != 'informacao'){
                            $msg_erro .= "Por favor selecione o tipo (Consumidor ou Revenda) <br>";
                        }
                    }
                }else{
                    $msg_erro .= "Por favor selecione o tipo (Consumidor ou Revenda) <br>";
                }
            }

            if (strlen(trim($_POST['origem'])) == 0) {
                $msg_erro .= "Por favor selecione a origem <br>";
            }

            if(!in_array($login_fabrica, array(169,170))){
                if (strlen(trim($_POST['consumidor_email'])) > 0) {
                    $valida_email = filter_var(trim($_POST['consumidor_email']),FILTER_VALIDATE_EMAIL);
                    if($valida_email === false){
                        $msg_erro .= "O email informado não é válido! <br>";
                    }
                }elseif(in_array($login_fabrica, array(151))) {
                    $msg_erro .= "Por favor inserir o e-mail do consumidor<br>";
                }
            }


            if ($login_fabrica == 148) {
                if (strlen($consumidor_fone) == 0) {
                    $msg_erro .= "Por favor inserir o telefone do consumidor <br>";
                }
            }

            if(in_array($login_fabrica, array(151))){
                if(empty($valida_cpf_cnpj)){
                    if (checaCPF($_POST['consumidor_cpf'],false) === false) {
                        $msg_erro .= "Por favor inserir o CPF do consumidor <br/>";
                    }
                }else{
                    $msg_erro .= $valida_cpf_cnpj;
                }
            }
        }

        if (in_array($login_fabrica,array(35,85,94,129,145,157,161)) && strlen($msg_erro) == 0) {
            $disparar_pesquisa = $_POST["disparar_pesquisa"];
            if($disparar_pesquisa == 't' && strlen($consumidor_email) > 0){
                $xenvia_email = "'t'";
                $valida_email = filter_var($consumidor_email,FILTER_VALIDATE_EMAIL);
                if($valida_email === false){
                    $msg_erro .= "O email informado não é válido para envio de pesquisa de satisfação ";
                }else{


                    if (in_array($login_fabrica, [35,157])) {
                        $condCategoria = " AND categoria = 'callcenter_email'";

                        $sqlEXT = "SELECT array_campos_adicionais
                                  FROM tbl_hd_chamado_extra
                                 WHERE hd_chamado = {$callcenter}";
                        $resEXT = pg_query($con,$sqlEXT);
                        if (pg_num_rows($resEXT) > 0) {
                            $arr_campos_add = json_decode(pg_fetch_result($resEXT, 0, 'array_campos_adicionais'), 1);
                            $arr_campos_add["disparado_pesquisa_email"] = "true";

                            $sqlEXTUP = "UPDATE  tbl_hd_chamado_extra
                                            SET array_campos_adicionais='".json_encode($arr_campos_add)."'
                                          WHERE hd_chamado = {$callcenter}";
                            $resEXTUP = pg_query($con, $sqlEXTUP);
                        }
                    } else {
                        $condCategoria = " AND categoria = 'externo'";
                    }

                    $sql = "SELECT pesquisa
                              FROM tbl_pesquisa
                             WHERE fabrica = {$login_fabrica}
                                   {$condCategoria}
                               AND ativo IS TRUE";
                    $res = pg_query($con,$sql);
                    if (pg_num_rows($res) == 0) {
                        $msg_erro .= "Não foi identificado nenhuma pesquisa da categoria 'Callcenter - E-mail' cadastrada!<br>";
                    }else{
                        $link_temp = explode("admin/",$HTTP_REFERER);

                        switch($login_fabrica){
                            case 85:
                                $from_fabrica           = "suporte@gelopar.com.br";
                                $from_fabrica_descricao = "Pós-Venda Gelopar";
                                $link_pesquisa = $link_temp[0]."externos/gelopar/callcenter_pesquisa_satisfacao2.php?atendimento=$hd_chamado";
                                $assunto  = "Pesquisa de Satisfação - GELOPAR";
                                break;
                            case 94:
                                #$from_fabrica           = "suporte@everest.ind.br";
                                $from_fabrica           = "no_reply@telecontrol.com.br";
                                $from_fabrica_descricao = "Pós-Venda Everest";
                                $link_pesquisa = $link_temp[0]."externos/everest/callcenter_pesquisa_satisfacao2.php?atendimento=$hd_chamado";
                                $assunto  = "Pesquisa de Satisfação - EVEREST";
                                break;
                            case 129:
                                $from_fabrica           = "no_reply@telecontrol.com.br";
                                $from_fabrica_descricao = "Pós-Venda Rinnai";
                                $link_pesquisa = $link_temp[0]."externos/rinnai/callcenter_pesquisa_satisfacao2.php?atendimento=$hd_chamado";
                                $assunto  = "Pesquisa de Satisfação - Rinnai";
                                break;
                            case 145:
                                $from_fabrica           = "no_reply@telecontrol.com.br";
                                $from_fabrica_descricao = "Pós-Venda Fabrimar";
                                $link_pesquisa = $link_temp[0]."externos/fabrimar/callcenter_pesquisa_satisfacao2.php?atendimento=$hd_chamado";
                                $assunto  = "Pesquisa de Satisfação - Fabrimar";
                                break;
                            case 157:

                                $tokenPes = sha1($login_fabrica.$hd_chamado);

                                if ($_serverEnvironment == 'development') {
                                    $urlPes = "https://novodevel.telecontrol.com.br/~kaique/PosVenda/externos/pesquisa_satisfacao_callcenter.php?token={$tokenPes}&callcenter={$hd_chamado}&tipo=callcenter_email";
                                } else {
                                    $urlPes = "https://posvenda.telecontrol.com.br/assist/externos/pesquisa_satisfacao_callcenter.php?token={$tokenPes}&callcenter={$hd_chamado}&tipo=callcenter_email";
                                }

                                $from_fabrica           = "no_reply@telecontrol.com.br";
                                $from_fabrica_descricao = "Pós-Venda Wap";
                                $link_pesquisa = $urlPes;
                                $assunto  = "Pesquisa de Satisfação - Wap";
                                break;
                            case 161:
                                $from_fabrica           = "no_reply@telecontrol.com.br";
                                $from_fabrica_descricao = "Pós-Venda Cristófoli";
                                $link_pesquisa = $link_temp[0]."externos/cristofoli/callcenter_pesquisa_satisfacao2.php?atendimento=$hd_chamado";
				$assunto  = "Pesquisa de Satisfação - Cristófoli";
				$emails = array($consumidor_email,"silvia@cristofoli.com");
                                break;
                        }

                        $mensagem = "Produto: $produto_referencia - $produto_nome <br>";
                        $mensagem .= "Protocolo: $hd_chamado, <br>";
                        $mensagem .= "Prezado(a) $consumidor_nome, <br>";
                        $mensagem .= "Sua opinião é muito importante para melhorarmos nossos serviços<br>";
                        $mensagem .= "Por favor, faça uma avaliação sobre nossos produtos e atendimento através do link abaixo: <br />";
                        $mensagem .= "Pesquisa de Satisfação: <a href='$link_pesquisa' target='_blank'>Acesso Aqui</a>
                        <br><br>Att <br>Equipe ".$login_fabrica_nome;

                        $headers  = "MIME-Version: 1.0 \r\n";
                        $headers .= "Content-type: text/html \r\n";
                        $headers .= "From: $from_fabrica_descricao <no_reply@telecontrol.com.br> \r\n";

                        //$headers .= "To: $consumidor_nome <$consumidor_email> \r\n";
                        #mail($consumidor_nome .'<'.$consumidor_email.'>', $assunto, utf8_encode($mensagem), $headers);
                        #$consumidor_email
			if($login_fabrica != 161){
				$emails[] =  $consumidor_email;
			}
                        $mailTc = new TcComm($externalId);

                        $res = $mailTc->sendMail(
                            $emails,
                            $assunto,
                            $mensagem,
                            "no_reply@telecontrol.com.br"
                        );

                        $sql = "INSERT INTO tbl_hd_chamado_item(
                            hd_chamado   ,
                            data         ,
                            comentario   ,
                            admin        ,
                            interno      ,
                            status_item
                        ) values (
                            $callcenter       ,
                            current_timestamp ,
                            'Foi enviado um E-mail para o consumidor com a pesquisa de satisfação',
                            $login_admin      ,
                            't'               ,
                            $xstatus_interacao
                        )";
                        $res = pg_query($con,$sql);
                    }

                }
            }else if(in_array($login_fabrica, [35])){
                $transferir_consumidor = $_POST["transferir_consumidor"];
                if (strlen($transferir_consumidor) > 0 ){
                    $valida_email = filter_var($consumidor_email,FILTER_VALIDATE_EMAIL);

                    if($valida_email === false){
                        $msg_erro .= " O email informado não é válido para envio do e-mail. ";
                    }

                    $valida_cpf_cnpj = verificaCpfCnpj(preg_replace("/\D/","",$consumidor_cpf));
                    if(empty($valida_cpf_cnpj) AND strlen($msg_erro) == 0){
                        $variavel = md5($callcenter.$consumidor_cpf);

                        $link_temp = explode("admin/",$HTTP_REFERER);
                        $from_fabrica           = "no_reply@telecontrol.com.br";
                        $from_fabrica_descricao = "Pós-Venda CADENCE";
                        $link_pesquisa = $link_temp[0]."externos/callcenter/callcenter_resposta.php?x=$variavel";
                        $assunto  = "Responder ao atendimento - CADENCE";
                        $mensagem = "Produto: $produto_referencia - $produto_nome <br>";
                        $mensagem .= "Protocolo: $callcenter , <br> <br>";
                        $mensagem .= "Prezado(a) $consumidor_nome, <br> <br>";
                        $mensagem .= "$resposta <br> <br> Protocolo:$callcenter <br> CPF: $consumidor_cpf <br> <br>";
                        $mensagem .= "Para responder esse atendimento por favor acesse o link $link_pesquisa <br>";

                        $mailTc->setEmailSubject($assunto);
                        $mailTc->addToEmailBody($mensagem);
                        $mailTc->setEmailFrom($externalEmail);
                        $mailTc->addEmailDest($consumidor_email);
                        $resultado = $mailTc->sendMail();

                        $sql = "INSERT INTO tbl_hd_chamado_item(
                            hd_chamado   ,
                            data         ,
                            comentario   ,
                            admin        ,
                            status_item
                        ) values (
                            $callcenter       ,
                            current_timestamp ,
                            'Foi enviado um E-mail para o consumidor responder ao atendimento',
                            $login_admin      ,
                            $xstatus_interacao
                        )";
                    $res = pg_query($con,$sql);
                    }else{
                        $msg_erro .= $valida_cpf_cnpj;
                    }
                }
            }else if(in_array($login_fabrica,array(35,85,94,129,145,157,161)) && ($disparar_pesquisa == 't' && strlen($consumidor_email) == 0)){
                $msg_erro .= "Favor digitar um email do consumidor para envio de pesquisa de satisfação ";
            }
        }
        if ($login_fabrica == 5) { // HD 59786
            $valida_cpf_cnpj = verificaCpfCnpj(preg_replace("/\D/","",$_POST['consumidor_cpf']));

            if(empty($valida_cpf_cnpj)){
                if (checaCPF($_POST['consumidor_cpf'],false) === false) {
                    $msg_erro .= "Por favor inserir o CPF do consumidor ";
                }
            }else{
                $msg_erro .= $valida_cpf_cnpj;
            }

            if (strlen(trim($_POST['consumidor_cep'])) == 0) {
                $msg_erro .= "Por favor inserir CEP do consumidor ";
            }

            if (strlen($_POST["produto_referencia"]) == 0) {
                $msg_erro .= "Por favor, insira a referência do produto ";
            }

		}
	} else if ($indicacao_posto == 'f' && !in_array($login_fabrica, array(125,161,162,164,175,183))) {
        if (!in_array($login_fabrica, $fabricas_validam_campos_obrigatorios)) {

            if (strlen($consumidor_nome) == 0 AND !in_array($login_fabrica, [169,170,176])) {
                $msg_erro .= "Informe o nome do consumidor<br>";
            }

	    if ($login_fabrica == 178 && $consumidor_cpf_cnpj == "R") {
		if (empty($consumidor_rg)) {
		    $msg_erro .= "Por favor informe a Inscrição Estadual <br />";
		}
	    }

            if($login_fabrica == 42){
                $consumidor_tipo_contato = $_POST["consumidor_tipo_contato"];

                if(empty($consumidor_tipo_contato)){
                    $msg_erro .= "Por favor insira a referência do atendimento. ";
                }
            }

            if (in_array($login_fabrica, [177])) {
                if (strlen($consumidor_fone3) == 0 && strlen($consumidor_fone) == 0) {
                    $msg_erro .= "Por favor informe o Celular ou Telefone do consumidor<br>";
                }


                if (!empty($_POST["produto_referencia"])) {
                    if (empty($hd_extra_defeito) AND empty($defeito_reclamado)) {
                        $msg_erro .= "Informe o Defeito Reclamado e Informe a Reclamação do Cliente <br />";
                    } else if (empty($hd_extra_defeito)) {
                        $msg_erro .= "Informe a Reclamação do Cliente <br />";
                    } else if (empty($defeito_reclamado)) {
                        $msg_erro .= "Informe o Defeito Reclamado <br />";
                    }

                    if (!empty($_POST["produto_referencia"]) && empty($defeito_reclamado)) {
                        $msg_erro .= "Informe o Defeito Reclamado <br />";
                    }
                }
            }

            if (!$integracaoSocial) {
                if (!in_array($login_fabrica,[174]) OR $obg !== false) {

                    if (!in_array($login_fabrica,array(163,167,176,178,183,184,186,195,200,203))) {
                        if (($login_fabrica == 52 && $consumidor_pais == 'BR') || !in_array($login_fabrica, array(52,139))) {

                            if (strlen($consumidor_nome) > 0 and strlen($consumidor_estado) == 0) {
                                $msg_erro .= "Por favor selecione o estado <br>";
                            }
                        } else {
                            if (strlen($consumidor_estado) == 0 || empty($consumidor_estado)) {
                                $consumidor_estado = 'null';
                            }
                        }

                        if (($login_fabrica == 52 && $consumidor_pais == 'BR') || !in_array($login_fabrica, array(52,139))) {
                            if (strlen($consumidor_nome) > 0 and strlen($consumidor_cidade) == 0) {
                                $msg_erro .= "Por favor inserir a cidade<br>";
                            }
                        } else {
                            if (strlen($consumidor_estado) == 0 || empty($consumidor_estado)) {
                                $consumidor_cidade = 'null';
                            }
                        }
                    } else {
                        if (strlen($consumidor_nome) > 0 and strlen($consumidor_fone) == 0  AND !in_array($login_fabrica, array(176,178,184,186,195,200)) ) {
                            if($login_fabrica == 85){
                               if(strlen($_POST['consumidor_fone3'] == 0)){
                                    $msg_erro .= "Por favor inserir o telefone do consumidor <br>";
                               } 
                            }else{
                                $msg_erro .= "Por favor inserir o telefone do consumidor <br>";
                            }
                        }
                    }
                }
            }
        }

        /*HD-4260075*/
        if ((in_array($login_fabrica, array(160)) or $replica_einhell)) {
            if (empty($_POST["origem"])) {
                $msg_erro .= "Por favor selecione a origem <br>";
            }
        }
    } else if(in_array($login_fabrica, array(161,162,164))){
        if($login_fabrica != 161){
            if (strlen(trim($consumidor_nome)) == 0) {
                $msg_erro .= "Por favor informe o nome do consumidor<br>";
            }

            if(strlen(trim($_POST['consumidor_cpf']))==0){
                $msg_erro .= "Por favor informe o CPF do consumidor<br>";
            }

            if(in_array($login_fabrica, array(164))){
                if(strlen($_POST["produto_referencia"]) > 0 && strlen($_POST["defeito_reclamado"]) == 0){
                    $msg_erro .= "Por favor informe o Defeito Reclamado <br />";
                }
            }

        }

        if($login_fabrica == 161){

            if($tab_atual == "reclamacao_produto"){ //hd_chamado=3120493
                if(strlen($_POST["produto_referencia"]) > 0 && strlen($_POST["defeito_reclamado"]) == 0){
                    $msg_erro .= "Por favor informe o Defeito Reclamado <br />";
                }
            }


            $consumidor_pais = $_POST["consumidor_pais"];
            $produto_sem_serie = $_POST["produto_sem_serie"];

            if($produto_sem_serie == "t"){

                if(strlen($_POST["produto_referencia"]) == 0){
                    $msg_erro .= "Por favor informe o Produto <br />";
                }

                if(strlen($_POST["posto_nome_tab"]) == 0){
                    $msg_erro .= "Por favor informe o Posto Autorizado <br />";
                }else{

                    $posto_id = $_POST["posto_tab"];

                    if(strlen(trim($posto_id)) > 0){
                        $sql_tipo_posto = "SELECT
                                                tbl_tipo_posto.posto_interno
                                            FROM tbl_tipo_posto
                                            INNER JOIN tbl_posto_fabrica ON tbl_posto_fabrica.tipo_posto = tbl_tipo_posto.tipo_posto
                                            WHERE
                                                tbl_posto_fabrica.posto = {$posto_id}
                                                AND tbl_posto_fabrica.fabrica = {$login_fabrica}";
                        $res_tipo_posto = pg_query($con, $sql_tipo_posto);

                        $posto_interno = pg_fetch_result($res_tipo_posto, 0, "posto_interno");

                        if($posto_interno == "f"){
                            $msg_erro .= "Por favor informe o Posto Autorizado Interno <br />";
                        }
                    }
                }

            } else {

                $serie = $xserie = $_POST["serie"];
                if(strlen($serie) == 0 && strlen($_POST["produto_referencia"]) > 0){
                    $msg_erro .= "Por favor informe o número de Série <br />";
                }

            }

        }
        if ($login_fabrica == 162 and !empty($posto_id)) {
            /*
             * - Validação dos campos obrigatórios
             * caso o posto escolhido for INTERNO
             */

            $posto_id = $_POST["posto_tab"];

            $sql_tipo_posto = " SELECT  tbl_tipo_posto.posto_interno
                                FROM    tbl_tipo_posto
                                JOIN    tbl_posto_fabrica ON tbl_posto_fabrica.tipo_posto = tbl_tipo_posto.tipo_posto
                                WHERE   tbl_posto_fabrica.posto     = {$posto_id}
                                AND     tbl_posto_fabrica.fabrica   = {$login_fabrica}";
            $res_tipo_posto = pg_query($con, $sql_tipo_posto);

            $posto_interno = pg_fetch_result($res_tipo_posto, 0, "posto_interno");
        }
    }

    if ($login_fabrica == 175){

        if (!empty($origem)){
            $sql = "SELECT descricao FROM tbl_hd_chamado_origem WHERE hd_chamado_origem = {$origem} AND fabrica = {$login_fabrica}";
            $res = pg_query($con, $sql);

            if (pg_num_rows($res) > 0){
                $desc_origem = pg_fetch_result($res, 0, 'descricao');
            }
        }

        if (strtolower($desc_origem) == 'fale conosco'){
            if (empty($consumidor_nome)){
                $msg_erro .= "Por favor inserir o nome do consumidor <br/>";
            }
            if (strlen(trim($_POST['consumidor_email'])) > 0) {
                $valida_email = filter_var(trim($_POST['consumidor_email']),FILTER_VALIDATE_EMAIL);
                if($valida_email === false){
                    $msg_erro .= "O email informado não é válido! <br>";
                }
            }else{
                $msg_erro .= "Por favor inserir o e-mail do consumidor<br>";
            }
            if (empty($_POST['consumidor_fone']) AND empty($_POST['consumidor_fone2']) AND empty($_POST['consumidor_fone3'])){
                $msg_erro .= "Por favor inserir algum telefone para contato <br/>";
            }
        }else{
            if (empty($consumidor_nome)){
                $msg_erro .= "Por favor inserir o nome do consumidor <br/>";
            }
            // if(empty($valida_cpf_cnpj)){
            //     if (checaCPF($_POST['consumidor_cpf'],false) === false) {
            //         $msg_erro .= "Por favor inserir o CPF do consumidor <br/>";
            //     }
            // }else{
            //     $msg_erro .= $valida_cpf_cnpj;
            // }

            if(!empty($valida_cpf_cnpj)){
                $msg_erro .= $valida_cpf_cnpj;
            }

            if (strlen(trim($_POST['consumidor_email'])) > 0) {
                $valida_email = filter_var(trim($_POST['consumidor_email']),FILTER_VALIDATE_EMAIL);
                if($valida_email === false){
                    $msg_erro .= "O email informado não é válido! <br>";
                }
            }

            if (!empty($_POST['produto_nome']) OR !empty($_POST['produto_referencia'])){
                // if (empty($_POST['hd_extra_defeito'])){
                //     $msg_erro .= "Por favor inserir a reclamaçãod do cliente <br/>";
                // }
                // if (empty($_POST['defeito_reclamado'])){
                //     $msg_erro .= "Por favor selecione o defeito reclamado <br/>";
                // }

                if (empty($_POST['hd_extra_defeito']) AND empty($_POST['defeito_reclamado'])){
                    $msg_erro .= "Por favor selecione o defeito reclamado ou reclamação do cliente para continuar.<br/>";
                }
            }
        }
    }

    if(in_array($login_fabrica, array(90))){
        if(strlen($_POST["produto_referencia"]) > 0 && strlen($_POST["defeito_reclamado"]) == 0){
            $msg_erro .= "Por favor informe o Defeito Reclamado <br />";
        }
    }

    if($usaScriptFalha){
        if(strlen(trim($script_falha)) > 0){
            $script_falha = $_POST['script_falha'];
        }
        if(strlen(trim($_POST['json_script'])) > 0){
            $json_script = $_POST['json_script'];
        }
        if(strlen(trim($_POST['json_execucao_script'])) > 0){
            $json_execucao_script = $_POST['json_execucao_script'];
        }
        if(strlen(trim($_POST['familia_script'])) > 0){
            $familia_script = $_POST['familia_script'];
        }
        if(strlen(trim($_POST['script_resolution'])) > 0){
            $script_resolution = $_POST['script_resolution'];
        }
        if(strlen(trim($_POST['ultima_pergunta_script'])) > 0){
            $ultima_pergunta_script = $_POST['ultima_pergunta_script'];
        }
        if(strlen(trim($_POST['ultima_resposta_script'])) > 0){
            $ultima_resposta_script = $_POST['ultima_resposta_script'];
        }
        if(strlen(trim($_POST['ultima_instrucao_script'])) > 0){
            $ultima_instrucao_script = $_POST['ultima_instrucao_script'];
        }

        if (!empty($_POST["hd_classificacao"]) && empty($_POST["script_resolution"])) {

            $hd_classificacao = $_POST["hd_classificacao"];

            if(strlen(trim($produto)) > 0 AND strlen(trim($defeito_reclamado)) > 0){
                $sql = "SELECT tbl_familia.familia
                        FROM tbl_produto
                        JOIN tbl_familia ON tbl_familia.familia = tbl_produto.familia AND tbl_familia.fabrica = {$login_fabrica}
                        WHERE fabrica = {$login_fabrica}
                        AND produto = {$produto}";
                $res = pg_query($con, $sql);
                $id_familia = pg_fetch_result($res, 0, 'familia');

                $sqlScript = "
                    SELECT script_falha FROM tbl_script_falha
                    WHERE familia = {$id_familia}
                    AND defeito_reclamado = {$defeito_reclamado}
                    AND fabrica = {$login_fabrica}
                ";
                $resScript = pg_query($con, $sqlScript);

                if(pg_num_rows($resScript) > 0){
                    $sqlScriptObrigatorio = "
                        SELECT hd_classificacao
                        FROM tbl_hd_classificacao
                        WHERE fabrica = {$login_fabrica}
                        AND hd_classificacao = {$hd_classificacao}
                        AND script_falha IS TRUE
                    ";
                    $resScriptObrigatorio = pg_query($con, $sqlScriptObrigatorio);

                    if (pg_num_rows($resScriptObrigatorio)) {
                        $msg_erro .= "Para a classificação selecionada é obrigatório a finalização do script de falha<br />";
                    }
                }
            }
        }
    }

    $abre_os            = trim($_POST['abre_os']);
    //HD 205933: Habilitar abertura de ORDEM DE SERVIÇO para a Esmaltec
    $abre_ordem_servico = trim($_POST['abre_ordem_servico']);
    $imprimir_os        = trim($_POST['imprimir_os']);
    $resposta           = addslashes(trim($_POST['resposta']));
    $posto_tab          = trim(strtoupper($_POST['posto_tab']));
    $posto_interno_tab  = trim(strtoupper($_POST['interno']));
    $codigo_posto_tab   = trim(strtoupper($_POST['codigo_posto_tab']));
    $posto_nome_tab     = trim(strtoupper($_POST['posto_nome_tab']));
    $posto_endereco_tab = trim(strtoupper($_POST['posto_endereco_tab']));
    $posto_cidade_tab   = trim(strtoupper($_POST['posto_cidade_tab']));
    $posto_estado_tab   = trim(strtoupper($_POST['posto_estado_tab']));
    $posto_fone_tab     = trim(strtoupper($_POST['posto_fone_tab']));
    if($login_fabrica == 30){
        $posto_fone1_tab     = trim(strtoupper($_POST['posto_fone_tab1']));
        $posto_fone2_tab     = trim(strtoupper($_POST['posto_fone_tab2']));
    }
    $posto_email_tab    = trim(strtoupper($_POST['posto_email_tab']));
    $posto_km_tab       = trim(strtoupper($_POST['posto_km_tab']));
    $revenda_nome       = substr(trim($_POST['revenda_nome']), 0, 50);
    $revenda            = trim($_POST['revenda']);
    $revenda_endereco   = trim($_POST['revenda_endereco']);
    $revenda_nro        = trim($_POST['revenda_nro']);
    $revenda_cmpto      = trim($_POST['revenda_cmpto']);
    $revenda_bairro     = trim($_POST['revenda_bairro']);
    $revenda_city       = trim($_POST['revenda_city']);
    $revenda_uf         = trim($_POST['revenda_uf']);
    $revenda_fone       = trim($_POST['revenda_fone']);
    $hd_extra_defeito   = trim($_POST['hd_extra_defeito']);
    $faq_situacao       = trim($_POST['faq_situacao']);
    $reclama_posto      = trim($_POST['tipo_reclamacao']);

    if (in_array($login_fabrica, array(30,74,178))) {
        $consumidor_nascimento = $_POST['consumidor_nascimento'];
        $cpf = preg_replace('/\D/','',$consumidor_cpf);
        if (strlen($consumidor_nascimento) == 0) {
            if($consumidor_cpf_cnpj =='C' or strlen($cpf) == 11) {
                if($login_fabrica == 74) {
                    $msg_erro .= "Por favor informar data de nascimento";
                }else{
                     $consumidor_nascimento_query = "NULL";
                }
            }else{
                $consumidor_nascimento_query = "NULL";
            }
        } else {
            $consumidor_nascimento_query = "'".converte_data($consumidor_nascimento)."'";
        }
    }

    if (!empty($_POST['consumidor_nascimento'])) {
        $ok = Valida_Data($_POST['consumidor_nascimento']);

        if ($ok == 'erro') {
            $msg_erro .= "Data de nascimento do consumidor inválida ! <br>";
        }
    }
    if (!empty($_POST['data_nf'])) {
        $ok = Valida_Data($_POST['data_nf']);
        if ($ok == 'erro') {
            $msg_erro .= "Data da nota fiscal inválida ! <br>";
        }
    }

    if($login_fabrica == 127 && (in_array($posto_tab,array(367307,371239)))){
        if (empty($consumidor_cep)) {
            $msg_erro .= "Informe o cep do consumidor <br>";
        }

        if (empty($consumidor_endereco)) {
            $msg_erro .= "Informe o endereco do consumidor <br>";
        }

        if (empty($consumidor_numero)) {
            $msg_erro .= "Informe o número endereco do consumidor <br>";
        }

        if (empty($consumidor_bairro)) {
            $msg_erro .= "Informe o bairro do consumidor <br>";
        }


        if (empty($consumidor_cidade)) {
            if (($login_fabrica == 52 && $_POST["consumidor_pais"] == 'BR') || $login_fabrica != 52) {
                $msg_erro .= "Informe a cidade do consumidor <br>";
            }
        }

        if (empty($consumidor_estado)) {
            $msg_erro .= "Informe o estado (UF) do consumidor <br>";
        }

        if(strlen($_POST['consumidor_cpf']) == 0){
            $msg_erro .= "Informe o CPF / CNPJ do Cliente <br>";
        }
        if(strlen($_POST['consumidor_fone']) == 0){
            $msg_erro .= "Informe o telefone do Cliente <br>";
        }
    }

    if ($login_fabrica == 148) {
         if(strlen($_POST['consumidor_fone']) == 0){
            $msg_erro .= "Informe o telefone do Cliente <br>";
        }
    }

    $xresposta            = (strlen($resposta) == 0)           ? "null" : "'".$resposta."'";
    $xreceber_informacoes = (strlen($receber_informacoes) > 0) ? "'$receber_informacoes'" : "'f'";

    if ($abre_os <> 't') {
        $abre_os = 'f';
    }

    if (in_array($login_fabrica,array(91))) {

        $hd_extra_defeito  = $_POST['hd_extra_defeito']  ?  $_POST['hd_extra_defeito']  : $_GET['hd_extra_defeito'];
        $reclamado_produto = $_POST['reclamado_produto'] ?  $_POST['reclamado_produto'] : $_GET['reclamado_produto'];

		if ((strlen($hd_extra_defeito) == 0 || strlen($reclamado_produto) == 0) and $tab_atual == "reclamacao_produto") {
			$msg_erro = "Digite o defeito do produto";
		}
    }
    if (in_array($login_fabrica, array(190)) && $abre_ordem_servico == "t") {
            $abre_os = "t";
    }
    if (in_array($login_fabrica, array(169, 170)) && ($abre_ordem_servico == "t" || $abre_os == "t")) {
        if ($abre_ordem_servico == "t") {
            $abre_os = "t";
        }

        if (empty($_POST["servico_instalacao"]) && !empty($data_nf) && !empty($produto)) {
            $sqlGarantia = "
                SELECT garantia FROM tbl_produto WHERE fabrica_i = {$login_fabrica} AND produto = {$produto}
            ";
            $resGarantia = pg_query($con, $sqlGarantia);

            $garantia = (integer) pg_fetch_result($resGarantia, 0, "garantia");

            if (!empty($instalador_id)) {
                $garantia += (int) $garantia_estendida_tempo;
            }

            list($dia, $mes, $ano) = explode("/", $data_nf);
            if ($os_cortesia != 't'){
                if (strtotime("{$ano}-{$mes}-{$dia} +{$garantia} months") < strtotime("today")) {
                    $fim_garantia = date("d/m/Y", strtotime("{$ano}-{$mes}-{$dia} +{$garantia} months"));
                    $msg_erro = "Produto fora da garantia, terminada em {$fim_garantia}<br />";
                }
            }
        }
    }

    if ($validaGarantiaCallcenter AND ($abre_ordem_servico == "t" || $abre_os == "t")){
        $valida_garantia = true;

        if ($login_fabrica == 183){
            $sql_cortesia = "SELECT tipo_atendimento FROM tbl_tipo_atendimento WHERE fabrica = $login_fabrica AND tipo_atendimento = $tipo_atendimento_os AND descricao = 'Cortesia'";
            $res_cortesia = pg_query($con, $sql_cortesia);

            if (pg_num_rows($res_cortesia) > 0){
                $valida_garantia = false;
            }
        }

        if (!empty($data_nf) AND !empty($produto) AND $valida_garantia === true){
            $sqlGarantia = "
                SELECT garantia FROM tbl_produto WHERE fabrica_i = {$login_fabrica} AND produto = {$produto}
            ";
            $resGarantia = pg_query($con, $sqlGarantia);

            $garantia = (integer) pg_fetch_result($resGarantia, 0, "garantia");

            list($dia, $mes, $ano) = explode("/", $data_nf);
            if (strtotime("{$ano}-{$mes}-{$dia} +{$garantia} months") < strtotime("today")) {
                $fim_garantia = date("d/m/Y", strtotime("{$ano}-{$mes}-{$dia} +{$garantia} months"));
                $msg_erro = "Produto fora da garantia, terminada em {$fim_garantia}<br />";
            }
        }
    }

    //HD 205933: Habilitar abertura de ORDEM DE SERVIÃO para a Esmaltec
    if ($abre_ordem_servico <> 't') {
        $abre_ordem_servico = ($abre_ordem_servico == 'true') ? 't' : 'f';
    }

    if ($login_fabrica == 24) {

        if ($tab_atual == "outros_assuntos") {

            $reclamado = trim($_POST['outros_assuntos_descricao']);

            if (strlen($reclamado) == 0) {
                $msg_erro = 'Digite a descrição de outros assuntos';
            } else {
                $xreclamado = "'".$reclamado."'";
            }

        }

    }

    if($tab_atual == "garantia_adicional"){
        $xserie = $_POST['serie'];
    }

    if ($tab_atual == "extensao") {

        $produto_referencia = $_POST['produto_referencia_es'];
        $produto_nome       = $_POST['produto_nome_es'];
        $reclamado          = trim($_POST['reclamado_es']);

        if (strlen($reclamado) == 0) {
            $xreclamado = "null";
        } else {
            $xreclamado = "'".$reclamado."'";
        }

        $xserie = $_POST['serie'];

        if (strlen($_POST["serie_es"]) > 0) $xserie = $_POST['serie_es'];

        //HD 12749
        if (strlen($produto_referencia) == 0) {
            $msg_erro .= " Insira a referência do produto\n ";
        }

        if (strlen($produto_nome) == 0) {
            $msg_erro .= " Insira nome do produto\n ";
        }

        if (strlen($xserie) == 0) {
            $msg_erro .= " Insira o número de série do produto\n ";
        }

        $es_id_numeroserie = $_POST['es_id_numeroserie'];
        $es_revenda_cnpj   = $_POST['es_revenda_cnpj'];
        $es_revenda        = $_POST['es_revenda'];

        if (strlen($es_revenda) == 0) {
            $xes_revenda = "NULL";
        } else {
            $xes_revenda = "'".$es_revenda."'";
        }

        $es_nota_fiscal = $_POST['es_nota_fiscal'];

        if (strlen($es_nota_fiscal) == 0) {
            $xes_nota_fiscal = "NULL";
        } else {
            $xes_nota_fiscal = "'".$es_nota_fiscal."'";
        }

        $es_data_compra = $_POST['es_data_compra'];

        if (strlen($es_data_compra) == 0) {
            $xes_data_compra = "NULL";
        } else {
            $xes_data_compra = "'".converte_data($es_data_compra)."'";
        }

        $es_municipiocompra = $_POST['es_municipiocompra'];

        if (strlen($es_municipiocompra) == 0) {
            $xes_municipiocompra = "NULL";
        } else {
            $xes_municipiocompra = "'".$es_municipiocompra."'";
        }

        $es_estadocompra = $_POST['es_estadocompra'];

        if (strlen($es_estadocompra) == 0) {
            $xes_estadocompra = "NULL";
        } else {
            $xes_estadocompra = "'".$es_estadocompra."'";
        }

        $es_data_nascimento = $_POST['es_data_nascimento'];

        if (strlen($es_data_nascimento) == 0) {
            $xes_data_nascimento = "NULL";
        } else {
            $xes_data_nascimento = "'".converte_data($es_data_nascimento)."'";
        }

        $es_estadocivil = $_POST['es_estadocivil'];

        if (strlen($es_estadocivil) == 0) {
            $xes_estadocivil = "NULL";
        } else {
            $xes_estadocivil = "'".$es_estadocivil."'";
        }

        $es_sexo = $_POST['es_sexo'];

        if (strlen($es_sexo) == 0) {
            $xes_sexo = "NULL";
        } else {
            $xes_sexo = "'".$es_sexo."'";
        }

        $es_filhos = $_POST['es_filhos'];

        if (strlen($es_filhos) == 0) {
            $xes_filhos = "NULL";
        } else {
            $xes_filhos = "'".$es_filhos."'";
        }

        $es_fonecomercial = $_POST['es_fonecomercial'];

        if (strlen($es_fonecomercial) == 0) {
            $xes_dddcomercial  = " NULL ";
            $xes_fonecomercial = "NULL";
        } else {
            $xes_dddcomercial  = "'".substr($es_fonecomercial,1,2)."'";
            $xes_fonecomercial = "'".substr($es_fonecomercial,5,9)."'";
        }

        $es_celular = $_POST['es_celular'];

        if (strlen($es_celular) == 0) {

            $xes_dddcelular = " NULL ";
            $xes_celular    = "NULL";

        } else {

            $xes_dddcelular = "'".substr($es_celular,1,2)."'";
            $xes_celular    = "'".substr($es_celular,5,9)."'";

        }

        $es_preferenciamusical = $_POST['es_preferenciamusical'];

        if (strlen($es_preferenciamusical) == 0) {
            $xes_preferenciamusical = "NULL";
        } else {
            $xes_preferenciamusical = "'".$es_preferenciamusical."'";
        }

    }

    if ($tab_atual == "reclamacao_produto") {

        $produto_referencia = $_POST['produto_referencia'];
        $produto_nome       = $_POST['produto_nome'];
        $voltagem           = $_POST['voltagem'];
        $reclamado          = trim($_POST['reclamado_produto']);
        $xserie             = $_POST['serie'];

        if (in_array($login_fabrica, array(43,14,157))) {
            if($login_fabrica<>157) {
                $ordem_montagem  = $_POST['ordem_montagem'];
            }
            $codigo_postagem = $_POST['codigo_postagem'];
        }

        if ($login_fabrica == 85) {//HD 237892

            if (strlen($produto_referencia) == 0) {
                $msg_erro .= " Insira a referência do produto\n ";
            }

            if (strlen($produto_nome) == 0) {
                $msg_erro .= " Insira nome do produto\n ";
            }

            if (strlen($_POST['voltagem'])== 0){
                $msg_erro .= "Informe voltagem do produto.";
            }

            if (strlen($_POST['nome_revenda']) == 0) {
                $msg_erro .= "Informe a revenda.";
            }

        }

        if($login_fabrica == 35) {
            if (strlen($hd_extra_defeito) == 0 ) {
                $msg_erro .= "Digite o defeito do produto";
            }
        }


        if (strlen($reclamado) == 0) {
            $xreclamado = "null";
        } else {
            $xreclamado = "'".$reclamado."'";
        }

    }

    if ($tab_atual == "reclamacao_at") {

        $reclamado = trim($_POST['reclamado_at']);
        $xserie    = $_POST['serie'];

        if (strlen($reclamado) == 0) {
            $msg_erro = "Insira a reclamação";
        } else {
            $xreclamado = "'".$reclamado."'";
        }

    }

    $posto_nome          = $_POST['posto_nome'];
    $codigo_posto        = $_POST['codigo_posto'];
    $procon_posto_nome   = $_POST['procon_posto_nome'];
    $procon_codigo_posto = $_POST['procon_codigo_posto'];
    $reclamacao_procon   = $_POST['reclamacao_procon'];

    if(((!empty($posto_tab) and empty($codigo_posto_tab)) or empty($posto_tab)) AND $tab_atual != 'reclamacao_at'){
        $posto_tab = "";
        $posto_nome          = "";
        $codigo_posto        = "";
        $procon_posto_nome   = "";
        $procon_codigo_posto = "";

    }

    if ($login_fabrica == 2 AND $reclama_posto <> 'reclamacao_at') {
        $codigo_posto = "";
    }

    if ($login_fabrica == 94 AND $tab_atual == 'indicacao_at') {
        $posto_nome          = $_POST['posto_nome_ind'];
        $codigo_posto        = $_POST['codigo_posto_ind'];

        if(empty($codigo_posto)){
            $msg_erro = "Informe um Posto Autorizado para indicação";
        }

        $reclamado = $_POST['ind_posto_desc'];
    }

    if (strlen($codigo_posto_tab) > 0) {

        $sql = "SELECT posto from tbl_posto_fabrica where upper(codigo_posto) = upper('$codigo_posto_tab') and fabrica = $login_fabrica";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0) {

            $mr_codigo_posto = pg_fetch_result($res,0,0);

            $sql = "SELECT contato_endereco,
                contato_numero,
                contato_bairro,
                contato_cidade,
                contato_estado,
                contato_cep,
                contato_email,
                contato_fone_comercial
                FROM
                     tbl_posto_fabrica
                WHERE
                     posto = $mr_codigo_posto
                AND
                    fabrica = $login_fabrica";
            $resm = pg_query($con, $sql);
            if (pg_num_rows($resm) > 0) {

                $posto_endereco = pg_escape_string(pg_fetch_result($resm,0,'contato_endereco'));
                $posto_numero= pg_fetch_result($resm,0,'contato_numero');
                $posto_bairro = pg_escape_string(pg_fetch_result($resm,0,'contato_bairro'));
                $posto_endereco_tab = $posto_endereco . ', ' . $posto_numero . ' - ' . $posto_bairro;
                $posto_cidade_tab = pg_fetch_result($resm,0,'contato_cidade');
                $posto_estado_tab = pg_fetch_result($resm,0,'contato_estado');
                $posto_cep_tab = pg_fetch_result($resm, 0, 'contato_cep');
                $posto_fone_tab = pg_fetch_result($resm,0,'contato_fone_comercial');
                $posto_email_tab = pg_fetch_result($resm,0,'contato_email');

            }
        }
    }

    if (strlen($codigo_posto) == 0) {

        $xcodigo_posto = "null";

    } else {

        $sql = "SELECT posto from tbl_posto_fabrica where codigo_posto = '$codigo_posto' and fabrica = $login_fabrica";
        $res = pg_query($con,$sql);

        if (pg_num_rows($res) > 0) {
            $xcodigo_posto = pg_fetch_result($res, 0, 0);
        } else {
            $xcodigo_posto = "null";
        }

    }

    if (($login_fabrica == 11 or $login_fabrica == 172) && $tab_atual == "procon") {

        if (strlen($procon_codigo_posto) == 0) {//HD 55995

            $xcodigo_posto = "null";

        } else {

            $sql = "SELECT posto from tbl_posto_fabrica where codigo_posto = '$procon_codigo_posto' and fabrica = $login_fabrica";
            $res = pg_query($con, $sql);

            if (pg_num_rows($res) > 0) {
                $xcodigo_posto = pg_fetch_result($res, 0, 0);
            } else {
                $xcodigo_posto = "null";
            }

        }

    }

    $os = trim($_POST['os']);

    if (!in_array($login_fabrica, array(169, 170))) {
        $os = (empty($os) AND !empty($_POST['at_os'])) ? $_POST['at_os'] : $os;
    }

    if (in_array($login_fabrica,array(74,85)) && strlen($os) > 0) {
        $sql = "SELECT tbl_hd_chamado_extra.os FROM tbl_hd_chamado_extra WHERE hd_chamado = {$callcenter} AND os = {$os}";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) == 0) {
            unset($os);
        }
     }

    if (strlen($os) == 0) {

        $xos = "null";

        if($login_fabrica == 85){
            $xos = trim($_POST['xos']);
        }

    } else {

        if (!in_array($login_fabrica,array(74,85))){
            if($login_fabrica == 30) {
                $sql = "SELECT os from tbl_os where sua_os = '$os' and fabrica = $login_fabrica";
            }else{
                $sql = "SELECT os from tbl_os where sua_os = '$os' and fabrica = $login_fabrica AND excluida IS NOT TRUE";
            }
            $res = pg_query($con, $sql);

            if (pg_num_rows($res) > 0) {
                $xos = pg_fetch_result($res, 0, 0);
            } else {

                $sql_os_excluida = "SELECT os FROM tbl_os_excluida WHERE os = {$os} AND fabrica = {$login_fabrica} union select os from tbl_os where os = $os and excluida";
                $res_os_excluida = pg_query($con, $sql_os_excluida);

                if(pg_num_rows($res_os_excluida) == 0){
                    $msg_erro .= trim("OS {$os} informada não encontrada no sistema");
                }elseif(in_array($login_fabrica,[169,170])) {
                    $xos = pg_fetch_result($res_os_excluida,0,'os');
                }

            }
        } else {
            $xos = $os;
        }
    }

    if ((strlen($xos) == 0 || $xos == 'null') && $_POST['os_ressarcimento'] != '') {

        $xos = $_POST['os_ressarcimento'];
    }

    if ($tab_atual == "reclamacao_empresa") {

        $reclamado = trim($_POST['reclamado_empresa']);

        if (strlen($reclamado) == 0) {
            $msg_erro = "Insira a reclamação";
        } else {
            $xreclamado = "'".$reclamado."'";
        }

    }

    if ($tab_atual == "reclamacoes") {

        $reclamado      = trim($_POST['reclamado']);
        $tipo_reclamado = trim($_POST['tipo_reclamacao']);

        if (strlen($reclamado) == 0) {
            $msg_erro = "Insira a reclamação";
        } else {
            $xreclamado = "'".$reclamado."'";
        }

    }

    if ($login_fabrica == 2) {

        if ($tab_atual == "reclamacao_produto") {

            $reclamado      = trim($_POST['reclamado_produto']);
            $tipo_reclamado = trim($_POST['tipo_reclamacao']);

            if (strlen($reclamado) == 0) {
                $msg_erro = "Insira a reclamação";
            } else {
                $xreclamado = "'".$reclamado."'";
            }

        }

        if ($tab_atual == "reclamacoes") {

            $reclamado      = trim($_POST['reclamado']);
            $tipo_reclamado = trim($_POST['tipo_reclamacao']);

            if (strlen($reclamado) == 0) {
                $msg_erro = "Insira a reclamação";
            } else {
                $xreclamado = "'".$reclamado."'";
            }

        }

        if ($tab_atual == "duvida_produto") {

            $reclamado      = trim($_POST['faq_duvida_duvida']);
            $tipo_reclamado = trim($_POST['tipo_reclamacao']);

            if (strlen($reclamado) == 0) {
                $msg_erro = "Insira a reclamação";
            } else {
                $xreclamado = "'".$reclamado."'";
            }

        }

    }

    if(in_array($login_fabrica,array(101,145,161))){
        if ($tab_atual == "duvida_produto") {
            $xserie = $_POST['serie'];
            $reclamado = trim($_POST['duvida_produto_obs']);

            if (strlen($reclamado) == 0) {
                $xreclamado = "";
            } else {
                $xreclamado = "'".$reclamado."'";
            }

        }
    }

    if(in_array($login_fabrica, array(169,170))){

        if ($tab_atual == "duvida_produto") {
            $xserie = $_POST['serie'];
            $reclamado = trim($_POST['duvida_produto_obs']);

            if (strlen($reclamado) == 0) {
                $msg_erro = "Inserir uma observação";
            } else {
                $xreclamado = "'".$reclamado."'";
            }
        }

        if($tab_atual == "indicacao_at"){
            $reclamado = trim($_POST['reclamado_assitencia']);

            if(strlen(trim($_POST['codigo_posto_tab'])) == 0 AND strlen(trim($_POST['posto_nome_tab'])) == 0){
                $msg_erro = "Selecione um posto autorizado.";
            }

            if (strlen($reclamado) == 0) {
                $msg_erro = "Inserir uma reclamação";
            } else {
                $xreclamado = "'".$reclamado."'";
            }
        }

        if($tab_atual == "informacao"){
            $reclamado = trim($_POST['reclamacao_informacao']);

            if (strlen($reclamado) == 0) {
                $msg_erro = "Inserir uma informação";
            } else {
                $xreclamado = "'".$reclamado."'";
            }
        }
    }

    if ($tab_atual == "sugestao") {

        $reclamado = trim($_POST['reclamado_sugestao']);

        if (strlen($reclamado) == 0) {
            $msg_erro .= "Insira a sugestão";
        } else {
            $xreclamado = "'".$reclamado."'";
        }

    }

    if ($tab_atual == "assistencia") {

        $produto_referencia = $_POST['produto_referencia_pa'];
        $produto_nome       = $_POST['produto_nome_pa'];
        $xserie             = $_POST['serie_pa'];
        $reclamado          = trim($_POST['reclamado_pa']);

        if (strlen($reclamado) == 0) {
            $xreclamado = "null";
        } else {
            $xreclamado = "'".$reclamado."'";
        }

    }

    if ($tab_atual == "procon") {

        if($login_fabrica == 160 or $replica_einhell){
            $numero_processo    = $_POST["numero_processo"];
            $data_conciliacao   = $_POST["data_conciliacao"];
            $data_julgamento    = $_POST["data_julgamento"];
            $xserie             = $_POST["serie"];

            $array_campos_adicionais['data_conciliacao'] = $data_conciliacao;
            $array_campos_adicionais['data_julgamento'] = $data_julgamento;

            $array_campos_adicionais =  json_encode($array_campos_adicionais);
        }

        $reclamado = trim($_POST['reclamado_procon']);

        if (strlen($reclamado) == 0) {
            $xreclamado = "null";
        } else {
            $xreclamado = "'".$reclamado."'";
        }

        if (strlen($reclamacao_procon) > 0) {

            $sub_reclamacao_procon = array("pr_reclamacao_at","pr_info_at","pr_mau_atend","pr_posto_n_contrib","pr_demonstra_desorg","pr_bom_atend","pr_demonstra_org");

            if (in_array($reclamacao_procon, $sub_reclamacao_procon)) {
                $tab_atual = $reclamacao_procon;
            }

        }

    }

    if ($tab_atual == "garantia") {

        $produto_referencia = $_POST['produto_referencia_garantia'];
        $produto_nome       = $_POST['produto_nome_garantia'];
        $xserie             = $_POST['serie_garantia'];
        $reclamado          = trim($_POST['reclamado_produto_garantia']);

        if (strlen($reclamado) == 0) {
            $xreclamado = "null";
        } else {
            $xreclamado = "'".$reclamado."'";
        }

    }

    if ($tab_atual == "troca_produto") {

        $produto_referencia = $_POST['troca_produto_referencia'];
        $produto_nome       = $_POST['troca_produto_nome'];
        $reclamado          = trim($_POST['troca_produto_descricao']);
        $xserie             = $_POST['troca_serie'];

        if (strlen($reclamado) == 0) {
            $xreclamado = "null";
        } else {
            $xreclamado = "'".$reclamado."'";
        }

        if (strlen($produto_referencia) == 0 AND strlen($produto_nome) == 0) {
            $msg_erro = "Por favor Escolha o produto.";
        }

    }

    if(!in_array($login_fabrica, array(169,170))){
        if ($tab_atual == 'informacao' || $tab_atual == 'reclamacao'){
            $reclamado          = trim($_POST['reclamado_produto']);
            if (strlen($reclamado) == 0) {
                $xreclamado = "null";
            } else {
                $xreclamado = "'".$reclamado."'";
            }
        }
    }

    $xrevenda      = 'null';
    $xrevenda_nome = "''";

    if ($tab_atual == "onde_comprar") {

        $revenda          = $_POST['revenda'];
        $revenda_cnpj     = $_POST['revenda_cnpj'];
        $revenda_nome     = substr(trim($_POST['revenda_nome']), 0, 50);
        $revenda_endereco = trim($_POST['revenda_endereco']);
        $revenda_nro      = trim($_POST['revenda_nro']);
        $revenda_cmpto    = trim($_POST['revenda_cmpto']);
        $revenda_bairro   = trim($_POST['revenda_bairro']);
        $revenda_city     = trim($_POST['revenda_city']);
        $revenda_uf       = trim($_POST['revenda_uf']);
        $revenda_fone     = trim($_POST['revenda_fone']);
        $reclamado        = trim($_POST['reclamado_onde_comprar']);

        $xrevenda      = ($revenda != '') ? $revenda : 'null';

        $xrevenda_nome = "'$xrevenda_nome'";

        if($login_fabrica == 101 || $login_fabrica == 145){
            $reclamado        = trim($_POST['onde_comprar_obs']);
            if (strlen($reclamado) == 0) {
                $xreclamado = "";
            } else {
                $xreclamado = "'".$reclamado."'";
            }
        }

    } else if($login_fabrica == 94 AND $tab_atual == "indicacao_rev"){

        $revenda_ind          = $_POST['revenda_ind'];
        $revenda_ind_cnpj     = $_POST['revenda_ind_cnpj'];
        $revenda_ind_nome     = substr(trim($_POST['revenda_ind_nome']), 0, 50);

        if(empty($revenda_ind_nome) or empty($revenda_ind_cnpj)){
            $msg_erro = "Informe uma Revenda para indicação";
        } else {
            $xrevenda       = $revenda_ind;
            $revenda_cnpj   = $revenda_ind_cnpj;
            $revenda_nome   = $revenda_ind_nome;
        }

        $xrevenda_nome = "'$revenda_nome'";
        $reclamado = $_POST['ind_revenda_desc'];

    }else {

        $revenda          = $_POST['revenda_tab'];

        if(strlen($revenda) > 0){
            $xrevenda = $revenda;
        }

        if (strlen($nome_revenda)) {
            $xrevenda_nome = "'$nome_revenda'";
        }

    }

    if ($tab_atual == "ressarcimento") {

        $banco             = trim($_POST['banco']);
        $agencia           = trim($_POST['agencia']);
        $contay            = trim($_POST['contay']);
        $nomebanco         = trim($_POST['nomebanco']);
        $tipo_conta        = trim($_POST['tipo_conta']);
        $favorecido_conta  = trim($_POST['favorecido_conta']);
        $cpf_conta         = trim($_POST['cpf_conta']);
        $reclamado         = trim($_POST['obs_ressarcimento']);

        $valor_produto     = trim($_POST['valor_produto']);
        $valor_inpc        = trim($_POST['valor_inpc']);
        $valor_corrigido   = trim($_POST['valor_corrigido']);

        $reclamado         = trim($_POST['troca_produto_descricao']);

        $data_pagamento    = trim($_POST['data_pagamento']);
        $procon            = trim($_POST['procon']);
        $numero_processo   = trim($_POST['numero_processo']);

        $valor_produto     = str_replace(",",".",$valor_produto);
        $valor_inpc        = str_replace(",",".",$valor_inpc);
        $valor_corrigido   = str_replace(",",".",$valor_corrigido);

        if (strlen($xos) == 0 or $xos == 'null') {
            $msg_erro .= "Para fazer o ressarcimento é necesário ter uma Ordem de Serviço Aberta";
        }

        if (strlen($banco) == 0) {
            $xbanco = "null";
        } else {
            $xbanco = "'".$banco."'";
        }

        if (strlen($agencia) == 0) {
            $xagencia = "null";
        } else {
            $xagencia = "'".$agencia."'";
        }

        if (strlen($contay) == 0) {
            $xcontay = "null";
        } else {
            $xcontay = "'".$contay."'";
        }

        if (strlen($nomebanco) == 0) {
            $xnomebanco = "null";
        } else {
            $xnomebanco = "'".$nomebanco."'";
        }

        if (strlen($tipo_conta) == 0) {
            $xtipo_conta = "null";
        } else {
            $xtipo_conta = "'".$tipo_conta."'";
        }

        if (strlen($favorecido_conta) == 0) {
            $xfavorecido_conta = "null";
        } else {
            $xfavorecido_conta = "'".$favorecido_conta."'";
        }

        if (strlen($cpf_conta) == 0) {
            $xcpf_conta = "null";
        } else {
            $xcpf_conta = "'".$cpf_conta."'";
        }

        if (strlen($obs_conta) == 0) {
            $xobs_conta = "null";
        } else {
            $xobs_conta = "'".$obs_conta."'";
        }

        if (strlen($data_pagamento) == 0) {
            $xdata_pagamento = "null";
        } else {
            $xdata_pagamento = "'".$data_pagamento."'";
        }

    }

    if ($tab_atual == "sedex_reverso") {

        $troca_produto_referencia = trim($_POST['troca_produto_referencia']);
        $troca_produto_nome       = trim($_POST['troca_produto_nome']);
        $reclamado                = trim($_POST['troca_observacao']);
        $numero_objeto            = trim($_POST['numero_objeto']);
        $nota_fiscal_saida        = trim($_POST['nota_fiscal_saida']);
        $data_nf_saida            = trim($_POST['data_nf_saida']);
        $data_retorno_produto     = trim($_POST['data_retorno_produto']);
        $procon                   = trim($_POST['procon2']);
        $numero_processo          = trim($_POST['numero_processo2']);

        if (strlen($nota_fiscal_saida) == 0) {
            $xnota_fiscal_saida = "null";
        } else {
            $xnota_fiscal_saida = "'".$nota_fiscal_saida."'";
        }

        if (strlen($data_nf_saida) == 0) {
            $xdata_nf_saida = "null";
        } else {
            $xdata_nf_saida = "'".converte_data($data_nf_saida)."'";
        }

        if (strlen($data_retorno_produto) == 0) {
            $xdata_retorno_produto = "null";
        } else {
            $xdata_retorno_produto = "'".converte_data($data_retorno_produto)."'";
        }

        if (strlen($numero_objeto) == 0) {
            $xnumero_objeto = "null";
        } else {
            $xnumero_objeto = "'".$numero_objeto."'";
        }

        if (strlen($produto_referencia) == 0 AND strlen($produto_nome) == 0) {
            $msg_erro = "Por favor Escolha o produto.";
        }

    }

    if ($tab_atual == "informacoes") {

        $reclamado = trim($_POST['informacoes_cliente']);

        if (strlen($reclamado) == 0) {
            $msg_erro .= "Insira as informações <br />";
        } else {
            $xreclamado = "'".$reclamado."'";

            if($login_fabrica == 74){

                if($status_interacao == "PROTOCOLO DE INFORMACAO" && strlen($_POST['informacoes_cliente']) == 0){
                    $msg_erro .= "Insira as informações do Cliente <br />";
                }
            }

        }

    }

    if($login_fabrica == 162){
        $valor_nf        = trim($_POST['valor_nf']);
    }

    if (($login_fabrica == 81 or $telecontrol_distrib) and !$replica_einhell) {
        $referencia_adi          = trim($_POST['referencia_adi']);
        $descricao_adi           = trim($_POST['descricao_adi']);
        $qtde_adi                = trim($_POST['qtde_adi']);
        $recebido                = trim($_POST['recebido']);
        $analise                 = trim($_POST['analise']);
        $validade                = trim($_POST['validade']);
        $lote                    = trim($_POST['lote']);
        $origem_adi              = trim($_POST['origem_adi']);
        $aco_de                  = trim($_POST['aco_de']);
        $procedente              = trim($_POST['procedente']);
        $reposicao               = trim($_POST['reposicao']);
        $disposicao              = trim($_POST['disposicao']);
        $descricao_analise       = trim($_POST['descricao_analise']);
        $valor_nf        = trim($_POST['valor_nf']);

        $array_campos_adicionais = array(
            "referencia_adi"    => $referencia_adi,
            "descricao_adi"     => $descricao_adi,
            "qtde_adi"          => $qtde_adi,
            "recebido"          => $recebido,
            "analise"           => $analise,
            "validade"          => $validade,
            "lote"              => $lote,
            "origem_adi"        => $origem_adi,
            "aco_de"            => $aco_de,
            "procedente"        => $procedente,
            "reposicao"         => $reposicao,
            "disposicao"        => $disposicao,
            "descricao_analise" => $descricao_analise
        );

    }

    if ( (in_array($login_fabrica, array(81,155, 114, 122, 123, 128))) or $telecontrol_distrib)  {
        if ($login_fabrica != 81 and $login_fabrica != 153) {
            $array_campos_adicionais = array();
        }

        $origem_reclamacao       = $_POST["origem_reclamacao"];
        $origem_reclamacao_outro = trim($_POST["origem_reclamacao_outro"]);

        sort($origem_reclamacao);

        $array_campos_adicionais["origem_reclamacao"] = $origem_reclamacao;

        if (!count($origem_reclamacao)) {
            $msg_erro = "Selecione uma origem de reclamação";
        } else {
            if (in_array("outro", $array_campos_adicionais["origem_reclamacao"])) {

                if (!strlen(trim($origem_reclamacao_outro))) {
                    $msg_erro = "Digite a outra origem de reclamação";
                } else {
                    $array_campos_adicionais["origem_reclamacao_outro"] = $origem_reclamacao_outro;
                }
            }

            foreach ($array_campos_adicionais as $key => $value) {
                if (!is_array($value)) {
                    $array_campos_adicionais[$key] = utf8_encode($value);
                }
            }

            // $array_campos_adicionais = str_replace("\\", "\\\\", json_encode($array_campos_adicionais));
            $array_campos_adicionais = json_encode($array_campos_adicionais);
        }
    }

    if ($login_fabrica == 74) {

        $fone_revenda = trim($_POST['fone_revenda']);
        $data_visita_tecnico = trim($_POST['data_visita_tecnico']);
        $fone_revenda2 = trim($_POST['fone_revenda2']);
        $dt_fabricacao = trim($_POST['dt_fabricacao']);

        $array_campos_adicionais =  array("data_visita_tecnico" => $data_visita_tecnico,
                                            "data_fabricacao"   => $dt_fabricacao,
                                            "fone_revenda"   => $fone_revenda,
                                            "fone_revenda2"   => $fone_revenda2
                                    );
        $array_campos_adicionais = json_encode($array_campos_adicionais);
        $garantia_produto = $_POST['garantia_produto'];
    }

    if($login_fabrica == 11 or $login_fabrica == 172 or ($login_fabrica == 30 && strlen($cliente_admin) > 0)){
        if (strtoupper($status_interacao) == "RESOLVIDO" ) {
            $leitura_pendente = "false";
        } else {
            $leitura_pendente = "true";
        }
    }else{
        $leitura_pendente = "f";
    }

    if ($login_fabrica == 11 or $login_fabrica == 172) {
        $array_campos_adicionais = array();
        $data_programada     = $_POST["data_programada"];

        $ant_data_programada = $array_campos_adicionais['data_programada'];
        if (strlen($data_programada) > 0) {
            list($dp, $mp, $yp) = explode("/", $data_programada);

            if (!checkdate($mp, $dp, $yp)) {
                $msg_erro = "A data programada informada é inválida";
            } else {
                if (strtoupper($status_interacao) == "RESOLVIDO") {
                    $leitura_pendente = "false";
                } else {
                    $leitura_pendente = "true";
                }
            }
        } else {
            $leitura_pendente = "false";
        }

        //$data_programada = str_replace("/", "-", $data_programada);
        $array_campos_adicionais['data_programada'] = $data_programada;
        if(!empty($callcenter)) {
            $sql = 'SELECT array_campos_adicionais FROM tbl_hd_chamado_extra WHERE hd_chamado = $1;';
            $result = pg_query_params($con,$sql,array($callcenter));
            if($result && pg_num_rows($result) == 1){
                $json = json_decode(pg_fetch_result($result,0,'array_campos_adicionais'),true);
                if($json['data_programada'] != $data_programada){
                    $array_campos_adicionais['admin_agendamento'] = $login_admin;

                    if($login_fabrica == 11 or $login_fabrica == 172){
                        $msg_alteracao_data = "A Data Programada foi alterada de <b>".$json['data_programada']."</b> para <b>$data_programada</b> ";
                    }

                    $sql = "INSERT INTO tbl_hd_chamado_item(
                            hd_chamado   ,
                            data         ,
                            comentario   ,
                            admin        ,
                            interno      ,
                            status_item 
                        ) values (
                            $hd_chamado       ,
                            current_timestamp ,
                            E'$msg_alteracao_data',
                            $login_admin      ,
                            't'  ,
                            $xstatus_interacao
                        )";
                    $res = pg_query($con,$sql);
                }else{
                    $sqlVer = " SELECT  status
                                FROM    tbl_hd_chamado
                                WHERE   fabrica     = $login_fabrica
                                AND     hd_chamado  = $callcenter";
                    $resVer = pg_query($con,$sqlVer);
                    $verStatus = pg_fetch_result($resVer,0,status);
                    if(strtoupper($verStatus) == "RESOLVIDO" && strtoupper($status_interacao) != "RESOLVIDO"){
                        $array_campos_adicionais['admin_agendamento'] = $login_admin;
                    }else{
                        $array_campos_adicionais['admin_agendamento'] = $json['admin_agendamento'];
                    }

                }
            }else{
                $array_campos_adicionais['admin_agendamento'] = $login_admin;
            }
            $array_campos_adicionais = json_encode($array_campos_adicionais);
        }

    }

    if (strlen($valor_produto) == 0) {
        $xvalor_produto = "null";
    } else {
        $xvalor_produto = $valor_produto;
    }

    if (strlen($valor_inpc) == 0) {
        $xvalor_inpc = "null";
    } else {
        $xvalor_inpc = $valor_inpc;
    }

    if (strlen($valor_corrigido) == 0) {
        $xvalor_corrigido = "null";
    } else {
        $xvalor_corrigido = $valor_corrigido;
    }

    if (strlen($numero_processo) == 0) {
        $xnumero_processo = "null";
    } else {
        $xnumero_processo = "'".$numero_processo."'";
    }

    if (strlen($cliente) == 0) {
        $cliente = "null";
    }

    if (strlen($faq_situacao) > 0) {
        $produto_referencia = $_POST['produto_referencia'];
    }

    if (strlen($_POST['produto_referencia']) > 0 && $login_fabrica == 30) { //hd 311031
        $produto_referencia = $_POST['produto_referencia'];
    }

    if ($login_fabrica == 35 && !empty($_POST['defeito_reclamado_procon'])) {
        $defeito_reclamado = $_POST['defeito_reclamado_procon'];
    }

    if (strlen($defeito_reclamado) == 0) {
        $xdefeito_reclamado  = "null";
    } else {
        $xdefeito_reclamado = $defeito_reclamado;
    }

    if ($login_fabrica <> 2) {

        if (strlen($reclamado) == 0) {
            $xreclamado = "null";
        } else {
            $reclamado = str_replace("'","\'",$reclamado);
            $xreclamado = "'".$reclamado."'";
        }

    }

    if(strlen($valor_nf)>0) {
        $xvalor_nf =  str_replace('.','',$valor_nf);
        $xvalor_nf =  str_replace(',','.',$xvalor_nf);
    } else {
        $xvalor_nf = 'null';
    }

    if (strlen($produto_referencia) > 0) {

        if ($login_fabrica == 96) {
            $cond_produto = "AND tbl_produto.referencia_fabrica = '$produto_referencia'";
        } else {
            $cond_produto = "AND tbl_produto.referencia = '$produto_referencia'";
        }

        $sql = "
            SELECT
                tbl_produto.produto,
                tbl_produto.numero_serie_obrigatorio,
                tbl_produto.linha AS linha_produto,
                tbl_linha.nome AS linha_descricao
            FROM tbl_produto
            JOIN tbl_linha ON tbl_produto.linha = tbl_linha.linha
            WHERE tbl_linha.fabrica = {$login_fabrica}
            AND tbl_produto.fabrica_i = {$login_fabrica}
            {$cond_produto}
            LIMIT 1;
        ";
        $res = pg_query($con, $sql);
        $msg_erro .= pg_errormessage($con);

        if (pg_num_rows($res) > 0) {
            $xproduto = pg_fetch_result($res,0,0);
            $nroSerieObrigatorio = pg_fetch_result($res, 0, 'numero_serie_obrigatorio');
            $xlinha_descricao = pg_fetch_result($res,0,'linha_descricao'); //HD-3428316
            if (in_array($login_fabrica,array(158)) && strlen($_POST['serie']) == 0 && $nroSerieObrigatorio== 't') {
                $msg_erro .= "número de Série obrigatório para esse produto <br />";
            }

        } else {

            if ($tab_atual == "reclamacao_produto"){
                $msg_erro = "Produto $produto_referencia informado não encontrado no sistema <br>";
            }

            $xproduto = "null";

        }

    } else {
        if (!in_array($login_fabrica,[165,191])) {

            if (in_array($login_fabrica, $fabricas_validam_campos_obrigatorios)) {
                $msg_erro .= "Informe o produto para o atendimento <br>";
            }else{
                $xproduto = "null";
            }
        } else {
            $xproduto = "null";
        }

    }

    if (in_array($login_fabrica, $fabricas_validam_campos_obrigatorios) && !in_array($login_fabrica,array(158,165))) {
        if (empty($_POST['reclamado_produto']) && $tab_atual=='reclamacao_produto'){
            if ((strlen($_GET['callcenter']) > 0 && !in_array($login_fabrica, array(125))) || strlen($_GET['callcenter']) == 0) {
                $msg_erro .= "Informe a descrição do defeito reclamado <br>";
            }
        }
    }

    if (in_array($login_fabrica, $fabricas_validam_campos_obrigatorios) || in_array($login_fabrica, array(30,122,158))) {
        if (in_array($login_fabrica,array(165,191)) && strlen($produto_referencia) > 0) {
          if (empty($_POST['defeito_reclamado']) && $tab_atual=='reclamacao_produto') {
            $msg_erro .= "Informar defeito reclamado<br>";
          }
        } else {
            if (empty($_POST['defeito_reclamado']) && !in_array($login_fabrica,array(153,157,165,191)) && $tab_atual=='reclamacao_produto') {
                $msg_erro .= "Informe o defeito reclamado do produto<br>";
            }
        }
    }

    if ($login_fabrica == 158) { /*HD - 6088097*/
        if ($_POST["consumidor_cliente_admin"] && strlen($_POST["unidade_negocio_imbera"]) == 0) {
            $msg_erro .= "Informe a unidade de negócio";
        }
    }

    if (strlen($troca_produto_referencia) > 0) {

        $sql = "
            SELECT
                tbl_produto.produto
            FROM tbl_produto
            JOIN tbl_linha ON tbl_produto.linha = tbl_linha.linha
            WHERE tbl_produto.referencia = '{$troca_produto_referencia}'
            AND tbl_linha.fabrica = {$login_fabrica}
            AND tbl_produto.fabrica_i = {$login_fabrica}
            LIMIT 1;
        ";

        $res = pg_query($con,$sql);
        $msg_erro .= pg_errormessage($con);

        if (pg_num_rows($res) > 0) {
            $xproduto_troca = pg_fetch_result($res,0,0);
        } else {
            $xproduto_troca = "null";
        }

    } else {

        $xproduto_troca = "null";

    }

    if (strlen($faq_situacao) > 0) {//HD 45991

        $sql = "INSERT INTO tbl_faq (
                    situacao,
                    produto
                ) VALUES (
                    '$faq_situacao',
                    $xproduto
                );";

        $res = @pg_query($con, $sql);
        $msg_erro .= pg_errormessage($con);

        if (strlen($msg_erro) == 0) {

            $sql = "SELECT email_cadastros FROM tbl_fabrica WHERE fabrica = $login_fabrica";
            $res = pg_query($con, $sql);

            if (pg_num_rows($res) > 0) {

                $email_cadastros = pg_fetch_result($res, 0, 'email_cadastros');
                $admin_email     = "helpdesk@telecontrol.com.br";
                $remetente       = $admin_email;
                $destinatario    = $email_cadastros ;
                $assunto         = "Nova dÃºvida cadastrada";
                $mensagem        = "Prezado, <br> Foi cadastrada uma nova dÃºvida no sistema para o produto $produto_referencia:<br>  - $faq_situacao <br><br>Por favor, entre na aba <b>Cadastro - Perguntas Frequentes</b> para cadastrar causa e solução da mesma. <br>Att <br>Equipe Telecontrol";
                $headers  = "MIME-Version: 1.0 \r\n";
                $headers .= "Content-type: text/html \r\n";
                $headers .= "From: Telecontrol Networking <helpdesk@telecontrol.com.br> \r\n";
                mail($destinatario, utf8_encode($assunto), utf8_encode($mensagem), $headers);

            }

        }

    }

    if (strlen($xserie) == 0) {
        $xserie = "null";
    } else {
        $xserie = "'".$xserie."'";
    }

    if ($login_fabrica == 11 or $login_fabrica == 172) { // HD 45078

        $xconsumidor_nome        = acentos1($xconsumidor_nome);
        $xconsumidor_nome        = acentos3($xconsumidor_nome);
        $xconsumidor_endereco    = acentos1($xconsumidor_endereco);
        $xconsumidor_endereco    = acentos3($xconsumidor_endereco);
        $xconsumidor_numero      = acentos1($xconsumidor_numero);
        $xconsumidor_numero      = acentos3($xconsumidor_numero);
        $xconsumidor_complemento = acentos1($xconsumidor_complemento);
        $xconsumidor_complemento = acentos3($xconsumidor_complemento);
        $xconsumidor_bairro      = acentos1($xconsumidor_bairro);
        $xconsumidor_bairro      = acentos3($xconsumidor_bairro);
        $xconsumidor_cidade      = acentos1($xconsumidor_cidade);
        $xconsumidor_cidade      = acentos3($xconsumidor_cidade);
        $xconsumidor_email       = acentos1($xconsumidor_email);
        $xconsumidor_email       = acentos3($xconsumidor_email);

    }

    $data_nf = $_POST["data_nf"];
    $data_nf_anterior = $_POST["data_nf_anterior"];

    if (strlen($data_nf) == 0){
        $xdata_nf = "NULL";
    }else{
        list($ddf, $mdf, $ydf) = explode("/", $data_nf);

        if(!checkdate($mdf,$ddf,$ydf)) {
            $msg_erro .= "Data NF Inválida";
        }else{
            if(strtotime("{$ydf}-{$mdf}-{$ddf}") > strtotime('today')) {
                $msg_erro .= "Data NF não pode ser maior que a data atual <br />";
            } else {
                $xdata_nf = "'".$ydf.'-'.$mdf.'-'.$ddf."'";
                if (in_array($login_fabrica, array(169,170))) {
                    $verifica_data = str_replace("'", "", $xdata_nf);
                    if ($verifica_data > date('Y-m-d')) {
                        $msg_erro .= "Data da nota fiscal não pode ser maior que a data atual <br />";
                    }
                }
            }
        }
    }

    //HD 205933: Habilitar abertura de ORDEM DE SERVIÇO para a Esmaltec
    /********************************* VALIDACOES DA ABERTURA DE OS *********************************/
    if($abre_ordem_servico == 't' && strlen($mr_codigo_posto) == 0){
        $abre_ordem_servico = 'f';

        if(strlen($callcenter)){

            $sql = "UPDATE tbl_hd_chamado_extra SET abre_os = false WHERE hd_chamado = {$callcenter}";
            $res = pg_query($con, $sql);

        }

    }else if (strlen($msg_erro) == 0 && $abre_ordem_servico == 't' && strlen($mr_codigo_posto) > 0) {

        if (strlen($mr_codigo_posto) > 0) {
            $xcodigo_posto    = $mr_codigo_posto;
        }

        $valida_cpf_cnpj = verificaCpfCnpj(preg_replace("/\D/","",$consumidor_cpf));

        if(empty($valida_cpf_cnpj)){
            $consumidor_cpf = checaCPF($consumidor_cpf, false, true);

            if ($consumidor_cpf === false) {

                $consumidor_cpf = 'null';

                if ($consumidor_cpf == "nul" and strlen($_POST['consumidor_cpf']) != 0) {
                    $msg_erro = "CPF do consumidor inválido";
                }

            }
        }else{
            $msg_erro = $valida_cpf_cnpj;
        }

    }

    //HD 211895: Separando rotina de PRÉ-OS das rotinas de inserção e atualização
	//			 As validações estão no começo do código, a a inserção depois das rotinas de inserir/atualizar
	/************************************* VALIDACOES DA PRE-OS *************************************/
	if ($login_fabrica == 52) {

        $cliente_admin      = $_POST['cliente_admin'];
        $cliente_nome_admin = trim($_POST['cliente_nome_admin']);
        $observacao_os      = trim($_POST['observacao_os']);
        $hd_classificacao   = trim($_POST['hd_classificacao']);

        if (strlen($cliente_admin) == 0 && $hd_orientacao == false) {
            $msg_erro = "Informe o Cliente Fricon <br />";
        }

        if (strlen($cliente_nome_admin) > 0) {
            $sql = "SELECT count(*) from tbl_cliente_admin where trim(nome) = '$cliente_nome_admin' and fabrica = $login_fabrica";
            $res = pg_query($con,$sql);
            if (pg_fetch_result($res, 0, 0) == 0) {
                $msg_erro = "Cliente Fricon '$cliente_nome_admin' não existe";
            }
        }

        if (strlen($msg_erro) == 0 and strlen($callcenter) == 0 and $abre_ordem_servico == 't') {

    //          if (strlen($posto_km_tab) == 0) {
    //              $posto_km_tab .= "Ã necessario digitar a Qtde de Km, clique em Mapa da Rede<br>";
    //          }

            if ($xserie <> 'null') {

                $sql = "SELECT serie from tbl_numero_serie where serie = $xserie and fabrica = {$login_fabrica}";
                $res = pg_query($con, $sql);

                if (pg_num_rows($res) == 0) {
                    $msg_erro .="Numero de Série Inválido, preencha corretamente ou deixe em branco";
                }

            }

        }

        //PARA A FRICON A REVENDA VAI SER O CLIENTE FRICON
        //echo $xrevenda;exit;
        if (!empty($cliente_admin)){

            $sql = "SELECT nome,cnpj,fone,cidade,estado FROM tbl_cliente_admin WHERE cliente_admin = $cliente_admin";
            $res = pg_query($con,$sql);

            if (pg_num_rows($res)>0){
                $xrevenda = $cliente_admin;
                $xrevenda_nome = "'".pg_fetch_result($res, 0, 'nome')."'";
                $cnpj_revenda  = pg_fetch_result($res, 0, 'cnpj');
                $fone_revenda  = pg_fetch_result($res, 0, 'fone');
                $cidade_revenda  = trim(pg_fetch_result($res, 0, 'cidade'));
                $estado_revenda  = trim(pg_fetch_result($res, 0, 'estado'));

                $sql = "SELECT revenda,cnpj,nome,fone FROM tbl_revenda where cnpj = '$cnpj_revenda' ";
                $res = pg_query($con,$sql);

                if (pg_num_rows($res)==0){

                    $sql = "SELECT cidade from tbl_cidade where nome = '$cidade_revenda' and estado = '$estado_revenda' limit 1 ";
                    $res = pg_query($con,$sql);

                    $cidade_cli_admin = pg_fetch_result($res, 0, 0);
                    if(!empty($cidade_cli_admin)) {
                        $sql = "INSERT INTO tbl_revenda (
                                    nome,
                                    numero,
                                    complemento,
                                    cidade,
                                    cep,
                                    cnpj
                                )SELECT
                                        tbl_cliente_admin.nome,
                                        tbl_cliente_admin.numero,
                                        tbl_cliente_admin.complemento,
                                        $cidade_cli_admin,
                                        tbl_cliente_admin.cep,
                                        tbl_cliente_admin.cnpj
                                    FROM tbl_cliente_admin
                                    WHERE cliente_admin = $cliente_admin";

                        // echo nl2br($sql);
                        $res = pg_query($con,$sql);
                        $msg_erro .= pg_last_error($con);
                        // echo $msg_erro;
                        // exit;
                        if (empty($msg_erro)) {
                            $sql = "SELECT nome,cnpj,fone,revenda FROM tbl_revenda where cnpj = '$cnpj_revenda'";
                            $res = pg_query($con,$sql);
                            $xrevenda      = pg_fetch_result($res, 0, 'revenda');
                            $xrevenda_nome = "'".pg_fetch_result($res, 0, 'nome')."'";
                            $cnpj_revenda  = pg_fetch_result($res, 0, 'cnpj');
                            $fone_revenda  = pg_fetch_result($res, 0, 'fone');
                        }
                    }
                }else{
                    $xrevenda = pg_fetch_result($res, 0, 'revenda');
                    $xrevenda_nome = "'".pg_fetch_result($res, 0, 'nome')."'";
                    $cnpj_revenda  = pg_fetch_result($res, 0, 'cnpj');
                    $fone_revenda  = pg_fetch_result($res, 0, 'fone');
                }
            }

        }
    } else if (in_array($login_fabrica, array(30, 50))) {
        $cliente_admin          = $_POST['cliente_admin'];
        $cliente_nome_admin     = $_POST['cliente_nome_admin'];

        $data_agendamento   = $_POST['data_agendamento'];
        $datas_agendamento  = $_POST['data_agendamento'];
        $datas_agendamento  = array_filter($datas_agendamento);
        $os_visita          = $_POST['os_visita'];
        $data_limite        = $_POST['data_limite'];
        $observacao_os      = trim($_POST['observacao_os']);

        if($cliente_admin != "" && strlen($data_limite) > 0){
            list($dld,$dlm,$dla) = explode("/",$data_limite);
            $xdata_limite = $dla."-".$dlm."-".$dld;
        }

        if($cliente_admin != "" AND strlen($_POST["codigo_posto_tab"]) == 0){
            $msg_erro .= "Para atendimento centralizado deve informar o Posto Autorizado";
        }

        if(!empty($data_limite)){
            $date_time_limite = DateTime::createFromFormat('d/m/Y', $data_limite);
            $date_time_hoje = new DateTime(date('Y-m-d'));

            if ($date_time_limite < $date_time_hoje) {
                $msg_erro .= "Data Limite não pode ser inferior a hoje";
            }
        }

        if (count($datas_agendamento) > 0) {
            foreach ($datas_agendamento as $key => $valor) {
                if (strlen($data_limite) == 0 && $cliente_admin != "") {
                    $msg_erro .= "Se agendamento centralizado for cadastrado, informe a data limite de atendimento";
                }

                if (empty($msg_erro)) {
                    list($dad,$dam,$daa) = explode("/",$valor);
                    $xdata_agendamento = $daa."-".$dam."-".$dad;

                    if ($login_fabrica != 30 && $cliente_admin != "" && strlen($data_limite) > 0) {
                        if (strtotime($xdata_limite) < strtotime($xdata_agendamento)) {
                            $msg_erro = "Data limite inválida! Deve ser maior que a data de agendamento";
                        }
                    }

                    $xdata_agendamento .= " 00:00:00";
                }
            }
        }
    } else {
        $data_agendamento = "";
    }

    if (in_array($login_fabrica, array(169,170))){
        $observacao_os      = trim($_POST['observacao_os']);
    }

	if($xrevenda == "null" and strlen($cnpj_revenda) > 5 ){
		$sql = "SELECT nome,cnpj,fone,revenda FROM tbl_revenda where cnpj = '$cnpj_revenda'";
		$res = pg_query($con,$sql);
		if(pg_num_rows($res) > 0){
				$xrevenda      = pg_fetch_result($res, 0, 'revenda');
				$xrevenda_nome = "'".pg_fetch_result($res, 0, 'nome')."'";
				$cnpj_revenda  = pg_fetch_result($res, 0, 'cnpj');
				$fone_revenda  = pg_fetch_result($res, 0, 'fone');
		}else{
			$sql = "INSERT INTO tbl_revenda (
							nome,
							cnpj
					)values(
						$xrevenda_nome,
						'$cnpj_revenda'
					) returning revenda";
			$res = pg_query($con,$sql);
		    $xrevenda      = pg_fetch_result($res, 0, 'revenda');
		}
	}

    if (strlen($msg_erro) == 0 and $abre_os == 't') {

        if ($login_fabrica == 151) {
            if (strlen($mr_codigo_posto) == 0 && empty($os)) {
                $msg_erro = "Para que a PRÉ-OS seja aberta é necessário escolher um posto";
            }
        } else {
            if (strlen($mr_codigo_posto) == 0) {
                $msg_erro = "Para que a PRÉ-OS seja aberta é necessário escolher um posto";
            }
        }

        if (strlen($mr_codigo_posto) > 0) {

            $xcodigo_posto    = $mr_codigo_posto;
        }

        if (strlen($mr_codigo_posto) == 0) {

            if (in_array($login_fabrica, array(30,50,156,190))) {
                $msg_erro = "Para que a OS seja aberta é necessário escolher um posto";
            } else if ($login_fabrica == 151 ) {
                if (empty($os)) {
                    $msg_erro = "Para que a PRÉ-OS seja aberta é necessário escolher um posto";
                }
            } else {
                $msg_erro = "Para que a PRÉ-OS seja aberta é necessário escolher um posto";
            }

        }

        if(strlen($produto_referencia) == 0 && !in_array($login_fabrica, [141,151,186,190,195])) {
            $p_os = '';

            if ($login_fabrica <> 156) {
                $p_os = 'PRÉ-';
            }

            $msg_erro = "Para que a {$p_os}OS seja aberta é necessário escolher um produto";
        }


        $xnota_fiscal   = "'".$_POST["nota_fiscal"]."'";
        $valida_cpf_cnpj = verificaCpfCnpj(preg_replace("/\D/","",$consumidor_cpf));

        if(empty($valida_cpf_cnpj)){
            $consumidor_cpf = checaCPF($consumidor_cpf,false,true);

            if ($consumidor_cpf === false) {

                $consumidor_cpf = 'null';

                if ($consumidor_cpf == "nul" and strlen($_POST['consumidor_cpf']) != 0) {
                    $msg_erro = "CPF do consumidor inválido";
                }

            }
        }else{
            $msg_erro = $valida_cpf_cnpj;
        }

        if (strlen($msg_erro) == 0) {

            if (strlen($data_nf) == 0 || $login_fabrica <> 151){
                $xdata_nf = "NULL";
            }else{
                list($ddf, $mdf, $ydf) = explode("/", $data_nf);
                if(!checkdate($mdf,$ddf,$ydf)) {
                    $msg_erro = "Data NF Inválida";
                }else{
                    $xdata_nf = "'".$ydf.'-'.$mdf.'-'.$ddf."'";
                }

            }

        }

    }

    //HD 932838
        if($login_fabrica==59 AND !empty($xproduto) and $xserie <> 'null') {
            $sql = "SELECT fn_serie_controle_sightgps($xproduto,$login_fabrica,$xserie)";
            $res = pg_query($con,$sql);
            $msg_erro .= pg_last_error($con);
        }

    if(strlen($xos) == 0){
        $xos = "null";
    }

    if($login_fabrica == 101){

        $motivo_contato = $_POST["motivo_contato"];

        if(!empty($array_campos_adicionais)){
            $array_campos_adicionais = json_decode($array_campos_adicionais);
            $array_campos_adicionais['motivo_contato'] = $motivo_contato;
            $array_campos_adicionais = json_encode($array_campos_adicionais);
        }else{
            $array_campos_adicionais = json_encode(array("motivo_contato" => $motivo_contato));
        }

    }

    $data_prov_ins = 'NULL';

    if (!empty($_POST['data_prov'])) {

        $data_prov_input = explode('/', $_POST['data_prov']);
        $erro_data = "Data Providência inválida.<br/>";
        $erro_status = 0;

        if (count($data_prov_input) <> 3) {
            $msg_erro .= $erro_data;
            $erro_status = 1;
        } elseif (!checkdate((int) $data_prov_input[1], (int) $data_prov_input[0], (int) $data_prov_input[2])) {
            $msg_erro .= $erro_data;
            $erro_status = 1;
        } else {
            $data_prov_fmt = $data_prov_input[2] . '-' . $data_prov_input[1] . '-' . $data_prov_input[0];
            $data_prov_ins = "'{$data_prov_fmt}'";
        }

        if($erro_status == 0 && $login_fabrica == 74){

            list($dia, $mes, $ano) = explode("/", $_POST['data_prov']);
            $data_prov_comp = strtotime($ano."-".$mes."-".$dia);
            $data_hoje_comp = strtotime(date("Y-m-d"));

            if($data_prov_comp < $data_hoje_comp){
                $msg_erro .= "A Data de Providência não pode ser menor que a data atual <br />";
            }
        }
    }

    if(in_array($login_fabrica, array(30))){
        $hd_chamado              = $_POST["callcenter"];
        $status_interacao        = $_POST["status_interacao"];
        $desbloquear_atendimento = $_POST["desbloquear_atendimento"];

        if($desbloquear_atendimento != "sim"){

            if($status_interacao == "Resolvido" ||  $status_interacao == "Cancelado"){

                $sql_os = "SELECT tbl_hd_chamado_extra.os, tbl_os.finalizada FROM tbl_hd_chamado_extra join tbl_os on tbl_os.os = tbl_hd_chamado_extra.os and tbl_os.fabrica = $login_fabrica WHERE tbl_hd_chamado_extra.hd_chamado = {$hd_chamado} and tbl_os.finalizada is null and tbl_os.data_fechamento is null ";
                $res_os = pg_query($con, $sql_os);
                if(pg_num_rows($res_os)>0){
                    $os_hd = pg_fetch_result($res_os, 0, "os");
    //              }
    //              if(strlen(trim($os_hd)) > 0){

                    $sql_os = "SELECT os,excluida FROM tbl_os WHERE os = {$os_hd} AND finalizada ISNULL AND data_fechamento ISNULL";
                    $res_os = pg_query($con, $sql_os);

                    if(pg_num_rows($res_os) > 0){
                        $excluida = pg_fetch_result($res_os, 0, 'excluida');
                        $bloqueia_envio_form = true;
                        if($excluida != 't') {
                            if($status_interacao == "Resolvido"){
                                    $msg_erro .= "
                                A Ordem de Serviço vinculada a este atendimento não está
                                finalizada. Este atendimento só pode ser resolvido após a
                                Finalização da Ordem de Serviço. <br />";
                            }

                            if($status_interacao == "Cancelado"){
                                 $msg_erro .= "
                                A Ordem de Serviço vinculada a este atendimento não está
                                finalizada. Este atendimento só pode ser cancelado após a
                                Cancelamento da Ordem de Serviço. <br />";
			    }
			    
			    $os_externa_atendimento = true;
                            $bloqueia_envio_form    = true;

                        }
                    }

                }else{

                    $nota_fiscal     = $_POST["nota_fiscal"];
                    $produto         = $_POST["produto"];
                    $nome_consumidor = $_POST["consumidor_nome"];

                    $nota_fiscal = str_pad($nota_fiscal, 6, "0", STR_PAD_LEFT);

                    $sql_os = "SELECT
                                    os
                                FROM tbl_os
                                WHERE
                                    consumidor_nome = '{$nome_consumidor}'
                                    AND nota_fiscal = '{$nota_fiscal}'
                                    AND produto = {$produto}
                                    AND finalizada ISNULL
                                    AND data_fechamento ISNULL
                                    AND cancelada is not true
                                    AND excluida is not true ";
                    $res_os = pg_query($con, $sql_os);

                    if(pg_num_rows($res_os) > 0){

                        $os_hd = pg_fetch_result($res_os, 0, "os");


                        if($status_interacao == "Resolvido"){

                            $msg_erro .= "
                                O Sistema identificou que o consumidor da Ordem de Serviço
                                {$os_hd} possui o mesmo nome e produto do consumidor deste
                                atendimento. <br />
                                Este atendimento só pode ser resolvido após o
                                fechamento da Ordem de Serviço. <br />
                            ";
                        }

                        if($status_interacao == "Cancelado"){

                            $msg_erro .= "
                                O Sistema identificou que o consumidor da Ordem de Serviço
                                {$os_hd} possui o mesmo nome e produto do consumidor deste
                                atendimento. <br />
                                Este atendimento só pode ser cancelado após o
                                Cancelamento da Ordem de Serviço. <br />
                            ";
                        }
			
			$os_externa_atendimento = true;
                        $bloqueia_envio_form    = true;

                    }
                }
            }
        }
    }

    /******************************************* INSERÇÃO *******************************************/
    if (strlen($callcenter) == 0) {

        $insert_hd_chamado = "sim";

        if (strlen($msg_erro) == 0) {
            $res = pg_query ($con, "BEGIN TRANSACTION");
            if ($login_fabrica == 30 && (isset($_POST['hd_motivo_ligacao']) && $_POST['hd_motivo_ligacao'] == 162)) {
                if (!empty($xos_c_troca)) {
                    $xos = $xos_c_troca;
                    $sql = "SELECT os FROM tbl_os WHERE os = {$xos_c_troca}";
                    $res = pg_query($con, $sql);
                    if (pg_num_rows($res) == 0) {
                        $msg_erro .= "Ordem de serviço aguardando comprovante de troca não encontrada";
                    }
                }else{
                    $msg_erro .= "Ordem de serviço aguardando comprovante de troca não foi informada";
                }
            }

            if (strlen($consumidor_nome) > 0 and strlen($consumidor_estado) > 0 and strlen($consumidor_cidade) > 0) {

                $sql = "SELECT cidade FROM tbl_cidade WHERE UPPER(fn_retira_especiais(nome)) = UPPER(fn_retira_especiais('{$consumidor_cidade}')) AND UPPER(estado) = UPPER('{$consumidor_estado}')";
                $res = pg_query($con, $sql);

                if (pg_num_rows($res) > 0) {
                    $cidade = pg_fetch_result($res, 0, "cidade");
                } else {
                    $sql = "SELECT upper(fn_retira_especiais(cidade)) as cidade, estado FROM tbl_ibge WHERE UPPER(fn_retira_especiais(cidade)) = UPPER(fn_retira_especiais('{$consumidor_cidade}')) AND UPPER(estado) = UPPER('{$consumidor_estado}')";
                    $res = pg_query($con, $sql);

                    if (pg_num_rows($res) > 0) {
                        $cidade_ibge        = pg_fetch_result($res, 0, "cidade");
                        $cidade_estado_ibge = pg_fetch_result($res, 0, "estado");

                        $sql = "INSERT INTO tbl_cidade (
                                    nome, estado
                                ) VALUES (
                                    '{$cidade_ibge}', '{$cidade_estado_ibge}'
                                ) RETURNING cidade";
                        $res = pg_query($con, $sql);

                        $cidade = pg_fetch_result($res, 0, "cidade");
                    } else {
						if($consumidor_pais == 'BR' or empty($consumidor_pais)) {
							$msg_erro .= "Cidade do consumidor não encontrada";
						}elseif(is_numeric($consumidor_cidade) and $consumidor_pais <>'BR'){
							$cidade = $consumidor_cidade;
						}

                    }
                }
            } else if($indicacao_posto == 'f' && !in_array($login_fabrica, array(125,161,162,163,164,167,175,176,178,195,203))) {
                if (in_array($login_fabrica, array(169,170))){
                    if ($tab_atual != 'sugestao' && $desbloqueia_obrigatorios === false){
                        $msg_erro .= "Informe a cidade do consumidor";
                    }
                }elseif (!in_array($login_fabrica, [174,184,186,200])) {
                    if ((in_array($login_fabrica,[52,161]) && $_POST["consumidor_pais"] == 'BR') || !in_array($login_fabrica, array(52,139,161))) {
                        $msg_erro .= "Informe a cidade do consumidor";
                    }
                }

            }

			if(is_numeric($consumidor_cidade) and $consumidor_pais <>'BR'){
				$cidade = $consumidor_cidade;
			}

        }

        if ($tab_atual == 'reclamacoes') {
            $tab_atual = $tipo_reclamado;
        }

        if ($login_fabrica == 2) {

            if ($tab_atual == "reclamacao_produto") {

                $up_tipo_reclamacao = array("aquisicao_mat","aquisicao_prod","indicacao_posto","solicitacao_manual");

                if (in_array($tipo_reclamacao, $up_tipo_reclamacao)) {
                    $tab_atual = $tipo_reclamacao;
                }

                if ($tab_atual == 'reclamacao_produto') {
                    $tab_atual = $tipo_reclamado;
                }

            }

            if ($tab_atual == "reclamacoes") {

                $up_tipo_reclamacao = array("reclamacao_revenda","reclamacao_at","reclamacao_enderecos","reclamacao_produto",
                    "reclamacao_conserto", "reclamacao_posto_aut", "reclamacao_orgao_ser", "repeticao_chamado", "reclamacao_outro");
                if (in_array($tipo_reclamacao, $up_tipo_reclamacao)) {
                    $tab_atual = $tipo_reclamacao;
                }

                if ($tab_atual == 'reclamacoes') {
                    $tab_atual = $tipo_reclamado;
                }

            }

            if ($tab_atual == "duvida_produto") {
                $up_tipo_reclamacao = array("especificacao_manuseio","informacao_manuseio","informacao_tecnica","orientacao_instalacao");

                if (in_array($tipo_reclamacao, $up_tipo_reclamacao)) {
                    $tab_atual = $tipo_reclamacao;
                }

                if ($tab_atual == 'duvida_produto') {
                    $tab_atual = $tipo_reclamado;
                }

            }

        }

        if (strlen($cliente_admin) == 0 and $login_fabrica <> 52) {
            $cliente_admin = 'null';
        }

        if ($login_fabrica == 190 && strlen($consumidor_cpf) > 0 && $consumidor_cpf != "null") {

            $xconsumidor_cpf = str_replace(["-",".","/"], "", $consumidor_cpf);
            $sqlClienteAdmin = "SELECT cliente_admin FROM tbl_cliente_admin WHERE fabrica={$login_fabrica} AND cnpj='{$xconsumidor_cpf}'";
            $resClienteAdmin = pg_query($con, $sqlClienteAdmin);
            if (pg_num_rows($resClienteAdmin) > 0) {
                $cliente_admin = pg_fetch_result($resClienteAdmin, 0, 'cliente_admin');
            }
        }


        $protocolo = $_POST['protocolo_id'];

        if (strlen($callcenter_assunto) > 0 && is_array($callcenter_assunto)) { #HD 251241
            $callcenter_assunto = trim(implode("", $callcenter_assunto));
        }
        if ($login_fabrica == 24 and !in_array($tab_atual, array('outros_assuntos','procon','sugestao'))) {

            if (strlen($callcenter_assunto) > 0) {
                $achou_categoria_assunto = false;

                //Localiza o assunto dentro do array $assuntos (definido em callcenter_suggar_assuntos)
                foreach ($assuntos as $categoria_assunto => $itens_categoria_assunto) {

                    foreach ($itens_categoria_assunto as $label_assunto => $bd_assunto) {

                        if ($bd_assunto == $callcenter_assunto) {
                            $categoria_banco         = $callcenter_assunto;
                            $achou_categoria_assunto = true;
                        }

                    }

                }

                if ($achou_categoria_assunto == false) {
                    $msg_erro .= "<br>Assunto não encontrado";
                }

            }

        } else {

            $categoria_banco = $tab_atual;

        }

        if($login_fabrica == 136){

            $gerar_pedido_posto_interno = $_POST["gerar_pedido_posto_interno"];
            if($gerar_pedido_posto_interno == "t"){
                $xstatus_interacao = "'Peças Pendentes'";
            }

        }
        if(strlen($msg_erro) == 0 and strlen($protocolo) > 0){

            $sql_verifica = "SELECT hd_chamado FROM tbl_hd_chamado WHERE hd_chamado = $protocolo and fabrica = $login_fabrica";
            $res_verifica = pg_query($con, $sql_verifica);

            if(pg_num_rows($res_verifica) ==0 ){

		$titulo = 'Atendimento interativo'; 

                $sql_grava_hd_extra = "INSERT INTO tbl_hd_chamado (hd_chamado, titulo,fabrica, fabrica_responsavel,admin,atendente) values ($protocolo, 'Atendimento interativo',$login_fabrica,$login_fabrica,$login_admin, $login_admin)";
                $res_grava_hd_extra = pg_query($con,$sql_grava_hd_extra);
                $msg_erro = pg_errormessage($con);


                $sql_grava_hd = "INSERT INTO tbl_hd_chamado_extra (hd_chamado) values ($protocolo)";
                $res_grava_hd = pg_query($con,$sql_grava_hd);
                $msg_erro = pg_errormessage($con);
            }
        }

        if (strlen($msg_erro) == 0 and strlen($callcenter) == 0 and strlen($protocolo) == 0) {

            $titulo = 'Atendimento interativo';

            if ($indicacao_posto == 't') $titulo = 'Indicação de Posto';

            if ($login_fabrica == 85 && ($atendimento_ambev == "t" || $atendimento_contratual == "t")) {
                    $xserie                     = $_POST['serie'];

                    if (strlen(trim($xserie)) == 0) {
                        $xserie = "null";
                    } else {
                        $xserie = "'".$xserie."'";
                    }

                if ($atendimento_ambev == "t") {
                    $cliente_admin = $cliente_admin_ambev;
                    $garantia_estendida_check   = $_POST["garantia_estendida_check"];

                    if($garantia_estendida_check == "t"){
                        $categoria  = "garantia_estendida";
                        $reclamado  = $_POST["reclamado_garantia_estendida"];
                        $xreclamado = "'".$reclamado."'";
                    }
                } else {
                    $garantia_contratual_check = $_POST["garantia_contratual_check"];

                    if($garantia_contratual_check == "t"){
                        $categoria  = "garantia_contratual";
                        $reclamado  = $_POST["descricao_garantia_contratual"];
                        $xreclamado = "'".$reclamado."'";
                    }
                }
            }

            if ($login_fabrica == 115 OR $login_fabrica == 116) {
                $data_de_retorno = $_POST["data_de_retorno"] ;

                if (strlen($data_de_retorno) == 0){
                    $data_de_retorno = "NULL";
                    $data_de_retorno_in = "";
                    $data_de_retorno_ins = "";
                }else{
                    list($ddf, $mdf, $ydf) = explode("/", $data_de_retorno);
                    if(!checkdate($mdf,$ddf,$ydf)) {
                        $msg_erro = "Data Retorno Inválida";
                    }else{
                        $dataexplode = explode('/', $data_de_retorno);
                        $data_de_retorno_timestamp = strtotime($dataexplode[2]."-".$dataexplode[1]."-".$dataexplode[0]);
                        $data_hoje_timestamp = strtotime(date('y-m-d',time()));


                        if($data_de_retorno_timestamp < $data_hoje_timestamp){
                            $msg_erro = "A Data de Retorno não pode ser inferior ao dia ".date("d-m-Y",time());
                        }else{
                            $xdata_de_retorno = "'".$ydf.'-'.$mdf.'-'.$ddf."'";
                            $data_de_retorno_in = ", data_providencia, esta_agendado";
                            $data_de_retorno_ins = ", '".$ydf.'-'.$mdf.'-'.$ddf."', 't'";
                        }
                    }
                }
            }

            if($login_fabrica == 30){
                $motivo_situacao = $_POST['motivo_situacao'];
                if(empty($motivo_situacao)){
                    $msg_erro .= "Informe o motivo por este atendimento estar em aberto";
                }

                $sqlProv = "SELECT campos_adicionais FROM tbl_hd_motivo_ligacao WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}";
                $resProv = pg_query($con,$sqlProv);

                $situacaoProv = pg_fetch_result($resProv,0,'campos_adicionais');
                $situacaoProv = json_decode($situacaoProv,true);
                $situacaoProv = array_filter($situacaoProv['situacoes']);

                if(count($situacaoProv) > 0 AND !in_array($status_interacao,$situacaoProv)){
                    $msg_erro .= "A providência informada não pode ser utilizada para a situação atual do atendimento";
                }
            }

            if ($login_fabrica == 162) { //HD-3352176
                $motivo_situacao = $_POST['motivo_situacao'];
                if (strlen($transferir) > 0) {
                    if (empty($motivo_situacao)) {
                        $msg_erro = "Informe o motivo da transferência deste atendimento";
                    }
                }
            }

            if ($login_fabrica == 174) {
                $data_aprovacao_in = ", data_aprovacao";
                $data_aprovacao_ins = ", ".current_timestamp;
            } else {
                $data_aprovacao_in = "";
                $data_aprovacao_ins = "";
            }

            if ($login_fabrica == 151 and strlen($callcenter) == 0) {
                $autoriza_gravacao = $_POST["autoriza_gravacao"];
                if (strlen($autoriza_gravacao) > 0 AND $autoriza_gravacao != "desbloqueado" ) {
                    $msg_erro = "Atendimento precisa de autorização do interventor.";
                }
            }

            if (strlen($msg_erro) == 0) {
                if ($moduloProvidencia && $login_fabrica != 189) {
                    $transferir_atendimento = "sim";
                }

                if ($login_fabrica == 115){ //hd_chamado=2710901
                    if (strlen(trim($hd_chamado_anterior_n)) > 0) {
                        $hd_chamado_anterior_in = ", hd_chamado_anterior";
                        $hd_chamado_anterior_ins = ", $hd_chamado_anterior_n";
                    }
                }

                if (in_array($login_fabrica,array(30))) {
                    $campo_orientacao = ",analise ";
                    $valor_orientacao = ",'$orientacao_posto'";
                }

                if (in_array($login_fabrica, [85])) {
                    $campo_cliente = ", cliente";
                    $valor_cliente = ", $xid_cliente_contratual";
                }

                if ($login_fabrica == 52) {
                    if (strlen($cliente_admin) == 0) $cliente_admin = 'NULL';

                    $campo_hd_classificacao = " ,hd_classificacao ";
                    $valor_hd_classificacao = " ,$hd_classificacao ";
                } else {
                    $campo_hd_classificacao = "";
                    $valor_hd_classificacao = "";
                }

                if ($login_fabrica == 183){

                    if (strlen(trim($id_zendesk)) > 0){
                        $array_zendesk["id_zendesk"] = $id_zendesk;

                        $dados_zendesk = json_encode($array_zendesk);
                        $campo_zendesk = " , campos_adicionais ";
                        $valor_zendesk = " , '$dados_zendesk'";
                    }
                }

                if(in_array($login_fabrica, [169,170])){
                    $campo_tipo_protocolo = ", hd_tipo_chamado";
                    $valor_tipo_protocolo = ",$tipo_protocolo";
                }

                //INSERCAO PRINCIPAL
                $sql = "INSERT INTO tbl_hd_chamado (
                            admin,
                            cliente_admin,
                            data,
                            status,
                            atendente,
                            fabrica_responsavel,
                            titulo,
                            categoria,
                            fabrica,
                            data_providencia
                            $data_aprovacao_in
                            $data_de_retorno_in
                            $hd_chamado_anterior_in
                            $campo_orientacao
                            $campo_cliente
                            $campo_hd_classificacao
                            $campo_zendesk
                            $campo_tipo_protocolo
                        ) values (
                            $login_admin,
                            $cliente_admin,
                            current_timestamp,
                            $xstatus_interacao,
                            $login_admin,
                            $login_fabrica,
                            '$titulo',
                            '$categoria_banco',
                            $login_fabrica,
                            $data_prov_ins
                            $data_aprovacao_ins
                            $data_de_retorno_ins
                            $hd_chamado_anterior_ins
                            $valor_orientacao
                            $valor_cliente
                            $valor_hd_classificacao
                            $valor_zendesk
                            $valor_tipo_protocolo
                    )";
                $res       = pg_query($con,$sql);
                $msg_erro .= pg_errormessage($con);

                //echo nl2br($sql);
                //echo pg_last_error($con);
                $res        = pg_query ($con, "SELECT CURRVAL ('seq_hd_chamado')");
                $hd_chamado = pg_fetch_result($res,0,0);
                if($login_fabrica == 189 and $envia_email_representante == 't'){

                    $sqlTipoPosto = "SELECT * FROM tbl_tipo_posto WHERE tipo_posto={$tipo_posto} AND fabrica = {$login_fabrica}";
                    $resTipoPosto = pg_query($con, $sqlTipoPosto);

                    $nomeTipo = pg_fetch_result($resTipoPosto, 0, 'descricao');


                    $assunto = "INDICAÃÃO DE ".strtoupper($nomeTipo)." - PROTOCOLO $hd_chamado ";
                    $mensagem = "Boa Tarde, <br><br> Indicamos vosso contato para o cliente abaixo: <br><br>
                    NOME: ".$_POST["consumidor_nome"]." <br>
                    TELEFONE: ".$_POST['consumidor_fone']." <br>
                    EMPRESA: $nome_empresa <br>
                    CPF/CNPJ: ".$_POST["consumidor_cpf"]." <br>
                    DESTINO DA MERCADORIA: $tipo_cliente <br>
                    <br>";

                    $mailTc = new TcComm($externalId);
                    $res = $mailTc->sendMail(
                        $posto_email_tab,
                        $assunto,
                        $mensagem,
                        'carolina.mantovani@viapol.com.br'
                    );
                }

                if($moduloProvidencia){
                    if(!in_array($login_fabrica, array(169,170))){
                        if(!empty($hd_motivo_ligacao) && empty($codigo_posto_tab)){

                            $sql = "SELECT descricao FROM tbl_hd_motivo_ligacao WHERE hd_motivo_ligacao = $hd_motivo_ligacao AND fabrica = $login_fabrica";
                            $resHd_motivo = pg_query($con, $sql);

                            if(pg_num_rows($resHd_motivo) > 0){
                                $texto = pg_fetch_result($resHd_motivo, 0, "descricao");

                                //if ($login_fabrica == 183){
                                if(in_array($login_fabrica, array(151,183))){
                                    $campo_mtl = ", hd_motivo_ligacao";
                                    $valor_mtl = ", $hd_motivo_ligacao";
                                }
                                $sql = "INSERT INTO tbl_hd_chamado_item (hd_chamado, comentario, admin $campo_mtl )
                                    VALUES ($hd_chamado, '$texto', $login_admin $valor_mtl)";
                                pg_query($con,$sql);
                            }
                        }
                    }
                }
            }

        } else {

            if (strlen($msg_erro) == 0 and strlen($protocolo) > 0) {

                $sql = "UPDATE tbl_hd_chamado set
                        cliente_admin         = $cliente_admin,
                        status                = $xstatus_interacao,
                        atendente             = $login_admin,
                        titulo                = '$titulo',
                        categoria             = '$categoria_banco'
                        WHERE hd_chamado = $protocolo";

                $res = pg_query($con, $sql);
                $msg_erro .= pg_errormessage($con);

                if (strlen($msg_erro) == 0) {
                    $hd_chamado = $protocolo;
                }
            }

        }

        if (in_array($login_fabrica, array(169,170))){ //validação OS vinculada ao Callcenter
            if (strlen(trim($os)) > 0){
                $sql_posto_os = "
                    SELECT tbl_os.posto, tbl_posto.nome, tbl_os.hd_chamado, tbl_os.obs
                    FROM tbl_os
                    JOIN tbl_posto ON tbl_posto.posto = tbl_os.posto
                    JOIN tbl_posto_fabrica ON tbl_posto_fabrica.posto = tbl_posto.posto
                        AND tbl_posto_fabrica.fabrica = {$login_fabrica}
                    WHERE tbl_os.os = {$os}
                    AND tbl_os.fabrica = {$login_fabrica}";
                $res_posto_os = pg_query($con, $sql_posto_os);

                if (pg_num_rows($res_posto_os) > 0){
                    $posto_os_nome              = pg_fetch_result($res_posto_os, 0, 'nome');
                    $posto_os                   = pg_fetch_result($res_posto_os, 0, 'posto');
                    $hd_chamado_os_anterior     = pg_fetch_result($res_posto_os, 0, 'hd_chamado');
                    $obs_chamado_os_anterior    = pg_fetch_result($res_posto_os, 0, 'obs');

                    if ($abre_ordem_servico != 't' AND strlen($posto_tab) > 0) { // Entra na condição OS vinculada ao Callcenter

                        if ($posto_os <> $posto_tab){
                            $msg_erro .= "O posto autorizado da Ordem de serviço é diferente do Posto autorizado do atendimento.";
                        }else{
                            $sql = "SELECT hd_chamado FROM tbl_hd_chamado_item WHERE hd_chamado = $hd_chamado
                                AND comentario ~'foi vinculada ao atendimento'";
                            $res = pg_query($con, $sql);
                            if (pg_num_rows($res) == 0){
                                $sql = "INSERT INTO tbl_hd_chamado_item(
                                        hd_chamado   ,
                                        data         ,
                                        comentario   ,
                                        admin        ,
                                        interno
                                    ) values (
                                        $hd_chamado       ,
                                        current_timestamp ,
                                        E'A OS: $os foi vinculada ao atendimento.',
                                        $login_admin      ,
                                        't'
                                    )";
                                $res = pg_query($con,$sql);
                            }
                        }
                    }
                    if (empty($msg_erro)){
                        if (!empty($hd_chamado_os_anterior)){
                            if ($hd_chamado_os_anterior <> $hd_chamado) {
                                $obs_chamado_os_anterior = $obs_chamado_os_anterior."<br/> OS vinculada ao Atendimento: {$hd_chamado}, Atendimento anterior: {$hd_chamado_os_anterior}";
                                $update_hd = "UPDATE tbl_os SET hd_chamado = {$hd_chamado}, obs = '$obs_chamado_os_anterior' WHERE os = {$os} AND fabrica = {$login_fabrica}";
                                $res_update_hd = pg_query($con, $update_hd);

                                $sql = "INSERT INTO tbl_hd_chamado_item(
                                        hd_chamado   ,
                                        data         ,
                                        comentario   ,
                                        admin        ,
                                        interno
                                    ) values (
                                        $hd_chamado       ,
                                        current_timestamp ,
                                        E'OS vinculada ao Atendimento: {$hd_chamado}, Atendimento anterior: {$hd_chamado_os_anterior}',
                                        $login_admin      ,
                                        't'
                                    )";
                                $res = pg_query($con,$sql);
                            }
                        }else{
                            $update_hd = "UPDATE tbl_os SET hd_chamado = {$hd_chamado} WHERE os = {$os} AND fabrica = {$login_fabrica}";
                            $res_update_hd = pg_query($con, $update_hd);
                        }
                    }
                }
            }
        }

        if ($login_fabrica == 51) {//HD 816610

            include_once 'pesquisa_satisfacao_config.php';
            include_once 'pesquisa_satisfacao_post.php';

        }
        if($login_fabrica == 30){
            if(strlen($xdata_limite) > 0){
                #$array_campos_adicionais = array();
                $array_campos_adicionais['data_limite'] = $data_limite;
                #$array_campos_adicionais = json_encode($array_campos_adicionais);
            }
            if (!empty(trim($obs_sac_adicionais))) {
                $array_campos_adicionais['observacao_sac'] = utf8_encode($obs_sac_adicionais);
            } else {
                $sqlOpt = "
                    SELECT  JSON_FIELD('observacao_sac',parametros_adicionais) AS observacao_sac
                    FROM    tbl_admin
                    WHERE   admin = $login_admin
                ";
                $resOpt = pg_query($con,$sqlOpt);
                $observacao_sac = pg_fetch_result($resOpt,0,observacao_sac);
                if ($observacao_sac == 't' && $tab_atual == 'reclamacao_produto') {
                    $msg_erro .= "Você deve preencher o campo Observação SAC<br />";
                }
            }
            # HD-2902269 INICIO
            $data_recebimento   = $_POST['data_recebimento'];
            $data_fatal         = $_POST['data_fatal'];

            if(strlen($data_recebimento) > 0 OR strlen($data_fatal) > 0){
                if(strlen($data_recebimento) > 0){
                    list($drd,$drm,$dra) = explode("/",$data_recebimento);
                    $xdata_recebimento = $dra."-".$drm."-".$drd;
                }
                if(strlen($data_fatal) > 0 ){
                    list($dfd,$dfm,$dfa) = explode("/",$data_fatal);
                    $xdata_fatal = $dfa."-".$dfm."-".$dfd;
                }
                if(strlen($data_nf) > 0){
                    list($dnd,$dnm,$dna) = explode("/",$data_nf);
                    #$xdata_nf = "'".$dna.'-'.$dnm.'-'.$dnd."'";
                    $xdata_nf = $dna."-".$dnm."-".$dnd;
                }

                if(strlen($data_recebimento) > 0 AND strlen($data_fatal) > 0){
                    if (strtotime($xdata_recebimento) > strtotime($xdata_fatal)) {
                        $msg_erro .= "Data fatal não pode ser menor que data recebimento <br/>";
                    }
                }

                if(strlen($data_recebimento) > 0 AND strlen($data_nf) > 0){
                    if (strtotime($xdata_recebimento) < strtotime($xdata_nf)) {
                        $msg_erro .= "Data recebimento não pode ser menor que data da nota fiscal <br/>";
                    }
                }

                if(strlen($data_fatal) > 0 AND strlen($data_nf) > 0){
                    if (strtotime($xdata_fatal) < strtotime($xdata_nf)) {
                        $msg_erro .= "Data fatal não pode ser menor que data da nota fiscal <br/>";
                    }
                }
            }

            $numero_sr  =   $_POST['numero_sr'];
            $numero_process  =   $_POST['numero_process'];
            $data_recebimento  =   $_POST['data_recebimento'];
            $data_fatal  =   $_POST['data_fatal'];
            $info_notificado  =   $_POST['info_notificado'];
            $nota_consumidor  =   $_POST['nota_consumidor'];
            $id_reclamacao  =   $_POST['id_reclamacao'];

            if ($_POST['numero_sr']) $array_campos_adicionais['numero_sr']                  = $_POST['numero_sr'];
            if ($_POST['numero_process']) $array_campos_adicionais['numero_process']        = $_POST['numero_process'];
            if ($_POST['data_recebimento']) $array_campos_adicionais['data_recebimento']    = $_POST['data_recebimento'];
            if ($_POST['data_fatal']) $array_campos_adicionais['data_fatal']                = $_POST['data_fatal'];
            if ($_POST['info_notificado']) $array_campos_adicionais['info_notificado']      = $_POST['info_notificado'];
            if ($_POST['nota_consumidor']) $array_campos_adicionais['nota_consumidor']      = $_POST['nota_consumidor'];
            if ($_POST['id_reclamacao']) $array_campos_adicionais['id_reclamacao']          = $_POST['id_reclamacao'];
            $array_campos_adicionais = json_encode($array_campos_adicionais);
            # HD-2902269 FIM
        }

        if (in_array($login_fabrica, array(141))) {
            if (!empty(trim($obs_sac_adicionais))) {
                $array_campos_adicionais['observacao_sac'] = utf8_encode($obs_sac_adicionais);
            }
        }
        //HD 196942: Controle de postagem
        //o checkbox para solicitar postagem para o chamado só aparece quando não tem solicitação para aquele chamado, portanto só virá alguma coisa por POST em hd_chamado_postagem se não estiver cadastrado e se estiver com o checkbox marcado
        if ($_POST["hd_chamado_postagem"] == "sim" && strlen($hd_chamado) > 0 && strlen($msg_erro) == 0) {

            $sql = "SELECT hd_chamado FROM tbl_hd_chamado_postagem WHERE hd_chamado = $hd_chamado";
            $res = pg_query($con, $sql);

            if (pg_num_rows($res)) {

                $msg_erro .= "Já existe solicitação de postagem cadastrada para este chamado. Não é permitido o cadastramento de mais de uma postagem para um mesmo chamado";

            } else {

                $sql = "INSERT INTO tbl_hd_chamado_postagem(hd_chamado, fabrica) VALUES($hd_chamado,$login_fabrica)";
                $res = @pg_query($con, $sql);

                if (pg_errormessage($con)) {
                    $msg_erro .= "Houve um erro ao cadastrar a sua solicitação de postagem. Contate o HelpDesk";
                }

            }

        }

        if($login_fabrica == 125 and $consumidor_revenda == "R"){

            $tel_fixo_revenda       = $_POST["tel_fixo_revenda"];
            $cel_revenda            = $_POST["cel_revenda"];

            if((strlen(trim($tel_fixo_revenda))==0) and (strlen(trim($cel_revenda))==0)){
                $msg_erro .= "Informe um telefone de contato para revenda. <br>";
            }

            if(strlen(trim($nome_revenda))==0){
                $msg_erro .= "Informe o Nome da Revenda. <br>";
            }

            if(strlen(trim($responsavel_revenda))==0){
                $msg_erro .= "Informe um responsável. <br>";
            }

        }

        if (strlen($msg_erro) == 0 and strlen($callcenter) == 0) {

            $xnota_fiscal = "'".$_POST["nota_fiscal"]."'";

            if (strlen($abre_os) == 0) {
                $abre_os = 'f';
            }

            $xabre_os = $abre_os;

            //HD 205933: Habilitar abertura de ORDEM DE SERVIÃO para a Esmaltec
            if (strlen($abre_ordem_servico) == 0) { $abre_ordem_servico = 'f';}
            $xabre_ordem_servico = "'".$abre_ordem_servico."'";

            $data_nf = $_POST["data_nf"] ;
            if (strlen($data_nf) == 0){
                $xdata_nf = "NULL";
            }else{
                list($ddf, $mdf, $ydf) = explode("/", $data_nf);
                if(!checkdate($mdf,$ddf,$ydf)) {
                    $msg_erro .= "Data NF Inválida";
                }elseif(strlen($ydf) <> 4){
                    $msg_erro .= "Informar 4 digitos para ano de data da nota ";
                }else{
                    $xdata_nf = "'".$ydf.'-'.$mdf.'-'.$ddf."'";
                }

            }

            if ($login_fabrica == 3) {

                if (strtoupper($status_interacao) == 'RESOLVIDO' OR strtoupper($status_interacao) == 'CANCELADO') {
                    $tipo_registro ="Contato";
                } else if ($status_interacao == 'Aberto') {
                    $tipo_registro ="Processo";
                }

            } else {
                $tipo_registro = "";
            }
            if (strlen($mr_codigo_posto) > 0 and ($tab_atual <> 'indicacao_at') and empty($codigo_posto)) {
                $xcodigo_posto = $mr_codigo_posto;
            }

            if (strlen($posto_km_tab) == 0) {
                $posto_km_tab = 0;
			} else {
				$posto_km_tab = str_replace(',','.',$posto_km_tab);
			}

            if (strlen($atendimento_callcenter) > 0) {
				$condicao = ", atendimento_callcenter = '$atendimento_callcenter' ";
			}

            $contato_nome = !empty($contato_nome) ? $contato_nome : "";

            if ($login_fabrica == 156) {
                if ($_POST['responsavel_nome'] or $_POST['responsavel_fone']) {
                    if ($array_campos_adicionais === "''")
                        $array_campos_adicionais = array();
                    if (!is_array($array_campos_adicionais)) {
                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    }
                    if ($_POST['responsavel_nome']) $array_campos_adicionais['responsavel']     = $_POST['responsavel_nome'];
                    if ($_POST['responsavel_fone']) $array_campos_adicionais['tel_responsavel'] = $_POST['responsavel_fone'];
                    $array_campos_adicionais = json_encode($array_campos_adicionais);
                }
            }

            if (strlen($protocolo) == 0) {                
                if (in_array($login_fabrica, [184,200]) && !empty($xos) && $xos != "null") {
                    $sqlOsAt = "INSERT INTO tbl_hd_chamado_item(
                                hd_chamado   ,
                                data         ,
                                comentario   ,
                                admin        ,
                                interno
                            ) VALUES(
                                $hd_chamado  ,
                                current_timestamp,
                                E'A OS: $xos foi vinculada ao atendimento.',
                                {$login_admin},
                                't'
                            )";
                    $resOsAt = pg_query($con, $sqlOsAt);
                }
				if ($login_fabrica == 85 || $login_fabrica == 24 || $login_fabrica == 15 ) {
					if ($login_fabrica == 85) {
						if ($atendimento_ambev == "t") {
							$array_campos_adicionais = array(
                                "atendimento_ambev"       => $atendimento_ambev,
                                "codigo_ambev"            => $codigo_ambev,
                                "data_previsao_ambev"     => $data_previsao_ambev,
                                "data_fabricacao_ambev"   => $data_fabricacao_ambev,
                                "data_encerramento_ambev" => $data_encerramento_ambev,
                                "atendimento_ambev_nome"  => $atendimento_ambev_nome,
                                "garantia_estendida_ambev" => $garantia_estendida_ambev
                            );
                        } else {
                            $array_campos_adicionais = array(
                                "atendimento_ambev"         => "f"                      ,
                                "data_previsao_ambev"       => $data_previsao_ambev     ,
                                "data_fabricacao_ambev"     => $data_fabricacao_ambev   ,
                                "atendimento_ambev_nome"    => $atendimento_ambev_nome
                            );
                        }

                        $array_campos_adicionais["atendimento_contratual"] = $atendimento_contratual;
                        $array_campos_adicionais["garantia_contratual"] = $garantia_contratual_cliente;

                        $array_campos_adicionais["consumidor_cpf_cnpj"] = $consumidor_cpf_cnpj;

                        if ($consumidor_cpf_cnpj == "R") {
                            $array_campos_adicionais["nome_fantasia"] = utf8_encode($nome_fantasia);
                        }
                        $array_campos_adicionais["voltagem"] = $voltagem;
                    }
                    if( $login_fabrica == 15) {
                        if (strlen($aux_data_retorno) > 0) {
                            $array_campos_adicionais = array(
                                "data_retorno"       => $aux_data_retorno
                            );

                        }
                    }


                    if ($login_fabrica == 24 and strlen($aux_ligacao_agendada) > 5) {
                        $array_campos_adicionais = array("ligacao_agendada" => $aux_ligacao_agendada);
                    }

                    $array_campos_adicionais = str_replace("\\", "\\\\", json_encode($array_campos_adicionais));

                }else if($login_fabrica >= 138 and !in_array($login_fabrica, array(153,172,183))){
                    // print_r($array_campos_adicionais);
                    if ($login_fabrica == 141) {
                        $array_campos_adicionais["voltagem"] = $voltagem;
                        $array_campos_adicionais = json_encode($array_campos_adicionais);
                    } else {
                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);
						if (!empty($voltagem)) {
							$array_campos_adicionais["voltagem"] = $voltagem;
						}
						if (!empty($consumidor_pais)) {
							$array_campos_adicionais["pais"] = $consumidor_pais;
						}
                        $array_campos_adicionais = json_encode($array_campos_adicionais);
						//var_dump($array_campos_adicionais);
                    }
                }

                if(in_array($login_fabrica, array(158))){
                    $dataFabricacao = DateTime::createFromFormat('d/m/Y', $_POST['data_fabricacao']);
                    $dataFabricacao = date_format($dataFabricacao, 'Y-m-d');
                    $dataVenda      = DateTime::createFromFormat('d/m/Y', $_POST['data_venda']);
                    $dataVenda      = date_format($dataVenda, 'Y-m-d');

                    $array_campos_adicionais                     = json_decode($array_campos_adicionais, true);
                    $array_campos_adicionais['tensao']           = $tensao;
                    $array_campos_adicionais['tempo_instalacao'] = $tempo_instalacao;
                    $array_campos_adicionais['unidade_negocio']  = $_POST['unidade_negocio_imbera'];
                    $array_campos_adicionais['data_fabricacao']  = $dataFabricacao;
                    $array_campos_adicionais['data_venda']       = $dataVenda;
                    $array_campos_adicionais                     = json_encode($array_campos_adicionais);
                }

                if($login_fabrica == 30){ //Lin pediu para tirar, isso irá funcionario somente qdo existir callcenter
                    if(!empty($array_campos_adicionais)){
                                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                        if(strlen($data_programada) > 0){
                            $array_campos_adicionais['data_programada']     = $data_programada;
                        }
                        $array_campos_adicionais['admin_agendamento']   = $login_admin;
                        $array_campos_adicionais = json_encode($array_campos_adicionais);
                    }
                }

                if($login_fabrica == 160 or $replica_einhell){
                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    $array_campos_adicionais["versao_produto"] = $versao;
                    $array_campos_adicionais = json_encode($array_campos_adicionais, true);
                }

                if ($login_fabrica == 156) {
                    if ($_POST['responsavel_nome'] or $_POST['responsavel_fone']) {
                        if ($array_campos_adicionais === "''")
                            $array_campos_adicionais = array();
                        if (!is_array($array_campos_adicionais)) {
                            $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                        }
                        if ($_POST['responsavel_nome']) $array_campos_adicionais['responsavel']     = $_POST['responsavel_nome'];
                        if ($_POST['responsavel_fone']) $array_campos_adicionais['tel_responsavel'] = $_POST['responsavel_fone'];
                        $array_campos_adicionais = json_encode($array_campos_adicionais);
                    }

                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    $array_campos_adicionais['tipo_atendimento'] = $tipo_atendimento_elgin;
                    $array_campos_adicionais = json_encode($array_campos_adicionais);

                }
                if($login_fabrica == 158){
                    if (!is_array($array_campos_adicionais)) {
                            $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    }
                    $array_campos_adicionais['tensao'] = $_POST['tensao'];
                    $array_campos_adicionais['tempo_instalacao'] = $_POST['tempo_instalacao'];

                    $array_campos_adicionais = json_encode($array_campos_adicionais);
                }

                if($login_fabrica == 101){
                    $tipo_registro = $_POST["consumidor_tipo_contato"];
                    if($tab_atual == "elogio"){
                        $reclamado = $_POST["reclamado_elogio"];
                        $xreclamado = "'$reclamado'";
                    }
                    if($tab_atual == "produto_acessorio_nao_entregue"){
                        $reclamado = $_POST["reclamado_produto_acessorio_nao_entregue"];
                        $xreclamado = "'$reclamado'";
                    }
                }

                if($login_fabrica == 42){
                    $tipo_registro = $_POST["consumidor_tipo_contato"];
                }

                if($login_fabrica == 125 and $consumidor_revenda == "R"){
                    $tel_fixo_revenda       = $_POST["tel_fixo_revenda"];
                    $cel_revenda            = $_POST["cel_revenda"];
                    $email_revenda          = $_POST["email_revenda"];
                    $responsavel_revenda    = $_POST["responsavel_revenda"];

                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    $array_campos_adicionais["tel_fixo_revenda"]    = $tel_fixo_revenda;
                    $array_campos_adicionais["cel_revenda"]         = $cel_revenda;
                    $array_campos_adicionais["email_revenda"]       = $email_revenda;
                    $array_campos_adicionais["responsavel_revenda"] = $responsavel_revenda;

                    $array_campos_adicionais = json_encode($array_campos_adicionais);
                }

                if(in_array($login_fabrica, [167, 203])){ //HD-3428316

                    $contador          = $_POST["contador"];
                    $linha_descricao   = $_POST['linha_descricao'];
                    $familia_descricao = $_POST['familia_descricao'];
                    $xserie            = $_POST['serie'];

                    if (strlen(trim($xserie)) == 0) {
                        $xserie = "null";
                    } else {
                        $xserie = "'".$xserie."'";
                    }

                    $array_campos_adicionais = array();
                    $array_campos_adicionais["voltagem"] = $voltagem;
                    if( strstr($familia_descricao, "Impressora") == true || strstr($familia_descricao, "Multifunciona") == true){
                        if(strlen(trim($xserie)) == 0 OR $xserie == "null"){
                            $msg_erro .= "Informe a série do produto <br/>";
                        }

                        if(strlen(trim($contador)) == 0){
                            $msg_erro .= "Informe o valor do Contador <br/>";
                        }else{
                            $array_campos_adicionais['contador'] = $contador;
                            $array_campos_adicionais = json_encode($array_campos_adicionais);
                        }
                    }

                }
                if($login_fabrica == 162){
                    $imei               = $_POST['imei'];
                    $linha_informatica  = $_POST['linha_informatica'];

                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    if (filter_input(INPUT_POST,'interno',FILTER_VALIDATE_INT)) {
                        $interno_aparencia      = filter_input(INPUT_POST,'interno_aparencia');
                        $interno_acessorios     = filter_input(INPUT_POST,'interno_acessorios');
                        $interno_atendimento    = filter_input(INPUT_POST,'interno_atendimento');
                        $interno_observacao     = filter_input(INPUT_POST,'interno_observacao');

                        $array_campos_adicionais['interno_aparencia']   = $interno_aparencia;
                        $array_campos_adicionais['interno_acessorios']  = $interno_acessorios;

                    }

                    $array_campos_adicionais['perfil_cliente']   = $_POST['perfil_cliente'];
                    $array_campos_adicionais['pedido_cliente']   = $_POST['pedido_cliente'];
                    $array_campos_adicionais['acordo_realizado']   = $_POST['acordo_realizado'];
                    $array_campos_adicionais['data_realizacao_acordo']   = $_POST['data_realizacao_acordo'];

                    if($_POST["acordo_realizado"] == "SIM"){
                        $array_campos_adicionais['tipo_acordo_realizado']   = $_POST['tipo_acordo_realizado'];
                    }else{
                        $array_campos_adicionais['tipo_acordo_realizado']   = "";
                    }

                    $array_campos_adicionais["imei"] = $imei;
                    $array_campos_adicionais["linha_informatica"] = $linha_informatica;
                    $array_campos_adicionais = json_encode($array_campos_adicionais);
                }

                if ($login_fabrica == 165) {
                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                    $array_campos_adicionais['indicacao_instalador_tecnico'] = $_POST['indicacao_instalador_tecnico'];

                    if (strlen($_POST['indicacao_instalador_comentario']) > 0) {
                        $indicacao_instalador_comentario  = $_POST["indicacao_instalador_comentario"];
                        $array_campos_adicionais['indicacao_instalador_comentario'] = utf8_encode($indicacao_instalador_comentario);
                    }

                    $array_campos_adicionais = json_encode($array_campos_adicionais);
                }

                //hd-3624967 - fputti

                if ($login_fabrica == 171) {
                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    unset($array_campos_adicionais["voltagem"]);
                    $array_campos_adicionais["projeto"] = $projeto;
                    $array_campos_adicionais["pressao_agua_mca"] = $pressao_agua_mca;
                    $array_campos_adicionais = json_encode($array_campos_adicionais);

                    $campoTipoAtendimentoGrohe = " tipo_atendimento,";

                    if (empty($tipo_atendimento_grohe)) {
                        $tipo_atendimento_grohe = "null";
                    }

                    $valorTipoAtendimentoGrohe = " $tipo_atendimento_grohe,";
                }

                if (in_array($login_fabrica, array(169,170))) {

                    if (strlen(trim($produto)) > 0 AND empty($servico_instalacao)){
                        $sql_contas_nacionais = "
                            SELECT
                                tbl_hd_motivo_ligacao.tipo_registro,
                                tbl_tipo_atendimento.tipo_atendimento
                            FROM tbl_hd_motivo_ligacao
                            JOIN tbl_tipo_atendimento ON tbl_tipo_atendimento.fabrica = tbl_hd_motivo_ligacao.fabrica
                                AND tbl_tipo_atendimento.fabrica = {$login_fabrica}
                            WHERE tbl_hd_motivo_ligacao.hd_motivo_ligacao = {$hd_motivo_ligacao}
                            AND tbl_tipo_atendimento.descricao = 'Garantia - Contas Nacionais'
                            AND tbl_hd_motivo_ligacao.fabrica = {$login_fabrica}
                            AND tbl_hd_motivo_ligacao.tipo_registro = 't' ";
                        $res_contas_nacionais = pg_query($con, $sql_contas_nacionais);

                        if (pg_num_rows($res_contas_nacionais) > 0){
                            $xtipo_atendimento = pg_fetch_result($res_contas_nacionais, 0, 'tipo_atendimento');
                        }else{
                            $sql = "SELECT
                                        tbl_linha.deslocamento,
                                        tbl_linha.linha
                                    FROM tbl_produto
                                        JOIN tbl_linha ON(tbl_produto.linha = tbl_linha.linha AND tbl_linha.fabrica = {$login_fabrica})
                                    WHERE tbl_produto.fabrica_i = {$login_fabrica}
                                    AND tbl_produto.produto = {$produto}";
                            $res = pg_query($con, $sql);

                            if (pg_num_rows($res) > 0){
                                $deslocamento    = pg_fetch_result($res, 0, "deslocamento");

                                if ($deslocamento == 't') {
                                    $sql = "SELECT
                                                tipo_atendimento
                                            FROM tbl_tipo_atendimento
                                            WHERE km_google IS TRUE
                                                AND fora_garantia IS NOT TRUE
                                                AND grupo_atendimento = 'P'
                                                AND descricao NOT ILIKE fn_retira_especiais('%Nacionais%')
                                                AND fabrica = {$login_fabrica};";
                                    $xres = pg_query($con, $sql);
                                }else{
                                    $sql = "SELECT
                                                tipo_atendimento
                                            FROM tbl_tipo_atendimento
                                            WHERE km_google IS NOT TRUE
                                                AND fora_garantia IS NOT TRUE
                                                AND grupo_atendimento = 'P'
                                                AND fabrica = {$login_fabrica};";
                                    $xres = pg_query($con, $sql);
                                }

                                if (pg_num_rows($xres) > 0){
                                    $xtipo_atendimento = pg_fetch_result($xres, 0, 'tipo_atendimento');
                                }
                            }
                        }
                    }else if (strlen(trim($produto)) > 0 AND strlen($servico_instalacao) > 0){
                        $xtipo_atendimento = $servico_instalacao;
                    }

                    if (empty($xtipo_atendimento)) {
                        $xtipo_atendimento = "null";
                    }

                    $garantia_estendida = "false";
                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                    $instalador_nome = $_POST["instalador_nome"];
                    $instalador_id   = $_POST["instalador_id"];

                    $array_campos_adicionais["instalador_nome"] = "";
                    $array_campos_adicionais["instalador_id"] = "";


                    if(strlen(trim($mapa_linha)) > 0){
                        $array_campos_adicionais["mapa_linha"] = $mapa_linha;
                    }

                    if (!empty($instalador_nome) && !empty($instalador_id)) {
                        $sqlInstalador = "SELECT nome FROM tbl_posto WHERE posto = {$instalador_id}";
                        $resInstalador = pg_query($con, $sqlInstalador);

                        if (pg_num_rows($resInstalador) > 0) {
                            $array_campos_adicionais["instalador_nome"] = utf8_encode(pg_fetch_result($resInstalador, 0, "nome"));
                            $array_campos_adicionais["instalador_id"] = $instalador_id;

                            $garantia_estendida = "true";
                        }
                    }

                    $array_campos_adicionais = json_encode($array_campos_adicionais);
                }

                if ($login_fabrica == 152) {

                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                    if ($duvida_consumidor == 'TE') {
                        $tipo_registro = "Técnica Equipamento";
                        $array_campos_adicionais["equipamentoeconsumivel"] = utf8_encode($equipamentoeconsumivel);
                    }elseif ($duvida_consumidor == 'TC') {
                        $tipo_registro = "Técnica Consumivel";
                        $array_campos_adicionais["equipamentoeconsumivel"] = utf8_encode($equipamentoeconsumivel);
                    } elseif ($duvida_consumidor == 'C') {
                        $tipo_registro = "Comercial";
                    } elseif ($duvida_consumidor == 'R') {
                        $tipo_registro = "Reclamacao";
                    }

                    $array_campos_adicionais["tipo_atendimento_consumidor"]  = utf8_encode($tipo_atendimento_consumidor);
                    $array_campos_adicionais = json_encode($array_campos_adicionais);
                }

                if ($login_fabrica == 85) {
                    $bonificacao = filter_input(INPUT_POST,'bonificacao');
                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                    if ($bonificacao == 't') {
                        $array_campos_adicionais['bonificacao'] = TRUE;
                        $array_campos_adicionais["bonificacao_admin"] = $login_admin;
                    } else {
                        $array_campos_adicionais['bonificacao'] = '';
                    }

                    /*HD - 4258409*/
                    if (!empty($_POST["check_tecnico_esporadico"]) && !empty($hd_chamado)) {
                        $tecnico_esporadico_id     = $_POST["tecnico_esporadico_id"];
                        $valor_servico_combinado   = $_POST["valor_servico_combinado"];
                        $valor_servico_combinado   = str_replace(array(".","R","$"), "", $valor_servico_combinado);
                        $valor_servico_combinado   = str_replace(",", ".", $valor_servico_combinado);

                        if (!empty($tecnico_esporadico_id) && !empty($valor_servico_combinado)) {
                            $array_campos_adicionais["tecnico_esporadico_id"]     = utf8_encode($tecnico_esporadico_id);
                            $array_campos_adicionais["valor_servico_combinado"]   = utf8_encode($valor_servico_combinado);

                            $aux_sql = "SELECT qtde_atendimento FROM tbl_tecnico WHERE tecnico = $tecnico_esporadico_id LIMIT 1";
                            $aux_res = pg_query($con, $aux_sql);
                            $qtde_at = (int) pg_fetch_result($aux_res, 0, 0);

                            if (empty($qtde_at) || $qtde_at == 0) {
                                $qtde_at = 1;
                            } else {
                                $qtde_at += 1;
                            }

                            $aux_sql = "UPDATE tbl_tecnico SET qtde_atendimento = $qtde_at WHERE tecnico = $tecnico_esporadico_id";
                            $aux_res = pg_query($con, $aux_sql);

                            if (pg_last_error()) {
                                $msg_erro .= "Erro ao registrar o novo atendimento ao téncico esporádico <br>";
                            }
                        }
                    }

                    $array_campos_adicionais = json_encode($array_campos_adicionais);
                    $array_campos_adicionais = str_replace("\\", "", $array_campos_adicionais);

                }

                if ($login_fabrica == 174) {
                    $pedido_info             = filter_input(INPUT_POST,'pedido_info');
                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                    $array_campos_adicionais['pedido_info'] = $pedido_info;

                    /*HD - 4382764*/
                    if (!empty($_POST["nome_loja"])) {
                        $nome_loja = $_POST["nome_loja"];
                        $array_campos_adicionais["nome_loja"] = $nome_loja;
                    }
                    if (!empty($_POST["hd_extra_data_entrega"])) {
                        $hd_extra_data_entrega = $_POST["hd_extra_data_entrega"];
                        $array_campos_adicionais["data_entrega"] = $hd_extra_data_entrega;
                    }

                    if ($_POST["consumidor_revenda"] == 'A') {
                        $array_campos_adicionais["tipo_atendimento"] = "B2B";
                    } else {
                        $array_campos_adicionais["tipo_atendimento"] = "B2C";
                    }

                    $array_campos_adicionais = json_encode($array_campos_adicionais);
                }

                /*HD - 4304128*/
                if (in_array($login_fabrica, [52])) {
                    $array_campos_adicionais["pais"] = $consumidor_pais;
                    $array_campos_adicionais         = json_encode($array_campos_adicionais);
				}

                if (in_array($login_fabrica, [177])) {
                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    $lote                    = $_POST['lote'];
                    $pais                    = $_POST['pais'];

                    $array_campos_adicionais["lote"] = $lote;
                    $array_campos_adicionais["pais"] = $pais;
                    $array_campos_adicionais = json_encode($array_campos_adicionais);
		        }
                /*HD - 6177097*/
                if ($login_fabrica == 151) {
                    if (strlen($_POST["titular_nota_fiscal"]) > 0) {
                        if (!is_array($array_campos_adicionais)) {
                            $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                        }

                        $array_campos_adicionais["nome_titular_nf"] = $_POST["titular_nota_fiscal"];
                    }

                    if (strlen($_POST["titular_cpf"]) > 0) {
                        if (!is_array($array_campos_adicionais)) {
                            $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                        }

                        $array_campos_adicionais["cpf_titular_nf"] = $_POST["titular_cpf"];
                    }

                    if (isset($_POST["abre_os_mondial"]) && $_POST["abre_os_mondial"] == 't') {
                        if (!is_array($array_campos_adicionais)) {
                            $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                        }
                        $array_campos_adicionais["abre_os_mondial"] = $_POST["abre_os_mondial"];
                    }
                }

                if($login_fabrica == 189){
                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    $array_campos_adicionais['prioridade'] = $prioridade;
                    $array_campos_adicionais['tipo_posto'] = $tipo_posto;
                    $array_campos_adicionais['analise_reclamacao'] = $analise_reclamacao;
                    $array_campos_adicionais['envia_email_representante'] = $envia_email_representante;
                    $array_campos_adicionais['nome_representante'] = $nome_representante;
                    $array_campos_adicionais['tipo_cliente'] = $tipo_cliente;
                    $array_campos_adicionais['celular_representante']  = $celular_representante;
                    $array_campos_adicionais['nome_empresa'] = utf8_encode($nome_empresa);
                    $array_campos_adicionais['codigo_cliente_revenda'] = utf8_encode($codigo_cliente_revenda);
                    $array_campos_adicionais['manual_nome_repre'] = utf8_encode($manual_nome_repre);
                    $array_campos_adicionais['manual_email_repre'] = utf8_encode($manual_email_repre);
                    $array_campos_adicionais['manual_cod_transp'] = utf8_encode($manual_cod_transp);
                    $array_campos_adicionais['manual_nome_transp'] = utf8_encode($manual_nome_transp);
                    $array_campos_adicionais['manual_contato_transp'] = utf8_encode($manual_contato_transp);
                    $array_campos_adicionais['manual_fone_transp'] = utf8_encode($manual_fone_transp);
                    $array_campos_adicionais['manual_end_transp'] = utf8_encode($manual_end_transp);
                    $array_campos_adicionais['manual_cod_transp_redespacho'] = utf8_encode($manual_cod_transp_redespacho);
                    $array_campos_adicionais['manual_nome_transp_redespacho'] = utf8_encode($manual_nome_transp_redespacho);
                    $array_campos_adicionais['manual_contato_transp_redespacho'] = utf8_encode($manual_contato_transp_redespacho);
                    $array_campos_adicionais['manual_fone_transp_redespacho'] = utf8_encode($manual_fone_transp_redespacho);
                    $array_campos_adicionais['manual_end_transp_redespacho'] = utf8_encode($manual_end_transp_redespacho);

                    $array_campos_adicionais['mercado_gerencia'] = $mercado_gerencia;
                    $array_campos_adicionais['planta'] = $planta;

                    $xxhd_motivo_ligacao = $_POST["hd_motivo_ligacao"];


                    $array_campos_adicionais['cte_1'] = $cte_1;
                    $array_campos_adicionais['cte_2'] = $cte_2;
                    $array_campos_adicionais['n_ordem_entrada_1'] = $n_ordem_entrada_1;
                    $array_campos_adicionais['n_ordem_entrada_2'] = $n_ordem_entrada_2;
                    $array_campos_adicionais['n_remessa_1'] = $n_remessa_1;
                    $array_campos_adicionais['n_remessa_2'] = $n_remessa_2;
                    $array_campos_adicionais['n_nf_entrada_1'] = $n_nf_entrada_1;
                    $array_campos_adicionais['n_nf_entrada_2'] = $n_nf_entrada_2;


                    if (strlen($_POST["hd_subclassificacao"]) > 0) {
                        $hd_subclassificacao = trim($_POST["hd_subclassificacao"]);
                    } else {
                        $hd_subclassificacao = null;
                    }
                }

                if (in_array($login_fabrica, [186])) {
                    if (!is_array($array_campos_adicionais)) {
                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    }
                    if (strlen($_POST["obs_para_contato"]) > 0) {
                        $array_campos_adicionais["obs_para_contato"] = utf8_encode($_POST["obs_para_contato"]);
                    }
                    if (strlen($_POST["assunto_fale_conosco"]) > 0) {
                        $array_campos_adicionais["assunto_fale_conosco"] = utf8_encode($_POST["assunto_fale_conosco"]);
                    }
                }

                if (in_array($login_fabrica, [184,200])) {
                    if (!is_array($array_campos_adicionais)) {
                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    }

                    if (!empty($pedido_venda)) {
                        $array_campos_adicionais["pedido_venda"] = $pedido_venda;
                    }

                    if (!empty($nf_venda)) {
                        $array_campos_adicionais["nf_venda"] = $nf_venda;
                    }

                }

                if (in_array($login_fabrica, [169,170]) && strlen($_POST['pedido_ecommerce']) > 0) {

                    $pedido_ecommerce = $_POST['pedido_ecommerce'];
                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                    $array_campos_adicionais["pedido_ecommerce"] = $pedido_ecommerce;
                }

                if (in_array($login_fabrica, [178])) {
                    if (!is_array($array_campos_adicionais)) {
                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    }

                    if (!empty($resposta_consumidor)) {
                        $array_campos_adicionais["resposta_consumidor"] = $resposta_consumidor;
                    }

                }

                if (in_array($login_fabrica, [35])) {
                    if (!is_array($array_campos_adicionais)) {
                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    }

                    if (!empty($cnpj_emitente_nf)) {
                        $array_campos_adicionais["cnpj_emitente_nf"] = str_replace([".","/","-"], "", trim($cnpj_emitente_nf));
                    }

                    $sqlVerificaReembolso = "SELECT hd_motivo_ligacao
                                     FROM tbl_hd_motivo_ligacao
                                     WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}
                                     AND (descricao = 'Ressarcimento'
                                     OR descricao = 'Reembolso ( boleto E-com)')";
                    $resVerificaReembolso = pg_query($con, $sqlVerificaReembolso);

                    if (pg_num_rows($resVerificaReembolso) > 0 && !empty($valor_ressarcimento_reembolso)) {

                        $array_campos_adicionais["valor_ressarcimento_reembolso"] = $valor_ressarcimento_reembolso;

                    }

                }

                if ($login_fabrica == 183){
                    if (strlen(trim($dev_transportadora)) > 0){
                        $array_campos_adicionais["dev_transportadora"] = utf8_encode($dev_transportadora);
                    }else{
                        unset($array_campos_adicionais["dev_transportadora"]);
                    }

                    if (strlen(trim($pedido_sap)) > 0){
                        $array_campos_adicionais["pedido_sap"] = $pedido_sap;
                    }else{
                        unset($array_campos_adicionais["pedido_sap"]);
                    }

                    if (strlen(trim($dev_motorista)) > 0){
                        $array_campos_adicionais["dev_motorista"] = utf8_encode($dev_motorista);
                    }else{
                        unset($array_campos_adicionais["dev_motorista"]);
                    }

                    if (strlen(trim($dev_aprovador)) > 0){
                        $array_campos_adicionais["dev_aprovador"] = utf8_encode($dev_aprovador);
                    }else{
                        unset($array_campos_adicionais["dev_aprovador"]);
                    }

                    if (strlen(trim($voltagem)) > 0){
                        $array_campos_adicionais["voltagem"] = $voltagem;
                    }else{
                        unset($array_campos_adicionais["voltagem"]);
                    }
                }

                if(is_array($array_campos_adicionais)){
                    $array_campos_adicionais = json_encode($array_campos_adicionais);
                }

                $array_campos_adicionais = str_replace("\\\\", '\\', $array_campos_adicionais);
                $array_campos_adicionais = pg_escape_string($array_campos_adicionais);

                if($login_fabrica == 42){
                    $pedido = $_POST["pedido"];

                    if(empty($pedido)){
                        $pedido = 'null';
                    }
                }

                if($login_fabrica == 189 && strlen($_POST["pedido"]) > 0) {
                    $sqlPedido = "SELECT pedido FROM tbl_pedido WHERE fabrica = {$login_fabrica} AND pedido_cliente='".$_POST["pedido"]."'";
                    $resPedido = pg_query($con, $sqlPedido);
                    if (pg_num_rows($resPedido) > 0) {
                        $xpedido = pg_fetch_result($resPedido, 0, 'pedido');
                    } else {
                        $xpedido = "";
                    }
                }

                #INSERT PRINCIPAL EXTRA
                $sql = "INSERT INTO tbl_hd_chamado_extra(
                            hd_chamado           ,
                            reclamado            ,
                            defeito_reclamado    ,
                            serie                ,
                            hora_ligacao         ,
                            produto              ,
                            posto                ,
                            os                   ,
                            receber_info_fabrica ,
                            consumidor_revenda   ,
                            origem               ,
                            revenda              ,
                            revenda_nome         ,
                            data_nf              ,
                            nota_fiscal          ,
                            valor_nf             ,
                            nome                 ,
                            endereco             ,
                            numero               ,
                            complemento          ,
                            bairro               ,
                            cep                  ,
                            fone                 ,
                            fone2                ,
                            email                ,
                            cpf                  ,
                            rg                   ,
                            cidade               ,
                            qtde_km              ,
                            abre_os              ,
                            defeito_reclamado_descricao,
                            numero_processo      ,
                            tipo_registro        ,
                            celular              ,
                            revenda_cnpj         ,
                            contato_nome        ,
                            $campoTipoAtendimentoGrohe";
                if (in_array($login_fabrica, [166,174,186])) {
                    $sql .= " tipo_venda, ";
                }

                if (in_array($login_fabrica, [169,170])) {
                    $sql .= "hd_providencia,
                             motivo_contato,";
                }

                if (in_array($login_fabrica, array(43,14,157))) {

                    if (strlen($ordem_montagem) > 0) $sql.= " ordem_montagem,  ";

                    $sql.= " codigo_postagem, ";

                }
                #3283170
                if(in_array($login_fabrica,array(11,50,74,86,172)) OR $moduloProvidencia){
                    $sql.= " hd_motivo_ligacao, ";

                }
                if(in_array($login_fabrica,array(189))){
                    $sql.= " hd_subclassificacao, ";
                    if(strlen($xpedido) > 0) {
                        $sql.= " pedido, ";
                    }

                }

                if (in_array($login_fabrica, array(11,15,24,30,35,52,74,81,85,101,114,122,123,128)) || $login_fabrica >= 138 || $telecontrol_distrib){
                    $sql .= " array_campos_adicionais, ";
                }

                if (in_array($login_fabrica, array(15,30,74,178))) {
                    $sql .= " data_nascimento, ";
                }

                if ($login_fabrica == 11 || $login_fabrica == 172 or ($login_fabrica == 30 && strlen($cliente_admin) > 0)) {
                    $sql .= " leitura_pendente, ";
                }

                if ($login_fabrica == 74 AND !empty($garantia_produto)){
                    $sql .= " garantia, ";
                }

                if (in_array($login_fabrica, array(169,170))) {
                    $sql .= " garantia, tipo_atendimento, obs_callcenter,";
                }

                if ($login_fabrica == 186){
                    $sql .= " obs_callcenter,
                    ";
                }


                if ($login_fabrica == 52){
                    $sql .= " posto_nome,
                              marca,
                              obs_callcenter,
                    ";
                }

                if ($login_fabrica == 183){
                    $sql .= "posto_nome,";
                }

				if (strlen($xdata_nf) == 0){
	                                $xdata_nf = "NULL";
				}
				if (strlen($xdata_prov) == 0){
	                                $xdata_prov = "NULL";
				}

                if($login_fabrica == 30){
                    $sql .= "hd_situacao,";
                }

                if($login_fabrica == 162 AND strlen(trim($motivo_situacao)) > 0){//HD-3352176
                    $sql .= "hd_situacao,";
                }

                if ($login_fabrica == 162 && filter_input(INPUT_POST,'interno')) {
                    $sql .= "
                        tipo_atendimento,
                        obs_callcenter,
                    ";
                }

                if(strlen(trim($cidade)) == 0){
                    $cidade = 'null';
                }

                if(in_array($login_fabrica, array(169,170)) || $usaOrigemCadastro){
                    if (!in_array($login_fabrica, [177,186,195]) && $xorigem != 'null') {
                        $sql .= " hd_chamado_origem, ";
                    }
                }


                $sql .= " atendimento_callcenter ";

                if($login_fabrica == 42){
                    $sql .= ", pedido";
                }

                if($login_fabrica == 81){
                    $sql .= ", solucao ";
                }

                $sql .= " ) values (
                        $hd_chamado                    ,
                        $xreclamado                    ,
                        $xdefeito_reclamado            ,
                        SUBSTR($xserie,0,27)           ,
                        $xhora_ligacao                 ,
                        $xproduto                      ,
                        $xcodigo_posto                 ,
                        $xos                           ,
                        $xreceber_informacoes          ,
                        $xconsumidor_revenda           ,
                        $xorigem                       ,
                        $xrevenda                      ,
                        substr($xrevenda_nome,0,51)    ,
                        $xdata_nf                      ,
                        $xnota_fiscal                  ,
                        $xvalor_nf                     ,
                        upper($xconsumidor_nome)       ,
                        substr(upper($xconsumidor_endereco),0,70)   ,
                        upper($xconsumidor_numero)     ,
                        upper($xconsumidor_complemento),
                        upper($xconsumidor_bairro)     ,
                        $xconsumidor_cep               ,
                        $xconsumidor_fone              ,
                        $xconsumidor_fone2             ,
                        $xconsumidor_email             ,
                        $xconsumidor_cpf               ,
                        upper($xconsumidor_rg)         ,
                        $cidade                        ,
                        $posto_km_tab                  ,
                        '$xabre_os'                    ,
                        '$hd_extra_defeito'            ,
                        $xnumero_processo              ,
                        '$tipo_registro'               ,
                        $xconsumidor_fone3             ,
                        '$cnpj_revenda'                ,
                        '$contato_nome'                ,
                        $valorTipoAtendimentoGrohe";

                if (in_array($login_fabrica, array(43,14,157))) {

                         if (strlen($ordem_montagem) > 0) $sql.= " '$ordem_montagem' , ";

                         $sql.= " '$codigo_postagem', ";

                }

                if (in_array($login_fabrica, [166,174,186])) {
			if (strlen($tipo_venda) == 0) {
				$sql .= "null, ";
			} else {
				$sql .= "'$tipo_venda', ";
			}
                }
                if (in_array($login_fabrica, [169,170])) {

                    if (empty($hd_providencia_callcenter)) {
                        $aux_hd_providencia = "null";
                    } else {
                        $aux_hd_providencia = $hd_providencia_callcenter;
                    }

                    if (empty($motivo_contato_callcenter)) {
                        $aux_motivo_contato = "null";
                    } else {
                        $aux_motivo_contato = $motivo_contato_callcenter;
                    }

                    $sql .= "{$aux_hd_providencia} ,
                             {$aux_motivo_contato} ,";

                }

                #3283170
                if(in_array($login_fabrica,array(11,50,74,86,172)) OR $moduloProvidencia){
                         $sql.= " $hd_motivo_ligacao, ";

                }
                if(in_array($login_fabrica,array(189))){

                    $sql.= " $hd_subclassificacao, ";
                    if(strlen($xpedido) > 0) {
                        $sql.= " $xpedido, ";
                    }

                }
                if (in_array($login_fabrica, array(11,15,24,30,35,52,74,81,85,101,114,122,123,128)) || $login_fabrica >= 138 || $telecontrol_distrib){
                    $sql .= " '$array_campos_adicionais', ";
                }

                if (in_array($login_fabrica, array(15,30,74,178))) {
                    $sql .= " $consumidor_nascimento_query ,";
                }

                if ($login_fabrica == 11 || $login_fabrica == 172 or ($login_fabrica == 30 && strlen($cliente_admin) > 0)) {
                    $sql .= " '$leitura_pendente', ";
                }

                if ($login_fabrica == 74 AND !empty($garantia_produto)){
                    $sql .= "'$garantia_produto', ";
                }

                if (in_array($login_fabrica, array(169,170))) {
                    $sql .= " $garantia_estendida, $xtipo_atendimento, '$observacao_os',";
                }

                if ($login_fabrica == 186){
                    $sql .= "'$observacao_os',";
                }


                if ($login_fabrica == 52){
                    if ($marca<=0) {
                        $marca = 'null';
                    }
                    $sql .= "$xconsumidor_ponto_referencia,
                             $marca,
                             '$observacao_os',
                    ";
                }

                if ($login_fabrica == 183){
                    $sql .= "$xconsumidor_ponto_referencia,";
                }

				if($login_fabrica == 30){
                    $sql .= $motivo_situacao.",";
                }

                if($login_fabrica == 162 AND strlen(trim($motivo_situacao)) > 0){//HD-3352176
                    $sql .= $motivo_situacao.",";
                }


                if ($login_fabrica == 162 && filter_input(INPUT_POST,'interno')) {
                    $sql .= "
                        $interno_atendimento,
                        '$interno_observacao',
                    ";
                }

                if (in_array($login_fabrica, array(169, 170)) || $usaOrigemCadastro) {
                    if (!in_array($login_fabrica, [177,186,195]) && $xorigem != 'null') {
                        $sql .= " $id_xorigem, ";
                    }
                }

                $sql .= "'$atendimento_callcenter'       ";

                if($login_fabrica == 42){
                    $sql .= ", $pedido ";
                }

                if($login_fabrica == 81){
                    $sql.= ", $solucao ";
                }

                $sql .=");";

            } else {

                if($login_fabrica == 158){
                    if (!is_array($array_campos_adicionais)) {
                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    }
                    $dataFabricacao = DateTime::createFromFormat('d/m/Y', $_POST['data_fabricacao']);
                    $dataFabricacao = date_format($dataFabricacao, 'Y-m-d');
                    $dataVenda      = DateTime::createFromFormat('d/m/Y', $_POST['data_venda']);
                    $dataVenda      = date_format($dataVenda, 'Y-m-d');

                    $array_campos_adicionais['tensao']           = $_POST['tensao'];
                    $array_campos_adicionais['tempo_instalacao'] = $_POST['tempo_instalacao'];
                    $array_campos_adicionais['unidade_negocio']  = $_POST['unidade_negocio_imbera'];
                    $array_campos_adicionais['data_fabricacao']  = $dataFabricacao;
                    $array_campos_adicionais['data_venda']       = $dataVenda;
                    $array_campos_adicionais                     = json_encode($array_campos_adicionais);
                }

                if (strlen($xdata_nf) == 0){
                                    $xdata_nf = "NULL";
                }

                if(in_array($login_fabrica,array(11,86,172)) OR $moduloProvidencia){
                    $cond_motivo_ligacao = ", hd_motivo_ligacao = $hd_motivo_ligacao";
                }

                if(in_array($login_fabrica, [167, 203])){ //HD-3428316
                    $contador          = $_POST["contador"];
                    $linha_descricao   = $_POST['linha_descricao'];
                    $familia_descricao = $_POST['familia_descricao'];

                    $xserie = $_POST['serie'];

                    if (strlen(trim($xserie)) == 0) {
                        $xserie = "null";
                    } else {
                        $xserie = "'".$xserie."'";
                    }

                    $array_campos_adicionais = array();
                    $array_campos_adicionais["voltagem"] = $voltagem;
                    if( strstr($familia_descricao, "Impressora") == true || strstr($familia_descricao, "Multifunciona") == true){

                        if(strlen(trim($xserie)) == 0 OR $xserie == "null"){
                            $msg_erro .= "Informe a série do produto ";
                        }

                        if(strlen(trim($contador)) == 0){
                            $msg_erro .= "Informe o valor do Contador";
                        }else{
                            $array_campos_adicionais['contador'] = $contador;
                            $array_campos_adicionais = json_encode($array_campos_adicionais);
                        }
                    }
                }

                if($login_fabrica == 162){
                    $imei               = $_POST['imei'];
                    $linha_informatica  = $_POST['linha_informatica'];

                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    if (filter_input(INPUT_POST,'interno',FILTER_VALIDATE_INT)) {
                        $interno_aparencia      = filter_input(INPUT_POST,'interno_aparencia');
                        $interno_acessorios     = filter_input(INPUT_POST,'interno_acessorios');
                        $interno_atendimento    = filter_input(INPUT_POST,'interno_atendimento');
                        $interno_observacao     = filter_input(INPUT_POST,'interno_observacao');

                        $array_campos_adicionais['interno_aparencia']   = $interno_aparencia;
                        $array_campos_adicionais['interno_acessorios']  = $interno_acessorios;

                    }

                    $array_campos_adicionais['perfil_cliente']   = $_POST['perfil_cliente'];
                    $array_campos_adicionais['pedido_cliente']   = $_POST['pedido_cliente'];
                    $array_campos_adicionais['acordo_realizado']   = $_POST['acordo_realizado'];
                    $array_campos_adicionais['data_realizacao_acordo']   = $_POST['data_realizacao_acordo'];

                    if($_POST["acordo_realizado"] == "SIM"){
                        $array_campos_adicionais['tipo_acordo_realizado']   = $_POST['tipo_acordo_realizado'];
                    }else{
                        $array_campos_adicionais['tipo_acordo_realizado']   = "";
                    }

                    $array_campos_adicionais["imei"] = $imei;
                    $array_campos_adicionais["linha_informatica"] = $linha_informatica;
                    $array_campos_adicionais = json_encode($array_campos_adicionais);

                }

                if ($login_fabrica == 165) {
                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                    $array_campos_adicionais['indicacao_instalador_tecnico'] = $_POST['indicacao_instalador_tecnico'];

                    if (strlen($_POST['indicacao_instalador_comentario']) > 0) {
                        $indicacao_instalador_comentario  = $_POST["indicacao_instalador_comentario"];
                        $array_campos_adicionais['indicacao_instalador_comentario'] = utf8_encode($indicacao_instalador_comentario);
                    }

                    $array_campos_adicionais = json_encode($array_campos_adicionais);
                }
                if (in_array($login_fabrica, array(169, 170))) {
                    if (strlen(trim($produto)) > 0 AND empty($servico_instalacao)){
                        $sql_contas_nacionais = "
                            SELECT
                                tbl_hd_motivo_ligacao.tipo_registro,
                                tbl_tipo_atendimento.tipo_atendimento
                            FROM tbl_hd_motivo_ligacao
                            JOIN tbl_tipo_atendimento ON tbl_tipo_atendimento.fabrica = tbl_hd_motivo_ligacao.fabrica
                                AND tbl_tipo_atendimento.fabrica = {$login_fabrica}
                            WHERE tbl_hd_motivo_ligacao.hd_motivo_ligacao = {$hd_motivo_ligacao}
                            AND tbl_tipo_atendimento.descricao = 'Garantia - Contas Nacionais'
                            AND tbl_hd_motivo_ligacao.fabrica = {$login_fabrica}
                            AND tbl_hd_motivo_ligacao.tipo_registro = 't' ";
                        $res_contas_nacionais = pg_query($con, $sql_contas_nacionais);

                        if (pg_num_rows($res_contas_nacionais) > 0){
                            $xtipo_atendimento = pg_fetch_result($res_contas_nacionais, 0, 'tipo_atendimento');
                        }else{
                            $sql = "SELECT
                                        tbl_linha.deslocamento,
                                        tbl_linha.linha
                                    FROM tbl_produto
                                        JOIN tbl_linha ON(tbl_produto.linha = tbl_linha.linha AND tbl_linha.fabrica = {$login_fabrica})
                                    WHERE tbl_produto.fabrica_i = {$login_fabrica}
                                    AND tbl_produto.produto = {$produto}";
                            $res = pg_query($con, $sql);

                            if (pg_num_rows($res) > 0){
                                $deslocamento    = pg_fetch_result($res, 0, "deslocamento");

                                if ($deslocamento == 't') {
                                    $sql = "SELECT
                                                tipo_atendimento
                                            FROM tbl_tipo_atendimento
                                            WHERE km_google IS TRUE
                                                AND fora_garantia IS NOT TRUE
                                                AND grupo_atendimento = 'P'
                                                AND descricao NOT ILIKE '%Nacionais%'
                                                AND fabrica = {$login_fabrica};";
                                    $xres = pg_query($con, $sql);
                                }else{
                                    $sql = "SELECT
                                                tipo_atendimento
                                            FROM tbl_tipo_atendimento
                                            WHERE km_google IS NOT TRUE
                                                AND fora_garantia IS NOT TRUE
                                                AND grupo_atendimento = 'P'
                                                AND fabrica = {$login_fabrica};";
                                    $xres = pg_query($con, $sql);
                                }

                                if (pg_num_rows($xres) > 0){
                                    $xtipo_atendimento = pg_fetch_result($xres, 0, 'tipo_atendimento');
                                }
                            }
                        }
                    }else if (strlen(trim($produto)) > 0 AND strlen($servico_instalacao) > 0){
                        $xtipo_atendimento = $servico_instalacao;
                    }

                    if (strlen(trim($xtipo_atendimento)) > 0){
                        $xtipo_atendimento = "tipo_atendimento = ".$xtipo_atendimento.",";
                    }

                    if(in_array($login_fabrica, array(169,170)) || $usaOrigemCadastro){
                        $xhd_chamado_origem = "hd_chamado_origem = $id_xorigem ,";
                    }
                }

                //hd-3624967 - fputti
                if ($login_fabrica == 171) {
                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    unset($array_campos_adicionais["voltagem"]);
                    $array_campos_adicionais["projeto"] = $projeto;
                    $array_campos_adicionais["pressao_agua_mca"] = $pressao_agua_mca;
                    $array_campos_adicionais = json_encode($array_campos_adicionais);
                }

                if (in_array($login_fabrica, [35])) {
                    if (!is_array($array_campos_adicionais)) {
                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    }

                    if (!empty($cnpj_emitente_nf)) {
                        $array_campos_adicionais["cnpj_emitente_nf"] = str_replace([".","/","-"], "", trim($cnpj_emitente_nf));
                    }

                    $sqlVerificaReembolso = "SELECT hd_motivo_ligacao
                                     FROM tbl_hd_motivo_ligacao
                                     WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}
                                     AND (descricao = 'Ressarcimento'
                                     OR descricao = 'Reembolso ( boleto E-com)')";
                    $resVerificaReembolso = pg_query($con, $sqlVerificaReembolso);

                    if (pg_num_rows($resVerificaReembolso) > 0 && !empty($valor_ressarcimento_reembolso)) {

                        $array_campos_adicionais["valor_ressarcimento_reembolso"] = $valor_ressarcimento_reembolso;

                    }

                    $array_campos_adicionais = json_encode($array_campos_adicionais);

                }

                if ($login_fabrica == 85) {
                    if ($atendimento_ambev == "t" || $atendimento_contratual == "t") {

                        if ($atendimento_ambev == "t") {
                            $cliente_admin = $cliente_admin_ambev;
                            $garantia_estendida_check   = $_POST["garantia_estendida_check"];
                            $xserie                     = $_POST['serie'];

                            if (strlen(trim($xserie)) == 0) {
                                $xserie = "null";
                            } else {
                                $xserie = "'".$xserie."'";
                            }

                            if($garantia_estendida_check == "t"){
                                $categoria  = "garantia_estendida";
                                $reclamado  = $_POST["reclamado_garantia_estendida"];
                                $xreclamado = "'".$reclamado."'";
                            } else {
                                if (empty($reclamado)) {
                                    $reclamado  = $_POST["reclamado_garantia_estendida"];
                                    $xreclamado = "'".$reclamado."'";
                                }
                            }
                        } else {
                            $garantia_contratual_check = $_POST["garantia_contratual_check"];

                            if($garantia_contratual_check == "t"){
                                $categoria  = "garantia_contratual";
                                $reclamado  = $_POST["descricao_garantia_contratual"];
                                $xreclamado = "'".$reclamado."'";
                            } else {
                                if (empty($reclamado)) {
                                    $reclamado  = $_POST["descricao_garantia_contratual"];
                                    $xreclamado = "'".$reclamado."'";
                                }
                            }
                        }
                    }

                    if ($atendimento_ambev == "t") {
                        $array_campos_adicionais = array(
                            "atendimento_ambev"        => $atendimento_ambev,
                            "codigo_ambev"             => $codigo_ambev,
                            "data_fabricacao_ambev"    => $data_fabricacao_ambev,
                            "data_previsao_ambev"      => $data_previsao_ambev,
                            "data_encerramento_ambev"  => $data_encerramento_ambev,
                            "atendimento_ambev_nome"   => $atendimento_ambev_nome,
                            "garantia_estendida_ambev" => $garantia_estendida_ambev
                        );
                    } else {
                        $array_campos_adicionais = array(
                            "atendimento_ambev"         => "f"                      ,
                            "data_fabricacao_ambev"     => $data_fabricacao_ambev   ,
                            "data_previsao_ambev"       => $data_previsao_ambev,
                            "atendimento_ambev_nome"    => $atendimento_ambev_nome
                        );
                    }

                    $array_campos_adicionais["atendimento_contratual"] = $atendimento_contratual;
                    $array_campos_adicionais["garantia_contratual"] = $garantia_contratual_cliente;

                    $array_campos_adicionais["consumidor_cpf_cnpj"] = $consumidor_cpf_cnpj;

                    if ($consumidor_cpf_cnpj == "R") {
                        $array_campos_adicionais["nome_fantasia"] = utf8_encode($nome_fantasia);
                    }
                    $array_campos_adicionais["voltagem"] = $voltagem;

                    $array_campos_adicionais = str_replace("\\", "\\\\", json_encode($array_campos_adicionais));

                    $bonificacao = filter_input(INPUT_POST,'bonificacao');
                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                    if ($bonificacao == 't') {
                        $array_campos_adicionais['bonificacao'] = TRUE;
                        $array_campos_adicionais["bonificacao_admin"] = $login_admin;
                    } else {
                        $array_campos_adicionais['bonificacao'] = '';
                        $array_campos_adicionais['bonificacao_admin'] = '';
                    }

                    /*HD - 4258409*/
                    if (!empty($_POST["check_tecnico_esporadico"]) && !empty($hd_chamado)) {
                        $tecnico_esporadico_id     = $_POST["tecnico_esporadico_id"];
                        $valor_servico_combinado   = $_POST["valor_servico_combinado"];
                        $valor_servico_combinado   = str_replace(array(".","R","$"), "", $valor_servico_combinado);
                        $valor_servico_combinado   = str_replace(",", ".", $valor_servico_combinado);

                        if (!empty($tecnico_esporadico_id) && !empty($valor_servico_combinado)) {
                            $array_campos_adicionais["tecnico_esporadico_id"]     = utf8_encode($tecnico_esporadico_id);
                            $array_campos_adicionais["valor_servico_combinado"]   = utf8_encode($valor_servico_combinado);

                            $aux_sql = "SELECT qtde_atendimento FROM tbl_tecnico WHERE tecnico = $tecnico_esporadico_id LIMIT 1";
                            $aux_res = pg_query($con, $aux_sql);
                            $qtde_at = (int) pg_fetch_result($aux_res, 0, 0);

                            if (empty($qtde_at) || $qtde_at == 0) {
                                $qtde_at = 1;
                            } else {
                                $qtde_at += 1;
                            }

                            $aux_sql = "UPDATE tbl_tecnico SET qtde_atendimento = $qtde_at WHERE tecnico = $tecnico_esporadico_id";
                            $aux_res = pg_query($con, $aux_sql);

                            if (pg_last_error()) {
                                $msg_erro .= "Erro ao registrar o novo atendimento ao téncico esporádico <br>";
                            }
                        }
                    }

                    $array_campos_adicionais = json_encode($array_campos_adicionais);
                }

                if ($login_fabrica == 174) {
                    $pedido_info             = filter_input(INPUT_POST,'pedido_info');
                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                    $array_campos_adicionais['pedido_info'] = $pedido_info;

                    $array_campos_adicionais = json_encode($array_campos_adicionais);
                }

                if (in_array($login_fabrica, [186])) {
                    $obs_para_contato        = filter_input(INPUT_POST,'obs_para_contato');
                    $assunto_fale_conosco        = filter_input(INPUT_POST,'assunto_fale_conosco');
                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                    $array_campos_adicionais['obs_para_contato'] = utf8_encode($obs_para_contato);
                    $array_campos_adicionais['assunto_fale_conosco'] = utf8_encode($assunto_fale_conosco);

                    $array_campos_adicionais = json_encode($array_campos_adicionais);
                }

                if (in_array($login_fabrica, [184,200])) {

                    if (!is_array($array_campos_adicionais)) {
                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    }

                    if (!empty($pedido_venda)) {
                        $array_campos_adicionais["pedido_venda"] = $pedido_venda;
                    }

                    if (!empty($nf_venda)) {
                        $array_campos_adicionais["nf_venda"] = $nf_venda;
                    }

                    $array_campos_adicionais = json_encode($array_campos_adicionais);

                }

                if (in_array($login_fabrica, [178])) {

                    if (!is_array($array_campos_adicionais)) {
                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                    }

                    if (!empty($resposta_consumidor)) {
                        $array_campos_adicionais["resposta_consumidor"] = $resposta_consumidor;
                    }

                    $array_campos_adicionais = json_encode($array_campos_adicionais);

                }

                if (in_array($login_fabrica, array(169, 170))) {
                    $OsUpdate = "os = $xos ,";
                } else {
                    $OsUpdate = "os = CASE WHEN os NOTNULL THEN os ELSE $xos END,";
                }
                //UPDATE PRINCIPAL EXTRA
                $sql = "UPDATE tbl_hd_chamado_extra
                           SET reclamado            = $xreclamado,
                               defeito_reclamado    = $xdefeito_reclamado,
                               serie                = SUBSTR($xserie,0,27),
                               hora_ligacao         = $xhora_ligacao,
                               produto              = $xproduto,
                               posto                = $xcodigo_posto,
                               {$OsUpdate}
                               receber_info_fabrica = $xreceber_informacoes,
                               consumidor_revenda   = $xconsumidor_revenda,
                               origem               = $xorigem,
                               revenda              = $xrevenda,
                               revenda_nome         = SUBSTR($xrevenda_nome,1,50),
                               data_nf              = $xdata_nf,
                               valor_nf             = $xvalor_nf,
                               nota_fiscal          = SUBSTR($xnota_fiscal,1,10),
                               nome                 = UPPER($xconsumidor_nome),
                               endereco             = substr(UPPER($xconsumidor_endereco),0,70),
                               numero               = UPPER($xconsumidor_numero),
                               complemento          = UPPER($xconsumidor_complemento),
                               bairro               = substr(UPPER($xconsumidor_bairro),1,60),
                               cep                  = $xconsumidor_cep,
                               fone                 = SUBSTR($xconsumidor_fone,1,20),
                               fone2                = SUBSTR($xconsumidor_fone2,1,20),
                               email                = $xconsumidor_email,
                               cpf                  = $xconsumidor_cpf,
                               rg                   = UPPER($xconsumidor_rg),
                               cidade               = $cidade,
                               qtde_km              = $posto_km_tab,";
                if (in_array($login_fabrica, array(11,15,24,30,35,74,81,85,101,114,122,123,128)) || $login_fabrica >= 138 || $telecontrol_distrib){
                    $sql .= " array_campos_adicionais = '$array_campos_adicionais' , ";
                }

                if (in_array($login_fabrica, [169,170])) {

                    if (empty($hd_providencia_callcenter)) {
                        $aux_hd_providencia = "null";
                    } else {
                        $aux_hd_providencia = $hd_providencia_callcenter;
                    }

                    if (empty($motivo_contato_callcenter)) {
                        $aux_motivo_contato = "null";
                    } else {
                        $aux_motivo_contato = $motivo_contato_callcenter;
                    }

                    $sql .= "motivo_contato = {$aux_motivo_contato},
                             hd_providencia = {$aux_hd_providencia},";

                }

                if (in_array($login_fabrica, array(15,30,74,178))) {
                    $sql .= " data_nascimento = $consumidor_nascimento_query , ";
                }

                if ($login_fabrica == 11 || $login_fabrica == 172 or ($login_fabrica == 30 && strlen($cliente_admin) > 0)) {
                    $sql .= " leitura_pendente = '{$leitura_pendente}', ";
                }

                if ($login_fabrica == 74 AND !empty($garantia_produto)){
                    $sql .= "garantia          = '$garantia_produto', ";
                }

                if ($login_fabrica == 52){
                    $sql .= "posto_nome          = $xconsumidor_ponto_referencia,
                             marca               = $marca, ";
                }

                if ($login_fabrica == 183){
                    $sql .= "posto_nome = $xconsumidor_ponto_referencia, ";
                }

				if ($login_fabrica == 162 && filter_input(INPUT_POST,'interno')) {
                    $sql .= "
                        tipo_atendimento    = $interno_atendimento,
                        obs_callcenter      = '$interno_observacao',
                    ";
                }

                //hd-3624967 - fputti

                if  ($login_fabrica == 171 && !empty($tipo_atendimento_grohe)) {
                    $sql .= " tipo_atendimento = $tipo_atendimento_grohe,";
                }

                if (in_array($login_fabrica, array(169, 170))) {
                    if(strlen(trim($xtipo_atendimento)) > 0){
                        $sql .= $xtipo_atendimento;
                    }
                }
                if (in_array($login_fabrica, array(169,170)) || $usaOrigemCadastro) {
                    if(strlen(trim($id_xorigem)) > 0){
                        $sql .= $xhd_chamado_origem;
                    }
                }

                if ($login_fabrica == 85) {
                    $sql .= " cliente = $xid_cliente_contratual ,";
                }

                $sql .="
							abre_os                     = '$xabre_os',
							defeito_reclamado_descricao = '$hd_extra_defeito',
							numero_processo             = $xnumero_processo,
							tipo_registro               = '$tipo_registro',
							celular                     = $xconsumidor_fone3,
							revenda_cnpj                = '$cnpj_revenda',
							contato_nome                = '$contato_nome'
							$condicao
							$cond_motivo_ligacao";
				$sql .= " WHERE tbl_hd_chamado_extra.hd_chamado = $hd_chamado";
			}

            
            $res = pg_query($con,$sql);
            if (in_array($login_fabrica, array(169,170)) AND strlen(trim($os)) > 0){
                $sql = "UPDATE tbl_os set observacao = '$observacao_os', hd_chamado = $hd_chamado where os = $os";
                $res = pg_query($con, $sql);
            }

            /*echo nl2br($sql);
            exit;*/

            if(pg_last_error($con)){
                $msg_erro .= "Erro ao gravar as informações!";
            }

            $valida_serie_bloqueio = 52; // Semáforo. Deixei com o ID da fábrica

            if ($login_fabrica == 74 and $garantia_adicional_check == 't') {
                if (strlen($protocolo) == 0) {
                    //inserir informações na tbl_cliente_garantia_extendida
                    //campo garantia_mes será fixo o valor 24 meses.
                    $sql_g = "INSERT INTO tbl_cliente_garantia_estendida(
                        nome,
                        cpf,
                        endereco,
                        numero,
                        cep,
                        cidade,
                        produto,
                        numero_serie,
                        revenda_nome,
                        nota_fiscal,
                        data_compra,
                        --estado,
                        fabrica,
                        garantia_mes,
                        fone,
                        fone2,
                        revenda,
                        motivo,
                        admin,

                        os,
                        email
                            )VALUES(
                                upper($xconsumidor_nome),
                                $xconsumidor_cpf,
                                upper($xconsumidor_endereco),
                                upper($xconsumidor_numero),
                                $xconsumidor_cep,
                                $cidade,
                                $xproduto,
                                substr($xserie,0,27),
                                substr($xrevenda_nome,0,51),
                                substr($xnota_fiscal,0,11),
                                $xdata_nf,
                                $login_fabrica,
                                24,
                                substr($xconsumidor_fone,0,21),
                                substr($xconsumidor_fone2,0,21),
                                $xrevenda,
                                $hd_motivo_ligacao,
                                $xos,
                                $xconsumidor_email
                                );";
                    $res = pg_query($con,$sql_g);
                    if(pg_last_error($con)){
                        $msg_erro .= "Erro ao gravar Garantia Estendida!<br>";
                    }

                }

            }

            if ($login_fabrica == 183){
                $sql = "
                    INSERT INTO tbl_hd_chamado_item(
                        hd_chamado,
                        data,
                        comentario,
                        admin,
                        status_item
                    )VALUES(
                        $hd_chamado,
                        current_timestamp,
                        $xreclamado,
                        $login_admin,
                        $xstatus_interacao
                    )";
                $res = pg_query($con, $sql);
            }

            if ($login_fabrica == 30 && !empty($_POST["autoriza_gravacao_esmaltec"])){

                $admin_inte      = $_POST["autoriza_admin_esmaltec"];
                $comentario_inte = $_POST["autoriza_gravacao_esmaltec"];

                $sql = "
                    INSERT INTO tbl_hd_chamado_item(
                        hd_chamado,
                        data,
                        comentario,
                        admin,
                        status_item,
                        interno
                    )VALUES(
                        $hd_chamado,
                        current_timestamp,
                        '$comentario_inte',
                        $admin_inte,
                        'Aberto',
                        TRUE
                    )";
                $res = pg_query($con, $sql);
            }

            if ($xstatus_interacao == "'Retorno'" AND $login_fabrica == 15 ) {

                $sql = "INSERT INTO tbl_hd_chamado_item(
                    hd_chamado,
                    data,
                    comentario,
                    admin,
                    interno,
                    status_item,
                    enviar_email
                        ) values (
                            $hd_chamado,
                            current_timestamp,
                            'Data para retorno : $xdata_retorno',
                            $login_admin,
                            $xchamado_interno,
                            $xstatus_interacao,
                            $xenvia_email
                            )";

                $res = pg_query($con,$sql);
                $msg_erro .= pg_errormessage($con);

            }

            if (strtoupper($xstatus_interacao) == "'RESOLVIDO'" AND $login_fabrica <> 6) {

                $sql = "INSERT INTO tbl_hd_chamado_item(
                    hd_chamado   ,
                                 data         ,
                                 comentario   ,
                                 admin        ,
                                 interno      ,
                                 status_item  ,
                                 enviar_email
                                     ) values (
                                         $hd_chamado       ,
                                         current_timestamp ,
                                         'Resolvido'       ,
                                         $login_admin      ,
                                         $xchamado_interno ,
                                         $xstatus_interacao,
                                         $xenvia_email
                                         )";

                $res = pg_query($con,$sql);
                $msg_erro .= pg_errormessage($con);

                if (strlen($msg_erro) == 0) {

                    $sql = "SELECT fn_callcenter_dias_interacao($hd_chamado,$login_fabrica)";
                    $res = pg_query($con, $sql);

                    $msg_erro .= pg_errormessage($con);

                    $sql = "SELECT fn_callcenter_dias_aberto($hd_chamado,$login_fabrica);";
                    $res = pg_query($con, $sql);

                    $msg_erro .= pg_errormessage($con);

                    $sql = "SELECT fn_callcenter_intervalo_interacao($hd_chamado,$login_fabrica);";
                    $res = pg_query($con, $sql);

                    $msg_erro .= pg_errormessage($con);

                }

            }

            if (isset($_POST['tipo_consumidor']) && !empty($hd_chamado)) { // HD 317864

                $sql = "UPDATE tbl_hd_chamado_extra SET tipo_consumidor = '" . $_POST['tipo_consumidor'] . "' WHERE hd_chamado = $hd_chamado";
                $res = pg_query($con,$sql);

            } else if (in_array($login_fabrica,$fab_usa_tipo_cons)) {

                $msg_erro .= "Selecione o Tipo do Consumidor <br>";

            }

            /*HD-4149060*/
            if ($login_fabrica == 80 && strlen($posto_tab) == 0) {
                $aux_codigo_posto_tab = $_POST['codigo_posto_tab'];

                if (strlen($aux_codigo_posto_tab) > 0) {
                    $aux_sql = "SELECT posto FROM tbl_posto_fabrica WHERE codigo_posto = '$aux_codigo_posto_tab' AND fabrica = $login_fabrica LIMIT 1";
                    $aux_res = pg_query($con, $aux_sql);

                    $posto_tab = pg_fetch_result($aux_res, 0, 0);
                    unset($aux_codigo_posto_tab, $aux_sql, $aux_res);
                }
            }

            //IGOR - HD: 10441 QUANDO FOR INDICADO UM POSTO AUTORIZADO, DEVE-SE INSERIR UMA INTERAO NO CHAMADO
            if (strlen($posto_tab) > 0 and strlen($msg_erro) == 0 and $abre_ordem_servico != "t") {

                if ($login_fabrica == 52){

                    $sql = "SELECT contato_endereco,
                        contato_numero,
                        contato_bairro,
                        contato_cidade,
                        contato_estado,
                        contato_cep,
                        contato_email,
                        contato_fone_comercial
                            FROM
                            tbl_posto_fabrica
                            WHERE
                            posto = $xcodigo_posto
                            AND
                            fabrica = $login_fabrica";

                    $res = pg_query($con, $sql);
                    if (pg_num_rows($res) > 0) {

                        $posto_endereco = pg_escape_string(pg_fetch_result($res,0,'contato_endereco'));
                        $posto_numero= pg_fetch_result($res,0,'contato_numero');
                        $posto_bairro = pg_escape_string(pg_fetch_result($res,0,'contato_bairro'));
                        $posto_endereco_tab = $posto_endereco . ', ' . $posto_numero . ' - ' . $posto_bairro;
                        $posto_cidade_tab = pg_escape_string(pg_fetch_result($res,0,'contato_cidade'));
                        $posto_estado_tab = pg_fetch_result($res,0,'contato_estado');
                        $posto_cep_tab = pg_fetch_result($res, 0, 'contato_cep');
                        $posto_fone_tab = pg_fetch_result($res,0,'contato_fone_comercial');
                        $posto_email_tab = pg_fetch_result($res,0,'contato_email');


                    }
                }

                if (in_array($login_fabrica, array(169,170))) {
                    $comentario = "Indicação de posto autorizado: <br>
                        Código: $codigo_posto_tab <br>
                        Nome: ".pg_escape_string($posto_nome_tab)."<br>
                        Endereço: $posto_endereco_tab <br>
                        Cidade: $posto_cidade_tab <br>
                        Estado: $posto_estado_tab<br>
                        Cep: $posto_cep_tab<br>
                        Telefone: $posto_fone_tab<br>
                        E-mail: $posto_email_tab";
                } else {
                    $comentario = "Indicação do posto mais próximo do consumidor: <br>
                        Código: $codigo_posto_tab <br>
                        Nome: ".pg_escape_string($posto_nome_tab)." <br>
                        Endereço: $posto_endereco_tab <br>
                        Cidade: $posto_cidade_tab <br>
                        Estado: $posto_estado_tab<br>
                        Cep: $posto_cep_tab<br>
                        Telefone: $posto_fone_tab<br>
                        E-mail: $posto_email_tab";

                    if ($login_fabrica == 80 && $abre_os == 't') {
                        $needle   = "<br><br>Foi disponibilizado para o posto a Pré-Ordem de Serviço.";
                        $auxiliar = strripos($comentario, $needle);

                        if ($auxiliar === false) {
                            $comentario .= "<br><br>Foi disponibilizado para o posto a Pré-Ordem de Serviço.";
                        }
                    }
                }

                if($login_fabrica == 94 and $tab_atual == 'indicacao_at'){
                    $sql_posto = "SELECT contato_endereco,
                        contato_numero,
                        contato_complemento,
                        contato_cidade,
                        contato_estado,
                        contato_email,
                        contato_fone_comercial
                            FROM tbl_posto_fabrica
                            WHERE codigo_posto = '$codigo_posto'
                            AND fabrica = $login_fabrica";
                    $res_posto = pg_query($con,$sql_posto);
                    if(pg_num_rows($res_posto) > 0){
                        $contato_endereco    = pg_result($res_posto,0,'contato_endereco');
                        $contato_numero      = pg_result($res_posto,0,'contato_numero');
                        $contato_complemento = pg_result($res_posto,0,'contato_complemento');
                        $contato_cidade      = pg_result($res_posto,0,'contato_cidade');
                        $contato_estado      = pg_result($res_posto,0,'contato_estado');
                        $contato_email       = pg_result($res_posto,0,'contato_email');
                        $contato_fone_comercial = pg_result($res_posto,0,'contato_fone_comercial');

                        $comentario = "Indicação do posto mais próximo do consumidor: <br>
                            Código: $codigo_posto <br>
                            Nome: $posto_nome<br>
                            Endereço: $contato_endereco, $contato_numero $contato_complemento<br>
                            Cidade: $contato_cidade <br>
                            Estado: $contato_estado<br>
                            Telefone: $contato_fone_comercial<br>
                            E-mail: $contato_email";
                    }
                }

                if ($abre_os == 't') {

                    if (in_array($login_fabrica, array(30,50,190)) || ($login_fabrica == 162 && filter_input(INPUT_POST,'interno'))) {
                        $comentario .= "<Br><br> Foi disponibilizado para o posto a Ordem de Serviço.";
                    } else {
                        if ($login_fabrica == 80) {
                            $needle   = "<br><br>Foi disponibilizado para o posto a Pré-Ordem de Serviço.";
                            $auxiliar = strripos($comentario, $needle);

                            if ($auxiliar === false) {
                                $comentario .= "<br><br>Foi disponibilizado para o posto a Pré-Ordem de Serviço.";
                            }
                        } else {
                            $comentario .= "<Br><br> Foi disponibilizado para o posto a Pré-Ordem de Serviço.";
                        }
                    }
                }

                $sql = "INSERT INTO tbl_hd_chamado_item(
                                        hd_chamado   ,
                                        data         ,
                                        comentario   ,
                                        admin        ,
                                        interno      ,
                                        status_item  ,
                                        produto      ,
                                        hd_motivo_ligacao
                                     ) values (
                                         $hd_chamado       ,
                                         current_timestamp ,
                                         E'$comentario'       ,
                                         $login_admin      ,
                                         '".(($login_fabrica == 74) ? "t": "f")."',
                                         $xstatus_interacao,
                                         $xproduto,
                                         $hd_motivo_ligacao
                                         )";
                $res       = pg_query($con,$sql);
                $msg_erro .= pg_errormessage($con);
            }

            if ($telecontrol_distrib || in_array($login_fabrica, [174])) {

                if (empty($callcenter) && strtoupper($xstatus_interacao) != "'RESOLVIDO'") {
                    $xstatus_interacao = "'Aguard. Contato Consumidor'";
                } else if (strtoupper($xstatus_interacao) == "'RESOLVIDO'") {

                    $sqlResolvidoMesmoDia = "SELECT hd_chamado
                                              FROM tbl_hd_chamado
                                              WHERE hd_chamado = {$hd_chamado}
                                              AND data::date = current_date";
                    $resResolvidoMesmoDia = pg_query($con, $sqlResolvidoMesmoDia);

                    if (pg_num_rows($resResolvidoMesmoDia) > 0) {

                        pg_query($con, "INSERT INTO tbl_hd_chamado_item(
                                            hd_chamado   ,
                                            data         ,
                                            comentario   ,
                                            admin        ,
                                            interno      ,
                                            status_item
                                        ) VALUES (
                                            $hd_chamado       ,
                                            current_timestamp ,
                                            'Solução na primeira e Ãºnica ligação',
                                            $login_admin      ,
                                            true              ,
                                            'FCR'
                        )");
                    }

                }

            }

        }

        $herdar_x            = $_GET['herdar']; //HD 94971
        $hd_chamado_herdar_x = $_GET['Id'];

        if ($login_fabrica == 59 AND strlen($herdar_x) > 0 AND strlen($hd_chamado_herdar_x) > 0 AND strlen($callcenter) <= 0) {

            $interacao   = $_POST['reclamado_produto_x'];
            $reclamado_x = "Histórico do HD $hd_chamado_herdar_x: $interacao ";

            $sql = "INSERT INTO tbl_hd_chamado_item(
                hd_chamado   ,
                             data         ,
                             comentario   ,
                             admin        ,
                             interno      ,
                             status_item
                                 ) values (
                                     $hd_chamado       ,
                                     current_timestamp ,
                                     E'$reclamado_x'       ,
                                     $login_admin      ,
                                     'f',
                                     $xstatus_interacao
                                     )";

            $res = pg_query($con,$sql);
            $msg_erro .= pg_errormessage($con);

            $sql = "SELECT hd_chamado, data,comentario,admin,interno,status_item FROM tbl_hd_chamado_item WHERE hd_chamado = $hd_chamado_herdar_x";

            $res = @pg_query($con,$sql);
            $msg_erro .= pg_errormessage($con);

            $linhas = pg_num_rows($res);

            if (strlen($linhas) > 0) {

                for ($y = 0; $y < $linhas; $y++) {

                    $data_hd_hist        = pg_fetch_result($res, $y, 'data');
                    $comentario_hd_hist  = pg_fetch_result($res, $y, 'comentario');
                    $admin_hd_hist       = pg_fetch_result($res, $y, 'admin');
                    $interno_hd_hist     = pg_fetch_result($res, $y, 'interno');
                    $status_item_hd_hist = pg_fetch_result($res, $y, 'status_item');
                    $hd_chamado_hd_hist  = pg_fetch_result($res, $y, 'hd_chamado');

                    $sql = "INSERT INTO tbl_hd_chamado_item(
                        hd_chamado   ,
                                     data         ,
                                     comentario   ,
                                     admin        ,
                                     interno      ,
                                     status_item
                                         ) values (
                                             '$hd_chamado'       ,
                                             '$data_hd_hist' ,
                                             E'Histórico do HD $hd_chamado_herdar_x: $comentario_hd_hist'       ,
                                             '$admin_hd_hist'      ,
                                             '$interno_hd_hist',
                                             '$status_item_hd_hist'
                                             )";
                    $res2 = pg_query($con,$sql);
                    $msg_erro .= pg_errormessage($con);

                    $finaliza = $y + 1;

                }

                if (strlen($finaliza) <= 0) {
                    $finaliza = 0;
                }

            }

        }


        if ((in_array($login_fabrica,array(52,138,151,186,189,190,195))) AND strlen($msg_erro) == 0) {
            $qtde_produto = $_POST['qtde_produto'];
            $abre_ordem_servico = $_POST['abre_ordem_servico'];
            $abre_ordem_servico = ($abre_ordem_servico == "true") ? "t" : $abre_ordem_servico;

            if ($qtde_produto > 0) {
                $series_digitadas = array();
                for ($w = 1; $w <= $qtde_produto; $w++) {

                    $produto_referencia = trim($_POST['produto_referencia_'.$w]);
                    $produto_nome = trim($_POST['produto_nome_'.$w]);
                    $serie              = trim($_POST['serie_'.$w]);
                    $defeito_reclamado  = $_POST['defeito_reclamado_'.$w];
                    if ($login_fabrica == 52){
                        $controle_cliente  = $_POST['controle_cliente_'.$w];
                    }
                    if ($login_fabrica == 151){
                       $nota_fiscal   = $_POST['nota_fiscal_'.$w];
                       $data_nf       = $_POST['data_nf_'.$w];
                       $voltagem      = $_POST['voltagem_'.$w];
                       $b_num_serie   = $_POST['b_num_serie_'.$w];
                       $obs_num_serie = $_POST['obs_num_serie_'.$w];
                       $voucher_codigo = $_POST['voucher_codigo_'.$w];
                       $voucher_id    = $_POST['voucher_id_'.$w];
                       $voucher_familia = $_POST['voucher_familia_'.$w]; 
                    }
                    if (in_array($login_fabrica, [186,189])){
                       $nota_fiscal   = $_POST['nota_fiscal_'.$w];
                       $qtde_prod_lancado = $_POST['qtde_prod_lancado_'.$w];
                       $preco         = $_POST['preco_'.$w];
                       $reclamado_cliente_produto = $_POST["reclamado_cliente_produto_".$w];
                    }

                    if (in_array($login_fabrica, [186])) {
                        $voltagem      = $_POST['voltagem_'.$w];
                        $data_nf       = $_POST['data_nf_'.$w];
                    }

                    if (in_array($login_fabrica, [190,195])) {
                        $voltagem      = $_POST['voltagem_'.$w];
                        $nota_fiscal       = $_POST['nota_fiscal_'.$w];
                        $data_nf       = $_POST['data_nf_'.$w];
                   }

                    if (strlen($produto_referencia) == 0 AND empty($callcenter) && !in_array($login_fabrica, [186,195])) {
                        if (($login_fabrica == 52 && $hd_orientacao == false) || $login_fabrica != 52) {
                            $msg_erro .= "Preencha o campo Referência<br/>";
                        }
                    }

                    if (strlen($produto_nome) == 0 AND empty($callcenter) && !in_array($login_fabrica, [186,195])) {
                        if (($login_fabrica == 52 && $hd_orientacao == false) || $login_fabrica != 52) {
                            $msg_erro .= "Preencha o campo Descrição<br/>";
                        }
                    }

                    if ($login_fabrica == 186 && $obriga_campos == 't' && strlen($produto_referencia) == 0 && empty($callcenter)) {
                        $msg_erro .= "Preencha o campo Referência<br/>";
                    }
                    if ($login_fabrica == 186 && $obriga_campos == 't' && strlen($produto_nome) == 0 && empty($callcenter)) {
                        $msg_erro .= "Preencha o campo Descrição<br/>";
                    }

                    if (strlen($produto_referencia) > 0) {

                        $sql_ref = "SELECT tbl_produto.produto
                            FROM  tbl_produto
                            join  tbl_linha on tbl_produto.linha = tbl_linha.linha
                            WHERE tbl_produto.referencia = '$produto_referencia'
                            and tbl_linha.fabrica = $login_fabrica
                            and tbl_produto.fabrica_i = $login_fabrica
                            limit 1";
                        $res_ref = pg_query($con,$sql_ref);
                        $msg_erro .= pg_errormessage($con);

                        if (pg_num_rows($res_ref) > 0) {
                            $xproduto = pg_fetch_result($res_ref, 0, 0);

                            if($xcodigo_posto != "null"){
                                $sql_linha = "SELECT tbl_linha.linha
                                    FROM tbl_produto
                                    JOIN tbl_linha ON tbl_produto.linha = tbl_linha.linha AND tbl_linha.fabrica = $login_fabrica
                                    JOIN tbl_posto_linha ON tbl_linha.linha = tbl_posto_linha.linha AND posto = $xcodigo_posto
                                    WHERE tbl_produto.produto = $xproduto";
                                $res_linha = pg_query($con,$sql_linha);
                                if(pg_num_rows($res_linha) == 0){
                                    $msg_erro .= "O posto não atende a linha do produto $produto_referencia";
                                }
                            }
                        } else {
                            $xproduto = "null";
                        }

                    } else {

                        $xproduto = "null";
                    }

                    if ($login_fabrica == 151 AND $b_num_serie == 't' AND empty($obs_num_serie)) {
                        $msg_erro .= "Para bloquear o número de série é necessário informar uma observação<br>";
                    }

                    if ($login_fabrica == 151 AND $b_num_serie == 't' AND empty($serie)) {
                        $msg_erro .= "Para bloquear o número de série é necessário informar um número de série<br>";
                    }

                    if ($login_fabrica == 151 AND strlen($nota_fiscal) == 0 AND $abre_os == 't') {
                        $msg_erro .= "Para que a PRÃ-OS seja aberta é necessário informar a Nota Fiscal do produto<br>";
                    }

                    if ($login_fabrica == 151 AND strlen($data_nf) == 0 AND $abre_os == 't') {
                        $msg_erro .= "Para que a PRÃ-OS seja aberta é necessário informar a Data da Nota Fiscal do produto <br>";
                    }

                    if (!in_array($login_fabrica, [151,189,190,195]) AND ($defeito_reclamado) == 0 and (strlen($xproduto)>0 and $xproduto != 'null') ) {
                        $msg_erro .= "Favor Escolha um defeito reclamado para o produto<br>";
                    }

                    if (strlen($defeito_reclamado) > 0 and (strlen($xproduto) == 0 or $xproduto == 'null')) {
                        $msg_erro .= "<br>Favor Escolha o produto";
                    }

                    if (($xproduto == 'null' or empty($xproduto)) and $abre_ordem_servico == 't'){
                        $msg_erro .= "<br> Favor Escolha um produto";
                    }

                    if(!in_array($login_fabrica, [151,186,189,190,195])) {
                        if (empty($serie) and (strlen($xproduto)>0 and $xproduto != 'null' ) ) {

                            if (in_array($login_fabrica, [203])) {
                                $xAbrePreOs = $_POST['abre_os'];

                                if (empty($xAbrePreOs) || $xAbrePreOs != 't') {
                                    $msg_erro .= "<br> Favor inserir o número de série para o produto '$produto_referencia'";
                                }
                            } else {
                                $msg_erro .= "<br> Favor inserir o número de série para o produto '$produto_referencia'";
                            }

                        }else{

                            if (in_array($serie, $series_digitadas[$xproduto])) {
                                $msg_erro .= "A série digitada: '$serie' ja foi cadastrada para algum outro produto neste atendimento ";
                            }else{
                                $series_digitadas[$xproduto][] = $serie;
                            }


                        }

                        if (!empty($serie)) {

                            $sql = "SELECT serie from tbl_numero_serie where serie = '$serie' and fabrica = $login_fabrica";
                            $res = pg_query($con, $sql);

                            if (pg_num_rows($res) == 0) {
                                $msg_erro .="Numero de Série Inválido";
                            }

                        }
                    }

                    if (in_array($login_fabrica, array(151,186,189,190,195)) AND strlen($data_nf) > 0) {
                        list($dia_nf, $mes_nf, $ano_nf) = explode("/", $data_nf);
                        if(!checkdate($mes_nf,$dia_nf,$ano_nf)) {
                            $msg_erro .= "Data NF Inválida";
                        }else{
                            $xdata_nf = "'".$ano_nf.'-'.$mes_nf.'-'.$dia_nf."'";
                        }

                        $sqldt = "SELECT $xdata_nf::date > current_date";
                        $resdt = pg_query($con,$sqldt);
                        $resultdt = pg_fetch_result($resdt, 0, 0);
                        if($resultdt == 't') {
                            $msg_erro .= "DATA DA NF NÃO PODE SER MAIOR QUE DATA DE HOJE";
                        }
                    }

                    $campo_xdefeito     = "";
                    $campo_defeito      = "";
                    $campo_nota_fiscal  = "";
                    $campo_data_nf      = "";
                    $campo_xposto      = "";
                    $valor_nota_fiscal  = "";
                    $valor_data_nf      = "";
                    $valor_defeito      = "";
                    $valor_xdefeito     = "";
                    $valor_xposto     = "";
                    $serie = "'$serie'";

                    if (strlen($produto_referencia) != 0) {
                        if (strlen($defeito_reclamado) != 0 && ($login_fabrica == 52 || $login_fabrica == 151)) {
                            $campo_defeito = "defeito_reclamado,";
                            $valor_defeito = "$defeito_reclamado, ";
                        }

                        if ($login_fabrica == 151) {
                            $window_cadastra_pedido = "false";
                            $defeito_reclamado = (strlen($defeito_reclamado) == 0) ? "null" : $defeito_reclamado;

                            $sqlDef = "SELECT descricao FROM tbl_defeito_reclamado WHERE fabrica = $login_fabrica AND ativo='t' AND defeito_reclamado=$defeito_reclamado";
                            $resDef = pg_query($con, $sqlDef);

                            if (pg_num_rows($resDef) > 0) {
                                $xdefeito = pg_fetch_result($resDef, 0, descricao);
                                $campo_xdefeito = "defeito_reclamado_descricao,";
                                $valor_xdefeito = "'$xdefeito',";
                            }

                            $campo_nota_fiscal  = "nota_fiscal,";
                            $campo_data_nf      = "data_nf,";
                            $campo_voltagem     = "voltagem,";
                            $valor_nota_fiscal  = "'$nota_fiscal', ";
                            $valor_data_nf      = "$xdata_nf, ";
                            $valor_voltagem     = "'$voltagem', ";

                            if (!empty($obs_num_serie) && empty($msg_erro)) {
                                $sql = "INSERT INTO tbl_serie_controle (fabrica, produto, serie, quantidade_produzida, motivo)
                                            VALUES ($login_fabrica, $xproduto, $serie, 0, '$obs_num_serie')";
                                pg_query($con, $sql);
                                if (strlen(pg_last_error()) > 0) {
                                    $msg_erro .= "Erro ao tentar bloquear o número de série";
                                }else{
                                    $window_cadastra_pedido = "true";
                                }
                            }
                        }


                        if (in_array($login_fabrica, [186,189,190,195])) {

                            if (strlen($defeito_reclamado) > 0 && in_array($login_fabrica, [189])) {
                                $sqlDef = "SELECT defeito_reclamado FROM tbl_defeito_reclamado WHERE fabrica = $login_fabrica AND ativo='t' AND defeito_reclamado=$defeito_reclamado";
                                $resDef = pg_query($con, $sqlDef);
                                if (pg_last_error()) {
                                    $msg_erro .= "Informe o Defeito reclamado";
                                }
                                if (pg_num_rows($resDef) > 0) {
                                    $xdefeito = pg_fetch_result($resDef, 0, defeito_reclamado);
                                    $campo_xdefeito .= "defeito_reclamado,";
                                    $valor_xdefeito .= "'$xdefeito',";
                                }
                            }

                            if (in_array($login_fabrica, [186,190])) {
                                if (strlen($defeito_reclamado) > 0) {
                                    $campo_xdefeito .= "defeito_reclamado,";
                                    $valor_xdefeito .= "'$defeito_reclamado',";
                                } else {
                                    $msg_erro .= "Informe o Defeito reclamado";
                                }
                            }

                            if (in_array($login_fabrica, [190,195])) {
                                if (strlen($_POST['posto_tab']) > 0) {
                                    $campo_xposto .= "posto,";
                                    $valor_xposto .= $_POST['posto_tab'].",";
                                } 
                            }


                            $campo_nota_fiscal  = "nota_fiscal,";
                            $campo_data_nf      = "data_nf,";
                            $campo_voltagem     = "voltagem,";
                            $valor_nota_fiscal  = "'$nota_fiscal', ";
                            $valor_data_nf      = "$xdata_nf, ";
                            $valor_voltagem     = "'$voltagem', ";
                            $count_qtde_prod_lancado = $qtde_prod_lancado;
                            if (in_array($login_fabrica, [186,190,195])) {
                                $qtde_prod_lancado = 1;
                            }
                            if (strlen($qtde_prod_lancado) > 0) {
                                $campo_xdefeito .= "qtde,";
                                $valor_xdefeito .= "'$qtde_prod_lancado',";
                            }

                            if (strlen($reclamado_cliente_produto) > 0) {
                                $campo_xdefeito .= "defeito_reclamado_descricao,";
                                $valor_xdefeito .= "'$reclamado_cliente_produto',";
                            }
                            if (strlen($preco) > 0) {
                                $campo_xdefeito .= "campos_adicionais,";
                                $valor_xdefeito .= "'".json_encode(["preco" => $preco])."',";
                            }

                        }

                        if (strlen($msg_erro)==0) {

                            if($abre_os == 't'){
                                $comentario_x = 'Inserção de Produto para pré-OS';
                            }
                            if($abre_os == 't' && in_array($login_fabrica, [190])) {
                                $comentario_x = 'Inserção de Produto para OS';
                            }
                            if($abre_ordem_servico == 't' && in_array($login_fabrica, [195])) {
                                $comentario_x = 'Inserção de Produto para OS';
                            }

                            if (in_array($login_fabrica, [186])) {
                                for ($ind=1; $ind <= $count_qtde_prod_lancado; $ind++) {
                                    $sql = "INSERT INTO tbl_hd_chamado_item(
                                                hd_chamado   ,
                                                data         ,
                                                admin        ,
                                                interno      ,
                                                produto      ,
                                                serie        ,
                                                {$campo_defeito}
                                                {$campo_nota_fiscal}
                                                {$campo_data_nf}
                                                {$campo_voltagem}
                                                {$campo_xdefeito}
                                                status_item,
                                                comentario
                                            ) values (
                                                $hd_chamado                       ,
                                                current_timestamp                 ,
                                                $login_admin                      ,
                                                't'                               ,
                                                '$xproduto'                       ,
                                                $serie                          ,
                                                {$valor_defeito}
                                                {$valor_nota_fiscal}
                                                {$valor_data_nf}
                                                {$valor_voltagem}
                                                {$valor_xdefeito}
                                                $xstatus_interacao,
                                                '$comentario_x'
                                                ) RETURNING hd_chamado_item";
                                    $res = pg_query($con,$sql);
                                }

                            } else {

                                $sql = "INSERT INTO tbl_hd_chamado_item(
                                            hd_chamado   ,
                                            data         ,
                                            admin        ,
                                            interno      ,
                                            produto      ,
                                            serie        ,
                                            {$campo_defeito}
                                            {$campo_nota_fiscal}
                                            {$campo_data_nf}
                                            {$campo_voltagem}
                                            {$campo_xdefeito}
                                            {$campo_xposto}
                                            status_item,
                                            comentario,
                                            hd_motivo_ligacao
                                        ) values (
                                            $hd_chamado                       ,
                                            current_timestamp                 ,
                                            $login_admin                      ,
                                            't'                               ,
                                            '$xproduto'                       ,
                                            $serie                          ,
                                            {$valor_defeito}
                                            {$valor_nota_fiscal}
                                            {$valor_data_nf}
                                            {$valor_voltagem}
                                            {$valor_xdefeito}
                                            {$valor_xposto}
                                            $xstatus_interacao,
                                            '$comentario_x',
                                            $hd_motivo_ligacao
                                            ) RETURNING hd_chamado_item";
                                $res = pg_query($con,$sql);
                            }

                            if($login_fabrica == 151){
                                 $voucher_hd_item = pg_fetch_result($res, 0, 'hd_chamado_item');
                            }
                           
                            if(strlen($controle_cliente) > 0 && $login_fabrica == 52){
                                $sql = "UPDATE tbl_hd_chamado SET protocolo_cliente = '$controle_cliente' WHERE hd_chamado = $hd_chamado";
                                $res = pg_query($con,$sql);
                            }
                            if ($login_fabrica == 189 && verifica_origem_atendimento($_POST["origem"]) == "producao" && !pg_last_error()) {
                                $hd_chamado_item = pg_fetch_result($res, 0, 'hd_chamado_item');
                                grava_chamado_item_externo($hd_chamado, $hd_chamado_item);
                            } 

                            if($login_fabrica == 151){

                                if(!empty($voucher_codigo) && !empty($voucher_id)){

                                    $voucher_nome = trim($_POST['consumidor_nome']);
                                    $voucher_cpf = trim($_POST['consumidor_cpf']);
                                    $voucher_data = date('Y-m-d');

                                    $sql_alter_voucher = 
                                    "UPDATE tbl_voucher SET status = 'UTILIZADO',  hd_chamado = $hd_chamado,
                                                            nome_consumidor = '$voucher_nome', cpf = '$voucher_cpf',
                                                            data = '$voucher_data'
                                     WHERE fabrica = $login_fabrica AND voucher = $voucher_id";
                                    pg_query($con,$sql_alter_voucher);

                                    $sql_campos_adicionais = "SELECT campos_adicionais 
                                                              FROM tbl_hd_chamado_item 
                                                              WHERE hd_chamado = $hd_chamado AND hd_chamado_item = $voucher_hd_item";

                                    $qry_campos_adicionais = pg_query($sql_campos_adicionais);
                                    $campos_adicionais = pg_fetch_result($qry_campos_adicionais, 0, 'campos_adicionais');
                    
                                    if (!is_object($campos_adicionais) || empty($campos_adicionais)){
                                        $campos_adicionais = new Json($campos_adicionais);
                                    }

                                    $campos_adicionais->voucher_id = $voucher_id;
                                    $campos_adicionais->voucher_codigo = $voucher_codigo;
                                    $campos_adicionais->voucher_familia = $voucher_familia;

                                    $campos_adicionais = "'" . $campos_adicionais . "'";

                                    $sql_alter_item = 
                                    "UPDATE tbl_hd_chamado_item SET campos_adicionais = $campos_adicionais
                                     WHERE hd_chamado = $hd_chamado AND hd_chamado_item = $voucher_hd_item";
                                    pg_query($con, $sql_alter_item);


                                }
                            }  
                        }
                    }
                }  
            }
        }
        /* HD 37805 */
        if ($tab_atual == "ressarcimento" and strlen($msg_erro) == 0) {

            if (strlen($xdata_nf) == 0 OR $xdata_nf == 'NULL') {
                $msg_erro .= "Informe a data da Nota fiscal.";
            }

            $sql  = "SELECT hd_chamado FROM tbl_hd_chamado_extra_banco WHERE hd_chamado = $hd_chamado ";
            $resx = @pg_query($con,$sql);

            if (@pg_num_rows($resx) == 0) {

                $sql = "INSERT INTO tbl_hd_chamado_extra_banco ( hd_chamado ) values ( $hd_chamado )";
                $res = pg_query($con, $sql);

                $msg_erro .= pg_errormessage($con);

            }

            $sql = "UPDATE tbl_hd_chamado_extra_banco SET
                banco            = $xbanco,
                                 agencia          = $xagencia,
                                 contay           = $xcontay,
                                 nomebanco        = $xnomebanco,
                                 favorecido_conta = $xfavorecido_conta,
                                 cpf_conta        = $xcpf_conta,
                                 tipo_conta       = $xtipo_conta
                                     WHERE hd_chamado = $hd_chamado";

            $res = pg_query($con, $sql);
            $msg_erro .= pg_errormessage($con);

            $sql  = "SELECT hd_chamado FROM tbl_hd_chamado_troca WHERE hd_chamado = $hd_chamado ";
            $resx = @pg_query($con, $sql);

            if (@pg_num_rows($resx) == 0) {
                $sql = "INSERT INTO tbl_hd_chamado_troca ( hd_chamado ) values ( $hd_chamado )";
                $res = pg_query($con, $sql);
                $msg_erro .= pg_errormessage($con);
            }

            $sql = "UPDATE tbl_hd_chamado_troca SET
                data_pagamento    = $xdata_pagamento,
                                  ressarcimento     = 't',
                                  numero_objeto     = NULL,
                                  nota_fiscal_saida = NULL,
                                  data_nf_saida     = NULL,
                                  produto           = NULL,
                                  valor_produto     = $xvalor_produto,
                                  valor_inpc        = $xvalor_inpc,
                                  valor_corrigido   = $xvalor_corrigido
                                      WHERE hd_chamado = $hd_chamado";

            $res = pg_query($con, $sql);
            $msg_erro .= pg_errormessage($con);

            if (strlen($valor_produto) > 0 AND strlen($valor_inpc) > 0 AND strlen($msg_erro) == 0) {

                $sql  = "SELECT CURRENT_DATE - data_nf AS qtde_dias FROM tbl_hd_chamado_extra WHERE hd_chamado = $hd_chamado ";
                $resx = @pg_query($con, $sql);

                if (@pg_num_rows($resx) > 0) {

                    $qtde_dias = pg_fetch_result($resx, 0, 'qtde_dias');

                    if ($qtde_dias > 0) {

                        $valor_corrigido = $valor_produto + ($valor_produto * $qtde_dias / 100);

                        $sql = "UPDATE tbl_hd_chamado_troca SET valor_corrigido = $valor_corrigido WHERE hd_chamado = $hd_chamado";
                        $res = pg_query($con, $sql);

                        $msg_erro .= pg_errormessage($con);

                    }

                }

            }

        }

        /* HD 37805 */
        if ($tab_atual == "sedex_reverso" and strlen($msg_erro) == 0) {

            $sql  = "SELECT hd_chamado FROM tbl_hd_chamado_troca WHERE hd_chamado = $hd_chamado ";
            $resx = @pg_query($con, $sql);

            if (@pg_num_rows($resx) == 0) {

                $sql = "INSERT INTO tbl_hd_chamado_troca ( hd_chamado ) values ( $hd_chamado )";
                $res = pg_query($con,$sql);

                $msg_erro .= pg_errormessage($con);

            }

            $sql = "UPDATE tbl_hd_chamado_troca SET
                data_pagamento       =  NULL,
                                     ressarcimento        = 'f',
                                     numero_objeto        = $xnumero_objeto,
                                     nota_fiscal_saida    = $xnota_fiscal_saida,
                                     data_nf_saida        = $xdata_nf_saida,
                                     produto              = $xproduto_troca,
                                     data_retorno_produto = $xdata_retorno_produto
                                         WHERE hd_chamado = $hd_chamado";

            $res = pg_query($con,$sql);
            $msg_erro .= pg_errormessage($con);

        }

        if ($tab_atual == "extensao" and strlen($msg_erro) == 0 and $login_fabrica == 25) {

            if (strlen($es_data_compra) == 0) {
                $msg_erro .= "Informe a data da Compra do produto.";
            }

        }

        /* ##################  grava no banco de dados da hbtech ##################### */
        if ($tab_atual == "extensao" and strlen($msg_erro) == 0 and $login_fabrica == 25) {

            if (strlen($consumidor_fone) == 15) {

                $xddd_consumidor  = "'".substr($consumidor_fone,2,2)."'";
                $xfone_consumidor = "'".substr($consumidor_fone,6,9)."'";

            } else if (strlen($consumidor_fone)==9 or strlen($consumidor_fone) == 8) {

                $xddd_consumidor  = "null";
                $xfone_consumidor = "'".$consumidor_fone."'";

            } else if (strlen($consumidor_fone) == 11 or strlen($consumidor_fone) == 10) {

                $xddd_consumidor  = "'".substr($consumidor_fone,0,2)."'";
                $xfone_consumidor = "'".substr($consumidor_fone,2,9)."'";

            } else if (strlen($consumidor_fone) == 0) {

                $xddd_consumidor  = "NULL";
                $xfone_consumidor = "NULL";

            } else {

                $xddd_consumidor  = "NULL";
                $xfone_consumidor = "'".$consumidor_fone."'";

            }

            $xxes_data_compra = converte_data($es_data_compra);
            $sql = "SELECT garantia from tbl_produto where produto = $xproduto";
            $res = pg_query($con, $sql);
            $garantia = pg_fetch_result($res, 0, 0);

            $sql = "SELECT to_char(('$xxes_data_compra'::date + interval '$garantia month') + interval '6 month','YYYY-MM-DD') ";
            $res = pg_query($con, $sql);
            $es_garantia = "'".pg_fetch_result($res, 0, 0)."'";

            if (strlen($es_id_numeroserie) > 0) {

                include "conexao_hbtech.php";

                /*INSERINDO NO SITE DO HIBEATS, VERIFICAMOS ANTES SE EXISTE ESSE NUMERO DE SRIE E INSERIMOS OS DADOS DO CLIENTE*/
                $sql = "INSERT INTO garantia(
                    produto           ,
                                      numeroSerie       ,
                                      nome              ,
                                      endereco          ,
                                      numero            ,
                                      complemento       ,
                                      cep               ,
                                      bairro            ,
                                      cidade            ,
                                      estado            ,
                                      sexo              ,
                                      dataNascimento    ,
                                      cpf               ,
                                      dddComercial      ,
                                      foneComercial     ,
                                      dddResidencial    ,
                                      foneResidencial   ,
                                      dddCelular        ,
                                      foneCelular       ,
                                      email             ,
                                      estadoCivil       ,
                                      filhos            ,
                                      prefMusical       ,
                                      dataCompra        ,
                                      nf                ,
                                      lojaAdquirida     ,
                                      estadoCompra      ,
                                      municipioCompra   ,
                                      dataGarantia
                                          ) values (
                                              '$produto_referencia||$produto_nome',
                                              $xserie  ,
                                              $xconsumidor_nome       ,
                                              $xconsumidor_endereco   ,
                                              $xconsumidor_numero     ,
                                              $xconsumidor_complemento,
                                              $xconsumidor_cep        ,
                                              $xconsumidor_bairro     ,
                                              $xconsumidor_cidade     ,
                                              $xconsumidor_estado     ,
                                              $xes_sexo               ,
                                              $xes_data_nascimento    ,
                                              $xconsumidor_cpf        ,
                                              $xes_dddcomercial       ,
                                              $xes_fonecomercial      ,
                                              $xddd_consumidor        ,
                                              $xfone_consumidor       ,
                                              $xes_dddcelular         ,
                                              $xes_celular            ,
                                              $xconsumidor_email      ,
                                              $xes_estadocivil        ,
                                              $xes_filhos             ,
                                              $xes_preferenciamusical ,
                                              $xes_data_compra        ,
                                              $xes_nota_fiscal        ,
                                              $xes_revenda            ,
                                              $xes_estadocompra       ,
                                              $xes_municipiocompra    ,
                                              $es_garantia
                                                  );";

                $res = mysql_query($sql) or die("Erro no Sql1: ".mysql_error());

                if ($xconsumidor_cpf == 'null' or strlen($xconsumidor_cpf) == 0 ){
                    $pesquisa_xconsumidor_cpf = " AND cpf  IS NULL ";
                } else {
                    $pesquisa_xconsumidor_cpf = " AND cpf  = $xconsumidor_cpf";
                }

                $sql = "SELECT idGarantia FROM garantia WHERE numeroSerie = $xserie $pesquisa_xconsumidor_cpf";
                $res = mysql_query($sql) or die("Erro no Sql2:".mysql_error());

                if (mysql_num_rows($res) > 0) {

                    $idGarantia = mysql_result($res, 0, 'idGarantia');
                    $sql = "UPDATE numero_serie SET idGarantia = $idGarantia WHERE numero = $xserie";
                    $res = mysql_query($sql) or die("Erro no Sql:".mysql_error());

                }

            }
        }

        if (strlen($msg_erro) == 0) {

            $sql = "SELECT fn_callcenter_dias_interacao($hd_chamado,$login_fabrica)";
            $res = pg_query($con, $sql);
            $msg_erro .= pg_errormessage($con);

            $sql = "SELECT fn_callcenter_dias_aberto($hd_chamado,$login_fabrica);";
            $res = pg_query($con, $sql);
            $msg_erro .= pg_errormessage($con);

            $sql = "SELECT fn_callcenter_intervalo_interacao($hd_chamado,$login_fabrica);";
            $res = pg_query($con, $sql);
            $msg_erro .= pg_errormessage($con);

        }

        if ($abre_os == 't' AND $imprimir_os == 't') {
            $imprimir_os = "&imprimir_os=t";
        } else {
            $imprimir_os = "";
        }

        $assunto_vazio = 0;

        $tot_campos = count($_POST['callcenter_assunto']);

        if ($login_fabrica == 24){

            $assunto_atendimento = $_POST['callcenter_assunto'];

            if ($tab_atual != "sugestao"){

                unset($assunto_atendimento["sugestao"]);
            }

            $tot_campos = count($assunto_atendimento);

            foreach ($assunto_atendimento as $campo => $valor) {
                if (strlen($valor)==0) {
                    $assunto_vazio++;
                }elseif ($assunto_vazio > 0) {
                    $assunto_vazio --;
                }
            }

            if ($assunto_vazio == $tot_campos){
                $msg_erro = "Insira o assunto do atendimento";
            }

        }

        if (strlen($xtransferir) > 0 AND strlen($hd_chamado) > 0 AND ($login_admin <> $xtransferir)) {//HD 26968
            $sql = "UPDATE tbl_hd_chamado set atendente = $xtransferir
                WHERE tbl_hd_chamado.fabrica_responsavel = $login_fabrica
                and tbl_hd_chamado.hd_chamado = $hd_chamado ";

            $res = pg_query($con,$sql);
            $msg_erro .= pg_errormessage($con);


            if($login_fabrica != 74){

                $sql = "SELECT login, nome_completo from tbl_admin where admin = $login_admin";
                $res = pg_query($con, $sql);

                if (in_array($login_fabrica, array(164,169,170))){
                    $nome_ultimo_atendente = pg_fetch_result($res, 0, 'nome_completo');
                }else{
                    $nome_ultimo_atendente = pg_fetch_result($res, 0, 'login');
                }


                $sql = "SELECT login, nome_completo from tbl_admin where admin = $xtransferir";
                $res = pg_query($con, $sql);

                if (in_array($login_fabrica, array(164,169,170))){
                    $nome_atendente = pg_fetch_result($res,0,nome_completo);
                    $mensagem_transferir = "Atendimento transferido por <b>$login_nome_completo</b> de <b>$nome_ultimo_atendente</b> para <b>$nome_atendente</b>";
                }else{
                    $nome_atendente = pg_fetch_result($res,0,login);
                    $mensagem_transferir = "Atendimento transferido por <b>$login_login</b> de <b>$nome_ultimo_atendente</b> para <b>$nome_atendente</b>";
                }


                $sql = "INSERT INTO tbl_hd_chamado_item(
                    hd_chamado   ,
                                 data         ,
                                 comentario   ,
                                 admin        ,
                                 interno      ,
                                 status_item  ,
                                 admin_transferencia
                                     ) values (
                                         $hd_chamado       ,
                                         current_timestamp ,
                                         E'$mensagem_transferir',
                                         $login_admin      ,
                                         't'  ,
                                         $xstatus_interacao,
                                         $xtransferir
                                         ) RETURNING hd_chamado_item";
                $res = pg_query($con,$sql);
                $msg_erro .= pg_errormessage($con);
                if ($login_fabrica == 189 && verifica_origem_atendimento($_POST["origem"]) == "producao" && strlen($msg_erro) == 0) {
                    $hd_chamado_item = pg_fetch_result($res, 0, 'hd_chamado_item');
                    grava_chamado_item_externo($hd_chamado, $hd_chamado_item);
                }
            }

        }

        // HD 129655 - Gravar dÃºvidas selecionadas [augusto]
        if (strlen($msg_erro) == 0) {
            if($novaTelaOs == true){
                gravarNovoFaq();
            }else{
                gravarFaq();
            }
        }

        //HD 211895: Rotina de PRÃ-OS movida para fora das rotinas de inserção e atualização
        //ATENÃÃO: COMMIT E ROLLBACK DESTA TRANSAÃÃO FOI MOVIDO PARA DEPOIS DA ROTINA DE INSERÃÃO
        //DE PRÃ-OS, QUE ESTÃ LOGO ABAIXO DA ROTINA DE ATUALIZAÃÃO (QUE COMEÃA AI EMBAIXO)

    } else {


        if ($login_fabrica == 156 and $abre_os == 't') {
            $codigo_posto_tab = $_POST["codigo_posto_tab"];
            $qry_posto_tab = pg_query(
                    $con,
                    "SELECT posto FROM tbl_posto_fabrica WHERE codigo_posto = '{$codigo_posto_tab}' AND fabrica = $login_fabrica"
                    );

            if (pg_num_rows($qry_posto_tab)) {
                $posto_tab = pg_fetch_result($qry_posto_tab, 0, 'posto');

                $atendente_filial = pg_query($con, "SELECT * FROM tbl_hd_chamado_extra_filial WHERE hd_chamado = $hd_chamado");

                if (pg_num_rows($atendente_filial) > 0) {
                    $msg_erro .= abreOSFilial($hd_chamado, $posto_tab);
                } else {
                    $msg_erro .= abreOSPostoTelaNova($hd_chamado, $posto_tab);
                }
            } else {
                $msg_erro .= 'Para abrir OS é necessário selecionar uma Autorizada.<br/>';
            }
        }
    }

    if ($login_fabrica == 151) {
        if ($qtde_produto > 0 && strlen($msg_erro) == 0) {
            for ($w = 1; $w <= $qtde_produto; $w++) {
                $data_nf = $_POST['data_nf_'.$w];

                if (strlen($data_nf) > 0) {
                    list($dia_nf, $mes_nf, $ano_nf) = explode("/", $data_nf);
                    if(!checkdate($mes_nf,$dia_nf,$ano_nf)) {
                        $msg_erro .= "Data NF Inválida";
                    }else{
                        $xdata_nf = "'".$ano_nf.'-'.$mes_nf.'-'.$dia_nf."'";
                    }

                    $sqldt = "SELECT $xdata_nf::date > current_date";
                    $resdt = pg_query($con,$sqldt);
                    $resultdt = pg_fetch_result($resdt, 0, 0);
                    if($resultdt == 't') {
                        $msg_erro .= "DATA DA NF NÃO PODE SER MAIOR QUE DATA DE HOJE";
                    }
                }
            }
        }
    }

    if ($moduloOSMultipla == "t" AND strlen($msg_erro) == 0 AND ($_POST['abre_ordem_servico'] == "t"  || $login_fabrica == 178)) {

        $res = pg_query ($con, "BEGIN TRANSACTION");

        $qtde_produto_antes = $_POST['qtde_produto_antes'];
        $qtde_produto       = $_POST['qtde_produto'];
        $abre_ordem_servico = $_POST['abre_ordem_servico'];

        if ( $_POST["consumidor_revenda"] == "C" AND (empty($_POST["nome_revenda"]) OR empty($_POST["cnpj_revenda"]))){
            if (!in_array($login_fabrica, [178])) {
                $msg_erro .= "Selecione Revenda para abertura da Ordem de Serviço <br/>";
            }

            if (in_array($login_fabrica, [178]) && $_POST['abre_ordem_servico'] == "t") {
                $msg_erro .= "Selecione Revenda para abertura da Ordem de Serviço <br/>";
            }
        }

        if (empty($_POST["posto_nome_tab"]) OR empty($_POST["codigo_posto_tab"])){
            if (!in_array($login_fabrica, [178])) {
                $msg_erro .= "Selecione Posto Autorizado para abertura de Ordem de Serviço <br/>";
            }

            if (in_array($login_fabrica, [178]) && $_POST['abre_ordem_servico'] == "t") {
                $msg_erro .= "Selecione Posto Autorizado para abertura de Ordem de Serviço <br/>";
            }
        }

        if ($qtde_produto > 0 AND strlen($msg_erro) == 0) {
            for ($w = 1; $w <= $qtde_produto; $w++) {
                $produto_referencia        = trim($_POST['produto_referencia_'.$w]);
                $produto_nome              = trim($_POST['produto_nome_'.$w]);
                $serie                     = trim($_POST['serie_'.$w]);
                $defeito_reclamado         = $_POST['defeito_reclamado_'.$w];
                $nota_fiscal               = $_POST['nota_fiscal_'.$w];
                $data_nf                   = $_POST['data_nf_'.$w];
                $qtde_prod_lancado         = $_POST['qtde_prod_lancado_'.$w];
				$reclamado_cliente_produto = $_POST["reclamado_cliente_produto_".$w];
				$hd_item		   = $_POST["hd_chamado_item_".$w];

                if (empty($qtde_prod_lancado)){
					$qtde_prod_lancado = "null";
                    if (!in_array($login_fabrica, [178])) {
                        $msg_erro .= "Informe a quantidade do produto <br/>";
                    }

                    if (in_array($login_fabrica, [178]) && $_POST['abre_ordem_servico'] == "t") {
                        $msg_erro .= "Informe a quantidade do produto <br/>";
                    }
                }

                if (strlen($produto_referencia) > 0) {
                    if (empty($qtde_prod_lancado)){
                        if (!in_array($login_fabrica, [178])) {
                            $msg_erro .= " Preencha o campo Quantidade <br/>";
                        }

                        if (in_array($login_fabrica, [178]) && $_POST['abre_ordem_servico'] == "t") {
                            $msg_erro .= " Preencha o campo Quantidade <br/>";
                        }
                    }
                    // if (empty($reclamado_cliente_produto) AND $consumidor_revenda == "C"){
                    //     $msg_erro .= " Preencha o campo Reclamado Cliente <br/>";
                    // }

                    if (empty($defeito_reclamado)){
                        if (!in_array($login_fabrica, [178])) {
                            $msg_erro .= "Preencha o campo Defeito Reclamado <br/>";
                        }

                        if (in_array($login_fabrica, [178]) && $_POST['abre_ordem_servico'] == "t") {
                            $msg_erro .= "Preencha o campo Defeito Reclamado <br/>";
                        }
                    }

                    $sql_ref = "SELECT tbl_produto.produto
                        FROM  tbl_produto
                        join  tbl_linha on tbl_produto.linha = tbl_linha.linha
                        WHERE tbl_produto.referencia = '$produto_referencia'
                        and tbl_linha.fabrica = $login_fabrica
                        and tbl_produto.fabrica_i = $login_fabrica
                        limit 1";
                    $res_ref = pg_query($con,$sql_ref);

                    $msg_erro .= pg_errormessage($con);

                    if (pg_num_rows($res_ref) > 0) {
                        $xproduto = pg_fetch_result($res_ref, 0, 0);

                        if($xcodigo_posto != "null"){
                            $sql_linha = "SELECT tbl_linha.linha
                                FROM tbl_produto
                                JOIN tbl_linha ON tbl_produto.linha = tbl_linha.linha AND tbl_linha.fabrica = $login_fabrica
                                JOIN tbl_posto_linha ON tbl_linha.linha = tbl_posto_linha.linha AND posto = $xcodigo_posto
                                WHERE tbl_produto.produto = $xproduto";
                            $res_linha = pg_query($con,$sql_linha);
                            if(pg_num_rows($res_linha) == 0){
                                $msg_erro .= "O posto não atende a linha do produto $produto_referencia";
                            }
                        }
                    } else {
                        $xproduto = "null";
                    }
                } else {
                    $xproduto = "null";
                }

                if (strlen($data_nf) > 0) {
                    list($dia_nf, $mes_nf, $ano_nf) = explode("/", $data_nf);
                    if(!checkdate($mes_nf,$dia_nf,$ano_nf)) {
                        $msg_erro .= "Data NF Inválida";
                    }else{
                        $xdata_nf = "'".$ano_nf.'-'.$mes_nf.'-'.$dia_nf."'";
                    }

                    $sqldt = "SELECT $xdata_nf::date > current_date";
                    $resdt = pg_query($con,$sqldt);
                    $resultdt = pg_fetch_result($resdt, 0, 0);
                    if($resultdt == 't') {
                        $msg_erro .= "DATA DA NF NÃO PODE SER MAIOR QUE DATA DE HOJE";
                    }
                }

                $campo_xdefeito     = "";
                $campo_defeito      = "";
                $campo_nota_fiscal  = "";
                $campo_data_nf      = "";
                $valor_nota_fiscal  = "";
                $valor_data_nf      = "";
                $valor_defeito      = "";
                $valor_xdefeito     = "";
                $serie = "'$serie'";

                if (!empty($defeito_reclamado)) {
					$campo_defeito = ",defeito_reclamado";
					$valor_defeito = ",$defeito_reclamado";
					$campo_up_defeito = ", defeito_reclamado = {$defeito_reclamado}";

					$campo_xdefeito = ",defeito_reclamado_descricao";
					$valor_xdefeito = ",'$reclamado_cliente_produto'";
					$campo_up_defeito_desc = ", defeito_reclamado_descricao = '{$reclamado_cliente_produto}'";

                }

                if (!empty($nota_fiscal)){
					$campo_nota_fiscal  = ",nota_fiscal";
					$valor_nota_fiscal  = ",'$nota_fiscal'";
					$campo_up_nf = ", nota_fiscal = '{$nota_fiscal}'";
                }

                if (!empty($xdata_nf)){
					$campo_data_nf      = ",data_nf";
					$valor_data_nf      = ",$xdata_nf";
					$campo_up_data_nf = ", data_nf = {$xdata_nf}";
                }

				if(!empty($hd_item)){

					$sql = "UPDATE tbl_hd_chamado_item SET
							produto = {$xproduto},
							serie = {$serie},
							qtde  = {$qtde_prod_lancado}
							{$campo_up_defeito}
							{$campo_up_defeito_desc}
							{$campo_up_nf}
							{$campo_up_data_nf}
						WHERE hd_chamado_item = {$hd_item}
						AND hd_chamado = {$hd_chamado}";
					$res = pg_query($con,$sql);
				}else{
					$sql = "INSERT INTO tbl_hd_chamado_item(
						hd_chamado,
						data,
						admin,
						interno,
						produto,
						serie,
						qtde
						{$campo_defeito}
						{$campo_nota_fiscal}
						{$campo_data_nf}
						{$campo_xdefeito}
					) values (
						$hd_chamado,
						current_timestamp,
						$login_admin,
						't',
						$xproduto,
						$serie,
						$qtde_prod_lancado
						{$valor_defeito}
						{$valor_nota_fiscal}
						{$valor_data_nf}
						{$valor_xdefeito}
					) RETURNING hd_chamado_item";
					$res = pg_query($con,$sql);

					if ($login_fabrica == 189 && verifica_origem_atendimento($_POST["origem"]) == "producao" && !pg_last_error()) {
						$hd_chamado_item = pg_fetch_result($res, 0, 'hd_chamado_item');
						grava_chamado_item_externo($hd_chamado, $hd_chamado_item);
					}
				}
            }
        }
    }
    if ($login_fabrica == 24 && $chamado_resolvido_reabertura === true && !empty($chamado_resolvido_reabertura_admin) && !empty($hd_chamado)) {
        $sql = "UPDATE tbl_hd_chamado SET atendente = $chamado_resolvido_reabertura_admin WHERE fabrica = $login_fabrica AND hd_chamado = $hd_chamado";
        $res = pg_query($con, $sql);

        if (strlen(pg_last_error()) > 0) {
            $msg_erro .= "Erro ao definir novo admin responsável para o chamado";
        }
    }

    /****************************************** ATUALIZAÃÃO *****************************************/
    if ($moduloProvidencia AND strlen(trim($hd_chamado))>0) {

        $data_prov = $_POST['data_prov'];

        if ($transferir_atendimento <> "sim" ) {
            $sql = "SELECT hd_motivo_ligacao FROM tbl_hd_chamado_extra WHERE hd_chamado = {$hd_chamado}";
            $resM = pg_query($con,$sql);
            $hd_motivo_ligacao_ant = pg_fetch_result($resM, 0, 'hd_motivo_ligacao');

            $sql = "SELECT data_providencia FROM tbl_hd_chamado WHERE hd_chamado = {$hd_chamado}";
            $resM = pg_query($con,$sql);
            $data_prov_ant = pg_fetch_result($resM, 0, 'data_providencia');
       }


       if($login_fabrica == 30){
            $sqlProv = "SELECT campos_adicionais FROM tbl_hd_motivo_ligacao WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}";
            $resProv = pg_query($con,$sqlProv);

            $situacaoProv = pg_fetch_result($resProv,0,'campos_adicionais');
            $situacaoProv = json_decode($situacaoProv,true);
            $situacaoProv = array_filter($situacaoProv['situacoes']);

            if($_POST['tab_atual'] == 'reclamacao_produto'){
                if(count($situacaoProv) > 0 AND !in_array($status_interacao,$situacaoProv)){
                    $msg_erro .= "A providência informada não pode ser utilizada para a situação atual do atendimento";
                }
            }
            
        }

        $sql = "SELECT tbl_hd_chamado_extra.hd_chamado
            FROM tbl_hd_chamado_extra
            JOIN tbl_hd_chamado ON tbl_hd_chamado.hd_chamado = tbl_hd_chamado_extra.hd_chamado
            LEFT JOIN tbl_os_produto ON tbl_hd_chamado_extra.os = tbl_os_produto.os
            LEFT JOIN tbl_os_item ON tbl_os_produto.os_produto = tbl_os_item.os_produto
            LEFT JOIN tbl_faturamento_item FOS ON tbl_os_item.os_item = FOS.os_item
            LEFT JOIN tbl_faturamento_item FP ON tbl_hd_chamado_extra.pedido = FP.pedido
            WHERE tbl_hd_chamado_extra.hd_chamado = {$hd_chamado}
            AND FOS.faturamento_item IS NULL
            AND FP.faturamento_item IS NULL
            AND tbl_hd_chamado.data_providencia::date = CURRENT_DATE";
        #$resM = pg_query($con,$sql);
    
        if($hd_motivo_ligacao == 104 and $login_fabrica == 30 ){                 

                $sql = "SELECT
                    to_char(data_providencia::date, 'DD/MM/YYYY') as data_providencia,
                    to_char(data_providencia::date, 'YYYY-MM-DD') as data_pg
                        FROM tbl_hd_chamado
                        WHERE hd_chamado = {$hd_chamado}";
                $res = pg_query($con,$sql);

                while ($linha = pg_fetch_array($res)) {
                    $data_prov_antiga = $linha['data_providencia'];
                    $data_pg_antiga = $linha['data_pg'];
                }
    
        if($data_prov_antiga != $_POST['data_prov']){

                    $msg_interacao_dt_prov = "<li>Campo <strong>Data Providência</strong> alterado de <em>{$data_prov_antiga}</em> para <em> ".$_POST['data_prov']." </li>";

                    $sql = "INSERT INTO tbl_hd_chamado_item(
                            hd_chamado   ,
                            data         ,
                            comentario   ,
                            admin        ,
                            interno      ,
                            status_item
                        ) values (
                            $hd_chamado       ,
                            current_timestamp ,
                            E'$msg_interacao_dt_prov'       ,
                            $login_admin      ,
                            't',
                            $xstatus_interacao
                        ) RETURNING hd_chamado_item";                    

                    $res = pg_query($con,$sql);
        }
                    $sql = "UPDATE tbl_hd_chamado SET data_providencia = '".formata_data($_POST['data_prov'])." 00:00:00' WHERE hd_chamado = {$hd_chamado}";
                    $res = pg_query($con,$sql);
            
        }else{
            if(strlen($hd_motivo_ligacao) > 0 && $hd_motivo_ligacao != "NULL" && ($hd_motivo_ligacao != $hd_motivo_ligacao_ant || empty($data_prov_ant)) && strlen($msg_erro) == 0 ){

                $sql = "select fn_calcula_previsao_retorno(current_date,prazo_dias,$login_fabrica)::date AS data_providencia from tbl_hd_motivo_ligacao where hd_motivo_ligacao = {$hd_motivo_ligacao}";
                $resP = pg_query($con,$sql);
                $data_providencia = pg_fetch_result($resP, 0, 'data_providencia');

                $sql = "UPDATE tbl_hd_chamado SET data_providencia = '{$data_providencia} 00:00:00' WHERE hd_chamado = {$hd_chamado}";
                $res = pg_query($con,$sql);

            }
        }

        if ($login_fabrica == 189) {
            
            $data_prov_comp = date("Y-m-d H:i:s");

            $sqlMot = "SELECT prazo_horas FROM tbl_hd_motivo_ligacao WHERE fabrica={$login_fabrica} AND hd_motivo_ligacao={$hd_motivo_ligacao}";
            $resMot = pg_query($con, $sqlMot);
            $prazo = pg_fetch_result($resMot, 0, 'prazo_horas');
            $data_pr = date('Y-m-d H:i:s', strtotime("$data_prov_comp + $prazo hour"));

            $novaDataProv = calcula_horas_uteis(date("Y-m-d 09:00:00"), date("Y-m-d 17:00:00"), $data_pr, $prazo);

            /*
            $data_corte_ini = date("Y-m-d 08:00:00");
            $data_corte_fim = date("Y-m-d 17:30:00");
            if ($data_pr >= $data_corte_ini && $data_pr <= $data_corte_fim) {
                $novaDataProv = $data_pr;
            } else {
                $nov_prov = date('Y-m-d 08:00:00', strtotime("$data_prov_comp +1 days"));
                $novaDataProv = date('Y-m-d H:i:s', strtotime("$nov_prov +$prazo hour"));
            }*/
			$sql = "UPDATE tbl_hd_chamado SET data_providencia = '{$novaDataProv}' WHERE hd_chamado = {$hd_chamado}";
			$res = pg_query($con,$sql);


        }

        if(strlen($data_prov) > 0 && $hd_motivo_ligacao == $hd_motivo_ligacao_ant){
            list($d, $m, $a) = explode("/", $data_prov);
            $data_prov_comp = $a."-".$m."-".$d;

            list($data, $hora) = explode(" ", $data_prov_ant);
            $data_prov_ant_comp = $data;

            if(!empty($hd_motivo_ligacao) and ($data_prov_comp != $data_prov_ant_comp)){
                if ($login_fabrica == 30 and $hd_motivo_ligacao != 104) {
                    $sql = "SELECT
                        to_char(data_providencia::date, 'DD/MM/YYYY') as data_providencia,
                        to_char(data_providencia::date, 'YYYY-MM-DD') as data_pg
                            FROM tbl_hd_chamado
                            WHERE hd_chamado = {$hd_chamado}";
                    $res = pg_query($con,$sql);
                    while ($linha = pg_fetch_array($res)) {
                        $data_prov_antiga = $linha['data_providencia'];
                        $data_pg_antiga = $linha['data_pg'];
                    }

                    $sql = "UPDATE tbl_hd_chamado SET data_providencia = '{$data_prov_comp} 00:00:00' WHERE hd_chamado = {$hd_chamado}";
                    $res = pg_query($con,$sql);

                    //cria uma nova variavel para padronizar
                    $data_prov_nova = $data_prov;

                    // Calcula a diferença em segundos entre as datas
                    $diferenca = strtotime($data_prov_comp) - strtotime($data_pg_antiga);

                    //Calcula a diferença em dias
                    if(!empty($data_pg_antiga)) {
                        $dias = floor($diferenca / (60 * 60 * 24));
                    }else{
                        $dias = 0 ;
                    }

                    if ($dias < 0) {
                        $palavra = "antecipada";
                    } else {
                        $palavra = "prolongada";
                    }

                    $transforma_em_potivo = abs($dias);

                    $msg_interacao_dt_prov = "<li>Campo <strong>Data Providência</strong> alterado de <em>{$data_prov_antiga}</em> para <em>{$data_prov_nova}</em> - {$palavra} em <b>{$transforma_em_potivo} dias</b></li>";

                    $sql = "INSERT INTO tbl_hd_chamado_item(
                            hd_chamado   ,
                            data         ,
                            comentario   ,
                            admin        ,
                            interno      ,
                            status_item
                        ) values (
                            $hd_chamado       ,
                            current_timestamp ,
                            E'$msg_interacao_dt_prov'       ,
                            $login_admin      ,
                            't',
                            $xstatus_interacao
                        ) RETURNING hd_chamado_item";                    

                    $res = pg_query($con,$sql);
                    if ($login_fabrica == 189 && verifica_origem_atendimento($_POST["origem"]) == "producao" && !pg_last_error()) {
                        $hd_chamado_item = pg_fetch_result($res, 0, 'hd_chamado_item');
                        grava_chamado_item_externo($hd_chamado, $hd_chamado_item);
                    }
				}else{

					if ($login_fabrica <> 189) {
						$sql = "UPDATE tbl_hd_chamado SET data_providencia = '{$data_prov_comp}' WHERE hd_chamado = {$hd_chamado}";
						$res = pg_query($con,$sql);
					}
				}
            }

        }
    }

    if ($login_fabrica == 156) {
        // Dados do responsável
        if ($_POST['responsavel_nome'] or $_POST['responsavel_fone']) {
            if ($array_campos_adicionais === "''")
                $array_campos_adicionais = array();
            if (!is_array($array_campos_adicionais)) {
                $array_campos_adicionais = json_decode($array_campos_adicionais, true);
            }
            if ($_POST['responsavel_nome']) $array_campos_adicionais['responsavel']     = $_POST['responsavel_nome'];
            if ($_POST['responsavel_fone']) $array_campos_adicionais['tel_responsavel'] = $_POST['responsavel_fone'];
            $array_campos_adicionais = json_encode($array_campos_adicionais);
        }

        if (!$msg_erro) {
            if ($data_providencia != "NULL") {
                pg_query($con,
                        "UPDATE tbl_hd_chamado
                        SET data_providencia = '$data_providencia'
                        WHERE hd_chamado = $hd_chamado"
                        );
                if (pg_last_error($con)) {
                    $msg_erro = "Erro ao gravar a data limite para resolução do atendimento.<Br />";
                }
            }

            if ($protocolo_cliente) {
                pg_query($con,
                        "UPDATE tbl_hd_chamado
                        SET protocolo_cliente = '$protocolo_cliente'
                        WHERE hd_chamado = $hd_chamado"
                        );
                if (pg_last_error($con)) {
                    $msg_erro .= " - Problemas ao gravar a data limite para resolução do atendimento.<br />";
                }
            }

            if ($fab_nova_filial && $filial_id != "NULL") {
                $tem = pg_query(
                        $con,
                        "SELECT * FROM tbl_hd_chamado_extra_filial WHERE hd_chamado = $hd_chamado AND filial = $filial_id"
                        );
                if (!pg_num_rows($tem)) {
                    pg_query(
                            $con,
                            $sqlif = "INSERT INTO tbl_hd_chamado_extra_filial (hd_chamado, filial) VALUES ($hd_chamado, $filial_id);"
                            );
                    if (pg_last_error($con))
                        $msg_erro .= "Houve um problema ao inserir a infromação da filial.<br />".$sqlif;
                }
            }
        }
    }

    if (in_array($login_fabrica, array(30,52,90,151,174)) AND strlen($_POST['hd_classificacao']) == 0) {
        $msg_erro .= "Ã necessário selecionar uma Classificação do atendimento. <br />";
    }

    if ($login_fabrica == 30 && strlen($_POST['hd_classificacao']) > 0) {
        $post_hd_classificacao = $_POST['hd_classificacao'];
        $sql_classificacao = "SELECT ativo FROM tbl_hd_classificacao WHERE hd_classificacao = $post_hd_classificacao AND ativo IS TRUE AND fabrica = $login_fabrica";
        $res_classificacao = pg_query($con, $sql_classificacao);

        if (pg_num_rows($res_classificacao) == 0) {
            $msg_erro .= 'A "Classificação de atendimento" selecionada está inativa, favor selecionar outra! <br />';
        }
    }

    if (strlen($callcenter) > 0) {
        if($login_fabrica == 30){

            if($hd_classificacao != 47){
                $orientacao_posto = "";
                $numero_processo  = "";
            }

            $sql = "UPDATE tbl_hd_chamado SET analise = '{$orientacao_posto}' WHERE hd_chamado = {$callcenter}";
            $res = pg_query($con, $sql);

            $sql = "UPDATE tbl_hd_chamado_extra SET numero_processo = '{$xnumero_processo}' WHERE hd_chamado = {$callcenter}";
            $res = pg_query($con, $sql);

            if ((isset($_POST['hd_motivo_ligacao']) && $_POST['hd_motivo_ligacao'] == 162) && !empty(trim($_POST['os_c_troca']))) {
                $xos = $xos_c_troca;
                $sql = "SELECT os FROM tbl_os WHERE os = {$xos_c_troca}";
                $res = pg_query($con, $sql);
                if (pg_num_rows($res) == 0) {
                    $msg_erro .= "Ordem de serviço não encontrada";
                }
            }
        }

        if($login_fabrica == 52){

            if(strlen($_POST['ponto_referencia']) == 0 && $hd_orientacao == false){
                $msg_erro .= "Informe o Ponto de Referência <br>";
            }
            if ($xresposta == "null") {
                $msg_erro .= "Por favor insira a resposta <br />";
            }

        }else{

            if ($xresposta == "null" AND !in_array($login_fabrica, array(74,174,183))) {
                $msg_erro .= "Por favor insira a resposta <br />";
            }

            if(in_array($login_fabrica, $fabricas_sms)){

                if(isset($_POST["enviar_por_sms"]) && strlen(trim($_POST["texto_sms_digitado"])) == 0){
                    $msg_erro .= "Por favor insira o texto para envio do SMS <br />";
                }

            }

        }

        if ($login_fabrica == 85) {

            if (isset($_POST['data_primeira_visita'])) {

                $aux_sql = "SELECT array_campos_adicionais FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter LIMIT 1";
                $aux_res = pg_query($con, $aux_sql);

                $aux_array_adicionais = pg_fetch_result($aux_res, 0, 'array_campos_adicionais');
                $aux_array_adicionais = json_decode($aux_array_adicionais, true);

                $data_primeira_visita = $_POST['data_primeira_visita'];

                $aux_array_adicionais["data_primeira_visita"] = $data_primeira_visita;

                $aux_sql = "UPDATE tbl_hd_chamado_extra SET array_campos_adicionais = '". json_encode($aux_array_adicionais) ."' WHERE hd_chamado = $callcenter";
                $aux_res = pg_query($con, $aux_sql);

                if (pg_last_error()) {
                    $msg_erro .= "Erro ao atualizar o valor do serviço do técnico esporádico";
                }
            }
        }

        /*HD - 4258409*/
        if ($login_fabrica == 85 && !empty($_POST["valor_servico_combinado"]) && !empty($callcenter) && empty($msg_erro)) {
            $aux_valor_servico         = $_POST["valor_servico_combinado"];
            $aux_tecnico_esporadico_id = $_POST["tecnico_esporadico_id"];

            if (!empty($aux_valor_servico)) {
                $aux_sql = "SELECT array_campos_adicionais FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter LIMIT 1";
                $aux_res = pg_query($con, $aux_sql);

                $aux_array_adicionais = pg_fetch_result($aux_res, 0, 'array_campos_adicionais');
                $aux_array_adicionais = json_decode($aux_array_adicionais, true);


                if (!empty($aux_array_adicionais["valor_servico_combinado"])) {
                    $aux_valor_servico = str_replace('R$ ', '', $aux_valor_servico);
                    $aux_valor_servico = str_replace(",", '.', $aux_valor_servico);

                    if ($aux_array_adicionais["valor_servico_combinado"] != $aux_valor_servico) {
                        $aux_array_adicionais["valor_servico_combinado"] = $aux_valor_servico;

                        $aux_sql = "UPDATE tbl_hd_chamado_extra SET array_campos_adicionais = '". json_encode($aux_array_adicionais) ."' WHERE hd_chamado = $callcenter";
                        $aux_res = pg_query($con, $aux_sql);

                        if (pg_last_error()) {
                            $msg_erro .= "Erro ao atualizar o valor do serviço do técnico esporádico";
                        }
                    }
                } else {
                    $aux_array_adicionais["tecnico_esporadico_id"]   = $aux_tecnico_esporadico_id;
                    $aux_array_adicionais["valor_servico_combinado"] = $aux_valor_servico;

                    $aux_sql = "UPDATE tbl_hd_chamado_extra SET array_campos_adicionais = '". json_encode($aux_array_adicionais) ."' WHERE hd_chamado = $callcenter";
                    $aux_res = pg_query($con, $aux_sql);

                    if (pg_last_error()) {
                        $msg_erro .= "Erro ao atualizar o valor do serviço do técnico esporádico";
                    }
                }
            }

        }

        if ($login_fabrica == 171 AND !empty($tipo_atendimento_grohe)){
            $update_grohe = "UPDATE tbl_hd_chamado_extra set tipo_atendimento = {$tipo_atendimento_grohe} WHERE hd_chamado = {$callcenter}";
            $res_update_grohe = pg_query($con, $update_grohe);
        }

        if (strlen(trim($consumidor_cidade)) > 0 AND strlen(trim($consumidor_estado)) > 0){
            $sql = "SELECT cidade FROM tbl_cidade WHERE UPPER(fn_retira_especiais(nome)) = UPPER(fn_retira_especiais('{$consumidor_cidade}')) AND UPPER(estado) = UPPER('{$consumidor_estado}')";
            $res = pg_query($con, $sql);

            if (pg_num_rows($res) > 0) {
                $cidade = pg_fetch_result($res, 0, "cidade");
            } else {
                $sql = "SELECT cidade, estado FROM tbl_ibge WHERE UPPER(fn_retira_especiais(cidade)) = UPPER(fn_retira_especiais('{$consumidor_cidade}')) AND UPPER(estado) = UPPER('{$consumidor_estado}')";
                $res = pg_query($con, $sql);

                if(!in_array($login_fabrica, array(161,162,164,167,203))){
                    if (pg_num_rows($res) > 0) {
                        $cidade_ibge        = pg_fetch_result($res, 0, "cidade");
                        $cidade_estado_ibge = pg_fetch_result($res, 0, "estado");

                        $sql = "INSERT INTO tbl_cidade (
                            nome, estado
                            ) VALUES (
                                '{$cidade_ibge}', '{$cidade_estado_ibge}'
                                ) RETURNING cidade";
                        $res = pg_query($con, $sql);

                        $cidade = pg_fetch_result($res, 0, "cidade");
                    } else {
                        if($login_fabrica == 125 and $consumidor_revenda == "C"){
                            $msg_erro .= "Cidade do consumidor não encontrada <br>";
                        }elseif($login_fabrica != 125){
                            if($login_fabrica == 52){
                                if($consumidor_pais == 'BR' or empty($consumidor_pais)) {
                                    $msg_erro .= "Cidade do consumidor não encontrada";
                                }
                            }else{
                                $msg_erro .= "Cidade do consumidor não encontrada <br>";
                            }
                        }

                    }
                }

            }
        }
		if($login_fabrica == 161 and $consumidor_pais !='BR' and strlen($consumidor_cidade > 0)) {
			$cidade = $consumidor_cidade;
		}

        if (strlen($msg_erro) == 0) {
            $res = pg_query ($con,"BEGIN TRANSACTION");

            if(in_array($login_fabrica, [30, 141])){
                $obs_sac_adicionais = filter_input(INPUT_POST,"obs_sac_adicionais");
                $obs_sac_adicionais = str_replace("\r\n", "<br>", $obs_sac_adicionais);
                if ($login_fabrica == 30) {
                    $msg_erro .= empty($obs_sac_adicionais) ? "Você deve preencher o campo Observação SAC" : "";

                    $os_revenda = $_POST["os_revenda"];
                    $orientacao_posto = $_POST["orientacao_posto"];

                    if($hd_classificacao == 47 && strlen($os_revenda) == 0){
                        $msg_erro .= "Por favor insira a OS Revenda<br>";
                    } else if ($hd_classificacao == 47 && empty($cliente_admin)) {
                        # $msg_erro .= "Para o Backoffice Casas Bahia, favor cadastrar no campo Atendimento Centralizado VIA VAREJO S/A";
                    }
                    $xnumero_processo = $os_revenda;

                    if (empty($xnumero_processo)) {
                        $xnumero_processo = "null";
                    }
                }

                if(empty($msg_erro) AND ( (trim($_POST['obs_sac_adicionais']) != trim($_POST['obs_sac_adicionais_anterior'])) AND ($xresposta != "null")) || (empty($msg_erro) && in_array($login_fabrica, array(141)))){

                    if($login_fabrica != 30){
                        $obs_sac_adicionais = "<b>Observação SAC: </b><br />$obs_sac_adicionais";
                    }else{
                        $hd_motivo_ligacao_ant = $_POST["hd_motivo_ligacao_ant"];
                        //deixa a data providencia na interação
                        if(strlen($hd_motivo_ligacao) > 0 && $hd_motivo_ligacao != "NULL" && $hd_motivo_ligacao != $hd_motivo_ligacao_ant ){

                            $sql = "select fn_calcula_previsao_retorno(current_date,prazo_dias,$login_fabrica)::date AS data_providencia from tbl_hd_motivo_ligacao where hd_motivo_ligacao = {$hd_motivo_ligacao}";
                            $resP = pg_query($con,$sql);
                            $data_providencia = pg_fetch_result($resP, 0, 'data_providencia');
                            $campos_termino = "termino, ";
                            $valor_termino = "'$data_providencia', ";
                        }
                    }

                    $sql = "INSERT INTO tbl_hd_chamado_item(
                            hd_chamado   ,
                            data         ,
                            comentario   ,
                            admin        ,
                            interno      ,
                            status_item,
                            $campos_termino
                            empregado
                        ) values (
                            $hd_chamado ,
                            current_timestamp ,
                            E'$obs_sac_adicionais',
                            $login_admin,
                            'f',
                            $xstatus_interacao,
                            $valor_termino
                            1
                        ) RETURNING hd_chamado_item";


                    $res = pg_query($con,$sql);
                    if ($login_fabrica == 189 && verifica_origem_atendimento($_POST["origem"]) == "producao" && !pg_last_error()) {
                        $hd_chamado_item = pg_fetch_result($res, 0, 'hd_chamado_item');
                        grava_chamado_item_externo($hd_chamado, $hd_chamado_item);
                    }
                }
            }

            if($login_fabrica == 30){

                if($hd_classificacao != 47){
                    $orientacao_posto = "";
                    $numero_processo  = "";
                }

                $sql = "UPDATE tbl_hd_chamado SET analise = '{$orientacao_posto}' WHERE hd_chamado = {$callcenter}";
                $res = pg_query($con, $sql);

                $sql = "UPDATE tbl_hd_chamado_extra SET numero_processo = '{$xnumero_processo}' WHERE hd_chamado = {$callcenter}";
                $res = pg_query($con, $sql);

            }

            if(!$moduloProvidencia){

                $data_prov = $_POST["data_prov"] ;
                if (strlen($data_prov) == 0){
                    $data_prov = "NULL";
                }else{
                    list($ddf, $mdf, $ydf) = explode("/", $data_prov);
                    if(!checkdate($mdf,$ddf,$ydf)) {
                        $msg_erro = "Data providência Inválida";
                    }else{
                        $dataexplode = explode('/', $data_prov);
                        $data_aprov_timestamp = strtotime($dataexplode[2]."-".$dataexplode[1]."-".$dataexplode[0]);
                        $data_hoje_timestamp = strtotime(date('y-m-d',time()));

                        $xdata_prov = "'".$ydf.'-'.$mdf.'-'.$ddf."'";

                        $sql = "UPDATE tbl_hd_chamado set data_providencia = $xdata_prov
                            WHERE tbl_hd_chamado.fabrica_responsavel = $login_fabrica
                            AND tbl_hd_chamado.hd_chamado = $callcenter ";

                        $res = pg_query($con,$sql);
                        $msg_erro .= pg_errormessage($con);
                    }
                }
            }

            if(in_array($login_fabrica, array(169,170)) AND strlen(trim($tab_atual)) > 0){
                $valida_categoria_anterior = $_POST['categoria_anterior'];
                $valida_categoria_atual = $tab_atual;

                if($valida_categoria_anterior != $valida_categoria_atual){
                    $sql_nat = "SELECT nome, descricao FROM tbl_natureza WHERE fabrica = {$login_fabrica}";
                    $res_nat = pg_query($con, $sql_nat);
                    $result_nat = pg_fetch_all($res_nat);

                    foreach ($result_nat as $key => $value) {
                        if($valida_categoria_anterior == $value['nome']){
                            $valida_categoria_anterior = $value['descricao'];
                        }
                        if($valida_categoria_atual == $value['nome']){
                            $valida_categoria_atual = $value['descricao'];
                        }
                    }

                    $msg_tabs = "Categoria alterada de <b>$valida_categoria_anterior</b> para <b>$valida_categoria_atual</b>";

                    $sql = "INSERT INTO tbl_hd_chamado_item(
                        hd_chamado   ,
                        data         ,
                        comentario   ,
                        admin        ,
                        interno      ,
                        status_item
                    ) values (
                        $hd_chamado       ,
                        current_timestamp ,
                        E'$msg_tabs'       ,
                        $login_admin      ,
                        't',
                        $xstatus_interacao
                    )";
                    $res = pg_query($con, $sql);
                }
            }

            $sql = "SELECT atendente,login
                from tbl_hd_chamado
                JOIN tbl_admin ON tbl_admin.admin = tbl_hd_chamado.atendente
                where fabrica_responsavel= $login_fabrica
                and hd_chamado = $callcenter";

            $res = pg_query($con,$sql);

            if (pg_num_rows($res) > 0) {
                $ultimo_atendente       = pg_fetch_result($res,0,'atendente');
                $ultimo_atendente_login = pg_fetch_result($res,0,'login');
            }

            // ! Gravar alteraçÃµes de dados
            // HD 122446 (augusto) - Criar interação quando o endereço do cliente for modificado (Lenoxx)
            // HD 124579 (augusto) - Implementar isso em outros campos que podem ser modificados para todas as fábricas
            $msg_interacao = '';

            if ((($login_fabrica == 11 or $login_fabrica == 172) && $xstatus_interacao == "'Aberto'" ) || ($login_fabrica != 11)) {
                unset($array_campos_consumidor_verificar);
                unset($array_consumidor_label);
                $array_campos_consumidor_verificar                = array(
                    'cliente_nome_admin',     'consumidor_bairro',  'consumidor_cep',   'consumidor_cidade',
                    'consumidor_complemento', 'consumidor_cpf',     'consumidor_email', 'consumidor_endereco',
                    'consumidor_estado',      'consumidor_fone',    'consumidor_fone2', 'consumidor_fone3',
                    'consumidor_nome',        'consumidor_numero',  'consumidor_rg',    'data_nf',
                    'marca',                  'nota_fiscal',        'ponto_referencia', 'posto_km_tab',
                    'produto_nome',           'produto_referencia', 'serie',            'voltagem',
                    'obs_sac_adicionais'
                );

                if ($login_fabrica == 24) {
                    $array_campos_consumidor_verificar = array(
                        'cliente_nome_admin',     'consumidor_bairro',  'consumidor_cep',   'consumidor_cidade',
                        'consumidor_complemento', 'consumidor_cpf',     'consumidor_email', 'consumidor_endereco',
                        'consumidor_estado',      'consumidor_fone',    'consumidor_fone2', 'consumidor_fone3',
                        'consumidor_nome',        'consumidor_numero',  'consumidor_rg',    'data_nf',
                        'marca',                  'nota_fiscal',        'ponto_referencia', 'posto_km_tab',
                        'produto_nome',           'produto_referencia', 'serie',            'voltagem',
                        'obs_sac_adicionais',     'callcenter_assunto'
                    );
                }

                $array_consumidor_label                           = array_flip($array_campos_consumidor_verificar);
                $array_consumidor_label['consumidor_nome']        = 'Nome';
                $array_consumidor_label['consumidor_cpf']         = 'CPF';
                $array_consumidor_label['consumidor_rg']          = 'RG';
                $array_consumidor_label['consumidor_email']       = 'E-mail';
                $array_consumidor_label['consumidor_fone']        = 'Telefone';
                $array_consumidor_label['consumidor_fone2']       = 'Telefone Comercial';
                $array_consumidor_label['consumidor_fone3']       = 'Telefone Celular';
                $array_consumidor_label['consumidor_cep']         = 'CEP';
                $array_consumidor_label['consumidor_endereco']    = 'Endereço';
                $array_consumidor_label['consumidor_numero']      = 'número';
                $array_consumidor_label['consumidor_complemento'] = 'Complem.';
                $array_consumidor_label['ponto_referencia']       = 'Ponto de Referência';
                $array_consumidor_label['consumidor_bairro']      = 'Bairro';
                $array_consumidor_label['consumidor_cidade']      = 'Cidade';
                $array_consumidor_label['consumidor_estado']      = 'Estado';
                $array_consumidor_label['produto_referencia']     = 'Referência (do Produto)';
                $array_consumidor_label['produto_nome']           = 'Descrição (do Produto)';
                $array_consumidor_label['voltagem']               = 'Voltagem';
                $array_consumidor_label['serie']                  = 'Série';
                $array_consumidor_label['nota_fiscal']            = 'NF Compra';
                $array_consumidor_label['data_nf']                = 'Data NF';
                $array_consumidor_label['marca']                  = 'Marca';
                $array_consumidor_label['posto_km_tab']           = 'Qtde de KM';
                $array_consumidor_label['cliente_nome_admin']     = 'Cliente Fricon';
                $array_consumidor_label['obs_sac_adicionais']     = 'Observação do SAC';
                if ($login_fabrica == 24) {
                     $array_consumidor_label['callcenter_assunto']     = 'Assunto';
                     $xxassunto = 'tbl_hd_chamado.categoria AS callcenter_assunto ,';
                 }

                $sqlBuscaAntigo = "
                    SELECT  tbl_hd_chamado_extra.nome                           AS consumidor_nome          ,
                            tbl_hd_chamado_extra.cpf                            AS consumidor_cpf           ,
                            tbl_hd_chamado_extra.rg                             AS consumidor_rg            ,
                            tbl_hd_chamado_extra.email                          AS consumidor_email         ,
                            tbl_hd_chamado_extra.fone                           AS consumidor_fone          ,
                            tbl_hd_chamado_extra.fone2                          AS consumidor_fone2         ,
                            tbl_hd_chamado_extra.celular                        AS consumidor_fone3         ,
                            tbl_hd_chamado_extra.cep                            AS consumidor_cep           ,
                            tbl_hd_chamado_extra.endereco                       AS consumidor_endereco      ,
                            tbl_hd_chamado_extra.numero                         AS consumidor_numero        ,
                            tbl_hd_chamado_extra.complemento                    AS consumidor_complemento   ,
                            tbl_hd_chamado_extra.bairro                         AS consumidor_bairro        ,
                            tbl_hd_chamado_extra.posto_nome                     AS ponto_referencia         ,
                            tbl_hd_chamado_extra.serie                          AS serie                    ,
                            tbl_hd_chamado_extra.nota_fiscal                    AS nota_fiscal              ,
                            tbl_hd_chamado_extra.array_campos_adicionais                                    ,
                            TO_CHAR(tbl_hd_chamado_extra.data_nf,'DD/MM/YYYY')  AS data_nf                  ,
                            tbl_hd_chamado_extra.marca                          AS marca                    ,
                            tbl_hd_chamado_extra.qtde_km                        AS posto_km_tab             ,
                            tbl_cidade.nome                                     AS consumidor_cidade        ,
                            tbl_cidade.estado                                   AS consumidor_estado        ,
                            tbl_produto.referencia                              AS produto_referencia       ,
                            $xxassunto
                            tbl_produto.descricao                               AS produto_nome             ,
                            tbl_produto.voltagem                                AS voltagem                 ,
                            tbl_cliente_admin.nome                              AS nome_cliente_admin
                                FROM    tbl_hd_chamado
                                JOIN    tbl_hd_chamado_extra    USING(hd_chamado)
                                LEFT JOIN    tbl_cidade              USING(cidade)
                                LEFT JOIN    tbl_produto             USING(produto)
                                LEFT JOIN    tbl_cliente_admin       USING(cliente_admin)
                                WHERE   tbl_hd_chamado.hd_chamado           = $callcenter
                                AND     tbl_hd_chamado.fabrica_responsavel  = $login_fabrica
                                ";
                $resBuscaAntigo = pg_query($con,$sqlBuscaAntigo);
                $valoresAntigos = pg_fetch_all($resBuscaAntigo);
                unset($interacao_campos_consumidor_msgs);
                $interacao_campos_consumidor_msgs                   = array();

                $valoresAntigos[0]['array_campos_adicionais'] = json_decode($valoresAntigos[0]['array_campos_adicionais'], true);
                $valoresAntigos[0]['obs_sac_adicionais'] = utf8_decode($valoresAntigos[0]['array_campos_adicionais']['observacao_sac']);

                foreach ($array_campos_consumidor_verificar as $campo_consumidor) {
                    // $valor_anterior = $campo_consumidor.'_anterior';
                    if ($login_fabrica == 24 && $campo_consumidor == 'callcenter_assunto') {
                        $tbl_atual = $_POST['tab_atual'];
                        $assunto_novo   = $_POST['callcenter_assunto'][$tbl_atual];
                        $assunto_antigo = $valoresAntigos[0]['callcenter_assunto'];
                    } elseif ( ! isset($_POST[$campo_consumidor]) ) {
                        continue;
                    }

                    //  30/12/2009 MLG HD 188091 - "Null" e "nada" deveriam ser a mesma coisa...
                    // if (empty($_POST[$valor_anterior]) and $$campo_consumidor == "null")
                    //if (empty($valoresAntigos[0][$campo_consumidor]) && $$campo_consumidor == "null")
                    if (empty($valoresAntigos[0][$campo_consumidor])) { //hd_chamado=2770010
                        continue;
                    }
                    //  22/01/2010 MLG HD 198090 - O campo CPF é re-formatado, mas isso significa que volta a ser alterado.
                    $replaceArgs = array('.','-',' ','/');
                    $valor_atual    = $$campo_consumidor;

                    // if ($campo_consumidor=="consumidor_cpf") $valor_atual = preg_replace("/\D/","",$valor_atual);
                    // if ($campo_consumidor=="consumidor_cpf"){
                    if (in_array($campo_consumidor,array("consumidor_cpf","consumidor_fone","consumidor_fone2","consumidor_fone3")) && $login_fabrica != 85){

                        $valor_atual = str_replace($replaceArgs, '', $valor_atual);
                        //$_POST[$campo_consumidor] = str_replace($replaceArgs, '', $$valor_anterior);
                        //$valor_atual = filter_var($$campo_consumidor,FILTER_SANITIZE_NUMBER_INT);
                    }

                    $campo_anterior = ($login_fabrica != 85) ? strtoupper(retira_acentos(retira_especiais($valoresAntigos[0][$campo_consumidor]))) : strtoupper(retira_acentos(retira_especiais($_POST[$campo_consumidor."_anterior"])));
                    if (in_array($login_fabrica, array(169,170)) && $campo_consumidor == 'produto_nome') {
                        $valor_atual = strtoupper($valor_atual);
                        $campo_anterior = strtoupper(retira_acentos(retira_especiais($valoresAntigos[0]['produto_referencia']))).' - '.$campo_anterior;
                        $campo_anterior = strtoupper(retira_acentos(retira_especiais($campo_anterior)));
                    }
                    // if (strtoupper(retira_acentos($_POST[$valor_anterior])) != strtoupper(retira_acentos($valor_atual))) {
                    if ($login_fabrica == 24 && $campo_consumidor == 'callcenter_assunto') {
                        $valor_atual = $assunto_novo;
                    }

                    if (trim($campo_anterior) != trim(strtoupper(retira_acentos(retira_especiais($valor_atual))))) {

                        $msg_valor_anterior = (empty($valoresAntigos[0][$campo_consumidor])) ? 'Em branco' : $valoresAntigos[0][$campo_consumidor];
                        if ($campo_consumidor == "marca" AND $login_fabrica == 52 ) {

                            if ($msg_valor_anterior != 'Em branco' OR $valor_atual != 'NULL'  ) {
                                $sql_marca = "SELECT nome from tbl_marca where marca = $msg_valor_anterior and fabrica = $login_fabrica";
                                $res_marca = pg_query($con,$sql_marca);
                                $marca_logo_ant = pg_fetch_result($res_marca, 0, nome);
                                //echo $sql_marca;
                                $sql_marca = "SELECT nome from tbl_marca where marca = $valor_atual and fabrica = $login_fabrica";
                                $res_marca = pg_query($con,$sql_marca);
                                //echo $sql_marca;exit;
                                $marca_logo_at = pg_fetch_result($res_marca, 0, nome);

                                $sql_up = "UPDATE tbl_os set marca = $valor_atual where hd_chamado = $hd_chamado";
                                //echo $sql;exit;
                                $res_up = pg_query($con,$sql_up);

                                $msg_alteracao      = "<li>Campo <strong>{$array_consumidor_label[$campo_consumidor]}</strong> alterado de '<em>{$marca_logo_ant}</em>' para '<em>{$marca_logo_at}</em>'</li>";

                            }

                        }else{
                            if ($login_fabrica == 24 && $campo_consumidor == 'callcenter_assunto') {
                                switch ($tbl_atual) {

                                        case "reclamacao_produto":
                                            $xnatureza = "PRODUTOS";
                                            break;

                                        case "reclamacao_empresa":
                                            $xnatureza = "EMPRESA";
                                            break;

                                        case "reclamacao_at":
                                            $xnatureza = "ASSISTÃNCIA TÃCNICA";
                                            break;

                                        case "duvida_produto":
                                            $xnatureza = "REVENDA";
                                            break;

                                        case "sugestao":
                                            $xnatureza = "sugestao";
                                            break;

                                        case "procon":
                                            $xnatureza = "PROCON";
                                            break;

                                        case "onde_comprar":
                                            $xnatureza = "REVENDA";
                                            break;

                                        case "outros_assuntos":
                                            $xnatureza = "OUTROS ASSUNTOS";
                                            break;

                                    }

                                if ($assunto_novo != $assunto_antigo) {
                                    foreach ($assuntos[$xnatureza] AS $label => $valor) {
                                        if ($assunto_antigo == $valor) {
                                            $msg_valor_anterior = $label;
                                        }
                                        if ($assunto_novo == $valor) {
                                            $$xcampo_consumidor = $label;
                                        }
                                    }
                                } else {
                                    continue;
                                }

                                $msg_alteracao      = "<li>Campo <strong>{$array_consumidor_label[$campo_consumidor]}</strong> alterado de '<em>{$msg_valor_anterior}</em>' para '<em>{$$xcampo_consumidor}</em>'</li>";
                            } else {
                                $msg_alteracao      = "<li>Campo <strong>{$array_consumidor_label[$campo_consumidor]}</strong> alterado de '<em>{$msg_valor_anterior}</em>' para '<em>{$$campo_consumidor}</em>'</li>";
                            }
                        }

                        if (count($msg_alteracao) > 0) {
                            $interacao_campos_consumidor_msgs[] = $msg_alteracao;
                        }else{
                            $interacao_campos_consumidor_msgs = NULL;
                        }
                    }
                }

                if($login_fabrica == 136){

                    $gerar_pedido_posto_interno = $_POST["gerar_pedido_posto_interno"];
                    if($gerar_pedido_posto_interno == "t"){
                        $xstatus_interacao = "'Peças Pendentes'";
                    }else{
                        $xstatus_interacao = "'".$_POST["status_interacao"]."'";
                    }

                }

                if (count($interacao_campos_consumidor_msgs) > 0) {
                    $msg_interacao  = "<p>As seguintes informações do chamado foram alteradas nesta interação:</p><p>&nbsp;</p>";
                    $msg_interacao .= "<ul>".implode('',$interacao_campos_consumidor_msgs)."</ul>";
                    $msg_interacao = addslashes($msg_interacao);
                    $sql = "INSERT INTO tbl_hd_chamado_item(
                        hd_chamado   ,
                        data         ,
                        comentario   ,
                        admin        ,
                        interno      ,
                        status_item
                    ) values (
                        $hd_chamado       ,
                        current_timestamp ,
                        E'$msg_interacao'       ,
                        $login_admin      ,
                        't',
                        $xstatus_interacao
                    ) RETURNING hd_chamado_item";

                    $res = pg_query($con, $sql);
                    if ($login_fabrica == 189 && verifica_origem_atendimento($_POST["origem"]) == "producao" && strlen($msg_erro) == 0) {
                        $hd_chamado_item = pg_fetch_result($res, 0, 'hd_chamado_item');
                        grava_chamado_item_externo($hd_chamado, $hd_chamado_item);
                    }
                }
                unset($array_campos_consumidor_verificar,$interacao_campos_consumidor_msgs,$msg_alteracao,$valor_anterior,$campo_consumidor,$sql,$res,$msg_interacao);
            }
            // fim HD 122446
            # HD 45756
            if ($login_fabrica == 3) {

                if ($ultimo_atendente <> $login_admin) {
                    $msg_erro = "Sem permissão de alteração. Admin responsável: $ultimo_atendente_login";
                }

            }

            if (isset($_POST['tipo_consumidor']) && !empty($hd_chamado)) { // HD 317864

                $sql = "UPDATE tbl_hd_chamado_extra SET tipo_consumidor = '" . $_POST['tipo_consumidor'] . "' WHERE hd_chamado = $hd_chamado";
                $res = pg_query($con, $sql);

            } else if (in_array($login_fabrica, $fab_usa_tipo_cons) ) {

                $msg_erro = "Selecione o Tipo do Consumidor";

            }

            $_xresposta = pg_escape_string("{$resposta}<p>&nbsp;</p> {$msg_interacao}");
            if ($login_fabrica == 74 && strlen($msg_interacao) == 0 && strlen($resposta) == 0 && strtoupper($xstatus_interacao) == "'RESOLVIDO'") {
                $sql = "INSERT INTO tbl_hd_chamado_item(
                    hd_chamado   ,
                    data         ,
                    comentario   ,
                    admin        ,
                    interno      ,
                    status_item  ,
                    enviar_email
                ) values (
                    $callcenter        ,
                    current_timestamp  ,
                    'Atendimento resolvido'     ,
                    $login_admin       ,
                    $xchamado_interno  ,
                    $xstatus_interacao ,
                    $xenvia_email
                )";

                $res = pg_query($con,$sql);
            }

            if(!($login_fabrica == 74 && strlen($msg_interacao) == 0 && strlen($resposta) == 0)){

                if (($login_fabrica == 15) AND (strlen($xdata_retorno) > 0 )) {
                    $sql = "INSERT INTO tbl_hd_chamado_item(
                        hd_chamado   ,
                        data         ,
                        comentario   ,
                        admin        ,
                        interno      ,
                        status_item  ,
                        enviar_email
                    ) values (
                        $callcenter        ,
                        current_timestamp  ,
                        E'$_xresposta Data para retorno : $xdata_retorno'      ,
                        $login_admin       ,
                        $xchamado_interno  ,
                        $xstatus_interacao ,
                        $xenvia_email
                    )";
                    $res = pg_query($con,$sql);
                    $msg_erro .= pg_errormessage($con);
                }else{
                    if ($login_fabrica == 115 OR $login_fabrica == 116) {

                        ##hd_chamado=2770071##
                        $data_retorno_antiga = $_POST["data_retorno_antiga"];
                        $data_antiga_explode = explode('/', $data_retorno_antiga);
                        $data_de_retorno_antiga_timestamp = strtotime($data_antiga_explode[2]."-".$data_antiga_explode[1]."-".$data_antiga_explode[0]);
                        ## fim hd_chamado=2770071 ##
                        $data_de_retorno = $_POST["data_de_retorno"] ;

                        if (strlen($data_de_retorno) == 0){
                            $data_de_retorno = "NULL";
                        }elseif($xstatus_interacao <> "'Resolvido'") {
                            list($ddf, $mdf, $ydf) = explode("/", $data_de_retorno);
                            if(!checkdate($mdf,$ddf,$ydf)) {
                                $msg_erro = "Data de Retorno Inválida";
                            }else{
                                $dataexplode = explode('/', $data_de_retorno);
                                $data_de_retorno_timestamp = strtotime($dataexplode[2]."-".$dataexplode[1]."-".$dataexplode[0]);
                                $data_hoje_timestamp = strtotime(date('y-m-d',time()));

                                if(strlen(trim($data_de_retorno_antiga_timestamp) == "") AND $data_de_retorno_timestamp < $data_hoje_timestamp){ //hd_chamado=2770071
                                    $msg_erro = "A Data de Retorno não pode ser inferior ao dia ".date("d-m-Y",time());
                                }elseif($data_de_retorno_antiga_timestamp <> $data_de_retorno_timestamp AND $data_de_retorno_timestamp < $data_hoje_timestamp){ //hd_chamado=2770071
                                    $msg_erro = "A Data de Retorno não pode ser inferior ao dia ".date("d-m-Y",time());
                                }else{
                                    $xdata_de_retorno = "'".$ydf.'-'.$mdf.'-'.$ddf."'";

                                    $sql = "SELECT  to_char(tbl_hd_chamado.data_providencia,'YYYY-MM-DD') as data_providencia
                                        FROM tbl_hd_chamado
                                        WHERE tbl_hd_chamado.fabrica_responsavel = $login_fabrica
                                        AND tbl_hd_chamado.hd_chamado = $callcenter;";
                                    $res = pg_query($con, $sql);
                                    //echo nl2br($sql);

                                    if (pg_num_rows($res) > 0) {
                                        $data_de_retorno_atual = pg_fetch_result($res, 0, data_providencia);
                                        $xdata_de_retorno_sql = str_replace("'", "", $xdata_de_retorno);
                                        if($xdata_de_retorno_sql != $data_de_retorno_atual){
                                            $sql = "UPDATE tbl_hd_chamado set data_providencia = $xdata_de_retorno, esta_agendado = 't'
                                                WHERE tbl_hd_chamado.fabrica_responsavel = $login_fabrica
                                                AND tbl_hd_chamado.hd_chamado = $callcenter";

                                            $res = pg_query($con,$sql);
                                            $msg_erro .= pg_errormessage($con);
                                        }else{
                                            $sql_ag = "UPDATE tbl_hd_chamado set esta_agendado = 'f'
                                                WHERE tbl_hd_chamado.fabrica_responsavel = $login_fabrica
                                                AND tbl_hd_chamado.hd_chamado = $callcenter ";

                                            $res_ag = pg_query($con,$sql_ag);
                                            $msg_erro .= pg_errormessage($con);
                                        }
                                    }
                                }
                            }
                        }
                    }

                    if($login_fabrica == 24){
                        $tincaso = " tincaso, ";
                        $value_tincaso = " '$callcenter' , ";

                    }

                    if(strlen(trim($hd_motivo_ligacao)) > 0){
                        $xhd_motivo_ligacao = $hd_motivo_ligacao;
                    }else{
                        $xhd_motivo_ligacao = "null";
                    }

                    if(in_array($login_fabrica, array(169,170))){
                        if(strlen(trim($hd_motivo_ligacao)) > 0){
                            $campo_insert = ", hd_motivo_ligacao ";
                            $campo_value  = ", $hd_motivo_ligacao";
                        }
                    }
                    if ($login_fabrica == 80 && $abre_os == 't') {
                        $aux_abre_os = $_POST['aux_abre_os'];

                        if ($aux_abre_os == 'f') {
                            $_xresposta .= "<br>Foi disponibilizado para o posto a Pré-Ordem de Serviço.";
                        }
                    }

                    if ($login_fabrica == 151) {
                        
                        $motivoLigacao = ',' . $_POST['hd_motivo_ligacao'];
                        $textoMotivo   = ',hd_motivo_ligacao';
                    }
                    
                    $sql = "INSERT INTO tbl_hd_chamado_item(
                        hd_chamado   ,
                        data         ,
                        comentario   ,
                        admin        ,
                        interno      ,
                        status_item  ,
                        $tincaso
                        enviar_email
                        $textoMotivo
                        $campo_insert
                    ) values (
                        $callcenter        ,
                        current_timestamp  ,
                        E'$_xresposta'      ,
                        $login_admin       ,
                        $xchamado_interno  ,
                        $xstatus_interacao ,
                        $value_tincaso
                        $xenvia_email 
                        $motivoLigacao
                        $campo_value
                    ) RETURNING hd_chamado_item";

                    $res = pg_query($con,$sql);
                    
                    $newHdChamadoItemId = pg_fetch_result($res, 0, 'hd_chamado_item');
                    if ($login_fabrica == 189 && verifica_origem_atendimento($_POST["origem"]) == "producao" && !pg_last_error()) {
                       // $hd_chamado_item = pg_fetch_result($res, 0, 'hd_chamado_item');
                        grava_chamado_item_externo($callcenter, $newHdChamadoItemId);

                    }
                    $chamado = buscaChamado($callcenter);
                    // verifica se admin tem email cadastrado. hd_chamado=2738892

                    $sqlVemail = "SELECT admin FROM tbl_hd_chamado WHERE hd_chamado = $callcenter AND fabrica_responsavel = $login_fabrica";
                    $resVemail = pg_query($con, $sqlVemail);

                    if(pg_last_error($con) > 0){
                        $msg_erro.="Admin não encontrado";
                    }

                    if(pg_num_rows($resVemail) > 0){
                        $idAdmin = pg_fetch_result($resVemail, 0, 'admin');
                    }                   

                    if(!empty($idAdmin)) {
                        $sqlTemail = "SELECT email, nome_completo FROM tbl_admin WHERE admin = $idAdmin AND fabrica = $login_fabrica";
                        $resTemail = pg_query($con, $sqlTemail);

                        if(pg_last_error($con) > 0){
                            $msg_erro.="Admin sem email cadastrado";
                        }

                        if(pg_num_rows($resTemail) > 0){
                            $emailAdmin = pg_fetch_result($resTemail, 0, 'email');
                            $adminNomeCompleto = pg_fetch_result($resTemail, 0, 'nome_completo');

                            if(strlen(trim($emailAdmin)) == ""){
                                $msg_erro.="Admin: $adminNomeCompleto sem email cadastrado";
                            }
                        }
                    }

                    // fim verifica admin email
                    if((in_array($login_fabrica,array(81,155,114,122,123,125,128,136))  or $telecontrol_distrib)  && $chamado['admin'] != $login_admin AND strlen($msg_erro) == 0 and !$controle_distrib_telecontrol){
                        $mail = montaEmail($chamado,$login_admin,$_xresposta);

                        try {
                            enviaEmail($mail);
                        } catch (Exception $e) {
                            $msg_erro .= $e->getMessage();
                        }
                    }

                    $msg_erro .= pg_errormessage($con);
                }

                if ($login_fabrica == 1 and $xchamado_interno <> "'t'") {

                    $sql = "Select email from tbl_admin where admin = $login_admin and fabrica = $login_fabrica";
                    $res = pg_query($con,$sql);
                    $msg_erro .= pg_errormessage($con);

                    if (pg_num_rows($res) > 0) {
                        $admin_email = pg_fetch_result($res, 0, 'email');
                    }

                    $sql = "SELECT email from tbl_hd_chamado_extra where hd_chamado = $hd_chamado";
                    $res = pg_query($con, $sql);

                    if (@pg_num_rows($res)  > 0 and strlen(pg_fetch_result($res,0,email)) > 0) {

                        $email_posto = strtolower(pg_fetch_result($res, 0, 'email'));
                        $subject  = "Help-Desk $hd_chamado respondido pelo fabricante";
                        $message  = "<b>Prezado Posto</b><br><br>";
                        $message .= "<b> O Help-Desk $hd_chamado foi respondido pelo fabrincate.<br><br>";
                        $message .= "<b> Atenciosamente<br><br>";

                        // $email_posto = "guilherme.silva@telecontrol.com.br";

                        $mailTc->setEmailSubject($subject);
                        $mailTc->addToEmailBody($message);
                        $mailTc->setEmailFrom($externalEmail);
                        $mailTc->addEmailDest($email_posto);

                        $resultado = $mailTc->sendMail();

                    }

                }

                /*
                * ADICIONADO UMA NOVA CONDIÃÃO PARA 198 (FRIGELAR), ENVIA E-MAIL PRO CONSUMIDOR MESMO SE N TIVER HD ABERTO 
                */
                if(((in_array($login_fabrica, array(169,170)) || (in_array($login_fabrica, [166,174,186,189]) && !empty($_POST['enviar_email']) )) && $xchamado_interno == "'f'" && strlen(trim($consumidor_email)) > 0 && $hd_chamado > 0) || in_array($login_fabrica, [198]) && strlen(trim($consumidor_email)) > 0 && $xchamado_interno == "'f'"){

                    if ($origem_nome == "fale conosco"){
                        $sql_email_faleconosco = "
                            SELECT tbl_admin.email
                            FROM tbl_hd_chamado
                            JOIN tbl_admin ON tbl_admin.admin = tbl_hd_chamado.admin AND tbl_admin.fabrica = {$login_fabrica}
                            WHERE tbl_hd_chamado.hd_chamado = {$hd_chamado}
                            AND tbl_hd_chamado.fabrica = {$login_fabrica} ";
                        $res_email_faleconosco = pg_query($con, $sql_email_faleconosco);

                        $email_fale_conosco = pg_fetch_result($res_email_faleconosco, 0, 'email');
                    }
                    $email_envio = strtolower($consumidor_email);

                    $messageAssun     = " $login_fabrica_nome Atendimento: $hd_chamado";
                    $messagePerso     = " <b> Houve uma interação no atendimento: $hd_chamado .</b><br><br>";

                    if (in_array($login_fabrica, [198])) {
                        $messageAssun = ($hd_chamado > 0) ? $messageAssun : " $login_fabrica_nome Novo Atendimento";
                        $messagePerso = ($hd_chamado > 0) ? $messagePerso : " <b> Novo atendimento aberto.</b><br><br>";;
                    }

                    $subject  = $messageAssun;
                    $message  = "<b>Prezado, $consumidor_nome</b><br><br>";
                    $message .= $messagePerso;
                    $message .= $_POST["resposta"]."<br><br>";
                    $message .= "<b> Atenciosamente<br>";
                    $message .= "<b> $login_fabrica_nome <br><br>";

                    $mailTc->setEmailSubject($subject);
                    $mailTc->addToEmailBody($message);

                    if ($origem_nome == "fale conosco"){

                        if ($login_fabrica == 186) {
                            $mailTc->setEmailFrom('sac@mqhair.com.br');
                        } elseif ($login_fabrica == 189) {
                            $mailTc->setEmailFrom('carolina.mantovani@viapol.com.br');
                        } else {
                            $mailTc->setEmailFrom($email_fale_conosco);
                        }
                    }else{
                        if ($login_fabrica == 186) {
                            $mailTc->setEmailFrom('sac@mqhair.com.br');
                        } elseif ($login_fabrica == 189) {
                            $mailTc->setEmailFrom('carolina.mantovani@viapol.com.br');
                        } else {
                            $mailTc->setEmailFrom($externalEmail);
                        }
                    }

                    if (in_array($login_fabrica, [198])) {
                        $sqlMail = "SELECT ce.email 
                                    FROM tbl_callcenter_email ce 
                                    WHERE ce.fabrica = {$login_fabrica}
                                    AND ce.ativa IS TRUE";
                        $resMail   = pg_query($con,$sqlMail);
                        $emailFrom = (pg_num_rows($resMail) > 0) ? pg_fetch_result($resMail, 0, 'email') : $externalEmail;
                        $mailTc->setEmailFrom($emailFrom);
                    }

                    $mailTc->addEmailDest($email_envio);
                    $resultado = $mailTc->sendMail();

                    if (in_array($login_fabrica, [144,186])) {
                        $comenta = "";
                        if (in_array($login_fabrica, [186])) {
                            $comenta = ": ".$message;
                        }
                        $sql = "INSERT INTO tbl_hd_chamado_item(
                            hd_chamado   ,
                            data         ,
                            comentario   ,
                            admin        ,
                            interno
                        ) values (
                            $hd_chamado        ,
                            current_timestamp  ,
                            'Enviado email para o consumidor {$comenta}',
                            $login_admin       ,
                            true
                        )";

                        $res = pg_query($con,$sql);

                    }
                }

                if(in_array($login_fabrica, [189]) AND !empty($_POST['enviar_email_rep']) AND strlen(trim($email_representante)) > 0 AND $hd_chamado > 0){
                    $email_envio = strtolower($email_representante);

                    $subject  = " $login_fabrica_nome Atendimento: $hd_chamado";
                    $message  = "<b>Prezado, Representante</b><br><br>";
                    $message .= "<b> Houve uma interação no atendimento: $hd_chamado .</b><br><br>";
                    $message .= $_POST["resposta"]."<br><br>";
                    $message .= "<b> Atenciosamente<br>";
                    $message .= "<b> $login_fabrica_nome <br><br>";

                    $mailTc->setEmailSubject($subject);
                    $mailTc->addToEmailBody($message);
                    $mailTc->setEmailFrom('carolina.mantovani@viapol.com.br');
                    $mailTc->addEmailDest($email_envio);
                    $resultado = $mailTc->sendMail();
                }

            }
        }

        if ($login_fabrica == 52 && strlen($msg_erro) == 0) {

            /* ------ Campo Operadora ------ */

            $campos_adicionais2 = array();

            if (!empty($_POST['operadora_celular'])){
                $campos_adicionais2["operadora"] = trim($_POST['operadora_celular']);
            }else{
                $campos_adicionais2["operadora"] = "";
            }

            /*HD - 4304128*/
            $campos_adicionais2["pais"] = (strlen($_POST["consumidor_pais"] > 0)) ? $_POST["consumidor_pais"] : "BR";


            $sqlOS = "SELECT os FROM tbl_os JOIN tbl_os_extra USING(os) where tbl_os.hd_chamado = $callcenter and tbl_os.fabrica = $login_fabrica";
            $resOS = pg_query($con,$sqlOS);
            if(pg_num_rows($resOS) > 0 ){
                $os_fricon = pg_fetch_result($resOS, 0, 'os');
                $json = json_encode($campos_adicionais2);

                $json = str_replace("\\", "", $json);

                $sql = "SELECT * FROM tbl_os_campo_extra WHERE os = $os_fricon";
                $res = pg_query($con, $sql);
                if(pg_num_rows($res) > 0){
                    $sql = "UPDATE tbl_os_campo_extra SET campos_adicionais = '$json' WHERE os = $os_fricon AND fabrica = $login_fabrica";
                    $res = pg_query($con, $sql);
                }else{
                    $sql = "INSERT INTO tbl_os_campo_extra (os, fabrica, campos_adicionais) VALUES ($os_fricon, $login_fabrica, '$json')";
                    $res = pg_query($con, $sql);
                }

            }
            /* ------ Campo Operadora ------ */

        }

        if (($login_fabrica == 52 || $login_fabrica == 151) and empty($msg_erro)){ //HD 905951

            if($login_fabrica == 52){
                $sqlPontoReferencia = "UPDATE tbl_hd_chamado_extra set posto_nome = $xconsumidor_ponto_referencia where hd_chamado = $hd_chamado";
                $resPontoReferencia = pg_query($con,$sqlPontoReferencia);
                $msg_erro = pg_last_error($con);

                if (strlen($posto_km_tab) > 0){
                    $sqlKm = "UPDATE tbl_hd_chamado_extra set qtde_km = $posto_km_tab where hd_chamado = $hd_chamado";
                    $resKm = pg_query($con,$sqlKm);
                    $msg_erro = pg_last_error($con);
                }
                $sqlKm = "UPDATE tbl_hd_chamado_extra set qtde_km = null where hd_chamado = $hd_chamado and qtde_km = 0 ";
                $resKm = pg_query($con,$sqlKm);
                $msg_erro = pg_last_error($con);
            }

            $qtde_produto = $_POST['qtde_produto'];
            if ($qtde_produto > 0) {

                $series_digitadas = array();

                for ($w = 1; $w <= $qtde_produto; $w++) {
                    $produto_referencia = $_POST['produto_referencia_'.$w];
                    $produto_nome = $_POST['produto_nome_'.$w];
                    $serie              = $_POST['serie_'.$w];
                    $serie_anterior     = $_POST['serie_anterior_'.$w];
                    $defeito_reclamado  = $_POST['defeito_reclamado_'.$w];
                    if (in_array($login_fabrica, array(151))) {
                        $voltagem    = $_POST['voltagem_'.$w];
                        $b_num_serie = $_POST['b_num_serie_'.$w];
                        $obs_num_serie = $_POST['obs_num_serie_'.$w];
                        $nota_fiscal = $_POST['nota_fiscal_'.$w];
                        $data_nf     = $_POST['data_nf_'.$w];
                    }

                   if (strlen($produto_referencia) == 0 AND empty($callcenter)) {
                        $msg_erro .= "Preencha o campo Referência<br/>";
                    }

                    if (strlen($produto_nome) == 0 AND empty($callcenter)) {
                        $msg_erro .= "Preencha o campo Descrição<br/>";
                    }

                    if (!isset($_POST['hd_chamado_item_'.$w]) or empty($_POST['hd_chamado_item_'.$w])){

                        if (strlen($produto_referencia) > 0) {

                            $sql_ref = "SELECT tbl_produto.produto
                                FROM  tbl_produto
                                join  tbl_linha on tbl_produto.linha = tbl_linha.linha
                                WHERE tbl_produto.referencia = '$produto_referencia'
                                and tbl_linha.fabrica = $login_fabrica
                                and tbl_produto.fabrica_i = $login_fabrica
                                limit 1";

                            $res_ref = pg_query($con,$sql_ref);
                            $msg_erro .= pg_errormessage($con);

                            if (pg_num_rows($res_ref) > 0) {
                                $xproduto = pg_fetch_result($res_ref, 0, 0);

                                if($xcodigo_posto != "null"){
                                    $sql_linha = "SELECT tbl_linha.linha
                                        FROM tbl_produto
                                        JOIN tbl_linha ON tbl_produto.linha = tbl_linha.linha AND tbl_linha.fabrica = $login_fabrica
                                        JOIN tbl_posto_linha ON tbl_linha.linha = tbl_posto_linha.linha AND posto = $xcodigo_posto
                                        WHERE tbl_produto.produto = $xproduto
                                        and tbl_produto.fabrica_i = $login_fabrica";
                                    $res_linha = pg_query($con,$sql_linha);
                                    if(pg_num_rows($res_linha) == 0){
                                        $msg_erro .= "O posto não atende a linha do produto $produto_referencia";
                                    }
                                }
                            } else {
                                $xproduto = "null";
                            }

                        } else {

                            $xproduto = "null";
                        }

                        if ($login_fabrica != 151 AND strlen($defeito_reclamado) == 0 and (strlen($xproduto)>0 and $xproduto != 'null' ) ) {
                            $msg_erro .= "Favor Escolha um defeito reclamado para o produto $produto_referencia <br>";
                        }

                        if (strlen($defeito_reclamado) > 0 and (strlen($xproduto) == 0 or $xproduto == 'null')) {
                            $msg_erro .= "Favor Escolha o produto";
                        }

                        if (($xproduto == 'null' or empty($xproduto)) and $abre_ordem_servico == 't'){
                            $msg_erro .= "<br> Favor Escolha um produto";
                        }

                        if (!in_array($login_fabrica, [151]) AND empty($serie) and (strlen($xproduto)>0 and $xproduto != 'null' ) ) {

                            if (in_array($login_fabrica, [203])) {
                                $xAbrePreOs = $_POST['abre_os'];

                                if (empty($xAbrePreOs) || $xAbrePreOs != 't') {
                                    $msg_erro .= "<br> Favor inserir o número de série para o produto '$produto_referencia'";
                                }
                            } else {
                                $msg_erro .= "<br> Favor inserir o número de série para o produto '$produto_referencia'";
                            }

                        }else{

                            if (in_array($serie, $series_digitadas[$xproduto])) {
                                $msg_erro .= "A série digitada: '$serie' ja foi cadastrada para algum outro produto neste atendimento ";
                            }else{
                                $series_digitadas[$xproduto][] = $serie;
                            }


                        }

                        if (!in_array($login_fabrica, array(151))) {
                            if (!empty($serie)) {

                                $sql = "SELECT serie from tbl_numero_serie where serie = '$serie' and fabrica = $login_fabrica";
                                $res = pg_query($con, $sql);

                                if (pg_num_rows($res) == 0) {
                                    $msg_erro .="Numero de Série Inválido, preencha corretamente ou deixe em branco o campo série";
                                }

                            }

                            if(empty($serie)) $serie = "null";


                            if ($serie <> 'null') {

                                $serie = "'$serie'";
                                $sql = "SELECT serie from tbl_numero_serie where serie = $serie and fabrica = {$login_fabrica}";
                                $res = pg_query($con, $sql);

                                if (pg_num_rows($res) == 0) {
                                    $msg_erro .="Numero de Série Inválido, preencha corretamente ou deixe em branco o campo série";
                                }

                            }
                        }else{
                            if ($b_num_serie == 't' AND empty($obs_num_serie)) {
                                $msg_erro .= "Para bloquear o número de série é necessário informar uma observação<br>";
                            }elseif ($b_num_serie == 't' AND empty($serie)) {
                                $msg_erro .= "Para bloquear o número de série é necessário informar um número de série<br>";
                            }elseif(!empty($xproduto) and !empty($serie)){
                                    $sql = "INSERT INTO tbl_serie_controle (fabrica, produto, serie, quantidade_produzida, motivo)
                                                VALUES ($login_fabrica, $xproduto, '$serie', 0, '$obs_num_serie')";
                                    pg_query($con, $sql);
                                    if (strlen(pg_last_error()) > 0) {
                                        $msg_erro .= "Erro ao tentar bloquear o número de série";
                                    }
                                $serie = "'$serie'";
                            }
                        }

                        if (strlen($produto_referencia) != 0 and empty($msg_erro)) {

                            if($login_fabrica == 151 AND strlen($defeito_reclamado) == 0){
                                $defeito_reclamado = "null";
                            }

                            if($login_fabrica != 151 || (in_array($login_fabrica, array(151)) && ($abre_os == 't' || $b_num_serie == 't' || strlen($serie) > 0 ))){

                                $comentario_x = ($b_num_serie == 't') ? 'null' : "'Insercao de Produto para pré-os'";
                                $campos_insert = '';
                                $values_insert = '';
                                if (in_array($login_fabrica, array(151))) {
                                    $voltagem = (empty($voltagem)) ? 'null' : "'$voltagem'";
                                    $campos_insert = ',nota_fiscal,data_nf,voltagem';
                                    $nota_fiscal = (!empty($nota_fiscal)) ? $nota_fiscal : "''";
                                    $data_nf = !empty($data_nf) ? "'$data_nf'" : "null";
                                    $values_insert = ",{$nota_fiscal},{$data_nf},{$voltagem}";
                                }

                                $serie = (!empty($serie)) ? $serie : "''";
                                $sql = "INSERT INTO tbl_hd_chamado_item(
                                    hd_chamado   ,
                                    data         ,
                                    admin        ,
                                    interno      ,
                                    produto      ,
                                    serie        ,
                                    comentario,
                                    defeito_reclamado,
                                    status_item {$campos_insert}
                                ) values (
                                    $hd_chamado                       ,
                                    current_timestamp                 ,
                                    $login_admin                      ,
                                    't'                               ,
                                    '$xproduto'                       ,
                                    $serie                            ,
                                    $comentario_x,
                                    $defeito_reclamado                ,
                                    $xstatus_interacao {$values_insert}
                                ) RETURNING hd_chamado_item";

                                $res = pg_query($con,$sql);
                                $msg_erro .= pg_last_error();
                                #echo $msg_erro; exit;
                                if ($login_fabrica == 189 && verifica_origem_atendimento($_POST["origem"]) == "producao" && strlen($msg_erro) == 0) {
                                    $hd_chamado_item = pg_fetch_result($res, 0, 'hd_chamado_item');
                                    grava_chamado_item_externo($hd_chamado, $hd_chamado_item);
                                }
                            }

                        }

                    }else{

                        if(in_array($login_fabrica,[52,151])){
                            $window_cadastra_pedido = "false";
                            $hd_item = $_POST['hd_chamado_item_'.$w];
                            $referencia_produto = $_POST['produto_referencia_'.$w];
                            $serie       = $_POST['serie_'.$w];

                            if ($b_num_serie == 't' AND empty($obs_num_serie)) {
                                $msg_erro .= "Para bloquear o número de série é necessário informar uma observação<br>";
                            }

                            if ($b_num_serie == 't' AND empty($serie)) {
                                $msg_erro .= "Para bloquear o número de série é necessário informar um número de série<br>";
                            }

                            if (empty($defeito_reclamado)) {
                                $defeito_reclamado = "null";
                            }

                            if (strlen($data_nf) > 0) {
                                list($dia_nf, $mes_nf, $ano_nf) = explode("/", $data_nf);
                                if(!checkdate($mes_nf,$dia_nf,$ano_nf)) {
                                    $msg_erro .= "Data NF Inválida";
                                }else{
                                    $xdata_nf = "'".$ano_nf.'-'.$mes_nf.'-'.$dia_nf."'";
                                }
                            }

                            $sql = "SELECT produto FROM tbl_produto WHERE fabrica_i = {$login_fabrica} AND referencia = '{$referencia_produto}'";
                            $res = pg_query($con,$sql);

                            if(pg_num_rows($res) > 0 && empty($msg_erro)){

                                $prod = pg_fetch_result($res, 0, "produto");
                                $voltagem = (empty($voltagem) || $voltagem == 'null') ? 'null' : "'$voltagem'";

                                $sql = "UPDATE tbl_hd_chamado_item SET
                                        produto = {$prod},
                                        serie = '{$serie}',
                                        nota_fiscal = '{$nota_fiscal}',
                                        data_nf = {$xdata_nf},
                                        defeito_reclamado = {$defeito_reclamado},
                                        voltagem = {$voltagem}
                                        WHERE hd_chamado_item = {$hd_item}";
                                $res = pg_query($con,$sql);

                                if (!empty($serie_anterior) && $serie_anterior !== $serie) {
                                    $sql = "DELETE FROM tbl_serie_controle WHERE fabrica = $login_fabrica AND produto = $prod AND serie = '$serie_anterior' AND motivo = '$obs_num_serie'";
                                    pg_query($con, $sql);
                                    if (strlen(pg_last_error()) > 0) {
                                        $msg_erro .= "Erro ao tentar bloquear o número de série";
                                    }
                                }

                                if (!empty($obs_num_serie) && empty($msg_erro)) {
                                    $sql = "SELECT serie_controle FROM tbl_serie_controle WHERE fabrica = {$login_fabrica} AND produto = {$prod} AND serie = '{$serie}'";
                                    $res = pg_query($con, $sql);
                                    if (pg_num_rows($res) == 0) {
                                        $sql = "INSERT INTO tbl_serie_controle (fabrica, produto, serie, quantidade_produzida, motivo)
                                                    VALUES ($login_fabrica, $prod, '$serie', 0, '$obs_num_serie')";
                                        pg_query($con, $sql);
                                        if (strlen(pg_last_error()) > 0) {
                                            $msg_erro .= "Erro ao tentar bloquear o número de série";
                                        }
                                    }
                                    if (empty($msg_erro)) {
                                        $sql_cc = "SELECT
                                                        tbl_hd_chamado.hd_chamado
                                                    FROM tbl_hd_chamado_item
                                                    JOIN tbl_hd_chamado ON tbl_hd_chamado_item.hd_chamado = tbl_hd_chamado.hd_chamado
                                                    JOIN tbl_os ON tbl_os.os = tbl_hd_chamado_item.os
                                                    WHERE tbl_hd_chamado_item.hd_chamado = {$hd_chamado} AND tbl_hd_chamado_item.os is not null";
                                        $res = pg_query($con, $sql_cc);
                                        if (pg_num_rows($res) == 0) {
                                            $window_cadastra_pedido = "true";
                                        }
                                    }
                                }

                                $sql = "SELECT os FROM tbl_hd_chamado_item WHERE hd_chamado_item = {$hd_item} AND os notnull";
                                $res = pg_query($con,$sql);

                                if(pg_num_rows($res) > 0){
                                    $osItem = pg_fetch_result($res,0,"os");

                                    $sql = "UPDATE tbl_os SET
                                        nota_fiscal = '{$nota_fiscal}',
                                        data_nf = {$xdata_nf}
                                        WHERE os = {$osItem}
                                        AND length(nota_fiscal) = 0";
                                    $res = pg_query($con,$sql);
                                }

                            }elseif(pg_num_rows($res) == 0){
                                $msg_erro .= "Produto $referencia_produto não encontrado <br>";
                            }
                        }

                    }

                }

            }

        }


        if (in_array($login_fabrica, [203])) {
            $xAbrePreOs = $_POST['abre_os'];

            if (!empty($xproduto) && !empty($serie) ) {
                $sql = "SELECT mascara, posicao_versao
                          FROM tbl_produto_valida_serie
                         WHERE produto = {$xproduto}
                           AND fabrica = {$login_fabrica}";
                $res = pg_query($con, $sql);

                $mascara_ok = null;

                while ($mascara = pg_fetch_object($res)) {
                    $regExp = str_replace(array('L','N'), array('[A-Z]', '[0-9]'), $mascara->mascara);

                    if (preg_match("/$regExp/i", $serie)) {
                        $mascara_ok = $mascara->mascara;
                        break;
                    }
                }

                if ($mascara_ok == null && (empty($xAbrePreOs) || $xAbrePreOs != 't')) {
                    $msg_erro .= "Número de série inválido";
                }
            } else {
                if (empty($xAbrePreOs) || $xAbrePreOs != 't') {
                    $msg_erro .= "Produto e/ou série não informado";
                }
            }
        }

        if (in_array($login_fabrica,[186,189,190,195])){

            $qtde_produto = $_POST['qtde_produto'];
  
    	    if (in_array($login_fabrica,[186,190,195]) && strlen($callcenter) > 0) {

                $observacao_os = $_POST['observacao_os'];

        		if (strlen($observacao_os) > 0) { 
        			$sqlUpEx = "UPDATE tbl_hd_chamado_extra SET obs_callcenter='{$observacao_os}' WHERE hd_chamado={$callcenter}";
                    $resUpEx = pg_query($con, $sqlUpEx);

                    if (pg_last_error()) {
                    	$msg_erro .= "Erro ao gravar Obs. OS ";
                    }

        		}

      	    } 

            for ($w = 1; $w <= $qtde_produto; $w++) {

                $nota_fiscal        = $_POST['nota_fiscal_'.$w];
                $data_nf            = $_POST['data_nf_'.$w];
                $qtde_prod_lancado  = (strlen($_POST['qtde_prod_lancado_'.$w]) == 0) ? 1 : $_POST['qtde_prod_lancado_'.$w];
                $lote               = $_POST['lote_'.$w];
                $preco              = $_POST['preco_'.$w];
                $defeito_reclamado  = $_POST['defeito_reclamado_'.$w];
                $serie               = $_POST['serie_'.$w];
                $hd_item            = $_POST['hd_chamado_item_'.$w];
                $referencia_produto = $_POST['produto_referencia_'.$w];
                $xdata_nf = "null";
                $campo_xdefeito = "";
                $campo_xserie = "";
                $campo_xvoltagem = "";

                if (strlen($data_nf) > 0) {
                    list($dia_nf, $mes_nf, $ano_nf) = explode("/", $data_nf);
                    if(!checkdate($mes_nf,$dia_nf,$ano_nf)) {
                        $msg_erro .= "Data NF Inválida";
                    }else{
                        $xdata_nf = "'".$ano_nf.'-'.$mes_nf.'-'.$dia_nf."'";
                    }
                }
                $campoVolt = "";
				$valueVolt = "";
                if (in_array($login_fabrica, [195])) {
                    $voltagem      = $_POST['voltagem_'.$w];
                    $campoVolt = "voltagem,";
					$valueVolt = "'$voltagem',";
                    $campo_xvoltagem = "voltagem='$voltagem',";
                }

                if (in_array($login_fabrica,[186,190,195])){

        			if (strlen($defeito_reclamado) > 0) {
        				$sqlDef = "SELECT defeito_reclamado FROM tbl_defeito_reclamado WHERE fabrica = $login_fabrica AND ativo='t' AND defeito_reclamado=$defeito_reclamado";
        				$resDef = pg_query($con, $sqlDef);

        				if (pg_num_rows($resDef) > 0) {
        				    $xdefeito = pg_fetch_result($resDef, 0, defeito_reclamado);
        				    $campoDef = "defeito_reclamado,";
        				    $valueDef = "$xdefeito,";
        				    $campo_xdefeito = "defeito_reclamado=$xdefeito,";
        				}
        			} else {

                        $campo_xdefeito = "defeito_reclamado=null,";
        			}

        			if (strlen($serie) > 0) {
        				$campoSer = "serie,";
        				$valueSer = "'$serie',";
                        $campo_xserie = "serie='$serie',";
        			}

                }

                $sql = "SELECT produto FROM tbl_produto WHERE fabrica_i = {$login_fabrica} AND referencia = '{$referencia_produto}'";
                $res = pg_query($con,$sql);


                if(pg_num_rows($res) > 0 && empty($msg_erro)){

                    $prod = pg_fetch_result($res, 0, "produto");
                    if (strlen($hd_item) > 0) {
                        $campos_xadicionais = "";
                        if ($login_fabrica == 189) {
                            $sqlIt = "SELECT campos_adicionais FROM tbl_hd_chamado_item WHERE hd_chamado_item={$hd_item}";
                            $resIt = pg_query($con, $sqlIt);
                            $camposAdd = json_decode(pg_fetch_result($resIt, 0, 'campos_adicionais'),1);
                            $camposAdd["preco"] = $preco;
                            $xcamposAdd = json_encode($camposAdd);
                            $campos_xadicionais = "campos_adicionais = '{$xcamposAdd}',";

                        }

                        $sql = "UPDATE tbl_hd_chamado_item SET
                                {$campo_xvoltagem}
                                {$campo_xdefeito}
                                {$campo_xserie}
                                {$campos_xadicionais}
                                produto = {$prod},
                                qtde = {$qtde_prod_lancado},
                                tincaso = '{$lote}',
                                nota_fiscal = '{$nota_fiscal}',
                                data_nf = {$xdata_nf}
                                WHERE hd_chamado_item = {$hd_item}";
                        $res = pg_query($con,$sql);
                    } else {

            			$campoAd = "";
            			$valueAd = "";
            			if ($login_fabrica == 189) {
                            $camposAdd["preco"] = $preco;
                            $xcamposAdd = json_encode($camposAdd);
                            $campoAd = "campos_adicionais,";
                            $valueAd = "'{$xcamposAdd}',";
                        }

                        $sql = "INSERT INTO tbl_hd_chamado_item (
                        {$campoAd}
                        {$campoVolt}
                        {$campoSer}
                        {$campoDef}
                        produto,
                        qtde,tincaso,nota_fiscal,data_nf,hd_chamado) VALUES(
                        {$valueAd}
                        {$valueVolt}
                        {$valueSer}
                        {$valueDef}
                        {$prod},
                        {$qtde_prod_lancado},
                        '{$lote}',
                        '{$nota_fiscal}',
                        {$xdata_nf},
                        {$hd_chamado}
                        )";
                        $res = pg_query($con,$sql);

                    }

                    if (pg_last_error()) {
                        $msg_erro .= "Erro ao gravar Produto {$referencia_produto} ";
                    }
                }
            }
        }

        // HD 3272576
        if ($login_fabrica == 30 and strlen($posto_km_tab) > 0){
            if (strpos($posto_km_tab, ','))
                $posto_km_tab = str_replace(',', '.', $posto_km_tab);
            $sqlKm = "UPDATE tbl_hd_chamado_extra SET qtde_km = $posto_km_tab WHERE hd_chamado = $hd_chamado";
            $resKm = pg_query($con,$sqlKm);
            $msg_erro .= pg_last_error($con);
        }

        //HD 196942: Controle de postagem
        //o checkbox para solicitar postagem para o chamado só aparece quando não tem solicitação para aquele chamado,
        //portanto só virá alguma coisa por POST em hd_chamado_postagem se não estiver cadastrado e se estiver com o checkbox marcado
        if ($_POST["hd_chamado_postagem"] == "sim" && strlen($hd_chamado) > 0 && strlen($msg_erro) == 0) {

            $sql = "SELECT hd_chamado FROM tbl_hd_chamado_postagem WHERE hd_chamado=$hd_chamado";
            $res = pg_query($con, $sql);

            if (pg_num_rows($res)) {
                $msg_erro = "já existe solicitação de postagem cadastrada para este chamado. Não é permitido o cadastramento de mais de uma postagem para um mesmo chamado";
            } else {

                $sql = "INSERT INTO tbl_hd_chamado_postagem(hd_chamado, fabrica) VALUES($hd_chamado,$login_fabrica)";
                @$res = pg_query($con, $sql);

                if (pg_errormessage($con)) {
                    $msg_erro = "Houve um erro ao cadastrar a sua solicitação de postagem. Contate o HelpDesk";
                }

            }

        }

        if (strlen($_POST["hd_chamado_codigo_postagem"]) > 0 && strlen($hd_chamado) && strlen($msg_erro) == 0) {

            $hd_chamado_codigo_postagem = $_POST["hd_chamado_codigo_postagem"];

            $sql = "SELECT hd_chamado FROM tbl_hd_chamado_postagem WHERE hd_chamado=$hd_chamado AND aprovado IS TRUE";
            $res = pg_query($con, $sql);

            if (pg_num_rows($res)) {

                $sql = "UPDATE tbl_hd_chamado_postagem SET codigo_postagem = '$hd_chamado_codigo_postagem' WHERE hd_chamado=$hd_chamado";
                @$res = pg_query($con, $sql);

                if (pg_errormessage($con)) {
                    $msg_erro = "Ocorreu um erro no sistema, contate o HelpDesk";
                }

            } else {
                $msg_erro = "Foi informado Código de Postagem, mas não existe postagem autorizada para este chamado";
            }
        }

        if (in_array($login_fabrica, array(169,170))) {
            $comentario = "Indicação de posto autorizado: <br>";

            if (empty($posto_tab)) {
                $sqlPosto = "SELECT * FROM tbl_posto_fabrica WHERE fabrica = {$login_fabrica} AND codigo_posto = '{$codigo_posto_tab}'";
                $resPosto = pg_query($con,$sqlPosto);
                if (pg_num_rows($resPosto) > 0) {
                    $posto_tab = pg_fetch_result($resPosto, 0, posto);
                }
            }
        }else{
            $comentario = "Indicação do posto mais próximo do consumidor: <br>";
        }

        if (strlen($posto_tab) > 0 and strlen($msg_erro) == 0) {

            $comentario .= "
                Código: $codigo_posto_tab <br>
                Nome: ".pg_escape_string($posto_nome_tab)."<br>
                Endereço: ".pg_escape_string($posto_endereco_tab)." <br>
                Cidade: ".pg_escape_string($posto_cidade_tab)."<br>
                Estado: $posto_estado_tab<br>
                Cep: $posto_cep_tab<br>
                Telefone: $posto_fone_tab<br>
                E-mail: $posto_email_tab
            ";

            if (in_array($login_fabrica, array(169,170))) {
                $sql = "SELECT hd_chamado FROM tbl_hd_chamado_item WHERE hd_chamado = $hd_chamado AND comentario ~'de posto autorizado:' AND comentario ~'$codigo_posto_tab'";
            } else {
                $sql = "SELECT hd_chamado FROM tbl_hd_chamado_item WHERE hd_chamado = $hd_chamado AND comentario ~'o do posto mais pr' AND comentario ~'$codigo_posto_tab'";
            }
            $res = pg_query($con, $sql);

            if(pg_num_rows($res) == 0) {
                $sql = "
                    INSERT INTO tbl_hd_chamado_item
                        (hd_chamado,data,comentario,admin,interno,status_item)
                    VALUES
                        ({$hd_chamado},current_timestamp,E'{$comentario}',{$login_admin},'".(($login_fabrica == 74) ? "t": "f")."',{$xstatus_interacao})
                RETURNING hd_chamado_item ";
                $res = pg_query($con, $sql);
                $msg_erro .= pg_errormessage($con);
                if ($login_fabrica == 189 && verifica_origem_atendimento($_POST["origem"]) == "producao" && strlen($msg_erro) == 0) {
                    $hd_chamado_item = pg_fetch_result($res, 0, 'hd_chamado_item');
                    grava_chamado_item_externo($hd_chamado, $hd_chamado_item);
                }
            }

            //HD 211895: Atualizando posto

            $sql = "UPDATE tbl_hd_chamado_extra SET posto = {$posto_tab} WHERE hd_chamado = {$callcenter};";
            $res_atualiza_posto = pg_query($con, $sql);

            if (in_array($login_fabrica, array(169,170))){ //validação OS vinculada ao Callcenter
                if (strlen(trim($os)) > 0){
                    $sql_posto_os = "
                        SELECT tbl_os.posto, tbl_posto.nome, tbl_os.hd_chamado, tbl_os.obs
                        FROM tbl_os
                        JOIN tbl_posto ON tbl_posto.posto = tbl_os.posto
                        JOIN tbl_posto_fabrica ON tbl_posto_fabrica.posto = tbl_posto.posto
                            AND tbl_posto_fabrica.fabrica = {$login_fabrica}
                        WHERE tbl_os.os = {$os}
                        AND tbl_os.fabrica = {$login_fabrica}";
                    $res_posto_os = pg_query($con, $sql_posto_os);

                    if (pg_num_rows($res_posto_os) > 0){
                        $posto_os_nome              = pg_fetch_result($res_posto_os, 0, 'nome');
                        $posto_os                   = pg_fetch_result($res_posto_os, 0, 'posto');
                        $hd_chamado_os_anterior     = pg_fetch_result($res_posto_os, 0, 'hd_chamado');
                        $obs_chamado_os_anterior    = pg_fetch_result($res_posto_os, 0, 'obs');

                        if ($abre_ordem_servico != 't' AND strlen($posto_tab) > 0) { // Entra na condição OS vinculada ao Callcenter
                            if ($posto_os <> $posto_tab){
                                $msg_erro .= "O posto autorizado da Ordem de serviço é diferente do Posto autorizado do atendimento.";
                            }else{
                                $sql = "SELECT hd_chamado FROM tbl_hd_chamado_item WHERE hd_chamado = $callcenter
                                    AND comentario ~'foi vinculada ao atendimento'";
                                $res = pg_query($con, $sql);

                                if (pg_num_rows($res) == 0){
                                    $sql = "INSERT INTO tbl_hd_chamado_item(
                                            hd_chamado   ,
                                            data         ,
                                            comentario   ,
                                            admin        ,
                                            interno
                                        ) values (
                                            $callcenter       ,
                                            current_timestamp ,
                                            E'A OS: $os foi vinculada ao atendimento.',
                                            $login_admin      ,
                                            't'
                                        )";
                                    $res = pg_query($con,$sql);
                                }
                            }
                        }

                        if (empty($msg_erro)){
                            if (!empty($hd_chamado_os_anterior)){
                                if ($hd_chamado_os_anterior <> $callcenter) {
                                    $obs_chamado_os_anterior = $obs_chamado_os_anterior."<br/> OS vinculada ao Atendimento: {$callcenter}, Atendimento anterior: {$hd_chamado_os_anterior}";

                                    $update_hd = "UPDATE tbl_os SET hd_chamado = {$callcenter}, obs = '$obs_chamado_os_anterior' WHERE os = {$os} AND fabrica = {$login_fabrica}";
                                    $res_update_hd = pg_query($con, $update_hd);

                                    $sql = "INSERT INTO tbl_hd_chamado_item(
                                            hd_chamado   ,
                                            data         ,
                                            comentario   ,
                                            admin        ,
                                            interno
                                        ) values (
                                            $callcenter       ,
                                            current_timestamp ,
                                            E'OS vinculada ao Atendimento: {$callcenter}, Atendimento anterior: {$hd_chamado_os_anterior}',
                                            $login_admin      ,
                                            't'
                                        )";
                                    $res = pg_query($con,$sql);
                                }
                            }else{
                                $update_hd = "UPDATE tbl_os SET hd_chamado = {$callcenter} WHERE os = {$os} AND fabrica = {$login_fabrica}";
                                $res_update_hd = pg_query($con, $update_hd);
                            }
                        }
                    }
                }
            }

            if(in_array($login_fabrica, array(169,170)) && !empty($os) && empty($msg_erro)) {
                $sqlPostoAnterior = "SELECT
                    tbl_posto_fabrica.codigo_posto AS codigo_posto,
                    tbl_posto.nome AS posto_nome,
                    tbl_os.posto,
                    tbl_os.status_checkpoint AS status_checkpoint_os,
                    tbl_produto.referencia AS referencia_produto,
                    tbl_produto.descricao AS descricao_produto,
                    tbl_produto.produto AS id_produto,
                    tbl_fabrica.nome AS fabrica_nome,
                    TO_CHAR(tbl_hd_chamado.data, 'DD/MM/YY HH24:MI') AS data_atendimento,
                    tbl_hd_chamado_extra.nome,
                    tbl_hd_chamado_extra.endereco,
                    tbl_hd_chamado_extra.numero,
                    tbl_hd_chamado_extra.complemento,
                    tbl_hd_chamado_extra.bairro,
                    tbl_cidade.nome AS cidade_nome,
                    tbl_hd_chamado_extra.os AS os_hd_chamado_extra,
                    tbl_cidade.estado,
                    tbl_hd_chamado_extra.revenda_nome,
                    tbl_revenda.cnpj AS revenda_cnpj,
                    tbl_admin.nome_completo AS admin_nome,
                    tbl_admin.email AS email_admin
                        FROM tbl_hd_chamado
                        JOIN tbl_hd_chamado_extra ON tbl_hd_chamado.hd_chamado=tbl_hd_chamado_extra.hd_chamado
                        JOIN tbl_posto ON tbl_hd_chamado_extra.posto=tbl_posto.posto
                        JOIN tbl_posto_fabrica ON tbl_posto.posto=tbl_posto_fabrica.posto AND tbl_posto_fabrica.fabrica = $login_fabrica
                        JOIN tbl_os ON tbl_os.os = tbl_hd_chamado_extra.os AND tbl_os.fabrica = $login_fabrica
                        JOIN tbl_produto ON tbl_hd_chamado_extra.produto=tbl_produto.produto
                        JOIN tbl_fabrica ON tbl_posto_fabrica.fabrica=tbl_fabrica.fabrica AND tbl_fabrica.fabrica = $login_fabrica
                        LEFT JOIN tbl_cidade ON tbl_hd_chamado_extra.cidade=tbl_cidade.cidade
                        LEFT JOIN tbl_revenda ON tbl_hd_chamado_extra.revenda=tbl_revenda.revenda
                        JOIN tbl_admin ON tbl_hd_chamado.admin=tbl_admin.admin AND tbl_admin.fabrica = $login_fabrica
                        WHERE tbl_hd_chamado.hd_chamado=$hd_chamado
                        AND tbl_hd_chamado.fabrica=$login_fabrica
                        AND tbl_posto_fabrica.fabrica=$login_fabrica
                        AND tbl_os.os = $os";
                $resPostoAnterior = pg_query($con, $sqlPostoAnterior);

                if (pg_num_rows($resPostoAnterior) > 0){
                    $postoAnterior             = pg_fetch_result($resPostoAnterior, 0, 'posto');
                    $email_os_codigo_posto     = pg_fetch_result($resPostoAnterior, 0, 'codigo_posto');
                    $email_os_posto_nome       = pg_fetch_result($resPostoAnterior, 0, 'posto_nome');
                    $email_os_fabrica_nome     = pg_fetch_result($resPostoAnterior, 0, 'fabrica_nome');
                    $email_os_data_atendimento = pg_fetch_result($resPostoAnterior, 0, 'data_atendimento');
                    $email_os_nome             = pg_fetch_result($resPostoAnterior, 0, 'nome');
                    $email_os_endereco         = pg_fetch_result($resPostoAnterior, 0, 'endereco');
                    $email_os_numero           = pg_fetch_result($resPostoAnterior, 0, 'numero');
                    $email_os_complemento      = pg_fetch_result($resPostoAnterior, 0, 'complemento');
                    $email_os_bairro           = pg_fetch_result($resPostoAnterior, 0, 'bairro');
                    $email_os_cidade_nome      = addslashes(pg_fetch_result($resPostoAnterior, 0, 'cidade_nome'));
                    $email_os_estado           = pg_fetch_result($resPostoAnterior, 0, 'estado');
                    $email_os_revenda_nome     = pg_fetch_result($resPostoAnterior, 0, 'revenda_nome');
                    $email_os_revenda_cnpj     = pg_fetch_result($resPostoAnterior, 0, 'revenda_cnpj');
                    $email_os_admin_nome       = pg_fetch_result($resPostoAnterior, 0, 'admin_nome');
                    $email_os_admin_email      = pg_fetch_result($resPostoAnterior, 0, 'email_admin');
                    $produto                   = pg_fetch_result($resPostoAnterior, 0, 'id_produto');
                    $produtos                  = pg_fetch_result($resPostoAnterior, 0, 'referencia_produto').' - '.pg_fetch_result($resPostoAnterior, 0, 'descricao_produto');
                    $os_hd_chamado_extra       = pg_fetch_result($resPostoAnterior, 0, 'os_hd_chamado_extra');
                    $status_checkpoint_os      = pg_fetch_result($resPostoAnterior, 0, 'status_checkpoint_os');

                    if ($email_os_endereco)     $email_endereco .= $email_os_endereco;
                    if ($email_os_numero)       $email_endereco .= ", " . $email_os_numero;
                    if ($email_os_complemento)  $email_endereco .= " " . $email_os_complemento;
                    if ($email_os_bairro)       $email_endereco .= " - " . $email_os_bairro;
                    if ($email_os_cidade_nome)  $email_endereco .= " - " . $email_os_cidade_nome;
                    if ($email_os_estado)       $email_endereco .= " - " . $email_os_estado;
                    if ($email_os_revenda_cnpj) $email_os_revenda_cnpj = " - " . $email_os_revenda_cnpj;

                    $subject  = "Nova ORDEM DE SERVIÇO nº $os :: $login_fabrica_nome";
                }

                if (!empty($postoAnterior)){
                    if ($postoAnterior <> $posto_tab){
                        $sqlAgendamento = "
                                SELECT os
                                FROM tbl_tecnico_agenda
                                WHERE os = {$os}
                                AND fabrica = {$login_fabrica}
                                AND confirmado IS NOT NULL
                                ORDER BY ordem DESC LIMIT 1";
                        $resAgendamento = pg_query($con, $sqlAgendamento);

                        if (pg_num_rows($resAgendamento) > 0){
                            $osAgendamento = pg_fetch_result($resAgendamento, 0, 'os');
                        }
                        if ($status_checkpoint_os != "" AND in_array($status_checkpoint_os, array(0,1)) AND !empty($osAgendamento)){
                            $msg_erro = "O posto autorizado da Ordem de serviço é diferente do Posto autorizado do atendimento. OS com agendamento confirmado pelo Posto: $posto_os_nome";
                        }

                        if (in_array($login_fabrica,[169,170])) {
                            $sql_checkpoint = "SELECT status_checkpoint
                                               FROM tbl_os
                                               WHERE os = {$os}
                                               AND fabrica = {$login_fabrica}";
                            $res_checkpoint = pg_query($con, $sql_checkpoint);
                            $valida_checkpoint = pg_fetch_result($res_checkpoint, 0, 'status_checkpoint');
                            if ($valida_checkpoint > 1) {
                                $msg_erro .= "OS já está sendo analisada pelo posto, não pode mais ser alterada.";
                            }
                        }

                        if (empty($msg_erro)){
                            $updPostoOS = "UPDATE tbl_os SET posto = {$posto_tab} WHERE os = {$os};";
                            $resPostoOS = pg_query($con, $updPostoOS);
                            $msg_erro .= pg_errormessage($con);

                            if ($_POST['periodo'] == 'manha'){
                                $texto_periodo = "Manhã";
                            }else{
                                $texto_periodo = "Tarde";
                            }

                            if (strlen(trim($msg_erro)) == 0){

                                $sql = "INSERT INTO tbl_hd_chamado_item(
                                        hd_chamado   ,
                                        data         ,
                                        comentario   ,
                                        admin        ,
                                        interno
                                    ) values (
                                        $callcenter       ,
                                        current_timestamp ,
                                        E'O Posto autorizado da OS foi alterado de: {$posto_os_nome} para: {$email_os_posto_nome}',
                                        $login_admin      ,
                                        't'
                                    )";
                                $res = pg_query($con,$sql);

                                $sqlComunicado = "
                                        SELECT comunicado
                                        FROM tbl_comunicado
                                        WHERE posto = {$postoAnterior}
                                        AND tipo = 'Comunicado'
                                        AND ativo IS TRUE
                                        AND descricao ~ 'Nova ORDEM DE SERVI'
                                        AND descricao ~ 'nº $os'
                                         ";
                                $resComunicado = pg_query($con, $sqlComunicado);

                                if (pg_num_rows($resComunicado) > 0){
                                    $comunicados = pg_fetch_all_columns($resComunicado);

                                    $sql_up = "UPDATE tbl_comunicado SET fabrica = 0 WHERE comunicado IN (".implode(',', $comunicados).")";
                                    $res_up = pg_query($con, $sql_up);
                                }

                                $message = "<p> Autorizada $email_os_codigo_posto - $email_os_posto_nome </p>
                                    <p >O Callcenter da Fábrica $email_os_fabrica_nome, abriu um atendimento que se tornou uma ORDEM DE SERVIÃO para ser atendido pelo seu posto autorizado.</p>
                                    <p >Segue as informações da ORDEM DE SERVIÇO nº $os</p>
                                    <p >    Atendimento do Call-Center nº $hd_chamado - Aberto por $email_os_admin_nome em $email_os_data_atendimento </p>
                                    ";

                                    $message .= "<p > Produto: $produtos</p>";

                                    if ($login_fabrica != 171 || ($login_fabrica == 171 && $_POST['tipo_atendimento_grohe'] == 297)) {
                                        $message .= "<p >Consumidor: $email_os_nome ($email_endereco) </p>
                                        <p >Revenda: $email_os_revenda_cnpj $email_os_revenda_nome </p>
                                        <p >Favor completar este atendimento o mais rápido possível, e qualquer dúvida, entrar em contato.</p>
                                        <p >$email_os_admin_nome</p>
                                        <p>Callcenter $login_fabrica_nome</p>
                                        <p><strong>A data de agendamento da OS é: {$_POST['data_agendamento_ordem']}</strong></p>
                                        <p><strong>O período do agendamento da OS é: {$texto_periodo}</strong></p>
                                    ";
                                    } else {
                                        $message .= "<p >Consumidor: $email_os_nome ($email_endereco) </p>
                                        <p >Revenda: $email_os_revenda_cnpj $email_os_revenda_nome </p>
                                        <p >Favor completar este atendimento o mais rápido possível, e qualquer dúvida, entrar em contato.</p>
                                        <p >$email_os_admin_nome</p>
                                        <p>Callcenter $login_fabrica_nome</p>
                                    ";
                                    }

                                $sql = "INSERT INTO tbl_comunicado (
                                        produto                ,
                                        descricao              ,
                                        mensagem               ,
                                        tipo                   ,
                                        fabrica                ,
                                        obrigatorio_site       ,
                                        posto                  ,
                                        ativo                  ,
                                        pais                   ,
                                        remetente_email
                                    ) VALUES (
                                        $produto               ,
                                        '$subject'             ,
                                        '$message'             ,
                                        'Comunicado'           ,
                                        $login_fabrica         ,
                                        't'                    ,
                                        $posto_tab             ,
                                        't'                    ,
                                        'BR'                   ,
                                        '$email_os_admin_email'
                                    )";
                                $res = pg_query($con, $sql);
                            }
                        }
                    }
                }
            }
            $msg_erro .= pg_errormessage($con);
        }

        //se  para enviar email para consumidor
        if (strlen($msg_erro) == 0 && $xenvia_email == "'t'" && in_array($login_fabrica,array(24,30,42,86,178))) {

            if ($_POST["consumidor_email"]) {
                $xxresposta   = str_replace("'","",$xresposta);
                /* Realiza uma interação no chamado - Foi enviado um email para o Consumidor */
                if(in_array($login_fabrica, [24,30])){
                    $sql_email_chamado = "INSERT INTO tbl_hd_chamado_item(
                        hd_chamado   ,
                        data         ,
                        comentario   ,
                        admin        ,
                        interno      ,
                        status_item
                    ) values (
                        $callcenter       ,
                        current_timestamp ,
                        'Foi enviado um E-mail para o consumidor <br /><br /> <b>Mensagem enviada:</b> <br /> <em>$xxresposta</em>',
                        $login_admin      ,
                        't'  ,
                        $xstatus_interacao
                    )";

                    $res_email_chamado = pg_query($con, $sql_email_chamado);
                    $msg_erro .= pg_errormessage($con);

                }

                if ($login_fabrica == 24) {
                    $admin_email = "Suggar <resposta_automatica@suggar.com.br>";
                } else {

                    if($login_fabrica == 86){
                        $sql = "SELECT email,responsabilidade
                            FROM tbl_admin
                            WHERE fabrica = $login_fabrica
                            AND responsabilidade = 'envia_email'
                            AND admin = $login_admin
                            ";
                        $res = pg_query($con,$sql);
                        $msg_erro .= pg_errormessage($con);

                        if (pg_num_rows($res) > 0) {
                            $admin_email_assinatura = pg_fetch_result($res,0,email);
                            $responsabilidade_admin = pg_fetch_result($res,0,responsabilidade);
                        }
                    }
                    $sql = "Select email from tbl_admin where admin = $login_admin and fabrica = $login_fabrica";
                    $res = pg_query($con,$sql);
                    $msg_erro .= pg_errormessage($con);

                    if (pg_num_rows($res) > 0) {
                        $admin_email = pg_fetch_result($res,0,email);
                    } else {
                        $admin_email = "telecontrol@telecontrol.com.br";
                    }

                    if($login_fabrica == 86 AND $responsabilidade_admin == "envia_email"){

                        $assinatura = "\n\n\nAssistência Técnica Famastil Taurus Ferramentas S.A.\nFone: 0800 644 8284\n$admin_email_assinatura";
                    }else{
                        $assinatura = '';
                    }
                }

                $remetente    = $admin_email;
                $destinatario = $_POST["consumidor_email"];
                $assunto      = "Protocolo $callcenter - Resposta atendimento Call Center";
                $mensagem     = $xxresposta.$assinatura;
                $headers      = "Return-Path: $admin_email\nFrom:".$remetente."\nContent-type: text/html\n";

                //HD 234227: Mensagem da Suggar
                if ($login_fabrica == 24) {
                    $remetente = "resposta_automatica@suggar.com.br";
                    $mensagem = "
                        Esta é uma mensagem automática. Por favor, não responda este e-mail. Estamos sempre prontos para atendê-lo.
                        Caso queira entrar em contato novamente, acesse www.suggar.com.br no link Fale conosco.
                        <br /> <br />
                        $mensagem
                        <br /> <br />
                        Atenciosamente,
                        <br /> <br />
                        Central de Relacionamento com o cliente<br>
                        <br />
                        SUGGAR
                        <br /> <br />";
                    $mailTc->setEmailSubject($assunto);
                    $mailTc->addToEmailBody($mensagem);
                    $mailTc->setEmailFrom($admin_email);
                    $mailTc->addEmailDest($destinatario);
                    $resultado = $mailTc->sendMail();

                }else if ($login_fabrica == 178) {
                    $admin_email = "Roca <resposta_automatica@roca.com.br>";
                    $remetente = "resposta_automatica@roca.com.br";

                    $mensagem = "
                        $mensagem
                        <br /> <br />
                        Caso seja necessário, responda este e-mail para posvendas@br.roca.com informando seu número de protocolo ou entre em contato pelo 0800-7011300.
                        <br /> <br />
                        Atenciosamente,
                        <br /> <br />
                        Serviços Pós-vendas Roca Brasil <br/>
                        posvendas@br.roca.com<br/>
                        0800-7011300<br/>

                        <br /> <br />";
                        $mailTc->setEmailSubject($assunto);
                        $mailTc->addToEmailBody($mensagem);
                        $mailTc->setEmailFrom($admin_email);
                        $mailTc->addEmailDest($destinatario);
                        $resultado = $mailTc->sendMail();
                } elseif ($login_fabrica == 30) {
                    $assunto  = " Atendimento Esmaltec - Protocolo $callcenter";
                    $mensagem = "
                        $mensagem
                        <br /> <br />
                        Caso queira responder Ã  essa mensagem, <a href='https://posvenda.telecontrol.com.br/assist/externos/esmaltec/fale_conosco.php' target='_blank'><b>CLIQUE AQUI</b></a> , acesse a aba Consulta de Protocolo e informe seu CPF/CNPJ ou número do Protocolo.
                        <br /> <br />
                        Equipe Esmaltec.
                        <br /> <br />";

                    // mail($destinatario, utf8_encode($assunto), utf8_encode($mensagem), $headers);

                    //$mailer->IsSMTP();
                    //$mailer->IsHTML(true);
                    //$mailer->AddAddress($destinatario);
                    //$mailer->Subject = $assunto;
                    //$mailer->Body = $mensagem;
                    //$mailer->AddReplyTo($admin_email);
                    //$mailer->Send();

                    $mailTc->setEmailSubject($assunto);
                    $mailTc->addToEmailBody($mensagem);
                    $mailTc->setEmailFrom($admin_email);
                    $mailTc->addEmailDest($destinatario);
                    $resultado = $mailTc->sendMail();
                } else {

                    //mail($destinatario,$assunto,$mensagem,$headers);

                    // $mailer->IsSMTP();
                    // $mailer->IsHTML(true);
                    // $mailer->AddAddress($destinatario);
                    // $mailer->Subject = $assunto;
                    // $mailer->Body = $mensagem;
                    // $mailer->AddReplyTo($admin_email);
                    // $mailer->Send();

                    $mailTc->setEmailSubject($assunto);
                    $mailTc->addToEmailBody($mensagem);
                    $mailTc->setEmailFrom($admin_email);
                    $mailTc->addEmailDest($destinatario);
                    $resultado = $mailTc->sendMail();
                }

            }

        }
        if(strlen($msg_erro) == 0 AND in_array($login_fabrica, [90]) AND $xenvia_email == "'t'") {
            $assunto = "Serviço de Atendimento ao Consumidor IBBL - $callcenter ";

            $mensagem = "Sr.(a) $consumidor_nome. <br><br>
                        O seu atendimento registrado através do protocolo ($callcenter) foi atualizado.<br><br>

                        <b> Mensagem: $resposta </b> <br><br>

                        Caso precise de alguma informação adicional por favor nos contate através do telefone 0800 725 4225.
                        Ficamos à sua disposição.<br><br>
                        Serviço de Atendimento ao Consumidor IBBL. ";

            $mailTc = new TcComm($externalId);
            $res = $mailTc->sendMail(
                $consumidor_email,
                $assunto,
                $mensagem,
                $externalEmail
            );
        }

        if (strlen($msg_erro) == 0) {
            $sql = "UPDATE tbl_hd_chamado set status = $xstatus_interacao ";

            if ($login_fabrica == 24) {//HD 262718

                $assunto_vazio = 0;
                $tot_campos = count($_POST['callcenter_assunto']);
                foreach ($_POST['callcenter_assunto'] as $campo => $valor) {
                    if (strlen($valor)==0) {
                        $assunto_vazio++;
                    }elseif ($assunto_vazio > 0) {
                        $assunto_vazio --;
                    }elseif(!empty($valor)){
                        $callcenter_assunto = $valor;
                    }
                }

                if ($assunto_vazio == $tot_campos){
                    $msg_erro = "Insira o assunto do atendimento";
                }

                if (empty($msg_erro)){
                    $sql .= " , categoria = '$callcenter_assunto' ";
                }

            }else{
                $sql .= " , categoria = '$tab_atual' ";
            }

            $sql .= " WHERE tbl_hd_chamado.fabrica_responsavel = $login_fabrica
                and tbl_hd_chamado.hd_chamado = $callcenter ";
            $res       = pg_query($con,$sql);
            $msg_erro .= pg_errormessage($con);

            if (strlen($intervensor) > 0 AND strlen($hd_chamado) > 0 AND ($login_admin <> $intervensor) AND ($xtransferir <> $intervensor)) {
                $sql = "UPDATE tbl_hd_chamado set sequencia_atendimento = $intervensor
                    WHERE tbl_hd_chamado.fabrica_responsavel = $login_fabrica
                    and tbl_hd_chamado.hd_chamado = $hd_chamado ";

                $res = pg_query($con,$sql);
                $msg_erro .= pg_errormessage($con);

                $sql = "SELECT login,email from tbl_admin where admin = $ultimo_atendente";
                $res = pg_query($con, $sql);

                $nome_ultimo_atendente  = pg_fetch_result($res, 0, 'login');
                $email_ultimo_atendente = pg_fetch_result($res, 0, 'email');

                $sql = "SELECT login,email from tbl_admin where admin = $intervensor";
                $res = pg_query($con, $sql);

                $nome_intervensor  = pg_fetch_result($res, 0, 'login');
                $email_intervensor = pg_fetch_result($res, 0, 'email');

                $sql = "INSERT INTO tbl_hd_chamado_item(
                        hd_chamado   ,
                        data         ,
                        comentario   ,
                        admin        ,
                        interno      ,
                        status_item
                    ) values (
                        $callcenter       ,
                        current_timestamp ,
                        E'O Atendente <b>$login_login</b> precisou da intenvencão do <b>$nome_intervensor</b> para resolver este atendimento',
                        $login_admin      ,
                        't'  ,
                        $xstatus_interacao
                    )";

                $res = pg_query($con,$sql);
                $msg_erro .= pg_errormessage($con);

                if (strlen($email_ultimo_atendente) > 0 AND strlen($email_intervensor) > 0) {

                    $assunto = "O Atendente $login_login, precisou de sua intervenção no chamado $callcenter";

                    if ($login_fabrica == 24 || $login_fabrica == 11 || $login_fabrica == 172) {

                        $sql = " SELECT  tbl_hd_chamado_extra.nome       ,
                            tbl_hd_chamado_extra.endereco   ,
                            tbl_hd_chamado_extra.numero     ,
                            tbl_hd_chamado_extra.complemento,
                            tbl_hd_chamado_extra.bairro     ,
                            tbl_hd_chamado_extra.cep        ,
                            tbl_hd_chamado_extra.fone       ,
                            tbl_hd_chamado_extra.email      ,
                            tbl_hd_chamado_extra.cpf        ,
                            tbl_hd_chamado_extra.rg         ,
                            tbl_hd_chamado.categoria  ,
                            tbl_hd_chamado_extra.reclamado  ,
                            tbl_cidade.nome as cidade,
                            tbl_cidade.estado         ,
                            tbl_produto.referencia    ,
                            tbl_produto.descricao
                            FROM tbl_hd_chamado
                            JOIN tbl_hd_chamado_extra USING(hd_chamado)
                            JOIN tbl_cidade           USING(cidade)
                            LEFT JOIN tbl_produto     USING(produto)
                            WHERE tbl_hd_chamado.hd_chamado = $callcenter";

                        $res = pg_query($con,$sql);

                        if (pg_num_rows($res) > 0) {

                            $nome        = pg_fetch_result($res, 0, 'nome');
                            $endereco    = pg_fetch_result($res, 0, 'endereco');
                            $numero      = pg_fetch_result($res, 0, 'numero');
                            $bairro      = pg_fetch_result($res, 0, 'bairro');
                            $cep         = pg_fetch_result($res, 0, 'cep');
                            $fone        = pg_fetch_result($res, 0, 'fone');
                            $email       = pg_fetch_result($res, 0, 'email');
                            $categoria   = pg_fetch_result($res, 0, 'categoria');
                            $cidade_nome = pg_fetch_result($res, 0, 'cidade');
                            $estado      = pg_fetch_result($res, 0, 'estado');
                            $reclamado   = pg_fetch_result($res, 0, 'reclamado');
                            $referencia  = @pg_fetch_result($res, 0, 'referencia');
                            $descricao   = @pg_fetch_result($res, 0, 'descricao');

                            //HD 235203: Colocar vários assuntos para a Suggar
                            $achou_categoria_assunto = false;

                            foreach ($assuntos as $categoria_assunto => $itens_categoria_assunto) {

                                foreach ($itens_categoria_assunto as $label_assunto => $bd_assunto) {

                                    if ($bd_assunto == $categoria) {
                                        $categoria               = $label_assunto;
                                        $achou_categoria_assunto = true;
                                    }

                                }

                            }

                            if ($achou_categoria_assunto == false) {

                                if ($categoria == 'reclamacao_produto') $categoria = "Reclamação do Produto";
                                if ($categoria == "duvida_produto")     $categoria = "Dúvida do Produto";
                                if ($categoria == "reclamacao_at")      $categoria = "Reclamação da Assistência Técnica";
                                if ($categoria == "sugestao")           $categoria = "Sugestão";
                                if ($categoria == "reclamacao_empresa") $categoria = "Reclamação da Empresa";
                                if ($categoria == "procon")             $categoria = "Procon";
                                if ($categoria == "onde_comprar")       $categoria = "Onde comprar";

                            }

                        }

                    }

                    if (strtoupper($status_interacao) == 'RESOLVIDO' || ($login_fabrica == 74 && $status_interacao == "PROTOCOLO DE INFORMACAO")) {//HD 226230
                        $corpo = "<P align='left'><STRONG>Chamado finalizado</STRONG> </P>
                            <P align='left'>".ucwords($nome_atendente).",</P>
                            <P align='justify'>
                            O atendimento $callcenter foi concluído por <b>$nome_ultimo_atendente</b>
                            </P>";
                    } else {
                        $corpo = "<P align='left'><STRONG>Nota: Este e-mail gerado automaticamente. **** POR FAVOR NÃO RESPONDA ESTA MENSAGEM ****.</STRONG> </P>
                            <P align='left'>$nome_atendente,</P>
                            <P align='justify'>
                            O atendimento $callcenter foi transferido por <b>$login_login</b> de <b>$nome_ultimo_atendente</b> para você
                            </P>";
                    }

                    if (in_array($login_fabrica,array(11,24,85,151,172))){

                        $corpo .= "<p align='justify'>Informação do atendimento:</p>";
                        $corpo .= "<p align='justify'>Nome do consumidor: $nome&nbsp;&nbsp;Telefone: $fone</p>";
                        $corpo .= "<p align='justify'>E-mail: $email</p>";
                        $corpo .= "<p align='justify'>Endereço:$endereco&nbsp;$numero - $bairro - $cidade_nome - $estado CEP: $cep</p>";
                        $corpo .= "<p align='justify'>Tipo de atendimento: $categoria</p>";

                        if (strlen($referencia) > 0) {
                            $corpo .="<p align='justify'>Produto: $referencia - $descricao</p>";
                        }

                        $corpo .= "<p align='justify'>Descrição: $reclamado</p>";

                    }

                    //HD 190736 - Link para chamado no corpo do e-mail
                    $corpo .= "<p>Segue abaixo link para acesso ao chamado:</p><p align='justify'><a href='http://posvenda.telecontrol.com.br/assist/admin/callcenter_interativo_new.php?callcenter=$callcenter'>http://posvenda.telecontrol.com.br/assist/admin/callcenter_interativo_new.php?callcenter=$callcenter</a>";
                    // HD 112313 (augusto) - Problema no cabeçalho do email, removidas partes com problema;
                    $headers  = "MIME-Version: 1.0 \r\n";
                    $headers .= "Content-type: text/html \r\n";
                    $headers .= "From: Telecontrol Networking <helpdesk@telecontrol.com.br> \r\n";

                    #$email_intervensor = "ronald.santos@telecontrol.com.br";
                        $mailTc = new TcComm($externalId);
                        $res = $mailTc->sendMail(
                            $email_intervensor,
                            $assunto,
                            $corpo,
                $externalEmail
            );

                        #if (mail($email_intervensor, $assunto, $corpo, $headers)) {
                        #   $msg = "<br>Foi enviado um email para: ".$email_atendente."<br>";
                        #}
                }

            }

            if (in_array($login_fabrica,array(11,24,85,151,172))){
                $sql = "SELECT atendente, sequencia_atendimento from tbl_hd_chamado where hd_chamado = $callcenter";
                $res = pg_query($con,$sql);

                if (pg_num_rows($res) > 0) {
                    $atendente_chamado   = pg_result($res, 0, 0);
                    $intervensor_chamado = pg_result($res, 0, 1);

                    if($login_admin <> $atendente_chamado AND empty($msg_erro) AND !empty($ultimo_atendente)){
                        $sql = "SELECT login,email from tbl_admin where admin = $ultimo_atendente";
                        $res = pg_query($con, $sql);

                        $nome_ultimo_atendente  = pg_fetch_result($res, 0, 'login');
                        $email_ultimo_atendente = pg_fetch_result($res, 0, 'email');
                        $link_atendimento = "<a href='http://posvenda.telecontrol.com.br/assist/admin/callcenter_interativo_new.php?callcenter={$callcenter}'>{$callcenter}</a>";
                        $assunto  = "Informação do atendimento: $callcenter";
                        $corpo    = "<p align='justify'>O atendimento $link_atendimento recebeu uma interação de $login_login</p>";
                        $headers  = "MIME-Version: 1.0 \r\n";
                        $headers .= "Content-type: text/html \r\n";
                        $headers .= "From: Telecontrol Networking <helpdesk@telecontrol.com.br> \r\n";

                        $mailTc = new TcComm($externalId);
                            $res = $mailTc->sendMail(
                                        $email_ultimo_atendente,
                                        $assunto,
                                        $corpo,
                            $externalEmail
                        );

                    }
                }

                if($xtransferir){
                    if (($intervensor_chamado == $login_admin) AND ($atendente_chamado <> $xtransferir)) {
                        $msg_erro = "O interventor pode transferir o chamado apenas para o responsável do atendimento";
                    }

                    if ($intervensor_chamado == $login_admin && strlen($msg_erro) == 0) {
                        $sql = "UPDATE tbl_hd_chamado set sequencia_atendimento = null
                            WHERE tbl_hd_chamado.fabrica_responsavel = $login_fabrica
                            and tbl_hd_chamado.hd_chamado = $callcenter";

                        $res = pg_query($con,$sql);
                        $msg_erro .= pg_errormessage($con);
                    }
                }

            } else {
                $intervensor_chamado = '0';
            }

            if ($login_fabrica == 74 AND !empty($callcenter) and is_int($callcenter)){

                $sql = "
                    SELECT admin
                    FROM tbl_hd_chamado
                    WHERE hd_chamado = $callcenter
                    ";
                $res = pg_query($con,$sql);
                //echo nl2br($sql);
                if(pg_num_rows($res) > 0) $admin = pg_fetch_result($res,0,0);
                if ($admin == 6437 ) {
                    $novo_admin = $login_admin;
                    if ($admin <> $novo_admin) {

                        $sql = "UPDATE tbl_hd_chamado set
                            admin = $novo_admin,
                            categoria = '$tab_atual'
                            WHERE tbl_hd_chamado.fabrica_responsavel = $login_fabrica
                            and tbl_hd_chamado.hd_chamado = $callcenter ";

                        $res = pg_query($con,$sql);
                        $msg_erro .= pg_errormessage($con);
                    }
                }
            }

            if (isset($novaTelaOs)) {
                $sql = "UPDATE tbl_hd_chamado set
                    categoria = '$tab_atual'
                    WHERE tbl_hd_chamado.fabrica_responsavel = $login_fabrica
                    and tbl_hd_chamado.hd_chamado = $callcenter ";

                $res = pg_query($con,$sql);
                $msg_erro .= pg_errormessage($con);
            }

            // echo $ultimo_atendente." - ".$xtransferir; exit;

            if (($ultimo_atendente <> $xtransferir) AND !empty($xtransferir) AND strlen($msg_erro) == 0) {
                $sql = "UPDATE tbl_hd_chamado set atendente = $xtransferir
                    WHERE tbl_hd_chamado.fabrica_responsavel = $login_fabrica
                    and tbl_hd_chamado.hd_chamado = $callcenter ";
                $res = pg_query($con,$sql);

                # HD 35488
                # Marca HD como pendente
                if ($login_fabrica == 51) {

                    $sql = "UPDATE tbl_hd_chamado_extra set leitura_pendente = 't' WHERE hd_chamado = $callcenter   ";
                    $res = pg_query($con,$sql);
                    $msg_erro .= pg_errormessage($con);

                }

                if($login_fabrica != 74 AND !empty($ultimo_atendente) AND !empty($xtransferir)){
                    $sql = "SELECT login,email,nome_completo from tbl_admin where admin = $ultimo_atendente";
                    $res = pg_query($con, $sql);
                    $msg_erro .= pg_errormessage($con);

                    if (in_array($login_fabrica, array(169,170))){
                        $nome_ultimo_atendente  = pg_fetch_result($res,0, 'nome_completo');
                    }else{
                        $nome_ultimo_atendente  = pg_fetch_result($res,0, 'login');
                    }
                    $email_ultimo_atendente = pg_fetch_result($res,0, 'email');


                    $sql = "SELECT login,email,nome_completo from tbl_admin where admin = $xtransferir";
                    $res = pg_query($con, $sql);

                    if (in_array($login_fabrica, array(169,170))){
                        $nome_atendente  = pg_fetch_result($res, 0, 'nome_completo');
                    }else{
                        $nome_atendente  = pg_fetch_result($res, 0, 'login');
                    }
                    $email_atendente = pg_fetch_result($res, 0, 'email');

                    if (in_array($login_fabrica, array(169,170))){
                        $mensage_transferir = "Atendimento transferido por <b>$login_nome_completo</b> de <b>$nome_ultimo_atendente</b> para <b>$nome_atendente</b>";
                    }else{
                        $mensage_transferir = "Atendimento transferido por <b>$login_login</b> de <b>$nome_ultimo_atendente</b> para <b>$nome_atendente</b>";
                    }

                    $sql = "INSERT INTO tbl_hd_chamado_item(
                        hd_chamado   ,
                        data         ,
                        comentario   ,
                        admin        ,
                        interno      ,
                        status_item  ,
                        admin_transferencia
                    ) values (
                        $callcenter       ,
                        current_timestamp ,
                        E'$mensage_transferir',
                        $login_admin      ,
                        't'  ,
                        $xstatus_interacao,
                        $xtransferir
                    ) RETURNING hd_chamado_item";
                    $res = pg_query($con, $sql);
                    $msg_erro .= pg_errormessage($con);
                    if ($login_fabrica == 189 && verifica_origem_atendimento($_POST["origem"]) == "producao" && strlen($msg_erro) == 0) {
                        $hd_chamado_item = pg_fetch_result($res, 0, 'hd_chamado_item');
                        grava_chamado_item_externo($hd_chamado, $hd_chamado_item);
                    }

                }

                if (strlen($email_ultimo_atendente) > 0 AND strlen($email_atendente) > 0) {
                    $assunto = "O atendimento $callcenter foi transferido por $login_login para você";

                    if ($login_fabrica == 24) {

                        $sql = " SELECT  tbl_hd_chamado_extra.nome       ,
                            tbl_hd_chamado_extra.endereco   ,
                            tbl_hd_chamado_extra.numero     ,
                            tbl_hd_chamado_extra.complemento,
                            tbl_hd_chamado_extra.bairro     ,
                            tbl_hd_chamado_extra.cep        ,
                            tbl_hd_chamado_extra.fone       ,
                            tbl_hd_chamado_extra.email      ,
                            tbl_hd_chamado_extra.cpf        ,
                            tbl_hd_chamado_extra.rg         ,
                            tbl_hd_chamado.categoria  ,
                            tbl_hd_chamado_extra.reclamado  ,
                            tbl_cidade.nome as cidade,
                            tbl_cidade.estado         ,
                            tbl_produto.referencia    ,
                            tbl_produto.descricao
                            FROM tbl_hd_chamado
                            JOIN tbl_hd_chamado_extra USING(hd_chamado)
                            JOIN tbl_cidade           USING(cidade)
                            LEFT JOIN tbl_produto     USING(produto)
                            WHERE tbl_hd_chamado.hd_chamado = $callcenter";

                        $res = pg_query($con, $sql);

                        if (pg_num_rows($res) > 0) {

                            $nome        = pg_fetch_result($res, 0, 'nome');
                            $endereco    = pg_fetch_result($res, 0, 'endereco');
                            $numero      = pg_fetch_result($res, 0, 'numero');
                            $bairro      = pg_fetch_result($res, 0, 'bairro');
                            $cep         = pg_fetch_result($res, 0, 'cep');
                            $fone        = pg_fetch_result($res, 0, 'fone');
                            $email       = pg_fetch_result($res, 0, 'email');
                            $categoria   = pg_fetch_result($res, 0, 'categoria');
                            $cidade_nome = pg_fetch_result($res, 0, 'cidade');
                            $estado      = pg_fetch_result($res, 0, 'estado');
                            $reclamado   = pg_fetch_result($res, 0, 'reclamado');
                            $referencia  = @pg_fetch_result($res, 0, 'referencia');
                            $descricao   = @pg_fetch_result($res, 0, 'descricao');

                            //HD 235203: Colocar vários assuntos para a Suggar
                            $achou_categoria_assunto = false;

                            foreach ($assuntos as $categoria_assunto => $itens_categoria_assunto) {

                                foreach ($itens_categoria_assunto as $label_assunto => $bd_assunto) {

                                    if ($bd_assunto == $categoria) {
                                        $categoria = $label_assunto;
                                        $achou_categoria_assunto = true;
                                    }

                                }

                            }

                            if ($achou_categoria_assunto == false) {

                                if ($categoria == 'reclamacao_produto') $categoria = "Reclamação do Produto";
                                if ($categoria == "duvida_produto")     $categoria = "Dúvida do Produto";
                                if ($categoria == "reclamacao_at")      $categoria = "Reclamação da Assistência Técnica";
                                if ($categoria == "sugestao")           $categoria = "Sugestão";
                                if ($categoria == "reclamacao_empresa") $categoria = "Reclamação da Empresa";
                                if ($categoria == "procon")             $categoria = "Procon";
                                if ($categoria == "onde_comprar")       $categoria = "Onde comprar";

                            }

                        }

                    }

                    if (strtoupper($status_interacao) == 'RESOLVIDO' || ($login_fabrica == 74 && $status_interacao == "PROTOCOLO DE INFORMACAO")) {//HD 226230
                        $corpo = "<P align=left><STRONG>Chamado finalizado</STRONG> </P>
                            <P align=left>".ucwords($nome_atendente).",</P>
                            <P align=justify>
                            O atendimento $callcenter foi concluÃ­do por <b>$nome_ultimo_atendente</b>
                            </P>";
                    } else {
                        $corpo = "<P align=left><STRONG>Nota: Este e-mail gerado automaticamente. **** POR FAVOR NÃO RESPONDA ESTA MENSAGEM ****.</STRONG> </P>
                            <P align=left>$nome_atendente,</P>
                            <P align=justify>
                            O atendimento $callcenter foi transferido por <b>$login_login</b> de <b>$nome_ultimo_atendente</b> para você
                            </P>";
                    }

                    if ($login_fabrica == 24) {

                        $corpo .= "<p align=justify>Informação do atendimento:</p>";
                        $corpo .= "<p align=justify>Nome do consumidor: $nome&nbsp;&nbsp;Telefone: $fone</p>";
                        $corpo .= "<p align=justify>E-mail: $email</p>";
                        $corpo .= "<p align=justify>Endereço:$endereco&nbsp;$numero - $bairro - $cidade_nome - $estado CEP: $cep</p>";
                        $corpo .= "<p align=justify>Tipo de atendimento: $categoria</p>";

                        if (strlen($referencia) > 0) {
                            $corpo .="<p align=justify>Produto: $referencia - $descricao</p>";
                        }

                        $corpo .= "<p align=justify>Descrição: $reclamado</p>";

                    }

                    //HD 190736 - Link para chamado no corpo do e-mail
                    $corpo .= "<p>Segue abaixo link para acesso ao chamado:</p><p align=justify><a href='http://posvenda.telecontrol.com.br/assist/admin/callcenter_interativo_new.php?callcenter=$callcenter'>http://posvenda.telecontrol.com.br/assist/admin/callcenter_interativo_new.php?callcenter=$callcenter</a>";

                    if (strlen($msg_erro) == 0) {

                        $headers  = "MIME-Version: 1.0 \r\n";
                        $headers .= "Content-type: text/html \r\n";
                        $headers .= "From: Telecontrol Networking <helpdesk@telecontrol.com.br> \r\n";
                            $mailTc = new TcComm($externalId);
                            $res = $mailTc->sendMail(
                                $email_atendente,
                                $assunto,
                                $corpo,
                                $externalEmail
                            );

                    }

                }

            }

                    if($login_fabrica == 74 && strlen($xtransferir) == 0){

                        $transferencia = (strlen($_POST["atendente_transferencia"]) > 0) ? true : false;

                        if($transferencia == true){

                            $xtransferir = $login_admin;

                            $sql = "UPDATE tbl_hd_chamado set atendente = $xtransferir
                                WHERE tbl_hd_chamado.fabrica_responsavel = $login_fabrica
                                and tbl_hd_chamado.hd_chamado = $callcenter ";

                            $res = pg_query($con,$sql);
                            $msg_erro .= pg_errormessage($con);

                        }

                    }
        }

                    if($login_fabrica == 125 and $consumidor_revenda == "R"){
                        $tel_fixo_revenda       = $_POST["tel_fixo_revenda"];
                        $cel_revenda            = $_POST["cel_revenda"];

                        if((strlen(trim($tel_fixo_revenda))==0) and (strlen(trim($cel_revenda))==0)){
                            $msg_erro .= "Informe um telefone de contato para revenda. <br>";
                        }

                        if(strlen(trim($nome_revenda))==0){
                            $msg_erro .= "Informe o Nome da Revenda. <br>";
                        }

                        if(strlen(trim($responsavel_revenda))==0){
                            $msg_erro .= "Informe um responsável. <br>";
                        }

                    }
                    //hd 14231 22/2/2008
                    if (strlen($msg_erro) == 0) {
                        if (strlen($hd_chamado) > 0 && (($login_fabrica != 11 && $login_fabrica != 172) || ($xstatus_interacao == "'Aberto'" or strlen($protocolo) > 0))) {//*ja tem cadastro no telecontrol/
                            $xserie       = (empty($_POST['serie']))       ? 'null' : "'".pg_escape_string($_POST['serie'])."'" ;
                            $xnota_fiscal = (empty($_POST['nota_fiscal'])) ? '' : pg_escape_string($_POST['nota_fiscal']) ;
                            if (empty($_POST['data_nf'])){
                                $xdata_nf = "null";
                            }else{
                                list($ddf, $mdf, $ydf) = explode("/", $_POST['data_nf']);
                                if(!checkdate($mdf,$ddf,$ydf)) {
                                    $msg_erro = "Data NF Inválida <br>";
                                }else{
                                    $xdata_nf = "'".$ydf.'-'.$mdf.'-'.$ddf."'";
                                }
                            }

                            if($login_fabrica == 30){
                                $motivo_situacao = $_POST['motivo_situacao'];
                                if(empty($motivo_situacao)){
                                    $msg_erro = "Informe o motivo por este atendimento estar em aberto";
                                }else{
                                    $cond_motivo_situacao = ", hd_situacao = $motivo_situacao ";
                                }
                            }

                            if($login_fabrica == 162){ //HD-3352176
                                $motivo_situacao = $_POST['motivo_situacao'];

                                if(strlen($transferir) > 0){
                                    if(empty($motivo_situacao)){
                                        $msg_erro = "Informe o motivo da transferência deste atendimento";
                                    }
                                }
                                if(strlen(trim($motivo_situacao)) > 0){
                                    $cond_motivo_situacao = ", hd_situacao = $motivo_situacao ";
                                }else{
                                    $cond_motivo_situacao = ", hd_situacao = null ";
                                }
                            }

                            $sql = "SELECT  tbl_hd_chamado.hd_chamado,
                                tbl_hd_chamado.status
                                    FROM tbl_hd_chamado
                                    JOIN tbl_hd_chamado_extra USING(hd_chamado)
                                    where tbl_hd_chamado.hd_chamado = $hd_chamado";

                            $res = pg_query($con,$sql);
                            $msg_erro .= pg_last_error();

                            if (pg_num_rows($res) > 0) {

                                $xhd_chamado = pg_result($res, 0, 0);
                                $xstatus     = pg_fetch_result($res, 0, 'status');

                                if (empty($msg_erro)){

                                    $xcodigo_posto = ($xcodigo_posto == 'null') ? $mr_codigo_posto : $xcodigo_posto;
                                    $xcodigo_posto = ($xcodigo_posto == '') ? 'null' : $xcodigo_posto;
                                    $marca = ($marca == '') ? 'null' : $marca;

                                    if (in_array($login_fabrica, array(169,170))) {
                                        $xcodigo_posto = (!empty($posto_tab)) ? $posto_tab : $xcodigo_posto;
                                    }

                                    if (in_array($login_fabrica,array(15,24,30,85,141)) and !empty($hd_chamado)) {
                                        $sql = "SELECT array_campos_adicionais FROM tbl_hd_chamado_extra WHERE hd_chamado = $xhd_chamado";
                                        $res = pg_query($con, $sql);
                                        $msg_erro .= pg_last_error();

                                        $array_campos_adicionais = json_decode(pg_fetch_result($res, 0, "array_campos_adicionais"), true);

                                        if ($login_fabrica == 85) {
                                            if ($atendimento_ambev == "t") {
                                                $array_campos_adicionais["atendimento_ambev"]       = $atendimento_ambev;
                                                $array_campos_adicionais["codigo_ambev"]            = $codigo_ambev;
                                                $array_campos_adicionais["data_fabricacao_ambev"]   = $data_fabricacao_ambev;
                                                $array_campos_adicionais["data_previsao_ambev"]     = $data_previsao_ambev;
                                                $array_campos_adicionais["data_encerramento_ambev"] = $data_encerramento_ambev;
                                                $array_campos_adicionais["atendimento_ambev_nome"]  = $atendimento_ambev_nome;
                                                $array_campos_adicionais["garantia_estendida_ambev"]  = $garantia_estendida_ambev;

                                            } else {
                                                $array_campos_adicionais["atendimento_ambev"]       = "f";
                                                $array_campos_adicionais["codigo_ambev"]            = "";
                                                $array_campos_adicionais["data_fabricacao_ambev"]   = $data_fabricacao_ambev;
                                                $array_campos_adicionais["data_previsao_ambev"]     = $data_previsao_ambev;
                                                $array_campos_adicionais["data_encerramento_ambev"] = "";
                                                $array_campos_adicionais["atendimento_ambev_nome"]  = $atendimento_ambev_nome;
                                                $array_campos_adicionais["garantia_estendida_ambev"]  = $garantia_estendida_ambev;

                                            }

                                            $array_campos_adicionais["atendimento_contratual"] = $atendimento_contratual;
                                            $array_campos_adicionais["garantia_contratual"]    = $garantia_contratual_cliente;

                                            if ($array_campos_adicionais["consumidor_cpf_cnpj"] == "R") {
                                                $array_campos_adicionais["nome_fantasia"] = utf8_encode($nome_fantasia);
                                            } else {
                                                $array_campos_adicionais["nome_fantasia"] = "";
                                            }

                                            $bonificacao = filter_input(INPUT_POST,'bonificacao');

                                            if ($bonificacao == 't') {
                                                $array_campos_adicionais['bonificacao'] = TRUE;
                                                $array_campos_adicionais['bonificacao_admin'] = $login_admin;

                                                $comentario = "Foi disponibilizado bonificação por serviço diferenciado para a OS $xos.";

                                                $sql = "INSERT INTO tbl_hd_chamado_item(
                                                    hd_chamado   ,
                                                    data         ,
                                                    comentario   ,
                                                    admin        ,
                                                    interno      ,
                                                    status_item
                                                ) values (
                                                    $hd_chamado,
                                                    current_timestamp ,
                                                    E'$comentario',
                                                    $login_admin,
                                                    't',
                                                    $xstatus_interacao
                                                )";
                                                $res = pg_query($con,$sql);

                                                $sqlOsValorAd = "

                                                    SELECT  JSON_FIELD('servicoDiferenciado',tbl_fabrica.parametros_adicionais) AS bonificacao
                                                    FROM    tbl_fabrica
                                                    WHERE   fabrica = $login_fabrica
                                                ";
                                                $resOsValorAd = pg_query($con,$sqlOsValorAd);
                                                $bonificacao = pg_fetch_result($resOsValorAd,0,bonificacao);

                                                $sql = "SELECT COUNT(1) AS valor_bonificacao FROM tbl_os_campo_extra WHERE os = $xos";
                                                $res = pg_query($con,$sql);
                                                $valor_bonificacao = pg_fetch_result($res,0,valor_bonificacao);

                                                if ($valor_bonificacao == 0) {
                                                    $sqlValorAdHis = "
                                                        INSERT INTO tbl_os_campo_extra (
                                                            os,
                                                            fabrica,
                                                            valores_adicionais
                                                        ) VALUES (
                                                            $xos,
                                                            $login_fabrica,
                                                            E'".json_encode(array("servicoDiferenciado"=>(float)$bonificacao))."'
                                                        )
                                                    ";
                                                } else {
                                                    $sqlValorAdHis = "
                                                        UPDATE  tbl_os_campo_extra
                                                        SET     valores_adicionais = E'".json_encode(array("servicoDiferenciado"=>(float)$bonificacao))."'
                                                        WHERE   os = $xos
                                                    ";
                                                }
                                                $resValorAdHis = pg_query($con,$sqlValorAdHis);
                                            } else if ($bonificacao == "" && !filter_input(INPUT_POST,'sem_bonificacao')) {
                                                $array_campos_adicionais['bonificacao'] = "";

                                                $comentario = "Foi retirada bonificação por serviço diferenciado para a OS $xos.";

                                                $sql = "INSERT INTO tbl_hd_chamado_item(
                                                    hd_chamado   ,
                                                    data         ,
                                                    comentario   ,
                                                    admin        ,
                                                    interno      ,
                                                    status_item
                                                ) values (
                                                    $hd_chamado,
                                                    current_timestamp ,
                                                    E'$comentario',
                                                    $login_admin,
                                                    't',
                                                    $xstatus_interacao
                                                )";
                                                $res = pg_query($con,$sql);

                                                $sqlOsValorAd = "UPDATE tbl_os SET valores_adicionais = NULL WHERE os = $xos";

                                                $resOsValorAd = pg_query($con,$sqlOsValorAd);

                                                $sqlValorAdHis = "
                                                    UPDATE  tbl_os_campo_extra
                                                    SET     valores_adicionais = NULL
                                                    WHERE   os = $xos
                                                ";
                                                $resValorAdHis = pg_query($con,$sqlValorAdHis);
                                            }
                                        }

                                        if ($login_fabrica == 24) {
                                            if( array_key_exists("ligacao_agendada", $array_campos_adicionais)){
                                                $array_campos_adicionais["ligacao_agendada"] = $aux_ligacao_agendada;
                                            }else{

                                                $array_campos_adicionais = array("ligacao_agendada" => $aux_ligacao_agendada);
                                            }

                                        }
                                        if ($login_fabrica == 15) {
                                            if( array_key_exists("data_retorno", $array_campos_adicionais)){
                                                $array_campos_adicionais["data_retorno"] = $aux_data_retorno;
                                            }else{

                                                $array_campos_adicionais = array("data_retorno" => $aux_data_retorno);
                                            }
                                        }

                                        if($login_fabrica == 30){ # HD-2902269
                                            $array_campos_adicionais["data_limite"]         = $data_limite;
                                            $array_campos_adicionais["data_programada"]     = $data_programada;
                                            $array_campos_adicionais['admin_agendamento']   = $login_admin;

                                            if (!empty(trim($obs_sac_adicionais))) {
                                                $array_campos_adicionais['observacao_sac'] = utf8_encode($obs_sac_adicionais);
                                            } else {
                                                $sqlOpt = "
                                                    SELECT  JSON_FIELD('observacao_sac',parametros_adicionais) AS observacao_sac
                                                    FROM    tbl_admin
                                                    WHERE   admin = $login_admin
                                                ";
                                                $resOpt = pg_query($con,$sqlOpt);
                                                $observacao_sac = pg_fetch_result($resOpt,0,observacao_sac);

                                                if ($observacao_sac == 't' && $tab_atual == 'reclamacao_produto') {
                                                    $msg_erro .= "Você deve preencher o campo Observação SAC <br />";
                                                }
                                            }

                                            $data_recebimento   = $_POST['data_recebimento'];
                                            $data_fatal         = $_POST['data_fatal'];

                                            if(strlen($data_recebimento) > 0 OR strlen($data_fatal) > 0){
                                                if(strlen($data_recebimento) > 0){
                                                    list($drd,$drm,$dra) = explode("/",$data_recebimento);
                                                    $xdata_recebimento = $dra."-".$drm."-".$drd;
                                                }
                                                if(strlen($data_fatal) > 0 ){
                                                    list($dfd,$dfm,$dfa) = explode("/",$data_fatal);
                                                    $xdata_fatal = $dfa."-".$dfm."-".$dfd;
                                                }

                                                if(strlen($data_nf) > 0){
                                                    list($dnd,$dnm,$dna) = explode("/",$data_nf);
                                                    $xdata_nf = "'".$dna.'-'.$dnm.'-'.$dnd."'";
                                                }

                                                if(strlen($data_recebimento) > 0 AND strlen($data_fatal) > 0){
                                                    if (strtotime($xdata_recebimento) > strtotime($xdata_fatal)) {
                                                        $msg_erro .= "Data fatal não pode ser menor que data recebimento <br/>";
                                                    }
                                                }

                                                if(strlen($data_recebimento) > 0 AND strlen($data_nf) > 0){
                                                    if (strtotime($xdata_recebimento) < strtotime($xdata_nf)) {
                                                        $msg_erro .= "Data recebimento não pode ser menor que data da nota fiscal <br/>";
                                                    }
                                                }

                                                if(strlen($data_fatal) > 0 AND strlen($data_nf) > 0){
                                                    if (strtotime($xdata_fatal) < strtotime($xdata_nf)) {
                                                        $msg_erro .= "Data fatal não pode ser menor que data da nota fiscal <br/>";
                                                    }
                                                }
                                            }

                                            if ($_POST['numero_sr']) $array_campos_adicionais['numero_sr']                  = $_POST['numero_sr'];
                                            if ($_POST['numero_process']) $array_campos_adicionais['numero_process']        = $_POST['numero_process'];
                                            if ($_POST['data_recebimento']) $array_campos_adicionais['data_recebimento']    = $_POST['data_recebimento'];
                                            if ($_POST['data_fatal']) $array_campos_adicionais['data_fatal']                = $_POST['data_fatal'];
                                            if ($_POST['info_notificado']) $array_campos_adicionais['info_notificado']      = $_POST['info_notificado'];
                                            if ($_POST['nota_consumidor']) $array_campos_adicionais['nota_consumidor']      = $_POST['nota_consumidor'];
                                            if ($_POST['id_reclamacao']) $array_campos_adicionais['id_reclamacao']          = $_POST['id_reclamacao'];
                                        }

                                        if (in_array($login_fabrica, array(141))) {
                                            if (!empty(trim($obs_sac_adicionais))) {
                                                $array_campos_adicionais['observacao_sac'] = utf8_encode($obs_sac_adicionais);
                                            }
                                        }

                                        if (!in_array($login_fabrica,array(15,30))){
                                            $array_campos_adicionais["voltagem"] = $voltagem;
                                        }

                                        $array_campos_adicionais = json_encode($array_campos_adicionais);


                                    } else if($login_fabrica >= 138 && !in_array($login_fabrica, array(153,166,167,172,186,183,190,203))) {

										$encode = array();

										if(!empty($voltagem)) {
											$encode['voltagem'] = $voltagem;
										}

										if(!empty($consumidor_pais)) {
											$encode['pais'] = $consumidor_pais;
										}

                                        if($login_fabrica == 158){
                                            $encode['tensao'] = $_POST['tensao'];
                                            $encode['tempo_instalacao'] = $_POST['tempo_instalacao'];
                                        }

                                        if($login_fabrica == 164){

                                            $encode["tentativas_contato"] = $_POST["tentativas_contato"];
                                            $encode["genero"]             = $_POST["genero"];
                                            $encode["faixa_etaria"]       = $_POST["faixa_etaria"];

                                        }

                                        $array_campos_adicionais = json_encode($encode);
                                    }

                                    if ($login_fabrica == 156) {

                                        if ($_POST['responsavel_nome'] or $_POST['responsavel_fone']) {
                                            if ($array_campos_adicionais === "''")
                                                $array_campos_adicionais = array();
                                            if (!is_array($array_campos_adicionais)) {
                                                $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                                            }
                                            if ($_POST['responsavel_nome']) $array_campos_adicionais['responsavel']     = $_POST['responsavel_nome'];
                                            if ($_POST['responsavel_fone']) $array_campos_adicionais['tel_responsavel'] = $_POST['responsavel_fone'];
                                            $array_campos_adicionais = pg_escape_string($con, json_encode(array_map('utf8_encode', $array_campos_adicionais)));
                                        }

                                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                                        $array_campos_adicionais['tipo_atendimento'] = $tipo_atendimento_elgin;
                                        $array_campos_adicionais = json_encode($array_campos_adicionais);

                                    }

                                    $receber_informacoes = $_POST['receber_informacoes'];

                                    $xreceber_informacoes = (strlen($receber_informacoes) > 0) ? "'$receber_informacoes'" : "'f'";

                                    if($login_fabrica == 85){
                                        $garantia_estendida_check   = $_POST["garantia_estendida_check"];
                                        $garantia_contratual_check  = $_POST["garantia_contratual_check"];

                                        if($garantia_estendida_check == 't'){
                                            $reclamado  = $_POST["reclamado_garantia_estendida"];
                                            $xreclamado = "'".$reclamado."'";
                                        } else if ($garantia_contratual_check == "t") {
                                            $reclamado  = $_POST["descricao_garantia_contratual"];
                                            $xreclamado = "'".$reclamado."'";
                                        }
                                    }

                                    if(in_array($login_fabrica, [42,101])){
                                        $tipo_registro = $_POST["consumidor_tipo_contato"];
                                    }

                                    if($login_fabrica == 125){
                                        $tel_fixo_revenda       = $_POST["tel_fixo_revenda"];
                                        $cel_revenda            = $_POST["cel_revenda"];
                                        $email_revenda          = $_POST["email_revenda"];
                                        $responsavel_revenda    = $_POST["responsavel_revenda"];

                                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                                        $array_campos_adicionais["tel_fixo_revenda"]    = $tel_fixo_revenda;
                                        $array_campos_adicionais["cel_revenda"]         = $cel_revenda;
                                        $array_campos_adicionais["email_revenda"]       = $email_revenda;
                                        $array_campos_adicionais["responsavel_revenda"] = $responsavel_revenda;

                                        $array_campos_adicionais = json_encode($array_campos_adicionais);
                                    }

                                    if($login_fabrica == 160 or $replica_einhell){
                                        $versao                  = $_POST["versao"];

                                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                                        $array_campos_adicionais['data_conciliacao'] = $data_conciliacao;
                                        $array_campos_adicionais['data_julgamento'] = $data_julgamento;

                                        $array_campos_adicionais["versao_produto"] = $versao;

                                        $array_campos_adicionais = str_replace("\\", "\\\\", json_encode($array_campos_adicionais));

                                    }

                                    if(in_array($login_fabrica, array(52,125,161,162,164,169,170,175,176,178,186)) and strlen(trim($cidade)) == 0){
                                        $cidade = 'null';
                                    }

                                    if(in_array($login_fabrica, [167, 203])){ //HD-3428316

                                        $array_campos_adicionais = array();
                                        $contador                = $_POST["contador"];
                                        $familia_descricao       = $_POST["familia_descricao"];

                                        $array_campos_adicionais["voltagem"] = $voltagem;

                                        if( strstr($familia_descricao, "Impressora") == true || strstr($familia_descricao, "Multifunciona") == true ){
                                            if(strlen(trim($xserie)) == 0 OR $xserie == "null"){
                                                $msg_erro .= "Informe a série do produto <br/>";
                                            }
                                            if(strlen(trim($contador)) == 0){
                                                $msg_erro .= " Informe o valor do Contador <br/>";
                                            }else{
                                                $array_campos_adicionais['contador'] = $contador;
                                                $array_campos_adicionais = json_encode($array_campos_adicionais);
                                            }
                                        }

                                    }

                                    if($login_fabrica == 162){
                                        $imei              = $_POST['imei'];
                                        $linha_informatica = $_POST['linha_informatica'];
                                        $abre_os           = $_POST['abre_os'];
                                        $abre_os           = (strlen($abre_os) == 0) ? "f" : $abre_os;

                                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                                        if (filter_input(INPUT_POST,'interno',FILTER_VALIDATE_INT)) {
                                            $interno_aparencia      = filter_input(INPUT_POST,'interno_aparencia');
                                            $interno_acessorios     = filter_input(INPUT_POST,'interno_acessorios');
                                            $interno_atendimento    = filter_input(INPUT_POST,'interno_atendimento');
                                            $interno_observacao     = filter_input(INPUT_POST,'interno_observacao');

                                            $array_campos_adicionais['interno_aparencia']   = $interno_aparencia;
                                            $array_campos_adicionais['interno_acessorios']  = $interno_acessorios;
                                        }

                                        $array_campos_adicionais['perfil_cliente']   = $_POST['perfil_cliente'];
                                        $array_campos_adicionais['pedido_cliente']   = $_POST['pedido_cliente'];
                                        $array_campos_adicionais['acordo_realizado']   = $_POST['acordo_realizado'];
                                        $array_campos_adicionais['data_realizacao_acordo']   = $_POST['data_realizacao_acordo'];

                                        if($_POST["acordo_realizado"] == "SIM"){
                                            $array_campos_adicionais['tipo_acordo_realizado']   = $_POST['tipo_acordo_realizado'];
                                        }else{
                                            $array_campos_adicionais['tipo_acordo_realizado']   = "";
                                        }

                                        $array_campos_adicionais["imei"] = $imei;
                                        $array_campos_adicionais["linha_informatica"] = $linha_informatica;
                                        $array_campos_adicionais = json_encode($array_campos_adicionais);

                                    }

                                    if ($login_fabrica == 165) {
                                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                                        $array_campos_adicionais['indicacao_instalador_tecnico'] = $_POST['indicacao_instalador_tecnico'];

                                        if (strlen($_POST['indicacao_instalador_comentario']) > 0) {
                                            $indicacao_instalador_comentario  = $_POST["indicacao_instalador_comentario"];
                                            $xindicacao_instalador_comentario = "'".$indicacao_instalador_comentario."'";
                                            $array_campos_adicionais['indicacao_instalador_comentario'] = $xindicacao_instalador_comentario;
                                        }

                                        $array_campos_adicionais = json_encode($array_campos_adicionais);
                                    }

                                    if (in_array($login_fabrica, array(169, 170))) {
                                        if (strlen(trim($produto)) > 0 AND empty($servico_instalacao)){
                                            $sql_contas_nacionais = "
                                                SELECT
                                                    tbl_hd_motivo_ligacao.tipo_registro,
                                                    tbl_tipo_atendimento.tipo_atendimento
                                                FROM tbl_hd_motivo_ligacao
                                                JOIN tbl_tipo_atendimento ON tbl_tipo_atendimento.fabrica = tbl_hd_motivo_ligacao.fabrica
                                                    AND tbl_tipo_atendimento.fabrica = {$login_fabrica}
                                                WHERE tbl_hd_motivo_ligacao.hd_motivo_ligacao = {$hd_motivo_ligacao}
                                                AND tbl_tipo_atendimento.descricao = 'Garantia - Contas Nacionais'
                                                AND tbl_hd_motivo_ligacao.fabrica = {$login_fabrica}
                                                AND tbl_hd_motivo_ligacao.tipo_registro = 't' ";
                                            $res_contas_nacionais = pg_query($con, $sql_contas_nacionais);

                                            if (pg_num_rows($res_contas_nacionais) > 0){
                                                $xtipo_atendimento = pg_fetch_result($res_contas_nacionais, 0, 'tipo_atendimento');
                                            }else{
                                                $sql = "SELECT
                                                            tbl_linha.deslocamento,
                                                            tbl_linha.linha
                                                        FROM tbl_produto
                                                            JOIN tbl_linha ON(tbl_produto.linha = tbl_linha.linha AND tbl_linha.fabrica = {$login_fabrica})
                                                        WHERE tbl_produto.fabrica_i = {$login_fabrica}
                                                        AND tbl_produto.produto = {$produto}";
                                                $res = pg_query($con, $sql);

                                                if (pg_num_rows($res) > 0){
                                                    $deslocamento    = pg_fetch_result($res, 0, "deslocamento");

                                                    if ($deslocamento == 't') {
                                                        $sql = "SELECT
                                                                    tipo_atendimento
                                                                FROM tbl_tipo_atendimento
                                                                WHERE km_google IS TRUE
                                                                    AND fora_garantia IS NOT TRUE
                                                                    AND grupo_atendimento = 'P'
                                                                    AND descricao NOT ILIKE '%Nacionais%'
                                                                    AND fabrica = {$login_fabrica};";
                                                        $xres = pg_query($con, $sql);
                                                    }else{
                                                        $sql = "SELECT
                                                                    tipo_atendimento
                                                                FROM tbl_tipo_atendimento
                                                                WHERE km_google IS NOT TRUE
                                                                    AND fora_garantia IS NOT TRUE
                                                                    AND grupo_atendimento = 'P'
                                                                    AND fabrica = {$login_fabrica};";
                                                        $xres = pg_query($con, $sql);
                                                    }

                                                    if (pg_num_rows($xres) > 0){
                                                        $xtipo_atendimento = pg_fetch_result($xres, 0, 'tipo_atendimento');
                                                    }
                                                }
                                            }
                                        }else if (strlen(trim($produto)) > 0 AND strlen($servico_instalacao) > 0){
                                            $xtipo_atendimento = $servico_instalacao;
                                        }

                                        if (empty($xtipo_atendimento)) {
                                            $xtipo_atendimento = "null";
                                        }

                                        $garantia_estendida = "false";
                                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                                        $instalador_nome = $_POST["instalador_nome"];
                                        $instalador_id   = $_POST["instalador_id"];

                                        $array_campos_adicionais["instalador_nome"] = "";
                                        $array_campos_adicionais["instalador_id"] = "";

                                        if (!empty($instalador_nome) && !empty($instalador_id)) {
                                            $sqlInstalador = "SELECT nome FROM tbl_posto WHERE posto = {$instalador_id}";
                                            $resInstalador = pg_query($con, $sqlInstalador);

                                            if (pg_num_rows($resInstalador) > 0) {
                                                $array_campos_adicionais["instalador_nome"] = utf8_encode(pg_fetch_result($resInstalador, 0, "nome"));
                                                $array_campos_adicionais["instalador_id"] = $instalador_id;

                                                $garantia_estendida = "true";
                                            }
                                        }

                                        if(strlen(trim($mapa_linha)) > 0){
                                            $array_campos_adicionais["mapa_linha"] = $mapa_linha;
                                        }

                                        $array_campos_adicionais = json_encode($array_campos_adicionais);
                                        $OsUpdate = "os = $xos,";
                                    } else {
                                        $OsUpdate = "os = case when os notnull then os else $xos end,";
                                    }

                                    if ($login_fabrica == 152) {

                                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                                        if ($duvida_consumidor == 'TE') {
                                            $tipo_registro = "Técnica Equipamento";
                                            $array_campos_adicionais["equipamentoeconsumivel"] = utf8_encode($equipamentoeconsumivel);

                                        }elseif ($duvida_consumidor == 'TC') {
                                            $tipo_registro = "Técnica Consumivel";
                                            $array_campos_adicionais["equipamentoeconsumivel"] = utf8_encode($equipamentoeconsumivel);

                                        } elseif ($duvida_consumidor == 'C') {
                                            $tipo_registro = "Comercial";
                                        } elseif ($duvida_consumidor == 'R') {
                                            $tipo_registro = "Reclamacao";
                                        }


                                        $array_campos_adicionais["tipo_atendimento_consumidor"]  = utf8_encode($tipo_atendimento_consumidor);

                                        $array_campos_adicionais = json_encode($array_campos_adicionais);
                                    }

                                    if ($integracaoSocial || in_array($login_fabrica, [166,186])) {
                                        $qAdicionais = "SELECT
                                            thce.array_campos_adicionais
                                        FROM tbl_hd_chamado_extra thce
                                        JOIN tbl_hd_chamado thc ON thc.hd_chamado = thce.hd_chamado
                                        WHERE thc.fabrica = $1
                                            AND thc.hd_chamado = $2";

                                        $rAdicionais = pg_query_params($con, $qAdicionais, [$login_fabrica, $callcenter]);
                                        $camposAdicionais = pg_fetch_result($rAdicionais, 0, 'array_campos_adicionais');
                                        $camposAdicionais = json_decode($camposAdicionais, true);

                                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                                        if ($camposAdicionais['meLibre']) { $array_campos_adicionais['meLibre'] = $camposAdicionais['meLibre']; }
                                        if ($camposAdicionais['facebook']) { $array_campos_adicionais['facebook'] = $camposAdicionais['facebook']; }
                                        if ($camposAdicionais['instagram']) { $array_campos_adicionais['instagram'] = $camposAdicionais['instagram']; }

                                        $array_campos_adicionais = json_encode($array_campos_adicionais);
                                    }

                                    if ($login_fabrica == 174) {
                                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                                        $nome_loja = $_POST['nome_loja'];
                                        $pedido_info             = filter_input(INPUT_POST,'pedido_info');
                                        $hd_extra_data_entrega = $_POST["hd_extra_data_entrega"];
                                        $array_campos_adicionais['hd_extra_data_entrega'] = $hd_extra_data_entrega;
                                        $array_campos_adicionais['nome_loja'] = $nome_loja;
                                        $array_campos_adicionais["pedido_info"] = $pedido_info;

                                        $array_campos_adicionais = json_encode($array_campos_adicionais);
                                    }

                                    if ($login_fabrica == 80 && strlen($_POST["volumes"]) > 0) {
                                        $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                                        $array_campos_adicionais["volumes"] = $_POST["volumes"];

                                        $array_campos_adicionais = json_encode($array_campos_adicionais);
                                    }

                                    if (in_array($login_fabrica, [186])) {

										$observacao_os = $_POST["observacao_os"];
										if (!is_array($array_campos_adicionais)) {
											$array_campos_adicionais = json_decode($array_campos_adicionais, true);
										}
										if (strlen($_POST["obs_para_contato"]) > 0) {
											$array_campos_adicionais["obs_para_contato"] = utf8_encode($_POST["obs_para_contato"]);
										}
										if (strlen($_POST["assunto_fale_conosco"]) > 0) {
											$array_campos_adicionais["assunto_fale_conosco"] = utf8_encode($_POST["assunto_fale_conosco"]);
										}
										$array_campos_adicionais = json_encode($array_campos_adicionais);
                                    }

                                    if ($login_fabrica == 151) { /* HD - 6177097*/
                                        /*HD - 6232912*/
                                        $sqlExtra = "SELECT tbl_hd_chamado_extra.array_campos_adicionais
                                                       FROM tbl_hd_chamado_extra
                                                       JOIN tbl_hd_chamado ON tbl_hd_chamado.hd_chamado = tbl_hd_chamado_extra.hd_chamado
                                                      WHERE tbl_hd_chamado.hd_chamado = {$hd_chamado}
                                                        AND tbl_hd_chamado.fabrica = {$login_fabrica}";
                                        $resultExtra = pg_query($con, $sqlExtra);
                                        $array_campos_adicionais = pg_fetch_result($resultExtra, 0, 'array_campos_adicionais');

                                        if (strlen($_POST["titular_nota_fiscal"]) > 0) {
                                            if (!is_array($array_campos_adicionais)) {
                                                $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                                            }

                                            $array_campos_adicionais["nome_titular_nf"] = $_POST["titular_nota_fiscal"];
                                            $array_campos_adicionais                    = json_encode($array_campos_adicionais);
                                        }

                                        if (strlen($_POST["titular_cpf"]) > 0) {
                                            if (!is_array($array_campos_adicionais)) {
                                                $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                                            }

                                            $array_campos_adicionais["cpf_titular_nf"] = $_POST["titular_cpf"];
                                            $array_campos_adicionais                   = json_encode($array_campos_adicionais);
                                        }

                                    }
                                    $array_campos_adicionais = pg_escape_string($array_campos_adicionais);
                                    $array_campos_adicionais = str_replace('\\u', '\\\\u', $array_campos_adicionais);
                                    $xreclamado = preg_replace("/\\\\(\d)/","/$1",$xreclamado);
                                    if($xreclamado <> 'null') $xreclamado = "$xreclamado";


                                    // atualizando data de aprovação
                                        if ($login_fabrica == 174)
                                        {
                                            $sql = "UPDATE tbl_hd_chamado
                                                SET data_aprovacao = ".current_timestamp."
                                                WHERE
                                                    hd_chamado = $xhd_chamado";
                                            $res       = pg_query($con, $sql);
                                            $msg_erro .= pg_last_error($con);
                                        }

                                        if (in_array($login_fabrica, [52])) {
                                            if (strlen($_POST["consumidor_pais"]) > 0) {
                                                $consumidor_pais                 = $_POST["consumidor_pais"];
                                                $array_campos_adicionais["pais"] = $consumidor_pais;
                                                $array_campos_adicionais         = json_encode($array_campos_adicionais);
                                            }
                                        }


                                        if (in_array($login_fabrica, [177])) {
                                            $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                                            $lote                    = $_POST['lote'];
                                            $pais                    = $_POST['pais'];

                                            $array_campos_adicionais["lote"] = $lote;
                                            $array_campos_adicionais["pais"] = $pais;
                                            $array_campos_adicionais         = json_encode($array_campos_adicionais);
                                        }

                                        if($login_fabrica == 189){
                                            $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                                            $array_campos_adicionais['tipo_posto'] = $tipo_posto;
                                            $array_campos_adicionais['prioridade'] = $prioridade;
                                            $array_campos_adicionais['analise_reclamacao'] = $analise_reclamacao;
                                            $array_campos_adicionais['nome_representante'] = $nome_representante;
                                            $array_campos_adicionais['tipo_cliente'] = $tipo_cliente;
                                            $array_campos_adicionais['celular_representante']  = $celular_representante;
                                            $array_campos_adicionais['nome_empresa'] = utf8_encode($nome_empresa);
                                            $array_campos_adicionais['manual_nome_repre'] = utf8_encode($manual_nome_repre);
                                            $array_campos_adicionais['manual_email_repre'] = utf8_encode($manual_email_repre);
                                            $array_campos_adicionais['manual_cod_transp'] = utf8_encode($manual_cod_transp);
                                            $array_campos_adicionais['manual_nome_transp'] = utf8_encode($manual_nome_transp);
                                            $array_campos_adicionais['manual_contato_transp'] = utf8_encode($manual_contato_transp);
                                            $array_campos_adicionais['manual_fone_transp'] = utf8_encode($manual_fone_transp);
                                            $array_campos_adicionais['manual_end_transp'] = utf8_encode($manual_end_transp);
                                            $array_campos_adicionais['manual_cod_transp_redespacho'] = utf8_encode($manual_cod_transp_redespacho);
                                            $array_campos_adicionais['manual_nome_transp_redespacho'] = utf8_encode($manual_nome_transp_redespacho);
                                            $array_campos_adicionais['manual_contato_transp_redespacho'] = utf8_encode($manual_contato_transp_redespacho);
                                            $array_campos_adicionais['manual_fone_transp_redespacho'] = utf8_encode($manual_fone_transp_redespacho);
                                            $array_campos_adicionais['manual_end_transp_redespacho'] = utf8_encode($manual_end_transp_redespacho);
                                            $array_campos_adicionais['codigo_cliente_revenda'] = utf8_encode($codigo_cliente_revenda);
                                            $array_campos_adicionais['planta'] = $planta;
                                            $array_campos_adicionais['mercado_gerencia'] = $mercado_gerencia;
                                            $array_campos_adicionais['envia_email_representante'] = $envia_email_representante;

                                            if (strlen($_POST["hd_subclassificacao"]) > 0) {
                                                $hd_subclassificacao = trim($_POST["hd_subclassificacao"]);
                                            } else {
                                                $hd_subclassificacao = null;
                                            }

                                            $xxhd_motivo_ligacao = $_POST["hd_motivo_ligacao"];


                                            $array_campos_adicionais['cte_1'] = $cte_1;
                                            $array_campos_adicionais['cte_2'] = $cte_2;
                                            $array_campos_adicionais['n_ordem_entrada_1'] = $n_ordem_entrada_1;
                                            $array_campos_adicionais['n_ordem_entrada_2'] = $n_ordem_entrada_2;
                                            $array_campos_adicionais['n_remessa_1'] = $n_remessa_1;
                                            $array_campos_adicionais['n_remessa_2'] = $n_remessa_2;
                                            $array_campos_adicionais['n_nf_entrada_1'] = $n_nf_entrada_1;
                                            $array_campos_adicionais['n_nf_entrada_2'] = $n_nf_entrada_2;
                                            $array_campos_adicionais = json_encode($array_campos_adicionais);

                                            if($envia_email_representante == 't'){
                                                $sqlTipoPosto = "SELECT * FROM tbl_tipo_posto WHERE tipo_posto={$tipo_posto} AND fabrica = {$login_fabrica}";
                                                $resTipoPosto = pg_query($con, $sqlTipoPosto);

                                                $nomeTipo = pg_fetch_result($resTipoPosto, 0, 'descricao');


                                                $assunto = "INDICAÃÃO DE ".strtoupper($nomeTipo)." - PROTOCOLO $hd_chamado ";
                                                $mensagem = "Boa Tarde, <br><br> Indicamos vosso contato para o cliente abaixo: <br><br>
                                                NOME: ".$_POST["consumidor_nome"]." <br>
                                                TELEFONE: ".$_POST['consumidor_fone']." <br>
                                                EMPRESA: $nome_empresa <br>
                                                CPF/CNPJ: ".$_POST["consumidor_cpf"]." <br>
                                                DESTINO DA MERCADORIA: $tipo_cliente <br>
                                                <br>";

                                                $mailTc = new TcComm($externalId);
                                                $res = $mailTc->sendMail(
                                                    $posto_email_tab,
                                                    $assunto,
                                                    $mensagem,
                                                    $externalEmail
                                                );
                                            }
                                        }

                                        if (in_array($login_fabrica, [184,200])) {

                                            if (!is_array($array_campos_adicionais)) {
                                                $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                                            }

                                            if (!empty($pedido_venda)) {
                                                $array_campos_adicionais["pedido_venda"] = $pedido_venda;
                                            }

                                            if (!empty($nf_venda)) {
                                                $array_campos_adicionais["nf_venda"] = $nf_venda;
                                            }

                                            $array_campos_adicionais = json_encode($array_campos_adicionais);

                                        }

                                        if (in_array($login_fabrica, [178])) {

                                            if (!is_array($array_campos_adicionais)) {
                                                $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                                            }

                                            if (!empty($resposta_consumidor)) {
                                                $array_campos_adicionais["resposta_consumidor"] = $resposta_consumidor;
                                            }

                                            $array_campos_adicionais = json_encode($array_campos_adicionais);

                                        }

                                        if (in_array($login_fabrica, [184,200]) && !empty($_POST['os'])) {

                                            $sqlVerificaVinculo = "SELECT os FROM tbl_hd_chamado_extra WHERE hd_chamado = {$xhd_chamado}";
                                            $resVerificaVinculo = pg_query($con, $sqlVerificaVinculo);

                                            $osVinculada = pg_fetch_result($resVerificaVinculo, 0, 'os');

                                            if (empty($osVinculada) || $osVinculada != $_POST['os']) {

                                                $sqlUpdOs = "UPDATE tbl_hd_chamado_extra SET os = {$_POST['os']} WHERE hd_chamado = {$xhd_chamado}";
                                                $resUpdOs = pg_query($con, $sqlUpdOs);

                                                $sqlInt = "INSERT INTO tbl_hd_chamado_item(
                                                            hd_chamado   ,
                                                            data         ,
                                                            comentario   ,
                                                            admin        ,
                                                            interno
                                                        ) VALUES(
                                                            $xhd_chamado  ,
                                                            current_timestamp,
                                                            E'A OS: $xos foi vinculada ao atendimento.',
                                                            {$login_admin},
                                                            't'
                                                        )";
                                                $resInt = pg_query($con, $sqlInt);

                                            }

                                        }

                                        if ($login_fabrica == 183){

                                            if (!is_array($array_campos_adicionais)) {
                                                $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                                            }

                                            if (strlen(trim($dev_transportadora)) > 0){
                                                $array_campos_adicionais["dev_transportadora"] = utf8_encode($dev_transportadora);
                                            }else{
                                                unset($array_campos_adicionais["dev_transportadora"]);
                                            }

                                            if (strlen(trim($pedido_sap)) > 0){
                                                $array_campos_adicionais["pedido_sap"] = $pedido_sap;
                                            }else{
                                                unset($array_campos_adicionais["pedido_sap"]);
                                            }

                                            if (strlen(trim($dev_motorista)) > 0){
                                                $array_campos_adicionais["dev_motorista"] = utf8_encode($dev_motorista);
                                            }else{
                                                unset($array_campos_adicionais["dev_motorista"]);
                                            }

                                            if (strlen(trim($dev_aprovador)) > 0){
                                                $array_campos_adicionais["dev_aprovador"] = utf8_encode($dev_aprovador);
                                            }else{
                                                unset($array_campos_adicionais["dev_aprovador"]);
                                            }

                                            if (strlen(trim($voltagem)) > 0){
                                                $array_campos_adicionais["voltagem"] = $voltagem;
                                            }else{
                                                unset($array_campos_adicionais["voltagem"]);
                                            }
                                            $array_campos_adicionais = json_encode($array_campos_adicionais);
                                        }

                                    if($login_fabrica == 42){
                                        $pedido = $_POST["pedido"];

                                        if(empty($pedido)){
                                            $pedido = 'null';
                                        }

                                        $camposPedido = ", pedido = $pedido ";
                                    }

                                    $sql = "UPDATE  tbl_hd_chamado_extra
                                            SET     nome                        = UPPER($xconsumidor_nome)       ,
                                                    cpf                         = $xconsumidor_cpf               ,
                                                    rg                          = UPPER($xconsumidor_rg)         ,
                                                    email                       = $xconsumidor_email             ,
                                                    fone                        = substr($xconsumidor_fone,0,21) ,
                                                    cep                         = $xconsumidor_cep               ,
                                                    endereco                    = substr(UPPER($xconsumidor_endereco),0,70)   ,
                                                    numero                      = UPPER($xconsumidor_numero)     ,
                                                    complemento                 = UPPER($xconsumidor_complemento),
                                                    bairro                      = UPPER($xconsumidor_bairro)     ,
                                                    receber_info_fabrica        = $xreceber_informacoes          ,
                                                    hora_ligacao                = $xhora_ligacao                 ,
                                                    origem                      = $xorigem                       ,
                                                    consumidor_revenda          = $xconsumidor_revenda           ,
                                                    fone2                       = substr($xconsumidor_fone2,0,21),
                                                    celular                     = $xconsumidor_fone3             ,
                                                    {$OsUpdate}
                                                    contato_nome                = '$contato_nome'                ,
                                                    produto                     = $xproduto                      ,
                                                    serie                       = substr($xserie,0,27)           ,
                                                    nota_fiscal                 = substr('$xnota_fiscal',0,11)   ,
                                                    data_nf                     = $xdata_nf                      ,
                                                    valor_nf                    = $xvalor_nf                     ,
                                                    marca                       = $marca                         ,
                                                    revenda                     = $xrevenda                      ,
                                                    revenda_cnpj                = '$cnpj_revenda'                ,
                                                    revenda_nome                = substr($xrevenda_nome,0,51)    ,
                                                    posto                       = $xcodigo_posto                 ,
                                                    defeito_reclamado           = $xdefeito_reclamado            ,
                                                    defeito_reclamado_descricao = '$hd_extra_defeito'            ,
                                                    reclamado                   = $xreclamado                    ,
                                                    hd_motivo_ligacao           = $hd_motivo_ligacao
                                                    $cond_motivo_situacao
                                                    $camposPedido
                                    ";

                                    if (!$integracaoSocial AND !in_array($login_fabrica, [174])) {
                                        $sql .= ", cidade = {$cidade}";
                                    } elseif (
                                        (in_array($login_fabrica, [174])) AND
                                        (!$integracaoSocial) AND
                                        (!empty($cidade) OR $obg === true)
                                    ) {
                                        $sql .= ", cidade = {$cidade}";
                                    }

                                    if ($login_fabrica == 183){
                                        $sql .= ", posto_nome = $xconsumidor_ponto_referencia";
                                    }

                                     if (in_array($login_fabrica, [169,170])) {

                                        if (empty($hd_providencia_callcenter)) {
                                            $aux_hd_providencia = "null";
                                        } else {
                                            $aux_hd_providencia = $hd_providencia_callcenter;
                                        }

                                        if (empty($motivo_contato_callcenter)) {
                                            $aux_motivo_contato = "null";
                                        } else {
                                            $aux_motivo_contato = $motivo_contato_callcenter;
                                        }

                                        $sql .= ", motivo_contato = {$aux_motivo_contato}
                                                 , hd_providencia = {$aux_hd_providencia}";

                                    }

                                    if (in_array($login_fabrica, array(11,15,24,30,52,74,80,81,85,101,114,122,123,128)) || $login_fabrica >= 138 || $telecontrol_distrib){

                                        $array_campos_adicionais = pg_escape_string($array_campos_adicionais);

                                        $sql .= ", array_campos_adicionais = '$array_campos_adicionais' ";
                                    }
                                    if (in_array($login_fabrica, array(15,30,74, 178))) {
                                        $sql .= ", data_nascimento = $consumidor_nascimento_query ";
                                    }

                                    if((in_array($login_fabrica, array(169,170)) || $usaOrigemCadastro) AND strlen(trim($id_xorigem)) > 0){
                                        $sql .= ", hd_chamado_origem = $id_xorigem";
                                    }

                                    if ($login_fabrica == 11 or $login_fabrica == 172) {
                                        $sql .= ", leitura_pendente = '{$leitura_pendente}' ";
                                    }

                                    if($login_fabrica == 81){
                                        $sql .= ", solucao = $solucao ";
                                    }

                                    if($login_fabrica == 189 && strlen($hd_subclassificacao) > 0){
                                        $sql .= ", hd_subclassificacao = $hd_subclassificacao ";
                                    }

                                    if(in_array($login_fabrica, array(42, 101, 152))){
                                        $sql .= ", tipo_registro = '$tipo_registro'  ";
                                    }

                                    if (in_array($login_fabrica, array(169,170))) {

                                        if($abre_ordem_servico == 't' || $abre_os == 't'){
                                            $upd_abre_os = 't';
                                        }else{
                                            $upd_abre_os = 'f';
                                        }


                                        $sql .= "
                                            , garantia = $garantia_estendida
                                            , tipo_atendimento = $xtipo_atendimento
                                            , abre_os = '$abre_os'
                                        ";
                                        if (strlen(trim($observacao_os)) > 0){
                                            $sql .=", obs_callcenter = '$observacao_os' ";
                                        }
                                    }
                                    if ($login_fabrica == 162) {
                                        if (filter_input(INPUT_POST,'interno')) {
                                            $sql .= ",
                                                tipo_atendimento    = $interno_atendimento,
                                                obs_callcenter      = '$interno_observacao'
                                            ";
                                        }
                                        $sql .= ",
                                            abre_os = '$abre_os'
                                        ";
                                    }

                                    $sql .=" WHERE
                                        tbl_hd_chamado_extra.hd_chamado = $xhd_chamado";

                                    $res = pg_query($con, $sql);

                                    $msg_erro .= pg_last_error($con);
                                }
                            }
                        }                                            
                        if ($login_fabrica == 151 && strlen(trim($msg_erro)) == 0) { /*HD - 6277889*/
                            if ($alterarCPFConsumidor == true) {
                                $aux_comentario = "O CPF do(a) consumidor(a) foi alterado de \"$CPFConsumidorAntigo\" para \"$CPFConsumidorNovo\" pelo usuário(a) $login_nome_completo";
                                $aux_sql = "INSERT INTO tbl_hd_chamado_item(hd_chamado, comentario, interno) VALUES($callcenter, '$aux_comentario', TRUE) RETURNING hd_chamado_item";
                                $aux_res = pg_query($con, $aux_sql);
                                $aux_val = pg_fetch_result($aux_res, 0, 0);

                                if (strlen($aux_val) == 0) {
                                    $msg_erro .= "Erro ao registrar a alteração de CPF do consumidor";
                                } else {
                                    $aux_sql = "SELECT os FROM tbl_os WHERE hd_chamado = $callcenter AND fabrica = $login_fabrica AND data_fechamento IS NULL AND finalizada IS NULL";
                                    $aux_res = pg_query($con, $aux_sql);
                                    $aux_val = pg_fetch_result($aux_res, 0, 0);

                                    if (strlen($aux_val) > 0) {
                                        $aux_sql = "UPDATE tbl_os SET consumidor_cpf = '$CPFConsumidorNovo' WHERE os = $aux_val";
                                        $aux_res = pg_query($con, $aux_sql);

                                        if (strlen(pg_last_error()) > 0) {
                                            $msg_erro .= "Erro ao atualizar o CPF na ordem de servio do(a) consumidor(a)";
                                        }
                                    }
                                }
                            }
                        }

                        if (in_array($login_fabrica, array(169,170)) AND strlen(trim($os)) > 0 AND strlen(trim($observacao_os)) > 0 AND strlen(trim($msg_erro)) == 0){
                            $sql = "UPDATE tbl_os set observacao = '$observacao_os' WHERE os = $os";
                            $res = pg_query($con, $sql);
                        }

                        if (in_array($login_fabrica, array(30,52,85, 158)) && empty($msg_erro)) {

                            if($login_fabrica == 85){

                                if ($atendimento_ambev == "t") {
                                    $cliente_admin = $cliente_admin_ambev;

                                    $sql = "UPDATE tbl_hd_chamado set cliente_admin = $cliente_admin where hd_chamado = $xhd_chamado";

                                    $res = pg_query($con,$sql);
                                    $msg_erro .= pg_errormessage($con);

                                } else if ($atendimento_contratual == "t") {
                                    $sql = "UPDATE tbl_hd_chamado set cliente = $xid_cliente_contratual WHERE hd_chamado = $xhd_chamado";

                                    $res = pg_query($con,$sql);
                                    $msg_erro .= pg_errormessage($con);
                                }

                            } else {

                                if (strlen($cliente_admin) > 0) {

                                    $sql = "UPDATE tbl_hd_chamado set cliente_admin = $cliente_admin where hd_chamado = $xhd_chamado";

                                    $res = pg_query($con,$sql);
                                    $msg_erro .= pg_errormessage($con);

                                }

                            }

                        }
                        
                        if ($login_fabrica == 178 AND empty($msg_erro)){

                            if (!empty($id_os_revenda) AND !empty($os_revenda_anterior) AND $id_os_revenda != $os_revenda_anterior){
                                $sql_cancelada = "SELECT excluida FROM tbl_os_revenda WHERE fabrica = $login_fabrica AND os_revenda = $os_revenda_anterior AND excluida IS TRUE";
                                $res_cancelada = pg_query($con, $sql_cancelada);
                                if (pg_num_rows($res_cancelada) == 0){
                                    $msg_erro .= "Favor cancelar a ORDEM DE SERVIÇO: $os_revenda_anterior antes de vincular uma nova ORDEM DE SERVIÇO <br/>";
                                }
                            }

                            if (empty($msg_erro) AND !empty($id_os_revenda) AND $id_os_revenda != $os_revenda_anterior ){
                                $sql_posto_os = "
                                    SELECT tbl_posto.posto, tbl_posto.nome, tbl_posto_fabrica.codigo_posto
                                    FROM tbl_os_revenda
                                    JOIN tbl_posto ON tbl_posto.posto = tbl_os_revenda.posto
                                    JOIN tbl_posto_fabrica ON tbl_posto_fabrica.posto = tbl_posto.posto AND tbl_posto_fabrica.fabrica = $login_fabrica
                                    WHERE tbl_os_revenda.os_revenda = $id_os_revenda AND tbl_os_revenda.fabrica = $login_fabrica";
                                $res_posto_os = pg_query($con, $sql_posto_os);

                                if (pg_num_rows($res_posto_os) > 0){
                                    $posto_nova_os = pg_fetch_result($res_posto_os, 0, "posto");
                                    $nome_posto_novo = pg_fetch_result($res_posto_os, 0, "nome");
                                    $codigo_posto_novo = pg_fetch_result($res_posto_os, 0, "codigo_posto");

                                    $sql_up = "UPDATE tbl_hd_chamado_extra SET posto = $posto_nova_os WHERE hd_chamado = $hd_chamado";
                                    $res_up = pg_query($con, $sql_up);

                                    if (!empty($os_revenda_anterior)){
                                        $sql_up = "UPDATE tbl_os_revenda SET hd_chamado = NULL WHERE os_revenda = $os_revenda_anterior";
                                        $res_up = pg_query($con, $sql_up);
                                    }

                                    $sql_up = "UPDATE tbl_os_revenda SET hd_chamado = $callcenter WHERE os_revenda = $id_os_revenda";
                                    $res_up = pg_query($con, $sql_up);

                                    if (strlen(pg_last_error()) > 0){
                                        $msg_erro .= "Erro ao vincular OS <br/>";
                                    }else{
                                        if (!empty($os_revenda_anterior) AND $id_os_revenda != $os_revenda_anterior){
                                            $aux_comentario = "OS: $id_os_revenda foi vinculado ao CallCenter, o Posto Autorizado foi alterado de \"$codigo_posto_tab - $posto_nome_tab\" para \"$codigo_posto_novo - $nome_posto_novo\" pelo usuário(a) $login_nome_completo";
                                            $aux_sql = "INSERT INTO tbl_hd_chamado_item(hd_chamado, comentario, interno) VALUES($callcenter, '$aux_comentario', TRUE) RETURNING hd_chamado_item";
                                            $aux_res = pg_query($con, $aux_sql);

                                            if (strlen(pg_last_error()) > 0){
                                                $msg_erro .= "Erro ao vincular OS <br/>";
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    /* HD 37805 */
                    if ($tab_atual == "ressarcimento" and strlen($msg_erro) == 0) {

                        $sql  = "SELECT hd_chamado FROM tbl_hd_chamado_extra_banco WHERE hd_chamado = $hd_chamado ";
                        $resx = @pg_query($con, $sql);

                        if (@pg_num_rows($resx) == 0) {

                            $sql = "INSERT INTO tbl_hd_chamado_extra_banco ( hd_chamado ) values ( $hd_chamado )";
                            $res = pg_query($con, $sql);

                            $msg_erro .= pg_errormessage($con);

                        }

                        $sql = "UPDATE  tbl_hd_chamado_extra_banco
                                SET     banco            = $xbanco,
                                        agencia          = $xagencia,
                                        contay           = $xcontay,
                                        nomebanco        = $xnomebanco,
                                        favorecido_conta = $xfavorecido_conta,
                                        cpf_conta        = $xcpf_conta,
                                        tipo_conta       = $xtipo_conta
                                WHERE   hd_chamado = $hd_chamado";

                        $res       = pg_query($con, $sql);
                        $msg_erro .= pg_errormessage($con);

                        $sql  = "SELECT hd_chamado FROM tbl_hd_chamado_troca WHERE hd_chamado = $hd_chamado ";
                        $resx = @pg_query($con, $sql);

                        if (@pg_num_rows($resx) == 0) {

                            $sql = "INSERT INTO tbl_hd_chamado_troca ( hd_chamado ) values ( $hd_chamado )";
                            $res = pg_query($con, $sql);
                            $msg_erro .= pg_errormessage($con);

                        }

                        $sql = "UPDATE  tbl_hd_chamado_troca
                                SET     data_pagamento    = $xdata_pagamento,
                                        ressarcimento     = 't',
                                        numero_objeto     = NULL,
                                        nota_fiscal_saida = NULL,
                                        data_nf_saida     = NULL,
                                        produto           = NULL,
                                        valor_produto     = $xvalor_produto,
                                        valor_inpc        = $xvalor_inpc,
                                        valor_corrigido   = $xvalor_corrigido
                                WHERE   hd_chamado = $hd_chamado";

                        $res = pg_query($con,$sql);
                        $msg_erro .= pg_errormessage($con);

                        if (strlen($valor_produto) > 0 AND strlen($valor_inpc) > 0 AND strlen($msg_erro) == 0) {

                            $sql  = "SELECT CURRENT_DATE - data_nf AS qtde_dias FROM tbl_hd_chamado_extra WHERE hd_chamado = $hd_chamado ";
                            $resx = @pg_query($con, $sql);

                            if (@pg_num_rows($resx) > 0) {

                                $qtde_dias = pg_fetch_result($resx, 0, 'qtde_dias');

                                if ($qtde_dias > 0) {

                                    $valor_corrigido = $valor_produto + ($valor_produto * $qtde_dias / 100);

                                    $sql = "UPDATE tbl_hd_chamado_troca SET valor_corrigido = $valor_corrigido WHERE hd_chamado = $hd_chamado";
                                    $res = pg_query($con, $sql);
                                    $msg_erro .= pg_errormessage($con);

                                }

                            }

                        }

                    }

                    /* HD 37805 */
                    if ($tab_atual == "sedex_reverso" and strlen($msg_erro) == 0) {

                        $sql = "SELECT hd_chamado
                            FROM tbl_hd_chamado_troca
                            WHERE hd_chamado = $hd_chamado ";

                        $resx = @pg_query($con, $sql);

                        if (@pg_num_rows($resx) == 0) {

                            $sql = "INSERT INTO tbl_hd_chamado_troca ( hd_chamado ) values ( $hd_chamado )";
                            $res = pg_query($con,$sql);
                            $msg_erro .= pg_errormessage($con);

                        }

                        $sql = "UPDATE tbl_hd_chamado_troca SET
                            data_pagamento       = NULL,
                                                 ressarcimento        = 'f',
                                                 numero_objeto        = $xnumero_objeto,
                                                 nota_fiscal_saida    = $xnota_fiscal_saida,
                                                 data_nf_saida        = $xdata_nf_saida,
                                                 produto              = $xproduto_troca,
                                                 data_retorno_produto = $xdata_retorno_produto
                                                     WHERE hd_chamado = $hd_chamado";

                        $res = pg_query($con,$sql);
                        $msg_erro .= pg_errormessage($con);

                    }

                    if ($tab_atual == "extensao" and strlen($msg_erro) == 0 and $login_fabrica == 25) {

                        if (strlen($es_data_compra) == 0) {
                            $msg_erro .= "Informe a data da Compra do produto.";
                        }

                    }

                    $sql = "SELECT fn_callcenter_dias_interacao($hd_chamado,$login_fabrica)";
                    $res = pg_query($con, $sql);

                    $sql = "SELECT fn_callcenter_dias_aberto($hd_chamado,$login_fabrica);";
                    $res = pg_query($con, $sql);
                    $msg_erro .= pg_errormessage($con);

                    $sql = "SELECT fn_callcenter_intervalo_interacao($hd_chamado,$login_fabrica);";
                    $res = pg_query($con, $sql);
                    $msg_erro .= pg_errormessage($con);

                    if (strlen($msg_erro) == 0) {//HD 129655 - Gravar dÃºvidas selecionadas [augusto]
                        if($novaTelaOs == true){
                            gravarNovoFaq();
                        }else{
                            gravarFaq();
                        }
                    }

                }

                if(in_array($login_fabrica, [90, 141]) && empty($callcenter)){
                    $enviarEmail = true;
                }

                if(in_array($login_fabrica, array(169,170)) AND strlen(trim($msg_erro)) == 0 AND strlen(trim($hd_classificacao)) > 0){
                    $sql = "SELECT tbl_hd_classificacao.envia_email FROM tbl_hd_classificacao
                                WHERE fabrica = {$login_fabrica} AND hd_classificacao = {$hd_classificacao}
                                AND envia_email IS TRUE";
                    $res = pg_query($con, $sql);

                    if(pg_num_rows($res) > 0){
                        $envia_email_posto = pg_fetch_result($res, 0, 'envia_email');
                    }

                    if(strlen(trim($callcenter)) == 0 AND strlen(trim($xreclamado)) > 0 AND strlen(trim($posto_email_tab)) > 0 AND $envia_email_posto == "t"){
                        $email_envio = strtolower($posto_email_tab);

                        $subject  = $login_fabrica_nome;
                        $message  = "<b>Prezado, $posto_nome_tab</b><br><br>";
                        $message .= $_POST["reclamado_produto"]."<br><br>";
                        $message .= "<b> Atenciosamente<br>";
                        $message .= "<b> $login_fabrica_nome <br><br>";

                        $mailTc->setEmailSubject($subject);
                        $mailTc->addToEmailBody($message);
                        $mailTc->setEmailFrom($externalEmail);
                        $mailTc->addEmailDest($email_envio);

                        $resultado = $mailTc->sendMail();

                    }else{
                        if(strlen(trim($_POST['resposta'])) > 0 AND strlen(trim($posto_email_tab)) > 0 AND $envia_email_posto == "t"){
                            $email_envio = strtolower($posto_email_tab);

                            $subject  = $login_fabrica_nome;
                            $message  = "<b>Prezado, $posto_nome_tab</b><br><br>";
                            $message .= $_POST["resposta"]."<br><br>";
                            $message .= "<b> Atenciosamente<br>";
                            $message .= "<b> $login_fabrica_nome <br><br>";

                            $mailTc->setEmailSubject($subject);
                            $mailTc->addToEmailBody($message);
                            $mailTc->setEmailFrom($externalEmail);
                            $mailTc->addEmailDest($email_envio);

                            $resultado = $mailTc->sendMail();
                        }
                    }
                }

                if ($login_fabrica == 24 && strlen($msg_erro) == 0) {//HD 751794 e (262718 - Adicionando mais campos)
                    if($xreclamado == "null"){
                        $xreclamado = "''";
                    }
                    $sql = "UPDATE  tbl_hd_chamado_extra
                        SET     orientacao_uso = '$orientacao_uso',
                                reclamado      = $xreclamado      ,
                                posto          = $xcodigo_posto   ,
                                os             = $xos
                                    WHERE   hd_chamado = $hd_chamado
                                    AND     abre_os IS NOT TRUE";

                    $res = pg_query($con, $sql);

                }

                // HD 674943
                if ($login_fabrica == 85 && strlen($msg_erro) == 0) {

                    if (!empty($_POST['sem_resposta'])) {

                        $campo_resposta = $_POST['sem_resposta'];
                        $campo_sem_resp = $campo_resposta == 'recusou_pesquisa' ? 'cliente_nao_encontrado' : 'recusou_pesquisa';

                        $sql = "UPDATE tbl_hd_chamado_extra
                            SET $campo_resposta = 't', $campo_sem_resp = null
                            WHERE hd_chamado = $hd_chamado";
                        $res = pg_query($con,$sql);

                    } else {

                        $sql = "UPDATE tbl_hd_chamado_extra
                            SET recusou_pesquisa = null, cliente_nao_encontrado = null
                            WHERE hd_chamado = $hd_chamado";

                        $res = pg_query($con,$sql);

                        $sql = "SELECT pergunta
                            FROM tbl_pergunta
                            JOIN tbl_tipo_pergunta ON tbl_pergunta.tipo_pergunta = tbl_tipo_pergunta.tipo_pergunta AND tbl_tipo_pergunta.ativo
                            WHERE tbl_pergunta.fabrica = $login_fabrica
                            AND tbl_pergunta.ativo";

                        $res = pg_query($con,$sql);

                        for ($i = 0; $i < pg_num_rows($res); $i++) {

                            $pergunta = pg_result($res,$i,'pergunta');
                            $nota     = $_POST['nota_'.$pergunta];

                            if (!isset($_POST['nota_'.$pergunta]) || empty($nota)) {
                                continue;
                            }

                            if (strlen($hd_chamado) > 0) {
                                $campo_gravar = $hd_chamado;
                                $cond         = ' hd_chamado = ' . $hd_chamado;
                            } else {
                                $campo_gravar = $callcenter;
                                $cond         = ' hd_chamado = ' . $callcenter;
                            }

                            $sql = "SELECT resposta
                                FROM tbl_resposta
                                JOIN tbl_pergunta USING(pergunta)
                                JOIN tbl_tipo_pergunta USING(tipo_pergunta)
                                WHERE $cond AND tbl_pergunta.fabrica = $login_fabrica
                                AND tbl_resposta.pergunta = $pergunta";

                            $res2 = pg_query($con, $sql);

                            if (pg_num_rows($res2)) {
                                $sql = "UPDATE tbl_resposta SET nota = $nota WHERE pergunta = $pergunta AND $cond";
                            } else {
                                $sql = "INSERT INTO tbl_resposta(hd_chamado, pergunta, nota) VALUES($campo_gravar,$pergunta,$nota)";
                            }

                            $res2 = pg_query($con,$sql);
                            $msg_erro = pg_errormessage($con);

                        }

                    }

                } // HD 674943

                /********************************************* PRE-OS *******************************************/
                // HD 120306 - envia e-mail para o posto informando pre-OS cadastrada
                if(!in_array($login_fabrica, array(169,170,171))){
                    $produto_deslocamento = "f";
                }

                if (strlen($msg_erro) == 0 AND $produto_deslocamento == "f") {

                    if ($abre_os == 't' && !($login_fabrica == 162 && filter_input(INPUT_POST,'interno'))) {
                        if (strlen($callcenter)) {
                            $sql = "UPDATE tbl_hd_chamado_extra SET abre_os=true WHERE hd_chamado=$callcenter";
                            $res = pg_query($con, $sql);
                            $msg_erro .= pg_errormessage($con);
                        }

                        switch ($login_fabrica) {
                            case 2: $sac_email = "sac@dynacom.com.br";
                                    break;
                            case 52: $sac_email = "sac@fricon.com.br";
                                    break;
                            case 96:
                                    $sac_email = "andre.dias@br.bosch.com; renato.lima2@br.bosch.com";
                                    break;
                        }

                        $sql = "SELECT email FROM  tbl_admin WHERE admin = $login_admin AND fabrica = $login_fabrica";
                        $res = pg_query($con,$sql);

                        $msg_erro .= pg_errormessage($con);

                        if (pg_num_rows($res) > 0) {
                            $admin_email = pg_fetch_result($res, 0, 'email');
                        } else {
                            $admin_email = $sac_email;
                        }

                        $sql = "SELECT contato_email from tbl_posto_fabrica where posto = $xcodigo_posto and fabrica = $login_fabrica";
                        $res = pg_query($con, $sql);

                        if (@pg_num_rows($res) > 0) {

                            $email_posto = pg_fetch_result($res, 0, 'contato_email');

                        } else {

                            $sql = "SELECT email from tbl_posto where posto = $xcodigo_posto";
                            $res = pg_query($con, $sql);

                            if (pg_num_rows($res) > 0) $email_posto = pg_fetch_result($res, 0, 'email');

                        }

                        if (in_array($login_fabrica, array(30,50,190,195))) {
                            $subject = "Nova OS :: Call-center $clogin_fabrica_nome;";
                        } else {
                            $subject = "Nova Pré-OS :: Call-center $clogin_fabrica_nome;";
                        }

                        //HD 199901 - Alterar mensagem de abertura de pré-OS
                        $sql = " SELECT tbl_posto_fabrica.codigo_posto AS codigo_posto,
                            tbl_posto.nome AS posto_nome,
                            tbl_fabrica.nome AS fabrica_nome,
                            TO_CHAR(tbl_hd_chamado.data, 'DD/MM/YY HH24:MI') AS data_atendimento,
                            tbl_hd_chamado_extra.nome,
                            tbl_hd_chamado_extra.endereco,
                            tbl_hd_chamado_extra.numero,
                            tbl_hd_chamado_extra.complemento,
                            tbl_hd_chamado_extra.bairro,
                            tbl_cidade.nome AS cidade_nome,
                            tbl_cidade.estado,
                            tbl_hd_chamado_extra.revenda_nome,
                            tbl_revenda.cnpj AS revenda_cnpj,
                            tbl_admin.nome_completo AS admin_nome,
                            tbl_admin.email AS admin_email,
                            tbl_hd_chamado_extra.posto
                                FROM tbl_hd_chamado
                                JOIN tbl_hd_chamado_extra ON tbl_hd_chamado.hd_chamado=tbl_hd_chamado_extra.hd_chamado
                                JOIN tbl_posto ON tbl_hd_chamado_extra.posto=tbl_posto.posto
                                JOIN tbl_posto_fabrica ON tbl_posto.posto=tbl_posto_fabrica.posto
                                JOIN tbl_fabrica ON tbl_posto_fabrica.fabrica=tbl_fabrica.fabrica
                                LEFT JOIN tbl_cidade ON tbl_hd_chamado_extra.cidade=tbl_cidade.cidade
                                LEFT JOIN tbl_revenda ON tbl_hd_chamado_extra.revenda=tbl_revenda.revenda
                                JOIN tbl_admin ON tbl_hd_chamado.admin=tbl_admin.admin
                                WHERE tbl_hd_chamado.hd_chamado=$hd_chamado
                                AND tbl_hd_chamado.fabrica=$login_fabrica
                                AND tbl_posto_fabrica.fabrica=$login_fabrica ";

                        $res = pg_query($con, $sql);

                        if (pg_num_rows($res)) {

                            $email_preos_codigo_posto     = pg_fetch_result($res, 0, 'codigo_posto');
                            $email_preos_posto_nome       = pg_fetch_result($res, 0, 'posto_nome');
                            $email_preos_fabrica_nome     = pg_fetch_result($res, 0, 'fabrica_nome');
                            $email_preos_data_atendimento = pg_fetch_result($res, 0, 'data_atendimento');
                            $email_preos_nome             = pg_fetch_result($res, 0, 'nome');
                            $email_preos_endereco         = pg_fetch_result($res, 0, 'endereco');
                            $email_preos_numero           = pg_fetch_result($res, 0, 'numero');
                            // $email_preos_complemento      = pg_fetch_result($res, 0, 'complemento');
                            $email_preos_bairro           = pg_fetch_result($res, 0, 'bairro');
                            $email_preos_bairro           = preg_replace("/'/g","",$email_preos_bairro);
                            $email_preos_cidade_nome      = pg_fetch_result($res, 0, 'cidade_nome');
                            $email_preos_cidade_nome      = preg_replace("/'/g","",$email_preos_cidade_nome);
                            $email_preos_estado           = pg_fetch_result($res, 0, 'estado');
                            $email_preos_revenda_nome     = pg_fetch_result($res, 0, 'revenda_nome');
                            $email_preos_revenda_cnpj     = pg_fetch_result($res, 0, 'revenda_cnpj');
                            $email_preos_admin_nome       = pg_fetch_result($res, 0, 'admin_nome');
                            $email_preos_admin_email      = pg_fetch_result($res, 0, 'admin_email');
                            $comunicado_posto             = pg_fetch_result($res, 0, 'posto');

                            if (in_array($login_fabrica,array(52,96,151,186,190,195))) {

                                $sql = " SELECT tbl_produto.referencia,
                                    tbl_produto.descricao
                                        FROM tbl_hd_chamado_item
                                        JOIN tbl_produto ON tbl_hd_chamado_item.produto=tbl_produto.produto
                                        WHERE tbl_hd_chamado_item.hd_chamado=$hd_chamado ";

                                $res = pg_query($con, $sql);

                                $produtos = array();
                                for ($p = 0; $p < pg_num_rows($res); $p++) {
                                    $produtos[] = "[" . pg_fetch_result($res, $p, 'referencia') . "] " . pg_fetch_result($res, $p, 'descricao');
                                }

                                $produtos = implode(", ", $produtos);

                            } else {

                                $sql = " SELECT tbl_produto.referencia,
                                    tbl_produto.descricao
                                        FROM tbl_hd_chamado_extra
                                        JOIN tbl_produto ON tbl_hd_chamado_extra.produto=tbl_produto.produto
                                        WHERE tbl_hd_chamado_extra.hd_chamado = $hd_chamado ";

                                $res = pg_query($con, $sql);

                                $produtos = "[" . pg_fetch_result($res, 0, 'referencia') . "] " . pg_fetch_result($res, 0, 'descricao');

                            }

                            $email_endereco = "";

                            if ($email_preos_endereco)    $email_endereco .= $email_preos_endereco;
                            if ($email_preos_numero)      $email_endereco .= ", " . $email_preos_numero;
                            if ($email_preos_complemento) $email_endereco .= " " . $email_preos_complemento;
                            if ($email_preos_bairro)      $email_endereco .= " - " . $email_preos_bairro;
                            if ($email_preos_cidade_nome) $email_endereco .= " - " . $email_preos_cidade_nome;
                            if ($email_preos_estado)      $email_endereco .= " - " . $email_preos_estado;

                            if ($email_preos_revenda_cnpj) $email_preos_revenda_cnpj = " - " . $email_preos_revenda_cnpj;

                            $message = "Autorizada $email_preos_codigo_posto - $email_preos_posto_nome

                                O Callcenter da Fábrica $email_preos_fabrica_nome, abriu um atendimento que se tornou uma ";

                            if (in_array($login_fabrica, array(30,50,190,195))) {
                                if (in_array($login_fabrica, array(190,195)) && !empty($_POST['data_agendamento'])) {
                                    list($dia, $mes, $ano) = explode("/", $_POST['data_agendamento'][0]);
                                    $data_limite = $ano."-".$mes."-".$dia;
                                }
                                $message .= "OS";
                                if($cliente_admin != ""){
                                    $message .= " com prazo de finalização para $data_limite";
                                }
                            } else {
                                $message .= "pré-OS";
                            }

                            $message .= " para ser atendido pelo seu posto autorizado.  Segue as informações da ";

                            if (in_array($login_fabrica, array(30,50,190,195))) {
                                $message .= "OS";
                            } else {
                                $message .= "pré-OS";
                            }

                            if (in_array($login_fabrica, array(171)) && $_POST['tipo_atendimento_grohe'] == 297) {
                                $message .= "
                                    A data de agendamento da Ordem é: {$_POST['data_agendamento_ordem']}.
                                    Ã necessário efetuar a confirmação do agendamento.
                                ";
                            }

                            $message .= " :
                                Atendimento do Call-Center nº $hd_chamado - Aberto por $email_preos_admin_nome em $email_preos_data_atendimento
                                Produto: $produtos
                                Consumidor: $email_preos_nome ($email_endereco)
                                Revenda: $email_preos_revenda_cnpj $email_preos_revenda_nome";

                            if ( (in_array($login_fabrica, array(169,170))) || ($login_fabrica == 171 && $_POST['tipo_atendimento_grohe'] == 297) ) {
                                $message .= "
                                    A data de agendamento da Ordem é: {$_POST['data_agendamento_ordem']}.
                                    Ã necessário efetuar a confirmação do agendamento.
                                ";
                            }

                            if ($login_fabrica <> 59) {
                                $message .= "
                                Favor completar este atendimento o mais rápido possÃ­vel, e qualquer dÃºvida, entrar em contato com ";
                            }

                            $message .= "$email_preos_admin_nome Callcenter";

                            $message = str_replace("\n", "<br>", $message);

                            $emailDestinatario[] = $email_posto;
			                if(!in_array($login_fabrica,array(174,186))){
                                $emailDestinatario[] = ($login_fabrica == 151) ? $admin_email : $email_preos_admin_email;
                            }

        				    $mailTc = new TcComm($externalId);
        				    $res = $mailTc->sendMail(
        					$emailDestinatario,
        					$subject,
        					$message,
        					$externalEmail
        					);
                        }

                        if ($login_fabrica == 96) $admin_email = "null";

                        $ea_email = false;
                        $ea_email_assunto = $email_preos_fabrica_nome . ' - Nova Ordem de Serviço aberta pelo Call-center';
                        $ea_email_mensagem = '';
                        $ea_email_remetente = '';

                        if($login_fabrica == 156){

                            $sql_comunicado = "SELECT
                                tbl_produto.referencia,
                                tbl_produto.descricao,
                                tbl_hd_chamado_extra.nome,
                                tbl_hd_chamado_extra.os
                                    FROM tbl_hd_chamado_extra
                                    INNER JOIN tbl_produto ON tbl_hd_chamado_extra.produto = tbl_produto.produto
                                    WHERE
                                    tbl_hd_chamado_extra.hd_chamado = $hd_chamado";

                            $res_comunicado = pg_query($con, $sql_comunicado);

                            $referencia_produto = pg_fetch_result($res_comunicado, 0, "referencia");
                            $descricao_produto  = pg_fetch_result($res_comunicado, 0, "descricao");
                            $os_posto           = pg_fetch_result($res_comunicado, 0, "os");
                            $cliente_nome       = pg_fetch_result($res_comunicado, 0, "nome");

                            $subject = "Nova Ordem de Serviço aberta pelo Call-center: <strong>{$os_posto}</strong>";

                            $message = "O Callcenter da Fábrica Elgin Automação, abriu um atendimento que se tornou uma ORDEM DE SERVIÇO para ser atendido pelo seu posto autorizado. <br />
                                Segue as informações da ORDEM DE SERVIÇO nº: <strong>{$os_posto}</strong> <br />
                                Atendimento do Call-Center nº <strong>{$hd_chamado}</strong>. <br />
                                Produto: {$referencia_produto} - {$descricao_produto} <br />
                                Cliente: {$cliente_nome} <br />
                                Favor completar este atendimento o mais rápido possível, e qualquer dúvida, entrar em contato.
                                <br /> <br />
                                Callcenter Elgin Automação";

                            $ea_email_assunto .= ': ' . $os_posto;
                            $ea_email_mensagem = $message;
                        }else{
                            $subject = substr($subject, 0, 50);
                        }

                        $peca                       = "null";
                        $produto                    = "null";
                        $aux_familia                = "null";
                        $aux_linha                  = "null";
                        $aux_extensao               = "null";
                        $aux_descricao              = $subject;
                        $aux_mensagem               = $message;
                        $aux_tipo                   = "Comunicado";
                        $posto                      = ($xcodigo_posto =='null' or empty($xcodigo_posto)) ?$comunicado_posto : $xcodigo_posto;
                        $aux_obrigatorio_os_produto = "'f'";
                        $aux_obrigatorio_site       = "'t'";
                        $aux_tipo_posto             = "null";
                        $aux_ativo                  = "'t'";
                        $aux_estado                 = "null";
                        $aux_pais                   = "'BR'";
                        $remetente_email            = "$admin_email";
                        $pedido_faturado            = "'f'";
                        $pedido_em_garantia         = "'f'";
                        $digita_os                  = "'f'";
                        $reembolso_peca_estoque     = "'f'";

                        $ea_email_remetente = $rementente_email;

                        // if (empty($posto)) {
                        //  $posto = 'null';
                        // }

                        if (in_array($login_fabrica, [175])) {
                            $sqlVerificaLU = "SELECT login_unico
                                              FROM tbl_login_unico
                                              WHERE posto = {$posto}";
                            $resVerificaLU = pg_query($con, $sqlVerificaLU);

                            if (pg_num_rows($resVerificaLU) > 0) {
                                $campo_lu_tecnico = ", tecnico";
                                $valor_lu_tecnico = ", 't'";
                            }

                        }

                        if($login_fabrica <> 59){
                            $sql = "INSERT INTO tbl_comunicado (
                                        peca                   ,
                                        produto                ,
                                        familia                ,
                                        linha                  ,
                                        extensao               ,
                                        descricao              ,
                                        mensagem               ,
                                        tipo                   ,
                                        fabrica                ,
                                        obrigatorio_os_produto ,
                                        obrigatorio_site       ,
                                        posto                  ,
                                        tipo_posto             ,
                                        ativo                  ,
                                        estado                 ,
                                        pais                   ,
                                        remetente_email        ,
                                        pedido_faturado        ,
                                        pedido_em_garantia     ,
                                        digita_os              ,
                                        reembolso_peca_estoque
                                        {$campo_lu_tecnico}
                                    ) VALUES (
                                        $peca                       ,
                                        $produto                    ,
                                        $aux_familia                ,
                                        $aux_linha                  ,
                                        $aux_extensao               ,
                                        '$aux_descricao'            ,
                                        '$aux_mensagem'             ,
                                        '$aux_tipo'                 ,
                                        $login_fabrica              ,
                                        $aux_obrigatorio_os_produto ,
                                        $aux_obrigatorio_site       ,
                                        $posto                      ,
                                        $aux_tipo_posto             ,
                                        $aux_ativo                  ,
                                        $aux_estado                 ,
                                        $aux_pais                   ,
                                        '$remetente_email'          ,
                                        $pedido_faturado            ,
                                        $pedido_em_garantia         ,
                                        $digita_os                  ,
                                        $reembolso_peca_estoque
                                        {$valor_lu_tecnico}
                                    );";
                            $res = pg_query($con, $sql);
                            $msg_erro .= pg_errormessage($con);

                            if ($login_fabrica == 156) {
                                $ea_email = true;
                            }
                        }
                        // echo nl2br($sql);exit;

    //                         }
                    }//IF PARA CONTROLAR ABERTURA DE PRE-OS

                }//IF QUE VERIFICA SE TEM ERROS
                //HD 205933: Habilitar abertura de ORDEM DE SERVIÃO para a Esmaltec

                if ($login_fabrica == 52) {
                    $qtde_produto = $_POST["qtde_produto"];

                    for($count=1; $count<=$qtde_produto; $count++){
                        $serie = $_POST["serie_".$count];

                        if (empty($serie)) {
                            continue;
                        }

                        $sql = "SELECT produto, bloqueada_garantia
                                  FROM tbl_numero_serie
                                 WHERE fabrica = $login_fabrica
                                   AND produto IS NOT NULL
                                   AND serie   = '$serie'";
                        $res = pg_query($con,$sql);

                        // pre_echo(pg_fetch_assoc($res, 0), "PESQUISA SERIE PRODUTO:\n$sql", true);

                        if ($valida_serie_bloqueio == 52 and pg_fetch_result($res, 0, 'bloqueada_garantia') == 't') {
                            $msg_erro .= "número série $serie está bloqueado.";
                        } else {

                            if (!isset($_POST["hd_perdeu_garantia_$count"]))
                                continue;
                            $motivo  = $_POST["hd_motivo_bloqueio_ns_".$count] ? : null;
                            $produto = pg_fetch_result($res, 0, 'produto');

                            if (empty($serie) or is_null($motivo)) {
                                continue;
                            }

                            $sql = " UPDATE tbl_numero_serie
                                        SET bloqueada_garantia = TRUE
                                      WHERE fabrica = $login_fabrica
                                        AND serie   = '$serie'";

                            $resb = pg_query($con,$sql);

                            if (strlen(pg_last_error($con)) > 0) {
                                $msg_erro .= "Erro ao bloquear o número de série '$serie'!";
                                if ($_serverEnvironment == 'development')
                                    $msg_erro .= '<br />DEV: ' . pg_last_error($con);
                            } else {

                                if (pg_num_rows($res) > 0) {

                                    $sql = "INSERT INTO tbl_serie_controle
                                        (fabrica, produto, serie, quantidade_produzida, motivo)
                                        VALUES ($login_fabrica, $produto, '$serie', 0, '$motivo')";
                                    pg_query($con,$sql);

                                    if (strlen(pg_last_error($con)) > 0) {
                                        $msg_erro .= "Erro ao gravar o motivo do bloqueio do número de série!";
                                        if ($_serverEnvironment == 'development')
                                            $msg_erro .= '<br />DEV: ' . pg_last_error($con);
                                    }
                                }
                            }
                        }
                    }

                }

                if(in_array($login_fabrica, array(30,50,171,176,183,190,195))) {
                    $abre_ordem_servico = $_POST['abre_ordem_servico'];
                }

                if ($login_fabrica == 162 && filter_input(INPUT_POST,'interno')) {
                    $abre_ordem_servico = $abre_os;
                }

                if($login_fabrica == 74){
                    $abre_os  = $_POST['abre_os'];
                    $id_posto = $_POST["posto_atual"];
                }
                if($login_fabrica == 74 AND $abre_os == 't'){

                    $id_posto = $_POST["posto_atual"];
                    $referencia = $_POST['produto_referencia'];

                    $comentario = "Foi disponibilizado para o posto a Pré-Ordem de Serviço.";

                    $sql = "INSERT INTO tbl_hd_chamado_item(
                        hd_chamado   ,
                        data         ,
                        comentario   ,
                        admin        ,
                        interno      ,
                        status_item
                    ) values (
                        $hd_chamado,
                        current_timestamp ,
                        E'$comentario',
                        6223,
                        't',
                        $xstatus_interacao
                    )";
                    $res = pg_query($con,$sql);

                    $sql_linha = "select tbl_linha.codigo_linha, numero_serie_obrigatorio
                                        from
                                        tbl_produto
                                        inner join tbl_linha on tbl_produto.linha = tbl_linha.linha
                                        where tbl_produto.referencia = '$referencia'
                                        and tbl_produto.fabrica_i = $login_fabrica  ";
                    $res_linha = pg_query($con, $sql_linha);

                    if(pg_num_rows($res_linha)> 0){
                        $codigo_linha             = pg_fetch_result($res_linha, 0, 'codigo_linha');
                    }

                    if($codigo_linha == "02"){
                        $cond_digita = " AND JSON_FIELD('digita_os_portateis', parametros_adicionais) = 't'";
                    }
                    if($codigo_linha == "01"){
                        $cond_digita = " AND JSON_FIELD('digita_os_fogo', parametros_adicionais) = 't'";
                    }

                    $sql_posto_fabrica = "SELECT posto
                                          FROM tbl_posto_fabrica
                                          WHERE posto = $id_posto
                                          AND tbl_posto_fabrica.fabrica = $login_fabrica
                                          $cond_digita";
                    $res_posto_fabrica = pg_query($con, $sql_posto_fabrica);

                    if(pg_num_rows($res_posto_fabrica) == 0 ){
                        $msg_erro .=  " Esse posto não é autorizado a digitar O.S dessa linha. <br>";
                    }


                    $sql_linha = "select tbl_posto_linha.linha, numero_serie_obrigatorio
                                    from
                                    tbl_produto
                                    inner join tbl_posto_linha on tbl_produto.linha = tbl_posto_linha.linha
                                    where tbl_produto.referencia = '$referencia'
                                    and tbl_produto.fabrica_i = $login_fabrica
                                    AND tbl_posto_linha.posto = $id_posto";
                    $res_linha = pg_query($con, $sql_linha);

                    if(pg_num_rows($res_linha) == 0){
                        $msg_erro .=  " Esse posto não atende essa linha. <br>";
                    }

                }

                if($login_fabrica == 74 AND $abre_ordem_servico == 't'){

                    $id_posto = $_POST["posto_atual"];
                    $referencia = $_POST['produto_referencia'];

                    if(strlen(trim($referencia))>0) {

                        $sql_linha = "select tbl_posto_linha.linha, numero_serie_obrigatorio
                                        from
                                        tbl_produto
                                        inner join tbl_posto_linha on tbl_produto.linha = tbl_posto_linha.linha
                                        where tbl_produto.referencia = '$referencia'
                                        and tbl_produto.fabrica_i = $login_fabrica
                                        AND tbl_posto_linha.posto = $id_posto";
                        $res_linha = pg_query($con, $sql_linha);

                        if(pg_num_rows($res_linha) == 0){
                            $msg_erro .=  " Esse posto não atende essa linha. <br>";
                        }
                    }
                }

                if(in_array($login_fabrica, [158])){
                    if(isset($_POST['abre_ordem_servico_submeteu'])) {
                        if($_POST['abre_ordem_servico_submeteu'] == 'sim' || $_POST['abre_ordem_servico_submeteu'] == 't'){
                            $abre_ordem_servico = 't';
                        }
                    }
                }

                if ($abre_ordem_servico == 't' && strlen($msg_erro) == 0 AND empty($moduloOSMultipla)) {

                    /************************************************************************************/
                    /******************************* VALIDAÃÃES DOS CAMPOS *******************************/
                    /************************************************************************************/
                    $sql = "SELECT  tbl_hd_chamado_extra.hd_chamado,
                        tbl_hd_chamado_extra.posto,
                        tbl_hd_chamado_extra.nome,
                        tbl_cidade.nome AS cidade,
                        tbl_cidade.estado,
                        tbl_hd_chamado_extra.fone,
                        tbl_hd_chamado_extra.cpf,
                        tbl_hd_chamado_extra.qtde_km,
                        tbl_hd_chamado_extra.endereco,
                        tbl_hd_chamado_extra.bairro,
                        tbl_hd_chamado_extra.celular,
                        tbl_hd_chamado_extra.fone2,
                        tbl_hd_chamado_extra.revenda,
                        tbl_hd_chamado_extra.consumidor_revenda,";

                    if (in_array($login_fabrica, array(52,190,195))) {

                        $sql .= "   tbl_hd_chamado_item.produto,
                            tbl_hd_chamado_item.defeito_reclamado,
                            tbl_hd_chamado_item.serie,";

                    }else{

                        $sql .= "   tbl_hd_chamado_extra.produto,
                            tbl_hd_chamado_extra.defeito_reclamado,
                            tbl_hd_chamado_extra.defeito_reclamado_descricao, ";

                    }

                    $sql .= "       tbl_hd_chamado_extra.nota_fiscal,
                        tbl_hd_chamado_extra.data_nf,
                        tbl_hd_chamado_extra.marca,
                        tbl_hd_chamado_extra.serie
                            FROM tbl_hd_chamado_extra
                            LEFT JOIN tbl_cidade ON tbl_hd_chamado_extra.cidade=tbl_cidade.cidade ";

                    if (in_array($login_fabrica, array(52,190,195))) {
                        $sql .= " JOIN tbl_hd_chamado_item on tbl_hd_chamado_item.hd_chamado = tbl_hd_chamado_extra.hd_chamado and tbl_hd_chamado_item.hd_chamado = $hd_chamado";
                    }

                    $sql .= "
                        WHERE tbl_hd_chamado_extra.hd_chamado = $hd_chamado";

                    if (in_array($login_fabrica, array(52,190,195))) {
                        $sql .= " AND tbl_hd_chamado_item.produto is not null
                            AND tbl_hd_chamado_item.serie is not null
                            AND tbl_hd_chamado_item.os is null ";
                    }else{
                        $sql .= " AND tbl_hd_chamado_extra.os isnull";
                    }

                    $res = pg_query($con, $sql);

                    if (pg_num_rows($res)>0 && !in_array($login_fabrica, array(190,195))){
                        for ($i=0; $i < pg_num_rows($res); $i++) {

                            $s_posto                       = trim(pg_fetch_result($res, $i, 'posto'));
                            $s_nome                        = trim(pg_fetch_result($res, $i, 'nome'));
                            $s_cidade                      = trim(pg_fetch_result($res, $i, 'cidade'));
                            $s_estado                      = trim(pg_fetch_result($res, $i, 'estado'));
                            $s_fone                        = trim(pg_fetch_result($res, $i, 'fone'));
                            $s_fone2                       = trim(pg_fetch_result($res, $i, 'fone2'));
                            $s_celular                     = trim(pg_fetch_result($res, $i, 'celular'));
                            $s_cpf                         = trim(pg_fetch_result($res, $i, 'cpf'));
                            $s_endereco                    = trim(pg_fetch_result($res, $i, 'endereco'));
                            $s_bairro                      = trim(pg_fetch_result($res, $i, 'bairro'));
                            $s_produto                     = trim(pg_fetch_result($res, $i, 'produto'));
                            $s_defeito_reclamado           = trim(pg_fetch_result($res, $i, 'defeito_reclamado'));
                            $s_defeito_reclamado_descricao = trim(pg_fetch_result($res, $i, 'defeito_reclamado_descricao'));
                            $s_nota_fiscal                 = trim(pg_fetch_result($res, $i, 'nota_fiscal'));
                            $s_data_nf                     = trim(pg_fetch_result($res, $i, 'data_nf'));
                            $s_revenda                     = trim(pg_fetch_result($res, $i, 'revenda'));
                            $s_marca                       = trim(pg_fetch_result($res, $i, 'marca'));
                            $s_serie                       = trim(pg_fetch_result($res, $i, "serie"));

                            if (empty($s_posto)) {
                                $msg_erro .= "Para abertura de ORDEM DE SERVIÃO, informar o posto autorizado<br>";
                            }

                            if (empty($s_nome)) {
                                $msg_erro .= "Para abertura de ORDEM DE SERVIÃO, informe o nome do consumidor<br>";
                            }

                            if ((empty($s_cidade) && $login_fabrica != 52) || (empty($s_cidade) && $login_fabrica == 52 && $_POST['consumidor_pais'] == "BR" )) {
                                $msg_erro .= "Para abertura de ORDEM DE SERVIÃO, informe a cidade o consumidor<br>";
                            }

                            if ((empty($s_estado) && $login_fabrica != 52) || (empty($s_estado) && $login_fabrica == 52 && $_POST['consumidor_pais'] == "BR" )) {
                                $msg_erro .= "Para abertura de ORDEM DE SERVIÃO, informe o estado do consumidor<br>";
                            }

                            if (empty($s_fone) && empty($s_celular) && empty($s_fone2) && !in_array($login_fabrica, array(158))){
                                $msg_erro .= "Para abertura de ORDEM DE SERVIÃO, informe pelo menos um dos telefones do cliente<br>";
                            }

                            if (empty($s_cpf) && !in_array($login_fabrica, array(30, 50, 52, 158))) {
                                $msg_erro .= "Para abertura de ORDEM DE SERVIÃO, informe o CPF do consumidor<br>";
                            }

                            if (empty($s_endereco)){
                                $msg_erro .= "Para abertura de ORDEM DE SERVIÃO, informe o endereço do consumidor<br>";
                            }

                            if (empty($s_bairro)) {
                                $msg_erro .= "Para abertura de ORDEM DE SERVIÃO, informe o bairro do consumidor<br>";
                            }

                            if (empty($s_produto)) {
                                $msg_erro .= "Para abertura de ORDEM DE SERVIÃO, informe o produto<br>";
                            }

                            if (!in_array($login_fabrica, array(52))) {

                                if (empty($s_defeito_reclamado) && empty($s_defeito_reclamado_descricao)){
                                    if ($login_fabrica != 74 and $tab_atual != 'garantia_adicional') {
                                        $msg_erro .= "Para abertura de ORDEM DE SERVIÃO, informe o defeito reclamado no produto<br>";
                                    }
                                }

                            }else{

                                if (empty($s_defeito_reclamado)){
                                    $msg_erro .= "Para abertura de ORDEM DE SERVIÃO, informe o defeito reclamado no produto<br>";
                                }

                            }

                            if ($login_fabrica == 162) {
                                if(empty($s_revenda)) {
                                    $msg_erro .= "Para abertura de ORDEM DE SERVIÃO, informe a revenda<br>";
                                }
                            }

                            if ($login_fabrica != 158 && $login_fabrica != 171) {
                                if (empty($s_nota_fiscal)) {
                                    $msg_erro .= "Para abertura de ORDEM DE SERVIÃO, informe o número da nota fiscal<br>";
                                }

                                if (empty($s_data_nf)) {
                                    $msg_erro .= "Para abertura de ORDEM DE SERVIÃO, informe a data da nota fiscal<br>";
                                }
                            }
                        }
                    }

                    if ($login_fabrica == 74) {
                        $consumidor_cidade = trim($consumidor_cidade);
                        $posto_contato_cidade = trim($posto_contato_cidade);

                        if (empty($consumidor_cidade)) {
                            $msg_erro .= "Para abertura de ORDEM DE SERVIÃO, informe a cidade do consumidor<br>";
                        }

                        if (empty($posto_contato_cidade)) {
                            $sqlPostoCidade = "
                                SELECT pf.contato_cidade FROM tbl_hd_chamado_extra hce
                                INNER JOIN tbl_posto_fabrica pf ON pf.posto = hce.posto AND pf.fabrica = {$login_fabrica}
                                WHERE hce.hd_chamado = {$hd_chamado}
                            ";
                            $resPostoCidade = pg_query($con, $sqlPostoCidade);
                            $posto_contato_cidade = pg_fetch_result($resPostoCidade, 0, "contato_cidade");
                        }

                        if (empty($posto_contato_cidade)) {
                            $msg_erro .= "Para abertura DE ORDEM DE SERVIÃO, informe a cidade do posto autorizado<br>";
                        }
                    }

           		    if (in_array($login_fabrica,[169,170]) and !empty($s_posto)){
               			$sqlP = "SELECT posto FROM tbl_posto_fabrica where posto = $s_posto and fabrica = $login_fabrica and parametros_adicionais ~'abre_os_dealer' and parametros_adicionais::jsonb->>'abre_os_dealer'='t' ";
               			$resP = pg_query($con, $sqlP);
               			if(pg_num_rows($resP) > 0 )  {
               			    $msg_erro .= "O posto autorizado selecionado não está habilitado para abertura de ordem de serviço através do callcenter";
               			}
        		    }

                    if (strlen($msg_erro) == 0 ) {
                        /************************************************************************************/
                        /********************************** INSERÃÃO DA OS **********************************/
                        /************************************************************************************/

                        //CASO A FABRICA FOR GERAR OS POR PRODUTO, UTILIZAR aqui
                        if(in_array($login_fabrica,array(190,195))){

                            $sqlItens = "SELECT * FROM tbl_hd_chamado_item WHERE produto IS NOT NULL AND hd_chamado=$hd_chamado";
                            $resItens = pg_query($con, $sqlItens);

                            if (pg_num_rows($resItens) > 0) {
                                $observacao_os = $_POST['observacao_os'];
                                foreach (pg_fetch_all($resItens) as $kky => $xrows) {

                                    $xcodigo_posto      = $xrows['posto'];
                                    $xxos               = $xrows['os'];
                                    $xxhd_chamado_item  = $xrows['hd_chamado_item'];
                                    $xxproduto  = $xrows['produto'];
                                    $xxserie  = $xrows['serie'];
                                    $xxdata_nf  = $xrows['data_nf'];

                                    $os_ja_aberta   = false;
                                    $aberturaOs     = "CURRENT_DATE";
                                    if (strlen($xxos) > 0) {
                                        $os_ja_aberta = true;
                                    }
                                   
                                    if (!$os_ja_aberta) {

                                        $campoProjeto = "";
                                        $valorProjeto = "";

                                        if (strlen($tipo_atendimento_os) > 0) {
                                            $campo_tipo_atendimento = ", tipo_atendimento";
                                            $valor_tipo_atendimento = ", {$tipo_atendimento_os}";
                                        }

                                        $sql = "INSERT INTO tbl_os (
                                            fabrica,
                                            validada,
                                            posto,
                                            data_abertura,
                                            consumidor_nome,
                                            consumidor_cidade,
                                            consumidor_estado,
                                            consumidor_fone,
                                            consumidor_cpf,
                                            consumidor_endereco,
                                            consumidor_numero,
                                            consumidor_cep,
                                            consumidor_complemento,
                                            consumidor_bairro,
                                            consumidor_email,
                                            consumidor_celular,
                                            consumidor_fone_comercial,
                                            consumidor_revenda,
                                            revenda,
                                            revenda_cnpj,
                                            revenda_nome,
                                            revenda_fone,
                                            produto,
                                            serie,
                                            defeito_reclamado,
                                            defeito_reclamado_descricao,
                                            nota_fiscal,
                                            data_nf,
                                            marca,
                                            admin,
                                            hd_chamado,
                                            cliente_admin,
                                            obs,
                                            observacao
                                            $campo_tipo_atendimento
                                            $campoImei
                                            $campoProjeto
                                        ) SELECT $login_fabrica, current_timestamp,
                                            tbl_hd_chamado_extra.posto,
                                            $aberturaOs,
                                            tbl_hd_chamado_extra.nome,
                                            tbl_cidade.nome,
                                            tbl_cidade.estado,
                                            tbl_hd_chamado_extra.fone,
                                            tbl_hd_chamado_extra.cpf,
                                            tbl_hd_chamado_extra.endereco,
                                            tbl_hd_chamado_extra.numero,
                                            tbl_hd_chamado_extra.cep,
                                            tbl_hd_chamado_extra.complemento,
                                            tbl_hd_chamado_extra.bairro,
                                            tbl_hd_chamado_extra.email,
                                            tbl_hd_chamado_extra.celular,
                                            tbl_hd_chamado_extra.fone2,
                                            tbl_hd_chamado_extra.consumidor_revenda,
                                            tbl_hd_chamado_extra.revenda,
                                            tbl_hd_chamado_extra.revenda_cnpj,
                                            tbl_hd_chamado_extra.revenda_nome, 
                                            '$fone_revenda',
                                            tbl_hd_chamado_item.produto,

                                            tbl_hd_chamado_item.serie,
                                            tbl_hd_chamado_item.defeito_reclamado,
                                            tbl_hd_chamado_extra.defeito_reclamado_descricao,
                                            tbl_hd_chamado_item.nota_fiscal,
                                            tbl_hd_chamado_item.data_nf,
                                            tbl_hd_chamado_extra.marca,
                                            tbl_hd_chamado.admin,
                                            $hd_chamado,
                                            tbl_hd_chamado.cliente_admin,
                                            'Ordem de Serviço aberta pelo CallCenter, atendimento $hd_chamado',                               
                                            '$observacao_os'
                                            $valor_tipo_atendimento
                                            $valorImei                                
                                        FROM tbl_hd_chamado
                                        JOIN tbl_hd_chamado_extra ON tbl_hd_chamado.hd_chamado=tbl_hd_chamado_extra.hd_chamado    
                                        JOIN tbl_hd_chamado_item on tbl_hd_chamado.hd_chamado = tbl_hd_chamado_item.hd_chamado  
                                   LEFT JOIN tbl_revenda ON tbl_hd_chamado_extra.revenda=tbl_revenda.revenda
                                   LEFT JOIN tbl_cidade ON tbl_hd_chamado_extra.cidade=tbl_cidade.cidade
                                      WHERE tbl_hd_chamado.hd_chamado = $hd_chamado 
                                        AND tbl_hd_chamado_item.hd_chamado_item=$xxhd_chamado_item
                                        AND tbl_hd_chamado_item.os is null
                                        RETURNING os, posto; ";
                                        $res = pg_query($con, $sql);
			    $os_aberta = pg_fetch_result($res, 0, 'os');
			    $xcodigo_posto = pg_fetch_result($res,0,'posto');
                                                                               
                                        if (!empty($os_aberta)){

                                            $updateStatus    = "UPDATE tbl_os set status_checkpoint = 0, off_line_reservada = 't' $campo_cortesia WHERE os = $os_aberta AND fabrica = $login_fabrica";
                                            $resUpdateStatus = pg_query($con, $updateStatus);
                                            
                                            $sql = "INSERT INTO tbl_hd_chamado_item(
                                                                hd_chamado   ,
                                                                data         ,
                                                                comentario   ,
                                                                admin        ,
                                                                interno      ,
                                                                status_item  ,
                                                                os           ,
                                                                posto
                                                            )values(
                                                                $hd_chamado       ,
                                                                current_timestamp ,
                                                                E'Foi aberta um Ordem de serviço número: <b>$os_aberta</b>',
                                                                $login_admin      ,
                                                                't'  ,
                                                                $xstatus_interacao,
                                                                $os_aberta,
                                                                $xcodigo_posto
                                                            )";
                                            $res = pg_query($con,$sql);
                                            $msg_erro .= pg_errormessage($con);

					}

                                        if (!empty($tipo_atendimento_os)){
                                            $update_atendimento = "UPDATE tbl_hd_chamado_extra set tipo_atendimento = {$tipo_atendimento_os} WHERE hd_chamado = {$hd_chamado}";
                                            $res_update_atendimento = pg_query($con, $update_atendimento);
                                        }
                                    
                                        if (isset($novaTelaOs) AND !empty($os_aberta)) {
                                            $sqlOsProduto = "
                                                INSERT INTO tbl_os_produto
                                                (os, produto, serie)
                                                VALUES
                                                ({$os_aberta}, {$xxproduto}, '{$xxserie}')
                                                ";
                                            $resOsProduto = pg_query($con, $sqlOsProduto);
                                        }

                                        $sqlInt = "
                                            INSERT INTO tbl_os_interacao (
                                                    programa,
                                                    os,
                                                    data,
                                                    comentario,
                                                    interno,
                                                    fabrica,
                                                    admin
                                                    ) VALUES (
                                                        '$programa_insert',
                                                        $os_aberta,
                                                        CURRENT_TIMESTAMP,
                                                        'Os cadastrada através do atendimento $hd_chamado',
                                                        TRUE,
                                                        $login_fabrica,
                                                        $login_admin
                                                        )
                                                    ";

                                        $resInt = pg_query($con,$sqlInt);
                                    }//fecha if os aberta

                                    if (strlen($msg_erro) == 0 && !$os_ja_aberta) {

                                        if(!empty($os_aberta)) {
                                            if(!isset($novaTelaOs)) {
                                                $sql = "SELECT fn_valida_os($os_aberta, $login_fabrica)";
                                                $res = @pg_query($con, $sql);
                                                $erro_valida = pg_errormessage($con);
                                            }else{

                                                $sql = "INSERT INTO tbl_os_extra(os) SELECT os FROM tbl_os LEFT JOIN tbl_os_extra USING(os) WHERE tbl_os.os =$os_aberta and tbl_os_extra.os isnull  ; UPDATE tbl_os SET sua_os = os WHERE OS = $os_aberta and sua_os isnull;";
                                                $res = @pg_query($con, $sql);
                                                $erro_valida = pg_errormessage($con);

                                            }

                                            if (strlen($erro_valida) == 0) {

                                                $sql = "SELECT sua_os FROM tbl_os WHERE os=$os_aberta";
                                                $res = @pg_query($con, $sql);

                                                $msg_erro .= pg_errormessage($con);
                                                $sua_os_aberta = pg_result($res, 0, sua_os);

                                                $sql = "UPDATE tbl_hd_chamado_extra SET os=$os_aberta WHERE hd_chamado=$hd_chamado";
                                                $res = @pg_query($con, $sql);
                                                $msg_erro .= pg_errormessage($con);

                                                if(strlen($cliente_admin) > 0){

                                                    $termino_atendimento = "tbl_hd_chamado.data_providencia";
                                                    
                                                    $sqlUpOs = "
                                                        UPDATE  tbl_os_extra
                                                        SET     termino_atendimento = $termino_atendimento
                                                        FROM    tbl_hd_chamado
                                                        JOIN    tbl_hd_chamado_extra USING (hd_chamado)
                                                        WHERE   tbl_hd_chamado_extra.os     = tbl_os_extra.os
                                                        AND     tbl_hd_chamado.hd_chamado   = $hd_chamado
                                                        AND     tbl_os_extra.os             = $os_aberta
                                                        ";
                                                    $resUpOs = pg_query($con,$sqlUpOs);
                                                    $msg_erro .= pg_errormessage($con);
                                                }
                                            } else {

                                                $erro_valida = explode("CONTEXT", $erro_valida);
                                                $erro_valida = explode("ERROR:", $erro_valida[0]);
                                                $erro_valida = trim($erro_valida[1]);
                                                $msg_erro .= $erro_valida . "<br>";

                                            }
                                        }

                                    }

                                    //auditoria de orcamento
                                    if ($login_fabrica == 190 && strlen($tipo_atendimento_os) > 0){

                                        $sqlVerificaTA =  "SELECT * 
                                                             FROM tbl_tipo_atendimento 
                                                            WHERE fabrica = {$login_fabrica} 
                                                              AND tipo_atendimento = {$tipo_atendimento_os}";
                                        $resVerificaTA = pg_query($con, $sqlVerificaTA);

                                        if (pg_num_rows($resVerificaTA) > 0) {
                                            $tipo_atendimento_desc = pg_fetch_result($resVerificaTA, 0, 'descricao');

                                            if ($tipo_atendimento_desc == 'Orçamento') {

                                                $sqlBuscaStatus = "SELECT * FROM tbl_status_os WHERE descricao='Em analise'";
                                                $resBuscaStatus = pg_query($con, $sqlBuscaStatus);

                                                if (pg_num_rows($resBuscaStatus) > 0) {
                                                    $xstatus_os = pg_fetch_result($resBuscaStatus, 0, 'status_os');

                                                    $sqlStatusOs = "UPDATE tbl_os SET status_os_ultimo = {$xstatus_os} WHERE os = {$os_aberta} AND fabrica = {$login_fabrica}";
                                                    $resStatusOs = pg_query($con, $sqlStatusOs);
                                                    
                                                    if (strlen(pg_last_error()) > 0){
                                                        $msg_erro .= "Erro ao gravar atendimento. #1 <br/>".pg_last_error();
                                                    }
                                                }

                                                $sql = "
                                                    SELECT os FROM tbl_auditoria_os
                                                    WHERE os = {$os_aberta}
                                                    AND auditoria_status = 6
                                                    AND observacao = 'OS em auditoria de Orçamento'
                                                    AND liberada IS NULL
                                                    AND cancelada IS NULL
                                                    AND reprovada IS NULL ";
                                                $res = pg_query($con, $sql);

                                                if (pg_num_rows($res) == 0){
                                                    $sql = "
                                                        INSERT INTO tbl_auditoria_os
                                                            (os, auditoria_status, observacao, bloqueio_pedido)
                                                        VALUES
                                                            ({$os_aberta}, 6, 'OS em auditoria de Orçamento', false)";
                                                    $res = pg_query($con, $sql);
                                                    
                                                    if (strlen(pg_last_error()) > 0){
                                                        $msg_erro .= "Erro ao gravar atendimento. #1 <br/>";
                                                    }                                        
                                                }
                        						$contrato = $_POST["contrato"];
                        						if (strlen($contrato) > 0) {
                        							$sqlContratoOS = "INSERT INTO tbl_contrato_os (os, contrato) VALUES ({$os_aberta},{$contrato})";
                        							$resContratoOS = pg_query($con, $sqlContratoOS);
                        							if (pg_last_error()) {
                        							    $msg_erro .= "Não é possÃ­vel abrir Ordem de Serviço #1";
                        							}
                        						}
                                            }

                                            if (in_array($tipo_atendimento_desc, ['Garantia'])) {

                                                if (!empty($xxproduto) && !empty($xxdata_nf)) {
                                                    $sql = "SELECT garantia
                                                              FROM tbl_produto 
                                                             WHERE fabrica_i = {$login_fabrica} 
                                                               AND produto = {$xxproduto}";
                                                    $res = pg_query($con, $sql);

                                                    if (pg_num_rows($res) > 0) {
                                                     
                                                        $garantia = pg_fetch_result($res, 0, "garantia");
                                                        $hj = date('Y-m-d');
                                                        if (strtotime($xxdata_nf." +{$garantia} months") < strtotime($hj)) {
                                                                $msg_erro .= "Produto fora de garantia, não é possÃ­vel abrir Ordem de Serviço<br>";
                                                        } else {
                            								$contrato = $_POST["contrato"];
                            								if (strlen($contrato) > 0) {
                            									$sqlContratoOS = "INSERT INTO tbl_contrato_os (os, contrato) VALUES ({$os_aberta},{$contrato})";
                            									$resContratoOS = pg_query($con, $sqlContratoOS);
                            									if (pg_last_error()) {
                            									    $msg_erro .= "Não é possÃ­vel abrir Ordem de Serviço #1";
                            									}
                            								}
                                                        }
                                                    }
                                                }
                                            }
                                            $xxconsumidor_cpf = str_replace(['.','/','-'], '', $_POST["consumidor_cpf"]);
                                            $xxcliente_admin  = "";
                                            if (strlen($xxconsumidor_cpf) > 0) {

                                                $sqlClAdm = "SELECT cliente_admin 
                                                               FROM tbl_cliente_admin 
                                                              WHERE cnpj = '{$xxconsumidor_cpf}' 
                                                                AND fabrica={$login_fabrica}";
                                                $resClAdm = pg_query($sqlClAdm);
                                                if (pg_num_rows($resClAdm) > 0) {
                                                    $xxcliente_admin  = pg_fetch_result($resClAdm, 0, 'cliente_admin');
                                                }
						
                                            }
                                            if (in_array($tipo_atendimento_desc, ['Atendimento Corretivo']) && strlen($xxcliente_admin) > 0) {
                                                
                                                $contrato = $_POST["contrato"];
                                                $condContrato = "";
                                                if (strlen($contrato) > 0) {
                                                    $condContrato = " AND CT.contrato=".$contrato;
                                                    $condContratoc = " AND C.contrato=".$contrato;
                                                }
                                                //verifica se o cliente possui contrato e se o mesmo esta vigente e ativo
                                                //buscar todas as os abertas no mes do tipo preventivo ou corretivo
                                                //validar se no contrato a corretiva existe e se nao utrapacou a qtde do mes
                                                //se utrapassar exibir mensagem dizendo que excedeu
                                                //nao deve abrir a os
                                            
                                                $sqlContrato = "SELECT CT.*,
                                                                             (
                                                                                  SELECT tbl_contrato_status.descricao
                                                                                     FROM tbl_contrato_status_movimento 
                                                                                     JOIN tbl_contrato_status ON  tbl_contrato_status.contrato_status = tbl_contrato_status_movimento.contrato_status
                                                                                     WHERE tbl_contrato_status_movimento.contrato = CT.contrato ORDER BY tbl_contrato_status_movimento.data desc LIMIT 1
                                                                             ) AS status_contrato_descricao
                                                                        FROM tbl_contrato CT
                                                                        JOIN tbl_cliente_admin CA ON CA.cliente_admin = CT.cliente  
                                                                        WHERE CT.fabrica={$login_fabrica}  
                                                                         AND CT.cliente = {$xxcliente_admin}
                                                                         $condContrato
                                                                         ";
                                                $resContrato = pg_query($con, $sqlContrato);

                                                if (pg_num_rows($resContrato) > 0) {
                                                    $contrato = pg_fetch_result($resContrato, 0, 'contrato');
                                                    $qtde_preventiva = pg_fetch_result($resContrato, 0, 'qtde_preventiva');
                                                    $qtde_corretiva  = pg_fetch_result($resContrato, 0, 'qtde_corretiva');
                                                    $data_vigencia   = pg_fetch_result($resContrato, 0, 'data_vigencia');
                                                    $status_contrato_descricao   = pg_fetch_result($resContrato, 0, 'status_contrato_descricao');
                                                    if (strtotime($data_vigencia) > strtotime(date("Y-m-d")) && $status_contrato_descricao == "Ativo") {

                                                        $sqlOs = "SELECT count(O.os) 
                                                                    FROM tbl_os O 
                                                                    JOIN tbl_contrato_os CO ON CO.os = O.os  
                                                                    JOIN tbl_contrato C ON C.contrato = CO.contrato  
                                                                    JOIN tbl_cliente_admin CA ON CA.cliente_admin = C.cliente  AND CA.fabrica={$login_fabrica} 
                                                                   WHERE O.data_abertura BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-t")."'
                                                                     AND O.fabrica={$login_fabrica} 
                                                                     AND O.tipo_atendimento = $tipo_atendimento_os
                                                                     $condContratoc";

                                                        $resOs = pg_query($con, $sqlOs);
                                                        if (pg_num_rows($resOs) > 0) {

                                                            $total_os_abertas = pg_num_rows($resOs);

                                                            if ($total_os_abertas > $qtde_corretiva) {
                                                                $msg_erro .= "Não é possÃ­vel abrir Ordem de Serviço, pois excedeu o limite de O.Ss do Contrato";
                                                            } else {
                                                                $sqlContratoOS = "INSERT INTO tbl_contrato_os (os, contrato) VALUES ({$os_aberta},{$contrato})";
                                                                $resContratoOS = pg_query($con, $sqlContratoOS);
                                                                if (pg_last_error()) {
                                                                    $msg_erro .= "Não é possÃ­vel abrir Ordem de Serviço #1";
                                                                }
                                                            }
                                                        } 
                                                    } else {
                                                        $msg_erro .= "Contrato expirado ou Inativo";
                                                    } 
                                                } else {
                                                    $msg_erro .= "Não é possÃ­vel abrir Ordem de Serviço, pois o Cliente não possui Contrato";
                                                }
                                            }
                                        }
                                    }

                                    if (count($_POST['os_visita']) > 0 || count($_POST['data_agendamento']) && in_array($login_fabrica, array(190,195))) {
                                        $visitas = $_POST['os_visita'];
                                        $xperiodo = $_POST['periodo'];
                                        $data_agendamento = $_POST['data_agendamento'];
                                        $datas = $_POST['data_agendamento'];
                                        $datas = array_filter($datas);

                                        if(count($_POST['os_visita']) == 0 AND count($datas) > 0){

                                            list($d,$m,$y) = explode("/", $datas[0]);

                                            if(!checkdate($m,$d,$y)){
                                                $xdata_agendamento = "";
                                            }else{
                                                $xdata_agendamento = "$y-$m-$d";


                                                $countAgenda = "SELECT COUNT(*) FROM tbl_tecnico_agenda WHERE fabrica = {$login_fabrica} AND os = {$os_aberta};";
                                                $resCountAgenda = pg_query($con,$countAgenda);

                                                $ordem = pg_fetch_result($resCountAgenda, 0, 0);
                                                $ordem += 1;

                                                $sqlAgenda = "
                                                    INSERT INTO tbl_tecnico_agenda (
                                                                                    fabrica,
                                                                                    admin,
                                                                                    os,
                                                                                    data_agendamento,
                                                                                    ordem,
                                                                                    periodo
                                                                                ) VALUES (
                                                                                    {$login_fabrica},
                                                                                    {$login_admin},
                                                                                    {$os_aberta},
                                                                                    '{$xdata_agendamento}',
                                                                                    $ordem, 
                                                                                    '$xperiodo'
                                                                                );
                                                ";

                                                $res = pg_query($con,$sqlAgenda);

                                                if (strlen(pg_last_error()) > 0) {
                                                    $msg_erro .= "Ocorreu um erro no agendamento da ordem de serviço para o posto #1";
                                                } else {
                                                    $sqlInteracao = "
                                                        INSERT INTO tbl_hd_chamado_item (
                                                                                          hd_chamado,
                                                                                          data,
                                                                                          comentario,
                                                                                          admin,interno,
                                                                                          status_item
                                                                                        ) VALUES (
                                                                                          {$hd_chamado},
                                                                                          NOW(),
                                                                                          'A OS {$os_aberta} foi agendada para: {$datas[0]} , no perÃ­odo da: {$periodo}',
                                                                                          {$login_admin},
                                                                                          't',
                                                                                          {$xstatus_interacao}
                                                                                        );
                                                    ";
                                                    $resInteracao = pg_query($con,$sqlInteracao);

                                                    if (strlen(pg_last_error()) > 0) {
                                                        $msg_erro .= "Ocorreu um erro no agendamento da ordem de serviço para o posto #2";
                                                    } else {
                                                        if (empty($os_aberta)) {
                                                            $titAgenda = "Agendamento OS {$os_aberta}";
                                                            $msgAgenda = "A visita para a OS {$os_aberta} está agendada para o dia: {$datas[0]} , no perÃ­odo da: {$xperiodo}.";
                                                            $sqlComunicado = "
                                                                INSERT INTO tbl_comunicado (
                                                                                              mensagem,
                                                                                              descricao,
                                                                                              tipo,
                                                                                              fabrica,
                                                                                              obrigatorio_site,
                                                                                              posto,
                                                                                              ativo
                                                                                            ) VALUES (
                                                                                            '{$msgAgenda}',
                                                                                            '{$titAgenda}',
                                                                                            'Comunicado',
                                                                                            {$login_fabrica},
                                                                                            't',
                                                                                            {$xcodigo_posto},
                                                                                            't'
                                                                                        );
                                                            ";
                                                            $resComunicado = pg_query($con,$sqlComunicado);

                                                            if (strlen(pg_last_error()) > 0) {
                                                                $msg_erro .= "Ocorreu um erro no agendamento da ordem de serviço para o posto #3";
                                                            } 
                                                        }
                                                    }
                                                }
                                            }

                                        }


                                    }

                                    //Envia e-mail para o posto informando OS cadastrada
                                    if (strlen($msg_erro) == 0) {

                                        $sql = "SELECT email FROM tbl_admin WHERE admin = $login_admin AND fabrica = $login_fabrica";
                                        $res = pg_query($con,$sql);
                                        $msg_erro .= pg_errormessage($con);


                                        if (pg_num_rows($res) > 0) {
                                            $admin_email = pg_fetch_result($res, 0, 'email');
                                        } else {
                                            $admin_email = $sac_email;
                                        }

                                        $sql = "SELECT contato_email FROM tbl_posto_fabrica WHERE posto = $xcodigo_posto AND fabrica=$login_fabrica";
                                        $res = pg_query($con,$sql);

                                        if (pg_num_rows($res) > 0) {
                                            $email_posto = pg_fetch_result($res, 0, 'contato_email');
                                        } else {
                                            $sql = "SELECT email from tbl_posto where posto = $xcodigo_posto";
                                            $res = pg_query($con, $sql);
                                            $email_posto = pg_fetch_result($res, 0, email);
                                        }

                                        
                                        $subject  = "Nova ORDEM DE SERVIÇO nº $sua_os_aberta :: $login_fabrica_nome
                                                ";

                                        //Mensagem de abertura de ORDEM DE SERVICO
                                        $sql = "SELECT
                                            tbl_posto_fabrica.codigo_posto AS codigo_posto,
                                            tbl_posto.nome AS posto_nome,
                                            tbl_fabrica.nome AS fabrica_nome,
                                            TO_CHAR(tbl_hd_chamado.data, 'DD/MM/YY HH24:MI') AS data_atendimento,
                                            tbl_hd_chamado_extra.nome,
                                            tbl_hd_chamado_extra.endereco,
                                            tbl_hd_chamado_extra.numero,
                                            tbl_hd_chamado_extra.complemento,
                                            tbl_hd_chamado_extra.bairro,
                                            tbl_cidade.nome AS cidade_nome,
                                            tbl_cidade.estado,
                                            tbl_hd_chamado_extra.revenda_nome,
                                            tbl_revenda.cnpj AS revenda_cnpj,
                                            tbl_admin.nome_completo AS admin_nome
                                                FROM tbl_hd_chamado
                                                JOIN tbl_hd_chamado_extra ON tbl_hd_chamado.hd_chamado=tbl_hd_chamado_extra.hd_chamado
                                                JOIN tbl_posto ON tbl_hd_chamado_extra.posto=tbl_posto.posto
                                                JOIN tbl_posto_fabrica ON tbl_posto.posto=tbl_posto_fabrica.posto
                                                JOIN tbl_fabrica ON tbl_posto_fabrica.fabrica=tbl_fabrica.fabrica
                                                LEFT JOIN tbl_cidade ON tbl_hd_chamado_extra.cidade=tbl_cidade.cidade
                                                LEFT JOIN tbl_revenda ON tbl_hd_chamado_extra.revenda=tbl_revenda.revenda
                                                JOIN tbl_admin ON tbl_hd_chamado.admin=tbl_admin.admin

                                                WHERE tbl_hd_chamado.hd_chamado=$hd_chamado
                                                AND tbl_hd_chamado.fabrica=$login_fabrica
                                                AND tbl_posto_fabrica.fabrica=$login_fabrica ";
                                        $res = pg_query($con, $sql);

                                        if (pg_num_rows($res)) {

                                            $email_os_codigo_posto     = pg_fetch_result($res, 0, 'codigo_posto');
                                            $email_os_posto_nome       = pg_fetch_result($res, 0, 'posto_nome');
                                            $email_os_fabrica_nome     = pg_fetch_result($res, 0, 'fabrica_nome');
                                            $email_os_data_atendimento = pg_fetch_result($res, 0, 'data_atendimento');
                                            $email_os_nome             = pg_fetch_result($res, 0, 'nome');
                                            $email_os_endereco         = pg_fetch_result($res, 0, 'endereco');
                                            $email_os_numero           = pg_fetch_result($res, 0, 'numero');
                                            $email_os_complemento      = pg_fetch_result($res, 0, 'complemento');
                                            $email_os_bairro           = pg_fetch_result($res, 0, 'bairro');
                                            $email_os_cidade_nome      = addslashes(pg_fetch_result($res, 0, 'cidade_nome'));
                                            $email_os_estado           = pg_fetch_result($res, 0, 'estado');
                                            $email_os_revenda_nome     = pg_fetch_result($res, 0, 'revenda_nome');
                                            $email_os_revenda_cnpj     = pg_fetch_result($res, 0, 'revenda_cnpj');
                                            $email_os_admin_nome       = pg_fetch_result($res, 0, 'admin_nome');


                                            $email_endereco = "";

                                            if ($email_os_endereco)     $email_endereco .= $email_os_endereco;
                                            if ($email_os_numero)       $email_endereco .= ", " . $email_os_numero;
                                            if ($email_os_complemento)  $email_endereco .= " " . $email_os_complemento;
                                            if ($email_os_bairro)       $email_endereco .= " - " . $email_os_bairro;
                                            if ($email_os_cidade_nome)  $email_endereco .= " - " . $email_os_cidade_nome;
                                            if ($email_os_estado)       $email_endereco .= " - " . $email_os_estado;
                                            if ($email_os_revenda_cnpj) $email_os_revenda_cnpj = " - " . $email_os_revenda_cnpj;

                                            $message = "<p> Autorizada $email_os_codigo_posto - $email_os_posto_nome </p>
                                                <p >O Callcenter da Fábrica $email_os_fabrica_nome, abriu um atendimento que se tornou uma ORDEM DE SERVIÇO para ser atendido pelo seu posto autorizado.</p>
                                                <p >Segue as informações da ORDEM DE SERVIÇO nº $sua_os_aberta:</p>
                                                <p >    Atendimento do Call-Center nº $hd_chamado - Aberto por $email_os_admin_nome em $email_os_data_atendimento </p>
                                                ";
                                            $message .= "<p > Produto: $produtos</p>";

                                            $message .= "<p >Consumidor: $email_os_nome ($email_endereco) </p>
                                                <p >Revenda: $email_os_revenda_cnpj $email_os_revenda_nome </p>
                                                <p >Favor completar este atendimento o mais rápido possível, e qualquer dúvida, entrar em contato.</p>
                                                <p >$email_os_admin_nome</p>
                                                <p>Callcenter $login_fabrica_nome</p>";


                                            $message = str_replace("\n", "<br>", $message);
                                            $headers = "From: Call-center <$admin_email>\n";

                                            $headers .= "MIME-Version: 1.0\n";
                                            $headers .= "Content-type: text/html; charset=iso-8859-1\n";

                                            if(empty($msg_erro)){

                                                if (!empty($sua_os_aberta)){

                                                    $mailTc = new TcComm($externalId);//classe

                                                    //$mailer->IsSMTP();
                                                    //$mailer->IsHTML(true);
                                                    $mailTc->setEmailSubject($subject);
                                                    $mailTc->addToEmailBody($message);
                                                    $mailTc->setEmailFrom($externalEmail);

                                                    //$mailer->Subject = $subject;
                                                    //$mailer->Body = $message;
                                                }


                                                if ($admin_email) {
                                                    //$mailer->ClearAddresses();
                                                    $mailTc->addEmailDest($admin_email);
                                                    //$mailer->Send();
                                                }
                                            }
                                        }

                                        $insereComunicado = 't';
                                       
                                        $peca                       = "null";
                                        $produto                    = "null";
                                        $aux_familia                = "null";
                                        $aux_linha                  = "null";
                                        $aux_extensao               = "null";
                                        $aux_descricao              = substr($subject, 0, 79);
                                        $aux_mensagem               = $message;
                                        $aux_tipo                   = "Comunicado";
                                        $posto                      = $xcodigo_posto;
                                        $aux_obrigatorio_os_produto = "'f'";
                                        $aux_obrigatorio_site       = "'t'";
                                        $aux_tipo_posto             = "null";
                                        $aux_ativo                  = "'t'";
                                        $aux_estado                 = "null";
                                        $aux_pais                   = "'BR'";
                                        $remetente_email            = "$admin_email";
                                        $pedido_faturado            = "'f'";
                                        $pedido_em_garantia         = "'f'";
                                        $digita_os                  = "'f'";
                                        $reembolso_peca_estoque     = "'f'";

                                        if (empty($posto)) {
                                            $posto = 'null';
                                        }

                                        $aux_mensagem = pg_escape_string($con,$aux_mensagem);

                                        if (empty($msg_erro) and $insereComunicado == 't') {

                                            $sql = "INSERT INTO tbl_comunicado (
                                                        peca                   ,
                                                        produto                ,
                                                        familia                ,
                                                        linha                  ,
                                                        extensao               ,
                                                        descricao              ,
                                                        mensagem               ,
                                                        tipo                   ,
                                                        fabrica                ,
                                                        obrigatorio_os_produto ,
                                                        obrigatorio_site       ,
                                                        posto                  ,
                                                        tipo_posto             ,
                                                        ativo                  ,
                                                        estado                 ,
                                                        pais                   ,
                                                        remetente_email        ,
                                                        pedido_faturado        ,
                                                        pedido_em_garantia     ,
                                                        digita_os              ,
                                                        reembolso_peca_estoque
                                                        $campoMaster
                                                    ) VALUES (
                                                        $peca                       ,
                                                        $produto                    ,
                                                        $aux_familia                ,
                                                        $aux_linha                  ,
                                                        $aux_extensao               ,
                                                        '$aux_descricao'            ,
                                                        '$aux_mensagem'             ,
                                                        '$aux_tipo'                 ,
                                                        $login_fabrica              ,
                                                        $aux_obrigatorio_os_produto ,
                                                        $aux_obrigatorio_site       ,
                                                        $posto                      ,
                                                        $aux_tipo_posto             ,
                                                        $aux_ativo                  ,
                                                        $aux_estado                 ,
                                                        $aux_pais                   ,
                                                        '$remetente_email'          ,
                                                        $pedido_faturado            ,
                                                        $pedido_em_garantia         ,
                                                        $digita_os                  ,
                                                        $reembolso_peca_estoque
                                                        $valorMaster
                                                    );";

                                            $res = pg_query ($con,$sql);
                                            $msg_erro .= pg_last_error();

                                        }

                                    }//IF QUE VERIFICA SE TEM ERROS - INSERÃÃO DA OS

                                }
                            }

                        } else {


                            $sql = "SELECT posto, os FROM tbl_hd_chamado_extra WHERE hd_chamado=$hd_chamado";
                            $res = pg_query($con,$sql);
                            $xcodigo_posto = trim(pg_fetch_result($res, 0, 'posto'));
                            $xxos = pg_fetch_result($res, 0, os);

                            $os_ja_aberta = false;
                            $aberturaOs = "CURRENT_DATE";
                            if (strlen($xxos) > 0) {
                                $os_ja_aberta = true;
                            }

                            if (!$os_ja_aberta) {
                                if(in_array($login_fabrica,array(30,74))){
                                    $campo_tipo_atendimento = ", tipo_atendimento, qtde_km";
                                }

                                if ($login_fabrica == 162) {
                                    if (filter_input(INPUT_POST,'interno')) {
                                        /*
                                         * - Direcionamento de comunicado para
                                         * Técnico MASTER
                                         */
                                        $campo_tipo_atendimento = " ,
                                            tipo_atendimento,
                                            acessorios,
                                            aparencia_produto,
                                            tecnico
                                        ";

                                        $aux_interno = filter_input(INPUT_POST,'interno');

                                        $sqlTecnico = "
                                            SELECT tbl_tecnico.tecnico
                                            FROM tbl_login_unico
                                            JOIN tbl_tecnico USING (tecnico)
                                            WHERE tbl_login_unico.master IS TRUE
                                            AND tbl_login_unico.tecnico IS NOT NULL
                                            AND tbl_login_unico.posto = {$aux_interno}
                                            AND tbl_tecnico.fabrica = {$login_fabrica};
                                        ";
                                        $resTecnico = pg_query($con,$sqlTecnico);
                                        $tecnicoMaster = pg_fetch_result($resTecnico,0,tecnico);

                                        $valor_tipo_atendimento = "
                                            '$interno_observacao',
                                            $interno_atendimento,
                                            '$interno_acessorios',
                                            '$interno_aparencia',
                                            $tecnicoMaster
                                        ";

                                        /*
                                         * - Data de Abertura de OS
                                         * pode ser data de postagem do produto
                                         * nos Correios
                                         */

                                        $sqlPostagem = "
                                            SELECT tbl_faturamento_correio.data::DATE
                                            FROM tbl_faturamento_correio
                                            JOIN tbl_hd_chamado_postagem USING (fabrica,numero_postagem)
                                            WHERE fabrica = $login_fabrica
                                            AND tbl_hd_chamado_postagem.hd_chamado = $hd_chamado
                                            AND situacao ~* 'Postado';
                                        ";

                                        $resPostagem = pg_query($con,$sqlPostagem);
                                        $dataPostagem = pg_fetch_result($resPostagem,0,data);

                                        if (!empty($dataPostagem)) {
                                            $aberturaOs = "'$dataPostagem'";
                                        }
                                    }

                                    $campoImei = " , rg_produto";
                                    $valorImei = " , '".$imei."'";

                                    $sqlReclamado = "
                                        SELECT  tbl_defeito_reclamado.descricao
                                        FROM    tbl_defeito_reclamado
                                        WHERE   fabrica = $login_fabrica
                                        AND     defeito_reclamado = $defeito_reclamado
                                    ";
                                    $resReclamado = pg_query($con,$sqlReclamado);
                                    $descReclamado = pg_fetch_result($resReclamado,0,descricao);
                                }

                                if ($login_fabrica == 158) {
                                    $cockpit = new Cockpit($login_fabrica);

                                    $sqlCliente = "SELECT parametros_adicionais
                                                     FROM tbl_cliente_admin
						    WHERE cliente_admin = {$cliente_admin} 
						    AND fabrica = {$login_fabrica}
						    AND parametros_adicionais::jsonb->'unidadePrincipal' is not null;";
                                    $resCliente = pg_query($con, $sqlCliente);

                                    if (strlen(pg_last_error($con))) {
                                        $msg_erro = 'Erro ao gravar unidade de negócio';
                                    }

                                    if (pg_num_rows($resCliente) > 0) {
                                        $paAdicionais   = json_decode(pg_fetch_result($resCliente, 0, parametros_adicionais), 1);
                                        $unidadeNegocio = $paAdicionais["unidadePrincipal"];

                                    } else if(isset($_POST['unidade_negocio_imbera'])){
                                        $unidade        = explode("-", $_POST['unidade_negocio_imbera']);
                                        $unidadeNegocio = trim($unidade[0]);
                                        
                                    } else {
                                        $unidadeNegocio = 6400;
                                    }

                                    $unidadesMinasGerais = \Posvenda\Regras::getUnidades("unidadesMinasGerais", $login_fabrica);

                                    if (in_array($unidadeNegocio, $unidadesMinasGerais) || $unidadeNegocio == 6301) {
                                        $tipo_atendimento = $cockpit->getTipoAtendimento("ZKR3");
                                    } else {
                                        $tipo_atendimento = $cockpit->getTipoAtendimento("ZKR3", "GARANTIA");
                                    }

                                    if (empty($tipo_atendimento)) {
                                        $tipo_atendimento = "null";
                                    } else {
                                        $tipo_atendimento = $tipo_atendimento["tipo_atendimento"];
                                    }

                                    $campo_tipo_atendimento = ", tipo_atendimento";
                                    $valor_tipo_atendimento = ", {$tipo_atendimento}";
                                }

                                //hd-3624967 - fputtii
                                if ($login_fabrica == 171) {
                                    if (empty($tipo_atendimento_grohe)){
                                        $tipo_atendimento_grohe = "null";
                                    }
                                    $campoProjeto = ", tipo_atendimento, contrato ";
                                    $valorProjeto = ", $tipo_atendimento_grohe,'$projeto' ";

                                } else {
                                    $campoProjeto = "";
                                    $valorProjeto = "";
                                }

                                if ($login_fabrica == 176) {

                                    $sqlTipo = "SELECT tipo_atendimento
                                                  FROM tbl_tipo_atendimento
                                                 WHERE descricao ILIKE '%Garantia%'
                                                   AND fabrica = {$login_fabrica};";
                                    $resTipo = pg_query($con, $sqlTipo);

                                    if (pg_num_rows($resTipo) > 0) {
                                        $tipo_atendimento = pg_fetch_result($resTipo, 0, 'tipo_atendimento');
                                        $campo_tipo_atendimento = ", tipo_atendimento";
                                        $valor_tipo_atendimento = ", {$tipo_atendimento}";
                                    }

                                }

                                if ($login_fabrica == 183){
                                    $posto_km_tab = str_replace(',','.',$posto_km_tab);
                                    $campo_tipo_atendimento = ", tipo_atendimento, qtde_km";
                                    $valor_tipo_atendimento = ", {$tipo_atendimento_os}, {$posto_km_tab}";

                                    $sql_l = "
                                        SELECT l.linha
                                        FROM tbl_hd_chamado hc
                                        INNER JOIN tbl_hd_chamado_extra hce ON hce.hd_chamado = hc.hd_chamado
                                        INNER JOIN tbl_posto_fabrica pf ON pf.posto = hce.posto
                                        INNER JOIN tbl_produto p ON p.produto = hce.produto AND p.fabrica_i = {$login_fabrica}
                                        INNER JOIN tbl_linha l ON l.linha = p.linha AND l.fabrica = {$login_fabrica}
                                        INNER JOIN tbl_posto_linha pl ON pl.posto = pf.posto AND pl.linha = l.linha
                                        WHERE hc.hd_chamado = {$hd_chamado} ";
                                    $res_l = pg_query($con, $sql_l);

                                    if (pg_num_rows($res_l) == 0){
                                        $msg_erro .= "Posto autorizado não atende a linha do produto <br/>";
                                    }
                                }

                                if (in_array($login_fabrica, [178])) {

                                    $sqlTipo = "SELECT tipo_atendimento FROM tbl_tipo_atendimento WHERE fabrica = 178 AND UPPER(fn_retira_especiais(descricao)) = 'GARANTIA DOMICILIO' AND ativo = 't'";;
                                    $resTipo = pg_query($con, $sqlTipo);

                                    if (pg_num_rows($resTipo) > 0) {
                                        $tipo_atendimento = pg_fetch_result($resTipo, 0, 'tipo_atendimento');
                                        $campo_tipo_atendimento = ", tipo_atendimento";
                                        $valor_tipo_atendimento = ", {$tipo_atendimento}";
                                    }
                                }

                                if (in_array($login_fabrica, array(169, 170))) {

                                    if (strlen(trim($produto)) > 0 AND empty($servico_instalacao)){
                                        $sql_contas_nacionais = "
                                            SELECT
                                                tbl_hd_motivo_ligacao.tipo_registro,
                                                tbl_tipo_atendimento.tipo_atendimento
                                            FROM tbl_hd_motivo_ligacao
                                            JOIN tbl_tipo_atendimento ON tbl_tipo_atendimento.fabrica = tbl_hd_motivo_ligacao.fabrica
                                                AND tbl_tipo_atendimento.fabrica = {$login_fabrica}
                                            WHERE tbl_hd_motivo_ligacao.hd_motivo_ligacao = {$hd_motivo_ligacao}
                                            AND tbl_tipo_atendimento.descricao = 'Garantia - Contas Nacionais'
                                            AND tbl_hd_motivo_ligacao.fabrica = {$login_fabrica}
                                            AND tbl_hd_motivo_ligacao.tipo_registro = 't' ";
                                        $res_contas_nacionais = pg_query($con, $sql_contas_nacionais);

                                        if (pg_num_rows($res_contas_nacionais) > 0){
                                            $tipo_atendimento = pg_fetch_result($res_contas_nacionais, 0, 'tipo_atendimento');
                                        }else{
                                            $sql = "SELECT
                                                        tbl_linha.deslocamento,
                                                        tbl_linha.linha
                                                    FROM tbl_produto
                                                        JOIN tbl_linha ON(tbl_produto.linha = tbl_linha.linha AND tbl_linha.fabrica = {$login_fabrica})
                                                    WHERE tbl_produto.fabrica_i = {$login_fabrica}
                                                    AND tbl_produto.produto = {$produto}";
                                            $res = pg_query($con, $sql);

                                            if (pg_num_rows($res) > 0){
                                                $deslocamento = pg_fetch_result($res, 0, "deslocamento");

                                                if ($deslocamento == 't') {
                                                    $sql = "SELECT
                                                                tipo_atendimento
                                                            FROM tbl_tipo_atendimento
                                                            WHERE km_google IS TRUE
                                                                AND fora_garantia IS NOT TRUE
                                                                AND grupo_atendimento = 'P'
                                                                AND descricao NOT ILIKE '%Nacionais%'
                                                                AND fabrica = {$login_fabrica};";
                                                    $xres = pg_query($con, $sql);
                                                }else{
                                                    $sql = "SELECT
                                                                tipo_atendimento
                                                            FROM tbl_tipo_atendimento
                                                            WHERE km_google IS NOT TRUE
                                                                AND fora_garantia IS NOT TRUE
                                                                AND grupo_atendimento = 'P'
                                                                AND fabrica = {$login_fabrica};";
                                                    $xres = pg_query($con, $sql);
                                                }

                                                if (pg_num_rows($xres) > 0){
                                                    $tipo_atendimento = pg_fetch_result($xres, 0, 'tipo_atendimento');
                                                }
                                            }
                                        }
                                    }else if (strlen(trim($produto)) > 0 AND strlen($servico_instalacao) > 0){
                                        $tipo_atendimento = $servico_instalacao;
                                    }

                                    $sqlCred = "
                                        SELECT tbl_posto_fabrica.credenciamento
                                        FROM tbl_posto
                                        JOIN  tbl_posto_fabrica ON tbl_posto_fabrica.posto = tbl_posto.posto
                                            AND tbl_posto_fabrica.fabrica = {$login_fabrica}
                                        JOIN tbl_hd_chamado_extra ON tbl_hd_chamado_extra.posto = tbl_posto.posto
                                        WHERE tbl_posto_fabrica.credenciamento not in ('DESCREDENCIADO', 'EM DESCREDENCIAMENTO')
                                        AND tbl_hd_chamado_extra.hd_chamado = {$hd_chamado} ";
                                    $resCred = pg_query($con, $sqlCred);

                                    if (pg_num_rows($resCred) == 0){
                                        $msg_erro .= "Erro ao gravar Ordem de Serviço (Posto descredenciado).<br/>";
                                    }

                                    $sql_l = "
                                        SELECT l.linha
                                        FROM tbl_hd_chamado hc
                                        INNER JOIN tbl_hd_chamado_extra hce ON hce.hd_chamado = hc.hd_chamado
                                        INNER JOIN tbl_posto_fabrica pf ON pf.posto = hce.posto
                                        INNER JOIN tbl_produto p ON p.produto = hce.produto AND p.fabrica_i = {$login_fabrica}
                                        INNER JOIN tbl_linha l ON l.linha = p.linha AND l.fabrica = {$login_fabrica}
                                        INNER JOIN tbl_posto_linha pl ON pl.posto = pf.posto AND pl.linha = l.linha
                                        WHERE hc.hd_chamado = {$hd_chamado} ";
                                    $res_l = pg_query($con, $sql_l);

                                    if (pg_num_rows($res_l) == 0){
                                        $msg_erro .= "Erro ao abrir Orderm de Serviço (Posto autorizado não atende a linha do produto <br/>";
                                    }

                                    $sqlVerificaRecall = "SELECT tipo_atendimento
                                                          FROM tbl_hd_motivo_ligacao
                                                          JOIN tbl_tipo_atendimento ON fn_retira_especiais(tbl_tipo_atendimento.descricao) = 'RECALL DOMICILIO'
                                                          AND tbl_tipo_atendimento.fabrica = {$login_fabrica}
                                                          AND tbl_tipo_atendimento.ativo
                                                          WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}
                                                          AND (
                                                            tbl_hd_motivo_ligacao.descricao ~~ 'GARANTIA CORTESIA DOMICILIO - RECALL%' OR
                                                            tbl_hd_motivo_ligacao.descricao ~~ 'GARANTIA DOMICILIO - RECALL%'
                                                          )
                                                          AND tbl_hd_motivo_ligacao.fabrica = {$login_fabrica}";
                                    $resVerificaRecall = pg_query($con, $sqlVerificaRecall);

                                    if (pg_num_rows($resVerificaRecall) > 0) {

                                        $tipo_atendimento = pg_fetch_result($resVerificaRecall, 0, 'tipo_atendimento');

                                    }

                                    $campo_tipo_atendimento = ", tipo_atendimento";
                                    $valor_tipo_atendimento = ", {$tipo_atendimento}";
                                }

                                if($login_fabrica == 30 and $consumidor_revenda == "R"){

                                    if(strlen(trim($posto_tab))==0){
                                        $posto_tab = $_POST["posto_banco"];
                                    }

                                    $sql = "INSERT INTO tbl_os_revenda (
                                        fabrica,
                                        data_abertura,
                                        data_nf,
                                        nota_fiscal,
                                        obs,
                                        digitacao,
                                        posto,
                                        consumidor_nome,
                                        consumidor_cpf,
                                        consumidor_email
                                    ) VALUES (
                                        $login_fabrica,
                                        $aberturaOs,
                                        $xdata_nf,
                                        $xnota_fiscal,
                                        'aberta pelo callcenter',
                                        current_timestamp,
                                        $posto_tab,
                                        $xconsumidor_nome,
                                        $xconsumidor_cpf,
                                        $xconsumidor_email
                                    ) RETURNING  os_revenda";
                                    $res = pg_query($con, $sql);
                                    if(pg_num_rows($res)>0){
                                        $os_revenda = pg_fetch_result($res, 0, 0);

                                        $sql = "INSERT INTO tbl_os_revenda_item (
                                                    os_revenda,
                                                    produto,
                                                    serie,
                                                    nota_fiscal,
                                                    data_nf,
                                                    explodida,
                                                    qtde
                                                ) VALUES (
                                                    $os_revenda,
                                                    $xproduto,
                                                    $xserie,
                                                    $xnota_fiscal,
                                                    $xdata_nf,
                                                    true,
                                                    1
                                                ) RETURNING os_revenda_item";

                                        $res = pg_query ($con,$sql);
                                        $msg_erro = pg_errormessage($con);
                                        if(empty($msg_erro)){
                                            $sua_os_revenda = $os_revenda."-1";
                                            $campos_sua_os_esmaltec = " sua_os, ";
                                            $value_sua_os_esmaltec = " '$sua_os_revenda', ";
                                        }
                                    }
                                }

                                $sql = "INSERT INTO tbl_os (
                                    $campos_sua_os_esmaltec
                                    fabrica,
                                    validada,
                                    posto,
                                    data_abertura,
                                    consumidor_nome,
                                    consumidor_cidade,
                                    consumidor_estado,
                                    consumidor_fone,
                                    consumidor_cpf,
                                    consumidor_endereco,
                                    consumidor_numero,
                                    consumidor_cep,
                                    consumidor_complemento,
                                    consumidor_bairro,
                                    consumidor_email,
                                    consumidor_celular,
                                    consumidor_fone_comercial,
                                    consumidor_revenda,
                                    revenda,
                                    revenda_cnpj,
                                    revenda_nome,
                                    revenda_fone,
                                    produto,
                                    serie,
                                    defeito_reclamado,
                                    defeito_reclamado_descricao,
                                    nota_fiscal,
                                    data_nf,
                                    marca,
                                    admin,
                                    hd_chamado,
                                    cliente_admin,
                                    obs,
                                    observacao
                                        $campo_tipo_atendimento
                                        $campo_esmaltec
                                        $campoImei
                                        $campoProjeto
                                        ) SELECT $value_sua_os_esmaltec $login_fabrica, current_timestamp,
                                    tbl_hd_chamado_extra.posto,
                                    $aberturaOs,
                                    tbl_hd_chamado_extra.nome,
                                    tbl_cidade.nome,
                                    tbl_cidade.estado,
                                    tbl_hd_chamado_extra.fone,
                                    tbl_hd_chamado_extra.cpf,
                                    tbl_hd_chamado_extra.endereco,
                                    tbl_hd_chamado_extra.numero,
                                    tbl_hd_chamado_extra.cep,
                                    tbl_hd_chamado_extra.complemento,
                                    tbl_hd_chamado_extra.bairro,
                                    tbl_hd_chamado_extra.email,
                                    tbl_hd_chamado_extra.celular,
                                    tbl_hd_chamado_extra.fone2,
                                    tbl_hd_chamado_extra.consumidor_revenda,
                                    tbl_hd_chamado_extra.revenda,
                                    tbl_hd_chamado_extra.revenda_cnpj,
                                    tbl_hd_chamado_extra.revenda_nome, ";

                                if (!in_array($login_fabrica, array(52))) {
                                    if ($login_fabrica != 162) {
                                        $sql .= "
                                            tbl_revenda.fone,
                                            tbl_hd_chamado_extra.produto,
                                            tbl_hd_chamado_extra.serie,
                                            tbl_hd_chamado_extra.defeito_reclamado,
                                            tbl_hd_chamado_extra.defeito_reclamado_descricao,
                                            ";
                                    } else {
                                        $sql .= "
                                            tbl_revenda.fone,
                                            tbl_hd_chamado_extra.produto,
                                            tbl_hd_chamado_extra.serie,
                                            tbl_hd_chamado_extra.defeito_reclamado,
                                            '$descReclamado',
                                        ";
                                    }
                                }else{
                                    $sql .= "
                                        '$fone_revenda',
                                        tbl_hd_chamado_item.produto,

                                        tbl_hd_chamado_item.serie,
                                        tbl_hd_chamado_item.defeito_reclamado,
                                        null,
                                        ";
                                }

                                if($login_fabrica == 74){
                                    if(strtoupper(retira_acentos($consumidor_cidade)) == strtoupper(retira_acentos($posto_contato_cidade))){
                                        $posto_km_tab = 0;
                                    }
                                }

                                if (in_array($login_fabrica,array(30,74))) {
                                    if(strlen($posto_km_tab) == 0) $posto_km_tab = 0 ;
                                    $posto_km_tab = str_replace(',','.',$posto_km_tab);
                                    $valor_tipo_atendimento = ", (SELECT tipo_atendimento FROM tbl_tipo_atendimento WHERE fabrica = {$login_fabrica} AND km_google IS TRUE), {$posto_km_tab} ";
                                }

                                $sql .= "
                                    tbl_hd_chamado_extra.nota_fiscal,
                                    tbl_hd_chamado_extra.data_nf,
                                    tbl_hd_chamado_extra.marca,
                                    tbl_hd_chamado.admin,
                                    $hd_chamado,
                                    tbl_hd_chamado.cliente_admin,
                                    'Ordem de Serviço aberta pelo CallCenter, atendimento $hd_chamado',";

                                if (!in_array($login_fabrica, array(30,50))) {
                                    if (in_array($login_fabrica, array(52,186))) {

                                        $sql .= " tbl_hd_chamado_extra.obs_callcenter ";
                                    } else if ($login_fabrica == 162) {
                                        $sql .= $valor_tipo_atendimento;
                                    } else if (in_array($login_fabrica, array(169,170))){
                                        $sql .= " tbl_hd_chamado_extra.obs_callcenter  $valor_tipo_atendimento";
                                    }else {
                                        $sql .= "'Ordem de Serviço aberta pelo CallCenter, atendimento $hd_chamado' $valor_tipo_atendimento ";
                                    }
                                }else{
                                    $sql .= "'$observacao_os'";
                                }
                                if (in_array($login_fabrica, array(30))) {
                                    $sql .= $valor_tipo_atendimento;
                                }

                                $sql .= $valorImei;

                                if ($login_fabrica == 171) {
                                    $sql .= $valorProjeto;
                                }

                                $sql .= "FROM tbl_hd_chamado
                                    JOIN tbl_hd_chamado_extra ON tbl_hd_chamado.hd_chamado=tbl_hd_chamado_extra.hd_chamado
                                    ";
                                if (in_array($login_fabrica, array(52))) {
                                    $sql .= "
                                        JOIN tbl_hd_chamado_item on tbl_hd_chamado.hd_chamado = tbl_hd_chamado_item.hd_chamado
                                        ";
                                }

                                $sql .= "
                                    LEFT JOIN tbl_revenda ON tbl_hd_chamado_extra.revenda=tbl_revenda.revenda
                                    LEFT JOIN tbl_cidade ON tbl_hd_chamado_extra.cidade=tbl_cidade.cidade
                                    WHERE tbl_hd_chamado.hd_chamado = $hd_chamado ";
                               
                            if ($login_fabrica == 52){
                                $sql .= "
                                    AND tbl_hd_chamado_item.produto is not null
                                    AND tbl_hd_chamado_item.serie is not null
                                    AND tbl_hd_chamado_item.os is null
                                    ";
                            }else{
                                $sql.=" AND tbl_hd_chamado_extra.os isnull ";
                            }

                            $sql .= " RETURNING os; ";
			    $res = pg_query($con, $sql);
                            $os_aberta = pg_result($res, 0, 0);

                            //hd-3624967 - fputti
                            if ($login_fabrica == 171 && !empty($pressao_agua_mca)) {

                                $sql = "INSERT INTO tbl_os_extra (os, regulagem_peso_padrao) VALUES ({$os_aberta}, {$pressao_agua_mca})
                                ";
                                $res = pg_query($con, $sql);

                                if(strlen(pg_last_error($con))){
                                    $msg_erro = 'Erro ao gravar Pressão da Agua (MCA)';
                                }

                            }
                            if($login_fabrica == 30 and $posto_km_tab > 0) {
                                $sql = "INSERT INTO tbl_os_status (os,status_os,observacao,automatico) VALUES ($os_aberta,98,'OS entrou em auditoria de km ($posto_km_tab)','t')";
                                $reskm = pg_query($con,$sql);
			    }

			    if($login_fabrica == 183){
				    include_once "../os_cadastro_unico/fabricas/regras.php";
				    include_once "../os_cadastro_unico/fabricas/{$login_fabrica}/regras.php";

				    $sql = "SELECT produto,serie,posto FROM tbl_os WHERE os = {$os_aberta}";
				    $res = pg_query($con,$sql);
				    $os = $os_aberta;
				    $campos["produto"]["id"] = pg_fetch_result($res,0,'produto');
				    $campos["produto"]["serie"] = pg_fetch_result($res,0,'serie');
				    $campos["posto"]["id"] = pg_fetch_result($res,0,'posto');

				    auditoria_os_reincidente_itatiaia();
				    auditoria_numero_serie_bloqueado_itatiaia();
				    unset($campos);
			    }

                            if(in_array($login_fabrica, array(169,170))){

                                if ($os_cortesia == 't'){
                                    $update = "UPDATE tbl_os SET cortesia = 't' WHERE os = {$os_aberta} AND fabrica = {$login_fabrica}";
                                    $res = pg_query($con, $update);
                                }

                                $sql = "INSERT INTO tbl_hd_chamado_item(
                                                    hd_chamado   ,
                                                    data         ,
                                                    comentario   ,
                                                    admin        ,
                                                    interno      ,
                                                    status_item
                                                )values(
                                                    $hd_chamado       ,
                                                    current_timestamp ,
                                                    E'Foi aberta um Ordem de serviço número: <b>$os_aberta</b>',
                                                    $login_admin      ,
                                                    't'  ,
                                                    $xstatus_interacao
                                                )";
                                $res = pg_query($con,$sql);
                                $msg_erro .= pg_errormessage($con);
                            }
                            if ($login_fabrica == 183){
                                $sql_cortesia = "SELECT tipo_atendimento FROM tbl_tipo_atendimento WHERE fabrica = $login_fabrica AND tipo_atendimento = $tipo_atendimento_os AND descricao = 'Cortesia'";
                                $res_cortesia = pg_query($con, $sql_cortesia);

                                if (pg_num_rows($res_cortesia) > 0){
                                    $campo_cortesia = ", cortesia = 't'";
                                }

                                if (!empty($os_aberta)){
                                    $updateStatus = "UPDATE tbl_os set status_checkpoint = 0, off_line_reservada = 't' $campo_cortesia WHERE os = $os_aberta AND fabrica = $login_fabrica";
                                    $resUpdateStatus = pg_query($con, $updateStatus);

                                    $sql = "INSERT INTO tbl_hd_chamado_item(
                                                        hd_chamado   ,
                                                        data         ,
                                                        comentario   ,
                                                        admin        ,
                                                        interno      ,
                                                        status_item  ,
                                                        os           ,
                                                        posto
                                                    )values(
                                                        $hd_chamado       ,
                                                        current_timestamp ,
                                                        E'Foi aberta um Ordem de serviço número: <b>$os_aberta</b>',
                                                        $login_admin      ,
                                                        't'  ,
                                                        $xstatus_interacao,
                                                        $os_aberta,
                                                        $xcodigo_posto
                                                    )";
                                    $res = pg_query($con,$sql);
                                    $msg_erro .= pg_errormessage($con);

                                }

                                if (!empty($tipo_atendimento_os)){
                                    $update_atendimento = "UPDATE tbl_hd_chamado_extra set tipo_atendimento = {$tipo_atendimento_os} WHERE hd_chamado = {$hd_chamado}";
                                    $res_update_atendimento = pg_query($con, $update_atendimento);
                                }

                                if ($posto_km_tab > 250){
                                    $sql = "
                                        SELECT os FROM tbl_auditoria_os
                                        WHERE os = {$os_aberta}
                                        AND auditoria_status = 2
                                        AND observacao = 'OS em auditoria de KM (OS com mais de 250 KM)'
                                        AND liberada IS NULL
                                        AND cancelada IS NULL
                                        AND reprovada IS NULL ";
                                    $res = pg_query($con, $sql);

                                    if (pg_num_rows($res) == 0){
                                        $sql = "
                                            INSERT INTO tbl_auditoria_os
                                                (os, auditoria_status, observacao, bloqueio_pedido)
                                            VALUES
                                                ({$os_aberta}, 2, 'OS em auditoria de KM (OS com mais de 250 KM)', false)";
                                        $res = pg_query($con, $sql);

                                        if (strlen(pg_last_error()) > 0){
                                            $msg_erro .= "Erro ao gravar atendimento. #1 <br/>";
                                        }
                                    }
                                }
                            }

                                // HD-4048450
                                $sqlFabrica = "
                                        SELECT JSON_FIELD('usaMobile', parametros_adicionais) AS usaMobile
                                        FROM tbl_fabrica
                                        WHERE fabrica = {$login_fabrica}";
                                $resFabrica = pg_query($con, $sqlFabrica);
                                $fabricaUsaMobile = pg_fetch_result($resFabrica, 0, 'usaMobile');

                                if(!empty($posto_tab) AND !empty($os_aberta)) {
                                    $sqlPostoFabrica  = "
                                            SELECT JSON_FIELD('usaMobile', parametros_adicionais) AS usaMobile
                                            FROM tbl_posto_fabrica
                                            WHERE fabrica = {$login_fabrica}
                                            AND posto = {$posto_tab}";
                                    $resPostoFabrica  = pg_query($con, $sqlPostoFabrica);
                                    $postoUsaMobile   = pg_fetch_result($resPostoFabrica, 0, 'usaMobile');

                                    if ($fabricaUsaMobile && $postoUsaMobile) {
                                        $sqlTipoAtend = "
                                                SELECT tipo_atendimento
                                                FROM tbl_tipo_atendimento
                                                WHERE fabrica = {$login_fabrica}
                                                AND tipo_atendimento = {$tipo_atendimento}
                                                AND km_google IS TRUE";
                                        $resTipoAtend = pg_query($con, $sqlTipoAtend);

                                        if (pg_num_rows($resTipoAtend) > 0) {
                                            $sqlXoce = "
                                                    SELECT campos_adicionais
                                                    FROM tbl_os_campo_extra
                                                    WHERE fabrica = {$login_fabrica}
                                                    AND os = {$os_aberta}";
                                            $resXoce = pg_query($con, $sqlXoce);
                                            $campoAdcXoce = json_decode(pg_fetch_result($resXoce, 0, 'campos_adicionais'), 1);

                                            //BUSCA LAT LON CLIENTE
                                            $oTcMaps     = new TcMaps($login_fabrica, $con);

                                            $xendereco   = $consumidor_endereco;
                                            $xnumero     = $consumidor_numero;
                                            $xbairro     = $consumidor_bairro;
                                            $xcidade     = $consumidor_cidade;
                                            $xestado     = $consumidor_estado;
                                            $xpais       = "Brasil";
                                            $xcep        = $consumidor_cep;

                                            $response    = $oTcMaps->geocode($xendereco, $xnumero, $xbairro, $xcidade, $xestado, $xpais, $xcep);

                                            $campoAdcXoce["cliente_latitude"]  = $response["latitude"];
                                            $campoAdcXoce["cliente_longitude"] = $response["longitude"];

                                            if (!empty($campoAdcXoce["cliente_latitude"]) AND !empty($campoAdcXoce["cliente_longitude"])){
                                                $novoCampoAdcXoce = json_encode($campoAdcXoce);

                                                if (pg_num_rows($resXoce) > 0){
                                                    $sqlOce = "UPDATE tbl_os_campo_extra
                                                                  SET campos_adicionais = '$novoCampoAdcXoce'
                                                                WHERE fabrica = {$login_fabrica}
                                                                  AND os = {$os_aberta}";
                                                    $resOce = pg_query($con,$sqlOce);
                                                }else{
                                                    $sqlOce = "
                                                            INSERT INTO tbl_os_campo_extra(
                                                                os,
                                                                fabrica,
                                                                campos_adicionais
                                                            )VALUES(
                                                                $os_aberta,
                                                                $login_fabrica,
                                                                '$novoCampoAdcXoce'
                                                            ) ";
                                                    $resOce = pg_query($con,$sqlOce);
                                                }
                                            }else{
                                                $msg_erro = "Latitude e longitude não encontrada, tente novamente!";
                                            }
                                        }
                                    }
                                }
                                // FIM HD-4048450

                                if($login_fabrica == 158){
                                    $dataFabricacao = DateTime::createFromFormat('d/m/Y', $_POST['data_fabricacao']);
                                    $dataFabricacao = date_format($dataFabricacao, 'Y-m-d');

                                    if (strlen($dataFabricacao) > 0) {
                                        $insert = "
                                            INSERT INTO tbl_os_extra
                                            (os, data_fabricacao)
                                            VALUES
                                            ($os_aberta,'$dataFabricacao')
                                        ";
                                        $resOsExtra = pg_query($con,$insert);

                                        if(strlen(pg_last_error($con))){
                                            $msg_erro = 'Erro ao salvar data de fabricação';
                                        }
                                    }

                                    $json_campo_extra = array(
                                        "unidadeNegocio" => $unidadeNegocio,
                                    );

                                    $json_campo_extra = json_encode($json_campo_extra);

                                    $sql_campo_extra = "SELECT * FROM tbl_os_campo_extra WHERE os = {$os_aberta} AND fabrica = $login_fabrica";
                                    $res_campo_extra = pg_query($con, $sql_campo_extra);

                                    if (pg_num_rows($res_campo_extra) > 0){
                                        $update = "
                                            UPDATE tbl_os_campo_extra
                                            SET campos_adicionais = '$json_campo_extra'
                                            WHERE os = {$os_aberta}
                                            AND fabrica = {$login_fabrica}
                                        ";
                                    }else{
                                       $insert = "
                                            INSERT INTO tbl_os_campo_extra
                                            (os, fabrica, campos_adicionais)
                                            VALUES
                                            ({$os_aberta}, {$login_fabrica}, '{$json_campo_extra}')
                                        ";
                                        $resOsExtra = pg_query($con,$insert);
                                    }

                                    if(strlen(pg_last_error($con))){
                                        $msg_erro = 'Erro ao gravar unidade de negócio';
                                    }
                                }

                                if (isset($novaTelaOs) AND !empty($os_aberta)) {
                                    $sqlOsProduto = "
                                        INSERT INTO tbl_os_produto
                                        (os, produto, serie)
                                        VALUES
                                        ({$os_aberta}, {$s_produto}, '{$s_serie}')
                                        ";
                                    $resOsProduto = pg_query($con, $sqlOsProduto);
                                }

                                if (in_array($login_fabrica, array(52,74,161))) {
                                    if(!empty($os_aberta)){
                                        if (in_array($login_fabrica,[52,161])) {
                                            $campos_adicionais2["pais"] = (strlen($_POST["consumidor_pais"] > 0)) ? $_POST["consumidor_pais"] : "BR"; /*HD - 4304128*/
                                            $json = json_encode($campos_adicionais2);
                                            $json = str_replace("\\", "", $json);
                                        } else if ($login_fabrica == 74) {
                                            $json = json_encode(array(
                                                "data_nascimento" => $_POST["consumidor_nascimento"]
                                            ));
                                        }

                                        $sql_campo_extra = "SELECT * FROM tbl_os_campo_extra WHERE os = {$os_aberta} AND fabrica = $login_fabrica";
                                        $res_campo_extra = pg_query($con, $sql_campo_extra);

                                        if (pg_num_rows($res_campo_extra) > 0){
                                            $update = "
                                                UPDATE tbl_os_campo_extra
                                                SET campos_adicionais = '$json'
                                                WHERE os = {$os_aberta}
                                                AND fabrica = {$login_fabrica}
                                            ";
                                        }else{
                                            $sql = "INSERT INTO tbl_os_campo_extra (os, fabrica, campos_adicionais) VALUES ($os_aberta, $login_fabrica, '$json')";
                                            $res = pg_query($con, $sql);
                                        }
                                    }
                                }

                                if (in_array($login_fabrica, array(30,50)) AND !empty($os_aberta)) {
                                    $sqlInt = "
                                        INSERT INTO tbl_os_interacao (
                                                programa,
                                                os,
                                                data,
                                                comentario,
                                                interno,
                                                fabrica,
                                                admin
                                                ) VALUES (
                                                    '$programa_insert',
                                                    $os_aberta,
                                                    CURRENT_TIMESTAMP,
                                                    'Os cadastrada através do atendimento $hd_chamado',
                                                    TRUE,
                                                    $login_fabrica,
                                                    $login_admin
                                                    )
                                                ";
                                    //                 echo nl2br($sqlInt);
                                    $resInt = pg_query($con,$sqlInt);
                                }

                              
                            }

                            // echo "OS's QUE FORAM AABERTAS:<br>";
                            // foreach (pg_fetch_all($res) as $key => $value) {
                            //  foreach ($value as $val) {
                            //      echo "<br>".$val;
                            //      # code...
                            //  }
                            // }
                            // echo "<br>----------------------------------------------------<br>HD CHAMADO ITEM - GRAVADOS<br><br>";
                            // $ressss = pg_query($con,"SELECT os,produto,serie,hd_chamado from tbl_hd_chamado_item where hd_chamado = $hd_chamado");
                            // var_dump(pg_fetch_all($ressss));

                            if (strlen($msg_erro) == 0 && !$os_ja_aberta) {

                                if ($login_fabrica <> 52){

                                    if(!empty($os_aberta)) {
                                        if(!isset($novaTelaOs)) {
                                            $sql = "SELECT fn_valida_os($os_aberta, $login_fabrica)";
                                            $res = @pg_query($con, $sql);
                                            $erro_valida = pg_errormessage($con);
                                        }else{

                                            $sql = "INSERT INTO tbl_os_extra(os) SELECT os FROM tbl_os LEFT JOIN tbl_os_extra USING(os) WHERE tbl_os.os =$os_aberta and tbl_os_extra.os isnull  ; UPDATE tbl_os SET sua_os = os WHERE OS = $os_aberta and sua_os isnull;";
                                            $res = @pg_query($con, $sql);
                                            $erro_valida = pg_errormessage($con);
                                        }
                                        if (strlen($erro_valida) == 0) {

                                            $sql = "SELECT sua_os FROM tbl_os WHERE os=$os_aberta";
                                            $res = @pg_query($con, $sql);

                                            $msg_erro .= pg_errormessage($con);
                                            $sua_os_aberta = pg_result($res, 0, sua_os);

                                            $sql = "UPDATE tbl_hd_chamado_extra SET os=$os_aberta WHERE hd_chamado=$hd_chamado";
                                            $res = @pg_query($con, $sql);
                                            $msg_erro .= pg_errormessage($con);

                                            if(strlen($cliente_admin) > 0){

                                                if($login_fabrica == 30 and !empty($data_limite)){

                                                    list($td,$tm,$ty) = explode("/", $data_limite);
                                                    $termino_atendimento = "'$ty-$tm-$td'";
                                                }else{
                                                    $termino_atendimento = "tbl_hd_chamado.data_providencia";
                                                }
                                                $sqlUpOs = "
                                                    UPDATE  tbl_os_extra
                                                    SET     termino_atendimento = $termino_atendimento
                                                    FROM    tbl_hd_chamado
                                                    JOIN    tbl_hd_chamado_extra USING (hd_chamado)
                                                    WHERE   tbl_hd_chamado_extra.os     = tbl_os_extra.os
                                                    AND     tbl_hd_chamado.hd_chamado   = $hd_chamado
                                                    AND     tbl_os_extra.os             = $os_aberta
                                                    ";
                                                $resUpOs = pg_query($con,$sqlUpOs);
                                                $msg_erro .= pg_errormessage($con);
                                            }
                                        } else {

                                            $erro_valida = explode("CONTEXT", $erro_valida);
                                            $erro_valida = explode("ERROR:", $erro_valida[0]);
                                            $erro_valida = trim($erro_valida[1]);
                                            $msg_erro .= $erro_valida . "<br>";

                                        }
                                    }
                                }else{

                                    /*HD - 4304128*/
                                    $sql = "SELECT  tbl_os.os,
                                        tbl_os.sua_os,
                                        tbl_produto.referencia,
                                        tbl_produto.descricao,
                                        tbl_os.serie,
                                        tbl_hd_chamado_item.hd_chamado_item
                                            FROM tbl_os
                                            JOIN tbl_hd_chamado_item ON(tbl_os.produto = tbl_hd_chamado_item.produto and tbl_os.serie = UPPER(tbl_hd_chamado_item.serie))
                                            LEFT JOIN tbl_produto on tbl_os.produto = tbl_produto.produto
                                            WHERE tbl_hd_chamado_item.hd_chamado = $hd_chamado
                                            AND tbl_os.hd_chamado = $hd_chamado
                                            AND tbl_hd_chamado_item.produto is not null
                                            AND tbl_hd_chamado_item.os is null
                                            AND tbl_os.fabrica=$login_fabrica ";
                                    $resX = pg_query($con,$sql);
                                    // echo "<br>----------------------------------------------------<br>RESULTADO resX<br><br>";
                                    // echo nl2br($sql);
                                    // var_dump(pg_fetch_all($resX));

                                    if (pg_num_rows($resX)>0){

                                        $abriuOsNova = 't';
                                        $osNova = array();

                                        for ($s=0; $s < pg_num_rows($resX); $s++) {

                                            $os_abertaX           = pg_fetch_result($resX, $s,0);
                                            $sua_os_aberta       = pg_fetch_result($resX, $s,1);
                                            $prod_ref_os_aberta  = pg_fetch_result($resX, $s,2);
                                            $prod_desc_os_aberta = pg_fetch_result($resX, $s,3);
                                            $hd_chamado_item_os_new = pg_fetch_result($resX, $s,5);

                                            $osNova[]      = $os_abertaX;
                                            $osNovaDados[] = $os_abertaX.";".$prod_ref_os_aberta.";".$prod_desc_os_aberta;

                                            $sql = "SELECT fn_valida_os($os_abertaX, $login_fabrica)";
                                            $res = pg_query($con, $sql);
                                            $erro_valida = pg_errormessage($con);
                                            if(!empty($os_abertaX)) {
                                                $aux_sql = "SELECT campos_adicionais FROM tbl_os_campo_extra WHERE os = $os_abertaX";
                                                $aux_res = pg_query($con, $aux_sql);
                                                $aux_arr = json_decode(pg_fetch_result($aux_res, 0, 'campos_adicionais'), true);

                                                if (empty($aux_arr)) {
                                                    $aux_arr["pais"] = $_POST["consumidor_pais"];
                                                    $json_arr        = json_encode($aux_arr);

                                                    $aux_sql = "INSERT INTO tbl_os_campo_extra(os, fabrica, campos_adicionais)
                                                                VALUES($os_abertaX, $login_fabrica, '$json_arr')";
                                                    $aux_res = pg_query($con, $aux_sql);
                                                } else {
                                                    $aux_arr["pais"] = $_POST["consumidor_pais"];
                                                    $json_arr        = json_encode($aux_arr);

                                                    $aux_sql = "UPDATE tbl_os_campo_extra SET campos_adicionais = '{$json_arr}' WHERE os = $os_abertaX";
                                                    $aux_res = pg_query($con, $aux_sql);
                                                }
                                            }

                                            if (strlen($erro_valida) == 0) {

                                                $sql = "UPDATE tbl_hd_chamado_item
                                                    set os = $os_abertaX
                                                    WHERE hd_chamado_item = $hd_chamado_item_os_new";
                                                $res = pg_query($con, $sql);
                                                $msg_erro .= pg_errormessage($con);

                                                $sql = "UPDATE tbl_os_extra
                                                    set obs = tbl_hd_chamado_extra.posto_nome
                                                    from tbl_hd_chamado_extra
                                                    where tbl_os_extra.i_fabrica = $login_fabrica
                                                    AND tbl_os_extra.os = $os_abertaX
                                                    and tbl_hd_chamado_extra.hd_chamado=$hd_chamado";
                                                $res = pg_query($con, $sql);
                                                $msg_erro .= pg_errormessage($con);

                                            } else {

                                                $erro_valida = explode("CONTEXT", $erro_valida);
                                                $erro_valida = explode("ERROR:", $erro_valida[0]);
                                                $erro_valida = trim($erro_valida[1]);
                                                $msg_erro .= $erro_valida . "<br>";

                                            }

                                        }

                                    }else{

                                        $abriuOsNova = 'f';

                                    }


                                }

                            }

                            if (count($_POST['os_visita']) > 0 || count($_POST['data_agendamento']) && in_array($login_fabrica, array(30))) {
                                $visitas = $_POST['os_visita'];
                                $data_agendamento = $_POST['data_agendamento'];
                                $datas = $_POST['data_agendamento'];
                                $datas = array_filter($datas);

                                if(count($_POST['os_visita']) == 0 AND count($datas) > 0){

                                    list($d,$m,$y) = explode("/", $datas[0]);

                                    if(!checkdate($m,$d,$y)){
                                        $data_agendamento = "";
                                    }else{
                                        $xdata_agendamento = "$y-$m-$d";

                                        $sql = "INSERT INTO tbl_os_visita(os,data) VALUES($os_aberta,'$xdata_agendamento')";
                                        //                      echo $sql;exit;
                                        $res = pg_query($con, $sql);
                                    }

                                }else{

                                    for($i = 0; $i < count($visitas); $i++){

                                        list($d,$m,$y) = explode("/", $datas[$i]);
                                        $datas[$i] = "$y-$m-$d";
                                        $sql = "UPDATE tbl_os_visita SET data = '{$datas[$i]}' WHERE os_visita = {$visitas[$i]}";

                                        $resO = pg_query($con,$sql);

                                    }
                                }

                            }

                            //Envia e-mail para o posto informando OS cadastrada

                            if (strlen($msg_erro) == 0) {

                                // Atualiza status_checkpoint da OS para a Colormaq para Aberta Call-center
                                // HD 2838143
                                if (in_array($login_fabrica, array(50))) {
                                    $upStatusCheckpoint = "UPDATE tbl_os SET status_checkpoint = 0 WHERE os = {$os_aberta} AND fabrica = {$login_fabrica};";
                                    $resStatusCheckpoint = pg_query($con, $upStatusCheckpoint);
                                }

                                $sql = "SELECT email FROM tbl_admin WHERE admin = $login_admin AND fabrica = $login_fabrica";
                                $res = pg_query($con,$sql);
                                $msg_erro .= pg_errormessage($con);

                                switch($login_fabrica) {
                                    case 2:
                                        $sac_email = "sac@dynacom.com.br";
                                        break;

                                    case 96:
                                        //$sac_email = "brayan@telecontrol.com.br; ronald@telecontrol.com.br";
                                        break;
                                }


                                if (pg_num_rows($res) > 0) {
                                    $admin_email = pg_fetch_result($res, 0, 'email');
                                } else {
                                    $admin_email = $sac_email;
                                }

                                $sql = "SELECT contato_email FROM tbl_posto_fabrica WHERE posto = $xcodigo_posto AND fabrica=$login_fabrica";
                                $res = pg_query($con,$sql);

                                if (pg_num_rows($res) > 0) {
                                    $email_posto = pg_fetch_result($res, 0, 'contato_email');
                                } else {
                                    $sql = "SELECT email from tbl_posto where posto = $xcodigo_posto";
                                    $res = pg_query($con, $sql);
                                    $email_posto = pg_fetch_result($res, 0, email);
                                }

                                if ($login_fabrica == 52){

                                    if (count($osNova)>0){

                                        $sua_os_aberta = implode(', ', $osNova);

                                        $subject  = "Nova ORDEM DE SERVIÇO nº $sua_os_aberta :: $login_fabrica_nome";

                                    }

                                }else if($login_fabrica == 30){
                                    $subject = "Uma nova OS $sua_os_aberta foi aberta para atendimento";
                                    if($cliente_admin != ""){
                                        $subject .= " com prazo limite de $data_limite";
                                    }
                                }else{
                                    $subject  = "Nova ORDEM DE SERVIÇO nº $sua_os_aberta :: $login_fabrica_nome
                                        ";
                                }

                                // echo $subject;exit;
                                //Mensagem de abertura de ORDEM DE SERVICO
                                $sql = "SELECT
                                    tbl_posto_fabrica.codigo_posto AS codigo_posto,
                                    tbl_posto.nome AS posto_nome,
                                    tbl_fabrica.nome AS fabrica_nome,
                                    TO_CHAR(tbl_hd_chamado.data, 'DD/MM/YY HH24:MI') AS data_atendimento,
                                    tbl_hd_chamado_extra.nome,
                                    tbl_hd_chamado_extra.endereco,
                                    tbl_hd_chamado_extra.numero,
                                    tbl_hd_chamado_extra.complemento,
                                    tbl_hd_chamado_extra.bairro,
                                    tbl_cidade.nome AS cidade_nome,
                                    tbl_cidade.estado,
                                    tbl_hd_chamado_extra.revenda_nome,
                                    tbl_revenda.cnpj AS revenda_cnpj,
                                    tbl_admin.nome_completo AS admin_nome
                                        FROM tbl_hd_chamado
                                        JOIN tbl_hd_chamado_extra ON tbl_hd_chamado.hd_chamado=tbl_hd_chamado_extra.hd_chamado
                                        JOIN tbl_posto ON tbl_hd_chamado_extra.posto=tbl_posto.posto
                                        JOIN tbl_posto_fabrica ON tbl_posto.posto=tbl_posto_fabrica.posto
                                        JOIN tbl_fabrica ON tbl_posto_fabrica.fabrica=tbl_fabrica.fabrica
                                        LEFT JOIN tbl_cidade ON tbl_hd_chamado_extra.cidade=tbl_cidade.cidade
                                        LEFT JOIN tbl_revenda ON tbl_hd_chamado_extra.revenda=tbl_revenda.revenda
                                        JOIN tbl_admin ON tbl_hd_chamado.admin=tbl_admin.admin

                                        WHERE tbl_hd_chamado.hd_chamado=$hd_chamado
                                        AND tbl_hd_chamado.fabrica=$login_fabrica
                                        AND tbl_posto_fabrica.fabrica=$login_fabrica ";
                                $res = pg_query($con, $sql);

                                if (pg_num_rows($res)) {

                                    $email_os_codigo_posto     = pg_fetch_result($res, 0, 'codigo_posto');
                                    $email_os_posto_nome       = pg_fetch_result($res, 0, 'posto_nome');
                                    $email_os_fabrica_nome     = pg_fetch_result($res, 0, 'fabrica_nome');
                                    $email_os_data_atendimento = pg_fetch_result($res, 0, 'data_atendimento');
                                    $email_os_nome             = pg_fetch_result($res, 0, 'nome');
                                    $email_os_endereco         = pg_fetch_result($res, 0, 'endereco');
                                    $email_os_numero           = pg_fetch_result($res, 0, 'numero');
                                    $email_os_complemento      = pg_fetch_result($res, 0, 'complemento');
                                    $email_os_bairro           = pg_fetch_result($res, 0, 'bairro');
                                    $email_os_cidade_nome      = addslashes(pg_fetch_result($res, 0, 'cidade_nome'));
                                    $email_os_estado           = pg_fetch_result($res, 0, 'estado');
                                    $email_os_revenda_nome     = pg_fetch_result($res, 0, 'revenda_nome');
                                    $email_os_revenda_cnpj     = pg_fetch_result($res, 0, 'revenda_cnpj');
                                    $email_os_admin_nome       = pg_fetch_result($res, 0, 'admin_nome');

                                    if ($login_fabrica <> 52) {

                                        $sql = " SELECT tbl_produto.referencia,
                                            tbl_produto.descricao
                                                FROM tbl_hd_chamado_extra
                                                JOIN tbl_produto ON tbl_hd_chamado_extra.produto=tbl_produto.produto
                                                WHERE tbl_hd_chamado_extra.hd_chamado=$hd_chamado ";
                                        $res = pg_query($con, $sql);
                                        $produtos = "[" . pg_fetch_result($res, 0, referencia) . "] " . pg_fetch_result($res, 0, descricao);
                                    }

                                    $email_endereco = "";

                                    if ($email_os_endereco)     $email_endereco .= $email_os_endereco;
                                    if ($email_os_numero)       $email_endereco .= ", " . $email_os_numero;
                                    if ($email_os_complemento)  $email_endereco .= " " . $email_os_complemento;
                                    if ($email_os_bairro)       $email_endereco .= " - " . $email_os_bairro;
                                    if ($email_os_cidade_nome)  $email_endereco .= " - " . $email_os_cidade_nome;
                                    if ($email_os_estado)       $email_endereco .= " - " . $email_os_estado;
                                    if ($email_os_revenda_cnpj) $email_os_revenda_cnpj = " - " . $email_os_revenda_cnpj;

                                    $message = "<p> Autorizada $email_os_codigo_posto - $email_os_posto_nome </p>
                                        <p >O Callcenter da Fábrica $email_os_fabrica_nome, abriu um atendimento que se tornou uma ORDEM DE SERVIÇO para ser atendido pelo seu posto autorizado.</p>
                                        <p >Segue as informações da ORDEM DE SERVIÇO nº $sua_os_aberta:</p>
                                        <p >    Atendimento do Call-Center nº $hd_chamado - Aberto por $email_os_admin_nome em $email_os_data_atendimento </p>
                                        ";

                                    if ($login_fabrica == 52) {
                                        if (count($osNovaDados)> 0) {

                                            $message .= "<fieldset style=\"width:450px\">   <legend>OS e Produtos</legend>";
                                            for ($o=0; $o < count($osNovaDados); $o++) {
                                                $dadosOs = $osNovaDados[$o];
                                                $dadosOs = explode(';', $dadosOs);
                                                $message .= "<p>Os: ".$dadosOs[0]."</p>";
                                                $message .= "<ul >  <li>".$dadosOs[1]." - ".$dadosOs[2]."</li>   </ul>
                                                    ";

                                                unset($dadosOs);
                                            }

                                            $message .= "</fieldset>";

                                        }
                                    } else {
                                        $message .= "<p > Produto: $produtos</p>";
                                    }

                                    $message .= "<p >Consumidor: $email_os_nome ($email_endereco) </p>
                                        <p >Revenda: $email_os_revenda_cnpj $email_os_revenda_nome </p>
                                        <p >Favor completar este atendimento o mais rápido possível, e qualquer dúvida, entrar em contato.</p>
                                        <p >$email_os_admin_nome</p>
                                        <p>Callcenter $login_fabrica_nome</p>";

                                    if ( (in_array($login_fabrica, array(169,170))) || ($login_fabrica == 171 && $_POST['tipo_atendimento_grohe'] == 297) ) {
                                        if ($_POST['periodo'] == 'manha'){
                                            $texto_periodo = "Manhã";
                                        }else{
                                            $texto_periodo = "Tarde";
                                        }

                                        $message .= "
                                            <p><strong>A data de agendamento da OS é: {$_POST['data_agendamento_ordem']}</strong></p>
                                            <p><strong>O período do agendamento da OS é: {$texto_periodo}</strong></p>
                                        ";
                                    }

                                    $message = str_replace("\n", "<br>", $message);
                                    $headers = "From: Call-center <$admin_email>\n";

                                    $headers .= "MIME-Version: 1.0\n";
                                    $headers .= "Content-type: text/html; charset=iso-8859-1\n";

                                    if(empty($msg_erro)){

                                    if (!empty($sua_os_aberta)){

                                        $mailTc = new TcComm($externalId);//classe

                                        //$mailer->IsSMTP();
                                        //$mailer->IsHTML(true);
                                        $mailTc->setEmailSubject($subject);
                                        $mailTc->addToEmailBody($message);
                                        $mailTc->setEmailFrom($externalEmail);

                                        //$mailer->Subject = $subject;
                                        //$mailer->Body = $message;
                                    }

                                    if ($login_fabrica == 52 and $abriuOsNova == 't') {
                                        if ($admin_email) {
                                            //$mailer->ClearAddresses();
                                            //$admin_email
                                            $mailTc->addEmailDest($admin_email);
                                            //$mailer->Send();
                                        }
                                        if ($email_posto) {
                                            //$mailer->ClearAddresses();
                                            $mailTc->addEmailDest($email_posto);
                                            //$mailer->Send();
                                        }

                                        $resultado = $mailTc->sendMail();

                                    } else if ($login_fabrica <> 52) {

                                        if ($admin_email) {
                                            //$mailer->ClearAddresses();
                                            $mailTc->addEmailDest($admin_email);
                                            //$mailer->Send();
                                        }
                                        if ($email_posto && in_array($login_fabrica, array(50,30,158,169,170,176))) {
                                            //$mailer->ClearAddresses();
                                            $mailTc->addEmailDest($email_posto);
                                            //$mailer->Send();

                                            $resultado = $mailTc->sendMail();
                                        }
                                    }
                                    }
                                }

                                $insereComunicado = 't';
                                if ($login_fabrica == 52 and $abriuOsNova != 't') {
                                    $insereComunicado = 'f';
                                }

                                if ($login_fabrica == 162 && filter_input(INPUT_POST,'interno')) {
                                    $postoInterno = filter_input(INPUT_POST,'interno');

                                    $sqlMaster = "
                                        SELECT  tbl_login_unico.tecnico
                                        FROM    tbl_login_unico
                                        WHERE   tbl_login_unico.posto = $postoInterno
                                        AND     tbl_login_unico.master IS TRUE
                                    ";
                                    $resMaster = pg_query($con,$sqlMaster);

                                    $tecMaster = pg_fetch_result($resMaster,0,tecnico);

                                    $campoMaster = " , destinatario";
                                    $valorMaster = " , ".$tecMaster;
                                }

                                if ($login_fabrica == 96) $admin_email = "null";
                                $peca                       = "null";
                                $produto                    = "null";
                                $aux_familia                = "null";
                                $aux_linha                  = "null";
                                $aux_extensao               = "null";
                                $aux_descricao              = substr($subject, 0, 79);
                                $aux_mensagem               = $message;
                                $aux_tipo                   = "Comunicado";
                                $posto                      = $xcodigo_posto;
                                $aux_obrigatorio_os_produto = "'f'";
                                $aux_obrigatorio_site       = "'t'";
                                $aux_tipo_posto             = "null";
                                $aux_ativo                  = "'t'";
                                $aux_estado                 = "null";
                                $aux_pais                   = "'BR'";
                                $remetente_email            = "$admin_email";
                                $pedido_faturado            = "'f'";
                                $pedido_em_garantia         = "'f'";
                                $digita_os                  = "'f'";
                                $reembolso_peca_estoque     = "'f'";

                                if (empty($posto)) {
                                    $posto = 'null';
                                }

                                $aux_mensagem = pg_escape_string($con,$aux_mensagem);

                                if (empty($msg_erro) and $insereComunicado == 't') {

                                    $sql = "INSERT INTO tbl_comunicado (
                                                peca                   ,
                                                produto                ,
                                                familia                ,
                                                linha                  ,
                                                extensao               ,
                                                descricao              ,
                                                mensagem               ,
                                                tipo                   ,
                                                fabrica                ,
                                                obrigatorio_os_produto ,
                                                obrigatorio_site       ,
                                                posto                  ,
                                                tipo_posto             ,
                                                ativo                  ,
                                                estado                 ,
                                                pais                   ,
                                                remetente_email        ,
                                                pedido_faturado        ,
                                                pedido_em_garantia     ,
                                                digita_os              ,
                                                reembolso_peca_estoque
                                                $campoMaster
                                            ) VALUES (
                                                $peca                       ,
                                                $produto                    ,
                                                $aux_familia                ,
                                                $aux_linha                  ,
                                                $aux_extensao               ,
                                                '$aux_descricao'            ,
                                                '$aux_mensagem'             ,
                                                '$aux_tipo'                 ,
                                                $login_fabrica              ,
                                                $aux_obrigatorio_os_produto ,
                                                $aux_obrigatorio_site       ,
                                                $posto                      ,
                                                $aux_tipo_posto             ,
                                                $aux_ativo                  ,
                                                $aux_estado                 ,
                                                $aux_pais                   ,
                                                '$remetente_email'          ,
                                                $pedido_faturado            ,
                                                $pedido_em_garantia         ,
                                                $digita_os                  ,
                                                $reembolso_peca_estoque
                                                $valorMaster
                                            );";

                                    $res = @pg_query ($con,$sql);
                                    $msg_erro .= pg_errormessage($con);
                                    //echo nl2br($sql);exit;
                                    // echo pg_errormessage($con);exit;
                                }
                                // exit;
                            }//IF QUE VERIFICA SE TEM ERROS - INSERÃÃO DA OS

                        }//IF QUE VERIFICA SE TEM ERROS - VALIDAÃÃO

                        if($login_fabrica == 30 and $dadosDiferenteEsmaltec == true ){
                            $anexoEsmaltec = $_POST['anexoEsmaltec'];

                            $anexoEsmaltec_arr = explode("|", $anexoEsmaltec);

                            foreach($anexoEsmaltec_arr as $value_anexo){

                                $sqlTdocs = "SELECT * FROM tbl_tdocs where tdocs_id = '$value_anexo'  and fabrica = $login_fabrica ";
                                $resTdocs = pg_query($con, $sqlTdocs);
                                if(pg_num_rows($resTdocs)>0){
                                    $tdocs = pg_fetch_result($resTdocs, 0, 'tdocs');
                                    $tdocs_id = pg_fetch_result($resTdocs, 0, 'tdocs_id');
                                    $fabrica = pg_fetch_result($resTdocs, 0, 'fabrica');
                                    $contexto = pg_fetch_result($resTdocs, 0, 'contexto');
                                    $situacao = pg_fetch_result($resTdocs, 0, 'situacao');
                                    $obs = pg_fetch_result($resTdocs, 0, 'obs');
                                    $referencia = pg_fetch_result($resTdocs, 0, 'referencia');
                                    $referencia_id = pg_fetch_result($resTdocs, 0, 'referencia_id');
                                    $hash_temp = pg_fetch_result($resTdocs, 0, 'hash_temp');
                                }

                                if(!empty($hd_chamado)){
                                    $sqlupdTdocs = "UPDATE tbl_tdocs SET referencia_id = '$hd_chamado' WHERE tdocs_id = '$value_anexo' ";
                                    $resupdTdocs = pg_query($con, $sqlupdTdocs);
                                    if(strlen(pg_last_error($con))>0){
                                        $msg_erro .= "Falha ao atualizar tdocs.";
                                    }
                                }

                                if(!empty($os_aberta)){
                                    $sqlInsTdocs = "INSERT INTO tbl_tdocs ( tdocs_id, fabrica, contexto, situacao, obs, referencia, referencia_id, hash_temp ) select tdocs_id, fabrica, 'os', situacao, obs, 'os', '$os_aberta', hash_temp from tbl_tdocs where  tdocs_id = '$value_anexo' ";
                                    $resInsTdocs = pg_query($con, $sqlInsTdocs);
                                    if(strlen(pg_last_error($con))>0){
                                        $msg_erro .= "Falha ao relacionar anexo com O.S.";
                                    }
                                }
                            }
                        }
                    }//fecha else 190
                }

                if ($login_fabrica == 183){
                    if (empty($os) AND !empty($os_aberta)){
                        $id_os = $os_aberta; 
                    }else if (empty($os_aberta) AND !empty($os)){
                        $id_os = $os;
                    }

                    if (strlen($id_os) > 0){
                        $sql = "UPDATE tbl_os_extra
                            set obs = tbl_hd_chamado_extra.posto_nome
                            from tbl_hd_chamado_extra
                            where tbl_os_extra.i_fabrica = $login_fabrica
                            AND tbl_os_extra.os = $id_os
                            and tbl_hd_chamado_extra.hd_chamado=$hd_chamado";
                        $res = pg_query($con, $sql);
                        $msg_erro .= pg_errormessage($con);
                    }
                    
                    if (strtolower($status_interacao) == "resolvido" AND !empty($hd_chamado) AND !empty($id_os)){
                        $sql_status = "SELECT os FROM tbl_os WHERE fabrica = {$login_fabrica} AND os = {$id_os} AND ((finalizada IS NOT NULL AND data_fechamento IS NOT NULL) OR excluida IS TRUE)";
                        $res_status = pg_query($con, $sql_status);
                        
    		            if (pg_num_rows($res_status) == 0){
                            $msg_erro .= "Não é possÃ­vel Resolver o atendimento, Ordem de Serviço está aberta no sistema <br/>";
                        }
                    }
                }

                if ($login_fabrica == 151 && $abre_os_mondial == 't' && empty($msg_erro)) {

                    $codigo_posto_tab = $_POST["codigo_posto_tab"];
                    $sqlPostoTab    = "SELECT posto FROM tbl_posto_fabrica WHERE codigo_posto = '{$codigo_posto_tab}' AND fabrica = $login_fabrica";
                    $resPostoTab    = pg_query($con, $sqlPostoTab);

                    if (pg_num_rows($resPostoTab)) {
                        $posto_tab        = pg_fetch_result($resPostoTab, 0, 'posto');
                    } else {
                        $msg_erro .= "Posto não encontrado";
                    }

                    if (strlen($msg_erro) == 0) {
                        $sqlHDItem = "SELECT * FROM tbl_hd_chamado_item WHERE produto is not null and  hd_chamado = {$hd_chamado}";
                        $resHDItem = pg_query($con, $sqlHDItem);
                        if (pg_num_rows($resHDItem) > 0) {
                            foreach (pg_fetch_all($resHDItem) as $key => $rows) {
                                $msg_erro .= abreOSPostoInterno($hd_chamado, $rows["hd_chamado_item"], true);
                            }
                        }
                    }
                }

                if ($moduloOSMultipla == "t" AND $abre_ordem_servico == 't' AND strlen($msg_erro) == 0){

                    try {
                        include "insert_callcenter_os_revenda.php";
                        if (!empty($cnpj_revenda)){
                            $sql = " SELECT revenda FROM tbl_revenda WHERE cnpj = '$cnpj_revenda' ";
                            $res = pg_query($con, $sql);
                            if (pg_num_rows($res) > 0){
                                $revenda = pg_fetch_result($res, 0, 'revenda');
                            }else{
                                $val_consumidor_rg = (in_array($login_fabrica, [178])) ? $consumidor_rg : null;
                                $sql = " INSERT INTO tbl_revenda (nome, cnpj, ie) VALUES ('$revenda_nome', '$cnpj_revenda', '$val_consumidor_rg') RETURNING revenda";
                                $res = pg_query($con, $sql);
                                $revenda = pg_fetch_result($res, 0, 'revenda');
                            }

                            if (strlen(pg_last_error()) > 0){
                                throw new Exception("Erro ao gravar Ordem de Serviço #R1");
                            }
                        }

                        if (!empty($hd_chamado)){
                            $sqlOsRevenda = "SELECT os_revenda FROM tbl_os_revenda WHERE fabrica = $login_fabrica AND hd_chamado = $hd_chamado";
                            $resOsRevenda = pg_query($con, $sqlOsRevenda);

                            if (pg_num_rows($resOsRevenda) > 0){
                                $os_revenda = pg_fetch_result($resOsRevenda, 0, "os_revenda");
                            }
                        }

                        $obs_sac_adicionais = filter_input(INPUT_POST,"obs_sac_adicionais");
                        $obs_sac_adicionais = str_replace("\r\n", "<br>", $obs_sac_adicionais);

                        $os_revenda = insereOsRevendaCallcenter($os_revenda, $hd_chamado, $consumidor_revenda, $obs_sac_adicionais);

                        if (!empty($os_revenda)){
                            
                            $os_revenda_item = insereOsRevendaItemCallcenter($os_revenda, $hd_chamado, $cont_os, $revenda, $consumidor_revenda);

                            $sqlRevenda = "UPDATE tbl_os_revenda SET explodida = now(), sua_os = '{$os_revenda}' WHERE os_revenda = {$os_revenda}";
                            $resRevenda = pg_query($con, $sqlRevenda);
                        }
                    }catch (Exception $e) {
                        $msg_erro .= $e->getMessage();
                    }

                    if ($login_fabrica == 178 AND !empty($obs_sac_adicionais)){
                        $sql_obs_sac = "SELECT hd_chamado FROM tbl_hd_chamado_item WHERE hd_chamado = $hd_chamado AND comentario ILIKE '%Observação SAC:%'";
                        $res_obs_sac = pg_query($con, $sql_obs_sac);

                        if (pg_num_rows($res_obs_sac) == 0){
                            $obs_sac_adicionais = "<b>Observação SAC: </b><br />$obs_sac_adicionais";
                            $insert_obs_sac = "INSERT INTO tbl_hd_chamado_item(
                                    hd_chamado   ,
                                    data         ,
                                    comentario   ,
                                    admin        ,
                                    interno      ,
                                    status_item
                                ) values (
                                    $hd_chamado ,
                                    current_timestamp ,
                                    E'$obs_sac_adicionais',
                                    $login_admin,
                                    'f',
                                    $xstatus_interacao
                                )";
                            $res_insert_obs_sac = pg_query($con,$insert_obs_sac);
                        }
                    }
                }
                // HD-3141903
                if($login_fabrica == 74 AND empty($msg_erro)){
                    if(strlen(trim($xtransferir)) > 0){
                        $atende = $_POST['atendente_transferencia'];

                        $sql = "SELECT login from tbl_admin where admin = $atende";
                        $res = pg_query($con, $sql);
                        $nome_ultimo_atendente = pg_fetch_result($res, 0, 'login');

                        $sql = "SELECT login from tbl_admin where admin = $xtransferir";
                        $res = pg_query($con, $sql);
                        $nome_atendente = pg_fetch_result($res,0,login);

                        $sql = "INSERT INTO tbl_hd_chamado_item(
                                                hd_chamado   ,
                                                data         ,
                                                comentario   ,
                                                admin        ,
                                                interno      ,
                                                status_item  ,
                                                admin_transferencia
                                            )values(
                                                $hd_chamado       ,
                                                current_timestamp ,
                                                E'Atendimento transferido por <b>$login_login</b> de <b>$nome_ultimo_atendente</b> para <b>$nome_atendente</b>',
                                                $login_admin      ,
                                                't'  ,
                                                $xstatus_interacao,
                                                $xtransferir
                                            )";
                        $res = pg_query($con,$sql);
                        $msg_erro .= pg_errormessage($con);
                    }
                }
                // FIM HD-3141903

                if ($classificacaoHD && empty($msg_erro) && strlen($_POST["hd_classificacao"]) > 0) {
                    $hd_classificacao = $_POST['hd_classificacao'];

                    if ($login_fabrica == 30 && !empty($callcenter)) {
                        $msg_classificacao = classificacao_anterior($hd_classificacao, $callcenter);
                    }

                    $sql = "UPDATE  tbl_hd_chamado
                                SET     hd_classificacao = {$hd_classificacao}
                                WHERE   hd_chamado = {$hd_chamado}
                        ";
                    $res = pg_query($con,$sql);
                    if (!pg_last_error() && $login_fabrica == 30 && !empty($msg_classificacao)) {
                        $sql_classificacao_interacao = "INSERT INTO tbl_hd_chamado_item(
                                                            hd_chamado   ,
                                                            data         ,
                                                            comentario   ,
                                                            admin        ,
                                                            interno
                                                        ) values (
                                                            $callcenter       ,
                                                            current_timestamp ,
                                                            E'$msg_classificacao'       ,
                                                            $login_admin      ,
                                                            't'
                                                        )";
                        $res_classificacao_interacao = pg_query($con,$sql_classificacao_interacao);
                    }
                }

                // Lin Disse p/ Substituir $classificacaoCallcenter Por $classificacaoHD
                if ($moduloProvidencia AND empty($msg_erro) && (strlen($_POST["hd_classificacao"]) > 0 || $login_fabrica == 35) OR ($classificacaoHD AND empty($msg_erro))) {

                    $callcenter = $hd_chamado;
                    //Relaciona os ao atendimento
                    $os_relacionadas = $_POST['os_relacionadas'];
                    if (!empty($os_relacionadas) AND in_array($login_fabrica,array(35,151,164,186))) {
                        if ($login_fabrica != 35) {

                            foreach ($os_relacionadas as $keyOsRelacionadas => $valueOsRelacionadas) {

                                $xos_relacionar = $valueOsRelacionadas;
                                $os_sodigito = preg_replace('/\D/','',$valueOsRelacionadas);
                                $sqlOS = "SELECT os,sua_os,nota_fiscal,data_nf,fabrica FROM tbl_os WHERE (os={$os_sodigito} OR (sua_os='{$xos_relacionar}')) and fabrica in ({$login_fabrica}, 0)";
                                $resOS = pg_query($con,$sqlOS);
                                if (pg_num_rows($resOS) == 0) {
                                    $msg_erro .= "OS {$xos_relacionar}, não foi encontrada.<br />";
                                } else {
                                    $xos_relacionar = pg_fetch_result($resOS, 0, 'os');
                                    $xsua_os_relacionar = pg_fetch_result($resOS, 0, 'sua_os');
                                    $xnota_fiscal = pg_fetch_result($resOS, 0, 'nota_fiscal');
                                    $data_nf = pg_fetch_result($resOS, 0, 'data_nf');
                                    $xdata_nf = (empty($data_nf)) ? "null": "'$data_nf'";
                                    $fabrica_os = pg_fetch_result($resOS, 0, 'fabrica');
                                    if($login_fabrica != $fabrica_os and  $fabrica_os != 0) {
                                        $msg_erro .= "OS {$xos_relacionar}, não foi encontrada.<br />";
                                    }
                                }

                                if (empty($msg_erro)) {

                                    $sqlOS2 = "SELECT
                                                tbl_hd_chamado_item.os,
                                                tbl_os.serie,
                                                tbl_os_produto.produto
                                            FROM tbl_hd_chamado_item
                                            JOIN tbl_hd_chamado ON tbl_hd_chamado_item.hd_chamado = tbl_hd_chamado.hd_chamado
                                            JOIN tbl_os ON tbl_hd_chamado_item.os = tbl_os.os
                                            LEFT JOIN tbl_os_produto ON tbl_os.os = tbl_os_produto.os
                                            WHERE tbl_hd_chamado_item.hd_chamado ={$callcenter}
                                            AND tbl_hd_chamado_item.os ={$xos_relacionar}";
                                    $resOS2 = pg_query($con,$sqlOS2);
                                    if (pg_num_rows($resOS2) == 0) {
                                        if (in_array($login_fabrica, array(151))) {
                                            $sql_serie_controle = "
                                                SELECT  tbl_os.os
                                                FROM    tbl_os
                                                JOIN    tbl_os_produto      ON  tbl_os_produto.os           = tbl_os.os
                                                JOIN    tbl_serie_controle  ON  tbl_serie_controle.produto  = tbl_os_produto.produto
                                                                            AND tbl_serie_controle.serie    = tbl_os.serie
                                                                            AND tbl_serie_controle.fabrica  = {$login_fabrica}
                                                WHERE   tbl_os.os       = {$xos_relacionar}
                                                AND     tbl_os.fabrica  = {$login_fabrica};
                                            ";
                                            $res_serie_controle = pg_query($con, $sql_serie_controle);
                                            if (pg_num_rows($res_serie_controle)) {
                                                $os_troca = $xos_relacionar;
                                            }
                                        }

                                        $sql = "
                                            INSERT INTO tbl_hd_chamado_item (
                                                hd_chamado,
                                                admin,
                                                os,
                                                nota_fiscal,
                                                data_nf,
                                                comentario
                                            ) VALUES (
                                                $hd_chamado,
                                                $login_admin,
                                                $xos_relacionar,
                                                '$xnota_fiscal',
                                                $xdata_nf,
                                                'A OS $xsua_os_relacionar foi relacionada ao atendimento'
                                            )";
                                        $res = pg_query($con,$sql);

                                        if (strlen(pg_last_error()) > 0) {
                                            $msg_erro .= "Erro ao relacionar a OS $xos_relacionar <br />";
                                        }
                                    }
                                }
                            }
                        } else {
                            $xos_relacionar = $os_relacionadas[0];

                            $sqlOs = "
                                SELECT  nota_fiscal,
                                        data_nf
                                FROM    tbl_os
                                WHERE   os=$xos_relacionar
                                AND     fabrica = {$login_fabrica}";
                            $resOs = pg_query($con,$sqlOs);

                            $xnota_fiscal = pg_fetch_result($resOs, 0, 'nota_fiscal');
                            $data_nf = pg_fetch_result($resOs, 0, 'data_nf');
                            $xdata_nf = (empty($data_nf)) ? "null": "'$data_nf'";

                            $sqlVer = "SELECT COUNT(1) AS tem_extra, os AS os_relacionada FROM tbl_hd_chamado_extra WHERE hd_chamado = $hd_chamado GROUP BY os_relacionada";

                            $resVer = pg_query($con,$sqlVer);
                            $tem_extra = pg_fetch_result($resVer,0,'tem_extra');
                            $os_relacionada_hd = pg_fetch_result($resVer, 0, 'os_relacionada');

                            if ($tem_extra > 0) {
                                if (trim($os_relacionada_hd) != trim($xos_relacionar)) {
                                    $sqlOsRelacionar = "
                                        UPDATE  tbl_hd_chamado_extra
                                        SET     os = $xos_relacionar,
                                                nota_fiscal = '$xnota_fiscal',
                                                data_nf = $xdata_nf,
                                                obs_callcenter = 'A OS $xos_relacionar foi relacionada ao atendimento'
                                        WHERE   hd_chamado = $hd_chamado
                                    ";
                                }
                            } else {
                                $sqlOsRelacionar = "
                                    INSERT INTO tbl_hd_chamado_extra (
                                        hd_chamado,
                                        os,
                                        nota_fiscal,
                                        data_nf,
                                        obs_callcenter
                                    ) VALUES (
                                        $hd_chamado,
                                        $xos_relacionar,
                                        '$xnota_fiscal',
                                        $xdata_nf,
                                        'A OS $xos_relacionar foi relacionada ao atendimento'
                                    )
                                ";
                            }
                            if (!empty($sqlOsRelacionar)) {
                                $resOsRelacionar = pg_query($con,$sqlOsRelacionar);
                            }

                            if (!pg_last_error($con)) {
                                if (!empty($sqlOsRelacionar)) {
                                    $sql = "
                                        INSERT INTO tbl_hd_chamado_item (
                                            hd_chamado,
                                            admin,
                                            status_item,
                                            comentario
                                        ) VALUES (
                                            $hd_chamado,
                                            $login_admin,
                                            $xstatus_interacao,
                                            'A OS $xos_relacionar foi relacionada ao atendimento'
                                        )
                                    ";
                                    $res = pg_query($con,$sql);
                                }
                            }
                        }
                    }

                    if ($_POST["trocar_produto"]) {

                        if (!empty($produto_referencia)) {
                            $sqlOS = "
                                SELECT  os,
                                        tbl_os.finalizada
                                FROM    tbl_os
                                JOIN    tbl_os_extra USING(os)
                                WHERE   tbl_os.hd_chamado   = $hd_chamado
                                AND     tbl_os.fabrica      = $login_fabrica";
                            $resOS = pg_query($con,$sqlOS);

                            if (!empty($hd_chamado) AND pg_num_rows($resOS) == 0) {
                                $abreTelaOs = true;
                                if (empty($msg_erro)) {
                                    if ($login_fabrica == 151) {
                                        $qtde_produto = $_POST['qtde_produto'];
                                        if ($qtde_produto > 0) {
                                            for ($w = 1; $w <= $qtde_produto; $w++) {
                                                $hd_chamado_item = $_POST['hd_chamado_item_'.$w];
                                                $nf_os = $_POST['data_nf_'.$w];
                                                if(strlen($nf_os) > 0 ) {
                                                    $sqld = "select '$nf_os'::date >current_date as data_valida; ";
                                                    $resd = pg_query($con, $sqld);
                                                    if(pg_fetch_result($resd, 0 , 'data_valida') == 't') {
                                                        $msg_erro = "Data de nota maior que a data atual";
                                                    }else{
                                                        $msg_erro .= abreOSPostoInterno($hd_chamado, $hd_chamado_item);//fputti
                                                    }
                                                }else{
                                                    $msg_erro .= abreOSPostoInterno($hd_chamado, $hd_chamado_item);//fputti
                                                }
                                            }
                                        }
                                    } else if (in_array($login_fabrica, array(169, 170))) {
                                        $os = $_POST["os"];
                                        pg_query("COMMIT");
                                        header ("Location: $PHP_SELF?callcenter=$hd_chamado&os_troca=$os&abreTelaOs=$abreTelaOs");                                                                     exit;

                                    } else {
                                        $msg_erro .= abreOSPostoInterno($hd_chamado);
                                    }

                                    if (strlen($msg_erro) == 0) {
                                        $sqlOS = "
                                            SELECT  os
                                            FROM    tbl_os
                                            JOIN    tbl_os_extra USING(os)
                                            WHERE   tbl_os.hd_chamado   = $hd_chamado
                                            AND     tbl_os.fabrica      = $login_fabrica";
                                        $resOS = pg_query($con,$sqlOS);
                                        $os_troca = pg_fetch_result($resOS, 0, 'os');
                                    }
                                }
                            } else if(!empty($hd_chamado) && pg_num_rows($resOS) > 0 && strtoupper($status_interacao) == "RESOLVIDO") {
                                $abreTelaOs = false;
                                $os = pg_fetch_result($resOS,0,'os');
                                $os_finalizada = pg_fetch_result($resOS,0,'finalizada');

                                if (in_array($login_fabrica, array(169,170))) {
                                    $abreTelaOs = true;
                                    pg_query("COMMIT");
                                    header ("Location: $PHP_SELF?callcenter=$hd_chamado&os_troca=$os&abreTelaOs=$abreTelaOs");
                                    exit;
                                }

                                try {
                                    if(strlen($os_finalizada) == 0){
                                        include "../classes/Posvenda/Os.php";
                                        $classOs = new \Posvenda\Os($login_fabrica, $os);
                                        //$classOs->calculaOs();
                                        $classOs->finaliza($con);
                                    }
                                } catch(Exception $e) {
                                    $msg_erro .= $e->getMessage();
                                }
                            } else {
                                if(in_array($login_fabrica, array(169,170))){
                                    $abreTelaOs = true;
                                    pg_query("COMMIT");
                                    header ("Location: $PHP_SELF?callcenter=$hd_chamado&os_troca=$os&abreTelaOs=$abreTelaOs");
                                    exit;
                                }
                                $abreTelaOs = false;
                            }
                        } else {
                            $msg_erro .= "Informe o produto para poder realizar a troca <br>";
                        }
                    }

                    if (strlen($xos) > 0 AND is_int($xos) AND in_array($login_fabrica,array(151))) {
                        $sql = "SELECT os FROM tbl_os WHERE fabrica = $login_fabrica AND os = $xos AND hd_chamado = $hd_chamado";
                        $resOS = pg_query($con,$sql);

                        if(pg_num_rows($resOS) == 0){

                            $sql = "
                                SELECT  tbl_posto.posto,
                                        tbl_posto.nome,
                                        tbl_posto_fabrica.codigo_posto,
                                        tbl_os.sua_os
                                FROM    tbl_os
                                JOIN    tbl_posto           ON  tbl_os.posto                = tbl_posto.posto
                                JOIN    tbl_posto_fabrica   ON  tbl_posto_fabrica.posto     = tbl_posto.posto
                                                            AND tbl_posto_fabrica.fabrica   = $login_fabrica
                                WHERE   os              = $xos
                                AND     tbl_os.fabrica  = $login_fabrica
                            ";
                            $resOS = pg_query($con,$sql);
                            $posto = pg_fetch_result($resOS, 0, 'posto');
                            $posto_nome = pg_fetch_result($resOS, 0, 'nome');
                            $codigo_posto = pg_fetch_result($resOS, 0, 'codigo_posto');
                            $sua_os = pg_fetch_result($resOS, 0, 'sua_os');

                            $sql = "
                                UPDATE  tbl_os
                                SET     hd_chamado = $hd_chamado
                                WHERE   os = $xos
                                AND     fabrica = $login_fabrica;

                                UPDATE  tbl_hd_chamado_extra
                                SET     os = $xos
                                WHERE   hd_chamado = $hd_chamado
                            ";
                            $resHD = pg_query($con,$sql);

                            $message = "<p> Autorizada $codigo_posto - $posto_nome </p>
                                <p >O Callcenter da Fábrica $login_fabrica_nome, abriu um atendimento para a ORDEM DE SERVIÇO nº $sua_os.</p>
                                <p >Segue as informações:</p>
                                <p >Atendimento do Call-Center nº $hd_chamado - Aberto em ".date('d/m/Y')." </p> ";

                            $sql = "INSERT INTO tbl_comunicado (
                                        mensagem               ,
                                        descricao              ,
                                        tipo                   ,
                                        fabrica                ,
                                        obrigatorio_site       ,
                                        posto                  ,
                                        ativo
                                    ) VALUES (
                                        '$message'             ,
                                        'Abertura do atendimento {$hd_chamado}',
                                        'Comunicado'           ,
                                        $login_fabrica         ,
                                        't'                    ,
                                        $posto                 ,
                                        't'
                                    );";

                            $res = pg_query ($con,$sql);

                        }

                    }

                    if(!empty($_POST['hd_classificacao'])){
                        $hd_classificacao = $_POST['hd_classificacao'];

                        if ($login_fabrica == 30 && !empty($callcenter)) {
                            $msg_classificacao = classificacao_anterior($hd_classificacao, $callcenter);
                        }

                        $sql = "UPDATE  tbl_hd_chamado
                                SET     hd_classificacao = {$hd_classificacao}
                                WHERE   hd_chamado = {$hd_chamado}
                        ";
                        $res = pg_query($con,$sql);
                        if (!pg_last_error() && $login_fabrica == 30 && !empty($msg_classificacao)) {
                            $sql_classificacao_interacao = "INSERT INTO tbl_hd_chamado_item(
                                                                hd_chamado   ,
                                                                data         ,
                                                                comentario   ,
                                                                admin        ,
                                                                interno
                                                            ) values (
                                                                $callcenter       ,
                                                                current_timestamp ,
                                                                E'$msg_classificacao'       ,
                                                                $login_admin      ,
                                                                't'
                                                            )";
                            $res_classificacao_interacao = pg_query($con,$sql_classificacao_interacao);
                        }
                    }else{
                        if($insert_hd_chamado == "sim" && !in_array($login_fabrica, array(164))){
                            if(in_array($login_fabrica, array(189))){
                                $msg_erro .= "Informe o Registro Ref. a do atendimento <br>";
                            } else {
                                $msg_erro .= "Informe a classificação do atendimento <br>";
                            }
                        }
                    }

                    if (!empty($hd_motivo_ligacao) and $transferir_atendimento == 'sim') {
                        if (in_array($login_fabrica, array(169,170))) {
                            if ((empty($xtransferir) || $xtransferir == $login_admin) && !empty($xproduto) && !empty($cidade) && (!empty($os_aberta) || !empty($os))) {
                                $whereJornada = array();


                                if (!empty($cidade) && !empty($xproduto)) {
                                    $whereJornada[0] = "(cidade = {$cidade} AND produto = {$xproduto})";
                                    $whereJornada[2] = "(produto = {$xproduto})";
                                    $whereJornada[3] = "(cidade = {$cidade})";
                                }

                                if (!empty($consumidor_estado) && !empty($xproduto)) {
                                    $whereJornada[1] = "(estado = '{$consumidor_estado}' AND produto = {$xproduto})";
                                    $whereJornada[4] = "(estado = '{$consumidor_estado}')";
                                }

                                $sqlJornada = "
                                    SELECT * FROM tbl_hd_jornada
                                    WHERE fabrica = {$login_fabrica}
                                    AND (".implode("OR ", $whereJornada).")
                                    LIMIT 1
                                ";
                                $resJornada = pg_query($con,$sqlJornada);

                                if (pg_num_rows($resJornada) > 0) {
                                    $transferir_atendimento = "não";
                                    $atendimento_jornada = true;
                                }
                            } else {
                                $atendimento_jornada = false;
                            }
                        }

                        if ($login_fabrica == 183){
                            $transferir_atendimento = "não";
                        }

                        if ($transferir_atendimento == "sim" and empty($msg_erro)) {
                                if (in_array($login_fabrica, array(169,170))) {
                                    $joinOrigem = "
                                        JOIN tbl_hd_origem_admin ON tbl_hd_origem_admin.admin = tbl_admin_atendente_estado.admin
                                    ";
                                    $condOrigem = "
                                        AND     (
                                                    tbl_admin_atendente_estado.hd_motivo_ligacao = $hd_motivo_ligacao
                                                OR  tbl_admin_atendente_estado.hd_classificacao = $hd_classificacao
                                                )
                                        AND     tbl_hd_origem_admin.hd_chamado_origem = $id_xorigem
                                    ";
                                } else {
                                    $condOrigem = "
                                        AND     tbl_admin_atendente_estado.hd_classificacao = {$hd_classificacao}
                                    ";
                                }

                            $sql = "
                                SELECT  COUNT(tbl_admin_atendente_estado.admin) AS total_admin
                                FROM    tbl_admin_atendente_estado
                                JOIN    tbl_admin USING(admin)
                                JOIN    tbl_cidade  ON  tbl_cidade.cod_ibge = tbl_admin_atendente_estado.cod_ibge
                                                    AND tbl_cidade.cidade   = {$cidade}
                                {$joinOrigem}
                                WHERE   tbl_admin_atendente_estado.fabrica          = {$login_fabrica}
                                AND     tbl_admin_atendente_estado.estado           = '$consumidor_estado'

                                {$condOrigem}
                                AND     tbl_admin.fabrica= {$login_fabrica}
                                AND     tbl_admin.nao_disponivel is NULL
                                AND     tbl_admin.ativo IS TRUE";
                            $resP = pg_query($con,$sql);

                            if (pg_fetch_result($resP, 0, 'total_admin') == 0) {
                                $sql = "
                                    SELECT  COUNT(tbl_admin_atendente_estado.admin) AS total_admin
                                    FROM    tbl_admin_atendente_estado
                                    JOIN    tbl_admin USING(admin)
                                    {$joinOrigem}
                                    WHERE   tbl_admin_atendente_estado.fabrica          = {$login_fabrica}
                                    AND     tbl_admin_atendente_estado.estado           = '$consumidor_estado'
                                    AND     tbl_admin_atendente_estado.cod_ibge         IS NULL

                                    {$condOrigem}
                                    AND     tbl_admin.fabrica                           = {$login_fabrica}
                                    AND     tbl_admin.nao_disponivel                    IS NULL
                                    AND     tbl_admin.ativo                             IS TRUE";
                                $resP = pg_query($con,$sql);

                                if (pg_fetch_result($resP, 0, 'total_admin') == 0) {
                                    $sql = "
                                        SELECT  COUNT(tbl_admin_atendente_estado.admin) AS total_admin
                                        FROM    tbl_admin_atendente_estado
                                        JOIN    tbl_admin USING(admin)
                                        {$joinOrigem}
                                        WHERE   tbl_admin_atendente_estado.fabrica          = {$login_fabrica}

                                        {$condOrigem}
                                        AND     tbl_admin_atendente_estado.estado           = ''
                                        AND     tbl_admin_atendente_estado.cod_ibge         IS NULL
                                        AND     tbl_admin.fabrica                           = {$login_fabrica}
                                        AND     tbl_admin.nao_disponivel                    IS NULL
                                        AND     tbl_admin.ativo                             IS TRUE
                                    ";
                                    $resP = pg_query($con,$sql);

                                    $cond_geral = "  AND tbl_admin_atendente_estado.estado = '' AND tbl_admin_atendente_estado.cod_ibge IS NULL ";
                                } else {
                                    $cond_estado = "AND tbl_admin_atendente_estado.estado = '$consumidor_estado' AND tbl_admin_atendente_estado.cod_ibge IS NULL ";
                                }
                            } else {
                                $join_cidade = " JOIN tbl_cidade ON tbl_cidade.cod_ibge = tbl_admin_atendente_estado.cod_ibge AND tbl_cidade.cidade = {$cidade} ";
                                $sqlIbge = "SELECT cod_ibge FROM tbl_cidade WHERE cidade = {$cidade}";
                                $resIbge = pg_query($con,$sqlIbge);
                                $cond_cidade = " AND tbl_admin_atendente_estado.cod_ibge = ". pg_fetch_result($resIbge,0,'cod_ibge')." ";
                            }

                            $total_admin = pg_fetch_result($resP, 0, 'total_admin') - 1;

                            $total_admin = ($total_admin < 1) ? 1 : $total_admin;

                            if ($login_fabrica != 30) {

                                $sql = "
                                    SELECT  tbl_admin_atendente_estado.admin    AS atendente,
                                            (
                                                SELECT  COUNT(1)
                                                FROM    tbl_hd_chamado
                                                WHERE   tbl_hd_chamado.data::DATE           = CURRENT_DATE
                                                AND     tbl_hd_chamado.status               NOT IN ('Resolvido','Cancelado','Finalizado')
                                                AND     tbl_hd_chamado.fabrica_responsavel  = $login_fabrica
                                                AND     hd_classificacao                    = $hd_classificacao
                                                AND     tbl_hd_chamado.atendente            = tbl_admin_atendente_estado.admin
                                            )                                   AS tot
                                    FROM    tbl_admin_atendente_estado
                                    {$joinOrigem}
                                    JOIN    tbl_admin ON tbl_admin.admin = tbl_admin_atendente_estado.admin
                                    {$join_cidade}
                                    WHERE   tbl_admin_atendente_estado.fabrica          = {$login_fabrica}
                                    AND     tbl_admin.fabrica                           = {$login_fabrica}

                                    $cond_estado
                                    {$condOrigem}
                                    $cond_geral
                                    AND     tbl_admin.ativo                             IS TRUE
                                    AND     tbl_admin.nao_disponivel                    IS NULL
                                    ORDER BY      tot
                                    LIMIT   1;";
                                //ORDER BY RANDOM() LIMIT {$total_admin}";
                                $resP = pg_query($con,$sql);
                                $callcenter_supervisor = pg_fetch_all($resP);

                                if (!$callcenter_supervisor) {
                                    $sql = "SELECT tbl_admin_atendente_estado.admin AS atendente
                                        FROM tbl_admin_atendente_estado
                                        JOIN tbl_admin ON tbl_admin.admin = tbl_admin_atendente_estado.admin AND tbl_admin.fabrica = {$login_fabrica}
                                        $join_cidade
                                        {$joinOrigem}
                                        WHERE tbl_admin_atendente_estado.hd_classificacao = {$hd_classificacao}
                                        AND tbl_admin_atendente_estado.fabrica = {$login_fabrica}
                                        {$condOrigem}
                                        $cond_estado
                                        $cond_geral
                                        AND tbl_admin.nao_disponivel is NULL
                                        AND tbl_admin.ativo IS TRUE
                                        LIMIT 1";
                                    $resP = pg_query($con,$sql);
                                    $callcenter_supervisor = pg_fetch_all($resP);
                                }
                            } else {
                                $sql = "SELECT  admin as atendente
                                        FROM tbl_admin_atendente_estado
                                        WHERE fabrica = {$login_fabrica}
                                        AND hd_classificacao = {$hd_classificacao}
                                        AND posto_filial = $xcodigo_posto";
                                $res = pg_query($con, $sql);
                                if (pg_num_rows($res) > 0) {
                                    $atDoDia = pg_fetch_all($res);
                                    $backoffice_centralizado = false;
                                } else {
                                    $sql = "SELECT tbl_posto_fabrica.admin_sap as atendente
                                                FROM tbl_posto_fabrica
                                                WHERE posto = $xcodigo_posto
                                                    AND fabrica = $login_fabrica
                                                    AND admin_sap IS NOT NULL;";
                                    $res = pg_query($con, $sql);
                                    if (pg_num_rows($res) > 0) {
                                        $atDoDia = pg_fetch_all($res);
                                        $backoffice_centralizado = true;
                                    }
                                }

                                if (empty($atDoDia)) {
                                    /*
                                     * - Verifica TODOS os atendentes
                                     * Responsáveis pela região E classificação
                                     * do chamado
                                     */
                                    $sql = "SELECT  DISTINCT
                                                tbl_admin.admin as atendente
                                        FROM    tbl_admin_atendente_estado
                                        JOIN    tbl_admin ON tbl_admin.admin = tbl_admin_atendente_estado.admin
                                        {$join_cidade}
                                        WHERE   tbl_admin_atendente_estado.fabrica          = {$login_fabrica}
                                        AND     tbl_admin.fabrica                           = {$login_fabrica}
                                        $cond_estado
                                        AND     tbl_admin_atendente_estado.hd_classificacao = {$hd_classificacao}
                                        $cond_geral
                                        AND     tbl_admin.ativo             IS TRUE
                                        AND     tbl_admin.nao_disponivel    IS NULL  ";
                                    $resP = pg_query($con,$sql);
                                    $atDoDia = pg_fetch_all($resP);
                                }

                                /*
                                 * - Faz a contagem diária de chamados
                                 * direcionados a este atendente
                                 */
                                foreach ($atDoDia as $key => $value) {

									if(!empty($hd_classificacao)) {
										$cond_classificacao  = " AND (tbl_hd_chamado.hd_classificacao = $hd_classificacao or tbl_hd_chamado.hd_classificacao isnull) ";
									}
                                    $sqlCont = "
                                        SELECT  COUNT(1) AS chamados_hoje
                                        FROM    tbl_hd_chamado
                                        WHERE   tbl_hd_chamado.atendente = ".$value['atendente']."
                                        AND     tbl_hd_chamado.posto isnull
										AND     tbl_hd_chamado.data::DATE = CURRENT_DATE
										$cond_classificacao
                                        ";
                                    $resCont = pg_query($con,$sqlCont);
                                    $contaChamados = pg_fetch_result($resCont,0,'chamados_hoje');
                                    $qtdeChamados[$value['atendente']] = $contaChamados;
                                }

                                /*
                                 * - Retira o atendente
                                 * com menor número de chamados
                                 * atendidos no dia para gravação do próximo
                                 * chamado
                                 */
                                asort($qtdeChamados);
                                $atendentesOrdenados = array_keys($qtdeChamados);
                                $primeiroAtendente = array_shift($atendentesOrdenados);
                                $callcenter_supervisor[] = array("atendente" => $primeiroAtendente);
                            }

                            foreach ($callcenter_supervisor as $key => $value) {
                                $atendentes[] = $value['atendente'];
                            }

                            $atendentes = array_filter($atendentes);
                            if(count($atendentes) > 0){
                                if ($backoffice_centralizado == true) {
                                    $sql = "SELECT  tbl_posto_fabrica.admin_sap as admin,
                                                    tbl_admin.nome_completo
                                                FROM tbl_posto_fabrica
                                                    JOIN tbl_posto ON tbl_posto.posto=tbl_posto_fabrica.posto
                                                        AND tbl_posto_fabrica.fabrica={$login_fabrica}
                                                    JOIN tbl_admin ON tbl_admin.admin = tbl_posto_fabrica.admin_sap
                                                WHERE tbl_posto_fabrica.fabrica = {$login_fabrica}
                                                    AND tbl_posto_fabrica.posto = {$xcodigo_posto}
                                                    AND tbl_posto_fabrica.admin_sap IN(".implode(",",$atendentes).")
                                                GROUP BY    tbl_posto_fabrica.admin_sap,
                                                            tbl_admin.login,
                                                            tbl_admin.nome_completo
                                                ORDER BY tbl_posto_fabrica.admin_sap";
                                } else {
                                    $sql = "SELECT  tbl_admin_atendente_estado.admin,
                                                    tbl_admin.nome_completo
                                                FROM tbl_admin_atendente_estado
                                                    JOIN tbl_admin USING(admin)
                                                    {$joinOrigem}
                                                WHERE tbl_admin_atendente_estado.fabrica = {$login_fabrica}
                                                    AND tbl_admin_atendente_estado.admin IN(".implode(",",$atendentes).")
                                                    AND tbl_admin.fabrica = {$login_fabrica}
                                                    AND tbl_admin.ativo IS TRUE
                                                    AND tbl_admin.nao_disponivel is NULL
                                                    AND tbl_admin_atendente_estado.hd_classificacao = {$hd_classificacao}
                                                    {$condOrigem}
                                                    $cond_cidade
                                                    $cond_estado
                                                    $cond_geral
                                                LIMIT 1";

                                    if ($login_fabrica == 30 ) {
                                        $sql = "SELECT  tbl_admin_atendente_estado.admin,
                                                    tbl_admin.nome_completo
                                                FROM tbl_admin_atendente_estado
                                                    JOIN tbl_admin USING(admin)
                                                    {$joinOrigem}
                                                WHERE tbl_admin_atendente_estado.fabrica = {$login_fabrica}
                                                    AND tbl_admin_atendente_estado.admin IN(".implode(",",$atendentes).")
                                                    AND tbl_admin.fabrica = {$login_fabrica}
                                                    AND tbl_admin.ativo IS TRUE
                                                    AND tbl_admin.nao_disponivel is NULL
                                                    AND tbl_admin_atendente_estado.hd_classificacao = {$hd_classificacao}
                                                LIMIT 1";
                                    }
                                }

                                $resP = pg_query($con,$sql);

                                $novo_atendente = pg_fetch_result($resP, 0, 'admin');
                                $nome_atendente = pg_fetch_result($resP, 0, 'nome_completo');

                                $sql = "UPDATE tbl_hd_chamado SET atendente = {$novo_atendente} WHERE hd_chamado = {$hd_chamado}";
                                $resP = pg_query($con,$sql);

                                $sql = "INSERT INTO tbl_hd_chamado_item(
                                            hd_chamado   ,
                                            data         ,
                                            comentario   ,
                                            admin        ,
                                            interno      ,
                                            status_item  ,
                                            admin_transferencia
                                        ) VALUES (
                                            {$hd_chamado},
                                            current_timestamp,
                                            E'Atendimento transferido para <b>$nome_atendente</b>',
                                            {$login_admin},
                                            't',
                                            {$xstatus_interacao},
                                            {$novo_atendente}
                                        ) RETURNING hd_chamado_item";
                                $resP = pg_query($con,$sql);

                                $msg_erro .= pg_last_error($con);
                                if ($login_fabrica == 189 && verifica_origem_atendimento($_POST["origem"]) == "producao" && strlen($msg_erro) == 0) {
                                    $hd_chamado_item = pg_fetch_result($res, 0, 'hd_chamado_item');
                                    grava_chamado_item_externo($hd_chamado, $hd_chamado_item);
                                }
                            }
                        }

                        if (in_array($login_fabrica, array(169,170)) && $transferir_atendimento == "não" && $atendimento_jornada === true) {
                            $sqlAtendenteJornada = "
                                SELECT
                                    tbl_admin.admin,
                                    tbl_admin.nome_completo,
                                    (
                                        SELECT COUNT(1)
                                        FROM tbl_hd_chamado
                                        WHERE tbl_hd_chamado.data::DATE = CURRENT_DATE
                                        AND tbl_hd_chamado.status NOT IN ('Resolvido','Cancelado','Finalizado')
                                        AND tbl_hd_chamado.fabrica_responsavel = $login_fabrica
                                        AND tbl_hd_chamado.atendente = tbl_admin.admin
                                    ) AS tot
                                FROM tbl_admin
                                WHERE tbl_admin.fabrica = {$login_fabrica}
                                AND (tbl_admin.atendente_callcenter IS TRUE OR tbl_admin.callcenter_supervisor IS TRUE)
                                AND tbl_admin.participa_agenda IS TRUE
                                AND tbl_admin.ativo IS TRUE
                                AND tbl_admin.nao_disponivel IS NULL
                                ORDER BY tot
                                LIMIT 1
                            ";
                            $resAtendenteJornada = pg_query($con,$sqlAtendenteJornada);

                            if (pg_num_rows($resAtendenteJornada) > 0) {
                                $novo_atendente = pg_fetch_result($resAtendenteJornada, 0, 'admin');
                                $nome_atendente = pg_fetch_result($resAtendenteJornada, 0, 'nome_completo');

                                $sql = "UPDATE tbl_hd_chamado SET atendente = {$novo_atendente} WHERE hd_chamado = {$hd_chamado}";
                                $resP = pg_query($con,$sql);

                                if ($novo_atendente != $login_admin) {
                                    $sql = "INSERT INTO tbl_hd_chamado_item(
                                                hd_chamado   ,
                                                data         ,
                                                comentario   ,
                                                admin        ,
                                                interno      ,
                                                status_item  ,
                                                admin_transferencia
                                            ) VALUES (
                                                {$hd_chamado},
                                                current_timestamp,
                                                E'Atendimento transferido para <b>$nome_atendente</b>',
                                                {$login_admin},
                                                't',
                                                {$xstatus_interacao},
                                                {$novo_atendente}
                                            )";
                                    $resP = pg_query($con,$sql);
                                    $msg_erro .= pg_last_error($con);
                                }
                            } else {
                                $msg_erro .= "Nenhum atendente configurado para jornada<br />";
                            }
                        }


                        $sql = "SELECT descricao, texto_email, texto_email_admin, texto_sms FROM tbl_hd_motivo_ligacao WHERE hd_motivo_ligacao = {$hd_motivo_ligacao} AND fabrica = {$login_fabrica}";
                        $resP = pg_query($con,$sql);

                        $texto_email = pg_fetch_result($resP, 0, 'texto_email');
                        $texto_email_admin = pg_fetch_result($resP, 0, 'texto_email_admin');
                        $texto_sms   = pg_fetch_result($resP, 0, 'texto_sms');
                        $desc_motivo_ligacao = pg_fetch_result($resP, 0, 'descricao');

                        $texto_email = ($texto_email == "null") ? "" : trim($texto_email);
                        $texto_email_admin = ($texto_email_admin == "null") ? "" : trim($texto_email_admin);
                        $texto_sms   = ($texto_sms == "null") ? "" : trim($texto_sms);

                        // echo $sql;exit;
                        if(strlen($texto_email) > 0){
                            $texto_email = textoProvidencia_new($texto_email,$hd_chamado,$consumidor_nome,$numero_objeto);
                        }

                        if(strlen($texto_email_admin) > 0){
                            $texto_email_admin = textoProvidencia_new($texto_email_admin,$hd_chamado,$consumidor_nome,$numero_objeto);
                        }

                        if(strlen($texto_sms) > 0){
                            $texto_sms = textoProvidencia_new($texto_sms,$hd_chamado,$consumidor_nome,$numero_objeto);
                        }
                    }

                    if((!empty($hd_motivo_ligacao_ant) AND $hd_motivo_ligacao <> $hd_motivo_ligacao_ant ) OR $transferir_atendimento == 'sim'){
                        if(!empty($hd_motivo_ligacao_ant)){
                            $sql = "SELECT descricao, texto_email FROM tbl_hd_motivo_ligacao WHERE hd_motivo_ligacao = {$hd_motivo_ligacao} AND fabrica = {$login_fabrica}";
                            $resP = pg_query($con,$sql);
                            $desc_motivo_ligacao = pg_fetch_result($resP, 0, 'descricao');
                            if($login_fabrica == 171){
                                $texto_email = pg_fetch_result($resP, 0, 'texto_email');
                            }
                            $sql = "SELECT descricao, texto_email, texto_sms FROM tbl_hd_motivo_ligacao WHERE hd_motivo_ligacao = {$hd_motivo_ligacao_ant} AND       fabrica = {$login_fabrica}";
                            $resP = pg_query($con,$sql);
                            $desc_motivo_ligacao_ant = pg_fetch_result($resP, 0, 'descricao');
                            $texto_interacao = "A providência do atendimento foi alterada por <b>$login_login</b> de <b> $desc_motivo_ligacao_ant </b> para <b>$desc_motivo_ligacao</b>";

                        } else {

                            $texto_interacao = !in_array($login_fabrica, [184,195,200]) ?
                                "O atendimento foi aberto por <b>$login_login</b> com a providência <b>$desc_motivo_ligacao</b>" :
                                "";

                            if(in_array($login_fabrica, array(169,170))){
                                $campo_hd_motivo_ligacao = ", hd_motivo_ligacao";
                                $value_hd_motivo_ligacao = ", $hd_motivo_ligacao";
                            }else{
                                $campo_hd_motivo_ligacao = "";
                                $value_hd_motivo_ligacao = "";
                            }
                        }

                        $sql = "INSERT INTO tbl_hd_chamado_item(
                                            hd_chamado   ,
                                            data         ,
                                            comentario   ,
                                            admin        ,
                                            interno      ,
                                            status_item
                                            $campo_hd_motivo_ligacao
                                        ) VALUES(
                                            $hd_chamado  ,
                                            current_timestamp,
                                            E'$texto_interacao',
                                            {$login_admin},
                                            't',
                                            $xstatus_interacao
                                            $value_hd_motivo_ligacao
                                        ) RETURNING hd_chamado_item";
                        $res = pg_query($con,$sql);
                        $msg_erro .= pg_errormessage($con);
                        if ($login_fabrica == 189 && verifica_origem_atendimento($_POST["origem"]) == "producao" && strlen($msg_erro) == 0) {
                            $hd_chamado_item = pg_fetch_result($res, 0, 'hd_chamado_item');
                            grava_chamado_item_externo($hd_chamado, $hd_chamado_item);
                        }
                        // preenche a variavel texto e-mail e SMS se o tipo de providencia for diferente da anterior
                        if (in_array($login_fabrica, [151,186,189,190,198])) {
                            $sql = "SELECT descricao, texto_email, texto_email_admin, texto_sms FROM tbl_hd_motivo_ligacao WHERE hd_motivo_ligacao = {$hd_motivo_ligacao} AND fabrica = {$login_fabrica}";
                            $resP = pg_query($con,$sql);

                            $texto_email = pg_fetch_result($resP, 0, 'texto_email');
                            $texto_email_admin = pg_fetch_result($resP, 0, 'texto_email_admin');
                            $texto_sms   = pg_fetch_result($resP, 0, 'texto_sms');
                            $desc_motivo_ligacao = pg_fetch_result($resP, 0, 'descricao');

                            $texto_email = ($texto_email == "null") ? "" : trim($texto_email);
                            $texto_email_admin = ($texto_email_admin == "null") ? "" : trim($texto_email_admin);
                            $texto_sms   = ($texto_sms == "null") ? "" : trim($texto_sms);
                            // echo $sql;exit;
                            if(strlen($texto_email) > 0){
                                $texto_email = textoProvidencia_new($texto_email,$hd_chamado,$consumidor_nome,$numero_objeto);
                            }

                            if(strlen($texto_email_admin) > 0){
                                $texto_email_admin = textoProvidencia_new($texto_email_admin,$hd_chamado,$consumidor_nome,$numero_objeto);
                            }

                            if(strlen($texto_sms) > 0){
                                $texto_sms = textoProvidencia_new($texto_sms,$hd_chamado,$consumidor_nome,$numero_objeto);
                            }

                            if ($login_fabrica == 151) {
                                $sql_email = "SELECT destinatarios
                                                FROM tbl_hd_motivo_ligacao
                                                WHERE destinatarios is not null
                                                    AND fabrica = {$login_fabrica}
                                                    AND hd_motivo_ligacao = $hd_motivo_ligacao;";
                                $res_email = pg_query($con,$sql_email);
                                $msg_erro .= pg_last_error();
                                if (pg_num_rows($res_email) > 0) {
                                    $destinatario = pg_fetch_result($res_email, 0, 'destinatarios');
                                    $destinatario = json_decode($destinatario,true);

                                    $destinatario = implode(";", $destinatario);
                                    $header = "From: Telecontrol <noreply@telecontrol.com.br>";
                                    //$texto_interacao_p = str_replace(array("<b>","</b>"), '"', $texto_interacao);
                                    mail($destinatario,utf8_encode('Alteração de providência no atendimento '.$hd_chamado),utf8_encode($texto_email_admin), $header );

                                }
                            }

                        }

                    }
                    #exit("kdaslkdlasmonteiro");
                    if(strlen($msg_erro) == 0 and is_numeric($cidade)){

                        $dados_consumidor = array(  "nome"          => preg_replace("/\t/","",$consumidor_nome),
                                "endereco"      => $consumidor_endereco,
                                "numero"        => $consumidor_numero,
                                "complemento"   => $consumidor_complemento,
                                "bairro"        => $consumidor_bairro,
                                "cidade"        => $cidade,
                                "cep"           => $consumidor_cep,
                                "fone"          => $consumidor_fone,
                                "email"         => $consumidor_email,
                                "cpf"           => preg_replace("/\D/","",$consumidor_cpf),
                                "rg"            => $consumidor_rg
                                );

                        $cliente = verifica_cliente($dados_consumidor);

                        if(!empty($cliente)){
                            $sql = "UPDATE tbl_hd_chamado_extra SET cliente = {$cliente} WHERE hd_chamado = {$hd_chamado}";
                            $res = pg_query($con,$sql);
                        }
                    }
                }

                if (empty($msg_erro)){
                    if(in_array($login_fabrica, array(169,170)) OR $usaScriptFalha){
                        if(
                            (
                                strlen(trim($script_resolution)) > 0
                                AND strlen(trim($ultima_pergunta_script)) > 0
                                AND strlen(trim($ultima_resposta_script)) > 0
                                AND strlen(trim($ultima_instrucao_script)) > 0
                                AND (
                                    (
                                        !isset($_GET['callcenter'])
                                        AND !in_array($login_fabrica, [174])
                                    )
                                    OR in_array($login_fabrica, [174,183])
                                )
                            )
                        ){
                            $rowsScript = 0;
                            if (in_array($login_fabrica, [174])) {
                                $queryScript = "SELECT hd_chamado_script_falha
                                                FROM tbl_hd_chamado_script_falha
                                                WHERE hd_chamado = {$callcenter}
                                                AND fabrica = {$login_fabrica}";
                                $resScript = pg_query($con, $queryScript);
                                $rowsScript = pg_num_rows($resScript);
                            }

                            if (empty($rowsScript)) {
                                $dados_script_resolution = "Resolução Script de Falha: <br/>".$script_resolution;
                                $sql = "INSERT INTO tbl_hd_chamado_item(
                                                    hd_chamado   ,
                                                    data         ,
                                                    comentario   ,
                                                    admin        ,
                                                    interno      ,
                                                    status_item
                                                ) VALUES(
                                                    $hd_chamado  ,
                                                    current_timestamp,
                                                    E'$dados_script_resolution',
                                                    {$login_admin},
                                                    't',
                                                    $xstatus_interacao
                                                )";
                                $res = pg_query($con,$sql);
                                $msg_erro .= pg_errormessage($con);

                                if(strlen(trim($msg_erro)) == 0){
                                    $sql = "INSERT INTO tbl_hd_chamado_script_falha(
                                                            fabrica,
                                                            ultima_pergunta,
                                                            ultima_resposta,
                                                            instrucao,
                                                            hd_chamado,
                                                            historico_resolucao
                                                        )VALUES(
                                                            $login_fabrica,
                                                            '$ultima_pergunta_script',
                                                            '$ultima_resposta_script',
                                                            '$ultima_instrucao_script',
                                                            $hd_chamado,
                                                            E'$script_resolution'
                                                        )";
                                    $res = pg_query($con, $sql);
                                    $msg_erro .= pg_errormessage($con);
                                }
                            }
                        }
                    }
                }
                if (in_array($login_fabrica, array(169,170,171))) {
                    $envia_email_agendamento_posto = false;

                    if (!empty($os_aberta) || !empty($os)) {
                        $os_agendada = (empty($os_aberta)) ? $os : $os_aberta;

                        if (in_array($login_fabrica, array(169, 170))) {
                            $sqlLinhaDeslocamento = "
                                SELECT l.linha
                                FROM tbl_os o
                                INNER JOIN tbl_os_produto op ON op.os = o.os
                                INNER JOIN tbl_produto p ON p.produto = op.produto AND p.fabrica_i = {$login_fabrica}
                                INNER JOIN tbl_linha l ON l.linha = p.linha AND l.fabrica = {$login_fabrica}
                                WHERE o.os = {$os_agendada}
                                AND l.deslocamento IS TRUE
                            ";
                            $resLinhaDeslocamento = pg_query($con, $sqlLinhaDeslocamento);
                        }
                        if (in_array($login_fabrica, array(171,190))) {

                            $sqlTipoAtendimento = "SELECT tipo_atendimento
                                       FROM tbl_tipo_atendimento
                                       WHERE tipo_atendimento = {$tipo_atendimento_grohe}
                                       AND km_google IS TRUE";
                            $resTipoAtendimento = pg_query($con, $sqlTipoAtendimento);

                        }

                        if ((in_array($login_fabrica,[171,190]) && pg_num_rows($resTipoAtendimento) > 0) || (in_array($login_fabrica, array(169, 170)) && pg_num_rows($resLinhaDeslocamento) > 0)) {
                            if (empty($msg_erro) AND ($abre_os == "t" || ($login_fabrica == 171 && $_POST["abre_ordem_servico"] == "t"))) {
                                list($da_dia, $da_mes, $da_ano) = explode("/", $_POST["data_agendamento_ordem"]);
                                $data_agendamento_ordem = $_POST['data_agendamento_ordem'];
                                $periodo = $_POST['periodo'];
                                $reagenda_manual = $_POST['reagenda_manual'];

                                $sqlVerAgenda = "
                                    SELECT
                                        ta.data_agendamento, ta.periodo
                                    FROM tbl_tecnico_agenda ta
                                    JOIN tbl_os o USING(os,fabrica)
                                    WHERE ta.fabrica = {$login_fabrica}
                                    AND o.os = {$os_agendada}
                                    AND ta.confirmado NOTNULL
                                    ORDER BY ta.data_input DESC
                                    LIMIT 1
                                ";

                                if ($reagenda_manual == "t") {
                                    $sqlVerAgenda = "
                                        SELECT *
                                        FROM (
                                            SELECT
                                                ta.data_agendamento, ta.periodo
                                            FROM tbl_tecnico_agenda ta
                                            JOIN tbl_os o USING(os,fabrica)
                                            WHERE ta.fabrica = {$login_fabrica}
                                            AND o.os = {$os_agendada}
                                            ORDER BY ta.data_input DESC
                                            LIMIT 1
                                        ) x
                                        WHERE data_agendamento::DATE = '{$da_ano}-{$da_mes}-{$da_dia}'
                                        AND periodo = '{$periodo}';
                                    ";
                                }

                                $resVerAgenda = pg_query($con, $sqlVerAgenda);

                                if (pg_num_rows($resVerAgenda) == 0) {

                                    if (in_array($login_fabrica, array(169,170)) && !empty($posto_tab)) {
                                        $sql = "SELECT
                                                    TO_CHAR(ab.data_inicio, 'DD/MM/YYYY') AS data_inicio,
                                                    TO_CHAR(ab.data_final, 'DD/MM/YYYY') AS data_final,
                                                    descricao
                                                FROM tbl_tecnico_agenda_bloqueio ab
                                                LEFT JOIN tbl_posto_fabrica pf ON pf.posto = {$posto_tab} AND pf.fabrica = {$login_fabrica}
                                                LEFT JOIN tbl_posto p ON p.posto = pf.posto
                                                WHERE ab.fabrica = {$login_fabrica}
                                                AND (ab.linha->>'linhas' ilike '%{$mapa_linha}%' OR ab.linha IS NULL OR ab.linha = '{}')
                                                AND (
                                                        ab.data_inicio::date BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '2 MONTHS'
                                                    OR  ab.data_final::date BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '2 MONTHS'
                                                )
                                                AND (
                                                    ab.posto = p.posto
                                                    OR ab.estado = p.estado
                                                    OR ab.cidade = (
                                                        SELECT cidade
                                                        FROM tbl_cidade
                                                        WHERE UPPER(fn_retira_especiais(nome)) = UPPER(fn_retira_especiais(p.cidade))
                                                        AND UPPER(estado) = UPPER(p.estado)
                                                        LIMIT 1
                                                    )
                                                    OR (ab.posto IS NULL AND ab.estado IS NULL AND ab.cidade IS NULL)
                                                )";
                                        $res = pg_query($con, $sql);

                                        $datas_bloqueadas = array();
                                        if (pg_num_rows($res) > 0){
                                            for ($i=0; $i < pg_num_rows($res); $i++) {
                                                $data_inicio = pg_fetch_result($res, $i, 'data_inicio');
                                                $data_final  = pg_fetch_result($res, $i, 'data_final');
                                                $array_datas = getDates($data_inicio, $data_final);

                                                foreach ($array_datas as $key => $value) {
                                                    $datas_bloqueadas[] = $value;
                                                }
                                            }
                                        }
                                    }

                                    if (in_array(date("N", strtotime("{$da_ano}-{$da_mes}-{$da_dia}")), array(6,7))) {
                                        $msg_erro .= "A data de agendamento deve ser em um dia Ãºtil<br />";
                                    } else if (in_array($data_agendamento_ordem, json_decode($feriados, true))) {
                                        $msg_erro .= "A data de agendamento selecionada é um feriado por favor selecione outra data<br />";
                                    } else if (in_array($data_agendamento_ordem, $datas_bloqueadas) AND in_array($login_fabrica, array(169,170))){
                                        $msg_erro .= "Data $data_agendamento_ordem bloqueada para agendamento<br />";
                                    } else {
                                        $countAgenda = "SELECT COUNT(*) FROM tbl_tecnico_agenda WHERE fabrica = {$login_fabrica} AND os = {$os_agendada};";
                                        $resCountAgenda = pg_query($con,$countAgenda);

                                        $ordem = pg_fetch_result($resCountAgenda, 0, 0);
                                        $ordem += 1;

                                        $sqlAgenda = "
                                            INSERT INTO tbl_tecnico_agenda (fabrica,admin,os,data_agendamento,ordem,periodo)
                                            VALUES ({$login_fabrica},{$login_admin},{$os_agendada},'{$da_ano}-{$da_mes}-{$da_dia}',$ordem, '$periodo');
                                        ";

                                        $res = pg_query($con,$sqlAgenda);

                                        if (strlen(pg_last_error()) > 0) {
                                            $msg_erro .= "Ocorreu um erro no agendamento da ordem de serviço para o posto #1";
                                        } else {
                                            $sqlInteracao = "
                                                INSERT INTO tbl_hd_chamado_item (hd_chamado,data,comentario,admin,interno,status_item)
                                                VALUES ({$hd_chamado},NOW(),'A OS {$os_agendada} foi agendada para: {$data_agendamento_ordem} , no perÃ­odo da: {$periodo}',{$login_admin},'t',{$xstatus_interacao});
                                            ";
                                            $resInteracao = pg_query($con,$sqlInteracao);

                                            if (strlen(pg_last_error()) > 0) {
                                                $msg_erro .= "Ocorreu um erro no agendamento da ordem de serviço para o posto #2";
                                            } else {
                                                if (empty($os_aberta)) {
                                                    $titAgenda = "Agendamento OS {$os_agendada}";
                                                    $msgAgenda = "A visita para a OS {$os_agendada} está agendada para o dia: {$data_agendamento_ordem} , no perÃ­odo da: {$periodo}.";
                                                    $sqlComunicado = "
                                                        INSERT INTO tbl_comunicado (mensagem,descricao,tipo,fabrica,obrigatorio_site,posto,ativo)
                                                        VALUES ('{$msgAgenda}','{$titAgenda}','Comunicado',{$login_fabrica},'t',{$xcodigo_posto},'t');
                                                    ";
                                                    $resComunicado = pg_query($con,$sqlComunicado);

                                                    if (strlen(pg_last_error()) > 0) {
                                                        $msg_erro .= "Ocorreu um erro no agendamento da ordem de serviço para o posto #3";
                                                    } else {

                                                        $sqlEmailPosto = "SELECT contato_email FROM tbl_posto_fabrica WHERE fabrica = {$login_fabrica} AND posto = {$xcodigo_posto};";
                                                        $resEmailPosto = pg_query($con,$sqlEmailPosto);

                                                        if (pg_num_rows($resEmailPosto) > 0) {
                                                            $email_posto_agendamento = pg_fetch_result($resEmailPosto, 0, contato_email);

                                                            $subject_email_agendamento_posto = $titAgenda;
                                                            $message_email_agendamento_posto = "
                                                                <p>{$msgAgenda}</p>
                                                            ";
                                                            $message_email_agendamento_posto = str_replace("\n", "<br />", $message);

                                                            $envia_email_agendamento_posto = true;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        if (!empty($os_agendada) || !empty($os)) {
                            if (!empty($os_agendada)) {
                                $os_pesquisa = $os_agendada;
                            } else {
                                $os_pesquisa = $os;
                            }

                            $sql = "SELECT * FROM tbl_os WHERE os = {$os_pesquisa} AND finalizada IS NULL AND excluida IS NOT TRUE";
                            $res = pg_query($con,$sql);

                            if(pg_num_rows($res) > 0){
                                if (!empty($produto) && !empty($cidade) && pg_num_rows($res) > 0) {
                                    $produto = pg_fetch_result($res, 0, 'produto');

                                    $whereJornada = array();

                                    if (!empty($cidade) && !empty($produto)) {
                                        $whereJornada[0] = "(cidade = {$cidade} AND produto = {$produto})";
                                        $whereJornada[2] = "(produto = {$produto})";
                                        $whereJornada[3] = "(cidade = {$cidade})";
                                    }

                                    if (!empty($consumidor_estado) && !empty($produto)) {
                                        $whereJornada[1] = "(estado = '{$consumidor_estado}' AND produto = {$produto})";
                                        $whereJornada[4] = "(estado = '{$consumidor_estado}')";
                                    }

                                    $sqlJornada = "
                                        SELECT * FROM tbl_hd_jornada
                                        WHERE fabrica = {$login_fabrica}
                                        AND (".implode("OR ", $whereJornada).")
                                        LIMIT 1
                                    ";
                                    $resJornada = pg_query($con,$sqlJornada);

                                    if (pg_num_rows($resJornada) > 0 && strtoupper($status_interacao) == "RESOLVIDO") {
                                        unset($status_interacao);
                                        $msg_erro .= "O chamado não pode ser finalizado pois deve acompanhar a jornada da OS";
                                    }
                                }
                            }
                        }
                    }
                }


                if (in_array($login_fabrica, [166,174]) AND empty($tipo_venda) AND strlen($callcenter) > 0) {
                    $msg_erro .= "Por favor, selecione a referência do atendimento. <br />";
                }

                if (in_array($login_fabrica, [186]) AND empty($tipo_venda) AND strlen($callcenter) > 0) {

                    $sqlOrigem = "SELECT descricao FROM tbl_hd_chamado_origem WHERE fabrica={$login_fabrica} AND hd_chamado_origem=".$_POST["origem"];
                    $resOrigem = pg_query($con, $sqlOrigem );
                    if (pg_num_rows($resOrigem) > 0) {
                        $nomeOrigem = trim(pg_fetch_result($resOrigem, 0, 'descricao'));

                        if ($nomeOrigem == "Mercado Livre") {
                            $msg_erro .= "Por favor, selecione a referência do atendimento. <br />";
                        }

                    }
                }
                if (
                    empty($msg_erro)
                    AND preg_match("/resolvido|cancelado/", strtolower($status_interacao))
                    AND $atendimentoFacebook == true
                    AND preg_match("/facebook/", strtolower($origem_nome))
                ) {
                    $qIntegracao = "SELECT x.*
                                    FROM (
                                       SELECT json_field('convId', thcie.id_integracao) AS conv_id,
                                              json_field('facebookPage', thce.array_campos_adicionais) AS page_id
                                       FROM tbl_hd_chamado_item_externo thcie
                                       JOIN tbl_hd_chamado thc ON thc.hd_chamado = thcie.hd_chamado AND thc.fabrica = thcie.fabrica
                                       JOIN tbl_hd_chamado_extra thce ON thce.hd_chamado = thc.hd_chamado
                                       WHERE thc.fabrica = {$login_fabrica}
                                       AND thc.hd_chamado = {$callcenter}
                                    )x
                                    WHERE x.conv_id IS NOT NULL
                                    LIMIT 1";
                    $rIntegracao = pg_query($con, $qIntegracao);
                    $rowsIntegracao = pg_num_rows($rIntegracao);

                    $convId = pg_fetch_result($rIntegracao, 0, 'conv_id');
                    $pageId = pg_fetch_result($rIntegracao, 0, 'page_id');

                    if ($rowsIntegracao > 0) {
                        $curlFb = curl_init();
                        $urlFb = "https://api2.telecontrol.com.br/posvenda-integracoes/fb-answer/convId/" . $convId . "/pageId/" . $pageId;

                        curl_setopt_array($curlFb, [
                            CURLOPT_URL => $urlFb,
                            CURLOPT_RETURNTRANSFER => true,
                            CURLOPT_TIMEOUT => 100,
                            CURLOPT_CUSTOMREQUEST => "DELETE",
                            CURLOPT_HTTPHEADER => array(
                            "Access-Application-Key:084f77e7ff357414d5fe4a25314886fa312b2cff",
                            "Access-Env:PRODUCTION",
                            "Content-Type:application/json;charset=utf-8",
                          ),
                        ]);

                        $apiResponseFb = curl_exec($curlFb);
                        $apiResponseFb = json_decode($apiResponseFb, true);

                        if ($apiResponseFb['exception'] OR strlen(curl_error($curlFb)) > 0) {
                            $msg_erro .= "Falha ao finalizar chamado integrado.<br />";
                        }
                    }
                }

                if(in_array($login_fabrica, [90, 141]) and strlen(trim($callcenter))==0){
                    $enviarEmail = true;
                }

                if ($atendimentoML == true AND empty($msg_erro) AND preg_match("/mercado livre/", strtolower($origem_nome))) {

                    if (!empty($melibre_attachment['name']) AND strlen($resposta) == 0) {
                        $msg_erro .= "Para enviar um anexo, você deve digitar uma resposta. <br />";
                    }

                    if ($envia_melibre == "on" AND empty($msg_erro)) {

                        $msgFalhaMl = "Falha ao enviar resposta via Mercado Livre. Tente novamente em instantes. <br />";

                        if (!empty($melibre_attachment['name'])) {
                            if (!in_array($melibre_attachment['type'], ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'])) {
                                $msg_erro .= "Formatos de arquivo permitidos: PNG, JPG e PDF <br />";
                            } elseif (number_format($melibre_attachment['size'] / 1048576, 2) >= 10) {
                                $msg_erro .= "Arquivo não deve exceder 10MB. <br />";
                            }
                        }

                        try {
                            $meli = new Meli(
                                '4814007018102931',
                                'bQq81aS24yoHydpTLhh0AuTJVjB7YvQq'
                            );

                            $tdocsMirror = new TdocsMirror();
                        } catch (\Exception $e) {
                            $msg_erro .= $msgFalhaMl;
                        }

                        // new token
                        if (time() > $parametros_adicionais['meLibreAccount']['mlExpires'] AND empty($msg_erro)) {

                            $tokenParams = [
                                'grant_type' => 'refresh_token',
                                'client_id' => '4814007018102931',
                                'client_secret' => 'bQq81aS24yoHydpTLhh0AuTJVjB7YvQq',
                                'refresh_token' => $parametros_adicionais['meLibreAccount']['mlRefreshToken']
                            ];

                            try {
                                $resultToken = $meli->post('/oauth/token', $tokenParams);
                            } catch (\Exception $e) {
                                $msg_erro .= "Erro ao renovar token de acesso. <br />";
                            }

                            $parametros_adicionais['meLibreAccount']['mlAccessToken'] = $resultToken['body']->access_token;
                            $parametros_adicionais['meLibreAccount']['mlRefreshToken'] = $resultToken['body']->refresh_token;
                            $parametros_adicionais['meLibreAccount']['mlExpires'] = time() + 21600;

                            $newParams = json_encode($parametros_adicionais);

                            $updateParams = "UPDATE tbl_fabrica
                                             SET parametros_adicionais = '{$newParams}'
                                             WHERE fabrica = {$login_fabrica}";
                            $result = pg_query($con, $updateParams);

                            if (strlen(pg_last_error()) > 0 OR pg_affected_rows($result) > 1) {
                                $msg_erro .= "Erro ao renovar token de acesso. <br />";
                            }

                        }

                        if (empty($msg_erro) AND !empty($melibre_attachment['name'])) {

                            $name = $melibre_attachment['name'];
                            $tmp = $melibre_attachment['tmp_name'];
                            $location = '/tmp/' . $name;
                            move_uploaded_file($tmp, $location);

                            // melibre
                            $curlML = curl_init();

                            $urlML = 'https://api.mercadolibre.com/messages/attachments?access_token='. $parametros_adicionais['meLibreAccount']['mlAccessToken'] . '&seller_id=' . $parametros_adicionais['meLibreAccount']['mlUserId'];

                            curl_setopt_array($curlML, [
                                CURLOPT_URL => $urlML,
                                CURLOPT_RETURNTRANSFER => true,
                                CURLOPT_TIMEOUT => 100,
                                CURLOPT_POST => true,
                                CURLOPT_POSTFIELDS => ['file' => curl_file_create($location, '', $name)],
                                CURLOPT_HTTPHEADER => ['Content-Type: multipart/form-data'],
                            ]);

                            $attachML = curl_exec($curlML);
                            $attachML = json_decode($attachML, true);

                            if (curl_error($curlML)) {
                                $msg_erro .= "Erro ao realizar upload de arquivo. <br />";
                            }

                            curl_close($curlML);

                            // tdocs
                            $uniqueId = [];

                            try {
                                $resultTdocs = $tdocsMirror->post($location);

                                foreach ($resultTdocs as $attachsKey => $attachs) {
                                    foreach ($attachs as $attach) {
                                        foreach ($attach as $key => $value) {
                                            if ($key == "unique_id") {
                                                $uniqueId[] = $value;
                                            }
                                        }
                                    }
                                }

                                $tdocsLink = $tdocsMirror->get($uniqueId[0]);
                                $tdocsLink = $tdocsLink['link'];
                            } catch (\Exception $e) {
                                $msg_erro .= $e->getMessage();
                            }

                            // chamado com anexo
                            $txtMessage = "Arquivo anexado: Clique <a target='_blank' href='" . $tdocsLink .  "'>aqui</a> para visualizar.";

                            $queryNewItem = "INSERT INTO tbl_hd_chamado_item (
                                                hd_chamado,
                                                comentario,
                                                admin,
                                                status_item
                                            ) VALUES ($1, $2, $3, $4) RETURNING hd_chamado_item";
                            $statement = pg_prepare($con, "item", $queryNewItem);
                            $result = pg_execute($con, "item", [
                                (int)$hd_chamado,
                                (string)$txtMessage,
                                (int)$login_admin,
                                (string)$status_interacao
                            ]);

                            $newHdChamadoItemId = pg_fetch_result($result, 0, 'hd_chamado_item');

                            if (strlen(pg_last_error()) > 0) {
                                $msg_erro .= $msgFalhaMl;
                            }

                            $queryTdocs = "INSERT INTO tbl_tdocs (
                                                tdocs_id,
                                                fabrica,
                                                contexto,
                                                referencia,
                                                referencia_id
                                            ) VALUES ($1, $2, $3, $4, $5)";
                            $statement = pg_prepare($con, "docs", $queryTdocs);
                            $result = pg_execute($con, "docs", [
                                (string)$uniqueId[0],
                                (int)$login_fabrica,
                                "interacao_callcenter",
                                "interacao_callcenter",
                                (int)$newHdChamadoItemId
                            ]);

                            if (strlen(pg_last_error()) > 0) {
                                $msg_erro .= "Erro ao realizar upload de arquivo. <br />";
                            }

                        }

                        if (empty($msg_erro)) {

                            $specialChars =   array_flip(get_html_translation_table(HTML_ENTITIES, ENT_COMPAT | ENT_HTML401, "ISO-8859-1"));
                            $resposta_ml = strtr($resposta, $specialChars);
                            $postBody = [
                                'message' => utf8_encode($resposta_ml),
                                'attachment' => !empty($attachML) ? $attachML : null,
                                'chamado' => $hd_chamado,
                                'fabrica' => $login_fabrica,
                                'admin' => $login_admin
                            ];

                            $curl = curl_init();

                            curl_setopt_array($curl, array(
                              CURLOPT_URL => "https://api2.telecontrol.com.br/posvenda-integracoes/ml-answer",
                              CURLOPT_POST => TRUE,
                              CURLOPT_RETURNTRANSFER => true,
                              CURLOPT_MAXREDIRS => 10,
                              CURLOPT_TIMEOUT => 100,
                              CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                              CURLOPT_CUSTOMREQUEST => "POST",
                              CURLOPT_POSTFIELDS => json_encode($postBody, JSON_UNESCAPED_UNICODE),
                              CURLOPT_HTTPHEADER => array(
                                "Access-Application-Key:084f77e7ff357414d5fe4a25314886fa312b2cff",
                                "Access-Env:PRODUCTION",
                                "Content-Type:application/json;charset=utf-8",
                              ),
                            ));

                            $responseAPI = curl_exec($curl);


                            $responseAPI = json_decode($responseAPI, true);
                            if (!in_array($responseAPI['http_code'], [200, 201])) {
                                $msg_erro .= "Falha na API de comunicação. <br />";
                            }

                            if (curl_error($curl)) {
                                $msg_erro .= $msgFalhaMl;
                            }

                            curl_close($curl);

	                    if ($_POST["tipo_venda"] == "PRE"){

				    $integracaoId = [
					'itemType' => 'question',
					'itemId' => $responseAPI['body']['id'],
				    ];

			    } else {

				    $integracaoId = [
					'itemType' => 'message',
					'itemId' => $responseAPI['body']['id'],
				//	'saleId' => $responseAPI['body']['resource_id']
					'saleId' => $parametros_adicionais['meLibreAccount']['mlUserId'],
				    ];
			    }

                            $integracaoId = json_encode($integracaoId);
                            $queryItemExterno = "INSERT INTO tbl_hd_chamado_item_externo (
                                                    fabrica,
                                                    hd_chamado,
                                                    hd_chamado_item,
                                                    id_integracao
                                                ) VALUES ($1, $2, $3, $4)";
                            $statement = pg_prepare($con, "insertItemExterno", $queryItemExterno);
                            $resultItemExterno = pg_execute($con, "insertItemExterno", [
                                (int)$login_fabrica,
                                (int)$hd_chamado,
                                (int)$newHdChamadoItemId,
                                (string)$integracaoId
                            ]);

                            if (strlen(pg_last_error()) > 0) {
                                $msg_erro .= "Erro ao inserir informações no sistema. <br />";
                            }

                        }

                    }

                }

                if (in_array($login_fabrica, array(169,170))) {
                    $sqlProvidenciaClassificacao = "
                        SELECT UPPER(fn_retira_especiais(hml.descricao)) AS providencia, UPPER(fn_retira_especiais(hc.descricao)) AS classificacao
                        FROM tbl_hd_motivo_ligacao hml
                        INNER JOIN tbl_hd_classificacao hc ON hc.hd_classificacao = hml.hd_classificacao AND hc.fabrica = {$login_fabrica}
                        WHERE hml.fabrica = {$login_fabrica}
                        AND hml.hd_motivo_ligacao = {$hd_motivo_ligacao}
                    ";
                    $resProvidenciaClassificacao = pg_query($con, $sqlProvidenciaClassificacao);

                    $providenciaClassificacao = pg_fetch_assoc($resProvidenciaClassificacao);

                    if (
                        strtoupper($status_interacao) == 'RESOLVIDO' && (
                            ($providenciaClassificacao['classificacao'] == 'ONDE COMPRAR' && in_array($providenciaClassificacao['providencia'], array('PECAS', 'PRODUTO', 'ACESSORIOS')))
                            || ($providenciaClassificacao['classificacao'] == 'SUGESTAO' && in_array($providenciaClassificacao['providencia'], array('ATENDIMENTO   BLUE SERVICE', 'ATENDIMENTO   CALL CENTER', 'MANUAL DE SERVICO', 'MANUAL DO PROPRIETARIO', 'POLITICA DE GARANTIA', 'PRODUTO', 'SITE')))
                            || ($providenciaClassificacao['classificacao'] == 'INFORMACOES INSTITUCIONAIS' && in_array($providenciaClassificacao['providencia'], array('CONTATO A IMPRENSA', 'INFORMACOES SOBRE A FABRICA', 'RECURSOS HUMANOS', 'TREINAMENTO')))
                            || ($providenciaClassificacao['classificacao'] == 'INFORMACOES SOBRE POS VENDA' && in_array($providenciaClassificacao['providencia'], array('CREDENCIAMENTO BLUE SERVICE', 'TREINAMENTO TECNICO')))
                            || ($providenciaClassificacao['classificacao'] == 'INFORMACOES SOBRE PRODUTO' && in_array($providenciaClassificacao['providencia'], array('CARACTERISTICAS TECNICAS', 'CODIGO EAN', 'CODIGO FINAME', 'DIMENSOES DO PRODUTO', 'FUNCOES DO PRODUTO', 'INSTRUCAO DE USO', 'MANUAIS DE PRODUTOS', 'SELO PROCEL')))
                            || ($providenciaClassificacao['classificacao'] == 'SUPORTE TECNICO' && in_array($providenciaClassificacao['providencia'], array('CODIGO DE PECAS', 'CODIGO DE PRODUTOS', 'CODIGOS DE ERRO', 'COMPATIBILIDADE ENTRE UNIDADES', 'DIAGRAMA ELETRICO', 'DIAMETRO DE TUBULACAO', 'INSTRUCAO DE USO', 'MANUAL DE SERVICO', 'NUMERO DE SERIE', 'SELO PROCEL   EFICIENCIA ENERGETICA', 'SUPORTE DIAGNOSTICO DO PRODUTO', 'SUPORTE INSTALACAO PRODUTO', 'SUPORTE SOBRE DIMENSIONAMENTO DO PRODUTO', 'VISTA EXPLODIDA')))
                            || ($providenciaClassificacao['classificacao'] == 'SOLICITACAO DE SERVICO' && in_array($providenciaClassificacao['providencia'], array('MANUTENCAO', 'INSTALACAO')))
                        )
                    ) {
                        $sqlProvidenciaClassificacao = "SELECT
                                    hc.hd_chamado,
                                    hcs.descricao AS classificacao,
                                    hml.descricao AS providencia,
                    tbl_admin.login,
                    tbl_hd_chamado_origem.descricao AS origem
                                FROM tbl_hd_chamado hc
                INNER JOIN tbl_admin ON hc.admin = tbl_admin.admin AND tbl_admin.fabrica = {$login_fabrica}
                                LEFT JOIN tbl_hd_chamado_extra hce ON hce.hd_chamado = hc.hd_chamado
                                LEFT JOIN tbl_hd_classificacao hcs ON hcs.hd_classificacao = hc.hd_classificacao AND hcs.fabrica = {$login_fabrica}
                                LEFT JOIN tbl_hd_motivo_ligacao hml ON hml.hd_motivo_ligacao = hce.hd_motivo_ligacao AND hml.fabrica = {$login_fabrica}
                LEFT JOIN tbl_hd_chamado_origem ON hce.hd_chamado_origem = tbl_hd_chamado_origem.hd_chamado_origem AND tbl_hd_chamado_origem.fabrica = {$login_fabrica}
                                WHERE hc.fabrica = {$login_fabrica}
                                AND hc.hd_chamado = {$hd_chamado}";
                        $resProvidenciaClassificacao = pg_query($con,$sqlProvidenciaClassificacao);
                        $resProvidenciaClassificacao = pg_fetch_all($resProvidenciaClassificacao);

                        $pushQueueMirror = new PushQueue();

                        try {

                            $queueResponse = $pushQueueMirror->post("TRACKSALE_INTEGRACAO",[
                                "fabrica" => $login_fabrica,
                                "customers" =>[
                                    [
                                        "consumidor_nome" => utf8_encode($consumidor_nome),
                                        "consumidor_cpf" => $consumidor_cpf,
                                        "consumidor_cidade" => utf8_encode($consumidor_cidade),
                                        "consumidor_estado" => $consumidor_estado,
                                        "consumidor_celular" => $consumidor_fone3,
                                        "consumidor_fone" => $consumidor_fone,
                                        "consumidor_email" => $consumidor_email,
                                        "codigo_posto" => $codigo_posto_tab,
                                        "nome_posto" => utf8_encode($posto_nome_tab),
                                        "numero_atendimento" => $hd_chamado,
                                        "classificacao" => utf8_encode($resProvidenciaClassificacao[0]['classificacao']),
                                        "providencia" => utf8_encode($resProvidenciaClassificacao[0]['providencia']),
                    "origem_atendimento" => utf8_encode($origem),
                    "login_atendimento" => $resProvidenciaClassificacao[0]['login']
                                    ]
                                ]
                            ]);
                        } catch(\Exception $e) {

                        }
                    }
                }

                // Inserindo TELEFONIA na tbl_hd_chamado_item_externo
                if($integracaoTelefonia === true && empty($msg_erro)) {

                    $ligacao_id = $_REQUEST['ligacao_id'];

                    if(!empty($ligacao_id)) {

                        $chamado_item = "INSERT INTO tbl_hd_chamado_item (hd_chamado, comentario, admin, interno, status_item, atendimento_telefone)
                                        VALUES ($hd_chamado, 'Ligação finalizada', $login_admin, true, 'Aberto', true) RETURNING hd_chamado_item;";
                        $res_chamado = pg_query($con, $chamado_item);
                        $linha = pg_fetch_result($res_chamado, 0, 'hd_chamado_item');

                        if(strlen(pg_last_error()) > 0) {
                            $msg_erro .= "#1 - Falha ao registrar ligação<br>";
                        }
                        if ($login_fabrica == 189 && verifica_origem_atendimento($_POST["origem"]) == "producao" && strlen($msg_erro) == 0) {
                            $hd_chamado_item = pg_fetch_result($res, 0, 'hd_chamado_item');
                            grava_chamado_item_externo($hd_chamado, $hd_chamado_item);
                        }
                        $consulta = "INSERT INTO tbl_hd_chamado_item_externo (fabrica, hd_chamado_item, hd_chamado, id_ligacao)
                                            VALUES ({$login_fabrica}, {$linha}, {$hd_chamado}, '{$ligacao_id}');";

                        $res_consulta = pg_query($con, $consulta);

                        if(strlen(pg_last_error()) > 0) {
                            $msg_erro .= "#2 - Falha ao registrar ligação<br>";
                        } else {
                            try {
                                $curl = curl_init();

                                curl_setopt_array($curl, array(
                                CURLOPT_URL => "http://api2.telecontrol.com.br/telefonia/ligacoes/uniqueId/".$ligacao_id,
                                CURLOPT_RETURNTRANSFER => true,
                                CURLOPT_ENCODING => "",
                                CURLOPT_MAXREDIRS => 10,
                                CURLOPT_TIMEOUT => 90,
                                CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                                CURLOPT_CUSTOMREQUEST => "PUT",
                                CURLOPT_POSTFIELDS => json_encode(["protocolo" => $hd_chamado]),
                                CURLOPT_HTTPHEADER => array(
                                    "Access-Application-Key: 084f77e7ff357414d5fe4a25314886fa312b2cff",
                                    "Access-Env: PRODUCTION",
                                    "Cache-Control: no-cache",
                                    "Content-Type: application/json"
                                    ),
                                ));

                                $response = curl_exec($curl);
                                $err = curl_error($curl);

                                curl_close($curl);
                            } catch (\Exception $e) { }
                        }
                    }
                }

                // FIM

                if (empty($msg_erro)) {
                    $enviou = false;
                    $enviou_email = '';
                    $enviou_sms = '';
                    $callcenter = $hd_chamado;

                    if (!empty($_POST['enviar_por_email']) OR (in_array($login_fabrica, array(151,169,170,171,186,190,198)) AND strlen($texto_email) > 0 AND ($hd_motivo_ligacao != 81 OR ($hd_motivo_ligacao == 81 AND strlen($numero_objeto) > 0)))) {
                        $sql = "SELECT nome, email from tbl_hd_chamado_extra where hd_chamado = $callcenter";
                        $qry = pg_query($con, $sql);

                        if (pg_num_rows($qry) == 0) {
                            $warning = 'Não foi possÃ­vel enviar interação por e-mail - e-mail do consumidor não cadastrado.';
                        } else {
                            $mensagem_email = (strlen($texto_email) > 0) ? $texto_email : $_POST['resposta'];
                            $consumidor_nome = pg_fetch_result($qry, 0, 'nome');
                            $consumidor_email = pg_fetch_result($qry, 0, 'email');

                            if (in_array($login_fabrica, array(169,170))){
                                $headers = 'From: <naorespondablueservice@carrier.com.br>';
                            }else{
                                $headers="From:Telecontrol <noreply@telecontrol.com.br>\nContent-type: text/html\n"; 
                            }
                
                            if(in_array($login_fabrica, array(151,169,170,190))){
                                $msg = $mensagem_email;
                            }else{
                                $msg = 'Prezado ' . $consumidor_nome . ",\n\n" . $mensagem_email;
                            }

                            $nome_fab = '';
                            if ($login_fabrica == '80') {
                                $nome_fab = 'Amvox';
                            }else{
                                $nome_fab = $login_fabrica_nome;
                            }

                                if (mail($consumidor_email, utf8_encode('Protocolo de Atendimento ' . $nome_fab . ' '. $callcenter), utf8_encode($msg), $headers)) {
                                    $enviou_email = 'e-mail ';
                                    $enviou = true;
                                }
                        }
                    }

                    if (!empty($_POST['enviar_por_sms']) OR (in_array($login_fabrica, $fabricas_sms) AND strlen($texto_sms) > 0 AND ($hd_motivo_ligacao != 81 OR ($hd_motivo_ligacao == 81 AND strlen($numero_objeto) > 0)))) {
                        $sql = "SELECT celular from tbl_hd_chamado_extra where hd_chamado = $callcenter and length(trim(celular)) > 0 ";
                        $qry = pg_query($con, $sql);

                        if (pg_num_rows($qry) == 0) {
                            $msg_erro .= 'Não foi possível enviar interação por SMS - celular do consumidor não cadastrado.';
                        } else {
                            $consumidor_celular = pg_fetch_result($qry, 0, 'celular');
                            require_once '../class/sms/sms.class.php';
                            $sms = new SMS();

                            $nome_fab = $sms->nome_fabrica;

                            $mensagem_sms = (strlen($texto_sms) > 0) ? $texto_sms : $_POST['resposta'];

                            if($login_fabrica == 151){
                                $sms_msg = ($_POST['enviar_por_sms']) ? "$nome_fab $callcenter. " . filter_input(INPUT_POST,'texto_sms_digitado') : $mensagem_sms;
                            }else if(in_array($login_fabrica, array(42,80,104,169,170,174,186,189))){
                                $sms_msg = ($_POST['enviar_por_sms']) ? "Protocolo de Atendimento $nome_fab $callcenter. " . filter_input(INPUT_POST,'texto_sms_digitado') : $mensagem_sms;
                            }else{
                                $sms_msg = "Protocolo de Atendimento $nome_fab $callcenter. " . filter_input(INPUT_POST,'resposta');
                            }
                            if ($sms->enviarMensagem($consumidor_celular, $sua_os, '', $sms_msg, $callcenter)) {
                                $enviou_sms = (empty($enviou_email)) ? 'SMS ' : 'e SMS ';
                                $enviou = true;
                            }
                        }
                    }

                    if (true === $enviou) {
                        $interacao = 'Foi enviado ' . $enviou_email . $enviou_sms . 'para o consumidor';

                        if($login_fabrica == 151 && !empty($texto_sms_digitado)){
                            $interacao .= "\n com a mensagem: ".$texto_sms_digitado;
                        }else{
                            if (in_array($login_fabrica, array(169,170))){
                                $interacao .= "\n com a mensagem: ".$sms_msg . $texto_email;
                            }elseif (in_array($login_fabrica, array(186)) && strlen($texto_email) > 0){
                                $interacao .= "\n\n com a mensagem: ".$sms_msg ."\n\n". $texto_email;
                            }else{
                                $interacao .= "\n com a mensagem: ".$sms_msg;
                            }

                        }

                        $ins = "INSERT INTO tbl_hd_chamado_item (hd_chamado, comentario, admin, interno) VALUES ($callcenter, '$interacao', $login_admin, 't') RETURNING hd_chamado_item";
                        $qry = pg_query($con, $ins);
                        if ($login_fabrica == 189 && verifica_origem_atendimento($_POST["origem"]) == "producao" && !pg_last_error()) {
                            $hd_chamado_item = pg_fetch_result($res, 0, 'hd_chamado_item');
                            grava_chamado_item_externo($hd_chamado, $hd_chamado_item);
                        }
                    }

                    if (in_array($login_fabrica, array(169,170,171)) && $envia_email_agendamento_posto === true) {
                        $mailTc->setEmailSubject($subject_email_agendamento_posto);
                        $mailTc->addToEmailBody($message_email_agendamento_posto);
                        $mailTc->setEmailFrom($externalEmail);
                        $mailTc->addEmailDest($email_posto_agendamento);
                        $mailTc->sendMail();
                    }
                }

                if (strlen($msg_erro) > 0) {
                    $os_troca = "";
                }

                if ($login_fabrica == 74 and !empty($data_consertado) and !empty($os_fechar)) {
                    $up_fechamento = pg_query(
                        $con,
                        "UPDATE tbl_os SET
                            data_fechamento = CURRENT_DATE,
                            data_conserto = '$data_consertado'
                            WHERE os = $os_fechar
                            AND finalizada isnull"
                    );

                    if (pg_affected_rows($up_fechamento) > 1) {
                        $msg_erro .= "Erro ao processar requisição";
                    }

                    $finaliza_os = pg_query($con, "SELECT fn_finaliza_os(os, $login_fabrica) FROM tbl_os WHERE os = $os_fechar AND finalizada IS NULL");

                    if (pg_last_error($con)) {
                        $sql_error = explode("CONTEXT:", pg_last_error($con));
                        $msg_erro .= trim(str_replace("ERROR:", "", $sql_error[0]));
                    }
                }

                if($login_fabrica == 138 && !empty($_POST['os']) && $status_interacao == "Resolvido"){

                    if(isset($_POST["cancela_mobra"])){
                        $cacelaMO = "f";
                    }else{
                        $cacelaMO = "t";
                    }

                    $sql = "UPDATE tbl_os_extra SET admin_paga_mao_de_obra = '$cacelaMO' WHERE os = ".$_POST['os'];
                    $res = pg_query($con,$sql);

                    if($cacelaMO == "f"){
                        $sql = "SELECT posto FROM tbl_os WHERE fabrica = $login_fabrica AND os = {$_POST['os']}";
                        $res = pg_query($con, $sql);

                        $xposto_id = pg_fetch_result($res, 0, 'posto');

                        $sql = "INSERT INTO tbl_comunicado (
                                                            mensagem,
                                                            descricao,
                                                            tipo,
                                                            fabrica,
                                                            obrigatorio_site,
                                                            posto,
                                                            ativo
                                                            ) VALUES (
                                                            '{$resposta}',
                                                            'OS {$_POST['os']} com mão-de-obra recusada',
                                                            'Com. Unico Posto',
                                                            {$login_fabrica},
                                                            't',
                                                            {$xposto_id},
                                                            't'
                                                        )";
                        $res = pg_query($con,$sql);
                    }

                    if (strlen(pg_last_error()) > 0) {
                        $msg_erro .= "Falha ao resolver chamado.<br />";
                    }

                }

                //Se veio conteÃºdo na variável $callcenter é atualização

                if (strlen($callcenter)) {

                    if (strlen($msg_erro) == 0) {

                        if($login_fabrica == 164){#3161041
                            include "../os_cadastro_unico/fabricas/164/classes/enviaDadosClientes.php";

                            $sql_ibge = "SELECT upper(fn_retira_especiais(cidade)) as cidade, estado, cod_ibge
                                FROM tbl_ibge WHERE UPPER(fn_retira_especiais(cidade)) = UPPER(fn_retira_especiais('{$consumidor_cidade}')) AND UPPER(estado) = UPPER('{$consumidor_estado}')";
                            $res_ibge = pg_query($con, $sql_ibge);

                            if(pg_num_rows($res_ibge) > 0){
                                $codigo_ibge = pg_fetch_result($res_ibge, 0, 'cod_ibge');
                                $uf = pg_fetch_result($res_ibge, 0, 'estado');
                            }

                            $xconsumidor_fone = str_replace("'", "", $xconsumidor_fone);
                            $xconsumidor_fone = str_replace("null", "", $xconsumidor_fone);
                            $xconsumidor_fone2 = str_replace("'", "", $xconsumidor_fone2);
                            $xconsumidor_fone2 = str_replace("null", "", $xconsumidor_fone2);
                            $xconsumidor_fone3 = str_replace("'", "", $xconsumidor_fone3);
                            $xconsumidor_fone3 = str_replace("null", "", $xconsumidor_fone3);

                            if(strlen(trim($xconsumidor_fone)) > 0){
                                $ddd = substr($xconsumidor_fone, 0, 2);
                                $yconsumidor_fone = substr($xconsumidor_fone, 2);
                            }

                            if(strlen(trim($xconsumidor_fone3)) > 0){
                                if(empty($xconsumidor_fone)){
                                    $ddd = substr($xconsumidor_fone3, 0, 2);
                                }
                                $yconsumidor_fone3 = substr($xconsumidor_fone3, 2);
                            }

                            if(empty($xconsumidor_fone) AND strlen(trim($xconsumidor_fone2)) > 0){
                                $ddd = substr($xconsumidor_fone2, 0, 2);
                                $yconsumidor_fone = substr($xconsumidor_fone2, 2);
                            }

                            if(empty($xconsumidor_fone3) AND empty($xconsumidor_fone) AND strlen(trim($xconsumidor_fone2)) > 0){
                                $ddd = substr($xconsumidor_fone2, 0, 2);
                                $yconsumidor_fone3 = substr($xconsumidor_fone2, 2);
                            }

                            if(empty($xconsumidor_fone2) AND empty($xconsumidor_fone3) AND strlen(trim($xconsumidor_fone)) > 0){
                                $ddd = substr($xconsumidor_fone, 0, 2);
                                $yconsumidor_fone3 = substr($xconsumidor_fone, 2);
                            }
                            $dados = array("ATENDIMENTO" => $hd_chamado, "BAIRRO" => retira_acentos($xconsumidor_bairro), "CEP" => $xconsumidor_cep, "CODMUN" => $codigo_ibge, "COMPLEMENTO" => $xconsumidor_complemento,
                                "CONTATO" => retira_acentos($xconsumidor_nome), "CPFCNPJ" => $xconsumidor_cpf, "DDD" => $ddd, "EMAIL" => $xconsumidor_email, "INSCREST" => $inscricao,
                                "INSCRMUN" => $inscricao2, "LOGRADOURO" => retira_acentos($xconsumidor_endereco), "NOME" => retira_acentos($xconsumidor_nome), "NUMERO" => $xconsumidor_numero,
                                "RG" => $xconsumidor_rg, "TELEFONE1" => $yconsumidor_fone, "TELEFONE2" => $yconsumidor_fone3,"UF" => $uf
                            );
                            $cliente = array();
                            foreach ($dados as $key => $value) {
                                $xvalue = str_replace("'", "", $value);
                                if(strlen(trim($xvalue)) == 0 OR $xvalue == "null"){
                                    $xvalue = "";
                                }
                                $cliente[$key] = $xvalue;
                            }
                            $classEnviaDadosClientes = new enviaDadosClientes($login_fabrica);
                            $classEnviaDadosClientes->enviaClientes($cliente);
                        }

                        $msg_erro .= pg_errormessage($con);

                        if ($login_fabrica == 174)
                        {
                            if ($xconsumidor_email != '' || $xconsumidor_email != NULL)
                            {
                                if ($xconsumidor_nome != '' || $xconsumidor_nome != NULL)
                                {
                                    $cliente = retira_acentos($xconsumidor_nome);
                                }else
                                {
                                    $cliente = 'Cliente';
                                }

                                if (isset($_POST['emitir_laudo']) && $_POST['emitir_laudo'] == 't')
                                {
                                    //INSERT INTO tbl_hd_chamado_item
                                    $assunto    = 'Autorização de troca - Aquarius';
                                    $mensagem   = 'Prezado <b>'.$cliente.'</b>, <br />Segue o <b><a href="http://posvenda.telecontrol.com.br/assist/externos/laudo_troca_aquarius.php?hd_chamado='.$hd_chamado.'">link para autorização de troca</a></b> do seu produto <b><u>'.$produto_nome.'</u></b>.';
                                    $mensagem  .= '<br /><br /> Caso o link acima não funcione, acesse diretamente pelo endereço: <br />
                                    <a href="http://posvenda.telecontrol.com.br/assist/externos/laudo_troca_aquarius.php?hd_chamado='.$hd_chamado.'">http://posvenda.telecontrol.com.br/assist/externos/laudo_troca_aquarius.php?hd_chamado='.$hd_chamado.'</a>';

                                    $mailTc = new TcComm($externalId);
                                    $envio  = $mailTc->sendMail(
                                        $xconsumidor_email,
                                        $assunto,
                                        $mensagem,
                                        $externalEmail
                                        );
                                    if (!$envio)
                                    {
                                        $msg_erro .= "Não foi possÃ­vel enviar o e-mail de Autorização de Troca";
                                        $res = pg_query($con,"ROLLBACK TRANSACTION");
                                    }

                                    $sql_laudo = "INSERT INTO tbl_hd_chamado_item(
                                            hd_chamado   ,
                                            data         ,
                                            comentario   ,
                                            admin        ,
                                            interno      ,
                                            status_item
                                        ) values (
                                            $callcenter       ,
                                            current_timestamp ,
                                            'Foi enviado um E-mail para o consumidor com o link da Autorização de Troca',
                                            $login_admin      ,
                                            't'               ,
                                            $xstatus_interacao
                                        )";
                                        $res = pg_query($con,$sql_laudo);
                                        if (!$res)
                                        {
                                            $msg_erro .= "Não foi possÃ­vel gravar a mensagem de Autorização de Troca";
                                            $res = pg_query($con,"ROLLBACK TRANSACTION");
                                        }
                                }

                            }
                        }

                        if (in_array($login_fabrica, [166,174,186])) {
			   if (strlen($tipo_venda) > 0) {
				    $query_tipo_venda = "UPDATE
							    tbl_hd_chamado_extra
							SET tipo_venda = '{$tipo_venda}'
							FROM tbl_hd_chamado
							WHERE tbl_hd_chamado.hd_chamado = tbl_hd_chamado_extra.hd_chamado
							AND tbl_hd_chamado.hd_chamado = {$callcenter}
							AND tbl_hd_chamado.fabrica = {$login_fabrica}";
				    $res_tipo_venda = pg_query($con, $query_tipo_venda);

				    if (strlen(pg_last_error()) > 0) {
					$msg_erro .= "Falha ao inserir referência. <br />";
				    }

			    }
                        }

                        if($login_fabrica == 90){
                            if($enviarEmail == true AND $status_interacao == "Aberto"){

                                $assunto = "Serviço de Atendimento ao Consumidor IBBL - $callcenter ";
                                $mensagem = "Sr.(a) $consumidor_nome. <Br><Br>
                                            O seu protocolo de atendimento na IBBL é o $callcenter. <Br><Br>
                                            Sua solicitação foi recebida e está sendo acompanhada pela nossa equipe de atendimento. <Br><Br>
                                            Durante o processo de resolução de sua solicitação enviaremos e-mails com o status de seu atendimento, caso precise de alguma informação adicional por favor nos contate através do telefone 0800 725 4225. <Br><Br><Br>
                                            Ficamos à sua disposição.<Br><Br>
                                            Serviço de Atendimento ao Consumidor IBBL ";

                                if(strlen(trim($consumidor_email))>0){
                                    $mailTc = new TcComm($externalId);

                                    $mailTc->sendMail(
                                    $consumidor_email,
                                    $assunto,
                                    $mensagem,
                                    $externalEmail
                                    );
                                }
                            }

                            $status_interacao_anterior = $_POST["status_interacao_anterior"];
                            if($enviarEmail != true AND $status_interacao_anterior != $status_interacao AND $status_interacao == 'Resolvido'){

                                $assunto = "Serviço de Atendimento ao Consumidor IBBL - $callcenter ";
                                $mensagem = "Sr.(a) $consumidor_nome. <br><br>
                                            O seu atendimento registrado através do protocolo ($callcenter) que estava sendo acompanhado pela nossa equipe de SAC foi finalizado.<br><br>
                                            Caso precise de alguma informação adicional por favor nos contate através do telefone 0800 725 4225.<br><br>
                                            Ficamos à sua disposição.<br><br>
                                            Serviço de Atendimento ao Consumidor IBBL ";

                                if(strlen(trim($consumidor_email))>0){
                                    $mailTc = new TcComm($externalId);

                                    $mailTc->sendMail(
                                    $consumidor_email,
                                    $assunto,
                                    $mensagem,
                                    $externalEmail
                                    );
                                }
                            }
                        }

                        if ($login_fabrica == 141 && $enviarEmail && $status_interacao == "Aberto") {
                            $assunto = "Serviço de Atendimento UNICOBA - $callcenter ";
                            $mensagem = "O seu protocolo de atendimento na UNICOBA é o $callcenter. <Br><Br>
                                        Sua solicitação foi recebida e está sendo acompanhada pela nossa equipe de atendimento. <Br><Br>
                                        Durante o processo de resolução de sua solicitação enviaremos e-mails com o status de seu atendimento. <Br><Br><Br>
                                        Ficamos à sua disposição.<Br><Br>
                                        Serviço de Atendimento ao Consumidor UNICOBA ";

                            if(strlen(trim($consumidor_email))>0){

                                $mailTc = new TcComm('smtp@posvenda');

                                $mailTc->sendMail(
                                $consumidor_email,
                                $assunto,
                                $mensagem,
                                'noreply@telecontrol.com.br'
                                );
                            }
                        }

                        if ($telecontrol_distrib && !isset($novaTelaOs)) {
                            $sql_verifica_interacao = "SELECT hd_chamado_item FROM tbl_hd_chamado_item
                                                       WHERE tbl_hd_chamado_item.hd_chamado = {$hd_chamado}";
                            $res_verifica_interacao = pg_query($con, $sql_verifica_interacao);

                            if (pg_num_rows($res_verifica_interacao) == 0) {
                                $sql_interacao = "INSERT INTO tbl_hd_chamado_item(
                                        hd_chamado   ,
                                        data         ,
                                        comentario   ,
                                        admin        ,
                                        interno      ,
                                        status_item  ,
                                        produto
                                     ) values (
                                         $hd_chamado       ,
                                         current_timestamp ,
                                         E'Atendimento aberto'    ,
                                         $login_admin      ,
                                         'f',
                                         $xstatus_interacao,
                                         $xproduto
                                         )";
                                $res_interacao = pg_query($con, $sql_interacao);
                            }

                        }
                        $res = pg_query($con,"COMMIT TRANSACTION");

                        /*if ($login_fabrica == 30 && !empty($xos_c_troca) && (isset($_POST['hd_motivo_ligacao']) && $_POST['hd_motivo_ligacao'] == 162)) {
                            $sql = "UPDATE tbl_os SET status_checkpoint = 32 WHERE os = {$xos_c_troca}";
                            pg_query($con, $sql);
                            $sql = "SELECT tbl_hd_chamado.hd_chamado FROM tbl_hd_chamado JOIN tbl_hd_chamado_extra USING(hd_chamado) WHERE tbl_hd_chamado_extra.os = {$xos_c_troca} AND tbl_hd_chamado.fabrica = {$login_fabrica} AND tipo_solicitacao IN(14,15,16,17,18)";
                            $res = pg_query($con, $sql);
                            if (pg_num_rows($res) == 0) {
                                header("Location: helpdesk_posto_autorizado_novo_atendimento.php?ordem_de_servico={$xos_c_troca}&callcenter={$callcenter}");
                                    exit;
                            }
                        }*/

                        if (true === $ea_email) {
                            $mailTc = new TcComm($externalId);

                            $mailTc->sendMail(
                                    $email_posto,
                                    $ea_email_assunto,
                                    $ea_email_mensagem,
                                    $externalEmail
                                    );
                        }

                        if($login_fabrica == 129){

                            include "gera_arquivo_ramal.php";

                        }

                        if($login_fabrica == 136){

                            $gerar_pedido_posto_interno = $_POST["gerar_pedido_posto_interno"];

                            if($gerar_pedido_posto_interno == "t"){
                                header("Location: pedido_cadastro.php?callcenter={$callcenter}");
                                exit;
                            }

                        }

                        if(in_array($login_fabrica, array(151,169,170))){
                            if($abreTelaOs){
                                $abreTelaOs = "true";
                            }else{
                                $abreTelaOs = "false";
                            }

                            if ($window_cadastra_pedido == 'true' && empty($os_troca)) {
                                $window_cadastra_pedido = "&cadastraPedido=true";
                            }else{
                                $window_cadastra_pedido = '';
                            }

                            header ("Location: $PHP_SELF?callcenter=$hd_chamado&os_troca=$os_troca&abreTelaOs=$abreTelaOs{$window_cadastra_pedido}");
                        }else{
                            if($login_fabrica == 30){
                                if($_POST['logomarca'] != ''){
                                    $logomarca = $_POST['logomarca'];
                                    $logomarca_sql = "SELECT logomarca FROM tbl_hd_chamado_logomarca WHERE hd_chamado = $hd_chamado";
                                    $res_logomarca = pg_query($con, $logomarca_sql);
                                    if(pg_num_rows($res_logomarca) > 0){
                                        $update_logomarca = "UPDATE tbl_hd_chamado_logomarca set logomarca = $logomarca where hd_chamado = $hd_chamado";
                                        pg_query($con, $update_logomarca);
                                    }else{
                                        $insert_logomarca = "INSERT INTO tbl_hd_chamado_logomarca (hd_chamado, logomarca) VALUES ($hd_chamado, $logomarca);";
                                        pg_query($con, $insert_logomarca);
                                    }
                                }
                            }
                            header ("Location: $PHP_SELF?callcenter=$hd_chamado");
                        }

                        exit;

                    } else {
                        $res = pg_query($con,"ROLLBACK TRANSACTION");
                    }

                } else { //Se não veio conteÃºdo na variável $callcenter é inserção

                    if (strlen($msg_erro) == 0) {
                        $res = pg_query($con,"COMMIT TRANSACTION");
                        if($login_fabrica == 129){

                            include "gera_arquivo_ramal.php";

                        }

                        if($login_fabrica == 136){

                            $gerar_pedido_posto_interno = $_POST["gerar_pedido_posto_interno"];

                            if($gerar_pedido_posto_interno == "t"){
                                header("Location: pedido_cadastro.php?callcenter={$hd_chamado}");
                                exit;
                            }

                        }

    #94971
                        if ($login_fabrica == 59 AND ($finaliza == $linhas)) {
                            header ("Location: $PHP_SELF?indicacao_posto=$indicacao_posto&callcenter=$hd_chamado&$imprimir_os#$tab_atual");
                            exit;
                        } else if($login_fabrica <> 59) {
                            if($login_fabrica == 151){
                                header ("Location: $PHP_SELF?indicacao_posto=$indicacao_posto&callcenter=$hd_chamado&os_troca=$os_troca&$imprimir_os#$tab_atual");
                            }else{
                                header ("Location: $PHP_SELF?indicacao_posto=$indicacao_posto&callcenter=$hd_chamado&$imprimir_os#$tab_atual");
                            }
                            exit;
                        }

                    } else {
                        $res = pg_query($con, "ROLLBACK TRANSACTION");
                    }

    }
}//IF DO BTN_ACAO

                function saudacao() {
                    $hora = date("H");
                    echo ($hora >= 7 and $hora <= 11) ? "bom dia" : (($hora>=18) ? "boa noite" : "boa tarde");
                }

                $callcenter  = $_GET['callcenter'];
                $imprimir_os = trim($_GET['imprimir_os']);
                $erro_login  = 'ok';

                // Variavel para validar Lenoxx
                if ($controle_distrib_telecontrol && strlen(trim($callcenter)) > 0 && is_numeric($callcenter)) {
                    $msg_funcao = valida_login_fabrica($callcenter);
                    if (!empty($msg_funcao)) {
                        $msg_erro = $msg_funcao;
                        $erro_login = 'erro';
                    }
                }

                if (strlen($callcenter) > 0 && is_numeric($callcenter) && $erro_login == 'ok') {
                    if (in_array($login_fabrica, array(96)))
                        $produto_referencia_s = "tbl_produto.referencia_fabrica as produto_referencia,";
                    else
                        $produto_referencia_s = "tbl_produto.referencia as produto_referencia,";

                    $sql_fone_adicional = "";
                    if($login_fabrica == 30){
                        $sql_fone_adicional = 'tbl_posto_fabrica.contato_fone_residencial AS telefone2,
                            tbl_posto_fabrica.contato_cel AS telefone3,';
                    }

                    if($login_fabrica == 162){
                        $join_linha = " LEFT JOIN tbl_linha on tbl_linha.linha = tbl_produto.linha
                        LEFT JOIN tbl_fabrica ON tbl_fabrica.posto_fabrica = tbl_hd_chamado_extra.posto
                        ";
                        $campo_linha = "
                            informatica,
                            tbl_hd_chamado_extra.tipo_atendimento,
                            tbl_fabrica.posto_fabrica AS posto_interno_tab,
                        ";
                    }

                    if (in_array($login_fabrica, array(169, 170))) {
                        $join_linha = "LEFT JOIN tbl_linha ON tbl_linha.linha = tbl_produto.linha AND tbl_linha.fabrica = {$login_fabrica}";
                        $join_familia = "LEFT JOIN tbl_familia ON tbl_familia.familia = tbl_produto.familia AND tbl_familia.fabrica = {$login_fabrica}";
                        $campo_linha = "tbl_linha.deslocamento AS linha_deslocamento,";
                        $campo_familia = "tbl_familia.black, tbl_familia.setor_atividade,";
                    }

                    if($login_fabrica <> 30){//HD-3172818
                        $cond_help = "AND (tbl_hd_chamado.titulo isnull or tbl_hd_chamado.titulo !~* 'help-desk')";
                    }

                    if (in_array($login_fabrica, array(42, 189))) {
                        $campo_pedido  = " tbl_hd_chamado_extra.pedido,  ";
                    }

                    if (in_array($login_fabrica, array(171, 190))) {
                        $campoTipoAtendimento = " tbl_hd_chamado_extra.tipo_atendimento,";
                    }

                    if($login_fabrica == 81){
                        $solucao = "tbl_hd_chamado_extra.solucao  , tbl_produto.marca as marca_produto,  ";
                    }

                    if ($login_fabrica == 174){
                        $produto_troca_obrigatoria = "tbl_produto.troca_obrigatoria, ";
                    }

                    if($usaOrigemCadastro){
                        $campo_hd_chamado_origem = " tbl_hd_chamado_extra.hd_chamado_origem,  ";
                    }

                    if ($login_fabrica == 178){
                        $sql_osr = "
                            SELECT DISTINCT oce.os_revenda AS id_os_revenda
                            FROM tbl_hd_chamado hc
                            JOIN tbl_os_revenda osr ON osr.hd_chamado = hc.hd_chamado AND osr.fabrica = $login_fabrica
                            JOIN tbl_os_campo_extra oce ON oce.os_revenda = osr.os_revenda AND oce.fabrica = $login_fabrica
                            WHERE hc.hd_chamado = $callcenter
                            AND hc.fabrica = $login_fabrica";
                        $res_osr = pg_query($con, $sql_osr);
                        if (pg_num_rows($res_osr) > 0){
                            $os_revenda_anterior = pg_fetch_result($res_osr,0,'id_os_revenda');
                            $id_os_revenda       = pg_fetch_result($res_osr,0,'id_os_revenda');
                        }
                    }
                    if($login_fabrica == 30){
                        $sql_logomarca = "SELECT logomarca FROM tbl_hd_chamado_logomarca WHERE hd_chamado = $callcenter";
                        $res_logomarca = pg_query($con, $sql_logomarca);

                        if(pg_num_rows($res_logomarca) > 0){
                            $logomarca = pg_fetch_result($res_logomarca, 'logomarca');

                            $codigo_logomarca = $logomarca;
                        }
                    }
                    #SELECT PRINCIPAL
                    $sql = "SELECT  tbl_hd_chamado_extra.hd_chamado as callcenter,
                        tbl_hd_chamado.admin as usuario_abriu,
                        to_char(tbl_hd_chamado_extra.data_abertura,'DD/MM/YYYY') as abertura_callcenter,
                        tbl_hd_chamado_extra.nome,
                        tbl_hd_chamado.protocolo_cliente,
                        $campo_hd_chamado_origem
                        $campo_pedido
                        tbl_hd_chamado_extra.endereco ,
                        $campoTipoAtendimento
                        JSON_FIELD('checklist', tbl_hd_chamado_extra.array_campos_adicionais) AS checklist,
                        tbl_hd_chamado.campos_adicionais->>'id_zendesk' AS id_zendesk,
                        JSON_FIELD('numero_documento', tbl_hd_chamado_extra.array_campos_adicionais) AS numero_documento,
                        tbl_hd_chamado_extra.numero ,
                        tbl_hd_chamado_extra.complemento ,
                        tbl_hd_chamado_extra.bairro ,
                        tbl_hd_chamado_extra.cep ,
                        tbl_hd_chamado_extra.fone ,
                        tbl_hd_chamado_extra.fone2 ,
                        tbl_hd_chamado_extra.celular ,
                        tbl_hd_chamado_extra.email ,
                        tbl_hd_chamado_extra.cpf ,
                        tbl_hd_chamado_extra.rg ,
                        tbl_hd_chamado_extra.cliente ,
                        tbl_hd_chamado_extra.consumidor_revenda,
                        tbl_hd_chamado_extra.qtde_km,
                        tbl_hd_chamado_extra.tipo_atendimento AS id_tipo_atendimento,
                        tbl_hd_chamado_extra.contato_nome,
                        tbl_hd_chamado_extra.posto_nome as ponto_referencia,
                        tbl_hd_chamado_extra.garantia as garantia_produto,
                        tbl_cidade.nome as cidade_nome,
                        tbl_cidade.estado,
                        tbl_cidade.estado_exterior,
                        tbl_hd_chamado_extra.origem,
                        tbl_hd_chamado.admin AS admin_abriu,
                        tbl_admin.login as atendente,
                        tbl_hd_chamado.data::date as data_hd_chamado,
                        to_char(tbl_hd_chamado.data,'DD/MM/YYYY HH24:MI') as data,
                        tbl_hd_chamado.status,
                        tbl_hd_chamado.categoria as natureza_operacao,
                        tbl_posto.posto,
                        tbl_posto_fabrica.contato_email as posto_email,
                        tbl_posto_fabrica.contato_fone_comercial as posto_fone,
                        tbl_posto_fabrica.obs as obs_posto,
                        $sql_fone_adicional
                            tbl_hd_chamado.titulo as assunto,
                        tbl_hd_chamado.categoria,
                        tbl_produto.produto,
                        tbl_produto.linha,
                        $produto_referencia_s
                            tbl_produto.descricao as produto_nome,
                        tbl_produto.voltagem,
                        tbl_produto.garantia,
                        $produto_troca_obrigatoria
                        tbl_produto.parametros_adicionais as produto_parametros_adicionais,
                        tbl_defeito_reclamado.defeito_reclamado,
                        tbl_defeito_reclamado.descricao as defeito_reclamado_descricao,
                        replace(tbl_hd_chamado_extra.reclamado,'style','') as reclamado,
                        tbl_hd_chamado_extra.os,
                        tbl_hd_chamado_extra.serie,
                        tbl_hd_chamado_extra.marca,
                        TO_CHAR(tbl_hd_chamado_extra.data_nf,'DD/MM/YYYY') as data_nf,
                        TO_CHAR(tbl_hd_chamado.data_providencia,'DD/MM/YYYY') as data_prov,
                        tbl_hd_chamado.data_providencia AS prazo_limite,
                        tbl_hd_chamado.esta_agendado,
                        tbl_hd_chamado_extra.nota_fiscal,
                        tbl_hd_chamado_extra.revenda,
                        tbl_hd_chamado_extra.revenda_nome,
                        tbl_hd_chamado_extra.revenda_cnpj,
                        tbl_hd_chamado_extra.ordem_montagem,
                        tbl_hd_chamado_extra.valor_nf,
                        tbl_hd_chamado_postagem.tipo_postagem,
                        tbl_servico_correio.codigo as servico_correio,
                        tbl_hd_chamado_postagem.codigo_postagem,
                        tbl_hd_chamado_postagem.obs as obs_postagem,
                        tbl_hd_chamado_extra.consumidor_final_nome,
                        tbl_hd_chamado_extra.hora_ligacao,
                        tbl_posto_fabrica.codigo_posto,
                        tbl_posto_fabrica.contato_endereco,
                        tbl_posto_fabrica.contato_numero,
                        tbl_posto_fabrica.contato_bairro,
                        tbl_posto_fabrica.contato_cidade,
                        tbl_posto_fabrica.contato_estado,
                        tbl_posto.nome as posto_nome,
                        to_char(tbl_hd_chamado_extra.data_abertura_os,'DD/MM/YYYY') as data_abertura,
                        tbl_hd_chamado_extra.receber_info_fabrica,
                        tbl_os.sua_os as sua_os,
                        tbl_os_extra.admin_paga_mao_de_obra,
                        tbl_hd_chamado_extra.abre_os,
                        tbl_hd_chamado_extra.leitura_pendente,
                        tbl_hd_chamado.atendente as atendente_pendente,
                        tbl_hd_chamado_extra.defeito_reclamado_descricao as hd_extra_defeito,
                        tbl_hd_chamado_extra.numero_processo,
                        tbl_hd_chamado_extra.tipo_registro  ,
                        $solucao
                        tbl_hd_chamado_extra.atendimento_callcenter  ,
                        tbl_hd_chamado_extra.familia ,
                        tbl_hd_chamado_extra.hd_motivo_ligacao ,
                        tbl_hd_chamado_extra.hd_situacao ,
                        tbl_hd_chamado_extra.obs_callcenter ,
                        tbl_hd_chamado_extra.hd_subclassificacao ,
                        tbl_admin.login            AS admin_login ,
                        tbl_admin.nome_completo    AS admin_nome_completo,
                        tbl_cliente_admin.nome     as nome_cliente_admin,
                        tbl_cliente_admin.cliente_admin,
                        tbl_hd_chamado_extra_filial.filial AS filial_id,
                        tbl_hd_chamado_extra.array_campos_adicionais,
                        to_char(tbl_hd_chamado_extra.data_nascimento,'DD/MM/YYYY') as data_nascimento,
                        $campo_linha
                        $campo_familia
                            tbl_hd_chamado.hd_classificacao,
                        tbl_hd_chamado.analise,
                        tbl_hd_chamado.cliente as id_cliente,
                        tbl_cliente.codigo_cliente,
                        tbl_cliente.nome as nome_cliente,
                        tbl_hd_providencia.hd_providencia,
                        tbl_motivo_contato.motivo_contato,
                        tbl_hd_chamado.hd_tipo_chamado
                            FROM tbl_hd_chamado
                            JOIN tbl_hd_chamado_extra        ON tbl_hd_chamado.hd_chamado               = tbl_hd_chamado_extra.hd_chamado

                            LEFT JOIN tbl_admin                   ON tbl_hd_chamado.admin                    = tbl_admin.admin
                            LEFT JOIN tbl_cliente_admin           ON tbl_cliente_admin.cliente_admin         = tbl_hd_chamado.cliente_admin
                            LEFT JOIN tbl_cliente                 ON tbl_cliente.cliente                     = tbl_hd_chamado.cliente
                            LEFT JOIN tbl_cidade                  ON tbl_hd_chamado_extra.cidade             = tbl_cidade.cidade
                            LEFT JOIN tbl_posto                   ON tbl_hd_chamado_extra.posto              = tbl_posto.posto
                            LEFT JOIN tbl_posto_fabrica           ON tbl_posto.posto                         = tbl_posto_fabrica.posto
                            AND tbl_posto_fabrica.fabrica = $login_fabrica
                            LEFT JOIN tbl_produto                 ON tbl_produto.produto                     = tbl_hd_chamado_extra.produto
                            $join_linha
                            $join_familia
                            LEFT JOIN tbl_revenda                 ON tbl_revenda.revenda                     = tbl_hd_chamado_extra.revenda
                            LEFT JOIN tbl_defeito_reclamado       ON tbl_defeito_reclamado.defeito_reclamado = tbl_hd_chamado_extra.defeito_reclamado
                            LEFT JOIN tbl_os                      ON tbl_os.os                               = tbl_hd_chamado_extra.os
                            LEFT JOIN tbl_os_extra                ON tbl_os_extra.os                         = tbl_os.os
                            LEFT JOIN tbl_hd_chamado_postagem     ON tbl_hd_chamado_postagem.hd_chamado      = tbl_hd_chamado.hd_chamado
                            LEFT JOIN tbl_hd_chamado_extra_filial ON tbl_hd_chamado_extra_filial.hd_chamado  = tbl_hd_chamado.hd_chamado
                            LEFT JOIN tbl_servico_correio         ON tbl_hd_chamado_postagem.servico_correio = tbl_servico_correio.servico_correio
                            LEFT JOIN tbl_hd_providencia          ON tbl_hd_providencia.hd_providencia       = tbl_hd_chamado_extra.hd_providencia
                            LEFT JOIN tbl_motivo_contato          ON tbl_motivo_contato.motivo_contato       = tbl_hd_chamado_extra.motivo_contato
                            WHERE tbl_hd_chamado.fabrica_responsavel = $login_fabrica
                            $cond_help
                            AND tbl_hd_chamado.hd_chamado = $callcenter";
                    $res = pg_query($con,$sql);

                    if (pg_num_rows($res) > 0) {
                        if($login_fabrica == 81){
                            $solucao    = pg_fetch_result($res, 0, solucao) ;
                            $solucao = (empty($solucao_post)) ? $solucao : $solucao_post;

                            $marca_produto      = pg_fetch_result($res, 0, marca_produto);

                            $sqlSolucao = " SELECT
                                        tbl_diagnostico.diagnostico,
                                        tbl_solucao.solucao,
                                        tbl_solucao.descricao as descricao_solucao
                                        FROM tbl_diagnostico
                                        INNER JOIN tbl_solucao using(solucao)
                                        WHERE tbl_diagnostico.fabrica = $login_fabrica
                                        AND solucao is not null
                                        AND marca = $marca_produto
                                        AND tbl_diagnostico.ativo is true ";
                            $resSolucao = pg_query($con, $sqlSolucao);
                             $optionSolucao = "<option value=''>Solução</option>";
                            for($i=0; $i<pg_num_rows($resSolucao); $i++){
                                $diagnostico        = pg_fetch_result($resSolucao, $i, diagnostico);
                                $solucao_db            = pg_fetch_result($resSolucao, $i, solucao);
                                $descricao_solucao  = pg_fetch_result($resSolucao, $i, descricao_solucao);

                                if($solucao_db == $solucao){
                                    $selected = " selected ";
                                }else{
                                    $selected = " ";
                                }
                                $optionSolucao .=  "<option value='$solucao_db' $selected>$descricao_solucao </option>";
                            }
                        }
                        if($login_fabrica == 162){
                            $linha_informatica               = pg_fetch_result($res,0,'informatica');
                            $posto_interno_tab               = pg_fetch_result($res,0,'posto_interno_tab');
                            $interno_atendimento             = pg_fetch_result($res,0,tipo_atendimento);
                            $interno_observacao              = pg_fetch_result($res,0,obs_callcenter);

                            $numero_documento   = pg_fetch_result($res,0, 'numero_documento'); //HD-3224475
                            $checklist          = pg_fetch_result($res, 0, 'checklist'); //HD-3224475
                        }

                            $motivo_contato_callcenter = pg_fetch_result($res, 0, 'motivo_contato');
                            $hd_providencia_callcenter = pg_fetch_result($res, 0, 'hd_providencia');

                        if (in_array($login_fabrica, array(169, 170))) {
                            $linha_deslocamento = pg_fetch_result($res, 0, "linha_deslocamento");
                            $garantia_estendida = pg_fetch_result($res, 0, "black");
                            $setor_atividade    = pg_fetch_result($res, 0, "setor_atividade");
                        }
                        if (in_array($login_fabrica, array(174))){
                            $troca_obrigatoria_campo = pg_fetch_result($res, 0, "troca_obrigatoria");
                        }

                        if (in_array($login_fabrica, array(42, 189))) {
                            $pedido = pg_fetch_result($res, 0, 'pedido');
                            if (in_array($login_fabrica, array(189))) {
                                $sqlPedido = "SELECT pedido_cliente FROM tbl_pedido WHERE fabrica = {$login_fabrica} AND pedido=".$pedido;
                                $resPedido = pg_query($con, $sqlPedido);
                                if (pg_num_rows($resPedido) > 0) {
                                    $pedido = pg_fetch_result($resPedido, 0, 'pedido_cliente');
                                } else {
                                    $pedido = "";
                                }
                            }
                        }

                        $callcenter               = pg_fetch_result($res,0,'callcenter');
                        $id_cliente_contratual    = pg_fetch_result($res,0,'id_cliente');
                        $codigo_cliente_contratual= pg_fetch_result($res,0,'codigo_cliente');
                        $nome_cliente_contratual  = pg_fetch_result($res,0,'nome_cliente');
                        $usuario_abriu            = pg_fetch_result($res,0,'usuario_abriu');
                        $abertura_callcenter      = pg_fetch_result($res,0,'abertura_callcenter');
                        $data_abertura_callcenter = pg_fetch_result($res,0,'data');
                        $data_hd_chamado          = pg_fetch_result($res,0,'data_hd_chamado');
                        $natureza_chamado         = pg_fetch_result($res,0,'natureza_operacao');
                        $consumidor_nome          = pg_fetch_result($res,0,'nome');
                        $cliente                  = pg_fetch_result($res,0,'cliente');
                        $consumidor_cpf           = pg_fetch_result($res,0,'cpf');
                        $consumidor_rg            = pg_fetch_result($res,0,'rg');
                        $consumidor_email         = pg_fetch_result($res,0,'email');
                        $consumidor_fone          = pg_fetch_result($res,0,'fone');
                        $consumidor_fone2         = pg_fetch_result($res,0,'fone2');
                        $consumidor_fone3         = pg_fetch_result($res,0,'celular');
                        $consumidor_cep           = pg_fetch_result($res,0,'cep');
                        $consumidor_endereco      = pg_fetch_result($res,0,'endereco');
                        $consumidor_numero        = pg_fetch_result($res,0,'numero');
                        $consumidor_numero = str_replace("&#8203;", "", $consumidor_numero);
                        $consumidor_complemento   = pg_fetch_result($res,0,'complemento');
                        $ponto_referencia         = pg_fetch_result($res,0,'ponto_referencia');
                        $consumidor_bairro        = pg_fetch_result($res,0,'bairro');
                        $consumidor_cidade        = pg_fetch_result($res,0,'cidade_nome');
                        $consumidor_estado        = pg_fetch_result($res,0,'estado');
                        $estado_exterior          = pg_fetch_result($res,0,'estado_exterior');
                        $obs_posto                = pg_fetch_result($res,0,'obs_posto');
                        $consumidor_revenda       = pg_fetch_result($res,0,'consumidor_revenda');

                        if($usaOrigemCadastro){
                            $origem    = pg_fetch_result($res,0,'hd_chamado_origem');
                            if(empty($origem)){
                                $origem               = pg_fetch_result($res,0,'origem');
                            }
                        }else{

                            $origem               = pg_fetch_result($res,0,'origem');
                        }
                        $assunto                  = pg_fetch_result($res,0,'assunto');
                        $sua_os                   = pg_fetch_result($res,0,'sua_os');
                        $os                       = pg_fetch_result($res,0,'os');
                        $admin_paga_mao_de_obra   = pg_fetch_result($res,0,'admin_paga_mao_de_obra');
                        $cancela_mobra            = ($admin_paga_mao_de_obra == "f") ? "t" : "";
                        $data_abertura            = pg_fetch_result($res,0,'data_abertura');
                        $produto                  = pg_fetch_result($res,0,'produto');
                        $produto_referencia       = pg_fetch_result($res,0,'produto_referencia');
                        $produto_garantia         = pg_fetch_result($res,0,'garantia');
                        $produto_nome             = pg_fetch_result($res,0,'produto_nome');
                        $voltagem                 = pg_fetch_result($res,0,'voltagem');
                        $serie                    = pg_fetch_result($res,0,'serie');
                        $data_nf                  = pg_fetch_result($res,0,'data_nf');
                        $marca                    = pg_fetch_result($res,0,'marca');
                        $data_nf_anterior         = $data_nf;
                        $data_ag                  = pg_fetch_result($res,0,'data_ag');
                        $data_providencia                  = pg_fetch_result($res,0,'data_prov');
                        $prazo_limite             = pg_fetch_result($res,0,'prazo_limite');
                        // $data_de_retorno          = pg_fetch_result($res,0,'data_providencia');
                        $ck_data_de_retorno = pg_fetch_result($res,0,'esta_agendado');
                        $nota_fiscal              = pg_fetch_result($res,0,'nota_fiscal');
                        $revenda                  = pg_fetch_result($res,0,'revenda');
                        $revenda_nome             = pg_fetch_result($res,0,'revenda_nome');
                        $revenda_cnpj             = pg_fetch_result($res,0,'revenda_cnpj');
                        $ordem_montagem       = pg_fetch_result($res,0,'ordem_montagem');
                        $valor_nf         = number_format(pg_fetch_result($res,0,'valor_nf'),2,',','.');
                        $tipo_postagem        = pg_fetch_result($res,0,'tipo_postagem');
                        $sedex_pac        = pg_fetch_result($res,0,'servico_correio');
                        $codigo_postagem          = pg_fetch_result($res,0,'codigo_postagem');
                        $consumidor_final_nome      = pg_fetch_result($res,0,'consumidor_final_nome');
                        $posto                    = pg_fetch_result($res,0,'posto');
                        //$posto_tab                    = pg_fetch_result($res,0,'posto');
                        $posto_nome               = pg_fetch_result($res,0,'posto_nome');
                        $defeito_reclamado        = pg_fetch_result($res,0,'defeito_reclamado');
                        $defeito_reclamado_banco  = $defeito_reclamado;
                        $reclamado                = pg_fetch_result($res,0,'reclamado');

                        $status_interacao         = pg_fetch_result($res,0,'status');
                        $atendente                = pg_fetch_result($res,0,'atendente');
                        $receber_informacoes      = pg_fetch_result($res,0,'receber_info_fabrica');
                        $codigo_posto             = pg_fetch_result($res,0,'codigo_posto');
                        $posto_contato_endereco   = pg_fetch_result($res,0,'contato_endereco');
                        $posto_contato_numero     = pg_fetch_result($res,0,'contato_numero');
                        $posto_contato_bairro     = pg_fetch_result($res,0,'contato_bairro');
                        $posto_contato_cidade     = pg_fetch_result($res,0,'contato_cidade');
                        $posto_contato_estado     = pg_fetch_result($res,0,'contato_estado');
                        $linha                    = pg_fetch_result($res,0,'linha');
                        $abre_os                  = pg_fetch_result($res,0,'abre_os');
                        $leitura_pendente         = pg_fetch_result($res,0,'leitura_pendente');
                        $atendente_pendente       = pg_fetch_result($res,0,'atendente_pendente');
                        $categoria                = pg_fetch_result($res,0,'categoria');
                        $hd_extra_defeito         = pg_fetch_result($res,0,'hd_extra_defeito');
                        $numero_processo          = pg_fetch_result($res,0,'numero_processo');
                        $tipo_registro            = pg_fetch_result($res,0,'tipo_registro');
                        $admin_abriu              = pg_fetch_result($res,0,'admin_abriu');
                        $familia                  = pg_fetch_result($res,0,'familia');
                        $admin_login              = pg_fetch_result($res,0,'admin_login');
                        $admin_nome_completo      = pg_fetch_result($res,0,'admin_nome_completo');
                        $cliente_admin            = pg_fetch_result($res,0,'cliente_admin');
                        $cliente_nome_admin       = pg_fetch_result($res,0,'nome_cliente_admin');
                        $posto_km_tab             = pg_fetch_result($res,0,'qtde_km');
                        $posto_email_tab          = pg_fetch_result($res,0,'posto_email');
                        $posto_fone_tab           = pg_fetch_result($res,0,'posto_fone');
                        if(empty($consumidor_final_nome)) $consumidor_final_nome = pg_fetch_result($res,0,'obs_postagem');
                        if($login_fabrica == 30){
                            $posto_fone1_tab          = pg_fetch_result($res,0,'telefone2');
                            $posto_fone2_tab          = pg_fetch_result($res,0,'telefone3');
                        }

                        $cnpj_revenda             = pg_fetch_result($res,0,'revenda_cnpj');
                        $atendimento_callcenter   = pg_fetch_result($res,0,'atendimento_callcenter');
                        $hora_ligacao             = pg_fetch_result($res,0,'hora_ligacao');
                        $protocolo_cliente        = pg_fetch_result($res,0,'protocolo_cliente');
                        $contato_nome             = pg_fetch_result($res,0,'contato_nome');
                        $hd_motivo_ligacao        = pg_fetch_result($res,0,'hd_motivo_ligacao');
                        $situacao_interacao       = pg_fetch_result($res,0,'hd_situacao');
                        $garantia_produto         = pg_fetch_result($res,0,'garantia_produto');
                        $array_campos_adicionais  = pg_fetch_result($res,0,'array_campos_adicionais');
                        $consumidor_nascimento    = pg_fetch_result($res,0,'data_nascimento');
                        $hd_classificacao         = pg_fetch_result($res,0,'hd_classificacao');
                        $analise                  = pg_fetch_result($res,0,'analise');
                        $filial_id                = pg_fetch_result($res,0,'filial_id');
                        $id_tipo_atendimento      = pg_fetch_result($res,0,'id_tipo_atendimento');
                        $tipo_protocolo           = pg_fetch_result($res,0,'hd_tipo_chamado');

                        if ($login_fabrica == 183){
                            $id_zendesk = pg_fetch_result($res, 0, 'id_zendesk');
                        }

                        if(in_array($login_fabrica, array(169,170))){
                            $id_hd_motivo_ligacao = $hd_motivo_ligacao;
                            $categoria_anterior = pg_fetch_result($res, 0, 'categoria');
                        }

                        if ($login_fabrica == 174 && !empty($produto))
                        {
                            $sql_laudo = "SELECT troca_obrigatoria
                                FROM tbl_produto
                                WHERE produto = $produto";
                            $res_laudo = pg_query($con,$sql_laudo);
                            $msg_erro .= pg_errormessage($con);

                            if (pg_num_rows($res_laudo) > 0)
                            {

                                $mostra_laudo = '';
                                $retorno = pg_fetch_array($res_laudo);
                                if ($retorno['troca_obrigatoria'] == 't')
                                {
                                    $mostra_laudo = "<input type='checkbox' name='emitir_laudo' id='emitir_laudo' value='t' /> <labeL>Emitir laudo de troca de produto para o consumidor</label>";
                                }
                            }
                        }

                        if($login_fabrica == 30){

                            if($hd_classificacao == 47){

                                $os_revenda       = $numero_processo;
                                $orientacao_posto = $analise;

                                $numero_processo  = "";
                                $analise          = "";

                            }else{

                                $numero_processo  = "";
                                $analise          = "";

                            }

                        }

                        if(in_array($login_fabrica, array(169,170,171)) AND strlen(trim($linha)) > 0){
                            $sql_linha = "SELECT deslocamento FROM tbl_linha WHERE fabrica = {$login_fabrica} AND linha = $linha";
                            $res_linha = pg_query($con, $sql_linha);
                            if(pg_num_rows($res_linha) > 0){
                                $produto_deslocamento = pg_fetch_result($res_linha, 0, 'deslocamento');
                            }

                            $parametros_adicionais = json_decode(pg_fetch_result($res, 0, "produto_parametros_adicionais"), true);
                            $garantia_estendida_tempo = $parametros_adicionais["garantia_estendida"];
                        }

                        $consumidor_cidade = str_replace("(", "", $consumidor_cidade);
                        $consumidor_cidade = str_replace(")", "", $consumidor_cidade);
                        $consumidor_cidade = strtoupper($consumidor_cidade);

                       if($login_fabrica == 189){
                            $array_campos_adicionais = json_decode($array_campos_adicionais, true);
                            $analise_reclamacao = $array_campos_adicionais['analise_reclamacao'];
                            $nome_representante = $array_campos_adicionais['nome_representante'];
                            $envia_email_representante = $array_campos_adicionais['envia_email_representante'];
                            $celular_representante = $array_campos_adicionais['celular_representante'];
                            $tipo_cliente = $array_campos_adicionais['tipo_cliente'];
                            $tipo_posto = $array_campos_adicionais['tipo_posto'];
            			    $nome_empresa = $array_campos_adicionais['nome_empresa'];
            			    $nome_empresa = mb_detect_encoding($nome_empresa, 'UTF-8', true) ? utf8_decode($nome_empresa) : $nome_empresa;
                            $manual_nome_repre = $array_campos_adicionais['manual_nome_repre'];
                            $manual_email_repre = $array_campos_adicionais['manual_email_repre'];
                            $manual_cod_transp = $array_campos_adicionais['manual_cod_transp'];
                            $manual_nome_transp = $array_campos_adicionais['manual_nome_transp'];
                            $manual_contato_transp = $array_campos_adicionais['manual_contato_transp'];
                            $manual_fone_transp = $array_campos_adicionais['manual_fone_transp'];
                            $manual_end_transp = $array_campos_adicionais['manual_end_transp'];
                            $manual_cod_transp_redespacho = $array_campos_adicionais['manual_cod_transp_redespacho'];
                            $manual_nome_transp_redespacho = $array_campos_adicionais['manual_nome_transp_redespacho'];
                            $manual_contato_transp_redespacho = $array_campos_adicionais['manual_contato_transp_redespacho'];
                            $manual_fone_transp_redespacho = $array_campos_adicionais['manual_fone_transp_redespacho'];
                            $manual_end_transp_redespacho = $array_campos_adicionais['manual_end_transp_redespacho'];
                            $codigo_cliente_revenda = $array_campos_adicionais['codigo_cliente_revenda'];

                            $planta = $array_campos_adicionais['planta'];
                            $mercado_gerencia = $array_campos_adicionais['mercado_gerencia'];
                            $hd_subclassificacao = pg_fetch_result($res,0,'hd_subclassificacao');
                        }
                        if($login_fabrica == 156 && !empty($array_campos_adicionais)){

                            $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                            if(!empty($array_campos_adicionais["numero_controle"])){
                                $protocolo_cliente = $array_campos_adicionais["numero_controle"];
                            }

                            if(!empty($array_campos_adicionais["responsavel"])){
                                $responsavel = $array_campos_adicionais["responsavel"];
                            }

                            if(!empty($array_campos_adicionais["tel_responsavel"])){
                                $tel_responsavel = $array_campos_adicionais["tel_responsavel"];
                            }

                            if (array_key_exists("tipo_consumidor_revenda", $array_campos_adicionais)) {
                                $consumidor_revenda = $array_campos_adicionais["tipo_consumidor_revenda"];
                            }

                        }

                        if(in_array($login_fabrica, [184,200]) && !empty($array_campos_adicionais)) {

                            $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                            if (!isset($_POST['pedido_venda'])) {
                                $pedido_venda = $array_campos_adicionais['pedido_venda'];
                            }

                            if (!isset($_POST['nf_venda'])) {
                                $nf_venda     = $array_campos_adicionais['nf_venda'];
                            }

                        }

                        if(in_array($login_fabrica, [178]) && !empty($array_campos_adicionais)) {

                            $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                            if (!isset($_POST['resposta_consumidor'])) {
                                $resposta_consumidor = $array_campos_adicionais['resposta_consumidor'];
                            }

                        }

                        if($login_fabrica == 156){
                            $consumidor_revenda = $array_campos_adicionais["tipo_atendimento"];
                        }

                        if ($login_fabrica == 35) {

                            $cnpj_emitente_nf = $array_campos_adicionais["cnpj_emitente_nf"];
                            $valor_ressarcimento_reembolso = $array_campos_adicionais["valor_ressarcimento_reembolso"];

                        }

                        if ($login_fabrica == 171) {//hd-3624967 - fputti
                            if (array_key_exists("pressao_agua_mca", $array_campos_adicionais)) {
                                $pressao_agua_mca = $array_campos_adicionais["pressao_agua_mca"];
                            }

                            if (array_key_exists("projeto", $array_campos_adicionais)) {
                                $projeto          = $array_campos_adicionais["projeto"];
                            }
                            $tipo_atendimento_grohe = pg_fetch_result($res,0,tipo_atendimento);
                        }

                        if($login_fabrica == 156 && strlen($familia) == 0){

                            $sql_familia = "SELECT familia FROM tbl_produto WHERE produto = {$produto} AND fabrica_i = {$login_fabrica}";
                            $res_familia = pg_query($con, $sql_familia);

                            if(pg_num_rows($res_familia)){
                                $familia = pg_fetch_result($res_familia, 0, "familia");
                            }

                        }

                        $array_campos_adicionais = pg_escape_string($array_campos_adicionais);
                        $array_campos_adicionais = str_replace('\\\\u', '\\u', $array_campos_adicionais);
                        $array_campos_adicionais = array_map('utf8_decode',json_decode($array_campos_adicionais, TRUE));

                        if (in_array($login_fabrica, array(169, 170))) {
                            $instalador_nome = $array_campos_adicionais["instalador_nome"];
                            $instalador_id = $array_campos_adicionais["instalador_id"];
                        }
                        if($login_fabrica == 101){
                            $motivo_contato = $array_campos_adicionais["motivo_contato"];
                        }
                        if($login_fabrica == 30){
                            $data_limite = $array_campos_adicionais['data_limite'];
                            $obs_sac_adicionais = $array_campos_adicionais['observacao_sac'];
                            $obs_sac_adicionais = str_replace("<br>", "\n", $obs_sac_adicionais);
                            $obs_sac_adicionais = escape_sequence_decode($obs_sac_adicionais);
                        }

                        if (in_array($login_fabrica, array(141))) {
                            $obs_sac_adicionais = $array_campos_adicionais['observacao_sac'];
                            $obs_sac_adicionais = str_replace("<br>", "\n", $obs_sac_adicionais);
                        }

                        if(in_array($login_fabrica,array(52,169,170,186))){
                            $observacao_os      = pg_fetch_result($res,0,obs_callcenter);
                        }
                        if($login_fabrica == 85){
                            $reclamado_garantia_estendida = pg_fetch_result($res,0,'reclamado');
                        }

                        if(in_array($login_fabrica, [167, 203])){ //HD-3428316
                            $contador = $array_campos_adicionais["contador"];
                        }
                        if (strlen($revenda) > 0)  {
                            $sql_revenda = "SELECT nome, cnpj FROM tbl_revenda WHERE revenda = $revenda";
                            $res_revenda = pg_query($con, $sql_revenda);
                            if (pg_num_rows($res) > 0) {
                                $revenda_nome = (empty($revenda_nome)) ? pg_fetch_result($res_revenda, 0, "nome") : $revenda_nome;
                                $revenda_cnpj = (empty($revenda_cnpj)) ? pg_fetch_result($res_revenda, 0, "cnpj") : $revenda_cnpj;
                            }
                        }

                        if(in_array($login_fabrica, [186]) and empty($msg_erro)){
                            $obs_para_contato = $array_campos_adicionais["obs_para_contato"];
                            $assunto_fale_conosco = utf8_decode($array_campos_adicionais["assunto_fale_conosco"]);
                        }

                        if ($login_fabrica == 152 AND $equi_com == false ) {

                            if ($tipo_registro == 'Técnica Equipamento') {
                                $duvida_consumidor = "TE";
                            }elseif ($tipo_registro == 'Técnica Consumivel') {
                                $duvida_consumidor = "TC";
                            } elseif ($tipo_registro == 'Comercial') {
                                $duvida_consumidor = "C";
                            } elseif ($tipo_registro == 'Reclamacao' OR $tipo_registro == 'Reclamação') {
                                $duvida_consumidor = "R";
                            }

                            $equipamentoeconsumivel = $array_campos_adicionais["equipamentoeconsumivel"];
                            $tipo_atendimento_consumidor  = $array_campos_adicionais["tipo_atendimento_consumidor"];
                        }

                        if (in_array($login_fabrica, array(11,15,24,30,74,81,85,101,114,122,123,128)) || $login_fabrica >= 138 || $telecontrol_distrib) {
                            if ($login_fabrica == 156) {
                                if(!is_array($array_campos_adicionais))
                                    extract(array_map('utf8_decode', json_decode($array_campos_adicionais, true)), EXTR_OVERWRITE);
                            } else if ($login_fabrica == 74 && !empty($array_campos_adicionais)) {
                                //var_dump($array_campos_adicionais);
                                //$array_campos_adicionais = json_decode($array_campos_adicionais, true);

                                if(!empty($array_campos_adicionais["data_fabricacao"])){
                                    $dt_fabricacao          = $array_campos_adicionais["data_fabricacao"];
                                }
                                //echo $dt_fabricacao;exit;

                                if(!empty($array_campos_adicionais["data_visita_tecnico"])){
                                    $data_visita_tecnico          = $array_campos_adicionais["data_visita_tecnico"];
                                }

                                if(!empty($array_campos_adicionais["fone_revenda"])){
                                    $fone_revenda          = $array_campos_adicionais["fone_revenda"];
                                }

                                if(!empty($array_campos_adicionais["fone_revenda2"])){
                                    $fone_revenda2          = $array_campos_adicionais["fone_revenda2"];
                                }
                            }else if($login_fabrica <= 138){
                                if(!is_array($array_campos_adicionais))
                                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                                extract($array_campos_adicionais, EXTR_OVERWRITE);

                                if (strlen($ligacao_agendada) > 0) {
                                    list($dmsa, $dmsm, $dmsd) = explode("-", $ligacao_agendada);
                                    $ligacao_agendada = "{$dmsd}/{$dmsm}/{$dmsa}";
                                }
                                if ((strlen($data_retorno) > 0) AND ($login_fabrica == 15)) {
                                    list($dmsa, $dmsm, $dmsd) = explode("-", $data_retorno);
                                    $xdata_retorno = "{$dmsd}/{$dmsm}/{$dmsa}";
                                }

                            }else if($login_fabrica >= 138) {

                                $voltagem = empty($voltagem) ? $array_campos_adicionais['voltagem'] : $voltagem;

                                if($login_fabrica == 151){
                                    $abre_os_mondial           = $array_campos_adicionais['abre_os_mondial'];
                                }

                                if($login_fabrica == 160 or $replica_einhell){
                                    $versao           = $array_campos_adicionais['versao_produto'];
                                    $data_conciliacao = $array_campos_adicionais['data_conciliacao'];
                                    $data_julgamento  = $array_campos_adicionais['data_julgamento'];
                                }

                                if ($login_fabrica == 162) {

                                    $interno_aparencia  = $array_campos_adicionais['interno_aparencia'];
                                    $interno_acessorios = $array_campos_adicionais['interno_acessorios'];

                                    $pedido_cliente = $array_campos_adicionais['pedido_cliente'];

                                    $perfil_cliente = $array_campos_adicionais['perfil_cliente'];
                                    $acordo_realizado = $array_campos_adicionais['acordo_realizado'];
                                    $data_realizacao_acordo = $array_campos_adicionais['data_realizacao_acordo'];
                                    $tipo_acordo_realizado = $array_campos_adicionais['tipo_acordo_realizado'];

                                }

                                if ($login_fabrica == 165) {

                                    $indicacao_instalador_tecnico = $array_campos_adicionais['indicacao_instalador_tecnico'];
                                    $indicacao_instalador_comentario = $array_campos_adicionais['indicacao_instalador_comentario'];

                                }
                            }

                            if ($login_fabrica == 174) {
                                $pedido_info = $array_campos_adicionais['pedido_info'];
                                $hd_extra_data_entrega = $array_campos_adicionais['data_entrega'];
                            }

                        } else {
                            if (!$_POST) {
                                if(!is_array($array_campos_adicionais))
                                    $array_campos_adicionais = json_decode($array_campos_adicionais, true);

                                if ($login_fabrica == 81 or $telecontrol_distrib) {
                                    $array_campos_adicionais["descricao_analise"] = utf8_decode($array_campos_adicionais["descricao_analise"]);
                                }

                                if (is_array($array_campos_adicionais) && count($array_campos_adicionais) > 0) {
                                    foreach($array_campos_adicionais as $key => $value){
                                        $$key = $value;
                                    }
                                }
                            }
                        }

                        //HD 205933: Habilitar abertura de ORDEM DE SERVIÃO para a Esmaltec
                        if ($os && in_array($login_fabrica, array(30,50,178,190))) {
                            $abre_ordem_servico = 't';
                            $sqlBuscaOs = "SELECT  tbl_os.observacao FROM tbl_os JOIN tbl_hd_chamado_extra USING(os) WHERE os = $os";
                            $resBuscaOs         = pg_query($con,$sqlBuscaOs);

                            $observacao_os      = pg_fetch_result($resBuscaOs,0,observacao);
                        } else {
                            $abre_ordem_servico = 'f';
                        }

                        if (is_numeric($consumidor_cpf)) {
                            $mask = (strlen($consumidor_cpf) == 14) ? '/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/':'/(\d{3})(\d{3})(\d{3})(\d{2})/';
                            $fmt  = (strlen($consumidor_cpf) == 14) ? '$1.$2.$3/$4-$5':'$1.$2.$3-$4';
                            $consumidor_cpf = preg_replace($mask, $fmt, $consumidor_cpf);
                        }

                        if ($fab_nova_filial) {
                            if (!empty($data_prov)) {
                                $data_providencia = is_date($prazo_limite, 'ISO', 'EUR');
                            }

                            if (!empty($filial_id)) {
                                $encaminha_filial = true;
                                $filial = pg_fetch_assoc(
                                        pg_query(
                                            $con,
                                            "SELECT tbl_filial.nome AS razao_social, fantasia, telefone AS fone,
                                            tbl_filial.*, tbl_cidade.nome
                                            FROM tbl_filial
                                            JOIN tbl_cidade USING(cidade)
                                            WHERE filial = $filial_id"
                                            ), 0
                                        );
                            }
                        }
                        if ($login_fabrica == 51 and $leitura_pendente == "t"){
                            if ($atendente_pendente == $login_admin){
                                $sql = "UPDATE tbl_hd_chamado_extra set leitura_pendente = null
                                    WHERE hd_chamado = $callcenter  ";
                                $res = pg_query($con,$sql);
                                $msg_erro .= pg_errormessage($con);
                            }
                        }
                        if (strlen($codigo_posto) > 0 && empty($_POST['codigo_posto_tab']) ) {
                            $procon_codigo_posto = $codigo_posto;
                            $procon_posto_nome   = $posto_nome;
                            $codigo_posto_tab    = $codigo_posto;
                            $posto_nome_tab      = $posto_nome;
                        }

                        $sql ="SELECT   tbl_hd_chamado_troca.valor_corrigido   ,
                            tbl_hd_chamado_troca.hd_chamado        ,
                            to_char(tbl_hd_chamado_troca.data_pagamento,'DD/MM/YYYY') as data_pagamento,
                            tbl_hd_chamado_troca.ressarcimento     ,
                            tbl_hd_chamado_troca.numero_objeto     ,
                            tbl_hd_chamado_troca.nota_fiscal_saida ,
                            TO_CHAR(tbl_hd_chamado_troca.data_nf_saida,'DD/MM/YYYY')        AS data_nf_saida,
                            TO_CHAR(tbl_hd_chamado_troca.data_retorno_produto,'DD/MM/YYYY') AS data_retorno_produto,
                            tbl_hd_chamado_troca.valor_produto     ,
                            tbl_hd_chamado_troca.valor_inpc        ,
                            tbl_hd_chamado_troca.valor_corrigido   ,
                            tbl_produto.referencia                 AS troca_produto_referencia,
                            tbl_produto.referencia                 AS troca_produto_descricao
                                FROM tbl_hd_chamado_troca
                                LEFT JOIN tbl_produto on tbl_produto.produto = tbl_hd_chamado_troca.produto
                                WHERE tbl_hd_chamado_troca.hd_chamado = $callcenter";

                        $res = pg_query($con, $sql);

                        if (pg_num_rows($res) > 0) {

                            $atendimento_com_troca = "t";
                            $valor_corrigido          = pg_fetch_result($res, 0, 'valor_corrigido');
                            $hd_chamado               = pg_fetch_result($res, 0, 'hd_chamado');
                            $data_pagamento           = pg_fetch_result($res, 0, 'data_pagamento');
                            $ressarcimento            = pg_fetch_result($res, 0, 'ressarcimento');
                            $numero_objeto            = pg_fetch_result($res, 0, 'numero_objeto');
                            $nota_fiscal_saida        = pg_fetch_result($res, 0, 'nota_fiscal_saida');
                            $nota_fiscal_saida        = pg_fetch_result($res, 0, 'nota_fiscal_saida');
                            $data_nf_saida            = pg_fetch_result($res, 0, 'data_nf_saida');
                            $data_retorno_produto     = pg_fetch_result($res, 0, 'data_retorno_produto');
                            $valor_produto            = pg_fetch_result($res, 0, 'valor_produto');
                            $valor_inpc               = pg_fetch_result($res, 0, 'valor_inpc');
                            $valor_corrigido          = pg_fetch_result($res, 0, 'valor_corrigido');
                            $troca_produto_referencia = pg_fetch_result($res, 0, 'troca_produto_referencia');
                            $troca_produto_descricao  = pg_fetch_result($res, 0, 'troca_produto_descricao');

                        }

                        if($login_fabrica == 52){

                            $sqlXX = "SELECT os FROM tbl_os JOIN tbl_os_extra USING(os) where tbl_os.hd_chamado = $callcenter and tbl_os.fabrica = $login_fabrica";
                            $resXX = pg_query($con,$sqlXX);
                            if(pg_num_rows($resXX) > 0 ){
                                $os_fricon = pg_fetch_result($resXX, 0, 'os');

                                $sql = "SELECT campos_adicionais FROM tbl_os_campo_extra WHERE os = '$os_fricon'";
                                $res = pg_query($con, $sql);
                                if(pg_num_rows($res) > 0){
                                    $campos_adicionais2 = pg_fetch_result($res, 0, 'campos_adicionais');
                                    $dados = json_decode($campos_adicionais2);
                                    $operadora_celular = $dados->operadora;
                                }else{
                                    $operadora_celular = "";
                                }
                            }
                        }

                        /* HD 37805 - Adicionei 59 - Arrumei esta parte de baixo*/
                        if ($login_fabrica == 59) {

                            $tipo_atendimento = array(  1 => 'reclamacao_produto',
                                    2 => 'reclamacao_empresa',
                                    3 => 'reclamacao_at',
                                    4 => 'duvida_produto',
                                    5 => 'sugestao',
                                    6 => 'onde_comprar',
                                    7 => 'ressarcimento',
                                    8 => 'sedex_reverso',);

                        } else if ($login_fabrica == 2) {

                            if ($natureza_chamado == 'aquisicao_mat' or $natureza_chamado == 'aquisicao_prod' or $natureza_chamado == 'indicacao_posto' or $natureza_chamado == 'solicitacao_manual') {

                                $natureza_chamado2 = $natureza_chamado;
                                $natureza_chamado = "reclamacao_produto";

                            }

                            if ($natureza_chamado == 'reclamacao_revenda' or $natureza_chamado == 'reclamacao_at' or $natureza_chamado == 'reclamacao_enderecos') {
                                $natureza_chamado2 = $natureza_chamado;
                                $natureza_chamado = "reclamacoes";
                            }

                            $tipo_atendimento = array(  1 => 'reclamacao_produto',
                                    2 => 'reclamacoes',
                                    3 => 'duvida_produto',
                                    4 => 'sugestao',
                                    5 => 'procon' ,
                                    6 => 'onde_comprar');
                        } else if ($login_fabrica == 11 or $login_fabrica == 172) {

                            $sub_tipo_reclamacao = array("mau_atendimento","posto_nao_contribui","demonstra_desorg","possui_bom_atend","demonstra_org","reclamacao_at_info");
                            if (in_array($natureza_chamado, $sub_tipo_reclamacao) or $natureza_chamado == 'reclamacao_at') {
                                $natureza_chamado2 = $natureza_chamado;
                                $natureza_chamado = "reclamacao_at";
                            }

                            $sub_reclamacao_procon = array("pr_reclamacao_at","pr_info_at","pr_mau_atend","pr_posto_n_contrib","pr_demonstra_desorg","pr_bom_atend","pr_demonstra_org");

                            if ($natureza_chamado == 'procon' or in_array($natureza_chamado, $sub_reclamacao_procon)) {
                                $natureza_chamado2 = $natureza_chamado;
                                $natureza_chamado  = "procon";
                            }

                            $tipo_atendimento = array(
                                    1 => 'reclamacao_produto',
                                    2 => 'reclamacao_empresa',
                                    3 => 'reclamacao_at',
                                    4 => 'duvida_produto',
                                    5 => 'sugestao',
                                    6 => 'procon' ,
                                    7 => 'onde_comprar');

                        } else if ($login_fabrica == 1) {

                            $hd_posto = array("digitacao_fechamento_de_os","utilizacao_do_site","falha_no_site","pendencias_de_pecas","pedido_de_pecas","duvida_tecnica_sobre_produto","outros");
                            if (in_array($natureza_chamado, $hd_posto)) {
                                $natureza_chamado = "hd_posto";
                            }

                            $tipo_atendimento = array(  1 => 'extensao',
                                    2 => 'reclamacao_produto',
                                    3 => 'reclamacao_empresa',
                                    4 => 'reclamacao_at',
                                    5 => 'duvida_produto',
                                    6 => 'sugestao',
                                    7 => 'assistencia',
                                    8 => 'garantia',
                                    9 => 'troca_produto',
                                    10 => 'procon' ,
                                    11 => 'onde_comprar',
                                    12 => 'hd_posto');
                        } else if($login_fabrica == 94){
                            $tipo_atendimento = array(  1 => 'reclamacao_produto',
                                    2 => 'reclamacao_empresa',
                                    3 => 'reclamacao_at',
                                    4 => 'duvida_produto',
                                    5 => 'sugestao',
                                    6 => 'procon',
                                    7 => 'onde_comprar',
                                    8 => 'indicacao_rev',
                                    9 => 'indicacao_at'
                                );
                        } else if($login_fabrica == 74){
                            $tipo_atendimento = array(  1 => 'extensao',
                                    2 => 'reclamacao_produto',
                                    3 => 'reclamacao_empresa',
                                    4 => 'reclamacao_at',
                                    5 => 'duvida_produto',
                                    6 => 'sugestao',
                                    7 => 'procon' ,
                                    8 => 'onde_comprar',
                                    9 => 'informacoes',
                                    10 => 'garantia_adicional');

                        }else if(in_array($login_fabrica, array(169,170))){
                            $tipo_atendimento = array(
                                    1 => 'extensao',
                                    2 => 'reclamacao_produto',
                                    3 => 'reclamacao_empresa',
                                    4 => 'reclamacao_at',
                                    5 => 'duvida_produto',
                                    6 => 'sugestao',
                                    7 => 'onde_comprar',
                                    8 => 'indicacao_at',
                                    9 => 'informacao');
                        }else{

                            $tipo_atendimento = array(  1 => 'extensao',
                                    2 => 'reclamacao_produto',
                                    3 => 'reclamacao_empresa',
                                    4 => 'reclamacao_at',
                                    5 => 'duvida_produto',
                                    6 => 'sugestao',
                                    7 => 'assistencia',
                                    8 => 'garantia',
                                    9 => 'troca_produto',
                                    10 => 'procon' ,
                                    11 => 'onde_comprar',
                                    12 => 'ressarcimento',
                                    13 => 'outros_assuntos');

                        }

                        $posicao = array_search($natureza_chamado, $tipo_atendimento); // $key = 2;
                        if ($imprimir_os == 't' AND strlen ($os) > 0 ) {
                            echo "<script language='javascript'>";
                            echo "window.open ('os_print.php?os=$os&qtde_etiquetas=$qtde_etiquetas','os_print','resizable=yes,resize=yes,toolbar=no,location=yes,status=no,scrollbars=yes,directories=no,width=500,height=400,top=18,left=0')";
                            echo "</script>";

                        }

                    }else{
                        $msg_erro = "Atendimento não encontrado";
                    }

                    if($assunto == 'Indicação de Posto' and ($login_fabrica == 5 or $login_fabrica == 24)) {
                        $indicacao_posto = 't';
                    }

                }


                $Id = $_GET['Id'];

                if (strlen($Id) > 0) {

                    $sql = "SELECT  tbl_hd_chamado_extra.hd_chamado as callcenter,
                        TO_CHAR(tbl_hd_chamado_extra.data_abertura,'DD/MM/YYYY') as abertura_callcenter,
                        tbl_hd_chamado_extra.nome,
                        tbl_hd_chamado_extra.endereco ,
                        tbl_hd_chamado_extra.numero ,
                        tbl_hd_chamado_extra.complemento ,
                        tbl_hd_chamado_extra.bairro ,
                        tbl_hd_chamado_extra.cep ,
                        tbl_hd_chamado_extra.fone ,
                        tbl_hd_chamado_extra.fone2 ,
                        tbl_hd_chamado_extra.celular ,
                        tbl_hd_chamado_extra.email ,
                        tbl_hd_chamado_extra.cpf ,
                        tbl_hd_chamado_extra.rg ,
                        tbl_hd_chamado_extra.cliente ,
                        tbl_hd_chamado_extra.ordem_montagem,
                        tbl_hd_chamado_extra.codigo_postagem,
                        tbl_hd_chamado_extra.consumidor_final_nome,
                        tbl_hd_chamado_extra.revenda ,
                        tbl_hd_chamado_extra.revenda_nome,
                        tbl_hd_chamado_extra.revenda_cnpj,
                        tbl_hd_chamado_extra.origem,
                        tbl_hd_chamado_extra.consumidor_revenda,
                        tbl_hd_chamado_extra.hora_ligacao ,
                        tbl_cidade.nome as cidade_nome,
                        tbl_cidade.estado,
                        tbl_cidade.estado_exterior,
                        tbl_produto.produto,
                        tbl_produto.linha,
                        tbl_produto.referencia as produto_referencia,
                        tbl_produto.descricao as produto_nome,
                        tbl_produto.voltagem,
                        tbl_hd_chamado_extra.serie,
                        to_char(tbl_hd_chamado_extra.data_nf,'DD/MM/YYYY') as data_nf,
                        tbl_hd_chamado_extra.marca,
                        to_char(tbl_hd_chamado.data_providencia,'DD/MM/YYYY') as data_prov,
                        tbl_hd_chamado_extra.nota_fiscal,
                        tbl_hd_chamado_extra.abre_os,
                        tbl_hd_chamado_extra.leitura_pendente,
                        tbl_hd_chamado.atendente as atendente_pendente,
                        tbl_hd_chamado_extra.defeito_reclamado_descricao as hd_extra_defeito,
                        tbl_hd_chamado_extra.tipo_registro ,
                        tbl_admin.login            AS admin_login ,
                        tbl_admin.nome_completo    AS admin_nome_completo,
                        tbl_cliente_admin.nome     as nome_cliente_admin,
                        tbl_cliente_admin.cliente_admin,
                        tbl_hd_chamado_extra.os,
                        tbl_hd_chamado.hd_classificacao,
                        tbl_hd_chamado.hd_tipo_chamado
                            FROM      tbl_hd_chamado
                            JOIN      tbl_hd_chamado_extra on tbl_hd_chamado.hd_chamado = tbl_hd_chamado_extra.hd_chamado
                            LEFT JOIN tbl_cidade on tbl_hd_chamado_extra.cidade = tbl_cidade.cidade
                            LEFT JOIN tbl_cliente_admin ON tbl_cliente_admin.cliente_admin = tbl_hd_chamado.cliente_admin
                            LEFT JOIN tbl_produto on tbl_produto.produto = tbl_hd_chamado_extra.produto
                            LEFT JOIN tbl_admin ON tbl_hd_chamado.admin = tbl_admin.admin
                            WHERE tbl_hd_chamado.hd_chamado = $Id";
                    $res = pg_query($con,$sql);

                    if (pg_num_rows($res) > 0) {

                        $consumidor_nome        = pg_fetch_result($res, 0, 'nome');
                        $cliente                = pg_fetch_result($res, 0, 'cliente');
                        $consumidor_cpf         = pg_fetch_result($res, 0, 'cpf');
                        $consumidor_rg          = pg_fetch_result($res, 0, 'rg');
                        $consumidor_email       = pg_fetch_result($res, 0, 'email');
                        $consumidor_fone        = pg_fetch_result($res, 0, 'fone');
                        $consumidor_fone2       = pg_fetch_result($res, 0, 'fone2');
                        $consumidor_fone3       = pg_fetch_result($res, 0, 'celular');
                        $consumidor_cep         = pg_fetch_result($res, 0, 'cep');
                        $consumidor_endereco    = pg_fetch_result($res, 0, 'endereco');
                        $consumidor_numero      = pg_fetch_result($res, 0, 'numero');
                        $consumidor_complemento = pg_fetch_result($res, 0, 'complemento');
                        $consumidor_bairro      = pg_fetch_result($res, 0, 'bairro');
                        $consumidor_cidade      = pg_fetch_result($res, 0, 'cidade_nome');
                        $consumidor_estado      = pg_fetch_result($res, 0, 'estado');
                        $estado_exterior        = pg_fetch_result($res, 0, 'estado_exterior');
                        $produto                = pg_fetch_result($res, 0, 'produto');
                        $produto_referencia     = pg_fetch_result($res, 0, 'produto_referencia');
                        $produto_nome           = pg_fetch_result($res, 0, 'produto_nome');
                        $voltagem               = pg_fetch_result($res, 0, 'voltagem');
                        $serie                  = pg_fetch_result($res, 0, 'serie');
                        $data_nf                = pg_fetch_result($res, 0, 'data_nf');
                        $marca                  = pg_fetch_result($res, 0, 'marca');
                        $data_prov                = pg_fetch_result($res, 0, 'data_prov');
                        $nota_fiscal            = pg_fetch_result($res, 0, 'nota_fiscal');
                        $revenda                = pg_fetch_result($res, 0, 'revenda');
                        $nome_revenda           = pg_fetch_result($res, 0, "revenda_nome");
                        $cnpj_revenda           = pg_fetch_result($res, 0, "revenda_cnpj");
                        $abre_os                = pg_fetch_result($res, 0, 'abre_os');
                        $leitura_pendente       = pg_fetch_result($res, 0, 'leitura_pendente');
                        $atendente_pendente     = pg_fetch_result($res, 0, 'atendente_pendente');
                        $hd_extra_defeito       = pg_fetch_result($res, 0, 'hd_extra_defeito');
                        $tipo_registro          = pg_fetch_result($res, 0, 'tipo_registro');
                        $admin_login            = pg_fetch_result($res, 0, 'admin_login');
                        $admin_nome_completo    = pg_fetch_result($res, 0, 'admin_nome_completo');
                        $cliente_admin          = pg_fetch_result($res, 0, 'cliente_admin');
                        $cliente_nome_admin     = pg_fetch_result($res, 0, 'nome_cliente_admin');
                        $hora_ligacao           = pg_fetch_result($res, 0, 'hora_ligacao');
                        $consumidor_revenda     = pg_fetch_result($res, 0, 'consumidor_revenda');
                        $tipo_protocolo         = pg_fetch_result($res, 0, 'hd_tipo_chamado');

                        if(!in_array($login_fabrica, array(169,170))){
                            $hd_classificacao       = pg_fetch_result($res, 0, 'hd_classificacao');
                        }
                        $origem                 = pg_fetch_result($res, 0, 'origem');

                        if (is_numeric($consumidor_cpf)) {
                            $mask = (strlen($consumidor_cpf) == 14) ? '/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/':'/(\d{3})(\d{3})(\d{3})(\d{2})/';
                            $fmt  = (strlen($consumidor_cpf) == 14) ? '$1.$2.$3/$4-$5':'$1.$2.$3-$4';
                            $consumidor_cpf = preg_replace($mask, $fmt, $consumidor_cpf);
                        }

                        if ($login_fabrica == 51 and $leitura_pendente == "t") {

                            if ($atendente_pendente == $login_admin) {

                                $sql = "UPDATE tbl_hd_chamado_extra set leitura_pendente = null WHERE hd_chamado = $Id";
                                $res = pg_query($con, $sql);
                                $msg_erro .= pg_errormessage($con);

                            }

                        }

                        //HD 205933: Habilitar abertura de ORDEM DE SERVIÃO para a Esmaltec
                        $abre_ordem_servico = pg_result($res, 0, 'os');
                        if ($abre_ordem_servico) {
                            $abre_ordem_servico = 't';
                        } else {
                            $abre_ordem_servico = 'f';
                        }


                    }

                }

                if ($login_fabrica == 74 and !empty($callcenter) and is_int($callcenter)) {
                    $sql_status_interacao = "SELECT status
                        FROM tbl_hd_chamado
                        WHERE hd_chamado = {$callcenter}
                    AND fabrica = {$login_fabrica}";
                    $res_status_interacao = pg_query($con, $sql_status_interacao);

                    $hd_chamado_status = pg_fetch_result($res_status_interacao, 0, "status");
                }

                if ($login_fabrica == 24) {//HD 235203: Colocar vários assuntos para a Suggar

                    if (strlen($tab_atual) == 0) {

                        foreach ($assuntos as $categoria_assunto => $itens_categoria_assunto) {

                            foreach ($itens_categoria_assunto as $label_assunto => $bd_assunto) {

                                if ($bd_assunto == $categoria) {

                                    $callcenter_assunto = $categoria;

                                    switch ($categoria_assunto) {

                                        case "PRODUTOS":
                                            $natureza_chamado = "reclamacao_produto";
                                            break;

                                        case "MANUAL":
                                            $natureza_chamado = "reclamacao_produto";
                                            break;

                                        case "EMPRESA":
                                            $natureza_chamado = "reclamacao_empresa";
                                            break;

                                        case "ASSISTÃNCIA TÃCNICA":
                                            $natureza_chamado = "reclamacao_at";
                                            break;

                                        case "REVENDA":
                                            $natureza_chamado = "onde_comprar";
                                            break;

                                    }

                                }

                            }

                        }

                    } else {

                        $natureza_chamado = $tab_atual;

                    }

                    $tipo_atendimento = array(  1 => 'extensao',
                            2 => 'reclamacao_produto',
                            3 => 'reclamacao_empresa',
                            4 => 'reclamacao_at',
                            5 => 'duvida_produto',
                            6 => 'sugestao',
                            7 => 'assistencia',
                            8 => 'garantia',
                            9 => 'troca_produto',
                            10 => 'procon' ,
                            11 => 'onde_comprar',
                            12 => 'ressarcimento',
                            13 => 'outros_assuntos');

                    $posicao = array_search($natureza_chamado, $tipo_atendimento); // $key = 2;

                    if (!$posicao) {
                        $posicao = 2;
                    }

                }

                if (strlen($_GET['Id']) > 0) {//HD 94971
                    $id_x = $_GET['Id'];
                } else {
                    $id_x = "";
                }

        $bloqueia_atendimento_atendente = false;

        if (in_array($login_fabrica, array(151,169,170))) {
            $bloqueia_atendimento_atendente = true;
        }

        if (in_array($login_fabrica, array(169,170)) && $login_callcenter_supervisor == "t") {
            $bloqueia_atendimento_atendente = false;
        }

                if ($bloqueia_atendimento_atendente === true) {
                    $redirectChamados = false;
                    if (strlen($callcenter) == 0) {
                        $sqlVerAdminAtendi = "SELECT * FROM tbl_atendimento WHERE atendente = {$login_admin} AND fabrica = {$login_fabrica};";
                        $resVerAdminAtendi = pg_query($con, $sqlVerAdminAtendi);

                        $adminAtendi = pg_fetch_all($resVerAdminAtendi);
                        if ($adminAtendi != false) {
                            $updateAdminAtendi = "UPDATE tbl_atendimento SET hd_chamado = NULL WHERE atendente = {$login_admin} AND fabrica = {$login_fabrica};";
                            $resUpAdminAtendi = pg_query($con, $updateAdminAtendi);

                            if (strlen(pg_last_error()) > 0) {
                                $msg_erro = "Ocorreu um erro de comunicação com o banco de dados (Atendimento 2)!";
                            }
                        } else {
                            $insertAdminAtendi = "INSERT INTO tbl_atendimento (atendente, fabrica) VALUES ({$login_admin}, {$login_fabrica});";
                            $resInsAdminAtendi = pg_query($con, $insertAdminAtendi);

                            if (strlen(pg_last_error()) > 0) {
                                $msg_erro = "Ocorreu um erro de comunicação com o banco de dados (Atendimento 1)!";
                            }
                        }
                    } else {
                        $sqlVerAdminAtendi = "SELECT * FROM tbl_atendimento WHERE hd_chamado = {$callcenter} AND fabrica = {$login_fabrica};";
                        $resVerAdminAtendi = pg_query($con, $sqlVerAdminAtendi);
                        
                        $adminAtendi = pg_fetch_all($resVerAdminAtendi);

                        $sqlVerAdminHD = "SELECT atendente FROM tbl_hd_chamado WHERE hd_chamado = {$callcenter} AND fabrica = {$login_fabrica};";
                        $resVerAdminHD = pg_query($con, $sqlVerAdminHD);
                        
                        if (pg_num_rows($resVerAdminHD) > 0) {
                            $adminHd = pg_fetch_result($resVerAdminHD, 0, 'atendente');
                        }


                        if ($adminAtendi != false) {
                            $atendentex = $adminAtendi[0]['atendente'];

                            $AdminAtivo = false;
                            $sqlAdminAtivo = "SELECT admin FROM tbl_admin WHERE fabrica = $login_fabrica AND ativo IS TRUE AND admin = $atendentex";
                            $resAdminAtivo = pg_query($con, $sqlAdminAtivo);
                            if (pg_num_rows($resAdminAtivo) > 0) {
                                $AdminAtivo = true;
                            }

                            $AdminAtivoHD = false;
                            $sqlAdminAtivo = "SELECT admin FROM tbl_admin WHERE fabrica = $login_fabrica AND ativo IS TRUE AND admin = $adminHd";
                            $resAdminAtivo = pg_query($con, $sqlAdminAtivo);
                            if (pg_num_rows($resAdminAtivo) > 0) {
                                $AdminAtivoHD = true;
                            }

                            if ( ($login_admin != $atendentex && $AdminAtivo)  && ($login_admin != $adminHd && $AdminAtivoHD) ) {
                                $sqlNomeAdmin = "SELECT nome_completo FROM tbl_admin WHERE admin = {$atendentex} AND fabrica = {$login_fabrica};";
                                $resNomeAdmin = pg_query($con, $sqlNomeAdmin);

                                $adminNome = pg_fetch_result($resNomeAdmin, 0, nome_completo);

                                $msg_erro = "Esse atendimento já está com o(a) Atendente: $adminNome, esta página será fechada!";
                                $redirectChamados = true;
                            }
                        } else {
                            $sqlVerAdminAtendi = "SELECT COUNT(*) FROM tbl_atendimento WHERE atendente = {$login_admin} AND fabrica = {$login_fabrica};";
                            $resVerAdminAtendi = pg_query($con, $sqlVerAdminAtendi);

                            $adminAtendiCadastrado = pg_fetch_result($resVerAdminAtendi, 0, 0);

                            if($adminAtendiCadastrado > 0 && !empty($callcenter)) {
                                $updateAdminAtendi = "UPDATE tbl_atendimento SET hd_chamado = {$callcenter} WHERE atendente = {$login_admin} AND fabrica = {$login_fabrica};";
                                $resUpAdminAtendi = pg_query($con, $updateAdminAtendi);

                                if (strlen(pg_last_error()) > 0) {
                                    $msg_erro = "Ocorreu um erro na gravação desse chamado para o(a) Atendente!";
                                    $redirectChamados = true;
                                }
                            } else {
                                $insertAdminAtendi = "INSERT INTO tbl_atendimento (atendente, hd_chamado, fabrica) VALUES ({$login_admin}, {$callcenter}, {$login_fabrica});";
                                $resInsAdminAtendi = pg_query($con, $insertAdminAtendi);

                                if (strlen(pg_last_error()) > 0) {
                                    $msg_erro = "Ocorreu um erro na gravação desse chamado para o(a) Atendente!";
                                }
                            }
                        }

                    }

                    if($redirectChamados) {
                        echo "<script>
                                    alert('".$msg_erro."');
                                    window.location.href = 'callcenter_interativo_new.php';
                              </script>";
                    }
                }

                include "cabecalho.php";
                ?>

                <br />

                <style>

                    .respondido {
                        font-size: 10px;
                        color: #4d4d4d;
                        font-family: arial;
                        border-right: #666666 1px double;
                        border-top: #666666 1px double;
                        border-left: #666666 1px double;
                        border-bottom: #666666 1px double;
                        background-color: #ffffff;
                    }

                    .inicio{
                        border:#485989 1px solid;
                        background-color: #e6eef7;
                        font-size:10px;
                        font-family:arial;
                        text-align:center;
                        margin: 0 auto;
                        width:200px;
                        padding-left: 2px;
                        padding-right: 2px;
                        padding-top: 2px;
                        padding-bottom: 2px;
                    }

                    .tab_content{
                        border:#485989 1px solid;
                        font-size:10px;
                        font-family:arial;
                        margin: 0 auto;
                        float:center;
                        /*  width:680px;*/
                        padding-left: 2px;
                        padding-right: 2px;
                        padding-top: 2px;
                        padding-bottom: 2px;
                    }

                    .padding {
                        padding-left: 150px;
                    }


                    .box {
                        border-width: 1px;
                        border-style: solid;
                    }
                    .box {
                        display: block;
                        margin: 0 auto;
                        width: 100%;
                    }
                    .azul {
                        border-color: #1937D9;
                        background-color: #D9E2EF;
                    }
                    .label {
                        width: 20%;
                    }
                    .border{
                        text-align:left;
                        font-weight:bold;
                    }
                    .dados {
                        text-align:left;
                    }
                    body {
                        text-align: left!important;
                    }

                    table.tabela tr td{
                        font-family: arial;
                        font-size: 11px;
                        border-collapse: collapse;
                    }

                    table.tabela tr{
                        background-color: #FFFFFF;
                    }

                    table.tabela tr:nth-child(2n+1) {
                        background-color: #E4E9FF;
                    }


                    .titulo_tabela{
                        background-color:#596d9b !important;
                        font: bold 11px "Arial";
                        color:#FFFFFF;
                        text-align:center;
                    }

                    .hd_motivo_ligacao{
                        display: none;
                    }
                        /* .oculto {display: none} */
                    .msn_success{
                        font-size: 10px;
                        color: green;
                        display: inline;
                        background-color: #c4ffc1;
                        padding: 5px;
                    }
                    .msn_error{
                        font-size: 10px;
                        color: #d90000;
                        display: inline;
                        background-color: #ffd6d6;
                        padding: 5px;
                    }
                    .titulo_relacionar_os{
                        font-size: 14px;
                    }
                    .asteristico{
                        color: #B94A48;
                        font-size: 13px;
                        margin-right: 2px;
                        margin-left: -7px;
                    }
                </style>

                <!--=============== <FUNES> ================================!-->
                <script src="js/jquery-1.8.3.min.js"></script>
                <? include "javascript_pesquisas.php" ?>
                <script language='javascript' src='ajax.js'></script>
                <script language='javascript' src='js/bibliotecaAJAX.js'></script>
                <script language='javascript' src='ajax_cep.js'></script>

                <script type='text/javascript' src='../inc_soMAYSsemAcento.js'></script>
                <script type='text/javascript' src='js/assist.js'></script>
                <script type='text/javascript' src='js/jquery.autocomplete.js'></script>
                <link rel="stylesheet" type="text/css" href="js/jquery.autocomplete.css" />
                <script type='text/javascript' src='js/jquery.bgiframe.min.js'></script>
                <script type='text/javascript' src='js/dimensions.js'></script>
                <script type="text/javascript" src="../plugins/jquery/datepick/jquery.datepick.js"></script>
                <script type="text/javascript" src="../plugins/jquery/datepick/jquery.datepick-pt-BR.js"></script>
                <link type="text/css" href="../plugins/jquery/datepick/telecontrol.datepick.css" rel="stylesheet" />

                <script src="js/jquery.tabs.pack.js" type="text/javascript"></script>
                <script type="text/javascript" src="js/jquery.alphanumeric.js"></script>
                <script type="text/javascript" src="js/jquery.blockUI_2.39.js"></script>
                <script type="text/javascript" src="js/plugin_verifica_servidor.js"></script>
                <script type="text/javascript" src="js/jquery.mask.js"></script>
                <script type="text/javascript" src="js/jquery.maskMoney.min.js"></script>
                <script src="../plugins/ckeditor_new/ckeditor.js"></script>
                <script src="../plugins/bloqueiaCheckbox.js"></script>
                <script type="text/javascript" src="js/jquery.price_format.1.7.min.js"></script>
                <link rel="stylesheet" href="js/jquery.tabs.css" type="text/css" media="print, projection, screen">
<!-- Additional IE/Win specific style sheet (Conditional Comments) -->
<!--[if lte IE 7]>
<link rel="stylesheet" href="js/jquery.tabs-ie.css" type="text/css" media="projection, screen">
<![endif]-->

<script type="text/javascript">

<?php if ($login_fabrica == 174){ ?>
            $("#origem").live('change', function() {
                $("#valida_obrigatorio").val($("#origem option:selected").attr('valida_obrigatorio'));
            });

            $("#abre_os").live('click', function(){
                var abre_os_check = $('#abre_os').is(':checked');
                if (abre_os_check){
                    $("#abre_os_check").val('true');
                }else
                {
                    $("#abre_os_check").val('false');
                }
            });
<?php } ?>

<?php if (in_array($login_fabrica, [169,170])){ ?>
            $("#origem").live('change', function() {

                if($("#tipo_protocolo").val() == ""){
                    alert("Informe o campo Protocolo Via antes de selecionar a Origem");
                }
            });
<?php } ?>

<?php
    if(in_array($login_fabrica, array(35,151,164,186))) {
?>
function add_os_relaciona() {
    var total_linha = $('#qtde_os_relacionar').val();
    var os_relaciona = $(".os_relaciona").val();
    if (os_relaciona == '' || os_relaciona == undefined) {
        $(os_relaciona).focus();
        $("#mensagem_relaciona_os").addClass('msn_error');
        $("#mensagem_relaciona_os").html('Digite uma OS');
        return false;
    } else {
        var linha = $('#qtde_os_relacionar').val();
        linha = parseInt(linha) + 1;
        $('#qtde_os_relacionar').val(linha);
        $("#mensagem_relaciona_os").html('');
        $("#mensagem_relaciona_os").removeClass('msn_error');
    }

    $.ajax({
        async: true,
        type: 'POST',
        dataType:"JSON",
        url: 'callcenter_interativo_new.php',
        data: {
            ajax_valida_os:true,
            os:os_relaciona
        },
    }).done(function(data) {
        if(data.error){
            $(".os_relacionar").focus();
            $("#mensagem_relaciona_os").addClass('msn_error');
            $("#mensagem_relaciona_os").html(data.mensagem);
            return false;
        } else {
            $("#mensagem_relaciona_os").html('');
            $("#mensagem_relaciona_os").removeClass('msn_error');
            $("#mensagem_relaciona_os").addClass('msn_success');
            $("#mensagem_relaciona_os").html(data.mensagem);
            $("#relaciona_os").append("<tr bgcolor='#ffffff' id='os_rel_"+linha+"'><td align='center'><input name='os_relacionadas[]' id='os_relacionadas' type='hidden' value='"+os_relaciona+"'  size='15'> "+os_relaciona+"</td><td align='center'><img style='cursor: pointer;' onclick='remove_os_relaciona("+linha+")' align='absmiddle' title='Remover' src='imagens/btn_delete.png' /></td></tr>");
<?php
        if ($login_fabrica == 35) {
?>
            $(".btn-add-os").hide();
<?php
        }
?>
            setTimeout(function() {
                $("#control-relaciona-os").html('');
                $("#mensagem_relaciona_os").html('');
                $("#mensagem_relaciona_os").removeClass('msn_success');
                $(".os_relaciona").val('');
            }, 2000);
        }
    });
}

function remove_os_relaciona(posicao) {
<?php
        if (isset($_GET['callcenter']) && in_array($login_fabrica,array(35,151,186))) {
?>
    if (confirm('Deseja realmente deletar esta ordem de serviço?')) {
        $.ajax({
            url: window.location.href,
            type: 'POST',
            dataType:"JSON",
            data: {
                ajax_remove_os: true,
                os: $("#os_rel_"+posicao).find('input').val(),
                callcenter: <?=$_GET['callcenter'] ?>
            },
            timeout: 8000
        }).fail(function(){
            alert('Ocorreu um erro ao tentar deletar uma ordem de serviço relacionada');
        }).done(function(data){
            if (data.ok !== undefined) {
                var linha = $('#qtde_os_relacionar').val();
                linha = parseInt(linha) - 1;
                $('#qtde_os_relacionar').val(linha);
                $("#os_rel_"+posicao).remove();
                if (linha == 1) {
                    $("#os_relacionar_"+linha).removeAttr('readonly');
                    $("#control-relaciona-os-"+linha).html('<img class="btn-add-os" onclick="add_os_relaciona('+linha+');" style="cursor: pointer;width:17px;vertical-align: top;" title="Adicionar" src="imagens/Plus.png"  /> ');
                }
<?php
            if ($login_fabrica == 35) {
?>
                $("input[name=at_os]").val('');
                $(".btn-add-os").show();
<?php
            }
?>
            } else {
                alert(data.error);
            }
        });
    }
<?php
        } else {
?>
        var linha = $('#qtde_os_relacionar').val();
        linha = parseInt(linha) - 1;
        $('#qtde_os_relacionar').val(linha);
        $("#os_rel_"+posicao).remove();
        if (linha == 1) {
            $("#os_relacionar_"+linha).removeAttr('readonly');
            $("#control-relaciona-os-"+linha).html('<img class="btn-add-os" onclick="add_os_relaciona('+linha+');" style="cursor: pointer;width:17px;vertical-align: top;" title="Adicionar" src="imagens/Plus.png"  /> ');
        }
<?php
            if ($login_fabrica == 35) {
?>
            $(".btn-add-os").show();
<?php
            }
        }
?>
}

<?php
    }
?>
    <?php if(in_array($login_fabrica, array(90))){?>
        function seleciona_frase_pronta(){//IBBL
            var origem = $('#origem').val();
            Shadowbox.open({
                content: "frases_callcenter.php?consulta_callcenter=true",
                player: "iframe",
                width: 900,
                height: 450
            });
        }
        function retorna_frase_callcenter(texto){
            CKEDITOR.instances['resposta'].setData(texto);
        }
    <?php } ?>
    <?php if(in_array($login_fabrica, array(189))){?>
    function retorna_transportadora(data) {
        if (data.posicao == "1") {
            $("input[name=manual_cod_transp]").val(data.codigo_interno);
            $("input[name=manual_nome_transp]").val(data.nome);
            if (data.contato != "" || data.contato != "null") {
                $("input[name=manual_contato_transp]").val(data.contato);
            }
            if (data.fone != "" && data.fone != "null") {
                $("input[name=manual_fone_transp]").val(data.fone);
            }
            if (data.cidade != "" && data.cidade != "null") {
                $("input[name=manual_end_transp]").val(data.cidade+"/"+data.uf);
            }
        } else {
            $("input[name=manual_cod_transp_redespacho]").val(data.codigo_interno);
            $("input[name=manual_nome_transp_redespacho]").val(data.nome);
            if (data.contato != "" && data.contato != "null") {
                $("input[name=manual_contato_transp_redespacho]").val(data.contato);
            }
            if (data.fone != "" && data.fone != "null") {
                $("input[name=manual_fone_transp_redespacho]").val(data.fone);
            }
            if (data.cidade != "" && data.cidade != "null") {
                $("input[name=manual_end_transp_redespacho]").val(data.cidade+"/"+data.uf);
            }
        }
    }
    function retorna_dados_pedido_viapol(nome_posto, cnpj, contato_email, contato_fone_residencial, contato_cep, contato_endereco, contato_numero, contato_complemento, contato_bairro, contato_estado, contato_cidade, contato_fone_comercial, contato_cel, pedido,representante_nome,representante_email,obs_pedido,obs_entrega,nome_transport,contato_transport,fone_transport,end_transport,codigo_cliente_revenda){

            $("#consumidor_nome").val(nome_posto);
            $("#consumidor_cnpj").attr('checked', 'checked');
            fnc_tipo_atendimento('R');
            $("#cpf").val(cnpj);
            $("#codigo_cliente_revenda").val(codigo_cliente_revenda);
            $("#consumidor_email").val(contato_email);
            $("#telefone").val(contato_fone_residencial);
            $("#consumidor_cep").val(contato_cep);
            $("#consumidor_endereco").val(contato_endereco);
            $("#consumidor_numero").val(contato_numero);
            $("#consumidor_complemento").val(contato_complemento);
            $("#consumidor_bairro").val(contato_bairro);
            $("#consumidor_estado").val(contato_estado);
            $("#consumidor_cidade").val(contato_cidade);
            $("#telefone2").val(contato_fone_comercial);
            $("#telefone3").val(contato_cel);
            $("#consumidor_cep").focus();
            $("#pedido").val(pedido);
        $(".txt_obs_pedido").html(obs_pedido);
        $(".txt_nome_transp").html(nome_transport);
        $(".txt_contato_transp").html(contato_transport);
        $(".txt_fone_transp").html(fone_transport);
        $(".txt_obs_entrega").html(obs_entrega);
        $(".txt_end_transp").html(end_transport);
        $("input[name=nome_representante]").val(representante_nome);
        $("input[name=email_representante]").val(representante_email);
    }

    $(function(){
        $(".btn_lupa_transporte").click(function(){
            var tipo    = $(this).data("tipo");
            var posicao = $(this).data("posicao");
            if (tipo == "codigo" && posicao == 1) {
                var campo  = $("input[name=manual_cod_transp]").val();
            } else if (tipo == "nome" && posicao == 1) {
                var campo  = $("input[name=manual_nome_transp]").val();
            } else if (tipo == "codigo" && posicao == 2) {
                var campo  = $("input[name=manual_cod_transp_redespacho]").val();
            } else if (tipo == "nome" && posicao == 2) {
                var campo  = $("input[name=manual_nome_transp_redespacho]").val();
            }

            if (campo.length < 4) {
                alert("Preencha toda ou parte da informação para realizar a pesquisa!");
                return false;
            }

            Shadowbox.open({
                content: "transportadora_lupa_new.php?posicao="+posicao+"&parametro="+tipo+"&valor="+campo ,
                player: "iframe",
                width: 700,
                height: 450,
                options: {
                    modal: true
                }
            });
        })



    });
    <?php } ?>

    <?php if(in_array($login_fabrica, array(190))){?>
        $(function(){
            $("#abre_ordem_servico").change(function(){
                if($('#abre_ordem_servico').is(":checked")){
                    $('#tipo_atendimento_os').show();
                }else{
                    $("#tipo_atendimento_os").hide();
                }
            });
        });
    <?php } ?>


    function retorna_dados_pedido(nome_posto, cnpj, contato_email, contato_fone_residencial, contato_cep, contato_endereco, contato_numero, contato_complemento, contato_bairro, contato_estado, contato_cidade, contato_fone_comercial, contato_cel, pedido){
        $("#consumidor_nome").val(nome_posto);
        $("#consumidor_cnpj").attr('checked', 'checked');
        fnc_tipo_atendimento('R');
        $("#cpf").val(cnpj);
        $("#consumidor_email").val(contato_email);
        $("#telefone").val(contato_fone_residencial);
        $("#consumidor_cep").val(contato_cep);
        $("#consumidor_endereco").val(contato_endereco);
        $("#consumidor_numero").val(contato_numero);
        $("#consumidor_complemento").val(contato_complemento);
        $("#consumidor_bairro").val(contato_bairro);
        $("#consumidor_estado").val(contato_estado);
        $("#consumidor_cidade").val(contato_cidade);
        $("#telefone2").val(contato_fone_comercial);
        $("#telefone3").val(contato_cel);
        $("#consumidor_cep").focus();
        $("#pedido").val(pedido);
    }

    <?php if ($login_fabrica == 183){ ?>
        function permissao_supervisor(){
            var status_interacao = $('select[name=status_interacao] option:selected').val();

            if(status_interacao == "Resolvido"){
                return false;
            }

            Shadowbox.open({
                content: "verifica_interventor.php?permissao_supervisor=true",
                player: "iframe",
                width: 700,
                height: 280,
                options: {
                    modal: true,
                    enableKeys: false,
                    displayNav: false
                }
            });
        }

        function retorna_permissao_supervisor(retorno){
            Shadowbox.close();
            if(retorno == "cancelar_acao"){
                $("#abre_ordem_servico").attr("checked", false);
                $("#select_atendimento_os").val("");
            }
        }
    <?php } ?>

    <?php if(in_array($login_fabrica, array(169,170))) { ?>

        function permissao_supervisor(atendimento){//Midea
            var status_interacao = $('select[name=status_interacao] option:selected').val();

            if($(atendimento).length > 0 && status_interacao == "Resolvido"){
                return false;
            }

            Shadowbox.open({
                content: "verifica_interventor.php?permissao_supervisor=true&atendimento="+atendimento ,
                player: "iframe",
                width: 700,
                height: 250,
                options: {
                    modal: true,
                    enableKeys: false,
                    displayNav: false
                }
            });
        }

        function seleciona_frase_pronta(){//Midea
            var origem = $('#origem').val();
            Shadowbox.open({
                content: "frases_callcenter.php?consulta_callcenter=true&origem="+origem ,
                player: "iframe",
                width: 900,
                height: 450
            });
        }
        function retorna_frase_callcenter(texto){
            CKEDITOR.instances['resposta'].setData(texto);
        }

        function valida_aba_atendimento(aba_atendimento){
            var fabrica_os_os = '<?=$login_fabrica?>';
            var id_hd_motivo_ligacao = $("#id_hd_motivo_ligacao").val();
            var selecionar = "";

            if($("#"+aba_atendimento+"_click").parent("li").hasClass("tabs-disabled")) {
                return false;
            }

            $("#hd_motivo_ligacao").val('');
            $("#hd_motivo_ligacao_reclamacao_empresa").val('');
            $("#hd_motivo_ligacao_reclamacao_at").val('');
            $("#hd_motivo_ligacao_duvida_produto").val('');
            $("#hd_motivo_ligacao_sugestao").val('');
            $("#hd_motivo_ligacao_onde_comprar").val('');
            $("#hd_motivo_ligacao_indicacao_at").val('');
            $("#hd_motivo_ligacao_informacao").val('');

            $.ajax({
                url: window.location,
                type: "POST",
                data: {ajax: 'sim', classificacao: $("#hd_classificacao").val(), natureza: aba_atendimento},
                timeout: 7000
            }).fail(function(){
                alert('fail');
            }).done(function(data){
                data = JSON.parse(data);
                if (data.ok !== undefined) {
                    var option = "<option value=''>Escolha a Providência</option>";
                    $.each(data.ok, function (key, value) {
                        if(value.motivo_ligacao == id_hd_motivo_ligacao){
                            selecionar = "selected";
                            if (value.abre_os == 't'){
                                $("#os_pre_os").show();
                                if ($.inArray(fabrica_os_os, [169,170]) !== -1 && $("#os").val() == "") {
                                    if($(".produto_deslocamento").val() == 't'){
                                        $(".class_169").hide();
                                        $(".abre_os_169").show();
                                        $("#div_data_agendamento_ordem").show();
                                        $("#div_periodo_agendamento_ordem").show();
                                        $("#imprimir_os").show();
                                        $("#abre_ordem_servico").prop("checked", true);
                                        abreOrdemServico($("#abre_ordem_servico"));
                                    }else{
                                        $(".abre_os_169").hide();
                                        $("#div_data_agendamento_ordem").hide();
                                        $("#div_periodo_agendamento_ordem").hide();
                                        $(".class_169").show();
                                        $("#imprimir_os").show();
                                        $("#abre_os").prop("checked", true);
                                    }
                                }
                            }else{
                                $("#os_pre_os").hide();
                            }
                            $("#os_cortesia").val(value.os_cortesia);
                        }else{
                            selecionar = "";
                        }
                        option += "<option data-os_cortesia='"+value.os_cortesia+"' data-abreos_preos='"+value.abre_os+"' data-prazodias='"+value.prazo_dias+"' "+selecionar+" value='"+value.motivo_ligacao+"'>"+value.descricao+" - "+value.prazo_dias+" D</option>";
                    });

                    if(aba_atendimento == 'reclamacao_produto'){
                        $('#hd_motivo_ligacao').html(option);
                    }else{
                        $('#hd_motivo_ligacao_'+aba_atendimento).html(option);
                    }
                }
            });
        }

        function retorna_permissao_supervisor(retorno){
            Shadowbox.close();

            if(retorno == "login_supervisor"){
                $("input[name='valida_senha_supervisor']").val("true");
                $(".verifica_servidor").prop("disabled", false);
                $(".verifica_servidor").show();
                $(".msg_prazo_dias").hide();
                $(".permissao_supervisor").hide();
                $("select[name='transferir']").prop("disabled", true);

                if (typeof permissao_supervisor_callback == "function") {
                    permissao_supervisor_callback();
                    permissao_supervisor_callback = null;
                }
            }else if(retorno == "cancelar_acao"){
                if (typeof permissao_supervisor_callback == "function") {
                    permissao_supervisor_callback();
                    permissao_supervisor_callback = null;
                }
            }

           <?php
           if (in_array($login_fabrica, [169,170])) { ?>
                if ($("input[name=mostra_providencia_nivel3]").val() == "sim" && retorno == 'cancelar_acao') {

                    $(".select_motivo_ligacao:visible option").prop("selected", false);
                    $(".select_motivo_ligacao:visible").change();
                    $("input[name=mostra_providencia_nivel3]").val("nao");

                }
           <?php
           }
           ?>
        }
        var permissao_supervisor_callback = null;
    <?php } ?>

    <?php if($login_fabrica == 30){ //HD-2902269 ?>
        function verifica_backofice(){
            $("#hd_classificacao").change(function() {
                var atendimento_backofice = $('select[name=hd_classificacao] option:selected').val();

                if(atendimento_backofice == 37 || atendimento_backofice == 46 || atendimento_backofice == 50){
                    $('#campos_backofice').show();
                }else{
                    $('#campos_backofice').hide();
                    $('#numero_sr').val('');
                    $('#numero_process').val('');
                    $('#data_recebimento').val('');
                    $('#data_fatal').val('');
                    $('#info_notificado').val('');
                }

                if(atendimento_backofice == 61){
                    $("#campos_reclameaqui").show();
                }else{
                    $("#campos_reclameaqui").hide();
                    $('#nota_consumidor').val('');
                    $('#id_reclamacao').val('');
                }

                if(atendimento_backofice == 47){
                    $(".backoffice_cb").each(function(){
                        $(this).show();
                    });
                }else{

                    $("#os_revenda").val("");
                    $("#orientacao_posto").val("");

                    $(".backoffice_cb").each(function(){
                        $(this).hide();
                    });
                }

            });
        }
    <?php } ?>

    <?php if (in_array($login_fabrica, array(24))) { ?>
        function fn_valida_consumidor_cpf(cpf_consumidor, nome_consumidor){
            var retorno;

            if (cpf_consumidor == '' || cpf_consumidor == 'undefined' ) {
                return true;
            }

            $.ajax({
                async: false,
                url : "<?php echo $_SERVER['PHP_SELF']; ?>",
                type: "POST",
                data: {
                    valida_consumidor_cpf : "ok",
                    cpf_consumidor : cpf_consumidor,
                    nome_consumidor : nome_consumidor,
                    ajax : true
                },
                complete: function(data){

                    data = data.responseText.split('|');

                    if(data[0] == "erro"){
                        if (confirm(data[1])) {
                            retorno = true;
                        } else {
                            retorno = false;
                        }
                    }

                    if (data[0] == "errosql") {
                        alert(data[1]);
                        retorno = false;
                    }

                    if (data[0] == "ok") {
                        retorno = true;
                    }
                }
            });
            return retorno;
        }
    <?php
    }?>

    function fnc_cpf_com_atendimento(){

        var cpf_cnpj = $("#cpf").val();
        if(typeof cpf_cnpj == undefined || cpf_cnpj.length == 0){
            return false;
        }
        $.ajax({
                async: true,
                type: 'POST',
                url: 'callcenter_interativo_new.php',
                data: { ajax_verifica_atendimento:true, cpf_consumidor:cpf_cnpj },
        })
        .done(function(data) {
            data = JSON.parse(data);

            if(data.error){

                var atendimento = data.error;

                Shadowbox.close();

                <?php
                if ($login_fabrica == 164) { ?>
                    var programa_cpf = "verifica_cpf_atendimento.php?cpf_cnpj="+cpf_cnpj;
            var modal = false;
                <?php
                } else { ?>
                    var programa_cpf = "verifica_interventor.php?cpf_cnpj="+cpf_cnpj+"&atendimento="+atendimento;
            var modal = true;
                <?php
                } ?>
                setTimeout(function() {

                    Shadowbox.open({
                    content: programa_cpf,
                    player: "iframe",
                    width: 700,
                    height: 250,
                    options: {
                        enableKeys: false,
                        modal: modal
                    }
                });

                $("#sb-nav").css({ display: "none" });

                }, 1000);

            }

        });

    }

    function fnc_valida_num_serie(num){
        var serie = $('#serie_'+num).val();
        var produto = $('#produto_referencia_'+num).val();
        var callcenter = '<?=$callcenter?>';
        btn = $('[rel*=frm_callcenter]').val();

        if (serie.length > 0 && produto.length > 0) {
            $.ajax({
                type: 'POST',
                url: 'valida_num_serie.php',
                data: { btnacao:true, serie:serie, produto:produto,callcenter:callcenter },
                dataType : "json",
                success: function(data){
                    dias = parseInt(data.qtd_dias);
                    if(data.status.toUpperCase() == 'RESOLVIDO' && dias <= 90){
                        if(confirm("Existe um chamado resolvido dentro do perÃ­odo de 90 dias.\n número do chamado: "+data.hd_chamado+" \n Data de abertura: "+data.data_abertura+"\n Atendente: "+data.atendente+"\n\n Esse chamado é reincidente? ")){
                            $('[rel*=frm_callcenter]').hide();
                        }
                    }

                    if(data.status.toUpperCase() == "ABERTO"){
                        alert("Existe um chamado em Aberto contendo este número de série e que necessita ser finalizado. Lembrando que, não pode ser possÃ­vel abrir chamado até que seja fechado o outro.\n número do chamado: "+data.hd_chamado+"\n número de série: "+data.serie);
                        $('[rel*=frm_callcenter]').hide();
                    }

                }
            });
        }
    }
    <?php
        if($login_fabrica == 30){ ?>
            var fnc_verifica_cep = function(results){
                var estado_tranferencia = results[4];

//                 if(estado_tranferencia == "CE" && estado_tranferencia != undefined){
//                     $("#campo_transferir").show();
//                     $("#texto_transferir").show();
//                 }else{
//                     $("#campo_transferir").hide();
//                     $("#texto_transferir").hide();
//                 }


            }
    <?php
        }else{ ?>
             var fnc_verifica_cep = function(results){
            }


    <?  }    ?>


function calcRoute(){

//        var service = new google.maps.DistanceMatrixService();
//        var service2 = new google.maps.DistanceMatrixService();

        var error = "";
        var endereco = $("#posto_contato_endereco").val();
        var numero = $("#posto_contato_numero").val();
        var bairro = $("#posto_contato_bairro").val();
        var cidade = $("#posto_contato_cidade").val();
        var estado = $("#posto_contato_estado").val();

        var posto = endereco+ " "+ numero + ", "+cidade+ " "+ estado+ " Brasil";
        var consumidor_latitude ;
        var consumidor_longitude;
        var posto_latitude ;
        var posto_longitude;
        var km1;
        var km2;

        if(cidade.length ==0) {
                alert("Favor selecionar o posto");
                return false;
        }
        if ($("input:radio[name=encaminha_filial][checked]").val() == 't') {
            var consumidor_endereco = $("#filial_endereco").val();
            var consumidor_numero   = $("#filial_numero").val();
            var consumidor_cidade   = $("#filial_cidade").val();
            var consumidor_estado   = $("#filial_estado").val();
        }else{
            var consumidor_endereco   = $("#consumidor_endereco").val();
            var consumidor_numero   = $("#consumidor_numero").val();
            var consumidor_cidade   = $("#consumidor_cidade").val();
            var consumidor_estado   = $("#consumidor_estado").val();
            var consumidor_cep   = $("#consumidor_cep").val();

            if (consumidor_endereco == "" || consumidor_endereco == undefined){
                error = "erro";
                $(this).attr("checked", false);
            }else if (consumidor_numero == "" || consumidor_numero == undefined){
                error = "erro";
                $(this).attr("checked", false);
            }else if (consumidor_cep == "" || consumidor_cep == undefined){
                error = "erro";
                $(this).attr("checked", false);
            }else if (consumidor_estado == "" || consumidor_estado == undefined){
                error = "erro";
                $(this).attr("checked", false);
            }else if (consumidor_cidade == "" || consumidor_cidade == undefined){
                error = "erro";
                $(this).attr("checked", false);
            }

            if (error.length > 0){
                alert("Por favor informe os dados de endereço do consumidor para calcular a rota.");
                return false;
            }

            if(consumidor_numero.length == 0){
                alert("Por favor informe o número do consumidor.");
                return false;
            }
        }
        $.ajax({
                url:"controllers/TcMaps.php",
                        type: "POST",
                        async:false,
                        data: { endereco: consumidor_endereco,
                                numero: consumidor_numero,
                                cidade: consumidor_cidade,
                                estado: consumidor_estado,
                                cep: consumidor_cep,
                                pais:'BRASIL',
                                ajax:'geocode'
                },
                complete: function (data) {
                        data = $.parseJSON(data.responseText);

                         consumidor_latitude = data.latitude;
                        consumidor_longitude = data.longitude;
                }
        });
        $.ajax({
                url: "controllers/TcMaps.php",
                        type: "POST",
                        async:false,
                        data: { endereco: endereco,
                                numero: numero,
                                cidade: cidade,
                                estado: estado,
                                pais:'BRASIL',
                                ajax:'geocode'
                },
                complete: function (data) {
                        data = $.parseJSON(data.responseText);

                         posto_latitude = data.latitude;
                         posto_longitude = data.longitude;
                }
        });
        $.ajax({
                url: "controllers/TcMaps.php",
                        type: "POST",
                        timeout:60000,
                        data: { origem: consumidor_latitude+','+consumidor_longitude,
                                destino: posto_latitude+','+posto_longitude,
                                ajax:'route',
                                ida_volta: 'sim'
                },
                beforeSend:function(){
                        $("#botao_km").html("Carregando");
                        $("#btn_calcula_km").hide();
                },
                complete: function (data) {
                        data = $.parseJSON(data.responseText);
                        km1 = data.total_km;
                        $("#botao_km").html("");
                        $("#btn_calcula_km").show();

                    $("#posto_km_tab").val(km1);
                }
        });


//        var consumidor = consumidor_endereco + " " +  consumidor_numero + ", " + consumidor_cidade + "  " + consumidor_estado + " Brasil " ;


//         var service = new google.maps.DistanceMatrixService();
//         var service2 = new google.maps.DistanceMatrixService();
//         var results1, kmtotal1;
//
//         var p = new Promise(function(resolve, reject) {
//            service.getDistanceMatrix(
//            {
//                origins: [posto],
//                destinations: [consumidor],
//                travelMode: google.maps.TravelMode.DRIVING,
//                unitSystem: google.maps.UnitSystem.METRIC,
//                avoidHighways: false,
//                avoidTolls: false
//            }, function(response, status) {
//                if (status != google.maps.DistanceMatrixStatus.OK) {
//                    reject('Error was: ' + status);
//                } else {
//                    results1 = response.rows[0].elements;
//                    var destino = response.destinationAddresses;
//                    destino = destino.toString();
//                    kmtotal1 = results1[0].distance.value;
//                    resolve(true);
//                }
//            });
//         });
//
//         p.then(function(success) {
//            service2.getDistanceMatrix(
//            {
//                origins: [consumidor],
//                destinations: [posto],
//                travelMode: google.maps.TravelMode.DRIVING,
//                unitSystem: google.maps.UnitSystem.METRIC,
//                avoidHighways: false,
//                avoidTolls: false
//            }, function(response2, status2) {
//                if (status2 != google.maps.DistanceMatrixStatus.OK) {
//                    var kmtotal = 0;
//                    kmtotal = kmtotal1.toFixed(2);
//                    kmtotal = kmtotal.toString();
//                    kmtotal = kmtotal.replace(".", ",");
//                }else{
//                    var results = response2.rows[0].elements;
//
//                    if(results[0].status == "OK"){
//                        var kmtotal = 0;
//                        var kmtotal2 = results[0].distance.value;
//
//                        kmtotal = (kmtotal1 + kmtotal2) / 1000;
//                        if(kmtotal == 'NaN'){
//                            alert("Falha ao calcular KM, tente novamente.");
//                        } else {
//                            kmtotal = kmtotal.toFixed(2);
//                            kmtotal = kmtotal.toString();
//                            kmtotal = kmtotal.replace(".", ",");
//
//                            kmtotal1 = kmtotal1 / 1000;
//                            kmtotal1 = kmtotal1.toFixed(2);
//                            kmtotal1 = kmtotal1.toString();
//                            kmtotal1 = kmtotal1.replace(".", ",");
//
//                            kmtotal2 = kmtotal2 / 1000;
//                            kmtotal2 = kmtotal2.toFixed(2);
//                            kmtotal2 = kmtotal2.toString();
//                            kmtotal2 = kmtotal2.replace(".", ",");
//
//                            $("#posto_km_tab").val(kmtotal);
//                        }
//
//                    }
//                }
//            });
//         }, function(error) {
//            alert(error);
//         });
    }

    $(window).load(function(){
        // Caso usuario digita texto sem acentuação correta.
        $("input[type='text']").prop('spellcheck',true);
        $("textarea").prop('spellcheck',true);

        $(document).on("keyup", "#texto_sms_digitado", function () {
            var caracteresDigitados = parseInt($(this).val().length);

            /*HD - 3956227*/
            if (caracteresDigitados <= 160) {
                var divisao = 1;
            } else {
                var divisao = caracteresDigitados /153;
            }

            var qtdeSms = Math.ceil(divisao);
            var textoMostrar = caracteresDigitados+"/"+qtdeSms;
            $("#qtde_caracteres").text(textoMostrar);
        });

    <?php if(!(in_array($login_fabrica,array(7,15,24,30,35,50,52,59,74,81,85,101,114,116)) || isset($novaTelaOs) || $login_fabrica >= 119)) { ?>
        $("#cpf").bind('paste', function(e) {
            e.preventDefault();
        });
    <? } ?>

        <?php if ($login_fabrica == 74): ?>
        if ($("#data_consertado").length == 1) {
            $("#data_consertado").mask("99/99/9999");

            if ($("#status_interacao").val() == "RESOLVIDO") {
                $("#data_consertado").removeAttr("disabled");
            }
        }

        $("#status_interacao").on("change", function(){
            var status = $( this ).val();

            if ($("#data_consertado").length == 1) {
                $("#data_consertado").prop("disabled", "disabled");

                if (status == "RESOLVIDO") {
                    $("#data_consertado").removeAttr("disabled");
                }
            }
        });
        <?php endif ?>

        <?php if($login_fabrica == 30){//HD-2902269 ?>
            $("#numero_process").numeric();
            $("#numero_sr").numeric();
            //$("#nota_consumidor").numeric();
            $("#id_reclamacao").numeric();
            verifica_backofice();

        <?php } ?>

        <?php if($login_fabrica == 52){ //hd_chamado=2891049 ?>
            var prod_referencia = $("input[name='produto_referencia_1']").val();
            var prod_descricao = $("input[name='produto_nome_1']").val();
            if(prod_referencia.length > 0 || prod_descricao.length > 0){
                $("input[name='produto_referencia_1']").prop('readonly', true);
                $("input[name='produto_nome_1']").prop('readonly', true);
            }
        <?php } ?>

        var wordCountConf = {
            showParagraphs: false,
            showWordCount: false,
            showCharCount: false,
            countSpacesAsChars: false,
            countHTML: false,
            maxWordCount: -1,
            maxCharCount: -1,
        }

        if ($("textarea[name=reclamado_produto]").attr("name") == "reclamado_produto"){
            CKEDITOR.replace("reclamado_produto",
                { enterMode : CKEDITOR.ENTER_BR,
                    wordcount: wordCountConf,
                    disableNativeSpellChecker: false
                }
            );
        }

        if ($("textarea[name=reclamado_empresa]").attr("name") == "reclamado_empresa"){
          CKEDITOR.replace("reclamado_empresa", { enterMode : CKEDITOR.ENTER_BR, wordcount: wordCountConf, disableNativeSpellChecker: false});
        }

        <?php if(in_array($login_fabrica, array(169,170))){ ?>
            if ($("textarea[name=reclamado_assitencia]").attr("name") == "reclamado_assitencia"){
              CKEDITOR.replace("reclamado_assitencia", { enterMode : CKEDITOR.ENTER_BR, wordcount: wordCountConf, disableNativeSpellChecker: false});
            }

            if ($("textarea[name=reclamacao_informacao]").attr("name") == "reclamacao_informacao"){
              CKEDITOR.replace("reclamacao_informacao", { enterMode : CKEDITOR.ENTER_BR, wordcount: wordCountConf, disableNativeSpellChecker: false});
            }

            if($("textarea[name=duvida_produto_obs]").attr("name") == "duvida_produto_obs"){
                CKEDITOR.replace("duvida_produto_obs", { enterMode : CKEDITOR.ENTER_BR, wordcount: wordCountConf, disableNativeSpellChecker: false});
            }

        <?php } ?>

        if ($("textarea[name=reclamado_at]").attr("name") == "reclamado_at"){
          CKEDITOR.replace("reclamado_at", { enterMode : CKEDITOR.ENTER_BR, wordcount: wordCountConf, disableNativeSpellChecker: false});
        }

        if ($("textarea[name=reclamado_sugestao]").attr("name") == "reclamado_sugestao"){
          CKEDITOR.replace("reclamado_sugestao", { enterMode : CKEDITOR.ENTER_BR, wordcount: wordCountConf, disableNativeSpellChecker: false});
        }

      <?php if($login_fabrica == 101 || $login_fabrica == 145){ ?>
        if($("textarea[name=onde_comprar_obs]").attr("name") == "onde_comprar_obs"){
            CKEDITOR.replace("onde_comprar_obs", { enterMode : CKEDITOR.ENTER_BR, wordcount: wordCountConf});
         }

         if($("textarea[name=duvida_produto_obs]").attr("name") == "duvida_produto_obs"){
            CKEDITOR.replace("duvida_produto_obs", { enterMode : CKEDITOR.ENTER_BR, wordcount: wordCountConf});
         }

      <?php } ?>
        if ($("textarea[name=reclamado_procon]").attr("name") == "reclamado_procon"){
          CKEDITOR.replace("reclamado_procon", { enterMode : CKEDITOR.ENTER_BR, wordcount: wordCountConf, disableNativeSpellChecker: false});
        }

        if ($("textarea[name=resposta]").attr("name") == "resposta"){
          CKEDITOR.replace("resposta", {enterMode : CKEDITOR.ENTER_BR, wordcount: wordCountConf, disableNativeSpellChecker: false});
        }

        if ($("textarea[name=troca_observacao]").attr("name") == "troca_observacao"){
          CKEDITOR.replace("troca_observacao", {enterMode : CKEDITOR.ENTER_BR, wordcount: wordCountConf, disableNativeSpellChecker: false});
        }

        <?php if($login_fabrica == 101){?>
            if ($("textarea[name=reclamado_elogio]").attr("name") == "reclamado_elogio"){
            CKEDITOR.replace("reclamado_elogio", { enterMode : CKEDITOR.ENTER_BR, wordcount: wordCountConf});
        }
if ($("textarea[name=reclamado_produto_acessorio_nao_entregue]").attr("name") == "reclamado_produto_acessorio_nao_entregue"){
CKEDITOR.replace("reclamado_produto_acessorio_nao_entregue", { enterMode : CKEDITOR.ENTER_BR, wordcount: wordCountConf, disableNativeSpellChecker: false});
        }
        <? }

        if ($login_fabrica == 85) { ?>
            if ($("textarea[name=descricao_garantia_contratual]").attr("name") == "descricao_garantia_contratual"){
CKEDITOR.replace("descricao_garantia_contratual", { enterMode : CKEDITOR.ENTER_BR, wordcount: wordCountConf, disableNativeSpellChecker: false});
        }
        <?php
        }

        if ($login_fabrica == 165) { ?>
            if ($("textarea[name=indicacao_instalador_comentario]").attr("name") == "indicacao_instalador_comentario"){
                CKEDITOR.replace("indicacao_instalador_comentario", { enterMode : CKEDITOR.ENTER_BR, wordcount: wordCountConf });
            }
        <? } ?>
    });

    $(function(){

        $('input[name=duvida_consumidor]').click(function() {
            if ($(this).val() == 'TE') {
                $(".exibe_equipamentos_consumiveis").show();
                $(".exibe_equipamentos").show();
                $(".exibe_consumiveis").hide();
            } else {
                $(".exibe_equipamentos").hide();
            }
        });

        $('input[name=duvida_consumidor]').click(function() {
            if ($(this).val() == 'TC') {
                $(".exibe_equipamentos_consumiveis").show();
                $(".exibe_equipamentos").hide();
                $(".exibe_consumiveis").show();
            } else {
                $(".exibe_consumiveis").hide();
            }
        });

        <?if($login_fabrica == 85 AND $somente_visualiza_call_center == 't'){ ?>
            $('input').attr('readonly', 'readonly');
            $('select').attr('disabled', 'true');
            $('textarea').attr('disabled', 'true');
            $('input[type="button"]').attr('disabled', 'true');
        <?php } ?>

        $("#numero_documento").numeric(); //HD-3224475
        $("#checklist").change(function(){ //HD-3224475
            var id_check = $("#checklist").val();
            if(id_check == '5'){
                $("#td_numero_documento").show();
            }else{
                $("#td_numero_documento").hide();
                $("#numero_documento").val('');
            }
        });



        <?php if(in_array($login_fabrica,array(195))){ ?>


            $("select[name=hd_classificacao]").change(function(){
                var abre_os_pre_os = $("select[name=hd_classificacao] option:selected").data("abre_os_pre_os");
                if (abre_os_pre_os == 'os'){
                    $(".abre_pre_os").hide();
                    $(".abre_os_os").show();
                    $("#tipo_atendimento_os").show();

                } else if (abre_os_pre_os == 'pre'){
                    $(".abre_pre_os").show();
                    $(".abre_os_os").hide();
                    $("#tipo_atendimento_os").hide();

                }else{
                    $(".abre_pre_os").hide();
                    $(".abre_os_os").hide();
                    $("#tipo_atendimento_os").hide();
                }
                $(".abre_os_os_agendamento").hide();
                
            });


            $(document).on("change","select[name=tipo_atendimento_os]", function(){
                var km_google = $("select[name=tipo_atendimento_os] option:selected").attr("km-google");
                if (km_google == 't'){
                    $(".abre_os_os_agendamento").show();
                } else{
                    $(".abre_os_os_agendamento").hide();
                }
                
                
            });
        <?php }?>
        <?php if(in_array($login_fabrica,array(169,170))){ ?>

            $("select[name=hd_classificacao]").change(function(){
                var envia_email = $("select[name=hd_classificacao] option:selected").data("classificacao_email");
                if(envia_email == 't'){
                    $("#classificacao_email").show();
                }else{
                    $("#classificacao_email").hide();
                }
            });

            var old_motivo_ligacao = $(".select_motivo_ligacao").val();

            $(".select_motivo_ligacao").change(function(){
                var valida_senha_supervisor = $("input[name='valida_senha_supervisor']").val();
                var prazo_dias = $(this).children(":selected").data('prazodias');
                var admin_supervisor = $("input[name='admin_supervisor']").val();
                var abreos_preos = $(this).children(":selected").data("abreos_preos");

                var os_cortesia = $(this).children(":selected").data('os_cortesia');
                $("#os_cortesia").val(os_cortesia);

                $("#abre_os_preos").val(abreos_preos);
                <?php
                if (empty($callcenter)) {
                ?>
                    var status = $("#status_interacao").val();

                    if (prazo_dias > 0 && status == 'Resolvido') {
                        $(".select_motivo_ligacao").val(old_motivo_ligacao);
                        alert("O atendimento não pode ser finalizado com a providência selecionada");
                        return false;
                    }

                    old_motivo_ligacao = $(".select_motivo_ligacao").val();
                <?php
                }
                ?>

                $("#id_hd_motivo_ligacao").val($(this).val());

                $("#serv_install").hide();
                $("#serv_install").prop("checked", false);
                $("#servico_instalacao").hide();

                if ($("input[name='abre_ordem_servico']").is(':checked') == true){
                    $("#serv_install").show();
                    $("#serv_install").prop("checked", false);
                    $("#servico_instalacao").show();
                }

                if(abreos_preos == 't'){
                    $("#os_pre_os").show();

                    if($(".produto_deslocamento").val() == 't'){
                        $(".class_169").hide();
                        $(".abre_os_169").show();
                        $("#div_data_agendamento_ordem").show();
                        $("#div_periodo_agendamento_ordem").show();
                        $("#imprimir_os").show();
                        $("#abre_ordem_servico").prop("checked", true);
                        abreOrdemServico($("#abre_ordem_servico"));
                    }else{
                        $(".class_169").show();
                        $(".abre_os_169").hide();
                        $("#div_data_agendamento_ordem").hide();
                        $("#div_periodo_agendamento_ordem").hide();
                        $("#imprimir_os").show();
                        $("#abre_os").prop("checked", true);
                    }
                }else{
                    $("#abre_ordem_servico").prop("checked", false);
                    $("#abre_os").prop("checked", false);
                    $("#serv_install").prop("checked", false);
                    $("#os_pre_os").hide();
                }

                var cidade = $("select[name='consumidor_cidade']").val();
                var estado = $("select[name='consumidor_estado']").val();
                var produto = $("input[name='produto']").val();
                var valida_jornada = $("#valida_jornada").val();
                var tem_jornada = "false";

                if (valida_jornada != '') {
            valida_jornada = $.parseJSON(valida_jornada);

                    $.each(valida_jornada, function(i, nome) {
                        if (cidade == nome.cidade && produto == nome.produto){
                            tem_jornada = "true";
                            return false;
                        }else if (estado == nome.estado && nome.cidade == null && produto == nome.produto){
                            tem_jornada = "true";
                            return false;
                        }else if (nome.estado == null && nome.cidade == null && produto == nome.produto){
                            tem_jornada = "true";
                            return false;
                        }else if (cidade == nome.cidade && nome.produto == null){
                            tem_jornada = "true";
                            return false;
                        }else if (estado == nome.estado && nome.cidade == null && nome.produto == null){
                            tem_jornada = "true";
                            return false;
                        }
                     });
        }

                $("#tem_jornada").val(tem_jornada);

                if(prazo_dias == 0 && valida_senha_supervisor != "true" && admin_supervisor == "" && tem_jornada == "false" && valida_jornada != ''){
                    $(".verifica_servidor").prop("disabled", true);
                    $(".verifica_servidor").hide();
                    $(".msg_prazo_dias").show();
                    $(".permissao_supervisor").show();
                    $("select[name='transferir']").prop("disabled", true);
                    $("select[name='transferir']").val("");
                }else{
                    $(".verifica_servidor").prop("disabled", false);
                    $(".verifica_servidor").show();
                    $(".msg_prazo_dias").hide();
                    $(".permissao_supervisor").hide();
                    $("select[name='transferir']").prop("disabled", false);
                }
            });

            $(".select_motivo_ligacao").change(function(){

                let motivo_ligacao = $(this).find("option:selected").val();
                let aba            = $(this).data("aba");

                if (motivo_ligacao != "") {
                    $.ajax({
                        url : window.location,
                        type: "POST",
                        data: {
                            ajax_providencia_nivel3 : true,
                            hd_motivo_ligacao : motivo_ligacao
                        },
                        timeout: 7000
                    }).done(function(data){

                        let dados = JSON.parse(data);

                        if (dados.cortesia) {
                            permissao_supervisor();
                        }

                        if (dados.retorno != "nao_encontrado") {

                            $("#providencia_nivel3_"+aba+" option").filter(function(){
                                    return $(this).val() != "";
                            }).remove();

                            $.each(dados.retorno, function(i, valor) {

                                let option = $('<option>', {
                                                value: valor.hd_providencia,
                                                text: valor.descricao,
                                                selected: (valor.hd_providencia == motivo_ligacao)
                                             });
                                $("#providencia_nivel3_"+aba).append(option);

                            });

                            $("#providencia_nivel3_"+aba).closest("tr").show();
                            $("input[name=mostra_providencia_nivel3]").val("sim");

                        } else {

                            $("#providencia_nivel3_"+aba+" option").filter(function(){
                                    return $(this).val() != "";
                            }).remove();

                            $("#providencia_nivel3_"+aba).closest("tr").hide();

                            $("input[name=mostra_providencia_nivel3]").val("nao");

                        }

                    });

                } else {

                    $("#providencia_nivel3_"+aba+" option").filter(function(){
                        return $(this).val() != "";
                    }).remove();

                    $("#providencia_nivel3_"+aba).closest("tr").hide();
                }

            });

            var old_status_interacao = $("select[name=status_interacao]").val();

            $("select[name=status_interacao]").change(function(){
                var status_interacao = $("select[name=status_interacao] option:selected").val();
                var valida_senha_supervisor = $("input[name='valida_senha_supervisor']").val();
                var tab_atual = $("#tab_atual").val();
                var admin_supervisor = $("input[name='admin_supervisor']").val();

                if(tab_atual == 'reclamacao_produto'){
                    var prazo_dias = $("select[name=hd_motivo_ligacao] option:selected").data("prazodias");
                }else if(tab_atual == 'reclamacao_empresa'){
                    var prazo_dias = $("select[name=hd_motivo_ligacao_reclamacao_empresa] option:selected").data("prazodias");
                }else if(tab_atual == 'reclamacao_at'){
                    var prazo_dias = $("select[name=hd_motivo_ligacao_reclamacao_at] option:selected").data("prazodias");
                }else if(tab_atual == 'duvida_produto'){
                    var prazo_dias = $("select[name=hd_motivo_ligacao_duvida_produto] option:selected").data("prazodias");
                }else if(tab_atual == 'sugestao'){
                    var prazo_dias = $("select[name=hd_motivo_ligacao_sugestao] option:selected").data("prazodias");
                }else if(tab_atual ==  'onde_comprar'){
                    var prazo_dias = $("select[name=hd_motivo_ligacao_onde_comprar] option:selected").data("prazodias");
                }else if(tab_atual == 'indicacao_at'){
                    var prazo_dias = $("select[name=hd_motivo_ligacao_indicacao_at] option:selected").data("prazodias");
                }else if(tab_atual == 'informacao'){
                    var prazo_dias = $("select[name=hd_motivo_ligacao_informacao] option:selected").data("prazodias");
                }

                <?php
                if (empty($callcenter)) {
                ?>
                    if (prazo_dias > 0 && $(this).val() == 'Resolvido') {
                        $("select[name=status_interacao]").val(old_status_interacao);
                        alert("O atendimento não pode ser finalizado com a providência selecionada");
                        return false;
                    }

                    old_status_interacao = $("select[name=status_interacao]").val();
                <?php
                }
                ?>

                var cidade = $("select[name='consumidor_cidade']").val();
                var estado = $("select[name='consumidor_estado']").val();
                var produto = $("input[name='produto']").val();
                var valida_jornada = $("#valida_jornada").val();
                var tem_jornada = "false";

                valida_jornada = $.parseJSON(valida_jornada);

                $.each(valida_jornada, function(i, nome) {
                    if (cidade == nome.cidade && produto == nome.produto){
                        tem_jornada = "true";
                        return false;
                    }else if (estado == nome.estado && nome.cidade == null && produto == nome.produto){
                        tem_jornada = "true";
                        return false;
                    }else if (nome.estado == null && nome.cidade == null && produto == nome.produto){
                        tem_jornada = "true";
                        return false;
                    }else if (cidade == nome.cidade && nome.produto == null){
                        tem_jornada = "true";
                        return false;
                    }else if (estado == nome.estado && nome.cidade == null && nome.produto == null){
                        tem_jornada = "true";
                        return false;
                    }
                });

                $("#tem_jornada").val(tem_jornada);

                if(prazo_dias == 0 && status_interacao == "Resolvido"){
                    $(".verifica_servidor").prop("disabled", false);
                    $(".verifica_servidor").show();
                    $(".msg_prazo_dias").hide();
                    $(".permissao_supervisor").hide();
                    $("select[name='transferir']").prop("disabled", true);
                }else{
                    if(prazo_dias == 0 && valida_senha_supervisor != "true" && admin_supervisor == "" && tem_jornada == "false"){
                        $(".verifica_servidor").prop("disabled", true);
                        $(".verifica_servidor").hide();
                        $(".msg_prazo_dias").show();
                        $(".permissao_supervisor").show();
                        $("select[name='transferir']").prop("disabled", true);
                    }
                }
            });

        <?php } ?>

        <?php if ($login_fabrica == 183){ ?>
            $("#pedido_sap").numeric();
            $("#hd_classificacao").change(function(){
                let hd_classificacao = $("select[name=hd_classificacao] option:selected").text().trim();
                let classificacao  = removeAcentojs(hd_classificacao);

                if (classificacao == "reclamacao - moveis"){
                    $(".pedido_sap").show();
                }else{
                    $(".pedido_sap").hide();
                    $("#pedido_sap").val("");
                }

                if (classificacao == "devolucao"){
                    $(".div_devolucao").show();
                }else{
                    $(".div_devolucao").hide();
                    $("#dev_transportadora").val("");
                    $("#dev_motorista").val("");
                    $("#dev_aprovador").val("");
                }
            });
            $(".select_motivo_ligacao").change(function(){

                let motivo_ligacao = $(this).find("option:selected").val();
                let hd_classificacao = $("#hd_classificacao").find("option:selected").val();

                if (motivo_ligacao != "" && motivo_ligacao != undefined) {
                    $.ajax({
                        url : window.location,
                        type: "POST",
                        data: {
                            ajax_admin_providencia : true,
                            hd_motivo_ligacao : motivo_ligacao,
                            hd_classificacao : hd_classificacao
                        },
                        timeout: 7000
                    }).done(function(data){

                        let dados = JSON.parse(data);

                        if (dados.ok == "success") {
                            $("select[name='transferir'] option").filter(function(){
                                return $(this).val() != "";
                            }).remove();

                            $.each(dados.usuarioAdmin, function(i, valor) {
                                let option = $('<option>', {
                                    value: valor.id,
                                    text: valor.admin,
                                });

                                $("select[name='transferir']").append(option);
                            });
                        } else {
                            $("select[name='transferir'] option").filter(function(){
                                return $(this).val() != "";
                            }).remove();
                            $("select[name='transferir']").val("");
                        }
                    });
                } else {
                    $("select[name='transferir'] option").filter(function(){
                        return $(this).val() != "";
                    }).remove();
                    $("select[name='transferir']").val("");
                }
            });
        <?php } ?>

        <?php if($login_fabrica == 125){?>
            $("#consumidor_revenda").change(function(){
                var consumidor_revenda = $("#consumidor_revenda").val();
                if(consumidor_revenda == "R"){
                    $(".campos_adicionais_revenda").show();
                }else{
                    $(".campos_adicionais_revenda").hide();
                    $("#tel_fixo_revenda").val('');
                    $("#cel_revenda").val('');
                    $("#email_revenda").val('');
                    $("#responsavel_revenda").val('');
                }
            });
        <?php } ?>


        $("#consumidor_bairro").blur(function() {
          $("#consumidor_revenda").focus();
        });
        <?php if($login_fabrica == 30){?>

            var consumidor_estado = $("#consumidor_estado").val();

            var hd_classificacao = $("#hd_classificacao").val();

            $("#consumidor_estado").change(function() {
                var consumidor_estado = $("#consumidor_estado").val();
                var hd_classificacao = $("#hd_classificacao").val();
            });


        <?php } else { ?>
            var fnc_verifica_cep = null;
        <?php }

        /*HD - 4417123*/
        $aux_privilegios       = $_COOKIE["aux_privilegios"];
        if ($aux_privilegios == "master") {
            $exibir_janela_saida = true;
        } else {
            $aux_privilegios = str_replace("_", "", $aux_privilegios);

            if ($aux_privilegios == "sem_privilegios" || preg_match("callcenter", $aux_privilegios) === false) {
                $exibir_janela_saida = false;
            } else {
                $exibir_janela_saida = true;
            }
        }


        if(count($_POST) == 0 && $exibir_janela_saida == true){ //confirm sair da pagina (Ã possÃ­vel que as alteraçÃµes feitas não sejam salvas.) ?>

            window.onbeforeunload = function(e) {
                return 'Esta página quer saber se você deseja mesmo sair - informações fornecidas podem ser perdidas';
            }

            $(document).on("submit", "form", function(event){
                  window.onbeforeunload = null;
            });

        <?php }?>


        /* Uso do input: <input maxlength="15" name="nome_do_campo" id="id_do_campo" class="telefone" /> */
        $('#telefone, .telefone').each(function(){
            var valor = $(this).val().replace(/[^0-9]/g,'').length;

            if(valor <= 10 && valor != 0){
                $('#telefone, .telefone').keydown(function(){
                    $(this).mask('(00) 00000-0000', $(this).val());
                })
                $(this).mask('(00) 0000-0000',  $(this).val()); /* Máscara default */
            } else if (valor != 0) {
                $(this).mask('(00) 00000-0000', $(this).val());  // 9Âº DÃ­gito
            }
        });
        

        <?php
            if(($atendimento_com_troca == "t" OR ($abre_os == "t" || !empty($os))) AND $login_fabrica == 151){
        ?>
            if ( $("input[name=trocar_produto]").length){
                $("input[name=trocar_produto]").checkreadonly(true);
            }
                $("input[name=abre_os]").checkreadonly(true);
                $("input[name=imprimir_os]").checkreadonly(true);

        <?php
            }
        ?>

        /*var phoneMask = function(){
                    if($(this).val().match(/^\(0/)){
                $(this).val('(');
                return;
            }

            if($(this).val().match(/^\([1-9][0-9]\) *[0-8]/)){
                $(this).mask('(00) 0000-0000');
                console.debug('telefone');
            }
            else{
                        $(this).mask('(00) 00000-0000');
                        console.debug('celular');
            }
            $(this).keyup(phoneMask);
        };*/
<?php
            if($login_fabrica != 189) {
        ?>
    var phoneMask = function() {
        if($(this).val().match(/^\(0/)) {
                $(this).val('(');
                return;
            }

            if($(this).val().match(/^\([1-9][0-9]\) *[0-8]/)){
                $(this).mask('(00) 0000-0000'); /* Máscara default */
            } else {
                $(this).mask('(00) 00000-0000');  // 9Âº DÃ­gito
            }

            $(this).keyup(phoneMask);
    };

        $('.telefone').keyup(phoneMask);

        <?php
            } else{
        ?>
            $('.telefone').blur(function(){
                var valor = $(this).val().replace(/[^0-9]/g,'').length;

                if(valor <= 10 && valor != 0){
                    $(this).mask('(00) 0000-0000',  $(this).val()); /* Máscara default */
                } else if (valor != 0) {
                    $(this).mask('(00) 00000-0000', $(this).val());  // 9Âº DÃ­gito
                }
            });


        <?php
            }
        ?>
    });
    /* fim - 9Âº DÃ­gito para São Paulo-SP, digitando o DDD 11 + 9 deixará entrar o 9Âº caracter */

$(function () {

    $(".data_primeira_visita").datepick({startDate:'01/01/2000'}).mask("99/99/9999");

    <?php
        if (in_array($login_fabrica, array(171))) { ?>

            var tipo_atendimento_deslocamento = $("select[name=tipo_atendimento_grohe] > option:selected").attr("km-google");

            toggle_agendamento(tipo_atendimento_deslocamento);

            $("select[name=tipo_atendimento_grohe]").change(function(){
                toggle_agendamento($(this).find("option:selected").attr("km-google"));
            });
    <?php
        }

     if(in_array($login_fabrica, array(151,169,170)) AND !empty($_GET['os_troca'])){ ?>
        var os_troca = <?= $_GET['os_troca']; ?>;
        var abreTelaOs = <?= $_GET['abreTelaOs']; ?>;
        var atendimento = <?= $callcenter; ?>;

        if(abreTelaOs == true){
            window.open("os_troca_subconjunto.php?os="+os_troca+"&hd_chamado="+atendimento);
        }
    <? }
    if($login_fabrica == 151 && !empty($_GET['cadastraPedido'])){ ?>
        var cadastraPedido = <?= $_GET['cadastraPedido']; ?>;
        var atendimento = <?= $callcenter; ?>;

        if(cadastraPedido == true && $('input[name=valida_num_serie]').val() == 'true'){
            window.open('cadastro_pedido.php?callcenter='+atendimento, '_blank');
        }
    <? }
    if($login_fabrica == 74){ ?>
        var atendimento = <?= (strlen($callcenter) > 0) ? $callcenter : 0; ?>;
        if(atendimento == 0){
            $("#envia_email_atlas").hide();
        }else{
            $("#envia_email_atlas").show();
        }

    <? } ?>

    $("#consumidor_estado").change(function () {
        if ($(this).val().length > 0) {
            $("#consumidor_cidade").removeAttr("readonly");
        } else {
            $("#consumidor_cidade").attr({"readonly": "readonly"});
        }

        $("#mapa_estado").val($(this).val());
    });

    $("#consumidor_cidade").change(function() {
        $("#mapa_cidade").val($(this).val());
    });

    <? if ($login_fabrica == 15) { ?>
        $("#data_retorno").blur(function () {
            $("#data_retorno_alterou").val("t");
        });
    <? } ?>
});

function toggle_agendamento (tipo_atendimento_deslocamento) {
    if (tipo_atendimento_deslocamento == "t") {
        $("#div_data_agendamento_ordem, #div_periodo_agendamento_ordem").show();
    } else {
        $("#div_data_agendamento_ordem, #div_periodo_agendamento_ordem").hide();
    }

}


function fnc_lupa_callcenter_revenda (campo, tipo){
    var campo = campo.value;
    if (jQuery.trim(campo).length > 2){
        Shadowbox.open({
            content: "lupa_callcenter_revenda.php?tipo="+tipo+"&campo="+campo,
            player:  "iframe",
            title:   "Pesquisa Revenda",
            width:   800,
            height:  500
        });
    } else{
        alert("Informar toda ou parte da informação para realizar a pesquisa!");
    }
}

function retorna_lupa_callcenter_revenda(revenda,nome,cnpj) {
    $("#cnpj_revenda").val(cnpj);
    $("#revenda_tab").val(revenda);
    $("#nome_revenda").val(nome);
}

function verifica_os_aberta () {
    var hd_chamado = $("input[name=callcenter]").val();

    if (hd_chamado.length > 0) {
        $.ajax({
            url: "verifica_os_atendimento.php",
            type: "POST",
            data: { hd_chamado: hd_chamado },
            complete: function (data) {
                data = $.parseJSON(data.responseText);

                if (data.erro) {
                    alert(data.erro);
                } else if (data.os) {
                    desassociar_os(data.os, hd_chamado);
                }
            }
        });
    }
}

function criarPedido(callcenter) {
    var fabrica = <?=$login_fabrica?>;
    var consumidor_cpf_anterior = $("#consumidor_cpf_anterior").val();
    if(fabrica == 74 && consumidor_cpf_anterior.length == 0){
        alert("Para criar um pedido é necessário primeiramente gravar o CPF do consumidor no atendimento.");
    }else{
        window.open('pedido_cadastro.php?callcenter='+callcenter, '_blank');
    }
}

function onde_comprar_midea(){
    Shadowbox.open({
        content: "http://www.mideadobrasil.com.br/pt/ondecomprar/",
        player: "iframe"
    });
}

 function desassociar_os (os, hd_chamado) {
    var posto = $("#posto_tab").val();

    Shadowbox.options.modal      = true;
    Shadowbox.options.enableKeys = false;

    Shadowbox.open({
        content: "desassociar_os.php?os="+os+"&hd_chamado="+hd_chamado+"&posto="+posto,
        player: "iframe",
        width: 450,
        height: 160
    });

    $("#sb-nav").css({ display: "none" });
 }

 function resetaPosto (hd_chamado) {
    $.ajax({
        url: "desassocia_os_ajax.php",
        type: "POST",
        data: { resetaPosto: true, hd_chamado: hd_chamado },
        complete: function (data) {
            data = $.parseJSON(data.responseText);

            $('#codigo_posto_tab').val(data.codigo);
            $('#posto_tab').val("");
            $('#posto_atual').val(data.posto);
            $('#posto_nome_tab').val(data.nome);
            $('#posto_fone_tab').val(data.fone);
            $('#posto_email_tab').val(data.email);
            $("#codigo_posto").val(data.codigo);
            $("#posto_nome").val(data.nome);

            Shadowbox.close();
            Shadowbox.options.modal      = false;
            Shadowbox.options.enableKeys = true;
            $("#sb-nav").css({ display: "block" });
        }
    });
 }

 function fechaShadowboxDesassocia () {
    Shadowbox.close();
    Shadowbox.options.modal      = false;
    Shadowbox.options.enableKeys = true;
    $("#sb-nav").css({ display: "block" });
 }

 /* 9Âº DÃ­gito para São Paulo-SP, digitando o DDD 11 + 9 deixará entrar o 9Âº caracter */
    /* Exemplos de uso das máscaras: http://igorescobar.github.com/jQuery-Mask-Plugin/ */
    $(function() {
        $('.telefone').keypress(function() {
            if( $(this).val().match(/[^\d|-|\(|\)]/g) ) {
            this.value = this.value.replace(/[^\d|\-|\(|\)]/g, '');
            }
        });
    });
    /* fim - 9Âº DÃ­gito para São Paulo-SP, digitando o DDD 11 + 9 deixará entrar o 9Âº caracter */

    function mostraPesquisaFricon(){

    var pesquisa_id   = $("input[name=pesquisa_fricon]:checked").val();
    var hdChamado = $('input[name=callcenter]').val();
    $.ajax({
        url: "<?php echo $_SERVER['PHP_SELF']; ?>?showPesquisa=1&pesquisa="+pesquisa_id+"&hd_chamado="+hdChamado,
        cache: false,
        success: function(data){
            $("#div_pesquisa").html('');
            $("#div_pesquisa").append(data);
            $("#div_pesquisa").show();
            $(".div_btn_gravar").show();
        }
    });
}

    function mostraPesquisaFriconAntigo(){
        var rel_input = $("input[name=tipo_pergunta]:checked").attr('rel');
        if ( rel_input == 'Auditoria em Campo'){
            $('#AuditoriaCampo').show();
            $('#PesquisaSatisfacao').hide();
        }else if(rel_input == 'Pesquisa de Satisfação'){
            $('#AuditoriaCampo').hide();
            $('#PesquisaSatisfacao').show();
        }
    }

    function informacoesPosto(id, cidade, enderecoPosto = false, numeroPosto = false, cidadePosto = false, estadoPosto = false, km_retorno = null ){
        var dados = new Array();
        var login_fabrica = <?= $login_fabrica; ?>;

        $.ajax({
			url: 'informacoes_posto.php',
			type: 'post',
			data: 'cod='+id,
			success: function(data){
                if (login_fabrica == 74 && ($("#posto_atual").val() != id)) {
					verifica_os_aberta();
				}

                if(enderecoPosto != false){
                    $("#posto_contato_endereco").val(enderecoPosto);
                }

                if(numeroPosto != false){
                    $("#posto_contato_numero").val(numeroPosto);
                }

                if(cidadePosto != false){
                    $("#posto_contato_cidade").val(cidadePosto);
                }

                if(estadoPosto != false){
                    $("#posto_contato_estado").val(estadoPosto);
                }

                dados = data.split("|");

                if (login_fabrica == 169 || login_fabrica == 170){
                    if (dados[7] == 't'){
                        $("#bloqueia_campos_dealer").val('true');
                        alert('O posto autorizado selecionado não está habilitado para abertura de ordem de serviço através do callcenter');
                        $("#codigo_posto_tab").val('');
                        $("#posto_nome_tab").val('');
                        $("#posto_tab").val('');
                        return;
                    }
                }

                $('#codigo_posto_tab').attr('value', dados[4]);
                $('#posto_tab').attr('value', id);
                $('#posto_nome_tab').attr('value', dados[0]);
                $('#posto_fone_tab').attr('value', dados[1]);
                $('#posto_email_tab').attr('value', dados[2]);
                $('#mapa_cidade').attr('value', dados[6]);
                $('#mapa_estado').attr('value', dados[5]);

                $("#codigo_posto").val(dados[4]) ;
                $("#posto_nome").val(dados[0]) ;

				<?php
				if ($login_fabrica == 74) {
				?>
					$("#posto_atual").val(id);
				<?php
				}elseif ($login_fabrica == 30){
					?>
					$("#posto_fone1_tab").attr('value', dados[7]);
					$("#posto_fone2_tab").attr('value', dados[8]);
					$("#particularidade_posto").attr('value', dados[10]);
					<?php
				}
				?>
                <?php if(in_array($login_fabrica,array(30,74,156,183))){?>
                    if (dados[9] == 'SAC') {
                        $("#posto_km_tab").attr('value', 0);
                    }else{
                        if (km_retorno == null) {
                            calcRoute();
                        }else{
                            $("#posto_km_tab").attr('value', km_retorno);
                        }
                    }
                <?php } ?>
            }
		});
	}

    $().ready(function(){
        <?php if ($login_fabrica == 161 && !isset($_GET['callcenter'])) { ?>
        $('#container-Principal li').each(function(){
            if ($(this).find('a').attr('rel') == 'reclamacao_produto') {
                $(this).addClass('tabs-selected');
            }else{
                $(this).removeClass('tabs-selected');
            }
    });
    $('#tab_atual').val('reclamacao_produto');
        <?php } ?>

        $("input, textarea").keyup(function () {
            $(this).val($(this).val().replace(/\'/gi, ""));
        });

        $("input, textarea").blur(function () {
            $(this).val($(this).val().replace(/\'/gi, ""));
        });

        $(".btn_consulta_cidades_atendidas").click(function(){
            var codigo = $('#codigo_posto_tab').val();
            if(codigo != ""){
                var URL = "cidades_atendidas.php?codigo="+ codigo +"&nome="+$('#posto_nome_tab').val();
                window.open(URL,"janela","toolbar=no,location=yes,status=yes,scrollbars=yes,directories=no,width=450,height=200,top=18,left=0" );
            }else{
                alert("Para consultar as cidades atendidas, informe um posto, preenchendo o campo código.");
            }

        });


        if ($('input[name=tipo_pergunta]').is(':checked')){
            mostraPesquisaFriconAntigo()
        }

        if ($('input[name=pesquisa_fricon]').is(':checked')){
            mostraPesquisaFricon()
        }

        $("input[name=pesquisa_fricon]").click(function(){
            mostraPesquisaFricon();
        });

        $(document).on("click",'.btn_grava_pesquisa_fricon',function(){

            var curDateTime = new Date();
            var relBtn = $(this).attr('rel');
            var hdChamado = $('input[name=callcenter]').val();
            var dados = '';
            dados = 'ajax=true&gravaPerguntasFricon=true&pesquisa='+relBtn+'&hdChamado='+hdChamado+'&'+$('.table_perguntas_fricon_pesquisa').find('input').serialize()+'&'+$('.table_perguntas_fricon_pesquisa').find('textarea').serialize()

            $.ajax({

                type: "GET",
                url: "<?=$PHP_SELF?>",
                data: dados,
                beforeSend: function(){

                    $('input[name=pesquisa_fricon]').attr('disabled',true);
                    $('.btn_grava_pesquisa_fricon').hide();
                    $('.td_btn_gravar_pergunta').show();
                    $('.td_btn_gravar_pergunta').html("&nbsp;&nbsp;Gravando...&nbsp;&nbsp;<br><img src='imagens/loading_bar.gif'> ");

                    $('.divTranspBlock').show();


                },
                complete: function(http) {

                    results = http.responseText;
                    results = results.split('|');
                    if (results[0] == 1){

                        $('div.errorPergunta').html(results[1]);
                        $('div.errorPergunta').show();
                        $('.td_btn_gravar_pergunta').hide();
                        $('input[name=pesquisa_fricon]').attr('disabled',false);
                        $('.divTranspBlock').hide();
                        $('.btn_grava_pesquisa_fricon').show();


                    }else{
                        $('div.errorPergunta').hide();
                        $('.divTranspBlock').hide();
                        $('input[name=pesquisa_fricon]').attr('disabled',true);
                        $('.table_perguntas_fricon_pesquisa').find('input').attr('disabled',true);
                        $('.table_perguntas_fricon_pesquisa').find('textarea').attr('disabled',true);
                        $('.agradecimentosPesquisa').show();
                        $('.td_btn_gravar_pergunta').hide();
                    }
                }

            });

            $("input[name=valor_declarado]").maskMoney({symbol:"", decimal:",", thousands:'.', precision:2, maxlength: 15});
        });

    <? // Elgin automação, pesquisa e cadastro de filial ?>
        if ($("input:radio[name=encaminha_filial]").length > 0) {
            // Busca filiais por nome (razão social), fantasia ou CNPJ
            // Se não encontra, oferece a opção de cadastrar uma nova

            $("#tbl_filial tr.info_filial [name]").attr('disabled', 'disabled');
            $("#prazo_limite").mask('99/99/9999 99:99:99');
            $("#filial_fone,#responsavel_fone").mask("(999) 9999-9999");
            $("#filial_cep").mask("99999-999");

            $("#filial_cep").change(function() {
                var frm = document.frm_callcenter;
                buscaCEP(
                    this.value, frm.filial_endereco, frm.filial_bairro,
                    frm.filial_cidade, frm.filial_estado
                );
            }).keypress(function(ev) {
                return txtBoxFormat(this.form, this.name, '99999-999', ev);
            });

            $("#tbl_filial input:radio").change(function() {
                showHideFilial();
            });

            $('#filial_cnpj').attr('maxLength', 18);

            $('#filial_cnpj').keypress(function(e){
                return txtBoxFormat(document.frm_callcenter, this.name, '99.999.999/9999-99', e);
            });

            $('#filial_cnpj').keypress();

            $("#BtnEditSubsidiary").click(function() {
                $("#tbl_filial :disabled").removeAttr('disabled');
                $(this).hide('fast');
                $('#BtnSaveSubsidiary').show('fast');
                /* $("#filial_nome,#filial_fantasia,#filial_cnpj").removeClass('ac_input'); // 'inativa' o autocomplete */
                removeACfilial();
            });

            $("#BtnSaveSubsidiary").click(function() {
                var params = {};
                var selfID = $(this).attr('id');
                url_filial = 'ajax_filial.php';

                params.ajax = ($("#filial").val().length) ? 'edit' : 'create';
                // criar os dados para o POST
                $("#tbl_filial tr.info_filial [name]").each(function(el, i) {
                    params[i.name.replace(/filial\[(\w+)\]/, "$1")] = i.value;
                });

                $("#tbl_filial tr.info_filial [name],#"+selfID).attr('disabled', 'disabled');
                $.post(url_filial, params, function(data, statusText) {
                    $("#filial,#filial_nome,#filial_fantasia,#filial_cnpj,#"+selfID).removeAttr('disabled');
                    setACfilial();
                    if (data.indexOf('|') < 1) {
                        alert(data);
                        $("#tbl_filial tr.info_filial [name]").removeAttr('disabled');
                        return;
                    }
                    alert("Filial cadastrada.");
                    preencheFilial(data.split('|'));
                });
            });

            <? if ($encaminha_filial): ?>
            $("#sim_encaminha_filial").click();
            <? endif; ?>

            setACfilial();
            showHideFilial();
        }

    });

    <?php if ($login_fabrica == 156): ?>
    var url_filial = 'ajax_filial.php';

    function formatACfilial(row) {
        return (row.length > 1) ?
        row[2] + ' - ' + row[1] : // CNPJ-Razão social
            'Sem resultados';
    }

    function preencheFilial(data) {
        if (typeof data === 'string') {
            data = data.split('|');
        }
        if (Array.isArray(data) && data.length >= 12) {
            $("#filial").val(data[0]);
            $("#filial_nome").val(data[1]);
            $("#filial_cnpj").val(data[2]);
            $("#filial_ie").val(data[3]);
            $("#filial_fantasia").val(data[4]);
            $("#filial_fone").val(data[5]);
            $("#filial_cep").val(data[6]);
            $("#filial_endereco").val(data[7]);
            $("#filial_numero").val(data[8]);
            $("#filial_complemento").val(data[9]);
            $("#filial_bairro").val(data[10]);
            $("#filial_cidade").val(data[11]);
            $("#filial_estado").val(data[12]);
            $("#tbl_filial tr.info_filial [name]").attr('disabled', 'disabled');
            $("#filial,#filial_nome,#filial_fantasia,#filial_cnpj").removeAttr('disabled');
            $("#BtnSaveSubsidiary").hide();
            $("#BtnEditSubsidiary").show();


            $("#mapa_estado").val(data[12]);
            $("#mapa_cidade").val(data[11]);


            calcRoute();

        }
        return false;
    }

    function showHideFilial() {
        if ($("input:radio[name=encaminha_filial][checked]").val() == 't') {
            $("#tbl_filial tr.info_filial").show();
            setACfilial();
            $("#filial,#filial_nome,#filial_fantasia,#filial_cnpj").removeAttr('disabled');
        } else {
            $("#tbl_filial tr.info_filial").hide();
            removeACfilial();
            atualizaQuadroMapas();
            $("#tbl_filial tr.info_filial [name]").attr('disabled', 'disabled');
        }
    }

    function setACfilial() {
        if (window.filialAC === true) {
            return;
        }

    window.filialAC = true;

    }


    function consulta_filial(filters) {
        if (undefined === filters)
            return;
        if (typeof filters !== 'object')
            return false;

        $.get(
            url_filial,
            filters,
            function(retorno) {
                if (filters.search_by === 'cnpj' && filters.q.length === 18) {
                    if (retorno.indexOf('Nenhuma') > 1 && confirm('Cadastrar uma nova filial?')) {
                        $("#tbl_filial :disabled").val('').removeAttr('disabled');
                        $("#filial").val(''); // não deve enviar ID porque não deve ter...
                        $("#BtnSaveSubsidiary").show();
                        $("#BtnEditSubsidiary").hide();
                        removeACfilial();
                        return $(this).val();
                    }
                }
                preencheFilial(retorno);
        });
    }

    function removeACfilial() {
    if (typeof $("#filial_cnpj").autocomplete() === 'object') {
            // $("#filial_nome,#filial_fantasia,#filial_cnpj").removeClass('ac_input'); // 'inativa' o autocomplete
            $("#filial_cnpj,#filial_fantasia,#filial_nome").unbind('autocomplete');
        }
        $("#filial_cnpj,#filial_fantasia,#filial_nome").unbind('change');
        window.filialAC = false;
    }

    <?php endif; ?>

    function retiraAcentos1(obj) {
        re = /[^a-z^0-9\x20]/gi; // Expressão regular que localiza tudo que for diferente de caracteres a-Z ou 0-9 ou espaços
        obj.value = obj.value.replace(re, "");
    }

   function removeAcentojs (text){
        text = text.toLowerCase();
        text = text.replace(new RegExp('[ÁÀÂÃ]','gi'), 'a');
        text = text.replace(new RegExp('[ÉÈÊ]','gi'), 'e');
        text = text.replace(new RegExp('[ÍÌÎ]','gi'), 'i');
        text = text.replace(new RegExp('[ÓÒÔÕ]','gi'), 'o');
        text = text.replace(new RegExp('[ÚÙÛ]','gi'), 'u');
        text = text.replace(new RegExp('[Ç]','gi'), 'c');
        return text;
    } 

    //HD 201434 - Retirar acentos da digitação do nome do cliente
 function retiraAcentos(obj) {

        com_acento = '.áàãâäéèêëíìîïóòõôöúùûüçÁÀÃÂÄÉÈÊËÍÌÎÏÓÒÕÖÔÚÙÛÜÇ';
        sem_acento = '.aaaaaeeeeiiiiooooouuuucAAAAAEEEEIIIIOOOOOUUUUC';

        resultado = '';

        for (i = 0; i < obj.value.length; i++) {

            if (com_acento.search(obj.value.substr(i,1)) >= 0) {
                resultado += sem_acento.substr(com_acento.search(obj.value.substr(i,1)),1);
            } else {
                resultado += obj.value.substr(i,1);
            }

        }

        obj.value = resultado;

    }

    $(function() {
    <? if(in_array($login_fabrica,array(85,94))){ ?>
            $('#status_interacao').change(function(){
                var valor = $('#status_interacao option:selected').val();
                if(valor.toUpperCase() == 'RESOLVIDO'){
                    $('td#satisfacao').css("display","table-cell");
                    $('td#satisfacao').css("width","130px");
                }else{
                    $('td#satisfacao').css("display","none");
                }
            });
    <?php
    }

    if (in_array($login_fabrica, [52])) {
    ?>
        $('#status_interacao').on('change', function() {
            const value = $(this).val();

            if (value == 'Cancelado') {
                $('#abre_ordem_servico').prop({ checked: false });
            }
        });

        $('#status_interacao').trigger('change');
    <?php
    }

    if ((in_array($login_fabrica,array(52,85,138,145,142)) || isset($novaTelaOs)) && strlen($msg_erro) > 0) {
    ?>
        var tipo = "<?echo $consumidor_cpf_cnpj;?>";

        if (tipo == 'C') {
            $('#cpf').attr('maxLength', 14);
            $('#cpf').attr('size', 18);
           <?php if(in_array($login_fabrica, array(169,170))){ ?>
            $('#label_cpf').html('<label class="asteristico">*</label> CPF:');
           <?php }else{?>
            $('#label_cpf').html('CPF:');
            <?php } ?>

    <?
            if($login_fabrica == 85){
    ?>
                $("#label_nome").html("Nome:");
    <?
            }
    ?>
            $('#cpf').keypress (function(e) {
                return txtBoxFormat(document.frm_callcenter, this.name, '999.999.999-99', e);
            });
    } else {
        if (tipo == 'R') {

            $('#consumidor_cnpj').attr('checked', true);
            $('#cpf').attr('maxLength', 18);
            $('#cpf').attr('size', 23);
            $('#label_cpf').html('CNPJ:');
<?
            if($login_fabrica == 85){
?>
                $("#label_nome").html("Razão Social:");
<?
            }
?>
            $('#cpf').keypress(function(e) {
                return txtBoxFormat(document.frm_callcenter, this.name, '99.999.999/9999-99', e);
            });
        }
    }

<?php
}
?>
});
</script>
<script type="text/javascript">

<?php if ($login_fabrica == 52) { ?>
        // function verificarConsumidorPais() {
        //     if ($('select[name^=consumidor_pais]').val() != 'BR') {
        //         $('select[name^=consumidor_estado]').hide();
        //         $('select[name^=consumidor_cidade]').hide();
        //     } else {
        //         $('select[name^=consumidor_cidade]').show();
        //         $('select[name^=consumidor_estado]').show();
        //     }
        // }

        function recarrega_estados(paisHD, select_estado) {

            if (paisHD.length == 0) {
                paisHD = '<?=$paisHD;?>';
            }

            $("#consumidor_cidade").html('');
            $("#consumidor_cidade").append("<option value=''></option>");

            if (paisHD != 'BR') {
                $("#consumidor_estado").removeClass('addressState');
                $("#consumidor_cidade").removeClass('addressCity');
            }else{
                $("#consumidor_cidade").addClass('addressCity');
                $("#consumidor_estado").addClass('addressState');
            }

            $.ajax({
                url: "<?= $_SERVER['PHP_SELF']; ?>",
                type: "POST",
                data: {ajax_recarrega_estados_pais:true,pais:paisHD},
                complete: function(data){
                    let dados = JSON.parse(data.responseText);

                    if (dados.length > 0) {
                        select_estado.html("");
                        select_estado.append("<option value=''></option>");

                        $.each(dados, function(key, estados) {
                            select_estado.append("\
                                <option value='"+estados.sigla+"'>"+estados.descricao+"</option>\
                            ");
                        });
                    } else {
                        select_estado.html("");
                        select_estado.append("<option value=''></option>");
                        $("#consumidor_cidade").html('');
                        $("#consumidor_cidade").append("<option value=''></option>");
                    }
                }
            });
        }

        // $(document).on('change', 'select[name^=consumidor_pais]', function(){
        //     //verificarConsumidorPais();
        //     let paisHD = $("select[name^=consumidor_pais] option:selected").val();
        //     recarrega_estados(paisHD, $("#consumidor_estado"));
        // });

<?php } ?>

<?php if (in_array($login_fabrica,[52,161])) { ?>
        function verificarConsumidorPais(provincia) {
			$.ajax({
				url: "../provincias.php",
				type: "GET",
				data: {
					pais: $('select[name^=consumidor_pais]').val(),
					provincia: provincia
				}
			}).done(function(data) {

				if($('select[name^=consumidor_pais]').val() != 'BR') {
                    $('#consumidor_estado').find('option').remove();
                    $('#consumidor_cidade').find('option').remove();
					$("#consumidor_estado").removeClass('addressState');
					$("#consumidor_cidade").removeClass('addressCity');
                    if (data != '' && data != 'erro') {
                        data = JSON.parse(data);
                        $.each(data, function(c, d) { 
                            $("#consumidor_estado").append(d); 
                        });
                    }
				}else{
                    $('#consumidor_estado').find('option').remove();
                    $('#consumidor_cidade').find('option').remove();
					$("#consumidor_cidade").addClass('addressCity');
					$("#consumidor_estado").addClass('addressState');
                    if (data != '' && data != 'erro') {
                        data = JSON.parse(data);
                        $.each(data, function(c, d) { 
                            $("#consumidor_estado").append(d); 
                        });
                    }
				}

				if (data == 'erro') {

					$('#consumidor_estado').find('option').remove();
                    $('#consumidor_cidade').find('option').remove();
					consulta_estado_provincia($('select[name^=consumidor_pais]').val());
				}

			});

		}

		function llevaCiudad(provincia,pais) {
				$.ajax({
					url: "ajax_cidade.php",
					type: "POST",
					dataType: "JSON",
					data: {
						pais: pais,
						provincia: provincia,
						consultaCity: 'sim'
					}
				}).done(function(obj) {
					if (obj != null) {
						var data = obj;
						var selectbox = $('#consumidor_cidade');
						selectbox.find('option').remove();
						$.each(data, function (i, d) {
							$('<option>').val(d.cod_cidade).text(d.cidade).appendTo(selectbox);
						});
					}
				});
		}

        function consulta_estado_provincia(pais) {
            $.ajax({
                url: "ajax_cidade.php",
                type: "POST",
                dataType: "JSON",
                data: {
                    pais: pais,
                    consulta_estado_provincia: 'sim'
                }
            }).done(function(obj) {
                if (obj != null) {
                    var data = obj;
                    var selectbox = $('#consumidor_estado');
                    selectbox.find('option').remove();
                    $.each(data, function (i, d) {
                        $('<option>').val(d.estado).text(d.estado).appendTo(selectbox);
                    });
                } else {
                    llevaCiudad('',$('select[name^=consumidor_pais]').val());
                }
            });
        }

        $(document).on('change', 'select[name^=consumidor_pais]', function(){
            verificarConsumidorPais();
		});
		$(document).on('change', 'select[name^=consumidor_estado]', function(){
			if($('select[name^=consumidor_pais]').val() != 'BR') {
				llevaCiudad($(this).val(),$('select[name^=consumidor_pais]').val());
			}
        });

		$(document).ready(function() {
			var provincia = '<?=$_POST['consumidor_estado']?>';
			var ciudad = '<?=$_POST['consumidor_cidade']?>';
            let feB = '<?=$login_fabrica?>';

			if($('input[name=consumidor_estado_anterior]').val()) {
				provincia = $('input[name=consumidor_estado_anterior]').val();
			}

			if(($('select[name^=consumidor_pais]').val() != 'BR' && $('select[name^=consumidor_pais]').val() != '' && feB == 161) || ($('select[name^=consumidor_pais]').val() != 'BR' && $('select[name^=consumidor_pais]').val() != '' && feB == 52 && ciudad.length > 0) )  {
                verificarConsumidorPais(provincia);
				llevaCiudad(provincia,$('select[name^=consumidor_pais]').val());
				setTimeout(function(){
					if(ciudad.length > 0) {
						$('#consumidor_cidade').val(ciudad);
					}else{
						if($('input[name=consumidor_cidade_anterior]').val()) {
							$('#consumidor_cidade option').filter(function() { return $.trim( $(this).text() ) == $('input[name=consumidor_cidade_anterior]').val(); }).attr('selected','selected');
						}
					}
                },1500);


			}
		});

        <?php if ($login_fabrica == 52) { ?>

            $(document).on('change', 'select[name^=consumidor_pais]', function(){
                //verificarConsumidorPais();
                let paisHD = $("select[name^=consumidor_pais] option:selected").val();
                recarrega_estados(paisHD, $("#consumidor_estado"));
            });
        <?php } ?>
<?php } ?>

<?php if ($login_fabrica == 189) { ?>
        $(document).ready(function() {
            if ($('input[name=consumidor_cpf_cnpj]:checked').val() == "R") {
                $("input[name=consumidor_cpf]").mask("99.999.999/9999-99");
            } else {
                $("input[name=consumidor_cpf]").mask("999.999.999-99");
            }
        });
<?php } ?>

<?php if ($login_fabrica == 81) { ?>
        $(document).on('change', 'input[name^=produto_referencia]', function(){
            var ref = $('input[name=produto_referencia]').val();
            $("#solucao").html('');
            if (ref != '') {
                 $.ajax({
                    url: "callcenter_interativo_new.php",
                    type: "POST",
                    data: {
                        montaSolucao: true,
                        ref: ref
                    }
                }).done(function(data) {
                    $("#solucao").html(data);
                });
            }
        });
<?
    }

?>
var MAX_ANEXOS = <?=$max_anexos?>;

<?php if(!in_array($login_fabrica, array(169,170))){ #midea ?>
    $(window).load(function () {
        var categoria = "<?=$natureza_chamado?>";

        $("#container-Principal > ul > li").find("a[id="+categoria+"_click]").click();
    });
<?php } ?>

function abrir_anexo(anexo){
    window.open ("callcenter_interativo_anexo.php?anexo="+anexo, "Anexo", "status = yes, scrollbars=yes");
    abrir() ;
}
<?php
if ($login_fabrica == 24) :?>

    $().ready(function(){ // HD 751794

        function toggleOrientacao() {

            if ( $("#callcenter_assunto").attr('value') === 'produto_reclamacao' ) {

                $("#orientacao_uso").show();

            } else {

                $("#orientacao_uso").hide();

            }

        }

        toggleOrientacao();

        $("#callcenter_assunto").change(function(){

            toggleOrientacao();

        });

    });<?php

endif;?>

function remove_linha_produtos(posicao) {

    var total_produto = $('#qtde_produto').val();
    total_produto = total_produto - 1;
    $('#qtde_produto').val(total_produto);
    $('#tr-pd-'+posicao).remove();
}

function limpa_linha_produtos() {
        var cont = 1;
    $("#tabela_itens tbody tr").each(function(x, i){
	if (cont > 1) {
        $('#tr-pd-'+cont).remove();
    	}
        cont++;
    });
}


$(document).on('click', '.btn-limpa-linha-os', function(){
    let linhaAtual = $(this).data("linha");
     var hd_item = $(this).data("iditem");
        if(confirm("Deseja mesmo remover esse Item?")) {
            if (typeof hd_item !== "undefined" && hd_item != '') {
                $.ajax({
                    url: 'callcenter_interativo_new.php',
                    type: 'POST',
                    dataType: 'JSON',
                    data: {ajax_remove_hd_item: true, hd_chamado_item : hd_item},
                })
                .done(function(data) {
                    if (data.erro) {
                        alert("Erro ao remover item");
                        return false;
                    } else {

                        $("#tr-pd-" + linhaAtual).find("#produto_referencia_" + linhaAtual).val('');
                        $("#tr-pd-" + linhaAtual).find("#nota_fiscal_" + linhaAtual).val('');
                        $("#tr-pd-" + linhaAtual).find("#data_nf_" + linhaAtual).val('');
                        $("#tr-pd-" + linhaAtual).find("#qtde_prod_lancado_" + linhaAtual).val('');
                        $("#tr-pd-" + linhaAtual).find("#produto_nome_" + linhaAtual).val('');
                        $("#tr-pd-" + linhaAtual).find("#produto_" + linhaAtual).val('');
                        $("#tr-pd-" + linhaAtual).find("#preco_" + linhaAtual).val('');
                        $("#tr-pd-" + linhaAtual).find("#lote_" + linhaAtual).val('');
                        $("#tr-pd-" + linhaAtual).find("#defeito_reclamado_" + linhaAtual).val('');
                    }
                })
                .fail(function() {
                    alert("Erro ao remover item");
                    return false;
                });

            }
        }

});

$(document).on('click', '.btn-remove-os', function(){

    <?php if (in_array($login_fabrica, [186, 189])) {?>
        var linha = $(this).data("linha");
        var hd_item = $(this).data("iditem");
        if(confirm("Deseja mesmo remover esse Item?")) {

            if (typeof hd_item !== "undefined" && hd_item != '') {

                $.ajax({
                    url: 'callcenter_interativo_new.php',
                    type: 'POST',
                    dataType: 'JSON',
                    data: {ajax_remove_hd_item: true, hd_chamado_item : hd_item},
                })
                .done(function(data) {
                    if (data.erro) {
                        alert("Erro ao remover item");
                        return false;
                    } else {

                        $('#tr-pd-'+linha).remove();
                    }
                })
                .fail(function() {
                    alert("Erro ao remover item");
                    return false;
                });

            } else {
                $('#tr-pd-'+linha).remove();
            }
        }
        return false;
    <?php } else {?>
    var linha = $("#tabela_itens tr").length - 1;
    $('#qtde_produto').val(linha);

    if (typeof produtosTrocaDireta !== "undefined" && produtosTrocaDireta.length > 0) {
        let linhaAtual = $(this).data("linha");
        let referencia = $("#tr-pd-" + linhaAtual).find("#produto_referencia_" + linhaAtual).val();
        $.each(produtosTrocaDireta, function (index, element) {
            if (element.referencia == referencia) {
                produtosTrocaDireta.splice(index, 1);
                return false;
            }
        });
    }

    $('#tr-pd-'+$(this).data("linha")).remove();
    <?php }?>
});


$(document).on('change', 'input[name^=b_num_serie_]', function(){
    let disabled = ($(this).is(':checked')) ? false : true;
    $(this).closest("tr").find('textarea[name^=obs_num_serie_]').attr("disabled", disabled).text('');
});

<?php if ($moduloOSMultipla == "t"){ ?>
    function bloqueia_campos_produtos() {

        if ($("input[name='abre_ordem_servico']").is(':checked') == true){
            $(".produtos_lancados").each(function(x, i){
                x++;
                $('#defeito_reclamado_'+x+' option:not(:selected)').prop('disabled', true);

                $("#data_nf_"+x).attr("rel", "");
                $("#data_nf_"+x).attr("readonly", "readonly");
                $("#nota_fiscal_"+x).attr("readonly", "readonly");
                $("#serie_"+x).attr("readonly", "readonly");
                $("#produto_referencia_"+x).attr("readonly", "readonly").removeAttr("onblur");
                $("#produto_nome_"+x).attr("readonly", "readonly").removeAttr("onblur");
                $("#qtde_prod_lancado_"+x).attr("readonly", "readonly");
                $("#reclamado_cliente_produto_"+x).attr("readonly", "readonly");

                $("#produto_referencia_"+x).next("img").hide();
                $("#produto_nome_"+x).next("img").hide();


                $(".btn-remove-os").hide();
                $(".btn-add-os").show();
            });
        }
    }
<?php } ?>

function add_linha() {
    var linha = $("#tabela_itens tr").length + 1;
    $('#qtde_produto').val(linha);
    $("#tabela_itens").find('tbody').append("<tr rel='"+linha+"' id='tr-pd-"+linha+"'>"+$('#tr-pd-1').html()+"</tr>");

    <?php if ($login_fabrica == 189) {?>
    if (linha >= 2) {
        $('#tr-pd-'+linha+' td').each(function(){
            $(this).find('.btn-limpa-linha-os').remove();
        });
    }
    <?php }?>

    $('#tr-pd-'+linha+' td').each(function(){
        $(this).find('.lupa').attr("onclick","javascript: fnc_pesquisa_produto2 (document.frm_callcenter.produto_referencia_"+linha+",document.frm_callcenter.produto_nome_"+linha+",'referencia',mapa_linha, "+linha+")").show();
        $(this).find('.lupa-descricao').attr("onclick","javascript: fnc_pesquisa_produto2 (document.frm_callcenter.produto_referencia_"+linha+",document.frm_callcenter.produto_nome_"+linha+",'descricao',mapa_linha, "+linha+")").show();
        $(this).find('.btn-add-os').attr("src", "imagens/btn_delete.png").addClass("btn-remove-os").removeClass("btn-add-os").removeAttr("onclick").attr("data-linha", linha);
        $(this).find('input, select, textarea, button').each(function(){
            var name_input = $(this).attr("name");
            if (name_input !== undefined){
                name_input = name_input.substr(0, name_input.length - 2)+"_"+linha;
                var val = ($(this).attr("type") == 'checkbox') ? 't' : '';
                $(this).attr("id", name_input).attr("name", name_input).val(val).removeAttr('checked').removeAttr('onBlur').removeAttr("readonly");
                if ($(this).hasClass("hasDatepick")){
                    $(this).removeClass('hasDatepick').datepick({startDate:'01/01/2000'}).mask("99/99/9999");
                }

                <?php if ($moduloOSMultipla == "t"){ ?>
                    var campo_data = "data_nf_"+linha;
                    var campo_defeito = "defeito_reclamado_"+linha;

                    if (name_input == campo_data){
                        $("#"+name_input).attr("rel", "data");
                        $("input[rel='data']").datepick({startDate:'01/01/2000'});
                        $("input[rel='data']").mask("99/99/9999");
                    }
                    if (name_input == campo_defeito){
                        $("#"+name_input+" option").prop("disabled", false);
                    }
                <?php } ?>
                <?php if ($login_fabrica == 186){ ?>
                    $("#defeito_reclamado_"+linha).html("");
                <?php } ?>
            }
        });
    });
    setValidacaoAdmin();
    $("#btn_garantia_estendida_"+linha+"").hide();

    <?php if($login_fabrica == 178){ ?>
		$("#produto_nome_"+linha+"").attr({readonly: "readonly"});
    <?php } ?>

     <?php if($login_fabrica == 151){ ?>

        $("#produto_referencia_" + linha).attr('data-linha', linha);
        $("#btn_gerar_voucher_" + linha).attr('data-linha', linha);
        $("#voucher_codigo_" + linha).prop('readonly', true);
        $("#voucher_familia_" + linha).find('option').remove().end().append('<option value="">Escolha</option>').val('');

        $("#btn_gerar_voucher_" + linha).on("click", function(){
            gerarVoucher(this);
        });

        $("#produto_referencia_" + linha).blur(function(){

            var produto_referencia = $(this).val();
            var linha = $(this).data('linha');

            if(produto_referencia == ""){
                $("#voucher_familia_" + linha).find('[data-linha="'+linha+'"]').remove();
            }else{

                $.ajax({
                    url: 'callcenter_interativo_new.php',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        ajax_busca_familias_produto : true,
                        referencia_produto_familia : produto_referencia
                    },
                    success : function(response){
                       addOptionsSelectFamilia(response, linha);
                    }
                });
            }  
        });

    <?php } ?>
}


function function1(linha2) {

    var linha = document.getElementById('qtde_produto').value;
    linha = parseInt(linha) + 1;

    if (!document.getElementById('item'+linha)) {

        var tbl = document.getElementById('tabela_itens');
        //var lastRow = tbl.rows.length;
        //var iteration = lastRow;

        //Atualiza a qtde de linhas
        $('#qtde_produto').val(linha);

        /*Criar TR - Linha*/
        var nova_linha = document.createElement('tr');
        nova_linha.setAttribute('rel', linha);
        <?php if ($login_fabrica == 151): ?>
        nova_linha.setAttribute('id', 'tr-pd-'+linha);
        <?php endif;?>
        /********************* COLUNA 1 ****************************/
        <?php if ($login_fabrica == 151): ?>
        /*Cria TD */
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';
        celula.setAttribute('width', '5%');

        var el = document.createElement('label');
        el.innerHTML = '<strong>NF compra:</strong>';
        celula.appendChild(el);
        nova_linha.appendChild(celula);


        /*Cria TD */
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';
        celula.setAttribute('width', '8%');

        var el = document.createElement('input');
        el.setAttribute('type', 'text');
        el.setAttribute('name', 'nota_fiscal_' +linha);
        el.setAttribute('id', 'nota_fiscal_' + linha);
        el.setAttribute('maxlength', '10');
        el.setAttribute('class','input');
        el.style.cssText = 'width:80% !important;';

        celula.appendChild(el);
        nova_linha.appendChild(celula);

        /*Cria TD */
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';
        var el = document.createElement('label');
        el.innerHTML = '<strong>Data NF:</strong>';
        celula.appendChild(el);
        nova_linha.appendChild(celula);

        /*Cria TD */
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';
        celula.setAttribute('width', '5%');
        var el = document.createElement('input');
        el.setAttribute('type', 'text');
        el.setAttribute('name', 'data_nf_' +linha);
        el.setAttribute('id', 'data_nf_' + linha);
        el.setAttribute('maxlength', '10');
        el.setAttribute('class','input data');
        el.setAttribute('rel','data');


        el.style.cssText = 'width:80% !important;';
        celula.appendChild(el)
        nova_linha.appendChild(celula);

        <?php endif;?>

        /*Cria TD */
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';
        <?php if ($login_fabrica == 151): ?>
        celula.setAttribute('width', '3%');
        <?php endif; ?>

        var el = document.createElement('label');
        el.innerHTML = '<strong>Série:</strong>';
        celula.appendChild(el);
        nova_linha.appendChild(celula);

        /*Cria TD */
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';
        <?php if ($login_fabrica == 151): ?>
        celula.setAttribute('width', '8%');
        <?php endif;?>

        var el = document.createElement('input');
        el.setAttribute('type', 'text');
        el.setAttribute('name', 'serie_' +linha);
        el.setAttribute('id', 'serie_' + linha);
        el.setAttribute('class','input');
        <?php if ($login_fabrica != 151): ?>
        el.setAttribute('maxlength', '10');
        <?php endif;?>
        <?php if ($login_fabrica == 151): ?>
        el.setAttribute('maxlength', '13');
        el.style.cssText = 'width:80% !important;';
        <?php endif;?>

        celula.appendChild(el);
        <?php if ($login_fabrica == 52): ?>
        var el = document.createElement('img');
        el.setAttribute('src', 'imagens/lupa.png');
        el.setAttribute('border', '0');
        el.setAttribute('align', 'absmiddle');
        el.setAttribute('style', 'cursor: pointer');
        el.onclick = function(){
            var nome       = document.getElementById('produto_nome_'+linha);
            var produto    = document.getElementById('produto_referencia_'+linha);
            var mapa_linha = $('#mapa_linha'+linha);
            var serie      = document.getElementById('serie_'+linha);
            var ativo      = document.getElementById('numero_ativo_'+linha);
            fnc_pesquisa_serie(produto,nome,'serie',mapa_linha,serie, linha);
        }
        celula.appendChild(el);
        <?php endif;?>
        nova_linha.appendChild(celula);

        /********************* COLUNA 2 ****************************/
        /*Cria TD */
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';
        <?php if ($login_fabrica == 151): ?>
        celula.setAttribute('width', '5%');
        <?php endif;?>
        var el = document.createElement('label');
        el.innerHTML = '<strong>Referência:</strong>';
        celula.appendChild(el);
        nova_linha.appendChild(celula);

        /*Cria TD */
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';
        <?php if ($login_fabrica == 151): ?>
        celula.setAttribute('width', '10%');
        <?php endif;?>
        var el = document.createElement('input');
        el.setAttribute('type', 'text');
        el.setAttribute('name', 'produto_referencia_' +linha);
        el.setAttribute('id', 'produto_referencia_' + linha);
        el.setAttribute('size','15');
        el.setAttribute('class','input');
        <?php if ($login_fabrica == 151): ?>
        el.style.cssText = 'width:80% !important;';
        <?php endif;?>
        <?php if ($login_fabrica == 52): ?>
            el.onblur = function() {
                var nat = "Reclamado";
                var val = document.getElementById('produto_referencia_'+linha).value;
                var l = linha;
                mostraDefeitos(nat, val, l);
            }
        <?php endif; ?>
        celula.appendChild(el);
        var el = document.createElement('img');
        el.setAttribute('src', 'imagens/lupa.png');
        el.setAttribute('border', '0');
        el.setAttribute('align', 'absmiddle');
        el.setAttribute('style', 'cursor: pointer');

        el.onclick = function(){
            var nome       = document.getElementById('produto_nome_'+linha);
            var produto    = document.getElementById('produto_referencia_'+linha);
            var mapa_linha = $('#mapa_linha'+linha);
            fnc_pesquisa_produto2(produto,nome,'referencia',mapa_linha, linha);
        }

        celula.appendChild(el);
        nova_linha.appendChild(celula);

        /********************* COLUNA 3 ****************************/
        /*Cria TD */
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';
        <?php if ($login_fabrica == 151): ?>
        celula.setAttribute('width', '5%');
        <?php endif;?>
        var el = document.createElement('label');
        el.innerHTML = '<strong>Descrição:</strong>';
        celula.appendChild(el);
        nova_linha.appendChild(celula);

        /*Cria TD */
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';
        <?php if ($login_fabrica == 151): ?>
        celula.setAttribute('width', '10%');
        <?php endif;?>
        var el = document.createElement('input');
        el.setAttribute('type', 'text');
        el.setAttribute('name', 'produto_nome_' +linha);
        el.setAttribute('id', 'produto_nome_' + linha);
        el.setAttribute('size','20');
        el.setAttribute('class','input');
        <?php if ($login_fabrica == 151): ?>
        el.style.cssText = 'width:80% !important;';
        <?php endif;?>
        celula.appendChild(el);
        var el = document.createElement('img');
        el.setAttribute('src', 'imagens/lupa.png');
        el.setAttribute('border', '0');
        el.setAttribute('align', 'absmiddle');
        el.setAttribute('style', 'cursor: pointer');
        el.onclick = function(){
            var nome       = document.getElementById('produto_nome_'+linha);
            var produto    = document.getElementById('produto_referencia_'+linha);
            var mapa_linha = $('#mapa_linha'+linha);
            fnc_pesquisa_produto2(produto,nome,'descricao',mapa_linha, linha);
        }
        celula.appendChild(el);
        nova_linha.appendChild(celula);

        <?php if ($login_fabrica == 151): ?>
        /*Cria TD */
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';
        var el = document.createElement('label');
        el.innerHTML = '<strong>Voltagem:</strong>';
        celula.appendChild(el);
        nova_linha.appendChild(celula);


        /*Cria TD */
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';

        var el = document.createElement('input');
        el.setAttribute('type', 'text');
        el.setAttribute('name', 'voltagem_' +linha);
        el.setAttribute('id', 'voltagem_' + linha);
        el.setAttribute('size','15');
        el.setAttribute('class','input');
        celula.appendChild(el);
        nova_linha.appendChild(celula);

        <?php endif; ?>

        <?php if ($login_fabrica == 52 || $login_fabrica == 151): ?>
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';
        var el = document.createElement('label');
        el.innerHTML = '<strong>Defeito Reclamado  </strong>';
        celula.appendChild(el);
        nova_linha.appendChild(celula);

        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';
        //var array_defeitos = '<?  if ($login_fabrica == 52 ) { $sql = "SELECT distinct tbl_defeito_reclamado.descricao, tbl_defeito_reclamado.defeito_reclamado FROM tbl_diagnostico JOIN tbl_defeito_reclamado on tbl_diagnostico.defeito_reclamado = tbl_defeito_reclamado.defeito_reclamado AND tbl_defeito_reclamado.fabrica = $login_fabrica JOIN tbl_produto on tbl_diagnostico.linha = tbl_produto.linha and tbl_diagnostico.familia = tbl_produto.familia AND tbl_produto.fabrica_i = $login_fabrica WHERE tbl_diagnostico.fabrica = $login_fabrica AND tbl_diagnostico.ativo is true"; $res1 = pg_query ($con,$sql); if (pg_num_rows($res1) > 0) { for ($x = 0 ; $x < pg_num_rows($res1) ; $x++){$defeito_reclamado = trim(pg_fetch_result($res1,$x,defeito_reclamado)); $descricao  = trim(pg_fetch_result($res1,$x,descricao)); $descricao = substr($descricao,0,30); echo $defeito_reclamado;echo'/';echo $descricao;echo '|'; }   }  }?>';
        var array_defeitos = '<?
            if ($login_fabrica == 52  || $login_fabrica == 151) {
                $sql = "SELECT defeito_reclamado, descricao
                          FROM tbl_defeito_reclamado
                         WHERE fabrica = $login_fabrica
                           AND ativo
                         ORDER BY descricao";
                $res1 = pg_query ($con,$sql);
                if (pg_num_rows($res1) > 0) {
                    for ($x = 0 ; $x < pg_num_rows($res1) ; $x++){
                        $defeito_reclamado = trim(pg_fetch_result($res1,$x, 'defeito_reclamado'));
                        $descricao  = trim(pg_fetch_result($res1,$x, 'descricao'));
                        $descricao = substr($descricao,0,30);
                        echo "$defeito_reclamado/$descricao|";
                    }
                }
            }?>';

        teste_array = array_defeitos.split('|');
        var qtd = teste_array.length;
        var el = document.createElement("select");
        el.setAttribute('name', 'defeito_reclamado_' + linha);
        el.setAttribute('id', 'defeito_reclamado_' + linha);
        <?php if($login_fabrica == 52){ ?>
            el.setAttribute('onblur', 'fnc_valida_num_serie('+linha+')' );
        <?php } ?>

        el.setAttribute('class','input');
        elop=document.createElement("OPTION");
        elop.setAttribute('value','');
        texto1=document.createTextNode(" ");
        elop.appendChild(texto1);
        el.appendChild(elop);

        for ($i=0;$i<qtd;$i++) {
            var array = teste_array[$i].split('/');
            var codigo = array[0];
            var nome = array[1];

            if (codigo != '') {
                elop=document.createElement("OPTION");
                elop.setAttribute('value',codigo);
                texto1=document.createTextNode(nome);
                elop.appendChild(texto1);
                el.appendChild(elop);
            }
        }
        celula.appendChild(el);
        nova_linha.appendChild(celula);
        <?php endif; ?>
        <?php if ($login_fabrica == 151): ?>


        /*Cria TD */
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';

        var el = document.createElement('img');
        el.setAttribute('src', 'imagens/btn_delete.png');
        el.setAttribute('onclick', 'remove_linha_produtos('+linha+')');
        el.setAttribute('class','btn-remove-produto');
        el.setAttribute('alt','Remover Linha');
        el.setAttribute('style','cursor:pointer;');
        celula.appendChild(el);
        nova_linha.appendChild(celula);

        <?php endif; ?>
        <?php if ($login_fabrica == 52): ?>

        /********************* COLUNA 5 ****************************/

        /*Cria TD */
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: right;';
        var el = document.createElement('label');
        el.innerHTML = '<strong>nº Controle Cliente:</strong>';
        celula.appendChild(el);
        nova_linha.appendChild(celula);

        /*Cria TD */
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';

        var el = document.createElement('input');
        el.setAttribute('type', 'text');
        el.setAttribute('name', 'controle_cliente_' +linha);
        el.setAttribute('id', 'controle_cliente_' + linha);
        el.setAttribute('class','input');
        celula.appendChild(el);
        nova_linha.appendChild(celula);
        <?php endif; ?>
		/************ FINALIZA LINHA DA TABELA ***********/
		var tbody = document.createElement('TBODY');
		tbl.appendChild(tbody);

        <?php if ($login_fabrica == 52) { /*HD - 6165474*/ ?>
            var campo;
            campo = '<tr>'+
                '<td align="left"><strong>NF SaÃ­da Fricon:</strong></td>'+
                '<td align="left">'+
                    '<input name="nota_fiscal_fricon_' + linha + '" id="nota_fiscal_fricon_' + linha + '" class="input" value="" readonly="readonly">'+
                '</td>'+
                '<td align="left"><strong>Data NF Fricon:</strong></td>'+
                '<td align="left">'+
                    '<input name="data_nf_fricon_' + linha + '" id="data_nf_fricon_' + linha + '" class="input" value="" readonly="readonly">'+
                '</td>'+
            '</tr>';
            $(tbody).append(campo);
        <?php } ?>
        tbody.appendChild(nova_linha);

        /********************* COLUNA 6 ****************************/
        <?php if ($login_fabrica == 52): ?>
        /*Cria TD */
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';
        var el = document.createElement('label');
        el.innerHTML = '<strong>número do Ativo:</strong>';
        celula.appendChild(el);
        nova_linha.appendChild(celula);

        /*Cria TD */
        var celula = criaCelula('');
        celula.style.cssText = 'text-align: left;';

        var el = document.createElement('input');
        el.setAttribute('type', 'text');
        el.setAttribute('name', 'numero_ativo_' +linha);
        el.setAttribute('id', 'numero_ativo_' + linha);
        el.setAttribute('class','input');
        celula.appendChild(el);
        var el = document.createElement('img');
        el.setAttribute('src', 'imagens/lupa.png');
        el.setAttribute('border', '0');
        el.setAttribute('align', 'absmiddle');
        el.setAttribute('style', 'cursor: pointer');
        el.onclick = function(){
            var nome         = document.getElementById('produto_nome_'+linha);
            var produto      = document.getElementById('produto_referencia_'+linha);
            var mapa_linha   = $('#mapa_linha'+linha);
            var serie        = document.getElementById('serie_'+linha);
            var numero_ativo = document.getElementById('numero_ativo_'+linha);
            fnc_pesquisa_ordem(produto,nome,'ordem',mapa_linha,serie,numero_ativo,linha);
        }
        celula.appendChild(el);
        nova_linha.appendChild(celula);

        /********************* COLUNA 7,8 ****************************/
        /*Cria TD */
        var tdContent;
        tdContent = '<tr rel="'+linha+'">' +
                '<td></td>' +
                '<td>'+
                    '<input  id="perdeu_garantia_'+linha+'" type="checkbox" name="hd_perdeu_garantia_'+linha+'" class="chk-motivo">' +
                    '<label for="perdeu_garantia_'+linha+'"><strong>Perda de garantia</strong></label>' +
                '</td>' +
                '<td class="motivo-perda oculto">' +
                    '<label for="motivo_perda_gar_'+linha+'"><strong>Motivo Perda de Garantia:</strong></label>' +
                '</td>' +
                '<td class="motivo-perda oculto">' +
                    '<input  id="motivo_perda_gar_'+linha+'" type="text" name="hd_motivo_bloqueio_ns_'+linha+'" class="input" value="">' +
                '</td>' +
            '</tr>';

        /************ FINALIZA LINHA DA TABELA ***********/
        $(tbody).append(tdContent);
     <?php endif; ?>
         $(document).find(".data").datepick({startDate:'01/01/2000'});
         $(".data").mask("99/99/9999");

    }
}

function criaCelula(texto) {

    var celula = document.createElement('td');
    var textoNode = document.createTextNode(texto);
    celula.appendChild(textoNode);
    return celula;
}

var data, hoje, amanha;

$(function() {
    // !129655 - Carregar dÃºvidas já cadastradas para este chamado [augusto]
    // !133157 - Carregar dÃºvidas quando o usuário não selecionou a aba dÃºvida, ou seja, a dÃºvida de produto [augusto]
    <?php if (isset($callcenter) && ! empty($callcenter) && $login_fabrica <> 52 ) : ?>
        if (document.frm_callcenter.produto_referencia) {
            localizarFaq(document.frm_callcenter.produto_referencia.value,'faq_duvida_duvida','carregar');
            localizarFaq(document.frm_callcenter.produto_referencia.value,'faq_duvida_produto','carregar');
        }
    <?php endif; ?>
    <?php if ($login_fabrica == 52): ?>
        $('#tabela_itens').on('change', '.chk-motivo', function() {
            var active = $(this).is(':checked');
            var tr = $(this).parent().parent();
            var motivos = tr.find('.motivo-perda');
            active ? $(motivos).removeClass('oculto') : $(motivos).addClass('oculto');
            motivos.find('input')
                .attr('disabled', !active)
            .end();
    });
    <?php endif; ?>

    <?php if ($moduloOSMultipla == "t" AND !empty($callcenter)){ ?>
        bloqueia_campos_produtos();
    <?php } ?>

    <?php if ($login_fabrica == 189){ ?>
        var xcallcenter = '<?php echo $callcenter;?>';
        $("select[name=origem]").change(function(){
            var origem = $(this).val();
            $("select[name=hd_classificacao]").load("callcenter_interativo_new.php?ajax=carrega_classificacao&callcenter="+xcallcenter+"&origem="+origem);
        });

        $("select[name=hd_classificacao]").change(function(){
            var hd_classificacao = $(this).val();
            $("select[name=hd_subclassificacao]").load("callcenter_interativo_new.php?ajax=carrega_subclassificacao&callcenter="+xcallcenter+"&hd_classificacao="+hd_classificacao);
        });

        $("select[name=hd_subclassificacao]").change(function(){
            var hd_subclassificacao = $(this).val();
            $("select[name=hd_motivo_ligacao]").load("callcenter_interativo_new.php?ajax=carrega_providencia&callcenter="+xcallcenter+"&hd_subclassificacao="+hd_subclassificacao);
        });
/*
        $("select[name=hd_motivo_ligacao]").change(function(){
            var hd_motivo_ligacao = $("select[name=hd_motivo_ligacao] option:selected").text().toUpperCase().trim();
            if (hd_motivo_ligacao == "DEVOLUCAO PARCIAL" || hd_motivo_ligacao == "DEVOLUCAO TOTAL") {
                $(".oculta_registro_tr").show();
                $(".oculta_registro").show();
            } else if(hd_motivo_ligacao == "REENTREGA") {
                $(".oculta_registro_tr").show();
                $(".oculta_registro").hide();
            } else {
                $(".oculta_registro_tr").hide();
            }

        });*/

    <?php } ?>


});
<?php
if ($login_fabrica == 25 OR $login_fabrica == 59 OR $login_fabrica == 94) {
    $w = 1;
} else if ($login_fabrica == 45) {
    $w = 1;
    $posicao = $posicao-1;
} else if ($login_fabrica == 46) {
    $w = 1;
    $posicao = $posicao-1;
} else if ($login_fabrica == 2 OR $login_fabrica == 11 or $login_fabrica == 172) {
    $w = 1;
    $posicao = $posicao;
} else {
    $w = 1;
    if ($posicao >= 10) $posicao = $posicao-4;
    else                $posicao = $posicao-1;
}

if (!empty($callcenter) and empty($tab_atual) and is_numeric($callcenter)){
    $sql = "SELECT categoria
        FROM tbl_hd_chamado
        WHERE hd_chamado = $callcenter AND fabrica = $login_fabrica ";
    $res = pg_query($con,$sql);
    if(pg_num_rows($res) > 0) $tab_atual = pg_fetch_result($res,0,0);
}

if (($tab_atual == "informacao" and $login_fabrica == 81) or ($login_fabrica == 158 and empty($tab_atual))) {
    $posicao = 1;
    $tab_atual = "reclamacao_produto";
}
?>

function solicitaPostagem(hd_chamado) {
    var tipo_postagem = $('#tipo_postagem').val();
    var sedex_pac = $('#sedex_pac').val()
    var consumidor_final_nome = $('#consumidor_final_nome').val();
    var posto_cod = $('#codigo_posto_tab').val();
    var valor_nf = 0 ;
    var url_check = "";
    var volumes = "";
    var login_admin = '<?=$login_admin;?>';

    <?php if(in_array($login_fabrica, array(80))) { ?>

    if ($('#volumes').val()) {
        volumes = "&volumes="+$('#volumes').val();
    }

    <?php } ?>
    <?php if(in_array($login_fabrica, array(42, 164))) { ?>

        valor_nf = $("#valor_nf").val();
        if(valor_nf == '0,00' || valor_nf.length == 0){
            alert("Informe o valor da NF");
            return false;
        }

    <?php
    }

    if($login_fabrica == 162) {
    ?>
        valor_nf = $("#valor_nf").val();
        if(valor_nf == '0,00' || valor_nf.length == 0){
            alert("Informe o valor da NF");
            return false;
        }

        var numero_documento = $("#numero_documento").val(); //HD-3224475
        var checklist = $("#checklist").val(); //HD-3224475

        if(checklist == '5' && numero_documento.length == 0){
            alert("Inform o número do documento");
            return false;
        }

        url_check = "&checklist="+checklist+"&numero_documento="+numero_documento; //HD-3224475

    <?php
    }

    if (($telecontrol_distrib || in_array($login_fabrica, [160,174,186,191])) && !in_array($login_fabrica,[11,172])) { ?>
        var tela_solicitacao_postagem = "solicitacao_postagem_correios_multiplas.php";
    <?php
    } else { ?>
        var tela_solicitacao_postagem = "solicitacao_postagem_correios.php";
    <?php
    }
    ?>

    if(tipo_postagem != '' & sedex_pac != '') {

        <?php if ($login_fabrica == 151) { ?>
            if (consumidor_final_nome == '') {
                alert('Favor digitar a observação da postagem');
                $('#consumidor_final_nome').focus();
                return false;
            }
        <?php
        }
        ?>

        if (posto_cod == '') {
            alert("Favor cadastrar um Posto!");
            $('codigo_posto_tab').focus();
            return false;
        }

        //console.log('solicitacao_postagem_correios.php?hd_chamado='+ hd_chamado+'&tipo='+tipo_postagem+'&sedex_pac='+sedex_pac+'&obs='+consumidor_final_nome);
        Shadowbox.open({
            content :   tela_solicitacao_postagem+"?hd_chamado="+ hd_chamado+"&tipo="+tipo_postagem+"&sedex_pac="+sedex_pac+"&obs="+consumidor_final_nome+"&valor_nf="+valor_nf+"&login_admin="+login_admin+url_check+volumes,
            player  :   "iframe",
            title   :   "Autorização de Postagem",
            width   :   800,
            height  :   500
        });
    } else {
        alert('Escolha o tipo de postagem e Modo de Envio');
    }

}

<?php
if (in_array($login_fabrica, array(169, 170))) {
?>
    function bloqueia_campos_dealer () {
        $("#codigo_posto_tab").val('');
        $("#posto_nome_tab").val('');
        $("#posto_tab").val('');
        $("#instalador_nome").val('');
        //$("#posto_nome_tab").prop("readonly",true);
        //$("#codigo_posto_tab").prop("readonly", true);
        $("#bloqueia_campos_dealer").val('true');
    }

    var valida_garantia = function () {
        var produto = $("input[name=produto]").val();
        var data_nf = $("input[name=data_nf").val();
        var garantia = parseInt($("input[name=produto_garantia]").val());
        var instalador = $("input[name=instalador_id]").val();
        var os_cortesia = $("#hd_motivo_ligacao").children(":selected").data('os_cortesia');

        if (produto.length > 0 && data_nf.length == 10) {
            if (isNaN(garantia)) {
                alert("Produto sem garantia");
            } else {
                [dia, mes, ano] = data_nf.split("/");

                if ((new Date(ano+"-"+mes+"-"+dia)) != "Invalid Date") {
                    var termino_garantia = new Date(parseInt(ano), (parseInt(mes) - 1), parseInt(dia));
                    termino_garantia.setMonth(termino_garantia.getMonth() + garantia);

                    if (instalador.length > 0) {
                        var garantia_estendida = parseInt($(".garantia_estendida_tempo").val());

                        if (isNaN(garantia_estendida)) {
                            garantia_estendida = 0;
                        }

                        termino_garantia.setMonth(termino_garantia.getMonth() + garantia_estendida);
                    }

                    if (termino_garantia < (new Date) && os_cortesia != 't') {
                        alert("Produto fora da garantia, terminada em "+termino_garantia.toLocaleDateString());
                    }
                }
            }
        }
    }

    window.valida_garantia = valida_garantia;

    var valida_distancia = function (posto){

        var endereco        = $("#consumidor_endereco").val();
        var numero          = $("#consumidor_numero").val();
        var bairro          = $("#consumidor_bairro").val();
        var cep             = $("#consumidor_cep").val();
        var local_cidade    = $('#consumidor_cidade').val();
        var local_estado    = $('#consumidor_estado').val();

        Shadowbox.open({
            content:"<div style='background:#FFFFFF;height:100%;text-align:center;'><br><p style='font-size:12px;'>Validando distÃ¢ncia</p><br/><img width='20' src='imagens/loading_img.gif'/></div>",
            player:     "html",
            title:      "",
            width:      250,
            height:     80,
            options: {
                modal: true,
                enableKeys: false,
                onFinish: function(){
                    $("#sb-nav-close").hide();
                },
                overlayColor:'#fcfcfc'
            }
        });

        $.ajax({
            type: "POST",
            url: "<?=$_SERVER['PHP_SELF']?>",
            data: { valida_distancia: 'sim', posto:posto, endereco: endereco, numero: numero, bairro: bairro, cep: cep, local_cidade: local_cidade, local_estado: local_estado},
            timeout: 8000
        }).fail(function(){
            alert("Não foi possÃ­vel pesquisar a distÃ¢ncia, tempo limite esgotado! Tente novamente");
            $("#codigo_posto_tab").val('');
            $("#posto_nome_tab").val('');
            $("#posto_fone_tab").val('');
            $("#posto_email_tab").val('');
            $("#posto_tab").val('');
            Shadowbox.close();
        }).done(function(data) {
            data = JSON.parse(data);

            if (data.ok > 200){

            }else if (data.error == 'error'){
                setTimeout(function(){
                    Shadowbox.close();
                },1500);

                setTimeout(function(){
                    alert(data.error);
                    $("#codigo_posto_tab").val('');
                    $("#posto_nome_tab").val('');
                    $("#posto_fone_tab").val('');
                    $("#posto_email_tab").val('');
                    $("#mapa_linha").val('');
                    $("#posto_tab").val('');
                    $("#linhas_posto_tab").val('');
                },2000);
            }else{
                setTimeout(function(){
                    Shadowbox.close();
                },1500);
            }
        });
    }
    window.valida_distancia = valida_distancia;
<?php
}
?>

<?php
if ($validaGarantiaCallcenter) {
?>
    var valida_garantia = function () {
        var produto = $("input[name=produto]").val();
        var data_nf = $("input[name=data_nf").val();
        var garantia = parseInt($("input[name=produto_garantia]").val());

        if (produto.length > 0 && data_nf.length == 10) {
            if (isNaN(garantia)) {
                alert("Produto sem garantia");
            } else {
                [dia, mes, ano] = data_nf.split("/");

                if ((new Date(ano+"-"+mes+"-"+dia)) != "Invalid Date") {
                    var termino_garantia = new Date(parseInt(ano), (parseInt(mes) - 1), parseInt(dia));
                    termino_garantia.setMonth(termino_garantia.getMonth() + garantia);
                    if (termino_garantia < (new Date)) {
                        alert("Produto fora da garantia, terminada em "+termino_garantia.toLocaleDateString());
                    }
                }
            }
        }
    }

    window.valida_garantia = valida_garantia;
<?php
}
?>
function carrega_custos_atendimentos(callcenter) {
    $("#carrega_custos_atendimentos").load("callcenter_interativo_new.php?ajax=carrega_custos_atendimentos&callcenter="+callcenter);
}
$(function() {

    <?php if($login_fabrica == 189){ ?>
        carrega_custos_atendimentos($('input[name=callcenter]').val())
        $(".btn_custo_atendimento").click(function(){
            var admin = '<?php echo $login_admin;?>';
            Shadowbox.open({
                content:"modal_custo_por_setor.php?admin="+admin+"&callcenter="+$('input[name=callcenter]').val(),
                player:     "iframe",
                title:      "",
                width:      400,
                height:     200,
                options: {
                    modal: true,
                    enableKeys: false,
                    onFinish: function(){
                            $("#sb-nav-close").hide();
                        },
                }
            });
        });
        $(document).on("click", ".btn_edita_custo_atendimento", function(){
            var admin = '<?php echo $login_admin;?>';
            Shadowbox.open({
                content:"modal_edita_custo_por_setor.php?admin="+admin+"&setor="+$(this).data("setor")+"&callcenter="+$(this).data("chamado"),
                player:     "iframe",
                title:      "",
                width:      900,
                height:     400,
                options: {
                    modal: true
                }
            });
        });
    <?php }?>

});
$().ready(function() {

    <?php if(in_array($login_fabrica, array(151))) { ?>
        $("#consumidor_numero").numeric();
    <?php } ?>

    $(document).on('click', '#serv_install, #serv_conv, #serv_install_conv', function(){
        if ($(this).is(':checked')) {
            $('input[name=tipo_atendimento_anterior]').val($('input[name=tipo_atendimento]').val());
            $('input[name=tipo_atendimento]').val($(this).val());
        }else{
            $('input[name=tipo_atendimento]').val($('input[name=tipo_atendimento_anterior]').val());
        }
    });

    <?php if(in_array($login_fabrica, array(162,164))) { ?>
        //$("#valor_nf").numeric();
        $("#valor_nf").priceFormat({
            prefix: '',
            centsSeparator: ',',
            thousandsSeparator: '.'
        });

    <?php } ?>

    <?php if(in_array($login_fabrica, array(189))) { ?>
        //$("#valor_nf").numeric();
        $(".preco_pd").priceFormat({
            prefix: '',
            centsSeparator: ',',
            thousandsSeparator: '.'
        });

    <?php } ?>

    <?php
    if ($login_fabrica == 81) { ?>
        $("#valor_nf").maskMoney({prefix:'R$ ', allowNegative: false, thousands:'.', decimal:',', affixesStay: false});
    <?php
    }
    ?>

    //alert ('Aqui');
<?php

    if ($login_fabrica == 24) {
?>
        $('#container-Principal').tabs(<?=$posicao?>);
<?php
    } else {
?>
        $('#container-Principal').tabs(2);
<?php
    }


    if ($login_fabrica == 74 AND !empty($callcenter) and is_int($callcenter)){
        $sql = "
        SELECT admin
        FROM tbl_hd_chamado
        WHERE hd_chamado = $callcenter
        ";
        $res = pg_query($con,$sql);
        if(pg_num_rows($res) > 0) $admin = pg_fetch_result($res,0,0);
        //echo "alert ('$callcenter');";
        //echo "alert ('$admin');";
    }
    if ((strlen($callcenter) > 0) AND ($admin <> 6437) && !isset($novaTelaOs)) {
        for ($x = $w; $x < 12; $x++) {

            if ($x <> $posicao) {

                if (strlen($protocolo) == 0)  {
                ?>
                    var categoriaX = "<?=$categoria?>";
                    //if (categoriaX != "garantia_adicional") {
                        $('#container-Principal').disableTab(<?=$x?>);
                    //};

                <?php
                }

            }


        }

    }

?>
<?php if(in_array($login_fabrica, array(169,170))){ ?>
        var number_tabs = [1,2,3,4,5,6,7,8,9];
        var nummber_posicao = <?=$posicao?>;
        number_tabs.map(function(v){
            if(nummber_posicao != v){
                $('#container-Principal').disableTab(parseInt(v));
                $('.tab_content, .tabs-container').addClass('tabs-hide');
            }
        });

        var ativar_tabs = $("#tabs_ativas").val();
        var tab_atual = $("#tab_atual").val();

        if(ativar_tabs.length > 0){
            ativar_tabs = ativar_tabs.split(",");
            $("#container-Principal > ul > li").addClass('tabs-disabled');
            ativar_tabs.map(function(y){
                $('a[rel="'+y+'"]').parent().removeClass();
            });
            $("#"+tab_atual).removeClass('tabs-hide');
            $('a[rel="'+tab_atual+'"]').parent().addClass('tabs-selected');
        }
<?php }else{
        if ((strlen($callcenter) > 0) AND (!empty($tab_atual)) && isset($novaTelaOs)) {
            for ($x = $w; $x < 12; $x++) {
                if ($x <> $posicao) {
                    if (strlen($protocolo) == 0)  {
?>
                        $('#container-Principal').disableTab(<?=$x?>);
<?php
                    }
                }
            }
        }
    }
    ?>

    //$('#container').disableTab(3);
    //fxAutoHeight: true,
    <? if(!empty($callcenter) && $login_fabrica != 161) { ?>
    if($("input[name=consumidor_cpf]").val().length > 14) {
        $("input[name=consumidor_cpf]").mask("99.999.999/9999-99");
    } else {
        $("input[name=consumidor_cpf]").mask("999.999.999-99");

    }
    <? }?>
    $(".contador").numeric();//HD-3428316Brother
    $("#consumidor_cep").mask("99999-999");
    $("#hora_ligacao").mask("99:99");

    <?php if(in_array($login_fabrica, array(30))){ ?>
                $("#data_prov").removeAttr("rel").attr({readonly : true});

    <?php } ?>

    <?php if(in_array($login_fabrica, array(169,170))){ ?>
        $("input[rel='data']").datepick({ maxDate: 0, startDate: "01/01/2000'"});

        if ($("input[name=consumidor_cpf]").val() != ""){
            if ($("input[name=consumidor_cpf]").val().length <= 14){
                $("input[name=consumidor_cpf]").mask("999.999.999-99");
            }else{
                $("input[name=consumidor_cpf]").mask("99.999.999/9999-99");
            }
        }else{
            $("input[name=consumidor_cpf]").mask("999.999.999-99");
        }


    <?php }else{ ?>
        $("input[rel='data']").datepick({startDate:'01/01/2000'});
    <?php } ?>
    $("input[rel='data']").mask("99/99/9999");
    $("input[rel='mes_ano']").mask("99/9999");
    $("#data_abertura").mask("99/99/9999");
    $("#expedicao").mask("99/99/9999");
    //$("#localizar_telefone").mask("(99) 9999-9999");
    $("#localizar_cep").mask("99999-999");

    <?
    if(!empty($tab_atual)){
        $xtab_atual = $tab_atual;

        if ($tab_atual == "informacao" and $login_fabrica == 81) :
            $xtab_atual = "reclamacao_produto";
        endif;
    ?>
        $("#<?php echo $xtab_atual.'_click'; ?>").click();
    <?}?>
    //$('#cpf').keypress();
    <?if ($login_fabrica == 86) { ?>
    var motivo_atendimento = '<?=$hd_motivo_ligacao?>';
    var consumidor_revenda = '<?=$consumidor_revenda?>';
    if(motivo_atendimento != ''){
        comboMotivo(consumidor_revenda,motivo_atendimento);
    }

    $('#consumidor_revenda').change(function(){
        var tipo = $(this).val();
        comboMotivo(tipo,motivo_atendimento);
    });
    <?}?>

    <?if ($login_fabrica == 74) { ?>
        var status_atual = "<?=$hd_chamado_status?>";

        if(status_atual.toUpperCase() == "RESOLVIDO" || status_atual == "PROTOCOLO DE INFORMACAO"){
            bloquear_campos();
            if(status_atual.toUpperCase() == "RESOLVIDO"){
                $("#continuar_chamado").find("input[type=button]").removeAttr("disabled");
            }
        }

        if(status_atual.toUpperCase() != "RESOLVIDO"){
            $("#continuar_chamado").find("input[type=button]").attr({'disabled':true});
        }

    <?}?>

});

function formatItem(row) {
    return row[1] + " - " + row[2];
}

function formatItemNomeRevenda(row) {
    return row[1] + " - " + row[2] + " - " + row[3];
}

function formatItemPosto(row) {
    return row[2] + " - " + row[3] + " (Fantasia:" + row[4] + ")";
}

function formatCliente(row) {
    return row[2] + " - " + row[3] + " - Cidade: " + row[4];
}

function formatLocalizar(row) {

    var data        = "";
    var nota_fiscal = "";
    var serie       = "";
    var cep         = "";

    if (row[0] == "erro") {
        return "Erro: " + row[1];
    }

    switch(row[24]) {

        case "O":
            sua_os = row[16];
            atendimento = row[22];
        break;

        case "C":
            sua_os = row[16];
            atendimento = row[0];
        break;

        case "R":
            sua_os = 0;
            atendimento = 0;
        break;

        case "A":
            sua_os = 0;
            atendimento = 0;
        break;

        default:
            sua_os = 0;
            atendimento = 0;

    }

    switch(row[28]) {

        case "O":
            sua_os = row[16];
            atendimento = row[22];
        break;

        case "C":
            sua_os = row[25];
            atendimento = row[0];
        break;
    }

    if (atendimento) {
        atendimento = "Chamado: " + atendimento;
    } else {
        atendimento = "<font style='font-size: 7pt; font-weight: bold; background-color: #CC5555; color: #FFFFFF;'>SEM ATENDIMENTO</font>";
    }

    if (sua_os) {
        sua_os = "OS: " + sua_os;
    } else {
        sua_os = "<font style='font-size: 7pt; font-weight: bold; background-color: #CC5555; color: #FFFFFF;'>SEM OS</font>";
    }

    if (row[18]) {
        nota_fiscal = " Nota Fiscal: " + row[18];
    }

    if (row[17]) {
        serie = " Série: " + row[17];
    }

    if (row[6]) {
        cep = " Cep: " + row[6];
    }

    return atendimento + " - Cliente: " + row[1] + " - " + sua_os + nota_fiscal + serie + cep;

}
function bindEventClienteNomeAdmin(reference) {
    if ( reference == undefined ) {
        reference = $('BODY').get(0);
    }
    $("#cliente_nome_admin",reference).autocomplete("<?= $PHP_SELF.'?tipo_busca=cliente_admin&busca=nome'; ?>", {
        minChars: 3,
        delay: 150,
        width: 350,
        max: 30,
        matchContains: true,
        formatItem: formatCliente,
        formatResult: function(row) {
        return row[3];
        }
    });
}

    function abreOs(elem) {
            if ($(elem).is(":checked")) {
                $("#os").val("");
                valida_garantia();
            //} else {
            //    $("#os").prop({ readonly: false });
            //    $(".lupa_os_consumidor").show();
            }

        }

    function abreOrdemServico(elem) {

        <?php if ($login_fabrica == 171){ ?>
            if ($(elem).attr("checked") && ($("select[name=tipo_atendimento_grohe]>option:selected").attr("km-google") == 't')) {
                $("#div_data_agendamento_ordem").show();
                $("#div_periodo_agendamento_ordem").show();
                if ($('#data_agendamento_ordem').val().length == 0) {
                    $("#data_agendamento_ordem").datepick("setDate", defaultAgenda);
                }
            }else{
                $("#div_data_agendamento_ordem").hide();
                $("#div_periodo_agendamento_ordem").hide();
            }

            if ($(elem).is(":checked")) {
                $("#os").val("");
            }

        <?php }else{ ?>
            setor_atividade();
            if ($(elem).attr("checked") && ($(".produto_deslocamento").val() == 't' || $("#os_cortesia").val() == 't')) {
                $("#div_data_agendamento_ordem").show();
                $("#div_periodo_agendamento_ordem").show();
                if ($('#data_agendamento_ordem').val().length == 0) {
                    $("#data_agendamento_ordem").datepick("setDate", defaultAgenda);
                }
            } else {
                $("#div_data_agendamento_ordem").hide();
                $("#div_periodo_agendamento_ordem").hide();
            }

            if ($(elem).is(":checked")) {
                $("#os").val("");
                valida_garantia();
            }
        <?php } ?>
    }
<? if(in_array($login_fabrica,array(169,170))) { ?>

    MutationObserver = window.MutationObserver || window.WebKitMutationObserver;
    var trackChange = function(element) {
        var observer = new MutationObserver(function(mutations, observer) {
            if(mutations[0].attributeName == "value") {
                $(element).trigger("change");
            }
        });
        observer.observe(element, {
            attributes: true
        });
    }

    var feriados = <?=$feriados?>;
    var dados_bloqueio = "";
    var array_date_ag = [];
    var array_date_ag_desc = {};

    function blockedDays(date, inMonth) {
        if (inMonth) {
            if (date.getDay() == 0 || date.getDay() == 6) {
                return {
                    selectable: false
                }
            }else if ($.inArray(date.dateToString("/"), feriados) != -1 || $.inArray(date.dateToString("/"), array_date_ag) != -1){
                return {
                    selectable: false,
                    dateClass: 'demo',
                    title: array_date_ag_desc[date.dateToString("/")]
                }
            }
        }
        return {};
    }

    $(function(){
        trackChange($("#posto_tab")[0]);
        $("#posto_tab").change(function() {
            var id_posto_tab = $("#posto_tab").val();
            var mapa_linha   = $("#mapa_linha").val();
            array_date_ag    = [];
            dados_bloqueio   = "";

            $.ajax({
                url: window.location,
                type: "POST",
                data: {
                    ajax:         'sim',
                    acao:         "pesquisa_agenda_bloqueio",
                    id_posto_tab: id_posto_tab,
                    mapa_linha:   mapa_linha
                },
                timeout: 6000
            }).fail(function(){
                setTimeout(function(){
                    Shadowbox.open({
                        content:"<div style='background:#FFFFFF;height:100%;text-align:center;'><br><p style='font-size:12px;'>Pesquisando informações do posto autorizado</p><br/><img width='20' src='imagens/loading_img.gif'/></div>",
                        player:     "html",
                        title:      "",
                        width:      250,
                        height:     80,
                        options: {
                            modal: true,
                            enableKeys: false,
                            onFinish: function(){
                                $("#sb-nav-close").hide();
                            },
                            overlayColor:'#fcfcfc'
                        }
                    });
                    $("#posto_tab").val(id_posto_tab);
                }, 700);
            }).done(function(data, idx) {
                if (typeof data != undefined && data != null && data.length > 0 && idx == "success"){
                    defaultAgenda = new Date(agendaDefault.getFullYear(), agendaDefault.getMonth(), agendaDefault.getDate());

                    data = JSON.parse(data);
                    if (data != null && data.messageError == undefined) {
                        dados_bloqueio = data;
                        $(dados_bloqueio).each(function(idx, element){
                            var startDateAg = new Date(element.data_inicio);
                            var stoptDateAg = new Date(element.data_final);
                            var datas_ag = (new Date).getDates(startDateAg, stoptDateAg);

                            datas_ag.forEach(function(date, i) {
                                array_date_ag.push(date.dateToString('/'));
                                array_date_ag_desc[date.dateToString('/')] = element.descricao;
                            });
                        });

                        while (defaultAgenda.getDay() == 0 || defaultAgenda.getDay() == 6 || $.inArray(defaultAgenda.dateToString("/"), feriados) != -1 || $.inArray(defaultAgenda.dateToString("/"), array_date_ag) != -1) {
                            if (defaultAgenda.getDay() == 0) {
                                defaultAgenda.setDate(defaultAgenda.getDate() + 2);
                            } else if (defaultAgenda.getDay() == 6) {
                                defaultAgenda.setDate(defaultAgenda.getDate() + 2);
                            } else if ($.inArray(defaultAgenda.dateToString("/"), feriados) != -1) {
                                defaultAgenda.setDate(defaultAgenda.getDate() + 1);
                            }else if ($.inArray(defaultAgenda.dateToString("/"), array_date_ag) != -1){
                                defaultAgenda.setDate(defaultAgenda.getDate() + 1);
                            }
                        }

                        var get_datas = (new Date()).getDates(defaultAgenda.addDays(1), defaultAgenda.addDays(3));
                        var maxDate = get_datas[2];

                        if (get_datas[2].getDay() == 0) {
                            maxDate.setDate(maxDate.getDate() + 2);
                        }

                        if (get_datas[2].getDay() == 6) {
                            maxDate.setDate(maxDate.getDate() + 2);
                        }
                        get_datas.forEach(function(d, i) {
                            if (d.getDay() == 0) {
                                maxDate.setDate(maxDate.getDate() + 2);
                            } else if (d.getDay() == 6) {
                                maxDate.setDate(maxDate.getDate() + 2);
                            } else if ($.inArray(d.dateToString("/"), feriados) != -1) {
                                maxDate.setDate(maxDate.getDate() + 1);
                            }else if ($.inArray(d.dateToString("/"), array_date_ag) != -1){
                                maxDate.setDate(maxDate.getDate() + 1);
                            }
                            while (maxDate.getDay() == 0 || maxDate.getDay() == 6 || $.inArray(maxDate.dateToString("/"), feriados) != -1 || $.inArray(maxDate.dateToString("/"), array_date_ag) != -1) {
                                if (maxDate.getDay() == 0) {
                                    maxDate.setDate(maxDate.getDate() + 2);
                                } else if (maxDate.getDay() == 6) {
                                    maxDate.setDate(maxDate.getDate() + 2);
                                } else if ($.inArray(maxDate.dateToString("/"), feriados) != -1) {
                                    maxDate.setDate(maxDate.getDate() + 1);
                                }else if ($.inArray(maxDate.dateToString("/"), array_date_ag) != -1){
                                    maxDate.setDate(maxDate.getDate() + 1);
                                }
                            }
                        });

                        $("#data_agendamento_ordem").datepick('destroy').val("");
                        $("#data_agendamento_ordem").datepick({maxDate: maxDate, onDate: blockedDays}).mask("99/99/9999");

                        setTimeout(function() {
                            $("#data_agendamento_ordem").datepick('setDate', defaultAgenda).attr("readonly", "readonly");
                        }, 500);

                    }else{
                        dados_bloqueio = [];

                        while (defaultAgenda.getDay() == 0 || defaultAgenda.getDay() == 6 || $.inArray(defaultAgenda.dateToString("/"), feriados) != -1 || $.inArray(defaultAgenda.dateToString("/"), array_date_ag) != -1) {
                            if (defaultAgenda.getDay() == 0) {
                                defaultAgenda.setDate(defaultAgenda.getDate() + 2);
                            } else if (defaultAgenda.getDay() == 6) {
                                defaultAgenda.setDate(defaultAgenda.getDate() + 2);
                            } else if ($.inArray(defaultAgenda.dateToString("/"), feriados) != -1) {
                                defaultAgenda.setDate(defaultAgenda.getDate() + 1);
                            }else if ($.inArray(defaultAgenda.dateToString("/"), array_date_ag) != -1){
                                defaultAgenda.setDate(defaultAgenda.getDate() + 1);
                            }
                        }
                        $("#data_agendamento_ordem").datepick('destroy').val("");
                        $("#data_agendamento_ordem").datepick({maxDate: defaultAgenda.addDays(3), onDate: blockedDays}).mask("99/99/9999");
                        setTimeout(function() {
                            $("#data_agendamento_ordem").datepick('setDate', defaultAgenda).attr("readonly", "readonly");
                        }, 500);
                    }
                }else{
                    $("#posto_tab").val(id_posto_tab);
                }
            });
        });

        <?php if(in_array($login_fabrica, array(169))){ ?>
        $(document).ready(function(){
            var id_posto_banco = "<?=$posto?>";
            var mapa_linha     = $("#mapa_linha").val();
            array_date_ag      = [];
            dados_bloqueio     = "";

            if(id_posto_banco != ""){
                $.ajax({
                    url: window.location,
                    type: "POST",
                    data: {
                        ajax:         'sim',
                        acao:         "pesquisa_agenda_bloqueio",
                        id_posto_tab: id_posto_banco,
                        mapa_linha:   mapa_linha
                    },
                    timeout: 6000
                }).fail(function(){
                    setTimeout(function(){
                        Shadowbox.open({
                            content:"<div style='background:#FFFFFF;height:100%;text-align:center;'><br><p style='font-size:12px;'>Pesquisando informações do posto autorizado</p><br/><img width='20' src='imagens/loading_img.gif'/></div>",
                            player:     "html",
                            title:      "",
                            width:      250,
                            height:     80,
                            options: {
                                modal: true,
                                enableKeys: false,
                                onFinish: function(){
                                    $("#sb-nav-close").hide();
                                },
                                overlayColor:'#fcfcfc'
                            }
                        });
                    }, 700);
                }).done(function(data, idx) {
                    if (typeof data != undefined && data != null && data.length > 0 && idx == "success"){
                        defaultAgenda = new Date(agendaDefault.getFullYear(), agendaDefault.getMonth(), agendaDefault.getDate());

                        data = JSON.parse(data);
                        if (data != null && data.messageError == undefined) {
                            dados_bloqueio = data;
                            $(dados_bloqueio).each(function(idx, element){
                                var startDateAg = new Date(element.data_inicio);
                                var stoptDateAg = new Date(element.data_final);
                                var datas_ag = (new Date).getDates(startDateAg, stoptDateAg);

                                datas_ag.forEach(function(date, i) {
                                    array_date_ag.push(date.dateToString('/'));
                                    array_date_ag_desc[date.dateToString('/')] = element.descricao;
                                });
                            });

                            while (defaultAgenda.getDay() == 0 || defaultAgenda.getDay() == 6 || $.inArray(defaultAgenda.dateToString("/"), feriados) != -1 || $.inArray(defaultAgenda.dateToString("/"), array_date_ag) != -1) {
                                if (defaultAgenda.getDay() == 0) {
                                    defaultAgenda.setDate(defaultAgenda.getDate() + 2);
                                } else if (defaultAgenda.getDay() == 6) {
                                    defaultAgenda.setDate(defaultAgenda.getDate() + 2);
                                } else if ($.inArray(defaultAgenda.dateToString("/"), feriados) != -1) {
                                    defaultAgenda.setDate(defaultAgenda.getDate() + 1);
                                }else if ($.inArray(defaultAgenda.dateToString("/"), array_date_ag) != -1){
                                    defaultAgenda.setDate(defaultAgenda.getDate() + 1);
                                }
                            }

                            var get_datas = (new Date()).getDates(defaultAgenda.addDays(1), defaultAgenda.addDays(3));
                            var maxDate = get_datas[2];

                            if (get_datas[2].getDay() == 0) {
                                maxDate.setDate(maxDate.getDate() + 2);
                            }

                            if (get_datas[2].getDay() == 6) {
                                maxDate.setDate(maxDate.getDate() + 2);
                            }
                            get_datas.forEach(function(d, i) {
                                if (d.getDay() == 0) {
                                    maxDate.setDate(maxDate.getDate() + 2);
                                } else if (d.getDay() == 6) {
                                    maxDate.setDate(maxDate.getDate() + 2);
                                } else if ($.inArray(d.dateToString("/"), feriados) != -1) {
                                    maxDate.setDate(maxDate.getDate() + 1);
                                }else if ($.inArray(d.dateToString("/"), array_date_ag) != -1){
                                    maxDate.setDate(maxDate.getDate() + 1);
                                }
                                while (maxDate.getDay() == 0 || maxDate.getDay() == 6 || $.inArray(maxDate.dateToString("/"), feriados) != -1 || $.inArray(maxDate.dateToString("/"), array_date_ag) != -1) {
                                    if (maxDate.getDay() == 0) {
                                        maxDate.setDate(maxDate.getDate() + 2);
                                    } else if (maxDate.getDay() == 6) {
                                        maxDate.setDate(maxDate.getDate() + 2);
                                    } else if ($.inArray(maxDate.dateToString("/"), feriados) != -1) {
                                        maxDate.setDate(maxDate.getDate() + 1);
                                    }else if ($.inArray(maxDate.dateToString("/"), array_date_ag) != -1){
                                        maxDate.setDate(maxDate.getDate() + 1);
                                    }
                                }
                            });

                            $("#data_agendamento_ordem").datepick('destroy').val("");
                            $("#data_agendamento_ordem").datepick({maxDate: maxDate, onDate: blockedDays}).mask("99/99/9999");

                            setTimeout(function() {
                                $("#data_agendamento_ordem").datepick('setDate', defaultAgenda).attr("readonly", "readonly");
                            }, 500);

                        }else{
                            dados_bloqueio = [];

                            while (defaultAgenda.getDay() == 0 || defaultAgenda.getDay() == 6 || $.inArray(defaultAgenda.dateToString("/"), feriados) != -1 || $.inArray(defaultAgenda.dateToString("/"), array_date_ag) != -1) {
                                if (defaultAgenda.getDay() == 0) {
                                    defaultAgenda.setDate(defaultAgenda.getDate() + 2);
                                } else if (defaultAgenda.getDay() == 6) {
                                    defaultAgenda.setDate(defaultAgenda.getDate() + 2);
                                } else if ($.inArray(defaultAgenda.dateToString("/"), feriados) != -1) {
                                    defaultAgenda.setDate(defaultAgenda.getDate() + 1);
                                }else if ($.inArray(defaultAgenda.dateToString("/"), array_date_ag) != -1){
                                    defaultAgenda.setDate(defaultAgenda.getDate() + 1);
                                }
                            }
                            $("#data_agendamento_ordem").datepick('destroy').val("");
                            $("#data_agendamento_ordem").datepick({maxDate: defaultAgenda.addDays(3), onDate: blockedDays}).mask("99/99/9999");
                            setTimeout(function() {
                                $("#data_agendamento_ordem").datepick('setDate', defaultAgenda).attr("readonly", "readonly");
                            }, 500);
                        }
                    }
                });
            }
        });
        <?php } ?>
    });
<? }else{ ?>
var feriados = [];
var dados_bloqueio = [];
<? } ?>

<?php $agendaDate = new DateTime();
$agendaDate = (date('N') == 6) ? $agendaDate->modify('+2 day') : (date('N') == 0) ? $agendaDate->modify('+1 day') : $agendaDate;
?>

var defaultAgenda = new Date('<?= $agendaDate->format('M, d Y H:i:s') ?>');
defaultAgenda.setDate(defaultAgenda.getDate() + 2);

while (defaultAgenda.getDay() == 0 || defaultAgenda.getDay() == 6 || $.inArray(defaultAgenda.dateToString("/"), feriados) != -1) {
    if (defaultAgenda.getDay() == 0) {
        defaultAgenda.setDate(defaultAgenda.getDate() + 2);
    } else if (defaultAgenda.getDay() == 6) {
        defaultAgenda.setDate(defaultAgenda.getDate() + 2);
    } else if ($.inArray(defaultAgenda.dateToString("/"), feriados) != -1) {
        defaultAgenda.setDate(defaultAgenda.getDate() + 1);
    }
}
var agendaDefault = new Date();
if (agendaDefault.getDay() == 0) {
	agendaDefault.setDate(agendaDefault.getDate() + 3);
} else if (agendaDefault.getDay() == 6) {
	agendaDefault.setDate(agendaDefault.getDate() + 4);
} else if ($.inArray(agendaDefault.dateToString("/"), feriados) != -1) {
	agendaDefault.setDate(agendaDefault.getDate() + 3);
}else{
	agendaDefault.setDate(agendaDefault.getDate() + 2);
}

$().ready(function() {
    <?php if($login_fabrica == 74){?>
        $('#btn_calcula_km').hide();
    <?php } ?>
   $("#filial_nome").autocomplete("ajax_filial.php?search_by=nome&ajax=ajax", {
        minChars: 3,
        delay: 150,
        width: 350,
        matchContains: true,
        formatItem: function(row) {
          if (row.length > 2) {
            return row[1] + " - " + row[2];
          }
          return row[1];
        },
        formatResult: function(row) {
            if (row.length > 2) {
              return row[1];
            }
        }
    });

    $("#filial_cnpj").autocomplete("ajax_filial.php?search_by=cnpj&ajax=ajax", {
        minChars: 3,
        delay: 150,
        width: 350,
        matchContains: true,
        formatItem: function(row) {
          if (row.length > 2) {
            return row[1] + " - " + row[2];
          }
          return row[1];
        },
        formatResult: function(row) {
            if (row.length > 2) {
              return row[2];
            }
        }
    });

    $("#filial_fantasia").autocomplete("ajax_filial.php?search_by=fantasia&ajax=ajax", {
        minChars: 3,
        delay: 150,
        width: 350,
        matchContains: true,
        formatItem: function(row) {
          if (row.length > 2) {
            return row[4] + " - " + row[2];
          }
          return row[1];
        },
        formatResult: function(row) {
            if (row.length > 2) {
              return row[4];
            }
        }
    });

    $("#filial_nome,#filial_cnpj,#filial_fantasia").result(function(event, data){
      preencheFilial(data);
    });

<?php
if($login_fabrica == 11 or $login_fabrica == 172){
?>

    $('#cpf').autocomplete('pesquisa_consumidor_callcenter_nv?tipo_pesquisa=cpf&ajax=sim',{
        minChars:6,
        delay: 700,
        width: 300,
        max: 30,
        matchContains:true,
        formatItem: formatLocalizar,
        formatResult: function(row){
            return $('#cpf').val();
        }
    });

    $('#cpf').result(function(event,data,formatted){
        preencheConsumidorAutocomplete(event,data,formatted);
        fnc_pesquisa_consumidor_callcenter($('#cpf').val(),'cpf',true);
    });
<?php
}
?>
    /* Busca pelo Cdigo */
    $("#revenda_cnpj").autocomplete("<?echo $PHP_SELF.'?tipo_busca=revenda&busca=codigo'; ?>", {
        minChars: 3,
        delay: 150,
        width: 350,
        matchContains: true,
        formatItem: formatItem,
        formatResult: function(row) {
            return row[1];
        }
    });

    $("#revenda_cnpj").result(function(event, data, formatted) {
        $("#revenda_tab").val(data[0]) ;
        $("#revenda_cnpj").val(data[1]).trigger('keyup');
        $("#revenda_nome").val(data[2]);
    });

    <?php if (!in_array($login_fabrica, array(169,170,175, 177, 178,191,194,203))) { ?>
    /* Busca pelo CNPJ da Revenda no quadro InformaçÃµes do Produto */
    $("#cnpj_revenda").autocomplete("<?echo $PHP_SELF.'?tipo_busca=revenda_geral&busca=codigo'; ?>", {
        minChars: 3,
        delay: 150,
        width: 350,
        matchContains: true,
        formatItem: formatItem,
        formatResult: function(row) {
            return row[1];
        }
    });

    $("#cnpj_revenda").result(function(event, data, formatted) {
        $("#revenda_tab").val(data[0]) ;
        $("#cnpj_revenda").val(data[1]).trigger('keyup');
        $("#nome_revenda").val(data[2]) ;
        if(data[4] != undefined){
            $("#fone_revenda").val(data[4]) ;
        }
    });
    <?php } ?>

    /* Busca pelo Nome */
    $("#revenda_nome").autocomplete("<?echo $PHP_SELF.'?tipo_busca=revenda&busca=nome'; ?>", {
        minChars: 3,
        delay: 150,
        width: 350,
        matchContains: true,
        formatItem: formatItem,
        formatResult: function(row) {
            return row[2];
        }
    });

    $("#revenda_nome").result(function(event, data, formatted) {
        $("#revenda").val(data[0]) ;
        $("#revenda_cnpj").val(data[1]).trigger('keyup');
        $("#revenda_nome").val(data[2]) ;
        if(data[4] != undefined){
            $("#fone_revenda").val(data[4]) ;
        }
        //alert(data[2]);
    });

    <?php if (!in_array($login_fabrica, array(169,170,175,177,178,184,191,193,194,200,203))) { ?>
    	/* Busca pelo Nome da Revenda no quadro Informações do Produto */
    	$("#nome_revenda").autocomplete("<?echo $PHP_SELF.'?tipo_busca=revenda_geral&busca=nome'; ?>", {
    		minChars: 3,
    		delay: 150,
    		width: 350,
    		matchContains: true,
    		formatItem: formatItemNomeRevenda,
    		formatResult: function(row) {
    			return row[2];
    		}
    	});

    	$("#nome_revenda").result(function(event, data, formatted) {
    		$("#cnpj_revenda").val(data[1]).trigger('keyup');
    		$("#nome_revenda").val(data[2]) ;
            $("#revenda_tab").val(data[0]);
            if(data[4] != undefined){
                $("#fone_revenda").val(data[4]) ;
            }
            //alert(data[2]);
        });
    <?php } ?>
    $("#revenda_nome_os").autocomplete("<?echo $PHP_SELF.'?tipo_busca=revenda_os&busca=nome'; ?>", {
        minChars: 3,
        delay: 150,
        width: 350,
        matchContains: true,
        formatItem: formatItem,
        formatResult: function(row) {
            return row[2];
        }
    });

    $("#revenda_nome_os").result(function(event, data, formatted) {
        $("#revenda_os").val(data[0]) ;
    });


    $("#mapa_cidade").autocomplete("<?echo $PHP_SELF.'?tipo_busca=mapa_cidade&busca=mapa_cidade'; ?>", {
        minChars: 3,
        delay: 150,
        width: 205,
        matchContains: true,
        formatItem: function(row) {
            return row[0];
        },
        formatResult: function(row) {
            return row[0];
        }
    });

    <?php
    if (in_array($login_fabrica, array(169, 170))) {
    ?>
        $("#instalador_nome").change(function() {
            if ($(this).val().trim().length == 0) {
                $("#instalador_id").val("");
                valida_garantia();
            }
        });

        $("#data_nf").data("antigo", $("#data_nf").val());
        $("#data_nf").blur(function() {
            if ($(this).val() != $(this).data("antigo")) {
                valida_garantia();
            }
            $(this).data("antigo", $(this).val());
        });

        $("#data_nf").change(function() {
            if ($(this).val() != $(this).data("antigo")) {
                valida_garantia();
            }
            $(this).data("antigo", $(this).val());
        });

    <?php
    }
    ?>

    var tipo_cliente = function () { return $("#tipo_cliente").val(); };

    /* Busca pelo Código */
    <?php if (!in_array($login_fabrica, array(169,170,175,178,183,184,191,194,200,203))){ ?>

    var tipoCliente = $("#tipo_cliente").val();
    $("#codigo_posto_tab").autocomplete("<?echo $PHP_SELF.'?tipo_busca=posto&busca=codigo' ?>", {
        minChars: 3,
        delay: 150,
        width: 350,
        matchContains: true,
        extraParams: {tipoCliente: tipo_cliente},
        formatItem: formatItemPosto,
        formatResult: function(row) {
            return row[2];
        }
    });

	$("#codigo_posto_tab").result(function(event, data, formatted) {
		<? if ($login_fabrica == 74) { ?>
            if (($("#posto_atual").val() != data[0])) {
                verifica_os_aberta();
            }
        <? } ?>

        $("#posto_tab").val(data[0]) ;
        $("#codigo_posto_tab").val(data[2]) ;
        $("#posto_nome_tab").val(data[3]) ;
        $("#posto_fone_tab").val(data[5]) ;
        $("#posto_email_tab").val(data[6]) ;

        $("#codigo_posto").val(data[2]) ;
        $("#posto_nome").val(data[3]) ;

        <?php
        if ($login_fabrica == 74) {
        ?>
            $("#posto_atual").val(data[0]);
        <?php
        }elseif($login_fabrica == 30){
            ?>
            $("#posto_fone1_tab").val(data[12]);
            $("#posto_fone2_tab").val(data[13]);
            $("#particularidade_posto").val(data[16]);
            $('#btn_calcula_km').show();
            if (data[14] == 'SAC') {
                $('#posto_km_tab').val('0');
                $('#btn_calcula_km').hide();
            }

<?php
        }elseif ($login_fabrica == 162) {
?>
            var valor_interno = data[12];

            if (valor_interno.length > 0) {
                $("#interno").val(valor_interno);
                $("#posto_interno").show();
            } else {
                $("#interno").val("");
                $("#posto_interno").hide();
            }
<?php
        } else if ($login_fabrica == 35) { ?>
            let produtoReferencia = $("input[name=produto_referencia]").val();
            let linhaInformada   = $("#mapa_linha option:selected").val();
            let cidadeInformada  = $("#consumidor_cidade option:selected").val();
            let estadoInformado  = $("#consumidor_estado option:selected").val();

            if (produtoReferencia != "" && linhaInformada != "" && cidadeInformada != "" && estadoInformado != "") {

                $.ajax({
                    async: false,
                    url: window.location,
                    type: "POST",
                    dataType:"JSON",
                    data: {
                        ajax_verifica_assistencia_cidade: true,
                        linha_produto: linhaInformada,
                        cidade_consumidor: cidadeInformada,
                        produto_id: null,
                        produto_referencia: produtoReferencia,
                        estado_consumidor: estadoInformado
                    }
                }).done(function(data) {

                    if (data.analise_obrigatoria) {
                        if (!data.tem_posto && $("#codigo_posto").val() == "REVERSA SAC") {
                            alert("Não é possÃ­vel selecionar este posto. Este produto deve ser enviado para análise e reparo na Fábrica.");
                            $("#codigo_posto_tab, #posto_nome_tab, #posto_fone_tab, #posto_email_tab").val("");
                        } else if (data.tem_posto && $("#codigo_posto").val() == "REVERSA SAC") {
                            alert("Este produto deve ser enviado para análise e reparo na Fábrica");
                        }
                    } else if (!data.tem_posto && $("#codigo_posto").val() == "CAD0310") {
                        alert("Não é possÃ­vel selecionar este posto. Por favor, Efetue a troca deste produto.");
                        $("#codigo_posto_tab, #posto_nome_tab, #posto_fone_tab, #posto_email_tab").val("");
                    }

                });
            }
<?php
        }
?>
    });
    <?php } ?>
    var extraParamEstado = {
        estado: function () {
            return $("#consumidor_estado").val()
        }
    };

    // $("#consumidor_cidade").autocomplete("autocomplete_cidade_new.php", {
    //  minChars: 3,
    //  delay: 150,
    //  width: 350,
    //  matchContains: true,
    //  extraParams: extraParamEstado,
    //  formatItem: function (row) { return row[0]; },
    //  formatResult: function (row) { return row[0]; }
    // });

    // $("#consumidor_cidade").result(function(event, data, formatted) {
    //  $("#consumidor_cidade").val(data[0].toUpperCase());
    // });
    var getEstado = function () { return $("#consumidor_estado").val(); };

    <?php if (!in_array($login_fabrica, array(169,170,175,178,183,184,191,193,194,200,203))){ ?>

	/* Busca pelo Nome */
	$("#posto_nome_tab").autocomplete("<?echo $PHP_SELF.'?tipo_busca=posto&busca=nome'; ?>", {
		minChars: 3,
		delay: 150,
		width: 350,
		matchContains: true,
		extraParams: {estado: getEstado},
		formatItem: formatItemPosto,
		formatResult: function(row) {
			return row[3];
		}
	});

	$("#posto_nome_tab").result(function(event, data, formatted) {
        <? if ($login_fabrica == 74) { ?>
            if (($("#posto_atual").val() != data[0])) {
                verifica_os_aberta();
            }
        <? }

        if(in_array($login_fabrica, array(30,74,156))) { ?>
            $("#posto_contato_endereco").val(data[7]);
            $("#posto_contato_numero").val(data[8]);
            $("#posto_contato_bairro").val(data[9]);
            $("#posto_contato_cidade").val(data[10]);
	        $("#posto_contato_estado").val(data[11]);
	        $("#particularidade_posto").val(data[16]);
        <? } ?>

        $("#posto_tab").val(data[0]) ;
        $("#codigo_posto_tab").val(data[2]) ;
        $("#posto_nome_tab").val(data[3]) ;
        $("#posto_fone_tab").val(data[5]) ;
        $("#posto_email_tab").val(data[6]) ;

        $("#codigo_posto").val(data[2]) ;
        $("#posto_nome").val(data[3]) ;

        <?php
        if ($login_fabrica == 74) {
        ?>
            $("#posto_atual").val(data[0]);
        <?php
        }elseif ($login_fabrica == 30){
            ?>
            $("#posto_fone1_tab").val(data[12]);
            $("#posto_fone2_tab").val(data[13]);
        <?php
        }elseif ($login_fabrica == 162) {
        ?>
            var valor_interno = data[12];

            if (valor_interno.length > 0) {
                $("#interno").val(valor_interno);
                $("#posto_interno").show();
            } else {
                $("#interno").val("");
                $("#posto_interno").hide();
            }
        <?php
        }

        if(in_array($login_fabrica,array(30,74,156))){?>
            calcRoute();
        <?php
        }
        ?>

    });
    <?php } ?>
    /* ! Busca pelo Nome do cliente  --------- */
    bindEventClienteNomeAdmin();
    /* Busca pelo Nome do cliente  FIM ----- */

	$("#cliente_nome_admin").result(function(event, data, formatted) {
    	$("#cliente_admin").val(data[0]);
    	$("#cliente_nome_admin").val(data[3]);
        $("#abre_os_admin").val(data[5]);
	});

    <?php if ($login_fabrica == 183){ ?>
        $("#abre_ordem_servico").change(function(){
            var error = "";
            var campo_posto_tab = $("#posto_tab").val();
            var campo_posto_banco = $("input[name='posto_banco']").val();

            var qtde_km_posto = $("#posto_km_tab").val();

            if (qtde_km_posto == "" || qtde_km_posto == undefined){
                alert("Favor calcular o KM para abrir a Ordem de Serviço");
                $(this).attr("checked", false);
            }

            if ((campo_posto_tab == "" || campo_posto_tab == undefined) && (campo_posto_banco == "" || campo_posto_banco == undefined)){
                alert("Selecione um posto autorizado para abrir uma Ordem de serviço");
                $(this).attr("checked", false);
            }else{
                <?php if (empty($admin_supervisor_callcenter)){ ?>
                    if (qtde_km_posto > 450){
                        permissao_supervisor();
                    }
                <?php } ?>
            }

            if($('#abre_ordem_servico').is(":checked")){
                $('#tipo_atendimento_os').show();
            }else{
                $("#tipo_atendimento_os").hide();
            }
        });
        <?php if (empty($admin_supervisor_callcenter)){ ?>
            $("#select_atendimento_os").change(function(){
                var tipo_atendimento_descricao = $(this).find('option:selected').text();

                if (tipo_atendimento_descricao == 'Cortesia'){
                    permissao_supervisor();
                }
            });
        <?php } ?>
    <?php } ?>

    <? if ($login_fabrica == 74) { ?>

        $('#abre_os').change(function(){
            if($('#abre_ordem_servico').is(":checked")){
                $('#abre_ordem_servico').prop('checked', false);
            }
        });

        $('#abre_ordem_servico').change(function(){
            if($('#abre_os').is(":checked")){
                $('#abre_os').prop('checked', false);
            }
        });

    <? }

    if (in_array($login_fabrica, array(169,170,171))) {?>
        var fabrica = <?=$login_fabrica?>;

        if ((fabrica == 169 || fabrica == 170) && $("#posto_tab").val() != ''){
            var val_posto_tab = $("#posto_tab").val();
            $("#posto_tab").val(val_posto_tab);
        }

        if (fabrica == 171) {
            $("input[name=projeto]").click(function(){
                if ($(this).is(":checked")) {
                    $("select[name=tipo_atendimento_grohe]").find("option").each(function(){
                        if ($(this).attr("fora-garantia") == "t") {
                            $(this).hide();
                        }
                    });
                } else {
                    $("select[name=tipo_atendimento_grohe]").find("option").each(function(){
                        if ($(this).attr("fora-garantia") == "t") {
                            $(this).show();
                        }
                    });
                }
            });

        }

        if (fabrica == 169 || fabrica == 170){
            $("#data_agendamento_ordem").datepick({maxDate: defaultAgenda.addDays(3)}).mask("99/99/9999").attr("readonly", "readonly");
        }else{
            $("#data_agendamento_ordem").datepick().mask("99/99/9999").attr("readonly", "readonly");
        }

        <? if (empty($_POST['data_agendamento_ordem'])) { ?>
            if($("input[name=data_agendamento_ordem]").val() == ""){ //ver com maicon
                $("#data_agendamento_ordem").datepick("setDate", defaultAgenda);
            }
        <? } ?>

        $("#abre_ordem_servico").click(function() {
            abreOrdemServico($(this));
        });

        $("#abre_os").click(function() {
            abreOs($(this));
        });

        $("#os").change(function() {
            if ($(this).val().length > 0) {
                $("#abre_ordem_servico, #abre_os").prop({ checked: false });
            }
        });

        $("#cnpj_revenda").mask("99.999.999/9999-99");
        $("#data_agendamento_ordem").change(function() {
            var data_antiga = $(this).data("antiga");

            [dia, mes, ano] = $(this).val().split("/");

            var data = new Date(ano, --mes, dia);
            data.setHours(0, 0, 0, 0);

            var hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            var amanha = new Date();
            amanha.setDate(amanha.getDate() + 1);
            amanha.setHours(0, 0, 0, 0);

            if (fabrica == 169 || fabrica == 170){
                var array_date = [];
                //var data_descricao = [];

                $(dados_bloqueio).each(function(idx, element){
                    var startDate = new Date(element.data_inicio);
                    var stoptDate = new Date(element.data_final);
                    var datasx = (new Date).getDates(startDate, stoptDate);
                    datasx.forEach(function(date, i) {
                        array_date.push(date.dateToString('/'));
                        // data_descricao.push({
                        //     data_bloqueada: date.dateToString('/'),
                        //     descricao: element.descricao
                        // });
                    });
                });
            }

            if (data.getDay() == 6 || data.getDay() == 0) {
                if (data_antiga == null) {
                    $(this).datepick('setDate', defaultAgenda);
                } else {
                    $(this).datepick('setDate', data_antiga);
                }
                $("select[name=periodo]").focus();
                alert("A data selecionado deve ser um dia Ãºtil");
            } else if ($.inArray(data.dateToString("/"), feriados) != -1) {
                if (data_antiga == null) {
                    $(this).datepick('setDate', defaultAgenda);
                } else {
                    $(this).datepick('setDate', data_antiga);
                }
                $("select[name=periodo]").focus();
                alert("A data selecionada é um feriado por favor selecione outra data");
            }else if ($.inArray(data.dateToString("/"), array_date) != -1 && (fabrica == 169 || fabrica == 170)){
                if (data_antiga == null) {
                    $(this).datepick('setDate', defaultAgenda);
                } else {
                    $(this).datepick('setDate', data_antiga);
                }
                $("select[name=periodo]").focus();
                // $(data_descricao).each(function(idx, element){
                //     if (data.dateToString("/") == element.data_bloqueada){
                //         alert(element.descricao);
                //     }
                // });
            }else {
                if (data.getTime() < hoje.getTime()) {
                    if (data_antiga == null) {
                        $(this).datepick('setDate', defaultAgenda);
                    } else {
                        $(this).datepick('setDate', data_antiga);
                    }
                    $("select[name=periodo]").focus();
                    alert('A data selecionada não pode ser menor que a data de hoje.');
                } else if (data.getTime() == hoje.getTime() || data.getTime() == amanha.getTime()) {
                    if (typeof data_antiga == "undefined" || data.getTime() != data_antiga.getTime()) {
                        if ($("#autoriza_gravacao").val() != 'desbloqueado') {
                            permissao_supervisor_callback = function() {
                                if ($("#autoriza_gravacao").val() != 'desbloqueado') {
                                    $("#data_agendamento_ordem").data("antiga", defaultAgenda).datepick('setDate', defaultAgenda);
                                } else {
                                    $("#data_agendamento_ordem").data("antiga", data);
                                }
                            }

                            permissao_supervisor(<?=$callcenter?>);
                        } else {
                            $("#data_agendamento_ordem").data("antiga", data);
                        }
                    }
                } else if (typeof data_antiga == "undefined" || data.getTime() != data_antiga.getTime()) {
                    $("#data_agendamento_ordem").data("antiga", data);
                }

                $("select[name=periodo]").focus();
            }
        });
    <? } ?>

    <?php if ($validaGarantiaCallcenter){ ?>
        $("#abre_ordem_servico, #abre_os").click(function() {
            abreOs($(this));
        });

    <?php } ?>

    $("input[name=cliente_nome_admin]").blur(function(){
        if ($(this).val().length == 0) {
            $("#cliente_admin").val('') ;
        };
    });

    var hora = new Date();
    var engana = hora.getTime();

    //HD 201434 - Campo Localizar desmembrado em vários, linhas do autocomplete do antigo campo excluÃ­das
	<?php
		if($novaTelaOs == true && $produto_referencia != "" && $produto_nome != ""){
			echo "localizarNovoFaq('$produto_referencia', '".str_replace("'","",$produto_nome)."'); ";
			echo "escolhaSituacao('');";
		}
	?>

    $("#container-Principal > ul > li > a").click(function () {
        if ($(this).parent("li").hasClass("tabs-disabled")) {
            return;
        }

        $('#tab_atual').val($(this).attr("rel"));
        if ($(this).attr("rel") == "ressarcimento") {
            validaOsRessarcimento();
        }

    });

});

<?php

if($login_fabrica == 85 && strlen($callcenter) > 0){

    if(mb_detect_encoding($origem,'UTF-8', true)){
        $origem = utf8_decode($origem);
    }

    $sql_interacoes = "SELECT hd_chamado_item FROM tbl_hd_chamado_item WHERE hd_chamado = {$callcenter}";
    $res_interacoes = pg_query($con, $sql_interacoes);

    $qtde_interacoes = pg_num_rows($res_interacoes);

    if(strlen(trim($origem)) > 0 && $origem == "Integração" && (int)$qtde_interacoes <= 1){
?>

        setTimeout(function(){
            libera_tabs();
        }, 1000);

        function libera_tabs(){

            $("#container-Principal > ul.tabs-nav > li").each(function(){

                if($(this).hasClass("tabs-disabled")){
                    $(this).removeClass("tabs-disabled");
                }

            });

        }

<?php
    }else{

        ?>

       function libera_tabs(){

            $("#container-Principal > ul.tabs-nav > li").each(function(){

                if($(this).find("a").attr("rel") != "<?php echo $categoria; ?>"){
                    return;
                }

                if($(this).hasClass("tabs-disabled")){
                    $(this).removeClass("tabs-disabled");
                }

                $(this).find("a").trigger("click");

            });

        }

        setTimeout(function(){
            libera_tabs();
        }, 1000);

        <?php

    }
}
?>

function preencheConsumidorAutocomplete(event, data, formatted) {
    if(formatted == "erro"){
        return;
    }

    var formulario = document.frm_callcenter;
    var os = document.getElementById('os')

    formulario.consumidor_nome.value = data[1];
    formulario.querySelector('input[name=consumidor_cpf]').value = data[11];
    <?php if (!in_array($login_fabrica,array(85,169,170))) { ?>
	formulario.consumidor_rg.value = data[12];
    <?php } ?>
    formulario.consumidor_email.value = data[13];
    formulario.consumidor_fone.value = data[8];
    formulario.consumidor_cep.value = data[6];
    formulario.consumidor_endereco.value = data[2];
    formulario.consumidor_numero.value = data[3];
    formulario.consumidor_complemento.value = data[4];
    formulario.consumidor_bairro.value = data[5];
    <?php if ($login_fabrica == 42) { ?>
        if(os) {
            os.value = data[17];
        }
        formulario.consumidor_estado.value = data[16];
        formulario.consumidor_cidade.value = data[15];
        $(formulario.consumidor_cidade).html('<option value="'+data[15]+'">'+data[15]+'</option>');
    <?php } else { ?>
	formulario.consumidor_estado.value = data[15];
	formulario.consumidor_cidade.value = data[14];
	if(os) {
		os.value = data[16];
	}
    <?php } ?>
    formulario.consumidor_fone2.value = data[9];
    formulario.consumidor_fone3.value =	 data[10];
    <? if(in_array($login_fabrica, array(30,74))) { ?>
	$(formulario.consumidor_nascimento).val(data[27]);
    <? } ?>
    if ((typeof formulario.consumidor_cpf != "undefined") && (typeof formulario.consumidor_cnpj != "undefined")) {
	if (typeof data['11'] != "undefined" && data[11].length > 11) {
	    formulario.consumidor_cnpj.checked = true;
        <?php if (in_array($login_fabrica, [178])) { ?>
            $("#consumidor_cnpj").click();
            $(formulario.consumidor_cnpj).click();
            formulario.querySelector('input[name=consumidor_cpf]').value = data[11];
        <?php } ?>
	} else {
	    formulario.consumidor_cpf.checked = true;
	}
    }

    if (typeof formulario.consumidor_revenda_c != "undefined") {
	switch (data[38]) {
	    case "O":
		formulario.consumidor_revenda_c.checked = true;
		break;

	    case "C":
		formulario.consumidor_revenda_c.checked = true;
		break;

	    case "R":
		formulario.consumidor_revenda_r.checked = true;
		break;

	    case "A":
		formulario.consumidor_revenda_a.checked = true;
		break;
	}
    }
}

function carregaTipoAtendimento(check) {
    if (check.checked) {
        $('#extra_grohe').show();
    } else {
        $('#extra_grohe').hide();
        $("select[name=tipo_atendimento_grohe]").val("");
    }
}

function RetornoAnexoEsmaltec(hash){
    var valorAnterior = $("#anexoEsmaltec").val();
    if(valorAnterior.length >0){
        valorAnterior = valorAnterior+"|"+hash;
    }else{
        valorAnterior = hash;
    }
    $("#anexoEsmaltec").val(valorAnterior);
}

function fnc_grava_callcenter_esmaltec(){
    var result = "";
    if($("#abre_ordem_servico").is(':checked')){
        result = verificaNumeroSerieEsmaltec();
    } else{
        $("#dadosDiferenteEsmaltec").val("");
        result = true;
    }

    if(result == true){
        if (document.frm_callcenter.btn_acao.value!='') {
            alert('Dados já gravados. Se você clicou em Voltar no seu browser ou clicou mais de uma vez no botão, acesse novamente a tela pelos Menus do sistema.');
        } else {
            document.frm_callcenter.btn_acao.value='final';
            liberar_campos();
            $('#frm_callcenter').submit();
            $(this).hide();
        }
    }
}

 function verificaNumeroSerieEsmaltec(){
    var numeroSerie = $("#serie").val();
    var produto_referencia = $("input[name=produto_referencia]").val();
    var consumidor_revenda = $("#consumidor_revenda").val();
    var resultado = "";

    if(consumidor_revenda.length == 0){
        alert("Informe o tipo do atendimento.");
        $("#abre_ordem_servico").prop("checked", false);
        return false;
    }

    //if(consumidor_revenda == "C"){

        if(produto_referencia.length == 0){
            alert("Informe o Produto");
            $("#abre_ordem_servico").prop("checked", false);
            return false;
        }

        if(numeroSerie.length == 0){
          //  alert("Informe o número de Série do Produto");
         //   $("#abre_ordem_servico").prop("checked", false);
            //return false;
        }

        $.ajax({
            url : "valida_ns_esmaltec.php",
            type: "POST",
            async:false,
            data: {
                numeroSerie: numeroSerie,
                produto_referencia :produto_referencia,
                consumidor_revenda : consumidor_revenda,
                ajax_ns : true
            },
            success: function(data){
                var retorno = JSON.parse(data);

                if(retorno.retorno == "ok"){
                    resultado = verificaDados(retorno);
                }else{
                    $("#dadosDiferenteEsmaltec").val("");
                    resultado = true;
                }
            }
        });
        return resultado;
    //}
}

function verificaDados(dados){
    var data_nf         = $("#data_nf").val();
    var nota_fiscal     = $("#nota_fiscal").val();
    var cnpj_revenda    = $("#cnpj_revenda").val();

    if((dados.data_nf != data_nf) || (dados.nota_fiscal != nota_fiscal) || (dados.revenda_cnpj != cnpj_revenda) ){
        if (confirm("Os dados de Nota Fiscal, Data da Compra ou Nome Revenda estão diferentes da O.S anterior. \n Deseja prosseguir com a abertura da O.S?") == true) {
            //alert("Informar o anexo da Nota Fiscal");
            $("#table_fileUploader").show();

            $("#dadosDiferenteEsmaltec").val("true");
            return true;
        } else {
            $("#dadosDiferenteEsmaltec").val("");
            $("#abre_ordem_servico").prop("checked", false);
            return false;
        }
    }else{
        $("#dadosDiferenteEsmaltec").val("");
        return true;
    }
}

function verificarImpressao(check){
        if (check.checked){
        $('#imprimir_os').show();

        <?php if($login_fabrica == 30){  ?>
            verificaNumeroSerieEsmaltec();
        <?php } ?>
    }else{
        $('#imprimir_os').hide();
    }
}

function pesquisa_produto_generico(){
    Shadowbox.open({
        content :   "produto_lupa_callcenter.php",
        player  :   "iframe",
        title   :   "Pesquisa",
        width   :   800,
        height  :   500
    });
}

function fnc_pesquisa_serie (campo, campo2, tipo, mapa_linha,campo3, pos) {
    if (tipo == "serie") {
        var xcampo = campo3;
    }

    <?php if ($login_fabrica == 158) { ?>
        var auxiliar = $("#cliente_admin"). val();

        if (auxiliar != "" && auxiliar != undefined) {
            var cliente_admin = '&cliente_admin=' + auxiliar;
        } else {
            var cliente_admin = "";
        }
    <?php } else { ?>
        var cliente_admin = "";
    <?php } ?>

    if (xcampo.value != "") {
        <?php if ($login_fabrica == 183){ ?>
            Shadowbox.open({
                content :   "produto_serie_pesquisa_itatiaia.php?campo=" + xcampo.value + "&tipo=" + tipo + "&mapa_linha=t&voltagem=t" + "&pos=" + pos + cliente_admin,
                player  :   "iframe",
                title   :   "Pesquisa",
                width   :   800,
                height  :   500
            });
        <?php }else{ ?>
            Shadowbox.open({
                content :   "produto_serie_pesquisa_new_nv.php?campo=" + xcampo.value + "&tipo=" + tipo + "&mapa_linha=t&voltagem=t" + "&pos=" + pos + cliente_admin,
                player  :   "iframe",
                title   :   "Pesquisa",
                width   :   800,
                height  :   500
            });
        <?php } ?>
    }else{
        alert( 'Favor inserir toda ou parte da informação para realizar a pesquisa' );
        return false;
    }
}

<?php if($login_fabrica == 161){
    //$retorna_serie_parametros_adicionais = ", revenda, revenda_nome, revenda_cnpj";
    $retorna_serie_parametros_adicionais = ", cliente_id, consumidor_nome, consumidor_cpf, nota_fiscal, data_nf, revenda, nome_revenda, cnpj_revenda";
    $retorna_serie_parametros_adicionais .= ", consumidor_cep, consumidor_numero, consumidor_complemento, consumidor_email, consumidor_fone";
}else if($login_fabrica == 74){
    $retorna_serie_parametros_adicionais = ", data_fabricacao, serie_inicial_final";
}else if($login_fabrica == 158){
    $retorna_serie_parametros_adicionais = ", data_fabricacao, data_venda";
} else if ($login_fabrica == 52) { /*HD - 6165474*/
    $retorna_serie_parametros_adicionais = ", data_venda=null, nota_fiscal_numero_serie=null, cliente_admin=null, cliente_admin_nome=null";
}

?>

function retorna_serie(descricao, referencia, serie, voltagem, produto, ordem, linha, pos <?php echo $retorna_serie_parametros_adicionais; ?>) {
    var fabrica = "<?=$login_fabrica?>";

	var opt = "";
	if(pos.length > 0 && fabrica == 52) {
		opt = "_" + pos;

        /*HD - 6165474*/
        if (cliente_admin != "" && cliente_admin != undefined) {
            $("#cliente_admin").val(cliente_admin);
        }

        if (cliente_admin_nome != "" && cliente_admin_nome != undefined) {
            $("#cliente_nome_admin").val(cliente_admin_nome);
        }

        if (data_venda != "" && data_venda != undefined) {
            $("#data_nf_fricon_" + pos).val(data_venda);
        }

        if (nota_fiscal_numero_serie != "" && nota_fiscal_numero_serie != undefined) {
            $("#nota_fiscal_fricon_" + pos).val(nota_fiscal_numero_serie);
        }
    }

    if(fabrica == 74){

        var valida_serie = serie_inicial_final.split("|");

        if(valida_serie[0] == "true"){
            $(".machine").html(valida_serie[1]);
            $(".machine").show();
        }else{
            $(".machine").hide();
        }
    }

    if(fabrica != 52) {
        gravaDados("voltagem", voltagem);

        if(linha) {
            $("#mapa_linha").val(linha);
        }
    }

    gravaDados("produto_nome" + opt, descricao);
    gravaDados("produto_referencia" + opt, referencia);
    <?php if($login_fabrica == 161){ ?>
       gravaDados("serie", serie);
    <?php }else{ ?>
        gravaDados("serie" + opt, serie);
    <?php } ?>
    gravaDados("numero_ativo" + opt, ordem);

    <?php if($login_fabrica == 161){ ?>

        if (cliente_id != "") {
            //gravaDados("revenda_tab", revenda);
            //gravaDados("cnpj_revenda", revenda_cnpj);
            //gravaDados("nome_revenda", revenda_nome);
            gravaDados("consumidor_nome", consumidor_nome);
            gravaDados("consumidor_cpf", consumidor_cpf);
            gravaDados("nota_fiscal", nota_fiscal);
            gravaDados("data_nf", data_nf);
            gravaDados("cnpj_revenda", cnpj_revenda);
            gravaDados("nome_revenda", nome_revenda);
            gravaDados("consumidor_cep", consumidor_cep);
            gravaDados("consumidor_numero", consumidor_numero);
            gravaDados("consumidor_complemento", consumidor_complemento);
            gravaDados("consumidor_email", consumidor_email);
            gravaDados("consumidor_fone", consumidor_fone);

            atualizaQuadroMapas();
            $("#consumidor_cep").focus();
        }

        mostraDefeitos('Reclamado',document.frm_callcenter.produto_referencia.value);

    <?php } ?>

    <? if($login_fabrica == 74){?>
        gravaDados("dt_fabricacao" + opt, data_fabricacao);
    <? }

    if ($login_fabrica == 158) { ?>
        gravaDados("data_fabricacao" + opt, data_fabricacao);
        gravaDados("data_venda" + opt, data_venda);
    <? } ?>
}

<?php if (in_array($login_fabrica, array(169,170))) { ?>
function setor_atividade(){
    var setor_atividade = $("#setor_atividade").val();//abre_ordem_servico
    if ($("#abre_ordem_servico").is(":checked") == true && (setor_atividade == 'I' || setor_atividade == 'C' || setor_atividade == 'IC')) {
        switch (setor_atividade) {
            case "I":
                $('#servico_instalacao, #serv_install').show();
                break;

            case "C":
                $('#servico_conversao, #serv_conv').show();
                break;

            case "IC":
                $('#servico_instalacao, #servico_conversao, #servico_instalacao_conversao, #serv_install, #serv_conv, #serv_install_conv').show();
                break;
        }

        $("#sem_servico_instalacao_conversao, #sem_servico_install_conv").show();
        $("#sem_servico_install_conv").prop({ checked: true });
    }else{
        $('#servico_instalacao, #servico_conversao, #servico_instalacao_conversao, #serv_install, #serv_conv, #serv_install_conv, #sem_servico_instalacao_conversao, #sem_servico_install_conv').hide();
    }
}
<?php } ?>

function retorna_prod_generico(res){
    $('input[name=produto]').val(res.produto);
    $('input[name=produto_nome]').val(res.referencia+" - "+res.descricao);
    $('input[name=produto_nome_generico]').val(res.descricao);
    $("input[name='produto_referencia']").val(res.referencia);
    $("input[name='voltagem']").val(res.voltagem);

    if(res.linha) {
        $("#mapa_linha").val(res.linha);
    }

    <? if(in_array($login_fabrica, array(169,170))) { ?>
        $('input[name=produto_garantia]').val(res.garantia);
        $("#nome_mapa_linha").val(res.linha_nome);
        $("#script_falha").val('');
        $("#json_script").val('');
        $("#json_execucao_script").val('');
        $("#executar_script").prop('disabled', false);
        $("#script_resolution").val('');
        $("#ultima_pergunta_script").val('');
        $("#ultima_resposta_script").val('');
        $("#ultima_instrucao_script").val('');
        $(".result_resolution").text('');
        $("#resolution").hide();
        $("#bloco_script_falha").hide();

        $("#serv_install, #serv_conv, #serv_install_conv").prop({ checked: false }).hide();
        $('#servico_instalacao, #servico_conversao, #servico_instalacao_conversao').hide();
        $('input[name=tipo_atendimento]').val(res.tipo_atendimento);
        $("#setor_atividade").val(res.setor_atividade);
        $("#garantia_estendida").val(res.garantia_estendida);

        $(".abre_os_169").hide();
        $(".class_169").hide();
        $(".class_169").attr("checked", false);
        $(".abre_os_169").attr("checked", false);
        $("#imprimir_os").hide();

        if($("#abre_ordem_servico").is(":checked") == true){
            switch (res.setor_atividade) {
                case "I":
                    $('#servico_instalacao, #serv_install').show();
                    break;

                case "C":
                    $('#servico_conversao, #serv_conv').show();
                    break;

                case "IC":
                    $('#servico_instalacao, #servico_conversao, #servico_instalacao_conversao, #serv_install, #serv_conv, #serv_install_conv').show();
                    break;
            }

            $("#sem_servico_instalacao_conversao, #sem_servico_install_conv").show();
            $("#sem_servico_install_conv").prop({ checked: true });
        } else {
            $('#sem_servico_instalacao_conversao, #servico_instalacao, #servico_conversao, #servico_instalacao_conversao, #serv_install, #serv_conv, #serv_install_conv, #sem_servico_install_conv').hide();
        }

        if (res.garantia_estendida == 1) {
            $(".tr-instalador").show();
        } else {
            $(".tr-instalador").hide();
            $(".tr-instalador").find("input").val("");
        }

        $(".produto_deslocamento").val(res.deslocamento);
        $(".garantia_estendida_tempo").val(res.garantia_estendida_tempo);

        var numero_os = $("#os").val();

        var abreos_preos = $("select[name=hd_motivo_ligacao] option:selected").data("abreos_preos");
        if (abreos_preos == 't') {
            $("#os_pre_os").show();
        } else {
            $("#os_pre_os").hide();
        }

        var os_cortesia = $("#hd_motivo_ligacao").children(":selected").data('os_cortesia');
        $("#os_cortesia").val(os_cortesia);

        if(res.deslocamento == 't'){
            $(".class_169").hide();
            $(".abre_os_169").show();
            $("#div_data_agendamento_ordem").show();
            $("#div_periodo_agendamento_ordem").show();
            $("#imprimir_os").show();
            $("#abre_ordem_servico").prop('checked', true);
        }else{
            if (os_cortesia == 't'){
                $(".class_169").hide();
                $(".abre_os_169").show();
                $("#div_data_agendamento_ordem").show();
                $("#div_periodo_agendamento_ordem").show();
                $("#imprimir_os").show();
                $("#abre_ordem_servico").prop('checked', true);
            }else{
                $(".class_169").show();
                $(".abre_os_169").hide();
                $("#div_data_agendamento_ordem").hide();
                $("#div_periodo_agendamento_ordem").hide();
                $("#imprimir_os").show();
                $("#abre_os").prop("checked", true);
            }
        }

        var linhas_posto_tab = $("#linhas_posto_tab").val();
        if (linhas_posto_tab != ''){
            var res = linhas_posto_tab.replace(/\{|\}/g, '');
            var result_linha_posto_tab = res.split(',');
            var fora_linha = false;
            $.map( result_linha_posto_tab, function( n ) {
                if (n == $("#mapa_linha").val()){
                    fora_linha = true;
                }
            });
            if (fora_linha == false){
                alert("O posto selecionado não atende a linha do Produto, selecione outro posto.");
                $("#linhas_posto_tab").val('');
                $("#codigo_posto_tab").val('');
                $("#posto_fone_tab").val('');
                $("#posto_email_tab").val('');
                $("#posto_nome_tab").val('');
                $("#posto_tab").val('');
            }
        }
        valida_garantia();
        mostraDefeitos('Reclamado',document.frm_callcenter.produto_referencia.value);
    <? } ?>

    atualizaQuadroMapas();

    <?php if ($login_fabrica == 171) { ?>
        $(".produto_deslocamento").val(res.deslocamento);
        mostraDefeitos('Reclamado',res.referencia);
    <?php } ?>

    <?php if (in_array($login_fabrica, array(169,170))) { ?>
    setTimeout(function(){$("#defeito_reclamado").trigger("change");},1000);
        setor_atividade();
    <? } ?>
}

var produtosTrocaDireta = [];

function retorna_produto(descricao, referencia, voltagem, marca_produto, produto, linha, pos, informatica, serie_obrigatorio, linha_descricao, familia_descricao, garantia, troca_obrigatoria=false, troca_direta) {
    <?php
    if (in_array($login_fabrica, [35])) { ?>
        ajax_assistencia_cidade_consumidor(linha, produto);
    <?php
    }

    if($login_fabrica == 42){ ?>
        $("#consultar_informacoes_tecnicas").show();
    <?php } ?>

   <?php if (in_array($login_fabrica, [151,186,190,195])) { ?>
        let prods = $("#tabela_itens tbody").find("tr");
        if (prods.length == 1) {
            produtosTrocaDireta = [];
        }

        let counter = 0;
        $.each(produtosTrocaDireta, function (index, element) {
            if (element.referencia == referencia) {
            counter++;
            }
        });

        if (counter == 0) {
            produtosTrocaDireta.push(
            {
                referencia: referencia,
                descricao: descricao,
                troca_direta: troca_direta
            }
            );
        }
    <?php } ?>

    <?php if($usaScriptFalha){ ?>
        $('input[name=produto]').val(produto);
        $("#script_falha").val('');
        $("#json_script").val('');
        $("#json_execucao_script").val('');
        $("#executar_script").prop('disabled', false);
        $("#script_resolution").val('');
        $("#ultima_pergunta_script").val('');
        $("#ultima_resposta_script").val('');
        $("#ultima_instrucao_script").val('');
        $(".result_resolution").text('');
        $("#resolution").hide();
        $("#bloco_script_falha").hide();
    <?php } ?>

    <?php if (in_array($login_fabrica, [174])) { ?>
        $.ajax('callcenter_interativo_new.php', {
            async: true,
            type: 'POST',
            data: {
                scriptFalhaProd: true,
                produto: produto,
            }
        }).done(function (response) {
            response = JSON.parse(response);

            $("#bloco_script_falha").show();
            $("#familia_script").val(response.familia);
            $("#script_falha").val(response.script_falha);
            $("#json_script").val(JSON.stringify(response.json_script));
            $("#json_execucao_script").val(JSON.stringify(response.json_execucao_script));
        });
    <?php } ?>

    <?php if($validaGarantiaCallcenter){ ?>
        $('input[name=produto]').val(produto);
        $('input[name=produto_garantia]').val(garantia);
    <?php } ?>

    <?php if($login_fabrica == 52){ //hd_chamado=2891049 ?>
        $('#produto_referencia'+opt).prop('readonly', true);
        $("input[name='produto_nome"+opt+"']").prop('readonly', true);
    <?php } ?>

    var fabrica = "<?=$login_fabrica?>";
    var opt     = '';

    if(pos.length > 0 && (fabrica == 52 || fabrica == 138 || fabrica == 151 || fabrica == 178 || fabrica == 186 || fabrica == 189 || fabrica == 190 || fabrica == 195)) {
        var opt = "_" + pos;
    }

    if(fabrica != 52) {
        gravaDados("voltagem", voltagem);

        if(linha) {
            $("#mapa_linha").val(linha);
        }
    }else{
        //alert(marca_produto);
        //gravaDados("marca", marca_produto);
        $("#marca").val(marca_produto);
    }

    if(fabrica == 169 || fabrica == 170){
        $("input[name='produto']").val(produto);
    }

    if (fabrica == 158 && serie_obrigatorio == 't') {
        $('.numero_serie > strong').html("<acronym title='Campo Obrigatório'><font color='#AA0000'>Série</font></acronym>");
    }

    if (fabrica == 162) {
        if(informatica == 'f'){
            $("#imei").show();
            $("#label_imei").show();
            $("#linha_informatica").val(informatica);
        }else{
            $("#imei").hide();
            $("#label_imei").hide();
            $("#imei").val('');
        }
    }

    if(fabrica == 167 || fabrica == 203){ //HD-3428316
        if(familia_descricao.indexOf("Impressora") != -1 || familia_descricao.indexOf("Multifunciona") != -1){
            $("#linha_descricao").val(linha_descricao);
            $("#familia_descricao").val(familia_descricao);
            $(".contador").show();
        }else{
            $(".contador").hide();
            $("#linha_descricao").val("");
            $("#familia_descricao").val("");
        }
    }

    if (fabrica == 174)
    {
        if (troca_obrigatoria == 't')
        {
            $("#laudo").show();
            $("#troca_obrg_val").val('t');
        }else
        {
            $("#laudo").hide();
             $("#troca_obrg_val").val('f');
        }
    }

    gravaDados("produto_nome" + opt, descricao);
    gravaDados("produto_referencia" + opt, referencia);

    if (fabrica == 138 ||  fabrica == 190 ||  fabrica == 195) {
        gravaDados("voltagem" + opt, voltagem);
    }

    $("#serie").focus();
    <?php if($novaTelaOs == true){
        echo "localizarNovoFaq(referencia, descricao);";
    } ?>
    <? if ($login_fabrica == 74 && strlen($callcenter) > 0) { ?>
        VerificaProduto();
    <? } ?>

    <?php if($login_fabrica == 81){ ?>
        buscaSolucao(marca_produto);
        $("input[name=produto_referencia]").trigger("change");
    <?php } ?>

    <?php if ($login_fabrica == 178){ ?>
        busca_defeito_reclamado(produto, pos);
        $("input[name='produto_"+pos+"']").val(produto);
    <?php } ?>

}

function ajax_assistencia_cidade_consumidor (linhaProduto, produto_id) {

    let cidadeConsumidor = $("#consumidor_cidade option:selected").val();
    let estadoConsumidor = $("#consumidor_estado option:selected").val();

    if (linhaProduto != "" && cidadeConsumidor != "") {
        $.ajax({
            url: window.location,
            type: "POST",
            dataType:"JSON",
            data: {
                ajax_verifica_assistencia_cidade: true,
                linha_produto: linhaProduto,
                cidade_consumidor: cidadeConsumidor,
                produto_id: produto_id,
                estado_consumidor: estadoConsumidor
            }
        }).done(function(data) {

            if (data.analise_obrigatoria) {
                if (!data.tem_posto) {
                    alert("Este produto deve ser enviado para análise e reparo na Fábrica.");
                } else {
                    alert("Oriente o consumidor a levar o produto para a Assistência Autorizada.");
                }
            } else if (data.tem_posto) {
                alert("Oriente o consumidor a levar o produto para a Assistência Autorizada.");
            } else if (!data.tem_posto) {
                alert("Efetue a troca deste produto.");
            }

        });
    }
}

<?php if ($login_fabrica == 178){ ?>
    function busca_defeito_reclamado(produto, posicao) {
        $.ajax({
            url: "callcenter_interativo_new.php",
            type: "POST",
            dataType:"JSON",
            data: {
                ajax: true,
                ajax_busca_defeito_reclamado: true,
                produto: produto
            },
            beforeSend: function() {
                $("#defeito_reclamado_"+posicao).hide().after($("<img />", { src: "imagens/loading_img.gif", css: { width: "30px", height: "30px" } }));
            }
        })
        .done(function(data) {
            if (data.defeitos_reclamados) {
                $("#defeito_reclamado_"+posicao+" > option").first().nextAll().remove();
                defeito_reclamado_json = [];
                var option = "<option value=''>Selecione</option>";
                $.each(data.defeitos_reclamados, function(key, value) {
                    var descricao = value.descricao;
                    option += "<option value='"+value.defeito_reclamado+"'>"+descricao+"</option>";
                    defeito_reclamado_json.push({ defeito_reclamado: value.defeito_reclamado, descricao: descricao , lancar_pecas: value.lancar_pecas, lista_garantia: value.lista_garantia, defeito_constatado_grupo: value.defeito_constatado_grupo });
                });
                $("#defeito_reclamado_"+posicao).append(option);
            }
            $("#defeito_reclamado_"+posicao).show().next().remove();
        });
    }
<?php } ?>

function buscaSolucao(marca_produto){
    $.ajax({
        url: "callcenter_interativo_new.php",
        type: "POST",
        data: {
            buscaSolucao: true,
            marca_produto: marca_produto
        }
    }).done(function(data) {
        $("#solucao").html(data);
    });
}

function retorna_numero_ativo(ordem, serie, referencia, descricao, produto, linha, voltagem, pos) {

    var fabrica = "<?=$login_fabrica?>";

    if(pos.length > 0 && fabrica == 52) {
        var opt = "_" + pos;
    }

    if(fabrica != 52) {
        gravaDados("voltagem", voltagem);

        if(linha) {
            gravaDados("mapa_linha", linha);
        }
    }

    gravaDados("serie" + opt, serie);
    gravaDados("produto_nome" + opt, descricao);
    gravaDados("produto_referencia" + opt, referencia);
    gravaDados("numero_ativo" + opt, ordem);
}

function fnc_pesquisa_ordem (campo, campo2, tipo, mapa_linha,campo3, campo4, pos) {
    if (tipo == "ordem") {
        var xcampo = campo4;
    }

    if (xcampo.value != "") {
        var url = "produto_numero_ativo_pesquisa_nv.php?campo=" + xcampo.value + "&tipo=" + tipo + "&mapa_linha=t&voltagem=t&pos=" + pos;

        Shadowbox.open({
            content :   url,
            player  :   "iframe",
            title   :   "Pesquisa",
            width   :   800,
            height  :   500
        });

    }else{
        alert( 'Favor inserir toda ou parte da informação para realizar a pesquisa' );
        return false;
    }
}

var janela = null;
var janela_descricao = null;

function fnc_pesquisa_produto2 (campo, campo2, tipo, mapa_linha, pos) {

    if (tipo == "referencia" ) {
        var xcampo = campo;
        //alert(xcampo.value);
    };
    if (tipo == "descricao" ) {
        var xcampo = campo2;
    }

    var familia = "";

    if ($("select#familia_produto").length > 0) {
        var id_familia = $("select#familia_produto").val();

        if (id_familia.length == 0) {
            alert ("Selecione a famÃ­lia do produto");
            campo.focus();
            return false;
        }
        familia = "&familia="+id_familia;
    }

    <?php if(in_array($login_fabrica, [52,138,151,178,186,189,190,195])) { ?>
        /* Validação para não realizar a ação para produto igual */
        var produto_referencia_anterior = $("input[name='produto_referencia_anterior_"+pos+"']").val();
        var produto_descricao_anterior = $("input[name='produto_nome_anterior_"+pos+"']").val();
        var produto_referencia_atual = $("input[name='produto_referencia_"+pos+"']").val();
        var produto_descricao_atual = $("input[name='produto_nome_"+pos+"']").val();

    <?php }else{ ?>
        /* Validação para não realizar a ação para produto igual */
        var produto_referencia_anterior = $("input[name='produto_referencia_anterior']").val();
        var produto_descricao_anterior = $("input[name='produto_nome_anterior']").val();
        var produto_referencia_atual = $("input[name='produto_referencia']").val();
        var produto_descricao_atual = $("input[name='produto_nome']").val();

    <?php } ?>

    // Para a Elgin Automação tem que abrir a lupa se não digitar nenhum produto
    var fabrica_elgin_aut = <?= $login_fabrica; ?>;
    <?php if($login_fabrica != 74){ ?>
        if(
            $.trim(produto_referencia_anterior) == $.trim(produto_referencia_atual)
            &&
            $.trim(produto_descricao_anterior) == $.trim(produto_descricao_atual)
            &&
            (fabrica_elgin_aut != 156 && $.trim(produto_referencia_atual).length == 0)
        ) {
            return;
        }
    <?php } ?>

    if ((typeof xcampo != 'undefined' && xcampo != "") || fabrica_elgin_aut == 156) {
        var url = "produto_pesquisa_3.php?campo=" +
            xcampo.value + "&tipo=" +
            tipo +"&familia=" + familia +
            "&mapa_linha=t&voltagem=t&pos=" + pos;

            <?php if($login_fabrica == 151){ ?>

             Shadowbox.open({
                content :   url,
                player  :   "iframe",
                title   :   "Pesquisa",
                width   :   800,
                height  :   500,
                options : {
                    onClose : buscaFamilias
                }
            });

         <?php } else{ ?>

           Shadowbox.open({
                content :   url,
                player  :   "iframe",
                title   :   "Pesquisa",
                width   :   800,
                height  :   500
            });

        <?php } ?>
    }
}

function VerificaProduto(){
    var produto_referencia_anterior = $("input[name='produto_referencia_anterior']").val();
    var produto_referencia_atual    = $("input[name='produto_referencia']").val();
    var produto_nome_anterior       = $("input[name='produto_nome_anterior']").val();
    var produto_nome                = $("input[name='produto_nome']").val();

    if((produto_referencia_anterior !=  produto_referencia_atual) || (produto_nome_anterior != produto_nome)){
        alert("Como você alterou o Produto, deverá cadastrar um novo Defeito!");
    }
}

function MudaCampo(campo){
    if (campo.value == 'reclamacao_at') {
        document.getElementById('info_posto').style.display='inline';
    }else{
        document.getElementById('info_posto').style.display='none';
    }
}

function enviaEmail(callcenter){
    url = "envio_email_callcenter.php?callcenter=" + callcenter;
    janela = window.open(url, "janela", "toolbar=no, location=no, status=yes, scrollbars=yes, directories=no, width=700, height=500, top=18, left=0");
}

function validaOsRessarcimento() {

    var os = $('#os').val();

    if (os.length == 0) {
        alert('Para fazer o ressarcimento é necessario escolher a Ordem de serviço no cabeçalho do programa');
    } else {
        $('#os_ressarcimento').val(os);
    }
}

$(document).ready(function(){
    <?php
    if(in_array($login_fabrica, array(158))){
    ?>
    $(document).on("change","#defeito_reclamado",function(){
        var consumidor_cliente_admin = $("#consumidor_ca").is(":checked");
        var cliente_admin            = $("#cliente_admin").val();
        var defeito_reclamado        = $(this).val();
        var data_nota                = $("#data_nf").val();

        if(consumidor_cliente_admin != "" && cliente_admin != "" && data_nota != ""){

            $.ajax({
                async: true,
                type: 'POST',
                url: 'modal_tabela_garantia.php',
                data: { ajax_verifica_garantia : true,
                        defeito_reclamado      : defeito_reclamado,
                        data_nota              : data_nota,
                        cliente_admin          : cliente_admin,
                    },
            })
            .done(function(data) {
                data = JSON.parse(data);

                if(data.success){
                    Shadowbox.close();
                    setTimeout(function() {
                        Shadowbox.open({
                            content: "modal_tabela_garantia.php?defeito_reclamado=" + defeito_reclamado + "&garantia=" + data.garantia,
                            player: "iframe",
                            width:480,
                            height: 200,
                            options: {
                                modal: true,
                                enableKeys: true
                            }
                        });
                    });
                }
            });
        }
    });
    <?php
    }
    ?>
});

<?php if($login_fabrica == 161){ ?>

function bloqueia_produto(opt){

    if(opt == true){
        $("#lupa_referencia_produto").css({"display" : "inline"});
        $("#lupa_descricao_produto").css({"display" : "inline"});

        $("input[name='produto_referencia']").prop('readonly', false);
        $("input[name='produto_nome']").prop('readonly', false);

        $("#serie").prop('readonly', true);
        $("#lupa_pesquisa_serie").css({"display" : "none"});
    }else{
        $("#lupa_referencia_produto").css({"display" : "none"});
        $("#lupa_descricao_produto").css({"display" : "none"});

        $("input[name='produto_referencia']").prop('readonly', true);
        $("input[name='produto_nome']").prop('readonly', true);

        $("#serie").prop('readonly', false);
        $("#lupa_pesquisa_serie").css({"display" : "inline"});
    }

}

$(document).ready(function(){

    $("#produto_sem_serie").click(function(){
        if($(this).is(":checked")){
            bloqueia_produto(true);
            mostraDefeitos('Reclamado',document.frm_callcenter.produto_referencia.value);
        }else{
            bloqueia_produto(false);
            mostraDefeitos('Reclamado',document.frm_callcenter.produto_referencia.value);
        }
        $("input[name='produto_referencia']").val('');
        $("input[name='produto_nome']").val('');
        $("#serie").val('');
    });


    if ($("#produto_sem_serie").val() == 't') {
        bloqueia_produto(false);
    } else {
        bloqueia_produto(true);
    }
});

<?php } ?>
</script>

<script type="text/javascript" src="js/thickbox.js"></script>
<script src="../plugins/shadowbox/shadowbox.js" type="text/javascript" ></script>
<link rel="stylesheet" type="text/css" href="../plugins/shadowbox/shadowbox.css" media="all" >
<link rel="stylesheet" href="js/thickbox.css" type="text/css" media="screen" />


<!--<link href="https://developers.google.com/maps/documentation/javascript/examples/default.css" rel="stylesheet">
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&language=pt-br&key=AIzaSyC5AsH3NU-IwraXqLAa1qbXxyjklSVP-cQ"></script>-->

<script type="text/html" id="templateInstagramComments">
    <div class="chat-integracao" style="z-index:9999;bottom:0;right:5px;position:fixed;">
        <div style="float:right;padding:10px;">
            <a href="javascript:void(0)" class="chat-collapse">
                <i class="fas fa-window-minimize" style="font-size:16px;color:grey;margin-right:10px"></i>
            </a>
            <a href="javascript:void(0)" class="chat-destroy">
                <i class="fas fa-times" style="font-size:16px;color:grey"></i>
            </a>
        </div>
        <div class="chat-component">
            <iframe class="tchat" style="" src=""></iframe>
        </div>
    </div>
</script>

<script type="text/javascript">
    function setValidacaoAdmin(){
        <?if($login_fabrica == 151){?>
            $("#cpf, input[name^=serie_], input[name^=produto_referencia_]").change(function(){
                var number_input = $(this).attr('id').split("_").slice(-1);
                verifica_interventor_blur(number_input);
            });
        <?}else{?>
            $("#cpf, input[name^=serie_], input[name^=produto_referencia_]").blur(function(){
                var number_input = $(this).attr('id').split("_").slice(-1);
                verifica_interventor_blur(number_input);
            });
        <?}?>
    }

    function verifica_interventor_blur(number_input){
        var cpf          = $("#cpf").val();
            var referencia   = $("#produto_referencia_" + number_input);
            var serie        = $("#serie_" + number_input);

            if(typeof cpf == undefined || cpf.length == 0 || cpf.length > 14){
                return false;
            }

            if ($(this) == cpf) {
                referencia = null;
                serie = null;
            }

            $.ajax({
                async: true,
                type: 'POST',
                url: 'callcenter_interativo_new.php',
                data: { ajax_verifica_atendimento:true,
                        cpf_consumidor:cpf,
                        produto_referencia: referencia .val(),
                        serie: serie.val()
                    },
            })
            .done(function(data) {
                data = JSON.parse(data);

                if(data.error){
                    var atendimento = data.error;

                    Shadowbox.close();
                    setTimeout(function() {
                        Shadowbox.open({
                        content: "verifica_interventor.php?cpf_cnpj="+cpf+"&atendimento="+atendimento ,
                        player: "iframe",
                        width: 500,
                        height: 250,
                        options: {
                            modal: true,
                            enableKeys: false
                        }
                    });

                    $("#sb-nav").css({ display: "none" });

                    }, 1000);

                }
            });
    }

    <?php
    if (in_array($login_fabrica, array(169, 170)) || ($integracaoTelefonia === true)) {
    ?>
        $(document).on("ShadowboxInit", function() {
            var a = "<?=$_GET['a']?>";

        if (a.length == 0) {
        a = "<?=$_GET['A']?>";
        }
            if (a.length > 0) {
                $("#localizar_telefone").val(a).next("img").trigger("click");
                $("#consumidor_fone").val(a);
            }
        });
    <?php
    }
    ?>

    function retorna_permissao_abre_os(permissao) {
        if (permissao == 'cancelar') {
            $("input[name=abre_os_mondial]").removeAttr('checked');
        }
    }
    $(document).ready(function(resolve, reject) {
        Shadowbox.init();

        <?php if (in_array($login_fabrica, array(151))) { ?>
            $(document).on("change", "input[name=abre_os_mondial]", function(){
                if ($("input[name=abre_os]").is(":checked")) {
                    $("input[name=abre_os]").removeAttr('checked');
                    $("input[name=imprimir_os]").removeAttr('checked');
                }

                if ($(this).is(":checked")) {
                    Shadowbox.open({
                        content: "verifica_interventor.php?abre_os_mondial=t",
                        player: "iframe",
                        width: 600,
                        height: 250,
                        options: {
                                    modal: true,
                                    enableKeys: false,
                                    displayNav: false
                                }
                    });
                }
            });
            $(document).on("change", "input[name=abre_os]", function(){
                if ($(this).is(":checked")) {
                    $("input[name=abre_os_mondial]").removeAttr('checked');
                }
            });
        <?php }?>


        <?php
        if (in_array($login_fabrica, array(169, 170))) {
        ?>
            $("#mapa_linha").change(function(){
                if ($("#mapa_linha :selected").text() == 'Eletroportáteis') {
                    $('#lb_num_serie, #num_serie_cadastro').show();
                }else{
                    $('#lb_num_serie, #num_serie_cadastro').hide();
                }
            });
        <?php
        }
        ?>

        var login_fabrica = "<?=$login_fabrica?>";

        if (login_fabrica == 115  || login_fabrica == 116) {
            $("input[name=data_de_retorno]").mask("99/99/9999");
        }

        if (login_fabrica == 85) {

            $(".cliente_contratual_lupa").click(function(){

                var parametro_cliente   = $(this).data("tipo");
                var valor_campo_cliente = $(this).prev("input").val();

                Shadowbox.open({
                    content: "cliente_lupa_new.php?parametro="+parametro_cliente+"&valor="+valor_campo_cliente+"&contratual=t&callcenter=t",
                    player: "iframe",
                    width: 900,
                    height: 450
                });
            });

            if ($("#contratual_sim").is(":checked")) {
                $(".cliente_contratual").show();
                $("#garantia_contratual_click").show();
                $("input[name=data_encerramento_ambev]").val("");
                $("input[name=codigo_ambev]").val("");
                $("#garantia_contratual_click").click();
                $("input[name=garantia_estendida_check]").prop("checked", false);
            } else {
                $(".cliente_contratual").hide();
                $("#garantia_contratual_click").hide();
                $("input[name=garantia_contratual_check]").prop("checked", false);
            }

            $("input[name=data_fabricacao_ambev]").mask("99/99/9999");
            $("input[name=data_previsao_ambev]").mask("99/99/9999");
            $("input[name=data_encerramento_ambev]").mask("99/99/9999");

            $("input[name=atendimento_ambev]").change(function () {

                if ($("input[name=atendimento_ambev]:checked").val() == "t") {
                    $("#codigo_ambev").show();
                    $("#data_encerramento_ambev").show();
                    $("#garantia_estendida_ambev").show();

                    if ($("#contratual_sim").is(":checked")) {
                        $("input[name=atendimento_contratual]").prop("checked", false);
                        $(".cliente_contratual").hide();
                    }
                    $("#id_cliente_contratual").val("");
                    $("input[name=codigo_cliente_contratual]").val("");
                    $("input[name=nome_cliente_contratual]").val("");
                    $("#garantia_contratual_click").hide();
                    $("#garantia_estendida_click").click();
                    $("input[name=garantia_contratual_check]").prop("checked", false);
                } else {
                    $("#codigo_ambev").hide();
                    $("#data_encerramento_ambev").hide();
                    $("#garantia_estendida_ambev").hide();
                }

            });

            $("input[name=atendimento_contratual]").click(function () {

                if ($(this).val() == "t") {
                    $(".cliente_contratual").show();
                    $("#atendimento_ambev_sim").prop("checked", false);
                    $("#codigo_ambev").hide();
                    $("#data_encerramento_ambev").hide();
                    $("#garantia_estendida_ambev").hide();
                    $("#garantia_contratual_click").show();
                    $("#garantia_estendida_click").hide();
                    $("input[name=data_fabricacao_ambev]").val("");
                    $("input[name=data_previsao_ambev]").val("");
                    $("input[name=data_encerramento_ambev]").val("");
                    $("#garantia_contratual_click").click();
                    $("input[name=garantia_estendida_check]").prop("checked", false);
                } else {
                    $(".cliente_contratual").hide();
                    $("#garantia_contratual_click").hide();
                    $("#reclamacao_produto_click").click();
                    $("#id_cliente_contratual").val("");
                    $("input[name=codigo_cliente_contratual]").val("");
                    $("input[name=nome_cliente_contratual]").val("");
                }

            });

            $("#garantia_estendida_click").hide();

            function habilitarAbaGarantia_Estendida(){
                if ($("input[name=atendimento_ambev]:checked").val() == "t") {
                    $("#garantia_estendida_click").show();
                }else{

                    if ($("input[name=atendimento_contratual]:checked").val() =='f') {
                       $("#reclamacao_produto_click").click();
                    }

                    $("#garantia_estendida_click").hide();
                }
            }
            habilitarAbaGarantia_Estendida();
            if ($("textarea[name=reclamado_garantia_estendida]").attr("name") == "reclamado_garantia_estendida"){
                CKEDITOR.replace("reclamado_garantia_estendida", { enterMode : CKEDITOR.ENTER_BR});
            }
            $("input[name=atendimento_ambev]").change(function () {
                if (!$("#contratual_sim").is(":checked")) {
                    habilitarAbaGarantia_Estendida();
                }

            });

            $('#mapa_estado').change(function(){

                var estado = $(this).val();

                $.ajax({

                    url: "<?php echo $_SERVER['PHP_SELF']; ?>",
                    type: "POST",
                    data: "ajax-estado="+estado,
                    complete: function(data){
                        data = data.responseText;
                        $('#mapa_cidade').html(data);
                    }

                });

            });

            $('#mapa_cidade').change(function(){

                var cidade = $(this).val();

                $.ajax({

                    url: "<?php echo $_SERVER['PHP_SELF']; ?>",
                    type: "POST",
                    data: "ajax-cidade="+cidade,
                    complete: function(data){
                        data = data.responseText;
                        $('#postos_cidade').html(data);
                    }

                });

            });

            $('#postos_cidade').change(function(){

                var posto = $(this).val();
                if(login_fabrica != 74){
                    var cidade_posto = "";
                }
                informacoesPosto(posto, cidade_posto);

            });

        }else{
            if(login_fabrica == 74){

                $('#mapa_estado').change(function(){

                var estado = $(this).val();

                    $.ajax({

                        url: "<?php echo $_SERVER['PHP_SELF']; ?>",
                        type: "POST",
                        data: "ajax-estado="+estado,
                        complete: function(data){


                            data = data.responseText;
                            $('#mapa_cidade').html(data);
                        }

                    });

                });

                $('#serie').change(function(){
                    var serie_g = $(this).val();
                    //alert("akii");

                    $.ajax({
                        url:"callcenter_interativo_new.php",
                        type: "POST",
                        data: "ajax_garantia="+serie_g,
                        complete: function(data){
                            data = data.responseText;
                            //alert(data);
                            $('#serie_adcional').html(data);
                        }
                    });

                });

                $('#mapa_cidade').change(function(){

                    var cidade = $(this).val();

                    $.ajax({

                        url: "<?php echo $_SERVER['PHP_SELF']; ?>",
                        type: "POST",
                        data: "ajax-cidade="+cidade+"&bairro=true",
                        complete: function(data){
                            data = data.responseText;
                            $('#mapa_bairro').html(data);
                        }

                    });

                });

                $('#mapa_bairro').change(function(){

                    var cidade = $('#mapa_cidade').val();
                    var bairro = $(this).val();
                    //console.log(cidade);
                    //console.log(bairro);
                    $.ajax({

                        url: "<?php echo $_SERVER['PHP_SELF']; ?>",
                        type: "POST",
                        data: "ajax-cidade="+cidade+"&bairro_escolhido="+bairro,
                        complete: function(data){
                            data = data.responseText;
                            $('#postos_cidade').html(data);
                        }

                    });

                });

                function getPostosAjax(){
                    $.ajax({

                        url: "<?php echo $_SERVER['PHP_SELF']; ?>",
                        type: "POST",
                        data: "ajax-cidade="+cidade,
                        complete: function(data){
                            data = data.responseText;
                            $('#postos_cidade').html(data);
                        }
                    });

                }

                $('#postos_cidade').change(function(){

                    var posto = $(this).val();
                    var cidade_posto = "";
                    informacoesPosto(posto, cidade_posto);

                });
            }
        }

        <?php
        if (in_array($login_fabrica, [35])) { ?>
            $("#cnpj_emitente_nf").mask("99.999.999/9999-99");

            $(".valor_ressarcimento_reembolso").maskMoney({
                 prefix: "R$ ",
                 decimal: ",",
                 thousands: "."
             });

            $("#cnpj_emitente_nf").blur(function(){

                let cnpj = $(this).val();

                if (cnpj != "") {

                    $.ajax({
                        url: window.location,
                        type: "POST",
                        data: {verifica_cnpj_bloqueio: true, cnpj: cnpj},
                        timeout: 7000,
                        dataType: "json"
                    }).fail(function(){
                        alert('fail');
                    }).done(function(data){
                        
                        if (data.bloqueada) {

                            Shadowbox.open({
                                content: '<div style="width: 90%;height: 100%; padding: 20px;background-color: white;"> \
                                                <h1>&nbsp; &nbsp; Varejo de Salvados, por gentileza orientar que o consumidor entre em contato com a loja na qual realizou a compra de seu produto para verificação de Garantia. O atendimento deverá ser encerrado. </h1> <br /> \
                                                <br /> \
                                                <center><button style="height: 35px;cursor: pointer;widht: 250px;border-radius: 5px;color: #fff; background-color: #d9534f; border-color: #d43f3a;"                                                onClick="window.location=\'callcenter_interativo_new.php\' ">Encerrar Atendimento</button></center> </div>',
                                player: "html",
                                width: 500,
                                height: 250,
                                options: {
                                    modal: true,
                                    enableKeys: false,
                                    displayNav: false
                                }
                            });

                        }

                    });

                }

            });

            $(".select_motivo_ligacao").change(function(){

                if ($.trim($(this).find("option:selected").text()) == "Ressarcimento" || $.trim($(this).find("option:selected").text()) == "Reembolso ( boleto E-com)") {

                    $(".div-valor-reembolso").show();

                } else {

                    $(".div-valor-reembolso").hide();
                    $(".valor_ressarcimento_reembolso").val("");

                }

            });

        <?php
        }
        ?>

        <?php if ((in_array($login_fabrica, array(169,170)) || $usaScriptFalha) AND (!in_array($login_fabrica, [174]))) { ?>
            $(document).on('change', "#defeito_reclamado", function() {
                var defeito_reclamado = $(this).val();
                var defeito_reclamado_anterior = $("#defeito_reclamado_anterior").val();

                if($("#script_resolution").val().length > 0){
                    if(defeito_reclamado_anterior.length > 0 && defeito_reclamado_anterior != defeito_reclamado){
                        if(confirm('Atenção!! \n Alterando o Defeito Reclamado você vai perder o histórico do Script de Falha. \n Deseja Alterar o Defeito Reclamado?') == true){
                            $("#script_falha").val('');
                            $("#json_script").val('');
                            $("#json_execucao_script").val('');
                            $("#executar_script").prop('disabled', false);
                            $("#script_resolution").val('');
                            $("#ultima_pergunta_script").val('');
                            $("#ultima_resposta_script").val('');
                            $("#ultima_instrucao_script").val('');
                            $(".result_resolution").text('');
                            $("#resolution").hide();
                        }else{
                            $("#defeito_reclamado").val(defeito_reclamado_anterior);
                            defeito_reclamado = $("#defeito_reclamado").val();
                        }
                    }
                }

                if(defeito_reclamado.length > 0){
                    var produto = $("input[name='produto']").val();
                    $.ajax({
                        url: window.location,
                        type: "POST",
                        data: {verifica_script: 'true', defeito_reclamado: defeito_reclamado, produto: produto},
                        timeout: 7000
                    }).fail(function(){
                        alert('fail');
                    }).done(function(data){
                        data = JSON.parse(data);
                        if(data.resultado == 'ok'){
                            $("#bloco_script_falha").show();
                            $("#familia_script").val(data.familia);
                            $("#script_falha").val(data.script_falha);
                            $("#json_script").val(data.json_script);
                            $("#json_execucao_script").val(data.json_execucao_script);
                        }else{
                            $("#bloco_script_falha").hide();
                        }
                        $("#defeito_reclamado_anterior").val(defeito_reclamado);

                    });
                }else{
                    $("#bloco_script_falha").hide();
                }
            });
        <?php } ?>

        if(login_fabrica == 151 || login_fabrica == 169 || login_fabrica == 170){
            if(login_fabrica != 169 && login_fabrica != 170){
                $("#tipo_postagem").change(function(){
                    var codigo_posto_tab    = $("#codigo_posto_tab").val();
                    var posto_nome_tab      = $("#posto_nome_tab").val();
                    var consumidor_estado   = $("#consumidor_estado").val();
                    var consumidor_cidade   = $("#consumidor_cidade").val();

                    if (codigo_posto_tab == '' || posto_nome_tab == '' && (consumidor_estado != '' && consumidor_cidade != '')) {
                        $.ajax({
                            type: 'POST',
                            url: 'callcenter_interativo_new.php',
                            data: {
                                    ajax_carrega_posto:true,
                                    consumidor_estado:consumidor_estado,
                                    consumidor_cidade:consumidor_cidade
                                },
                        })
                        .done(function(data) {
                            data = JSON.parse(data);
                            if(data != ''){
                                $("#posto_tab").val(data.posto);
                                $("#codigo_posto_tab").val(data.codigo_posto);
                                $("#posto_nome_tab").val(data.nome);
                                $("#posto_fone_tab").val(data.fone);
                                $("#posto_email_tab").val(data.email);

                            }
                        });
                    }
                });
            }

            setValidacaoAdmin();

            <?php if(in_array($login_fabrica, array(169,170)) AND strlen(trim($_GET['Id'])) > 0){ ?>
                var getId = "<?=$_GET['Id']?>";
                $("#cpf").on("blur-verifica-cpf", function(){
                    var cpf = $(this).val();

                    if(typeof cpf == undefined || cpf.length == 0 || cpf.length > 14){
                        return false;
                    }
                    $.ajax({
                        async: true,
                        type: 'POST',
                        url: 'callcenter_interativo_new.php',
                        data: { ajax_verifica_atendimento:true, cpf_consumidor:cpf },
                    })
                    .done(function(data) {
                        data = JSON.parse(data);

                        if(data.error){

                            var atendimento = data.error;

                            Shadowbox.close();
                            setTimeout(function() {
                                Shadowbox.open({
                                content: "verifica_interventor.php?cpf_cnpj="+cpf+"&atendimento="+atendimento ,
                                player: "iframe",
                                width: 500,
                                height: 220,
                                options: {
                                    modal: true,
                                    enableKeys: false
                                }
                            });

                            $("#sb-nav").css({ display: "none" });

                            }, 1000);
                        }
                    });

                });
                $("#cpf").trigger("blur-verifica-cpf");
            <?php } ?>
        }

        if(login_fabrica == 30){
            $("#nota_fiscal").change(function(){
                var nota_fiscal = $(this).val();
                var cpf = $("#cpf").val();
                let hdchamado = '<?=$callcenter?>'

                if (hdchamado == undefined || hdchamado == '') {
                    hdchamado = 'novo';
                }

                if(nota_fiscal.length == 0){
                    return false;
                }

                if(typeof cpf == undefined || cpf.length == 0 || cpf.length > 14){
                    return false;
                }

                $.ajax({
                    async: true,
                    type: 'POST',
                    url: 'callcenter_interativo_new.php',
                    data: { ajax_verifica_atendimento:true, nota_fiscal:nota_fiscal,cpf_consumidor:cpf },
                    beforeSend: function() {
                        $('.loading_nf').show();
                    }
                })
                .done(function(data) {
                    $('.loading_nf').hide();
                    data = JSON.parse(data);

                    if(data.error){

                        var atendimento = data.error;

                        Shadowbox.close();
                        setTimeout(function() {
                            // Shadowbox.init();

                            Shadowbox.open({
                            content: "verifica_interventor.php?nota_fical="+nota_fiscal+"&cpf_cnpj="+cpf+"&atendimento="+atendimento+"&hdchamado="+hdchamado ,
                            player: "iframe",
                            width: 500,
                            height: 220,
                            options: {
                                modal: true,
                                enableKeys: false
                            }
                        });

                        $("#sb-nav").css({ display: "none" });

                        }, 1000);

                    }
                });
                $('.loading_nf').hide();
            });

            $("#serie").change(function(){
                var serie = $(this).val();
                let hdchamado = '<?=$callcenter?>'

                if (hdchamado == undefined || hdchamado == '') {
                    hdchamado = 'novo';
                }

                if(typeof serie == undefined || serie.length == 0){
                    return false;
                }

                $.ajax({
                    async: true,
                    type: 'POST',
                    url: 'callcenter_interativo_new.php',
                    data: { ajax_verifica_atendimento_serie:true, serie:serie },
                    beforeSend: function() {
                        $('.loading_serie').show();
                    }
                })
                .done(function(data) {
                    $('.loading_serie').hide();
                    data = JSON.parse(data);
                    if(data.error){

                        var atendimento = data.error;

                        Shadowbox.close();
                        setTimeout(function() {
                            // Shadowbox.init();

                            Shadowbox.open({
                            content: "verifica_interventor.php?serie="+serie+"&atendimento="+atendimento+"&hdchamado="+hdchamado ,
                            player: "iframe",
                            width: 500,
                            height: 220,
                            options: {
                                modal: true,
                                enableKeys: false
                            }
                        });

                        $("#sb-nav").css({ display: "none" });

                        }, 1000);

                    }
                });

                $('.loading_serie').hide();
            });
        }

        <?php if(in_array($login_fabrica,[120,201]) AND strlen(trim($_GET['callcenter'])) == 0){ //hd_chamado=2692262 ?>
            setTimeout(function(){
                confirmNEW();
            },1000);
        <?php } ?>

        $("#data_prov").blur(function(){

            setTimeout(function(){

                var data_prov = $("#data_prov").val();
        var data_prov_ant = $("#data_prov_ant").val();

        if(data_prov != data_prov_ant){
            var data = [];
            data = data_prov.split("/");

            var data_1 = new Date(data[2]+"-"+data[1]+"-"+data[0]);
            var data_2 = new Date("<?php echo date('Y-m-d'); ?>");

            if(data_1 < data_2){
                $("#data_prov").val("<?php echo date('d/m/Y'); ?>");
                alert("A data informada não pode ser menor do que a data atual.");
            }
        }

            }, 500);

        });

    });

    function retorna_cliente_contratual(retorno) {
        $("input[name=codigo_cliente_contratual]").val(retorno.codigo_cliente);
        $("input[name=nome_cliente_contratual]").val(retorno.nome);
        $("#id_cliente_contratual").val(retorno.cliente);
    }
function confirmNEW(){ //hd_chamado=2692262
    Shadowbox.open({
        content:"<div style='background:#FFFFFF;height:100%;text-align:center;'><br><p style='font-size:14px;font-weight:bold'>Esta abertura de chamado irá gerar protocolo. Deseja continuar?</p><br /><br><p><input type='button' value='Sim' style='padding: 5px; width:80px;' onclick=\"javascript:geraProtocolo();\">&nbsp &nbsp <input type='button' value='Não' style='padding: 5px; width:80px;' onclick=\"javascript:Shadowbox.close();\"></p></div>",
        player:     "html",
        title:      "Gerar Protocolo.",
        width:      600,
        height:     200
    });
}


function atualizaMapa(){
    var cidade = $('#consumidor_cidade').val();
    var estado = $('#consumidor_estado').val();
    $('#link').attr('href','callcenter_interativo_posto.php?fabrica=12<?echo $login_fabrica;?>&cidade='+cidade+'&estado='+estado+'&keepThis=trueTB_iframe=true&height=400&width=700')
    $('#link2').attr('href','callcenter_interativo_posto.php?fabrica=12<?echo $login_fabrica;?>&cidade='+cidade+'&estado='+estado+'&keepThis=trueTB_iframe=true&height=400&width=700')
}
function minimizar(arquivo){
    if (document.getElementById(arquivo)){
        var style2 = document.getElementById(arquivo);
        if (style2==false) return;
        if (style2.style.display=="block"){
            style2.style.display = "none";
        }else{
            style2.style.display = "block";
        }
    }
}

function formata_data(valor_campo, form, campo){
    var mydata = '';
    mydata = mydata + valor_campo;
    myrecord = campo;
    myform = form;

    if (mydata.length == 2){
        mydata = mydata + '/';
        window.document.forms["" + myform + ""].elements[myrecord].value = mydata;
    }
    if (mydata.length == 5){
        mydata = mydata + '/';
        window.document.forms["" + myform + ""].elements[myrecord].value = mydata;
    }

}

function fnc_pesquisa_satisfacao(callcenter){
    var pesquisa_selecionada = $("#tipo_pesquisa_callcenter").val();

    Shadowbox.open({
      content :   "pesquisa_satisfacao_new.php?callcenter="+callcenter+"&pesquisa_selecionada="+pesquisa_selecionada,
      player  :   "iframe",
      title   :   "Pesquisa de Satisfação",
      width   :   800,
      height  :   500
   });
}

function fnc_pesquisa_satisfacao_new(token, callcenter, tipo){

    Shadowbox.open({
      content :   "../externos/pesquisa_satisfacao_callcenter.php?token="+token+"&callcenter="+callcenter+"&tipo="+tipo,
      player  :   "iframe",
      title   :   "Pesquisa de Satisfação",
      width   :   800,
      height  :   500
   });
}


function fnc_discar(telefone) {
    var numerodiscar = telefone.replace(/[^0-9]+/g,'');
    if (numerodiscar == "") {
        window.alert("Campo telefone não pode ser vazio");
    } else {
            $.ajax ({
                url: "callcenter_interativo_new.php",
                type: "POST",
                data: {
                    numerodiscar: numerodiscar,
                    hdchamado: '<?=$callcenter?>',
                    ajax_discar: true
                },
                async: true,
                timeout: 10000
            }).done(function(response) {
                response = JSON.parse(response);
                if (response.exception != undefined) {
                    alert('Ocorreu ao tentar efetuar a ligação: ' + response.exception);
                }
            });
    }
}

//HD 163220 - Alterada a função para chamar pesquisa de todos os tipos pelo popup
/*************************************************************************************/
/*************************** Função PESQUISA DE CONSUMIDOR ***************************/
/*************************************************************************************/
function fnc_pesquisa_consumidor_callcenter(valor, tipo_pesquisa, busca_exata, tipo_retorno, ligacao_id) {
    var ligacao_id = "<?=$_REQUEST['ligacao_id'] ?>";
    var exata = "nao";
    if (busca_exata) {
        exata = "sim";
    }

    if (tipo_retorno == "undefined" || tipo_retorno == null) {
        tipo_retorno = "";
    }

    if (valor.length >= 2) {
	Shadowbox.open({
            content :   "pesquisa_consumidor_callcenter_nv.php?descricao_pesquisa="+valor+"&tipo_pesquisa="+tipo_pesquisa+"&exata="+exata+"&tipo_retorno="+tipo_retorno+"&ligacao_id="+ligacao_id,
            player  :   "iframe",
            title   :   "Pesquisa",
            width   :   800,
            height  :   500
        });

    } else {
        alert("Digite pelo menos 3 caracteres para efetuar a busca");
    }
}

<?php
if (in_array($login_fabrica, array(169,170,184,200))) {
?>
    function retorna_os(os) {
        $("#os").val(os);
        Shadowbox.close();
    }
<?php
}
?>


function fnc_pesquisa_revenda (campo, tipo,cidade) {
    var url = "";
    if (tipo == "nome") {
        url = "pesquisa_revenda_callcenter.php?nome=" + campo.value + "&tipo=nome";
    }
    if (tipo == "cnpj") {
        url = "pesquisa_revenda_callcenter.php?cnpj=" + campo.value + "&tipo=cnpj";
    }
    if (tipo == "cidade") {
        url = "pesquisa_revenda_callcenter.php?cidade=" + campo.value + "&tipo=cidade";
    }
    if (tipo == "familia") {
        url = "pesquisa_revenda_callcenter.php?familia=" + campo.value + "&tipo=familia&consumidor_cidade=" + cidade.value;

    }

    janela = window.open(url,"janela","toolbar=no,location=yes,status=yes,scrollbars=yes,directories=no,width=500,height=400,top=18,left=0");

    <?php if($tab_atual == "indicacao_rev"){ ?>
            janela.nome         = document.frm_callcenter.revenda_ind_nome;
            janela.cnpj         = document.frm_callcenter.revenda_ind_cnpj;
            janela.revenda      = document.frm_callcenter.revenda_ind;
    <?php }else { ?>
            janela.nome         = document.frm_callcenter.revenda_nome;
            janela.revenda      = document.frm_callcenter.revenda;
    <?php } ?>
    janela.endereco     = document.frm_callcenter.revenda_endereco;
    janela.numero       = document.frm_callcenter.revenda_nro;
    janela.complemento  = document.frm_callcenter.revenda_cmpto;
    janela.bairro       = document.frm_callcenter.revenda_bairro;
    janela.cidade       = document.frm_callcenter.revenda_city;
    janela.estado       = document.frm_callcenter.revenda_uf;
    janela.fone         = document.frm_callcenter.revenda_fone;
    janela.focus();
}

function pesquisaRevenda(campo,tipo){
        var campo = campo.value;

        if (campo.value != ""){
            Shadowbox.open({
                content:    "pesquisa_revenda_nv.php?"+tipo+"="+campo+"&tipo="+tipo,
                player: "iframe",
                title:      "Pesquisa Revenda",
                width:  800,
                height: 500
            });
        }else
            alert("Informar toda ou parte da informação para realizar a pesquisa!");
    }

function retorna_revenda(nome,cnpj,nome_cidade,fone,endereco,numero,complemento,bairro,cep,estado,email,revenda){
    gravaDados("revenda_ind_nome",nome);
    gravaDados("revenda_ind_cnpj",cnpj);
    gravaDados("revenda_ind",revenda);
}

function ouvir_gravacoes(id_ligacao_gr){
    Shadowbox.open({
        content: "callcenter_ouvir_gravacoes.php?id_ligacao_gr=" + id_ligacao_gr,
        player: "iframe",
        title: "Baixar Gravação",
        width: 320,
        height: 120,
        options: {
            modal: true,
            enableKeys: false,
            displayNav: true
        }
    });
}

function toggleInstagramComment(button, callcenter, admin, businessAccount, commentId) {
    $(button).prop("onclick", null).off("click");

    let icon = $("<i></i>", {class: "fas fa-spinner fa-spin", css: {"font-size": "16px"}});

    $(button).find("i").remove()
    $(button).append(icon);

    let baseIframeUrl = 'https://tchat.telecontrol.com.br/atendente/callcenter-ig/callcenter/' + callcenter + '/admin/' + admin + '/account/' + businessAccount + '/comment/' + commentId;
    let template = $.parseHTML($("#templateInstagramComments").html().trim());

    $(template).css("display", "none");
    $(template).css('background', '-moz-linear-gradient(-45deg, #c084e8 0%, #f29ef6 31%, #f29ef6 31%, #ffc793 68%, #ffffff 100%)');
    $(template).css('background', '-webkit-linear-gradient(-45deg, #c084e8 0%,#f29ef6 31%,#f29ef6 31%,#ffc793 68%,#ffffff 100%)');
    $(template).css('background', 'linear-gradient(135deg, #c084e8 0%,#f29ef6 31%,#f29ef6 31%,#ffc793 68%,#ffffff 100%)')

    $(template).find(".chat-component").find("iframe").attr("src", baseIframeUrl);

    $(template).find(".chat-collapse").find("i").on("click", function (e) {
        e.stopPropagation();
        $(template).find(".chat-component").toggle(100);
    })

    $(template).find(".chat-destroy").find("i").on("click", function (e) {
        e.stopPropagation();
        $(template).toggle(100, function () {
            $(this).remove();
            $(button).on("click", function (e) {
                toggleInstagramComment(button, callcenter, admin, businessAccount, commentId)
            });
        });
    })

    window.addEventListener('message', function (e) {
        if (e.data == 'loaded') {
            icon = $("<i></i>", {class: "far fa-comment", css: {"font-size": "16px"}});

            $(button).find("i").remove()
            $(button).append(icon);

            $(template).toggle(100, function () {
                $(template).find(".chat-component").toggle(100);
            });
        }
    }, false);

    $("#footer").append(template);
}

function pesquisaPosto(campo,tipo){
    var campo = campo.value;

    if (campo.value != ""){
        Shadowbox.open({
            content:    "posto_pesquisa_2_nv.php?"+tipo+"="+campo+"&tipo="+tipo,
            player:     "iframe",
            title:      "Pesquisa Posto",
            width:      800,
            height:     500
        });
    }else
        alert("Informar toda ou parte da informação para realizar a pesquisa!");
}

function retorna_posto(codigo,posto, nome) {
    gravaDados("codigo_posto_ind", codigo);
    gravaDados("posto_nome_ind", nome);
}
function retorna_tipo_posto(descricao_tipo_posto){

    if(descricao_tipo_posto == "Representante"){
        $("#envia_email_representante").show();
    }else{
        $("#envia_email_representante").hide();
    }
}
function gravaDados(name, valor){
    try{
        $("input[name="+name+"]").val(valor);
    } catch(err){
        return false;
    }
}

function zxxx (campo) {

    url = "pesquisa_os_callcenter.php?sua_os=" + campo;
    janela = window.open(url,"janela","toolbar=no,location=yes,status=yes,scrollbars=yes,directories=no,width=500,height=400,top=18,left=0");
    janela.sua_os           = document.frm_callcenter.sua_os;
    janela.data_abertura    = document.frm_callcenter.data_abertura;
    janela.data_nf          = document.frm_callcenter.data_nf;
    janela.serie            = document.frm_callcenter.serie;
    janela.nota_fiscal      = document.frm_callcenter.nota_fiscal;
    janela.produto          = document.frm_callcenter.produto;
    janela.produto_nome     = document.frm_callcenter.produto_nome;
    janela.revenda_nome     = document.frm_callcenter.revenda_nome;
    janela.revenda          = document.frm_callcenter.revenda;
    //janela.posto          = document.frm_callcenter.posto;
    janela.posto_nome       = document.frm_callcenter.posto_nome;

    janela.focus();

}

/* ============= Função PESQUISA DE POSTO POR MAPA ====================
Nome da Função : fnc_pesquisa_at_proximo()
=================================================================*/
function fnc_pesquisa_at_proximo(fabrica) {
    url = "callcenter_interativo_posto.php?fabrica=12"+fabrica;
    janela = window.open(url,"janela","toolbar=no,location=yes,status=yes,scrollbars=yes,directories=no,width=750,height=500,top=18,left=0");
    janela.posto_tab = document.frm_callcenter.posto_tab;
    janela.codigo_posto_tab = document.frm_callcenter.codigo_posto_tab;
    janela.posto_nome_tab = document.frm_callcenter.posto_nome_tab;
    janela.posto_cidade_tab = document.frm_callcenter.posto_cidade_tab;
    janela.posto_estado_tab= document.frm_callcenter.posto_estado_tab;
    janela.posto_endereco_tab = document.frm_callcenter.posto_endereco_tab;
    janela.posto_km_tab = document.frm_callcenter.posto_km_tab;
    janela.posto_fone_tab = document.frm_callcenter.posto_fone_tab;
    janela.posto_email_tab = document.frm_callcenter.posto_email_tab;
    janela.abas = $('#container-Principal');
    janela.focus();
}

/* ========== Função AJUSTA CAMPO DE DATAS =========================
Nome da Função : ajustar_data (input, evento)
        Ajusta a formatao da Máscara de DATAS a medida que ocorre
        a digitação do texto.
=================================================================*/
function ajustar_data(input , evento)
{
    var BACKSPACE=  8;
    var DEL=  46;
    var FRENTE=  39;
    var TRAS=  37;
    var key;
    var tecla;
    var strValidos = "0123456789" ;
    var temp;
    tecla= (evento.keyCode ? evento.keyCode: evento.which ? evento.which : evento.charCode)

    if (( tecla == BACKSPACE )||(tecla == DEL)||(tecla == FRENTE)||(tecla == TRAS)) {
        return true;
            }
        if ( tecla == 13) return false;
        if ((tecla<48)||(tecla>57)){
            return false;
            }
        key = String.fromCharCode(tecla);
        input.value = input.value+key;
        temp="";
        for (var i = 0; i<input.value.length;i++ )
            {
                if (temp.length==2) temp=temp+"/";
                if (temp.length==5) temp=temp+"/";
                if ( strValidos.indexOf( input.value.substr(i,1) ) != -1 ) {
                    temp=temp+input.value.substr(i,1);
            }
            }
                    input.value = temp.substr(0,10);
                return false;
}

function createRequestObject(){
    var request_;
    var browser = navigator.appName;
    if(browser == "Microsoft Internet Explorer"){
         request_ = new ActiveXObject("Microsoft.XMLHTTP");
    }else{
         request_ = new XMLHttpRequest();
    }
    return request_;
}

var http1 = new Array();

<?php if ($login_fabrica == 24 && empty($callcenter)) { ?>
$(document).ready(function(){
    window.onload = function(){
        var xprod_ref = $("input[name='produto_referencia']").val();
        if (xprod_ref != '') {
            $("input[name='produto_referencia_anterior']").val('');
            $("input[name='produto_nome_anterior']").val('');
            mostraDefeitos('Reclamado',xprod_ref);
        }
    }
});
<? } ?>

function mostraDefeitos(natureza,produto,idx,defeito){

    <?  if(in_array($login_fabrica, [52,151,186,189,190,195])){ ?>

        /* Validação para não realizar a ação para produto igual */
        var produto_referencia_anterior = $("input[name='produto_referencia_anterior_"+idx+"']").val();
        var produto_descricao_anterior = $("input[name='produto_nome_anterior_"+idx+"']").val();
        var produto_referencia_atual = $("input[name='produto_referencia_"+idx+"']").val();
        var produto_descricao_atual = $("input[name='produto_nome_"+idx+"']").val();

    <? } else { ?>

        /* Validação para não realizar a ação para produto igual */
        var produto_referencia_anterior = $("input[name='produto_referencia_anterior']").val();
        var produto_descricao_anterior = $("input[name='produto_nome_anterior']").val();
        var produto_referencia_atual = $("input[name='produto_referencia']").val();
        var produto_descricao_atual = $("input[name='produto_nome']").val();

    <? } ?>

    if($.trim(produto_referencia_anterior) == $.trim(produto_referencia_atual) && $.trim(produto_descricao_anterior) == $.trim(produto_descricao_atual)){
        return;
    }

    var curDateTime = new Date();
    http1[curDateTime] = createRequestObject();
    url = "callcenter_interativo_defeitos.php?ajax=true&natureza="+ natureza +"&produto=" + produto + "&defeito=" +defeito;
    http1[curDateTime].open('get',url);

    <?php
    if (in_array($login_fabrica, [52,151,186,190,195])) {
        $campo = "'defeito_reclamado_'";
    } else {
        $campo = "'div_defeitos'";
    } ?>

    //hd_chamado=3196041
    if (typeof idx != "undefined" && idx != "undefined" && idx != null) {
        if(idx.length > 0){
            <?php if (in_array($login_fabrica, [52,151,186,190,195])) { ?>
                var el = <?= $campo; ?> + idx;
            <? } else { ?>
                var el = <?= $campo; ?>;
            <? } ?>
        }else{
            var el = <?= $campo; ?>;
        }

    } else {
        var el = <?= $campo; ?>;
    }

    var campo = document.getElementById(el);

    if (!campo) {
        return true;
    }


    <? if ($login_fabrica == 52) { ?>
       if (campo.value.length == 0){
    <? } ?>
        http1[curDateTime].onreadystatechange = function(){
            if(http1[curDateTime].readyState == 1) {
                campo.innerHTML = "<img src='imagens_admin/carregando_callcenter.gif' border='0'><font size='1' face='arial'>Aguarde..</font>";
            }
            if (http1[curDateTime].readyState == 4){
                if (http1[curDateTime].status == 200 || http1[curDateTime].status == 304){
                    var results = http1[curDateTime].responseText;
                    $(campo).html(results);
                }else {
                    campo.innerHTML = "Erro";
                }
            }
        }
        http1[curDateTime].send(null);

    <? if ($login_fabrica == 52) { ?>
        } else {
            return false;
        }
    <? } ?>

}

var http2 = new Array();
function localizarFaq(produto,local,action){
    var action          = ( action == undefined ) ? 'pesquisa' : action ;
    var faq_duvida      = (action == 'pesquisa') ? document.getElementById(local).value : '    ';
    var campo           = '#div_'+local;
    var hd_chamado      = '<?php echo $callcenter; ?>';
    var buscar_marcados = ( action == 'pesquisa' ) ? '0' : '1' ;
    if ( hd_chamado.length <= 0 ) {
        hd_chamado = 0;
    }
    if(produto.length==0 && action == 'pesquisa'){
        alert('Por favor selecione o produto');
        return 0;
    } else if ( produto.length==0 ) {
        return 0;
    }

    <?php if($login_fabrica != 42){ ?>
        if(faq_duvida.length==0){
            alert('Por favor inserir a dÃºvida');
            return 0;
        }
    <?php } ?>

    //url    = "callcenter_interativo_ajax.php";
    //params = {'ajax':'true', 'faq_duvida':'true','produto':produto,'duvida':faq_duvida,'hd_chamado':hd_chamado,'buscar_marcados':buscar_marcados };
    url    = "callcenter_interativo_ajax.php?ajax=true&faq_duvida=true&produto="+produto+"&faq_duvida="+faq_duvida+"&hd_chamado="+hd_chamado+"&buscar_marcados="+buscar_marcados;
    params = '';
    $(campo).empty();
    $.get(url,params,function(resposta) {
        $(campo).html(resposta);
        $('.chk_faq').click(function() {
            $('.chk_faq').parent().css('background','none').css('cursor','pointer')
                         .end().filter(':checked').parent().css('background','#BCCACD');
        });
    },'html');
}

function localizarNovoFaq(referencia, descricao){
    var hd_chamado = '<?=$callcenter?>';

    if(referencia == ""){
        referencia = $("input[name=produto_referencia]").val();
    }

    if(descricao == ""){
        descricao = $("input[name=produto_nome]").val();
    }

    if ( hd_chamado.length <= 0 ) {
        hd_chamado = 0;
    }

    if(referencia.length==0){
        alert('Por favor selecione o produto');
        return false;
    }

    var dataAjax = {
        ajax: true,
        novo_faq: true,
        referencia: referencia,
        descricao: descricao,
        duvida: $("#faq_duvida_duvida").val(),
        hd_chamado: hd_chamado
    }

    $.ajax({
        url: 'callcenter_interativo_ajax.php',
        type: 'GET',
        data: dataAjax
    }).done(function(data){
        $("#div_situacao").html(data);
        return true;

    }).fail(function(data){
        // var value = JSON.parse(data);
        // if(value.resultado == false){
            // $("#mensagem").html('<div class="alert alert-error"><h4>'+value.mensagem+'</h4> </div>');
        // }
        return false;
    });
}

function escolhaSituacao(faq){
    var hd_chamado = "<?=$callcenter?>";

    if(faq != ""){
        hd_chamado = 0;
    }

    var dataAjax = {
        ajax: true,
        faq_selecionado: true,
        faq: faq,
        hd_chamado: hd_chamado
    }

    $.ajax({
        url: 'callcenter_interativo_ajax.php',
        type: 'GET',
        data: dataAjax
    }).done(function(data){
        $("#div_causa_solucao").html(data);
        return true;

    }).fail(function(data){
        return false;
    });
}

var http3 = new Array();
function localizarConsumidor(busca,tipo){
    if (tipo=='novo'){
        $('#tabela_consumidor input').each( function(){
            $(this).val('');
        });
        $('#consumidor_nome').focus();
        return false;
    }
    var campo = document.getElementById('div_consumidor');
    $(campo).empty();
    var busca = document.getElementById(busca).value;
    var curDateTime = new Date();
    http3[curDateTime] = createRequestObject();

    url = "callcenter_interativo_ajax.php?ajax=true&busca_cliente=tue&busca=" + busca + "&tipo=" + tipo;
    http3[curDateTime].open('get',url);

    http3[curDateTime].onreadystatechange = function(){
        if(http3[curDateTime].readyState == 1) {
            campo.innerHTML = "<img src='imagens_admin/carregando_callcenter.gif' border='0'><font size='1' face='arial'>Aguarde..</font>";
        }
        if (http3[curDateTime].readyState == 4){
            if (http3[curDateTime].status == 200 || http3[curDateTime].status == 304){
                var results = http3[curDateTime].responseText;
                campo.innerHTML   = results;
                bindEventClienteNomeAdmin(campo);
            }else {
                campo.innerHTML = "Erro";
            }
        }

        $("#consumidor_fone").mask("(999) 9999-9999");
        $("#consumidor_cep").mask("99999-999");
        $("#hora_ligacao").mask("99:99");
    }
    http3[curDateTime].send(null);
}

function mostraEsconde(){
    $("div[@rel=div_ajuda]").toggle();
}
var http4 = new Array();
function fn_verifica_garantia(){
    var produto_nome       = document.getElementById('produto_nome_es').value;
    var produto_referencia = document.getElementById('produto_referencia_es').value;
    var serie              = document.getElementById('serie_es').value;
     var campo = document.getElementById('div_estendida');
    var curDateTime = new Date();
    http4[curDateTime] = createRequestObject();

    url = "callcenter_interativo_ajax.php?ajax=true&garantia=tue&produto_nome=" + produto_nome + "&produto_referencia=" + produto_referencia+"&serie="+serie+"&data="+curDateTime;
    http4[curDateTime].open('get',url);

    http4[curDateTime].onreadystatechange = function(){
        if(http4[curDateTime].readyState == 1) {
            campo.innerHTML = "<img src='imagens_admin/carregando_callcenter.gif' border='0'><font size='1' face='arial'>Aguarde..</font>";
        }
        if (http4[curDateTime].readyState == 4){
            if (http4[curDateTime].status == 200 || http4[curDateTime].status == 304){
                var results = http4[curDateTime].responseText;
                campo.innerHTML   = results;
            }else {
                campo.innerHTML = "Erro";
            }
        }
        $("#es_data_compra").mask("99/99/9999");
        $("#es_data_nascimento").mask("99/99/9999");
        $("#es_fonecomercial").mask("(99) 9999-9999");
    }
    http4[curDateTime].send(null);
}

<?php
if ($login_fabrica == 140) {?>
    // /*  Tirei o bairro e aumentei o tamanhodo pop-up    */
function mapa_rede_new(linha,estado,cidade,cep,endereco,numero,bairro,consumidor_cidade,consumidor_estado){

    if (linha.value == '') {

        alert("Favor selecionar a Linha do Posto !");

    } else {

        var endereco_completo = "";
        var endereco_rota = "";

        if(endereco.value != ""){ endereco_completo += endereco.value+","; }
        if(numero.value != ""){ endereco_completo += numero.value+","; }
        if(bairro.value != ""){ endereco_completo += bairro.value+","; }
        if(consumidor_cidade.value != ""){ endereco_completo += consumidor_cidade.value+","; }
        if(consumidor_estado.value != ""){ endereco_completo += consumidor_estado.value; }
        endereco_completo += ", Brasil";

        if(endereco.value != ""){ endereco_rota += endereco.value+","; }
        if(numero.value != ""){ endereco_rota += numero.value+","; }
        if(consumidor_cidade.value != ""){ endereco_rota += consumidor_cidade.value+","; }
        if(consumidor_estado.value != ""){ endereco_rota += consumidor_estado.value; }
        endereco_rota += ", Brasil";

        var nome_cliente = $("#consumidor_nome").val();

        var get = [
            "callcenter=true",
            "linha="+linha.value,
            "nome="+nome_cliente,
            "cep="+cep.value,
            "pais=BR",
            "consumidor_estado="+consumidor_estado.value,
            "estado="+estado.value,
            "consumidor_cidade="+consumidor_cidade.value,
            "cidade="+cidade.value,
            "bairro="+bairro.value,
            "numero="+numero.value,
            "endereco="+endereco.value,
            "endereco_rota="+endereco_rota,
            "consumidor="+endereco_completo
        ];

        url = "mapa_rede_new.php?"+get.join("&");
        janela = window.open(url,"janela","width=960,height=600,scrollbars=yes,resizable=yes");
        janela.posto_tab        = document.frm_callcenter.posto_tab;
        janela.codigo_posto_tab = document.frm_callcenter.codigo_posto_tab;
        janela.posto_nome_tab   = document.frm_callcenter.posto_nome_tab;
        janela.posto_email_tab  = document.frm_callcenter.posto_email_tab;
        janela.posto_fone_tab   = document.frm_callcenter.posto_fone_tab;
        janela.posto_km_tab     = document.frm_callcenter.posto_km_tab;

    }

}
<?php
}else{?>
$(function(){

    $("#consultar_informacoes_tecnicas").click(function(){

        var produto_referencia = $("input[name='produto_referencia']").val();

        Shadowbox.open({
            content: "consulta_informacoes_tecnica.php?produto_referencia="+produto_referencia,
            player: "iframe",
            width: '700px',
            height: '500px'
        });
    });

    $(document).on('change, click', 'input[name=tipo_posto]', function() {

        var tipo = $(this).data('descricao');
        if (tipo == 'Representante') {
            $('.txt_cod_posto').text('Código do Representante');
            $('.txt_nome_posto').text('Nome do Representante');
        } else {
            $('.txt_cod_posto').text('Código da Revenda');
            $('.txt_nome_posto').text('Nome da Revenda');
        }
    });
    $("input[name=tipo_posto]").click(function() {
        $("input[name=tipo_posto]").removeAttr('checked');
        $(this).attr('checked', 'true');

    });
    $("#btn_mapa").click(function() {
        var login_fabrica = <?=$login_fabrica?>;
        var linha = $("#mapa_linha").val();
        var nome_cliente = $("#consumidor_nome").val();
        var endereco_completo = [];
        var endereco_rota = [];
        var hd_chamado = $("input[name='callcenter']").val();
        var estado,
            cidade,
            cep,
            endereco,
            numero,
            bairro,
            local_cidade,
            local_estado,
            mapa_endereco,
            mapa_rota
            produto;

        if(login_fabrica == 169 || login_fabrica == 170){
            cep = $("#consumidor_cep").val();
            if(cep == "" || cep == "undefined"){
                alert("Informe o CEP para consultar o mapa de postos autorizados");
                return false;
            }
        }

        if(login_fabrica == 189){

            var tipo_posto      = $("input[name=tipo_posto]:checked").val();
            var tipo_cliente    = $("select[name=tipo_cliente] option:selected").val();
            var text_tipo_posto = $("input[name=tipo_posto]:checked").data('descricao');
            var produto         = $("#produto_referencia_1").val();

            if(produto == "" || produto == "undefined" || produto == undefined){
                alert("Selecione o Produto");
                return false;
            }
            if(tipo_posto == "" || tipo_posto == "undefined" || tipo_posto == undefined){
                alert("Selecione Representante ou Revenda");
                return false;
            }
            if(text_tipo_posto == "Representante" && (tipo_cliente == "" || tipo_cliente == undefined)) {
                alert("Selecione um Tipo de Cliente");
                return false;
            }
        }

        if (linha == "") {
            if (login_fabrica == 117) {
                alert("Favor selecionar a Macro-Familia do Posto!");
            }else{
                alert("Favor selecionar a Linha do Posto!");
            }
        } else {
            if (login_fabrica == 156 && $("input:radio[name=encaminha_filial][checked]").val() == 't') {
                endereco        = $("#filial_endereco").val();
                numero          = $("#filial_numero").val();
                bairro          = $("#filial_bairro").val();
                cep             = $("#filial_cep").val();
                local_cidade    = $("#filial_cidade").val();
                local_estado    = $("#filial_estado").val();
            }else if (login_fabrica == 183) {// mapa_rede Itatia
                endereco        = $("#consumidor_endereco").val();
                numero          = $("#consumidor_numero").val();
                bairro          = $("#consumidor_bairro").val();
                cep             = $("#consumidor_cep").val();
                local_cidade    = $('#consumidor_cidade').val();
                local_estado    = $('#consumidor_estado').val();

                if (local_cidade == '' || local_estado == '') {
                    alert('Preencha a cidade e Estado do cliente antes de buscar um posto autorizado');
                    return;
                }
            }else {
                if (($("#mapa_cidade").val() !== '' && $("#mapa_cidade").val() !== undefined)
                    && ($("#mapa_estado").val() !== '' && $("#mapa_estado").val() !== undefined)
                    && ($("#mapa_cidade").val() !== $('#consumidor_cidade').val()
                    || $("#mapa_estado").val() !== $('#consumidor_estado').val())) {
                    endereco        = '';
                    numero          = '';
                    bairro          = '';
                    cep             = '';
                    local_cidade    = $("#mapa_cidade").val();
                    local_estado    = $("#mapa_estado").val();
                }else{
                    endereco        = $("#consumidor_endereco").val();
                    numero          = $("#consumidor_numero").val();
                    bairro          = $("#consumidor_bairro").val();
                    cep             = $("#consumidor_cep").val();
                    local_cidade    = $('#consumidor_cidade').val();
                    local_estado    = $('#consumidor_estado').val();
                }

                if (local_cidade == '' || local_estado == '') {
                    alert('Preencha a cidade e Estado do cliente antes de buscar um posto autorizado');
                    return;
                }
            }

            endereco_completo.push(endereco);
            endereco_completo.push(numero);
            endereco_completo.push(bairro);
            endereco_completo.push(local_cidade);
            endereco_completo.push(local_estado);
            endereco_completo.push("Brasil");
            mapa_completo = endereco_completo.join();

            endereco_rota.push(endereco);
            endereco_rota.push(numero);
            endereco_rota.push(local_cidade);
            endereco_rota.push(local_estado);
            endereco_rota.push("Brasil");
            mapa_rota = endereco_rota.join();

            var get = [
                "callcenter=true",
                "linha="+linha,
                "nome="+nome_cliente,
                "cep="+cep,
                "pais=BR",
                "consumidor_estado="+local_estado,
                "estado="+local_estado,
                "consumidor_cidade="+local_cidade,
                "cidade="+local_cidade,
                "bairro="+bairro,
                "numero="+numero,
                "endereco="+endereco,
                "endereco_rota="+endereco_rota,
                "consumidor="+endereco_completo,
                "hd_chamado="+hd_chamado,
                "tipo_cliente="+tipo_cliente,
                "tipo_posto="+tipo_posto,
                "produto="+produto
            ];

			Shadowbox.open({
                content: "mapa_rede_new.php?"+get.join("&"),
                player: "iframe",
                width: '1400px',
                height: '900px'
            });
            $("#sb-nav").css({ display: "none" });
        }
    });
});
<?php
}
?>


function fnc_pesquisa_os (campo, tipo) {
    var url = "";
    if (tipo == "os") {
        url = "pesquisa_os_callcenter.php?consumidor_cpf=" + campo.value + "&tipo=os";
    }
    if (tipo == "cpf") {
        url = "pesquisa_consumidor_callcenter.php?consumidor_cpf=" + campo.value + "&tipo=cpf";
    }

    if (tipo == "nota_fiscal") {
        url = "pesquisa_os_callcenter.php?nota_fiscal=" + campo.value + "&tipo=nota_fiscal";
    }
    if (campo.value != "") {
        janela = window.open(url,"janela","toolbar=no,location=yes,status=yes,scrollbars=yes,directories=no,width=500,height=400,top=18,left=0,resizable=yes");

        janela.produto_referencia      = document.frm_callcenter.produto_referencia;
        janela.produto_nome            = document.frm_callcenter.produto_nome;
        janela.produto_serie           = document.frm_callcenter.serie;
        janela.produto_nf              = document.frm_callcenter.nota_fiscal;
        janela.produto_nf_data         = document.frm_callcenter.data_nf;
        janela.sua_os                  = document.frm_callcenter.os;
        janela.posto_nome              = document.frm_callcenter.posto_nome;
        janela.posto_codigo            = document.frm_callcenter.codigo_posto;
        <? if($login_fabrica==11 or $login_fabrica == 172) { //HD 14549 ?>
            janela.consumidor_nome         = document.frm_callcenter.consumidor_nome;
            janela.consumidor_cpf          = document.frm_callcenter.consumidor_cpf;
            janela.consumidor_cep          = document.frm_callcenter.consumidor_cep;
            janela.consumidor_fone         = document.frm_callcenter.consumidor_fone;
            janela.consumidor_endereco     = document.frm_callcenter.consumidor_endereco;
            janela.consumidor_numero       = document.frm_callcenter.consumidor_numero;
            janela.consumidor_complemento  = document.frm_callcenter.consumidor_complemento;
            janela.consumidor_bairro       = document.frm_callcenter.consumidor_bairro;
            janela.consumidor_cidade       = document.frm_callcenter.consumidor_cidade;
            janela.consumidor_estado       = document.frm_callcenter.consumidor_estado;
            janela.abas = $('#container-Principal');
        <? } ?>
        janela.focus();
    }
}

function atualizaQuadroMapas(){

    /*
     * - Atualiza os dados do posto conforme cidade e estado do Consumidor
     */

    var estado_selecionado = $('#consumidor_estado').val();

    var login_fabrica = <?=$login_fabrica?>;

    if (login_fabrica == 156 && $("input:radio[name=encaminha_filial][checked]").val() == 't') {
        estado_selecionado = $("filial_estado").val();
    }

    $('#mapa_estado').val( estado_selecionado ).trigger("change");

    if (login_fabrica == 169 || login_fabrica == 170){
        setTimeout(function(){
            var estadoConsumidor = $('#consumidor_estado').val();
            var dados_estados = $("#dados_estados").val();
            dados_estados = $.parseJSON(dados_estados);
            $.each(dados_estados, function(i, nome) {
                if (estadoConsumidor == i){
                    $("#nome_mapa_estado").val(nome);
                }
            });
        }, 1000);
    }

    /* Centro Oeste */
    if (estado_selecionado == 'GO' || estado_selecionado == 'MT' || estado_selecionado == 'MS' || estado_selecionado == 'DF'){
        estado_selecionado = 'BR-CO';
    }

    /* Nordeste */
    if (estado_selecionado == 'AL' || estado_selecionado == 'BA' || estado_selecionado == 'CE' || estado_selecionado == 'MA' || estado_selecionado == 'PB' || estado_selecionado == 'PE' || estado_selecionado == 'PI' || estado_selecionado == 'RN' || estado_selecionado == 'SE'){
        estado_selecionado = 'BR-NE';
    }

    /* Norte */
    if (estado_selecionado == 'AC' || estado_selecionado == 'AP' || estado_selecionado == 'AM' || estado_selecionado == 'PA' || estado_selecionado == 'RR' || estado_selecionado == 'RO' || estado_selecionado == 'TO'){
        estado_selecionado = 'BR-N';
    }

    $('#mapa_cidade').val( $('#consumidor_cidade').val() );
    if (login_fabrica == 156 && $("input:radio[name=encaminha_filial][checked]").val() == 't') {
        $("#mapa_cidade").val($("#filial_cidade").val());
    }
    //$('#mapa_estado').val( estado_selecionado ).trigger("change");

}


function txtBoxFormat(objForm, strField, sMask, evtKeyPress) {
    var i, nCount, sValue, fldLen, mskLen,bolMask, sCod, nTecla;

    if(document.all) { // Internet Explorer
        nTecla = evtKeyPress.keyCode;
    } else if(document.layers) { // Nestcape
        nTecla = evtKeyPress.which;
    } else {
        nTecla = evtKeyPress.which;
        if (nTecla == 8) {
            return true;
        }
    }

    sValue = objForm[strField].value;

    sValue = sValue.toString().replace( "-", "" );
    sValue = sValue.toString().replace( "-", "" );
    sValue = sValue.toString().replace( ".", "" );
    sValue = sValue.toString().replace( ".", "" );
    sValue = sValue.toString().replace( "/", "" );
    sValue = sValue.toString().replace( "/", "" );
    sValue = sValue.toString().replace( "/", "" );
    sValue = sValue.toString().replace( "(", "" );
    sValue = sValue.toString().replace( "(", "" );
    sValue = sValue.toString().replace( ")", "" );
    sValue = sValue.toString().replace( ")", "" );
    sValue = sValue.toString().replace( " ", "" );
    sValue = sValue.toString().replace( " ", "" );
    fldLen = sValue.length;
    mskLen = sMask.length;

    i = 0;
    nCount = 0;
    sCod = "";
    mskLen = fldLen;

    while (i <= mskLen) {
    bolMask = ((sMask.charAt(i) == "-") || (sMask.charAt(i) == ":") || (sMask.charAt(i) == ".") || (sMask.charAt(i) == "/"))
    bolMask = bolMask || ((sMask.charAt(i) == "(") || (sMask.charAt(i) == ")") || (sMask.charAt(i) == " ") || (sMask.charAt(i) == "."))


    if (bolMask) {
        sCod += sMask.charAt(i);
        mskLen++;

    } else {
        sCod += sValue.charAt(nCount);
        nCount++;
    }
    i++;
    }

    objForm[strField].value = sCod;
    if (nTecla != 8) { // backspace
        if (sMask.charAt(i-1) == "9") { // apenas números...
        return ((nTecla > 47) && (nTecla < 58));
        } // números de 0 a 9
    else { // qualquer caracter...
        return true;
    }
    } else {
        return true;
    }

}


<?PHP if ($login_fabrica == 3) { ?>
    window.onload = function foco(){
        var campo = document.getElementById("consumidor_nome");
        campo.focus();
    }
<? } ?>

<?PHP if (in_array($login_fabrica,array(2,7,10,15,35,42,91,101,116))) { ?>
function fnc_tipo_atendimento(tipo) {
        $('#cpf').val('');
        $('#label_nome').show();
    if (tipo.value == 'C') {
        $('#cpf').attr('maxLength', 14);
        $('#cpf').attr('size', 23);
        $('#label_cpf').html('CPF:');
        $('#label_nome').unbind(function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_nome, 'nome', 'assistencia'); } );
        $('#label_cnpj').unbind( function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_cpf, 'cpf', 'assistencia'); } );
        $('#label_nome').unbind(function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_nome, 'nome', 'revenda'); } );
        $('#label_cnpj').unbind( function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_cpf, 'cpf', 'revenda'); } );
        $('#label_nome').click( function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_nome, 'nome', 'consumidor'); } );
        $('#label_cnpj').click( function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_cpf, 'cpf', 'consumidor'); } );
        $('#cpf').keypress (function(e){
            return txtBoxFormat(document.frm_callcenter, this.name, '999.999.999-99', e);
        });
    } else {
        if (tipo.value == 'R' || tipo.value=='E') {
            $('#cpf').attr('maxLength', 18);
            $('#cpf').attr('size', 23);
            $('#label_cpf').html('CNPJ:');
            $('#label_nome').unbind(function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_nome, 'nome', 'consumidor'); } );
            $('#label_cnpj').unbind( function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_cpf, 'cpf', 'consumidor'); } );
            $('#label_nome').unbind(function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_nome, 'nome', 'assistencia'); } );
            $('#label_cnpj').unbind( function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_cpf, 'cpf', 'assistencia'); } );
            $('#label_nome').click( function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_nome, 'nome', 'revenda'); } );
            $('#label_cnpj').click( function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_cpf, 'cpf', 'revenda'); } );
            $('#cpf').keypress(function(e){
                return txtBoxFormat(document.frm_callcenter, this.name, '99.999.999/9999-99', e);
            });
        } else {
            if (tipo.value == "F") {
                $('#label_nome').hide();
            }
            $('#cpf').attr('maxLength', 18);
            $('#cpf').attr('size', 23);
            $('#label_cpf').html('CNPJ:');
            $('#label_nome').unbind(function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_nome, 'nome', 'consumidor'); } );
            $('#label_cnpj').unbind( function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_cpf, 'cpf', 'consumidor'); } );
            $('#label_nome').unbind(function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_nome, 'nome', 'revenda'); } );
            $('#label_cnpj').unbind( function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_cpf, 'cpf', 'revenda'); } );
            $('#label_nome').click( function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_nome, 'nome', 'assistencia'); } );
            $('#label_cnpj').click(function() { javascript: fnc_pesquisa_consumidor_callcenter (document.frm_callcenter.consumidor_cpf, 'cpf', 'assistencia'); } );

            $('#cpf').keypress(function(e){
                return txtBoxFormat(document.frm_callcenter, this.name, '99.999.999/9999-99', e);
            });
        }
    }
}

<? }elseif(in_array($login_fabrica,array(7,11,24,30,35,52,59,74,81,85,101,103,114)) || isset($novaTelaOs) || ($login_fabrica >= 119)){ // HD 75777 ?>
function fnc_tipo_atendimento(tipo, naoMuda = null) {
    if (naoMuda == 1) {
        return false;
    }

    $('#cpf').val(''); //voltando opção de limpar a mascara (solicitada pelo Flávio Suporte)

    if (tipo.value == 'C') {
        $('#cpf').attr('maxLength', 14);
        $('#cpf').attr('size', 23);
        $('#label_cpf').html('CPF:');
        $("input[name=consumidor_cpf]").mask("999.999.999-99");
        $('.label_ie').html('<strong>RG:</strong>');

        $('#cpf').keypress (function(e){
            return txtBoxFormat(document.frm_callcenter, this.name, '999.999.999-99', e);
        });

        <?php
        if ($login_fabrica == 85) {
        ?>
            $('#label_nome').html('Nome:');
            $("#nome_fantasia").hide();
            $("input[name=nome_fantasia]").val("");
        <?php
        }else if ($login_fabrica == 178){
        ?>
            $(".td_nascimento").show();
            $('.label_ie').hide();
            $(".campo_ie").hide();
            $("#consumidor_revenda option[value != 'C']").hide();
            $("#consumidor_revenda option[value = 'C']").show();
            $("#consumidor_revenda").val('C');
        <?php
        }
        ?>
    } else {
        if (tipo.value == 'R') {
            $('#cpf').attr('maxLength', 18);
            $('#cpf').attr('size', 23);
            $('#label_cpf').html('CNPJ:');
            $("input[name=consumidor_cpf]").mask("99.999.999/9999-99");

            <?php
            if ($login_fabrica == 85) {
            ?>
                $('#label_nome').html('Razão Social:');
                $("#nome_fantasia").show();
            <?php
            }else if ($login_fabrica == 178){
            ?>
                $(".td_nascimento").hide();
                $('.label_ie').show();
                $(".campo_ie").show();
                $("#consumidor_revenda option[value = 'C']").hide();
                $("#consumidor_revenda").val("");
                $("#consumidor_revenda option[value != 'C']").show();
            <?php
            }
            ?>
            <?php if (in_array($login_fabrica, array(11, 81, 103, 114, 119, 122, 123, 125, 147, 160, 172, 174, 178, 183, 187, 188, 189))) {?>
                $('.label_ie').html('<strong>IE:</strong>');
            <?php } else {?>
                 $('.label_ie').html('<strong>RG:</strong>');
           <?php }?>
        }
    }
}
<?}?>

var http5 = new Array();
function listaFaq(produto){
    var campo = document.getElementById('div_faq_duvida_duvida');
    if(produto.length==0){
        alert('Por favor selecione o produto');
    }else{
        var curDateTime = new Date();
        http5[curDateTime] = createRequestObject();

        url = "callcenter_interativo_ajax.php?ajax=true&listar=sim&produto=" + produto;
        http5[curDateTime].open('get',url);

        http5[curDateTime].onreadystatechange = function(){
            if(http5[curDateTime].readyState == 1) {
                campo.innerHTML = "<img src='imagens_admin/carregando_callcenter.gif' border='0'><font size='1' face='arial'>Aguarde..</font>";
            }
            if (http5[curDateTime].readyState == 4){
                if (http5[curDateTime].status == 200 || http5[curDateTime].status == 304){
                    var results = http5[curDateTime].responseText;
                    campo.innerHTML   = results;
                }else {
                    campo.innerHTML = "Erro";

                }
            }
        }
        http5[curDateTime].send(null);
    }
}

function indicacao(check){
    if (check.checked){
        $('.input_req').val('Indicação de Posto');
        $('#telefone').val('(000) 0000-0000');
        $('#cpf').val('000.000.000-00');
        $('#consumidor_cep').val('00000-000');
        $('#consumidor_numero').val('00');
        $('#hora_ligacao').val('00:00');
        $('#consumidor_estado').val('');
        $('#origem').val('');
        $('#consumidor_revenda').val('');
        $('#receber_informacoes').attr('checked', false);
        $('#status_interacao').val('Resolvido');


        $('.input_req').attr('readonly', true);
        $('.input_req').attr('disabled', true);

        $('#consumidor_estado').attr('disabled', true);
        $('#origem').attr('disabled', true);
        $('#consumidor_revenda').attr('disabled', true);
        $('#receber_informacoes').attr('disabled', true);
        $('#status_interacao').attr('disabled', true);


    } else {

        $('.input_req').val('');
        $('#consumidor_estado').val('');
        $('#origem').val('');
        $('#consumidor_revenda').val('');
        $('#receber_informacoes').attr('checked', false);

        input_req = $(".input_req").get();
        for(i = 0; i < input_req.length; i++){
            $(input_req[i]).removeAttr('readonly');
            $(input_req[i]).removeAttr('disabled');
        }

        $('#consumidor_estado').removeAttr('disabled');
        $('#origem').removeAttr('disabled');
        $('#consumidor_revenda').removeAttr('disabled');
        $('#receber_informacoes').removeAttr('disabled');
        $('#status_interacao').removeAttr('disabled');

    }
}


// hd-2109903


function indicacao_suggar(check, evento){
    if (check.checked){

        $('#receber_informacoes').attr('disabled', true);
        //$('#consumidor_rg').val('Indicação de Posto').attr({'disabled':true , 'readonly': true});
        //$('#cep').val('00000-000').attr({'disabled':true , 'readonly': true});
                    // $('#telefone').val('00000-000').attr({'disabled':true , 'readonly': true});
        //$('#consumidor_complemento').val('Indicação de Posto').attr({'disabled':true , 'readonly': true});
        //$('#consumidor_numero').val('Indicação de Posto').attr({'disabled':true , 'readonly': true});
        //$('#consumidor_email').val('Indicação de Posto').attr({'disabled':true , 'readonly': true});
        //$('#consumidor_endereco').val('Indicação de Posto').attr({'disabled':true , 'readonly': true});
        //$('#contato_nome').val('Indicação de Posto').attr({'disabled':true , 'readonly': true});
        //$('#consumidor_bairro').val('Indicação de Posto').attr({'disabled':true , 'readonly': true});
        $('#hora_ligacao').val('00:00');
        //$('#status_interacao').val('Resolvido').attr('disabled', true);
        $('#data_nf').val('').attr({'disabled':true , 'readonly': true});
        $('#nota_fiscal').val('').attr({'disabled':true , 'readonly': true});
        $('#serie').val('').attr({'disabled':true , 'readonly': true});

    //HD 235203: Coloquei o evento, pois quando carrega a página e não está marcado indicação de posto, não pode entrar aqui, senão apaga tudo o que o usuário digitou nos dados do consumidor
    } else if (evento == 'onchange') {

        $('#consumidor_revenda').attr('disabled', false);
        $('#receber_informacoes').attr('disabled', false);
        $('#status_interacao').attr('disabled', false);
        $('#consumidor_rg').val('').attr({'readonly': false , 'disabled':false});
        $('#consumidor_cep').val('').attr({'readonly': false , 'disabled':false});
        // $('#telefone').val('').attr({'readonly': false , 'disabled':false});
        $('#consumidor_complemento').val('').attr({'readonly': false , 'disabled':false});
        $('#consumidor_numero').val('').attr({'readonly': false , 'disabled':false});
        $('#consumidor_email').val('').attr({'readonly': false , 'disabled':false});
        $('#consumidor_endereco').val('').attr({'readonly': false , 'disabled':false});
        $('#contato_nome').val('').attr({'readonly': false , 'disabled':false});
        $('#consumidor_bairro').val('').attr({'readonly': false , 'disabled':false});
        $('#data_nf').val('').attr({'disabled':false , 'readonly': false});
        $('#nota_fiscal').val('').attr({'disabled':false , 'readonly': false});
        $('#serie').val('').attr({'disabled':false , 'readonly': false});

    }
}

<?php
if($login_fabrica == 74){
?>
function transferir_chamado(){

    var transferir = $("select[name='transferir']").val();

    if(transferir == ""){

        var atendente               = <?php echo $login_admin; ?>;
        var atendente_transferencia = $("#atendente_transferencia").val();

        if(parseInt(atendente) == parseInt(atendente_transferencia)){
            $("#atendente_transferencia").val("");
            $("#frm_callcenter").submit();
        }else{

            Shadowbox.open({
                content:"<div style='background:#FFFFFF;height:100%;text-align:center;'><br><p style='font-size:14px;font-weight:bold'>Gostaria de transferir esse chamado para sua fila?</p><br /><p style='font-weight:bold;'><input type='radio' name='transferir_para_fila' value='t' checked> SIM &nbsp &nbsp <input type='radio' name='transferir_para_fila' value='f'> NÃO</p><br><p><input type='button' value='Prosseguir' style='padding: 5px;' onclick=\"javascript:reset_transferencia();\"></p></div>",
                player: "html",
                title:  "Indicar Posto",
                width:  400,
                height: 170,
                options: {onFinish: function(){
                    $("#sb-nav-close").hide();
                },
                overlayColor:'#fcfcfc' }
            });
        }

    }else{
        Shadowbox.close();
        $("#frm_callcenter").submit();
    }

}

function reset_transferencia(){

    var transferir_para_fila = $("input[name='transferir_para_fila']:checked").val();

    if(transferir_para_fila == "f"){
        $("#atendente_transferencia").val("");
    }

    Shadowbox.close();
    $("#frm_callcenter").submit();

}

<?php
}
?>
function liberar_campos(){
    input_req = $(".input_req").get();
    for(i = 0; i < input_req.length; i++){
        $(input_req[i]).removeAttr('readonly');
        $(input_req[i]).removeAttr('disabled');
    }
    select_req = $("select:disabled").get();
    for(i = 0; i < select_req.length; i++){
        $(select_req[i]).removeAttr('disabled');
    }
}

function bloquear_campos(){
    <?php if($login_fabrica != 74){ ?>
        $("input").attr({'disabled':true});
        $("textarea").attr({'disabled':true});
        $("select").attr({'disabled':true});
    <?php }else{ ?>
        $('input[name="bt"]').attr({'disabled':true});
    <?php } ?>
}


function geraProtocolo() {
    var div = $('#protocolo');
    div.html("<img src='imagens/ajax-loader.gif' width='20' height='20'>");
    requisicaoHTTP('GET','gera_protocolo.php', true , 'mostraProtocolo');

    <?php
        if(in_array($login_fabrica,[120,201])){ //hd_chamado=2692262
    ?>
            Shadowbox.close();
    <?php
        }
    ?>

}

function mostraProtocolo(campos) {
    var campos_array = campos.split('|');
    if (campos_array[0]=='sim') {

        var div = $('#protocolo');
        var protocolo = $('#protocolo_id');
        div.html("n <font color='#CC0033'><b>"+campos_array[1]+"</font></b>");
        protocolo.val(campos_array[1]);

        <?php if(in_array($login_fabrica,[120,201])){ ?>
            var id_protocolo = $('#protocolo_id').val();
            alert("O número de protocolo gerado é "+id_protocolo);
        <?php } ?>

        <?php if($login_fabrica == 129){ ?>

            var url_ramal = campos_array[2];

            if(typeof url_ramal != "undefined" && url_ramal != ""){

                $(".url_ramal").html("<img src='../imagens/phone-icon.png' height='30' /> <br /> <strong>"+url_ramal+"</strong>");

            }

        <?php } ?>

    } else {
        var div = $('#protocolo');
        div.html('Erro ao gerar Protocolo');
    }
}


function altera2Aba(nu) {//HD 262718
    if ($('#container-Principal > ul > li').length) {

        var obj   = $('#container-Principal > ul > li > a')[(nu-1)];
        var tabId = obj.href.split('#')[1];

        $('#container-Principal > ul > li').each(function(i) {

            $('#container-Principal').disableTab(parseInt(i) + 1);

        });

        $('#container-Principal').enableTab(parseInt(nu));
        $('#tab_atual').val(tabId);

        $(obj).click();

    }

}

function comboMotivo(tipo,motivo){

    if(tipo == 'R' || tipo == 'P' || tipo == 'T') {
        $.ajax({
        type: "GET",
        url: "<?=$PHP_SELF?>",
        data: {ajax : 1, combo_motivo : 1, tipo : tipo, motivo : motivo},

        complete: function(http) {
            results = http.responseText;
            $('#hd_motivo_ligacao').html(results);
            $('.hd_motivo_ligacao').show();
        }

    });

    }else{
        $('#hd_motivo_ligacao').html('');
        $('.hd_motivo_ligacao').hide();
    }
}

function geraXml(atendimento){
    var coleta = $("input[name=coleta]:checked").val();
    var valor_declarado = $("#valor_declarado").val();

    if(valor_declarado <= 0 ){
        alert("Informe o valor declarado");
        return false;
    }

    $.ajax({
        url: "ajax_gera_xml_nks.php?hd_chamado="+atendimento+"&coleta="+coleta+"&valor_declarado="+valor_declarado,
        cache: false,
        success: function(data) {

            retorno = data.split('|');

            if (retorno[0]=="OK") {
                $("#gerar_xml").html("<input type='button' value='Download XML' onclick=\"window.open('xls/"+atendimento+".zip');\">")
                window.location.href = "xls/"+atendimento+".zip";

            } else {
                alert(retorno[0]);
            }

        }
    });

}

<?php if ($login_fabrica == 24) { ?>
    $(function () {
        $("#ligacao_agendada").datepick({startDate:"01/01/2000"}).mask("99/99/9999");
    });
<?php }
if ($login_fabrica == 156) { ?>
    $(function () {
        $("#prazo_limite").datepick({startDate:"01/01/2000"}).mask("99/99/9999");
    });

<?php
}
?>
$(document).ready(function() {
    <?php if (in_array($login_fabrica, [178])) { ?>
        var cpf_cnpj = $("#cpf").val();
        var tipo     = $("input[name=consumidor_cpf_cnpj]:checked").val();

        if (tipo == 'C') {
            $("#consumidor_cpf").click();
        } else if (tipo == 'R') {
            $("#consumidor_cnpj").click();
        }

        $("#cpf").val(cpf_cnpj);
    <?php } ?>
});
</script>


<?php // VALIDAÃÃO NUMERO TELEFONE / CELULAR VALIDO
    $prefixo = 55;
?>
    <script language="javascript" type="text/javascript" src="js/phoneparser.js"></script>

    <script>

        $(function(){

            <?php if(in_array($login_fabrica, array(178, 186,191))){ ?>
                $("#reclamacao_empresa_click").parent("li").addClass("tabs-disabled");
                $("#reclamacao_at_click").parent("li").addClass("tabs-disabled");
                $("#duvida_produto_click").parent("li").addClass("tabs-disabled");
                $("#sugestao_click").parent("li").addClass("tabs-disabled");
                $("#procon_click").parent("li").addClass("tabs-disabled");
                $("#onde_comprar_click").parent("li").addClass("tabs-disabled");
            <?php } ?>

            <?php if(in_array($login_fabrica, array(162))){ ?>

                $("#acordo_realizado_sim").click(function(){
                    $(".tipo_acordo_realizado").css("display", "block");
                });
                $("#acordo_realizado_nao").click(function(){
                    $(".tipo_acordo_realizado").css("display", "none");
                });
            <? } ?>

            <?php if(!in_array($login_fabrica, array(164,189))){ ?>

            var cel = "", prefix=55;

            $("#telefone3").blur(function() {

                if($(this).val() == "" || $(this).val() == cel){
                    return;
                }

                if($(this).val().length <= 13){
                    $(this).focus();
                    return;
                }

                cel = prefix + $(this).val();
                var res = parsePhone($.trim(cel));

                if(JSON.stringify(res) == "null"){

                    $(this).focus();
                    alert("número de Celular Inválido. Por favor verifique!");
                    return;

                }
            });

            $("#telefone2").blur(function() {

                if($(this).val() == "" || $(this).val() == cel){
                    return;
                }

                if($(this).val().length <= 13){
                    $(this).focus();
                    return;
                }

                cel = prefix + $(this).val();
                var res = parsePhone($.trim(cel));

                if(JSON.stringify(res) == "null"){

                    $(this).focus();
                    alert("número de Telefone Inválido. Por favor verifique!");
                    return;

                }
            });

                $("#telefone").blur(function() {

                    if($(this).val() == "" || $(this).val() == cel){
                        return;
                    }

                    if($(this).val().length <= 13){
                        $(this).focus();
                        return;
                    }

                    cel = prefix + $(this).val();
                    var res = parsePhone($.trim(cel));

                    if(JSON.stringify(res) == "null"){

                        $(this).focus();
                        alert("número de Telefone Inválido. Por favor verifique!");
                        return;

                    }
                });

            <? }

            if($login_fabrica == 171){ ?>
                $("#btn_agendamentos").click(function() {
                    if ($("#tbl_agendamentos").is(":visible")) {
                        $("#tbl_agendamentos").hide();
                    } else {
                        $("#tbl_agendamentos").show();
                    }
                });
            <?php
            }

            if (in_array($login_fabrica, array(169,170))) {?>

                $("#btn_agendamentos").click(function() {
                    if ($("#tbl_agendamentos").is(":visible")) {
                        $("#tbl_agendamentos").hide();
                    } else {
                        $("#tbl_agendamentos").show();
                    }
                });

                $("#hd_classificacao").change(function(){

                    if($("#tipo_protocolo").val() == ""){
                        alert("Informe o campo Protocolo Via antes de selecionar a classificação");
                        return true;
                    }

                    if(($("#tipo_protocolo > option:selected").text()) == "Ecommerce"){

                    }

		    $('.tab_content, .tabs-container').addClass('tabs-hide');
		    $("#container-Principal > ul > li").removeClass('tabs-selected');

		    var nome_classificacao = $('#hd_classificacao option:selected').text();

		    var number_tabs = [1,2,3,4,5,6,7,8,9];
		    number_tabs.map(function(v){
			$('#container-Principal').disableTab(parseInt(v));
		    });

                    var tabs_ativas = [];
                    $.ajax({
                        url: window.location,
                        type: "POST",
                        data: {ajax: 'sim', classificacao: $("#hd_classificacao").val()},
                        timeout: 7000
                    }).fail(function(){
                        alert('fail');
                    }).done(function(data){
                        data = JSON.parse(data);
                        if (data.ok !== undefined) {
                            $.each(data.ok, function (key, value) {
                                $('a[rel="'+value.tabs+'"]').parent().removeClass();
                                tabs_ativas.push(value.tabs);
                            });
                            var tabs_c = [];
                            $("#container-Principal > ul > li").each(function(){
                                if(!$(this).hasClass('tabs-disabled')){
                                    tabs_c.push($(this).find('a').attr('rel'));
                                }
                            });
                            var tab_b = tabs_c[0];

                            for (var i = 0; i < tabs_ativas.length; i++) {
                                var tab_a = tabs_ativas[i];
                                if(tab_b == tab_a){
                                    $('a[rel="'+tab_a+'"]').parent().addClass('tabs-selected');
                                    $("#"+tab_a).removeClass('tabs-hide');
                                    $("#tab_atual").val(tab_a);
                                    valida_aba_atendimento(tab_a);
                                }
                            }
                            $("#tabs_ativas").val(tabs_ativas);

                            if (nome_classificacao == "ONDE COMPRAR"){
                                $("#mapa_linha").prop("disabled", true).css("cssText", "background-color: #e6e3e3 !important;");
                                $("#mapa_estado").prop("disabled", true).css("cssText", "background-color: #e6e3e3 !important;");
                                $("#mapa_cidade").prop("disabled", true).css("cssText", "background-color: #e6e3e3 !important;");
                                $("#btn_mapa").prop("disabled", true).css("cssText", "background-color: #e6e3e3 !important;");
                                $("#codigo_posto_tab").prop("disabled", true).css("cssText", "background-color: #e6e3e3 !important;");
                                $("#posto_fone_tab").prop("disabled", true).css("cssText", "background-color: #e6e3e3 !important;");
                                $("#posto_nome_tab").prop("disabled", true).css("cssText", "background-color: #e6e3e3 !important;");
                                $("#posto_email_tab").prop("disabled", true).css("cssText", "background-color: #e6e3e3 !important;");

                                $("#posto_tab").val('');
                                $("#mapa_linha").val('');
                                $("#mapa_estado").val('');
                                $("#mapa_cidade").val('');
                                $("#codigo_posto_tab").val('');
                                $("#posto_fone_tab").val('');
                                $("#posto_nome_tab").val('');
                                $("#posto_email_tab").val('');
                            }else{
                                $("#mapa_linha").prop("disabled", false).css("cssText", "");
                                $("#mapa_estado").prop("disabled", false).css("cssText", "");
                                $("#mapa_cidade").prop("disabled", false).css("cssText", "");
                                $("#btn_mapa").prop("disabled", false).css("cssText", "");
                                $("#codigo_posto_tab").prop("disabled", false).css("cssText", "");
                                $("#posto_fone_tab").prop("disabled", false).css("cssText", "");
                                $("#posto_nome_tab").prop("disabled", false).css("cssText", "");
                                $("#posto_email_tab").prop("disabled", false).css("cssText", "");
                            }
                            // $("#"+tabs_ativas[0]).removeClass('tabs-hide');
                            // $('a[rel="'+tabs_ativas[0]+'"]').parent().addClass('tabs-selected');
                            // valida_aba_atendimento(tabs_ativas[0]);
                        }

                        if (data.usuarioAdmin !== undefined ) {
                            var option = "<option value=''></option>";
                            $.each(data.usuarioAdmin, function (key, value) {
                                option += "<option value='"+value.id+"'>"+value.admin+"</option>";
                            });
                            $('#campo_transferir').find('select').html(option);
                        }
                    });
		}); 
		
		$("select[id^=hd_motivo_ligacao]").change(function(){

		    let providencia = $(this).val();

		    $.ajax({
                        url: window.location,
                        type: "POST",
                        data: {ajax: 'sim', classificacao: $("#hd_classificacao").val(), providencia: providencia},
                        timeout: 7000
                    }).fail(function(){
                        alert('fail');
                    }).done(function(data){
                        data = JSON.parse(data);
                        if (data.usuarioAdmin !== undefined ) {
                            var option = "<option value=''></option>";
                            $.each(data.usuarioAdmin, function (key, value) {
                                option += "<option value='"+value.id+"'>"+value.admin+"</option>";
                            });
                            $('#campo_transferir').find('select').html(option);
                        }
                    });
                });

            <? } else { ?>
                $("#hd_classificacao").change(function(){
                    var fabrica_id = <?=$login_fabrica?>;

                    if (fabrica_id == 52) {
                        ValidarOrientacao();
                    }

                    $.ajax({
                        url: window.location,
                        type: "POST",
                        data: {ajax: 'sim', classificacao: $("#hd_classificacao").val()},
                        timeout: 7000
                    }).fail(function(){
                        alert('fail');
                    }).done(function(data){
                        data = JSON.parse(data);
                        if (data.ok !== undefined) {
                            if(fabrica_id >= 169){
                                var option = "<option value=''>Escolha a Providência</option>";
                                $.each(data.ok, function (key, value) {
                                    option += "<option value='"+value.motivo_ligacao+"'>"+value.descricao+"</option>";
                                });
                                $('#hd_motivo_ligacao').html(option);

                            }else{
                                $('#hd_motivo_ligacao').val(data.ok);
                            }
                        }else{
                            <?php if (in_array($login_fabrica, [178,198])) { ?>
                                $('#hd_motivo_ligacao').html("<option value=''>Escolha a Providência</option>");
                            <?php } ?>
                            <?php if ($login_fabrica == 30) { ?>
                                $("#hd_motivo_ligacao option:first").attr('selected','selected');
                            <?php } ?>
                        }
                    });
                });
            <? }

            if($login_fabrica == 30){ ?>

                if( $('#hd_motivo_ligacao').val() == 104 ){                    
                    $("#data_prov").prop("readonly", false);
                    $("#data_prov").datepick({ minDate: 0});
                }else{                    
                    $("#data_prov").prop("readonly", true);
                    $("#data_prov").datepick('destroy');
                }


                $('#hd_motivo_ligacao').on('change', function(){

                    if($(this).val() == 104){
                        $("#data_prov").prop("readonly", false);
                        $("#data_prov").datepick({ minDate: 0}).focus();
                    }else{
                        $("#data_prov").prop("readonly", true);
                        $("#data_prov").datepick('destroy');
                    }

                    var status = $("#status_interacao").val();
                    var hd_chamado = '<?=$callcenter?>';

                    $.ajax({
                        url : "callcenter_interativo_new.php",
                        type: "POST",
                        data: {ajax_verifica_situacao_providencia : true, hd_chamado : hd_chamado, providencia : $(this).val(), status : status},
                        dataType:"JSON"
                    }).done(function(response){
                        if(response.erro == true){

                            if(response.anterior != ""){
                                $("#hd_motivo_ligacao").val(response.anterior);
                            }

                            alert(response.msg);
                        }else{
                            if ($('#hd_motivo_ligacao').val() == 162) {
                                $('#os_comprovante_troca').show();
                            }else{
                                $('#os_comprovante_troca').hide();
                            }
                        }
                    });
                });

                $("#cliente_nome_admin").change(function(){

                        if ($(this).val() != "") {
                            $(".limite").show();
                        } else {
                            $(".limite").hide();
                            $("#data_limite").val("");
                        }
                    });

                $("#prorroga_providencia").click(function(){
                    let hd_chamado = $(this).attr("rel");

                    $.ajax({
                        url : "callcenter_interativo_new.php",
                        type: "POST",
                        data: {ajax_prorroga_providencia : true, hd_chamado : hd_chamado},
                        dataType:"JSON"
                    }).done(function(response){
                        if(response.erro == true){
                            alert(response.msg);
                        }else{
                            $("#data_prov").val(response.msg);
                        }
                    });

                });

                $("#antecipa_providencia").click(function(){
                    let hd_chamado = $(this).attr("rel");
                    var dataFim = $("#data_prov").val();
                    var now = new Date();
                    var dataHoje = now.getDate() + "/" + parseFloat(now.getMonth()) + 1 + "/" + now.getFullYear();

                    $("#data_prov").datepick({ minDate: 0, maxDate: dataFim}).focus();

                });


            <? } ?>

            <?php if ($login_fabrica == 52 && (strlen($callcenter) > 0 || strlen($_POST["hd_classificacao"] > 0))) { ?>
                ValidarOrientacao();
            <?php }

            if($login_fabrica == 178 AND empty($msg_erro)){ ?>
                $("input[name='consumidor_cpf_cnpj']:checked").click();
            <?php } ?>

        });

        function ValidarOrientacao() {
            if ($("#hd_classificacao option:selected").text() == "ORIENTAÇÃO") {
                $("#abre_ordem_servico").val(false);
                $("#abre_ordem_servico").prop('checked', false);
                $("#strong_abrir_os").css("display", "none");
                $("#imprimir_os").css("display", "none");
            } else {
                $("#abre_ordem_servico").val(true);
                $("#abre_ordem_servico").prop('checked', true);
                $("#strong_abrir_os").css("display", "block");
                $("#imprimir_os").css("display", "block");
            }
        }

		function abrir_pre_atendimento(){
		    url = "pre_atendimento_cadastro.php";
		    window.open(url);
		}

        <?php if(in_array($login_fabrica, array(169,170))){ ?>

                function tipoProtocloClassificacaoOrigem(){
                    
                    var obj = $("#tipo_protocolo");
                    var id_origem = '<?=$origem?>';
                    var id_classificacao = '<?=$hd_classificacao?>';

                    $.ajax({
                        url: "callcenter_interativo_new.php",
                        type: "POST",
                        data: {"ajax_tipo_protocolo_classificacao": true, tipo_protocolo: $(obj).val()},
                        complete: function(data){

                            var retorno = data.responseText;

                            if(retorno.length > 0){
                                $("#hd_classificacao").html(retorno);

                                if(id_classificacao != ""){
                                    $("#hd_classificacao").val(id_classificacao);
                                }

                                $.ajax({
                                    url: "callcenter_interativo_new.php",
                                    type: "POST",
                                    data: {"ajax_tipo_protocolo_origem": true, tipo_protocolo: $(obj).val()},
                                    complete: function(data){

                                        var retorno = data.responseText;

                                        if(retorno.length > 0){
                                            $("#origem").html(retorno);

                                            if(id_origem != ""){
                                                $("#origem").val(id_origem);
                                            }

                                        }
                                    }
                                });
                            }
                        }
                    });

                    if( $("#tipo_protocolo > option:selected").text() == "Ecommerce"){
                        $(".pedido_ecommerce").show();
                    } else {
                        $(".pedido_ecommerce").hide();
                    }
                }

                    $(function(){tipoProtocloClassificacaoOrigem()});
            <? } ?>

    </script>
<style type="text/css">
    .demo {
        background-color: #ff6868 !important;
        background-image :none !important;
        color: #fffefe !important;
    }
    .btn_custo_atendimento{
        cursor:pointer;background: #17a2b8;color:#fff;border:solid 1px #007bff;padding:10px 30px;font-weight: bold;
    }
    .btn_custo_atendimento:hover{
        cursor:pointer;background: #007bff;color:#fff;border:solid 1px #17a2b8;padding:10px 30px;font-weight: bold;
    }
    .btn_add_item{
        cursor:pointer;background: #17a2b8;color:#fff;border:solid 1px #007bff;padding:10px 30px;font-weight: bold;
    }
    .btn_add_item:hover{
        cursor:pointer;background: #007bff;color:#fff;border:solid 1px #17a2b8;padding:10px 30px;font-weight: bold;
    }
    .tac{
        text-align: center;
    }
    .titulo_viapol{
        padding: 5px 20px !important;
    }
    .conteudo_viapol{
        padding: 10px;
        background: #fff;
    }
    .btn_editar{
        cursor:pointer;background: #007bff;color:#fff;border:solid 1px #007bff;padding:5px 30px;font-weight: bold;margin-bottom: 10px;
    }
    .btn_editar:hover{
        cursor:pointer;background: #17a2b8;color:#fff;border:solid 1px #007bff;padding:5px 30px;font-weight: bold;margin-bottom: 10px;
    }
</style>
<?php

if (strlen($msg_erro) > 0) { ?>

    <!-- Colocar aqui a função substr HD#311031 -->
    <? //recarrega informacoes
    $callcenter               = trim($_POST['callcenter']);
    $data_abertura_callcenter = trim($_POST['data_abertura_callcenter']);
    $natureza_chamado         = trim($_POST['natureza_chamado']);
    $consumidor_nome          = trim($_POST['consumidor_nome']);
    $cliente                  = trim($_POST['cliente']);
    $consumidor_cpf           = trim($_POST['consumidor_cpf']);
    $consumidor_rg            = trim($_POST['consumidor_rg']);
    $consumidor_rg            = preg_replace("/\W/","",$consumidor_rg);
    $consumidor_email         = trim($_POST['consumidor_email']);
    $consumidor_fone          = trim($_POST['consumidor_fone']);
    $consumidor_fone2         = trim($_POST['consumidor_fone2']);
    $consumidor_fone3         = trim($_POST['consumidor_fone3']);
    $consumidor_cep           = trim($_POST['consumidor_cep']);
    $consumidor_cep           = str_replace("-","",$consumidor_cep);
    $consumidor_cep           = str_replace("/","",$consumidor_cep);
    $consumidor_endereco      = trim($_POST['consumidor_endereco']);
    $consumidor_numero        = trim($_POST['consumidor_numero']);
    $consumidor_complemento   = trim($_POST['consumidor_complemento']);
    $ponto_referencia         = trim($_POST['ponto_referencia']);
    $consumidor_bairro        = trim($_POST['consumidor_bairro']);
    $consumidor_cidade        = trim(strtoupper($_POST['consumidor_cidade']));
    $consumidor_cidade        = str_replace("\\","",$consumidor_cidade);
    $consumidor_estado        = trim(strtoupper($_POST['consumidor_estado']));
    $assunto                  = trim($_POST['assunto']);
    $sua_os                   = trim($_POST['sua_os']);
    $data_abertura            = trim($_POST['data_abertura']);
    $produto                  = trim($_POST['produto']);
    $produto_referencia       = trim($_POST['produto_referencia']);
    $produto_nome             = trim($_POST['produto_nome']);
    $voltagem                 = trim($_POST['voltagem']);
    $serie                    = trim($_POST['serie']);
    $data_nf                  = trim($_POST['data_nf']);
    $marca                    = trim($_POST['marca']);
    $data_prov                = trim($_POST['data_prov']);
    $mapa_linha               = trim($_POST['mapa_linha']);
    $nota_fiscal              = trim($_POST['nota_fiscal']);
    $revenda                  = trim($_POST['revenda']);
    if ($login_fabrica == 178){
        $revenda_nome         = trim($_POST['nome_revenda']);
        $id_os_revenda        = $_POST["id_os_revenda"];
    }else{
        $revenda_nome             = trim($_POST['revenda_nome']);
    }
    if ($login_fabrica == 183){
        $id_zendesk = trim($_POST['id_zendesk']);
    }
    $revenda_endereco         = trim($_POST['revenda_endereco']);
    $revenda_nro              = trim($_POST['revenda_nro']);
    $revenda_cmpto            = trim($_POST['revenda_cmpto']);
    $revenda_bairro           = trim($_POST['revenda_bairro']);
    $revenda_city             = trim($_POST['revenda_city']);
    $revenda_uf               = trim($_POST['revenda_uf']);
    $revenda_fone             = trim($_POST['revenda_fone']);
    $posto                    = trim($_POST['posto']);
    if (empty($posto)) {
    $posto = $_POST["posto_banco"];
    }
    $posto_nome               = trim($_POST['posto_nome']);
    $defeito_reclamado        = trim($_POST['defeito_reclamado']);
    //$reclamado                 = trim($_POST['reclamado']);
    $status           = trim($_POST['status']);
    $transferir       = trim($_POST['transferir']);
    $chamado_interno  = trim($_POST['chamado_interno']);
    $status_interacao = trim($_POST['status_interacao']);
    $resposta         = trim($_POST['resposta']);
    $abre_os          = trim($_POST['abre_os']);
    $hd_extra_defeito = trim($_POST['hd_extra_defeito']);
    //HD 205933: Habilitar abertura de ORDEM DE SERVIÃO para a Esmaltec
    $abre_ordem_servico    = trim($_POST['abre_ordem_servico']);
    $abre_ordem_servico = ($abre_ordem_servico == "true") ? "t" : $abre_ordem_servico;
    $hd_motivo_ligacao     = trim($_POST['hd_motivo_ligacao']);
    $motivo_contato_callcenter = trim($_POST['motivo_contato_callcenter']);

    if (in_array($login_fabrica, [169,170])) {
        switch($_POST["tab_atual"]) {
            case "reclamacao_produto":
                $hd_motivo_ligacao = $_POST["hd_motivo_ligacao"];
                $hd_providencia_callcenter = $_POST["providencia_nivel3_reclamacao_produto"];
                break;

            case "reclamacao_empresa":
                $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_reclamacao_empresa"];
                $hd_providencia_callcenter = $_POST["providencia_nivel3_reclamacao_empresa"];
                break;

            case "reclamacao_at":
                $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_reclamacao_at"];
                $hd_providencia_callcenter = $_POST["providencia_nivel3_reclamacao_at"];
                break;

            case "duvida_produto":
                $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_duvida_produto"];
                $hd_providencia_callcenter = $_POST["providencia_nivel3_duvida_produto"];
                break;

            case "sugestao":
                $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_sugestao"];
                $hd_providencia_callcenter = $_POST["providencia_nivel3_sugestao"];
                break;

            case "onde_comprar":
                $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_onde_comprar"];
                $hd_providencia_callcenter = $_POST["providencia_nivel3_onde_comprar"];
                break;

            case "indicacao_at":
                $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_indicacao_at"];
                $hd_providencia_callcenter = $_POST["providencia_nivel3_indicacao_at"];
                break;

            case "informacao":
                $hd_motivo_ligacao = $_POST["hd_motivo_ligacao_informacao"];
                $hd_providencia_callcenter = $_POST["providencia_nivel3_informacao"];
                break;

            default:
                $hd_motivo_ligacao = null;
                break;
        }
    }

    $recebido              = trim($_POST['recebido']);
    $analise               = trim($_POST['analise']);
    $validade              = trim($_POST['validade']);
    $lote                  = trim($_POST['lote']);
    $origem_adi            = trim($_POST['origem_adi']);
    $aco_de                = trim($_POST['aco_de']);
    $procedente            = trim($_POST['procedente']);
    $referencia_adi        = trim($_POST['referencia_adi']);
    $descricao_adi         = trim($_POST['descricao_adi']);
    $qtde_adi              = trim($_POST['qtde_adi']);
    $reposicao             = trim($_POST['reposicao']);
    $disposicao            = trim($_POST['disposicao']);
    $descricao_analise     = trim($_POST['descricao_analise']);
    $hd_classificacao      = trim($_POST['hd_classificacao']);
    $tipo_protocolo        = trim($_POST['tipo_protocolo']);
    $consumidor_nascimento = $_POST['consumidor_nascimento'];
    $data_providencia      = $_POST['data_prov'];

    if (in_array($login_fabrica, array(174)))
    {
        $emitir_laudo      = (isset($_POST['hd_classificacao'])) ? trim($_POST['hd_classificacao']) : '';
    }

    if (in_array($login_fabrica, array(138)))
    {
        $cancela_mobra      = (isset($_POST['cancela_mobra'])) ? 'f' : 't';
    }

    if(empty($callcenter) and !empty($protocolo) and strlen(trim($msg_erro)) == 0 ) {
        $callcenter = $protocolo;
    }

    if(strlen($consumidor_fone) > 0){
        $consumidor_fone = str_replace("(", "", $consumidor_fone);
        $consumidor_fone = str_replace(")", "", $consumidor_fone);
        $consumidor_fone = str_replace("-", "", $consumidor_fone);
        $consumidor_fone = str_replace(" ", "", $consumidor_fone);
    }

    if($login_fabrica == 74){
        $posto_contato_numero       = $_POST["posto_contato_numero"];
        $posto_contato_endereco     = $_POST["posto_contato_endereco"];
        $posto_contato_cidade       = $_POST["posto_contato_cidade"];
        $posto_contato_estado       = $_POST["posto_contato_estado"];
    }

    if ($fab_nova_filial) {
        $encaminha_filial = $_POST['encaminha_filial'];

        $filial_id = $_POST['filial_id'];
        $filial = $_POST['filial'];

        if (is_numeric($filial_id) and $filial_id > 0) {
            $filial = pg_fetch_assoc(
                pg_query(
                    $con,
                    "SELECT tbl_filial.nome AS razao_social, fantasia, telefone AS fone,
                            tbl_filial.*, tbl_cidade.nome
                       FROM tbl_filial
                       JOIN tbl_cidade USING(cidade)
                      WHERE filial = $filial_id"
                ), 0
            );
        }
        $protocolo_cliente = $_POST['protocolo_cliente'];
        $data_providencia  = $_POST['data_providencia'];
    }
?>
<body <? if ($login_fabrica == 24) {?> onload="javascript: var check = document.getElementById('indicacao_posto'); indicacao_suggar(check, 'onload')"; <?}?>>

    <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F7503E;font-size:12px; padding: 4px;'>
        <tr>
            <td align='center'><? echo "<font color='#FFFFFF'>$msg_erro</font>"; ?></td>
        </tr>
    </table><?php

}

if(in_array($login_fabrica, [169,170]) AND !empty($tipo_protocolo)){
?>
    <script>
        tipoProtocloClassificacaoOrigem();
        $("#origem").val(<?=$origem?>);
        $("#hd_classificacao").val(<?=$hd_classificacao?>);
    </script>
<?php
}

    if ($integracaoTelefonia === true) {
        ?>
            <script>
                var fabrica_atendimento = "<?= $login_fabrica ?>";
                function verificaFabrica (){
                    setTimeout (function() {
                        $.ajax ({
                            url: "callcenter_interativo_new.php",
                            type: "POST",
                            data: {
                                fabrica_atendimento: fabrica_atendimento,
                                ajax_verifica_fabrica: true
                            },
                            async: true,
                            timeout: 10000
                        }).done(function(response) {
                            if (response == 'false') {
                                Shadowbox.init({
                                    skipSetup: true
                                });
                                Shadowbox.open({
                                    content: "<div style='position:absolute; margin-left:10px; margin-top:10px; margin-right:10px; margin-bottom:1px; background-color: #fff; height:100%; width:100%; text-align: center;'><div style='margin-left:10px; margin-top:15px; margin-right:15px; margin-bottom:1px;'><br><font style='font-size:20px; font-weight:bold; color:#434390;'>já existe um atendimento em aberto para outra fábrica</font></div><br><div style='margin-left:10px; margin-top:20px; margin-right:15px; margin-bottom:1px;'><button type='submit' style='text-align:center; font-size:10px; background-color:#434390; border:none; color:white; padding:15px 32px; text-align:center; text-decoration:none; display:inline-block;' id='btn-parar' onclick='continuarAtendimento();'><font style='cursor:pointer; font-size:12px;'>Para continuar este atendimento clique aqui</font></button></div></div></div>",
                                    player: "html",
                                    width: 400,
                                    height: 200,
                                    title: "Atendimento em andamento",
                                    options: {
                                        modal: true,
                                        enableKeys: false,
                                        displayNav: false
                                    }
                                });
                            } else {
                                verificaFabrica();
                            }

                        });
                    },2000);
                }

                verificaFabrica();

                function continuarAtendimento() {
                    $.ajax ({
                        url: "autologin_telefonia.php",
                        type: "POST",
                        data: {
                            fabrica_atendimento: fabrica_atendimento,
                            ajax_retorna_sessao: true,
                            url_retorno: window.location.href
                        },
                        async: true
                    }).done(function(response) {
                        if (response == 'true') {
                            Shadowbox.close();
                            verificaFabrica();
                        } else {
                          alert(response);
                        }
                    });
                }

            </script>
        <?
    }

$sql = "SELECT nome from tbl_fabrica where fabrica = $login_fabrica";
$res = pg_query($con, $sql);
$nome_da_fabrica = pg_fetch_result($res,0,0);?>

<?php if($os_externa_atendimento == true){ ?>
<div style="width: 100%; text-align: center; padding-top: 20px;">
    <button type="button" onclick="lista_os_atendimento();" style="cursor: pointer; font-size: 14px !important; padding: 5px 30px !important;" class="frm"> Inserir senha para dar continuidade! </button>
</div>
<?php } ?>

<link rel="stylesheet" type="text/css" href="plugins/font_awesome/css/font-awesome.css">
<style type="text/css">
    .chat-integracao {
        float:right;
        margin-right:10px;
        width:330px;
        background-color:#3B66AA;
        border-top-right-radius:5px;
        border-top-left-radius:5px;
        cursor:pointer;
        box-shadow:0 0 10px #666;
    }

    .chat-component {
        cursor:initial;
        height:400px;
        display:none;
    }

    .tchat {
        outline:none;
        border:none;
        height:inherit;
        width:100%;
    }
</style>

<?php
if ($atendimentoFacebook == true AND !empty($origem) AND strlen($callcenter) > 0) {
    $qOrigem = "SELECT descricao
                FROM tbl_hd_chamado_origem
                WHERE hd_chamado_origem = {$origem}
                AND fabrica = {$login_fabrica}";
    $rOrigem = pg_query($con, $qOrigem);
    $rOrigem = pg_fetch_result($rOrigem, 0, 'descricao');

    $qIntegracao = "SELECT thcie.id_integracao,
                        thce.array_campos_adicionais::json->>'facebook' facebook
                    FROM tbl_hd_chamado_item_externo thcie
                    JOIN tbl_hd_chamado thc ON thc.hd_chamado = thcie.hd_chamado AND thc.fabrica = {$login_fabrica}
                    JOIN tbl_hd_chamado_item thci ON thci.hd_chamado_item = thcie.hd_chamado_item
                    JOIN tbl_hd_chamado_extra thce ON thce.hd_chamado = thc.hd_chamado
                    WHERE thc.hd_chamado = {$callcenter}";
    $resIntegracao = pg_query($con, $qIntegracao);
    $rIntegracao = pg_num_rows($resIntegracao);

    $resultIntegracao = json_decode(pg_fetch_result($resIntegracao, 0, 'facebook'), true);
}

if ($atendimentoFacebook == true AND strlen($callcenter) > 0 AND preg_match("/facebook/", strtolower($rOrigem)) AND $rIntegracao > 0) {
$fbChatLink = "https://tchat.telecontrol.com.br/atendente/callcenter-facebook/atendimento/" . $callcenter . "/atendente/" . $login_admin ."/pagina/" . $resultIntegracao['facebookPage'];

?>

<div class="chat-integracao" style="z-index:9999;bottom:0;right:5px;position:fixed;">
    <div style="float:right;padding:10px;">
        <i class="far fa-window-maximize" style="font-size:16px;color:#FFF"></i>
    </div>
    <div style="padding:10px;">
        <h6 style="font-size:15px;font-weight:bold;font-family:'Arial','sans-serif';color:#FFF">
            <?= ucwords(strtolower($resultIntegracao['facebookPageName'])) ?>
            <i class="fa fa-spinner fa-spin"></i>
        </h6>
    </div>
    <div class="chat-component">
        <iframe class="tchat" style="" src="<?=$fbChatLink?>"></iframe>
    </div>
</div>
<script>
    window.addEventListener('message', function (e) {
        if (e.data == 'loaded') {
            $(".chat-integracao").on("click", function () {
                $(".chat-component").toggle();
            });
            let i = $(".chat-integracao").find(".fa-spinner")[0];
            $(i).removeClass("fa fa-spinner fa-spin");
            $(i).addClass("fas fa-check-circle");
        }
    }, false);
</script>
<?php } ?>
<table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px; padding: 4px; margin-top: 30px'>
    <tr>
        <td align='right' width='150'></td>
        <td align='right' width='55'>
            <img src='imagens/ajuda_call.png' align='absmiddle' onClick='javascript:mostraEsconde();'>
        </td>
        <td align='center'>
            <STRONG>APRESENTAÇÃO</STRONG><BR><?php

            $sql = "SELECT pergunta FROM tbl_callcenter_pergunta WHERE codigo='1' AND fabrica = $login_fabrica";
            $pe  = pg_query($con, $sql);

            if (pg_num_rows($pe) > 0) {
                echo pg_fetch_result($pe, 0, 0);
            } else {

                if ($login_fabrica == 25) echo "Hbflex"; else echo "$nome_da_fabrica";?>, <?echo ucfirst((!empty($login_nome_completo)) ? $login_nome_completo : $login_login);?>, <?echo saudacao();?>.<BR> O Sr.(a) já fez algum contato com a <? if ($login_fabrica==25) echo "Hbflex"; else echo "$nome_da_fabrica ";?> <?if($login_fabrica==25){ ?> por telefone ou pelo Site<?}?> ?
            <?}?>
        </td>
        <td align='right' width='150'></td>
    </tr>
</table>

<?php

#94971
if ($login_fabrica == 59 AND strlen($_GET['herdar']) > 0) {
    $id = $_GET['Id'];
    $end_herda = "?herdar=sim&Id=$id";
}

if (strlen($callcenter) > 0 OR $login_fabrica == 30) {
    include_once "../class/aws/s3_config.php";

    include_once S3CLASS;

    $s3 = new AmazonTC('callcenter', (int) $login_fabrica);
?>
    <link rel="stylesheet" type="text/css" href="fancybox/jquery.fancybox-1.3.4.css" />

<!--BoxUploader-->
<link rel='stylesheet' href='plugins/font_awesome/css/font-awesome.css' />
<link rel='stylesheet' href='box_uploader_shadowbox.css' />

<style>
.box-uploader-app  {
    background-color: unset !important;
}

.box-uploader-app .titulo_tabela {
    background-color: unset !important;
    color: #000;
    font-size: 16px;
    font-weight: bold;
}

.box-uploader-app .btn.btn-block.btn-mini.btn-danger.btn-delete-file {
    padding-top: 5px !important;
    padding-bottom: 5px !important;
    height: 20px;
}

.modal-header > h3 {
    font-size: 16px;
}

.modal-header > button, .modal-footer > button {
    font-size: 20px !important;
    font-weight: bold;
}
</style>

    <script src='js/FancyZoom.js'></script>
    <script src='js/FancyZoomHTML.js'></script>

    <script>
        $(function () {
            function carregaDadosNumeroSerie(){
                var numeroSerie = $(this).val();
                var produtoReferencia = $("input[name=produto_referencia]").val();

                $.ajax({
                url: "cadastro_os.php",
                type: 'get',
                data: {
                    "numeroSerie": numeroSerie,
                        "produtoReferencia": produtoReferencia
                    }
            }).always(function(data, textStatus, responseObj){
                var response = $.parseJSON(data);
                if(response.hasOwnProperty('msg')){
                    alert(response.msg);
                }

            $('#data_fabricacao').val(response.data_fabricacao).attr('readonly','readonly');
                $('#data_venda').val(response.data_venda).attr('readonly','readonly');
            });
        }
        
            //$("#serie").blur(carregaDadosNumeroSerie); Não funciona, ninguém questionou e não sei oque fazia.  

        });
    </script>

    <br />
    <?php
        if($callcenter == 0 and $login_fabrica == 30){
            $tempUniqueId = sha1($login_fabrica.$login_admin.date("dmYHis"));
        }
     ?>

    <div style='width: 1024px; margin: 0 auto; text-center;' >
        <?php
        if($callcenter == 0 and $login_fabrica == 30){
            $boxUploader = array(
                "div_id" => "div_anexos",
                "context" => "callcenter",
                "hash_temp" => true,
                "unique_id" => $tempUniqueId
            );
        }else{
            $boxUploader = array(
                "div_id" => "div_anexos",
                "context" => "callcenter",
                "unique_id" => $callcenter
            );
        }
        include "box_uploader.php";
        ?>
    </div>
    <script>
    $(function() {
        BoxUploader.registerCallback('delete', (res, file) => new Promise((resolve, reject) => {
            if (res.remove == 'ok') {
                $.ajax({
                    async: true,
                    timeout: 60000,
                    type: 'POST',
                    dataType: 'JSON',
                    url: 'callcenter_interativo_new.php',
                    data: {
                        ajax_interage_upload_arquivo_excluir: true,
                        tdocsId: file.id(),
                        callcenter: '<?=$callcenter?>'
                    },
                })
                .done(() => resolve());
            }
            resolve();
        }));

        BoxUploader.registerCallback('upload', (fileInfo) => new Promise((resolve, reject) => {
            $.ajax({
                async: true,
                timeout: 60000,
                type: 'POST',
                dataType: 'JSON',
                url: 'callcenter_interativo_new.php',
                data: {
                    ajax_interage_upload_arquivo: true,
                    nome_arquivo: fileInfo.fileId.file_name[0],
                    callcenter: '<?=$callcenter?>'
                }
            }).done(() => resolve());
        }));
    });
    </script>

    <br />

<?php
}
if($login_fabrica == 129){
?>
    <div style="text-align: center; width: 100%;" class="url_ramal">

    <?php

        if(strlen($callcenter) > 0){
            $sql = "SELECT array_campos_adicionais FROM tbl_hd_chamado_extra WHERE hd_chamado = {$callcenter}";
            $res = pg_query($con, $sql);

            $adicionais = pg_fetch_result($res, 0, "array_campos_adicionais");

            if(strlen($adicionais) > 0){

                $adicionais = json_decode($adicionais, true);

                $url_ramal = str_replace("\\\\", "\\", $adicionais["caminho_arquivo"]);
                $url_ramal = "\\\\admin09\\".str_replace(":", "", $url_ramal);

                echo (strlen($url_ramal) > 0) ? "<img src='../imagens/phone-icon.png' height='30' /> <br /> <strong>{$url_ramal}<strong>" : "";

            }
        }
    ?>
    </div>
<?php
}
?>

<form lang="pt-br" name='frm_callcenter' id='frm_callcenter' enctype="multipart/form-data" method='post' action='<?$PHP_SELF?><?=$end_herda?>'>

<input type="hidden" name="valida_jornada" id='valida_jornada' value='<?=$result_jornada?>'>
<input type="hidden" name="tem_jornada" id='tem_jornada' value="<?=$tem_jornada?>">
<input type="hidden" name="contrato" id='contrato' value="<?=$contrato?>">

<input name="callcenter" class="input" type="hidden" value='<?echo $callcenter;?>' />
<input name="protocolo_id" id='protocolo_id' class="input" type="hidden" value='<?=$protocolo;?>' />
<table width="100%" border="0" align="center" cellpadding="2" cellspacing="2" style='font-size:12px'><?php

// Inicio - Verificar se o fabricante tem integração com telefonia
if ($integracaoTelefonia === true) {
    echo "<input type='hidden' name='ligacao_id' id='ligacao_id' value='" . $ligacao_id . "'>";
}
// Fim

if ($login_fabrica == 5 or $login_fabrica == 24) {

    if($login_fabrica == 24){
        $style = "display:none";
    }

?>
    <tr>
        <td align='right' style="font-size: 14px; font-weight: bold; font-family: arial; color:red; <?php echo $style; ?>">INDICAÃÃO DE POSTO
            <input type="checkbox" name="indicacao_posto" id="indicacao_posto" <? if($indicacao_posto=="t") echo "checked";?> value="t" <?if ($login_fabrica == 24){ ?>onChange="indicacao_suggar(this, 'onchange');" <?} else {?> onChange="indicacao(this);" <?}?>>
        </td>
    </tr><?php
}

if($login_fabrica == 151){
    $font_mondial_analista      = " style='font-size:20px' ";
    $font_mondial_atendimento   = " style='font-size:24px' ";
}

?>

<tr>
    <td align='left'>
        <table width="100%" border='0'>
            <tr>
                <td align='left'><strong>Cadastro de Atendimento</strong></td><?php
                if (strlen($callcenter)>0 AND $login_fabrica == 3) {?>
                    <td nowrap>Tipo de registro: <strong><? echo $tipo_registro; ?></strong></td><?php
                }

                if (strlen ($admin_login) > 0) {
                    echo "<td ><b>Aberto por: </b>  $admin_login - <span $font_mondial_analista> $admin_nome_completo   </span> <b>  &nbsp; &nbsp;  Em: </b>  $data_abertura_callcenter";
                    if(in_array($login_fabrica, array(169,170))){
                        $sql_atendente_atual = "SELECT login, nome_completo FROM tbl_admin WHERE fabrica = {$login_fabrica} AND admin = {$atendente_pendente}";
                        $res_atendente_atual = pg_query($con, $sql_atendente_atual);

                        if(pg_num_rows($res_atendente_atual) > 0){
                            $atendente_atual_login = pg_fetch_result($res_atendente_atual, 0, 'login');
                            $atendente_atual_nome = pg_fetch_result($res_atendente_atual, 0, 'nome_completo');
                        }

                        echo "&nbsp; &nbsp; &nbsp;<b>Atendente Atual: </b>$atendente_atual_login - $atendente_atual_nome";
                    }
                    echo "</td>";
                }

                if (strlen($atendimento_callcenter) > 0 AND $login_fabrica == 35) {?>
                    <td nowrap>Atendimento(Solutiva): <strong><? echo $atendimento_callcenter; ?></strong></td><?php
                }?>

                <?php
                    if($login_fabrica == 74 AND strtoupper($status_interacao) != "RESOLVIDO" AND (strtotime($data_hd_chamado.'+ 30 days') < strtotime(date('Y-m-d')))){
                ?>
                    <td align='left' width='500'><font color='#FF0000'><b>Atendimento aberto a mais de 30 dias</b></font></td>
                <?php
                    }
                ?>

                <td align='right'>
                    <div id='protocolo'>
                        <strong><?php
                        if (strlen($protocolo) > 0 OR strlen($callcenter) > 0) {

                            if (strlen($protocolo_cliente) > 0 && $login_fabrica == 90)
                                echo "número IBBL: <font color='#CC0033'>" . $protocolo_cliente . '</font> - ';

                            if(strlen($protocolo) >0){
                                echo "N: <font color='#CC0033' $font_mondial_atendimento >$protocolo</font>";
                            }else{
                                echo "N: <font color='#CC0033' $font_mondial_atendimento >$callcenter</font>";
                            }

                        } else {
                            echo "<font color='#CC0033'><a href='javascript: geraProtocolo();'>GERAR PROTOCOLO</font></a>";
                        }?>
                        </strong>
                    </div>
                </td>
            </tr>
            <?=(in_array($login_fabrica, array(169,170))) ? '<tr><td  align="left"></td><td colspan="2" align="right"><labe style="color: #B94A48;"><strong>* Campos Obrigatórios</strong></label></td></tr>' : '';?>

		</table><?php
		 if($login_fabrica == 151) {
			 $btn_pre_atendimento = "<td><input class='input' type='button' name='btn_pre_atendimento' value='Pré-Atendimento' style='width:120px;height:30px' onclick='abrir_pre_atendimento();'></td>";
			 $cspan = 3;
		 } else {
			 $cspan = 2;
		 }

        if(in_array($login_fabrica, [169,170])){
        ?>
            <table width="100%" corder='0'>
                <tr>
                    <td colspan="100%" style="border: 1px solid #DD0000; background-color: #FFDDCC; padding: 5px;">
                        <b>PROTOCOLO VIA</b>
                    </td>
                </tr>
                <tr>

                    <td align='left' style="padding-left: 20px;">
                        <label class="asteristico">*</label>
                        <select name="tipo_protocolo" id="tipo_protocolo" class="input" onchange="tipoProtocloClassificacaoOrigem()">
                            <option value=''>Escolha</option>
                            <?php
                                $sql = "SELECT  tbl_hd_tipo_chamado.hd_tipo_chamado, 
                                                tbl_hd_tipo_chamado.descricao 
                                        FROM tbl_hd_tipo_chamado 
                                        JOIN tbl_hd_tipo_chamado_vinculo USING(hd_tipo_chamado)
                                        WHERE fabrica = {$login_fabrica} 
                                        AND tbl_hd_tipo_chamado_vinculo.admin = {$login_admin}
                                        AND ativo ORDER BY descricao";
                                
                                $res = pg_query($con,$sql);
                                $tipos = pg_fetch_all($res);


                                foreach($tipos AS $k => $row){

                                    $selected = ($row['hd_tipo_chamado'] == $tipo_protocolo) ? "SELECTED" : "";

                                    echo "<option value='".$row['hd_tipo_chamado']."' {$selected}>".$row['descricao']."</option>";
                                }
                            ?>
                        </select>
                    </td>
                </tr>
            </table>
        <?php
        }

        if (strlen($callcenter) == 0) {?>
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style='border:#485989 1px solid; background-color: #e6eef7;font-size:10px'>
                <!-- HD 216395: Mudar todas as buscas de nome para LIKE com % apenas no final. A funcao function mostrarMensagemBuscaNomes() está definida no js/assist.js -->
                <tr>
                    <td colspan="100%" style='border: 1px solid #DD0000; background-color: #FFDDCC; padding: 5px;' id="aviso_localizar_nome">
                    <b>BUSCA POR NOME:</b> utilizar sempre letras MAIUSCULAS E SEM ACENTOS. Clique no icone "?" a seguir para INSTRUÇÕES <img align="absmiddle" src='imagens/help.png' title='Clique aqui para ajuda na busca deste campo' onclick='mostrarMensagemBuscaNomes()'>
                    </td>
                </tr>
                <tr>
                    <td align='left' width='68'><strong>Localizar:</strong></td>
                    <td>
                    <table><?php
                    //HD 163220 - Abrir popup para todos os tipos de pesquisas na fábrica
                    //          - Retirei o if ($login_fabrica == 3), pois a Britania não utiliza esta tela e a busca
                    //            está sendo padronizada
                    if ($login_fabrica == 174) {
                        $localizar_opcoes = array('cpf', 'nome', 'pedido_info', 'os', 'serie', 'email', 'telefone', 'lote', 'nf', 'cep', 'atendimento');
                        $localizar_labels = array('CPF/CNPJ', 'Nome', 'Pedido de Compra', 'OS', 'nº de Série', 'E-mail', 'Telefone', 'Lote', 'NF de Compra', 'CEP', 'Atendimento');
                    } else {
                        $localizar_opcoes = array('cpf', 'nome', 'atendimento', 'os', 'serie', 'cep', 'telefone');
                        $localizar_labels = array('CPF/CNPJ', 'Nome', 'Atendimento', 'OS', 'nº de Série', 'CEP', 'Telefone');

                    }

                    if (in_array($login_fabrica, [164])) {
                        $localizar_opcoes = array('cpf', 'nome', 'atendimento', 'os', 'serie', 'cep', 'telefone', 'nf');
                        $localizar_labels = array('CPF/CNPJ', 'Nome', 'Atendimento', 'OS', 'nº de Série', 'CEP', 'Telefone', 'NF de Compra');
                    }

                    if (in_array($login_fabrica, [189])) {
                        $localizar_opcoes = array('cpf', 'nome', 'pedido_info', 'atendimento', 'cep', 'telefone', 'nf');
                        $localizar_labels = array('CPF/CNPJ Revenda', 'Revenda', 'Pedido', 'Atendimento', 'CEP', 'Telefone', 'Nota Fiscal');
                    }

                    if($login_fabrica == 161){
                        $localizar_opcoes[] = "lote";
                        $localizar_labels[] = "Lote";
                    }

                    if($login_fabrica == 186){
                        $localizar_opcoes[] = "email";
                        $localizar_labels[] = "E-mail Consumidor";
                    }

                    if($login_fabrica == 190){
                        $localizar_opcoes[] = "contrato";
                        $localizar_labels[] = "nº Contrato";
                    }

                    if($login_fabrica == 42){
                        $localizar_opcoes = array('codigo_posto','cpf', 'nome', 'atendimento', 'os', 'pedido', 'serie', 'cep', 'telefone');

                        $localizar_labels = array('Código do Posto', 'CPF/CNPJ', 'Nome', 'Atendimento', 'OS', 'nº do Pedido', 'nº de Série', 'CEP', 'Telefone', 'Lote');
                    }

                    $localizar_posicao_retorno = array(11, 1, 0, 16, 17, 6, 8);
                    $localizar_links = array();
                    $localizar_autocomplete = array();
                    //HD311031
                    $cor_font = $login_fabrica == 30 ? 'font-size:10px;' : '';

                    for ($l = 0; $l < count($localizar_opcoes); $l++) {

                        if ($l % 3 == 0) {
                            $localizar_links[$l] = "<tr>";
                        }

                        if ($localizar_opcoes[$l] == "nome") {
                            $onkeyup = "somenteMaiusculaSemAcento(this);";
                        } else {
                            $onkeyup = "";
                        }

                        if ($localizar_opcoes[$l] == "telefone") {
                            $class = "class='input_req2 telefone'";
                        } else {
                            $class = "class='input_req2'";
                        }

                        $localizar_links[$l] .= "<td align=right style='padding-left:10px;$cor_font'>" . $localizar_labels[$l] . ": </td><td><input type=text name='localizar_" . $localizar_opcoes[$l] . "' id='localizar_" . $localizar_opcoes[$l] . "' " . ($localizar_opcoes[$l] != 'cep' ? "onkeyup='retiraAcentos(this); $onkeyup'" : '') . " ".$class."> <img src='imagens/lupa.png' title='Buscar' onclick='fnc_pesquisa_consumidor_callcenter(document.getElementById(\"localizar_" . $localizar_opcoes[$l] . "\").value, \"" . $localizar_opcoes[$l] . "\")' style='cursor:pointer;'></td>";

                        if ($l % 3 == 2) {
                            $localizar_links[$l] .= "</tr>";
                        }

                        if (!in_array($login_fabrica, array(169, 170))) {
                            $qtde_pesquisa = ($login_fabrica == 42) ? 4 : 6;

                            if ($localizar_opcoes[$l] != "nome") {

                                $localizar_autocomplete[$l] = '
                                $("#localizar_' . $localizar_opcoes[$l] . '").autocomplete("pesquisa_consumidor_callcenter_nv.php?tipo_pesquisa=' . $localizar_opcoes[$l] . '&ajax=sim&engana="+engana, {
                                    minChars: '.$qtde_pesquisa.',
                                    delay: 700,
                                    width: 300,
                                    max: 30,
                                    matchContains: true,
                                    formatItem: formatLocalizar,
                                    formatResult: function(row) {
                                    return $("#localizar_' . $localizar_opcoes[$l] . '").val();
                                }
                                });

                                $("#localizar_' . $localizar_opcoes[$l] . '").result(function(event, data, formatted) {
                                    preencheConsumidorAutocomplete(event, data, formatted);
                                });
                                ';
                            }
                        }
                    }
                    // $novo_consumidor = "<input type=button value='Novo Consumidor' onclick=\"javascript:localizarConsumidor('localizar','novo')\" class=input_req2 style='background-color:#DDDDDD'>";

                    // switch ($l % 3) {
                    //  case 0:
                    //      $localizar_links[$l] .= "<td colspan=2 align=right>$novo_consumidor</td><td></td><td></td></tr>";
                    //  break;

                    //  case 1:
                    //      $localizar_links[$l] .= "<td colspan=2 align=right>$novo_consumidor</td><td></td></tr>";
                    //  break;

                    //  case 2:
                    //      $localizar_links[$l] .= "<td colspan=2 align=right>$novo_consumidor</td></tr>";
                    //  break;
                    // }

                    $localizar_links = implode("", $localizar_links);
                    echo $localizar_links;

                    $localizar_autocomplete = implode("", $localizar_autocomplete);
                    echo "<script language='javascript'>
                            var hora = new Date();
                            var engana = hora.getTime()
                            $localizar_autocomplete
                        </script> "; ?>
                    </table>
                </td>
		<?=$btn_pre_atendimento; ?>
            </tr>
            <tr>
                <td colspan='2'>
                    Digite pelo menos 6 caracteres em um dos campos acima e clique na lupa para localizar e recuperar na tela os dados do atendimento.
                </td>
            </tr>
        </table>
    <?  } ?>
    </td>
</tr>
<tr>
    <td>
    <div id='div_consumidor' style='display:inline; Position:relative;background-color: #e6eef7;width:100%'>
        <input type='hidden' name='atendimento_callcenter' value='<?=$atendimento_callcenter?>'>
        <table width='100%' border='0' align='center' cellpadding='2' cellspacing='2' style='border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left: 4px;' id='tabela_consumidor'>
        <?php if ($login_fabrica == 152) {?>
        <tr>
            <td colspan='6' align='left'>
                <table border='0' cellpadding='3' cellspacing='0' width="50%">
                    <tr>
                        <td align='left'>
                            <b>Tipo de atendimento:</b>
                        </td>
                        <td align='left'>
                            <input type='radio' id="consumidor_revenda_c" name='tipo_atendimento_consumidor' value='C' <?php if ($tipo_atendimento_consumidor == 'C') { echo "CHECKED";}?> onclick="fnc_tipo_atendimento(this)">
                            <label for="consumidor_revenda_c">Cliente Final</label>
                        </td>
                        <td align='left'>
                            <input type='radio' id="consumidor_revenda_r" name='tipo_atendimento_consumidor' value='R' <?php if ($tipo_atendimento_consumidor == 'R') { echo "CHECKED";}?> onclick="fnc_tipo_atendimento(this)">
                            <label for="consumidor_revenda_r">Revenda</label>
                        </td>
                        <td align='left'>
                            <input type='radio' id="consumidor_revenda_a" name='tipo_atendimento_consumidor' value='S' <?php if ($tipo_atendimento_consumidor == 'S') { echo "CHECKED";}?> onclick="fnc_tipo_atendimento(this)">
                            <label for="consumidor_revenda_a">SAE</label>
                        </td>
                        <td align='left'>
                            <input type='radio' id="consumidor_revenda_w" name='tipo_atendimento_consumidor' value='W' <?php if ($tipo_atendimento_consumidor == 'W') { echo "CHECKED";}?> onclick="fnc_tipo_atendimento(this)">
                            <label for="consumidor_revenda_w">WhatsApp</label>
                        </td>
                    <tr>
                </table>
            </td>
        </tr>
        <?php }?>

       <?php if ($login_fabrica == 2 || $login_fabrica == 10 || $login_fabrica == 91) {?>
        <tr>
            <td colspan='6' align='left'>
                <table border='0' cellpadding='3' cellspacing='0' width="50%">
                    <tr>
                        <td align='left'>
                            <b>Tipo de atendimento:</b>
                        </td>
                        <td align='left'>
                            <label for="consumidor_revenda_c">Consumidor</label>
                            <input type='radio' id="consumidor_revenda_c" name='consumidor_revenda' value='C' <?PHP if ($consumidor_revenda == 'C' or $consumidor_revenda == '') { echo "CHECKED";}?> onclick="fnc_tipo_atendimento(this)">
                        </td>
                        <td align='left'>
                            <label for="consumidor_revenda_r">Revenda</label>
                            <input type='radio' id="consumidor_revenda_r" name='consumidor_revenda' value='R' <?PHP if ($consumidor_revenda == 'R') { echo "CHECKED";}?> onclick="fnc_tipo_atendimento(this)">
                        </td>
                        <td align='left'>
                            <label for="consumidor_revenda_a">Assistência Técnica</label>
                            <input type='radio' id="consumidor_revenda_a" name='consumidor_revenda' value='A' <?PHP if ($consumidor_revenda == 'A') { echo "CHECKED";}?> onclick="fnc_tipo_atendimento(this)">
                        </td>
                        <?php if ( $login_fabrica == 10 ): ?>
                        <td align='left'>
                            <label for="consumidor_revenda_f">Fábrica</label>
                            <input type='radio' id="consumidor_revenda_f" name='consumidor_revenda' value='F' <?PHP if ($consumidor_revenda == 'F') { echo "CHECKED";}?> onclick="fnc_tipo_atendimento(this)">
                        </td>
                        <?php endif; ?>
                        <?php if ( $login_fabrica == 91 ){ ?>
                        <td align='left'>
                            <label for="consumidor_revenda_f">Equipe Comercial</label>
                            <input type='radio' id="consumidor_revenda_e" name='consumidor_revenda' value='E' <?PHP if ($consumidor_revenda == 'E') { echo "CHECKED";}?> onclick="fnc_tipo_atendimento(this)">
                        </td>
                        <?php } ?>
                    <tr>
                </table>
            </td>
        </tr><?php
        } else if(in_array($login_fabrica,array(7,11, 15,24,30,35,42,50,52,59,74,81,85,101,114,116)) || isset($novaTelaOs) || ($login_fabrica >= 119)) {
            if (in_array($login_fabrica, array(30,50))) {
?>
            <tr>
                <td colspan="8" style='border: 1px solid #DD0000; background-color: #FFDDCC; padding: 5px;' id="aviso_localizar_nome">
                OS CAMPOS EM VERMELHO SÃO DE PREENCHIMENTO OBRIGATÃRIO
                </td>
            </tr>
<?php
            }

        ?>
        <tr>
            <td colspan='6'  align='left'>
            <?php if (!in_array($login_fabrica, array(101,156))) { ?>
                <table border='0' cellpadding='3' cellspacing='0' width="50%">
                    <tr>
                        <td align='left'>
                            <b>Tipo Consumidor:</b>
                        </td>
                        <?php

                            if($login_fabrica == 7 ){
                                $checkedcpf = "";
                                $checkedcnpj = "";

                                if($consumidor_cpf != ""){

                                    $checkedcpf = "CHECKED";
                                    $checkedcnpj = "";
                                }

                                if($consumidor_cnpj != ""){
                                    $checkedcpf = "";
                                    $checkedcnpj = "CHECKED";
                                }

                                if($consumidor_cpf == "" and $consumidor_cnpj == ""){
                                    $checkedcpf = "";
                                    $checkedcnpj = "CHECKED";
                                }
                            }
                        ?>
                        <td align='left'>
                            CPF
                            <input type='radio' name='consumidor_cpf_cnpj'  <?= (in_array($login_fabrica, [178])) ? "id='consumidor_cpf'": '' ?> value='C'
                            <?php
                            if ((strlen($consumidor_cpf) == 14 OR strlen($consumidor_cpf) == 11) or strlen($consumidor_cpf) == 0) {
                                if($login_fabrica == 7){
                                    echo $checkedcpf;
                                }else{
                                    echo "CHECKED";
                                }
                            }else{
                                if($login_fabrica == 7){
                                    echo $checkedcpf;
                                }
                            }
                            $disable_cpf_cnpj = true;

                            if (!empty($_GET['os']) and $login_fabrica == '85') {
                                $chkOs = (int) $_GET['os'];
                                $qryChkOs = pg_query($con, "SELECT * FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter AND os = $chkOs");

                                if (pg_num_rows($qryChkOs) > 0) {
                                    $qryChkHDItem = pg_query($con, "SELECT hd_chamado_item FROM tbl_hd_chamado_item WHERE hd_chamado = $callcenter");

                                    if (pg_num_rows($qryChkHDItem) == 0) {
                                        $disable_cpf_cnpj = false;
                                    }
                                }
                            }

                            if((strlen($callcenter) > 0) && ($login_fabrica <> 7) and (true === $disable_cpf_cnpj) && !empty($consumidor_cpf)) {
                                echo " disabled";
                            }
                            ?>
                            onclick="<?=($login_fabrica == 178 AND !empty($callcenter))? '' : 'fnc_tipo_atendimento(this)'?>">
                        </td>
                        <td align='left'>
                            CNPJ
                            <input type='radio' name='consumidor_cpf_cnpj'id='consumidor_cnpj' value='R'
                            <?php
                            if (strlen($consumidor_cpf) == 18) {
                                if($login_fabrica == 7){
                                    echo $checkedcnpj;
                                }else{
                                    echo "CHECKED";
                                }
                            }else{
                                if($login_fabrica == 7){
                                    echo $checkedcnpj;
                                }
                            }
                            if((strlen($callcenter) > 0) && ($login_fabrica <> 7) and (true === $disable_cpf_cnpj) && !empty($consumidor_cpf)) {
                                echo " disabled";
                            }
                            ?>
                            onclick="<?=($login_fabrica == 178 AND !empty($callcenter))? '' : 'fnc_tipo_atendimento(this)'?>">
                        </td>
                         <?php if ($login_fabrica == 158) {
                            $checked = "";

                            if ($_POST["consumidor_cliente_admin"]) {
                                $checked = "checked";
                            }

                            if ($array_campos_adicionais['unidade_negocio'] != '' || $array_campos_adicionais['unidadeNegocio'] != '') {
                                $checked = "checked";
                            }
                            ?>
                            <td>
                                Cliente Admin <input type='checkbox' <?= $checked; ?> name='consumidor_cliente_admin' id='consumidor_ca'>
                            </td>
                            <script type="text/javascript">
                                $(function() {
                                    verificarClienteAdmin();
                                });

                                function verificarClienteAdmin() {
                                    if ($("#consumidor_ca").is(':checked')) {
                                        $('.unidade_imbera').addClass('unidade_imbera_visivel');
                                        $('.unidade_imbera').removeClass('unidade_imbera');
                                        $('#unidade_negocio_imbera').attr('required', true);
                                    } else {
                                        $('#unidade_negocio_imbera').val('');
                                        $('#unidade_negocio_imbera').removeAttr('required');
                                        $('.unidade_imbera_visivel').addClass('unidade_imbera');
                                        $('.unidade_imbera_visivel').removeClass('unidade_imbera_visivel');
                                    }
                                }

                                $('[name="consumidor_cliente_admin"]').on('change', function(){
                                    verificarClienteAdmin();
                                });
                                function fnc_pesquisa_unidade_imbera(nome) {
                                        if (nome.length > 2) {
                                            Shadowbox.open({
                                                content :   "pesquisa_unidade_negocio_imbera.php?nome="+nome,
                                                player  :   "iframe",
                                                title   :   "Pesquisa",
                                                width   :   400,
                                                height  :   250
                                            });
                                        }else{
                                            alert("Preenche Cliente Imbera(cliente admin)");
                                        }
                                };
                                function retorna_unidade_imbera(unidade) {
                                    $("#unidade_negocio_imbera").val(unidade);
                                    Shadowbox.close();
                                }
                            </script>
                        <?php } ?>
                    </tr>
                </table>
                <?php } ?>
            </td>
        </tr>
        <?
        }
        if (in_array($login_fabrica,array(30,52,158))) { ?>
        <tr>
            <td align='left'>
                <strong>
<?php
            if ($login_fabrica == 52) {
                echo "Cliente Fricon:";
            } else if ($login_fabrica == 158) {
                echo '<strong><acronym title="Campo Obrigatório"><font color="#AA0000">Cliente Imbera:</font></acronym></strong>';
            } else {
                echo "Atendimento Centralizado:";
            }
?>
                </strong>
                <input type='hidden' name='cliente_admin' id='cliente_admin' value="<?=$cliente_admin?>" />
                <input type='hidden' name='abre_os_admin' id='abre_os_admin' value="<?=$abre_os_admin?>" />
            </td>
            <td align='left'>
                <input type='hidden' name='cliente_nome_admin_anterior' value="<?=trim($cliente_nome_admin)?>">
                <input name="cliente_nome_admin" id="cliente_nome_admin" value='<?=trim($cliente_nome_admin)?>' <?=(strlen($cliente_admin) > 0) ? "readOnly" : ""?>class='input_req' type="text" size="35" maxlength="50">
            </td>
              <?php if ($login_fabrica == 158) {
                $classe  = ($array_campos_adicionais['unidade_negocio'] != '' || $array_campos_adicionais['unidadeNegocio'] != '' ) ? "unidade_imbera_visivel" : "unidade_imbera";
                $unidade_neg = ($array_campos_adicionais['unidade_negocio'] != '') ? $array_campos_adicionais['unidade_negocio'] : ($array_campos_adicionais['unidadeNegocio'] != '') ? $array_campos_adicionais['unidadeNegocio'] : '';

                if($unidade_neg == "" || $unidade_neg == "{"){
                    if(isset($_POST["unidade_negocio_imbera"])){
                        $unidade_neg = $_POST["unidade_negocio_imbera"];

                    } else if(isset($array_campos_adicionais['unidade_negocio'])){
                        $unidade_neg = $array_campos_adicionais['unidade_negocio'];

                    }
                }
                ?>
                <style type="text/css">
                    .unidade_imbera{
                        display: none;
                    }
                </style>
                <td class="<?=$classe;?>">
                    <strong><acronym title="Campo Obrigatório"><font color="#AA0000">Unidade de Negócio</font></acronym></strong>
                </td>
                <td class="<?=$classe;?>">
                    <input type="text" name="unidade_negocio_imbera" id="unidade_negocio_imbera" value="<?= $unidade_neg ;?>">
                    <img style="cursor: pointer; margin-bottom: -4px;" onclick="fnc_pesquisa_unidade_imbera(document.getElementById('cliente_nome_admin').value)" title="Buscar" src="imagens/lupa.png"/></acronym>
                </td>
            <?php } ?>
        <tr>
        <?
        }
        ?>
        <tr>
            <? if (in_array($login_fabrica, array(30,50,158))) { ?>
                <td align='left'><strong><acronym title='Campo Obrigatório'><font color="#AA0000">Nome:</font></acronym></strong></td>
            <? } else {
                if ($login_fabrica == 24) { ?>
                <td align='left'><strong>Nome NF:</strong></td>
                <? } else {
                    if ($login_fabrica != 85) { ?>
                        <td align='left'><strong><?=(in_array($login_fabrica, array(169,170,198))) ? '<label class="asteristico">*</label>' : '';?>Nome:</strong></td>
                    <? } else { ?>
                        <td align='left'><strong><span id='label_nome'>
                            <? if((strlen($consumidor_cpf) != 18 and strlen($callcenter) > 0) or strlen($callcenter) == 0) { ?>
                                Nome:
                            <? } else if (strlen($consumidor_cpf) == 18 and strlen($callcenter) > 0) { ?>
                                Razão Social:
                            <? } ?>
                        </span></strong></td>
                    <? }
                }
            } ?>
            <td align='left'>

    			<? if (in_array($login_fabrica, array(30,50))) { ?>
    				<input type="hidden" name="consumidor_nome_anterior" value="<?php echo $consumidor_nome; ?>" />
    				<acronym title='Campo Obrigatório'><input name="consumidor_nome" id="consumidor_nome" maxlength='50' value='<?php echo $consumidor_nome; ?>' class="input_req" type="text" size="35" maxlength="50" onkeyup="somenteMaiusculaSemAcento(this);">
    				 <img style="cursor: pointer; margin-bottom: -4px;" onclick='fnc_pesquisa_consumidor_callcenter(document.getElementById("consumidor_nome").value, "nome")' title="Buscar" src="imagens/lupa.png"/></acronym>
    			<? }else{ ?>
    				<input type="hidden" name="consumidor_nome_anterior" value="<?php echo $consumidor_nome; ?>" />
    				<?=($login_fabrica == 178)? "<span style='color: #c73e10; font-weight: bold; margin-left: -8px;'>*</span>": "" ?>
                    <input name="consumidor_nome" id="consumidor_nome" maxlength='50' value='<?php echo $consumidor_nome ;?>'
    				 <?echo ($login_fabrica == 24) ? 'class="input_req2"':'class="input_req"';?> type="text" size="35" maxlength="50"
    					onkeyup="somenteMaiusculaSemAcento(this);" <? if($login_fabrica==11 or $login_fabrica == 172){?> onChange="javascript: this.value=this.value.toUpperCase();"<?}?>>
    				 <? if(!in_array($login_fabrica, array(151,169,170))){?><img style="cursor: pointer; margin-bottom: -4px;" onclick='fnc_pesquisa_consumidor_callcenter(document.getElementById("consumidor_nome").value, "nome")' title="Buscar" src="imagens/lupa.png"/> <? } ?>
    			<? } ?>
			</td>

            <?php
            if (in_array($login_fabrica, array(189))) {
            ?>
            <td align='left' nowrap><strong>Código do Cliente:</strong></td>
            <td>
                <input type="hidden" name="codigo_cliente_revenda_anterior" value="<?php echo $codigo_cliente_revenda; ?>" />
                <input name="codigo_cliente_revenda" id="codigo_cliente_revenda" value='<?php echo $codigo_cliente_revenda?>'  type="text" size="15">
            </td>
            <?php
            }
            ?>
			<?php
			if (in_array($login_fabrica, array(15,74,178))) {
                if (strlen($consumidor_cpf) > 17 OR $_POST['consumidor_cpf_cnpj'] == "R"){
                    $td_nascimento_display = "style='display: none;'";
                }
			?>
			<td <?=$td_nascimento_display?> align='left' class="td_nascimento"><strong>Data de Nascimento:</strong></td>
			<td <?=$td_nascimento_display?> class="td_nascimento">
				<input type="hidden" name="consumidor_nascimento" value="<?php echo $consumidor_nascimento; ?>" />
				<input name="consumidor_nascimento" id="consumidor_nascimento" rel="data" value='<? echo $consumidor_nascimento ?>' class="input_req" type="text" size="15" maxlength="14" <?php echo $endereco_readonly; ?> >
			</td>
			<?php
			}
			?>

			<td align='left' class='td_midea_carrier'>

			<?php if($login_fabrica == 101){ ?>
				<table>
					<tr>
						<td align='left'>
							CPF
							<input type='radio' name='consumidor_cpf_cnpj' id='consumidor_cpf' value='C'
							<?php
							if (strlen($consumidor_cpf) == 14 or strlen($consumidor_cpf) == 0) {
								if($login_fabrica == 7){
									echo $checkedcpf;
								}else{
									echo "CHECKED";
								}
							}else{
								if($login_fabrica == 7){
									echo $checkedcpf;
								}
							}

							$disable_cpf_cnpj = true;

							if (!empty($_GET['os']) and $login_fabrica == '85') {
								$chkOs = (int) $_GET['os'];
								$qryChkOs = pg_query($con, "SELECT * FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter AND os = $chkOs");

								if (pg_num_rows($qryChkOs) > 0) {
									$qryChkHDItem = pg_query($con, "SELECT hd_chamado_item FROM tbl_hd_chamado_item WHERE hd_chamado = $callcenter");

									if (pg_num_rows($qryChkHDItem) == 0) {
										$disable_cpf_cnpj = false;
									}
								}
							}

							if((strlen($callcenter) > 0) && ($login_fabrica <> 7) and (true === $disable_cpf_cnpj) && !empty($consumidor_cpf)) {
								echo " disabled";
							}
							?>
							onclick="fnc_tipo_atendimento(this)">
						</td>
						<td align='left'>
							CNPJ
							<input type='radio' name='consumidor_cpf_cnpj' id='consumidor_cnpj' value='R'
							<?php
							if (strlen($consumidor_cpf) == 18) {
								if($login_fabrica == 7){
									echo $checkedcnpj;
								}else{
									echo "CHECKED";
								}

							}else{
								if($login_fabrica == 7){
									echo $checkedcnpj;
								}
							}
							if((strlen($callcenter) > 0) && ($login_fabrica <> 7) and (true === $disable_cpf_cnpj) && !empty($consumidor_cpf)) {
								echo " disabled";
							}
							?>
							onclick="fnc_tipo_atendimento(this)">
						</td>
					</tr>
				</table>

				<?php

			}else{

				?>

				<strong>
                    <?= (in_array($login_fabrica, [198])) ? "<label class='asteristico'>*</label>" : ""; ?>
					<span id='label_cpf'>
						<?php
                        if (!in_array($login_fabrica, array(7,156))) {
							if((strlen($consumidor_cpf) != 18 and strlen($callcenter) > 0) or strlen($callcenter) == 0) {
								if(in_array($login_fabrica, array(169,170))){
                                    echo '<label class="asteristico">*</label>' ;
                                }
                                if($login_fabrica == 30){
                                    echo "<font color='#AA0000'>CPF:</font>";
                                }else{
                                    echo "CPF:";
                                }
                                $limite ='14';
                                $mascara_box_format = '999.999.999-99';
                            }elseif(strlen($consumidor_cpf) == 18 and strlen($callcenter) > 0 ){
                                echo "CNPJ:";
                                $limite = "18";
                                $mascara_box_format = '99.999.999/9999-99';
                            }
                        }else{
                            echo "CNPJ:";
                            $limite = "18";
                            $mascara_box_format = '99.999.999/9999-99';
                        }

                        $campos_obrig = (in_array($login_fabrica, array(30,50,158))) ? '<acronym title="Campo Obrigatório"><font color="#AA0000">' : NULL;
                        $fx_cmp_obg = !is_null($campos_obrig) ? '</font></acronym>' : '';

                        ?>
                    </span>
                </strong>

                <?php
            }

            ?>

            </td>

            <?/* 08/04/2010 MLG - HD 209670 - Retirado código para bloquear esta parte do formulário na Lenoxx */?>
            <td align='left'>

                <?php
                if ($_POST['consumidor_cpf_anterior'] and $msg_erro){
                    $consumidor_cpf_anterior = $_POST['consumidor_cpf_anterior'];
                }else{
                    $consumidor_cpf_anterior = $consumidor_cpf;
                }
                // HD 2498770 - PREENCHIMENTO DE DADOS (CHAMADO)
                if ($login_fabrica != 52) { ?>
                <input type="hidden" name="consumidor_cpf_anterior" id="consumidor_cpf_anterior" value="<?php echo trim($consumidor_cpf_anterior); ?>" />
                <?php $idCpf = ($login_fabrica == 161) ? "cpf1" : "cpf"; ?>
                <input type="text" name="consumidor_cpf" id="<?=$idCpf?>" value='<? echo trim($consumidor_cpf) ;?>'
                      class="input_req" size="23" maxlength="<?=$limite?>"
                 <?if($login_fabrica == 11 or $login_fabrica == 172){?>onkeyup="javascript:retiraAcentos(this);"<?}?>
                  <?=$readonly_cpf?><?php if ($login_fabrica == 164) {echo 'onblur="{fnc_cpf_com_atendimento()}"'; } ?>>


                 <?php } else { ?>

                <input type="hidden" name="consumidor_cpf_anterior" value="<?php echo trim($consumidor_cpf_anterior); ?>" />
                <input type="text" name="consumidor_cpf" id="cpf" value='<? echo trim($consumidor_cpf) ;?>' class="input_req" size="15" maxlength="<?=$limite?>">

                 <script>
                    $("#cpf").autocomplete("pesquisa_consumidor_callcenter_nv.php?tipo_pesquisa=cpf&ajax=sim", {
                                minChars: 6,
                                delay: 700,
                                width: 300,
                                max: 30,
                                matchContains: true,
                                formatItem: formatLocalizar,
                                formatResult: function(row) {
                                return $("#cpf").val();
                            }
                            });

                            $("#cpf").result(function(event, data, formatted) {
                                preencheConsumidorAutocomplete(event, data, formatted);
                                fnc_pesquisa_consumidor_callcenter(data['11', '1', '0', '16', '17', '6', '8'], "cpf", true);
                            });

                 </script>

                 <?php
                 }
                 //Fim HD 2498770
                 #if($login_fabrica <> 151){
                 if(!in_array($login_fabrica, array(151,169,170))){
			//não tera lupar para a procura de clientes mondial apenas para atendimento ja cadastrado!
				 ?>
				<img style="cursor: pointer; margin-bottom: -4px;" onclick='fnc_pesquisa_consumidor_callcenter(document.getElementById("cpf").value, "cpf")' title="Buscar" src="imagens/lupa.png"/>
				<? } ?>
				<input name="cliente" id="cliente" value='<? echo $cliente ;?>' type="hidden">
			</td>
			<?php if ($login_fabrica == 156) { ?>
			<td align='left'><strong title="Inscrição estadual">I.E.:</strong></td>
			<td align='left'>
				<input type="hidden" name="consumidor_rg_anterior" value="<?php echo $consumidor_rg; ?>" />
				<input name="consumidor_rg" id="consumidor_rg" value='<? echo $consumidor_rg ;?>'  class="input_req" type="text" size="14" maxlength="14">
			</td>
			<?php } else if (in_array($login_fabrica, array(85, 169, 170))) { ?>
			<td colspan="2">&nbsp;</td>
			<?php
                } else {
                    if ($login_fabrica == 178 && empty($consumidor_rg) && $consumidor_cpf_cnpj != "R" && strlen($consumidor_cpf) <= 17){
                        $td_display = "style='display: none;'";
                    }
            ?>
			<td align='left' <?=$td_display?> class='label_ie'>
            <?php if ($login_fabrica == 178){ ?>
                <strong>IE:</strong>
            <?php } else { ?>
                <?php if (in_array($login_fabrica, array(11, 81, 103, 114, 119, 122, 123, 125, 147, 160, 172, 174, 187, 188, 189)) && strlen($consumidor_cpf) == 18 && strlen($callcenter) > 0) {?>
                    <strong>IE:</strong>
                <?php } else {?>
                    <strong>RG:</strong>
                <?php }?>
            <?php } ?>
            </td>

            <td align='left' class='campo_ie' <?=$td_display?> >
                <input type="hidden" name="consumidor_rg_anterior" value="<?php echo $consumidor_rg; ?>" />
                <?php $idRg = ($login_fabrica == 161) ? "consumidor_rg1" : "consumidor_rg"; ?>
                <input name="consumidor_rg" id="<?=$idRg?>" value='<? echo $consumidor_rg ;?>'  class="input_req" type="text" size="14" maxlength="14">
            </td>
            <?php } ?>
            <?php
            if (in_array($login_fabrica, array(30))) {
            ?>
            <td align='left' nowrap><strong>Data de Nascimento:</strong></td>
            <td>
                <input type="hidden" name="consumidor_nascimento" value="<?php echo $consumidor_nascimento; ?>" />
                <input name="consumidor_nascimento" id="consumidor_nascimento" rel="data" value='<? echo $consumidor_nascimento ?>' class="input_req" type="text" size="15" maxlength="14" <?php echo $endereco_readonly; ?> >
            </td>
            <?php
            }
            ?>
        </tr>
        <?php if(in_array($login_fabrica, array(189))) {?>
            <tr>
                <td align='left'>
                    <strong>Registrado por:</strong>
                </td>
                <td align='left'>
                    <input type="hidden" name="nome_empresa_anterior" value="<?php echo $nome_empresa; ?>" />
                    <input name="nome_empresa" id="nome_empresa" maxlength='50' size="30" value='<?php echo $nome_empresa ;?>' class="input_req" type="text"  />
                </td>
            </tr>
        <?php }?>
        <tr>
            <?php
            if(in_array($login_fabrica, array(174))) {?>
               <td align='left'><strong>Nome Contato:</strong></td>
               <td align='left'>
                    <input type="hidden" name="contato_nome_anterior" value="<?php echo $contato_nome; ?>" />
                    <input name="contato_nome" id="contato_nome" maxlength='50' size="30" value='<?php echo $contato_nome ;?>' class="input_req" type="text" size="35" onkeyup="somenteMaiusculaSemAcento(this);" />
               </td>
            <?php }

            $endereco_readonly = '' ; //08/04/2010 MLG - HD 209670 - ( $login_fabrica == 11 && isset($callcenter) && $callcenter > 0 && $status_interacao != 'Aberto' ) ? 'readonly' : ?>
            <td align='left'><strong>E-mail:</strong></td>
            <td align='left'>
                <input type="hidden" name="consumidor_email_anterior" value="<?php echo $consumidor_email; ?>" />
                <input name="consumidor_email" id="consumidor_email" value='<? echo $consumidor_email ?>' class="input_req" type="text" size="40" maxlength="50" <?php echo $endereco_readonly; ?> >
            </td>
            <td align='left' class='td_midea_carrier'>
                <?= (in_array($login_fabrica, [198])) ? "<label class='asteristico'>*</label>" : ""; ?>
                <strong>
                    <?
                    echo (in_array($login_fabrica, array(158))) ? $campos_obrig : "";
                    if($login_fabrica == 59){
                        echo "Telefone Residêncial:";
                    }elseif($login_fabrica == 101){
                        echo "Telefone Principal:";
                    }else{
                        echo "Telefone:";
                    }
                    echo (in_array($login_fabrica, array(158))) ? $fx_cmp_obg : ""; ?>
                </strong>
            </td>
            <td align='left'>

                <? if($integracaoTelefonia === true) { ?>
                    <input type="hidden" name="consumidor_fone_anterior" value="<?php echo $_REQUEST['a']; ?>" />
                    <input name="consumidor_fone" id="telefone" value='<? echo $consumidor_fone; ?>' class="input_req telefone" type="text" size="15" maxlength="15" <?php echo $endereco_readonly; ?> >
                    <script>
                        $("#telefone").autocomplete("pesquisa_consumidor_callcenter_nv.php?tipo_pesquisa=telefone&ajax=sim", {
                                    minChars: 6,
                                    delay: 700,
                                    width: 300,
                                    max: 30,
                                    matchContains: true,
                                    formatItem: formatLocalizar,
                                    formatResult: function(row) {
                                    return $("#telefone").val();
                                    }
                                });

                                $("#telefone").result(function(event, data, formatted) {
                                    preencheConsumidorAutocomplete(event, data, formatted);
                                    fnc_pesquisa_consumidor_callcenter(data['11', '1', '0', '16', '17', '6', '8'], "telefone", true);
                                });
                    </script>
                    <img style="cursor: pointer; margin-bottom: -4px;" onclick='fnc_pesquisa_consumidor_callcenter(document.getElementById("telefone").value, "telefone")' title="Buscar" src="imagens/lupa.png"/>&nbsp;&nbsp;
                    <? if(!empty($callcenter) && ($login_sac_telecontrol === true)) { ?>
                        <img style="cursor: pointer; margin-bottom: -4px;" onclick='fnc_discar(document.getElementById("telefone").value)' title="Discar Telefone" src="imagens/telefone_002.png" width="15" height="15" id='icone_telefone' />
                <?
                       }
                    } else {
                        if ($login_fabrica == 183){
                            $valida = substr($consumidor_fone, 1, 2);
                            if ($valida == "55"){
                                $consumidor_fone = substr($consumidor_fone, 3);
                            }
                        }
                ?>
                    <input type="hidden" name="consumidor_fone_anterior" value="<?php echo $consumidor_fone; ?>" />
                    <?=($login_fabrica == 178)? "<span style='color: #c73e10; font-weight: bold; margin-left: -8px;'>*</span>": "" ?>
                    <?php $idFone = ($login_fabrica == 161) ? "telefone5" : "telefone"; ?>
                    <input name="consumidor_fone" id="<?=$idFone?>" value='<? echo $consumidor_fone ;?>' <? if ($login_fabrica == 24) { ?>class="input_req2 telefone"<? } else { ?> class="input_req <?=$idFone?>" <? } ?> type="text" size="15" maxlength="15" <?php echo $endereco_readonly; ?> >
                <?
                    }
                ?>
            </td>
            <?php if(in_array($login_fabrica, array(152)) and !empty($callcenter)){
                $estado_adicional = "";

                $sqlPais = "SELECT array_campos_adicionais FROM tbl_hd_chamado_extra WHERE hd_chamado = {$callcenter}";
                $resPais = pg_query($con,$sqlPais);

                if(pg_num_rows($resPais) > 0){
                    $array_pais = pg_fetch_result($resPais, 0, "array_campos_adicionais");
                    if (!empty($array_pais)) {
                    $array_pais = json_decode($array_pais);

                    if (isset($array_pais->pais)) {
                    $array_pais = utf8_decode($array_pais->pais);

                    if($array_pais != "" && $array_pais != "Brazil"){
                        $estado_adicional = "EX";
            ?>
                <td align='left'><strong>País:</strong></td>
                <td align='left'>
                    <input type="hidden" name="consumidor_pais_anterior" value="<?php echo $consumidor_pais; ?>" />
                    <labe><?php echo $array_pais; ?></labe></td>
                </td>
            <?php }
                }
                }
                }
            } ?>
            <?php if (!in_array($login_fabrica, array(169,170))){ ?>
            <td align='left'>
                <?= (in_array($login_fabrica, [198])) ? "<label class='asteristico'>*</label>" : ""; ?> 
                <strong>CEP:</strong></td>
            <td align='left'>
                <input type="hidden" name="consumidor_cep_anterior" value="<?php echo $consumidor_cep; ?>" />
                <input
                    name="consumidor_cep"
                    id="consumidor_cep"
                    value="<? echo $consumidor_cep ;?>"
                    class="input_req addressZip"
                    type="text"
                    size="14"
                    maxlength="9"
                    onchange="atualizaQuadroMapas();"
                    onkeypress="return txtBoxFormat(this.form, this.name, '99999-999', event);"
                    <?php echo $endereco_readonly; ?>
                    data-before-ajax-zip="beforeAjaxZip"
                    data-after-ajax-zip="afterAjaxZip"
                    data-fail-ajax-zip="failAjaxZip"
                />
                <script>
                    document.beforeAjaxZip = function(e) {
                        return new Promise(function(resolve, reject) {
                            var cep = $(".addressZip").val().replace(/\D/, '');

                            if (cep.length != 8) {
                                reject(false);
                                return false;
                            }

                            $("#btn_mapa").prop({ disabled: true });
                            Shadowbox.open({
                                content: "",
                                player: "html",
                                height: 50,
                                width: 230,
                                options: {
                                    modal: true,
                                    enableKeys: false,
                                    displayNav: false
                                }
                            });
                            resolve(true);
                        });
                    }

                    document.afterAjaxZip = function(e) {
                        $("#btn_mapa").prop({ disabled: false });
                        Shadowbox.close();

                        <?php if (in_array($login_fabrica,[161])) { /*HD - 6201206  || HD - 7637693*/ ?>
                            if ($("input[name=consumidor_cep]").length > 0) {
                                $("#consumidor_pais").val("BR");
                                <?php if (in_array($login_fabrica, [161])) { ?>
                                    verificarConsumidorPais();
                                <?php }  ?>
                            }
                        <?php } ?>
                    }

                    document.failAjaxZip = function(e) {
                        $("#btn_mapa").prop({ disabled: false });
                        Shadowbox.close();
                    }

                    document.afterLoadCities = function() {
                        $("#mapa_cidade").val($("#consumidor_cidade").val());
                        $("#mapa_estado").val($("#consumidor_estado").val());
                    }
                </script>
            </td>
            <?php } ?>
        </tr>

        <?php if (in_array($login_fabrica, array(169,170))){ ?>
        <tr>
            <td align='left' style="width: 160px;"><strong>Telefone Comercial:</strong></td>
            <td align='left' >
                <input type="hidden" name="consumidor_fone2_anterior" value="<?php echo $consumidor_fone2; ?>" />
                <input name="consumidor_fone2" id="telefone2" value='<?php echo $consumidor_fone2 ;?>'  class="input telefone"  type="text" size="15" maxlength="15" >
                <? if($integracaoTelefonia === true) {
                    if(!empty($callcenter) && ($login_sac_telecontrol === true)) { ?>
                        <img style="cursor: pointer; margin-bottom: -4px;" onclick='fnc_discar(document.getElementById("telefone2").value)' title="Discar Telefone" src="imagens/telefone_002.png" width="15" height="15" id='icone_telefone' />
                <? }} ?>
            </td>

            <td align='left' class='td_midea_carrier' >
                <strong><?=(in_array($login_fabrica, array(169,170))) ? '<label class="asteristico">*</label>' : '';?>Telefone Celular:</strong>
            </td>
            <td align='left' >
                <input type="hidden" name="consumidor_fone3_anterior" value="<?php echo $consumidor_fone3; ?>" />
                <input name="consumidor_fone3" id="telefone3" value='<?php echo $consumidor_fone3 ;?>'  class="input telefone"  type="text" size="15" maxlength="15" >
                <? if($integracaoTelefonia === true) {
                    if(!empty($callcenter) && ($login_sac_telecontrol === true)) { ?>
                        <img style="cursor: pointer; margin-bottom: -4px;" onclick='fnc_discar(document.getElementById("telefone3").value)' title="Discar Telefone" src="imagens/telefone_002.png" width="15" height="15" id='icone_telefone' />
                <? }} ?>
            </td>
            <td align='left'><strong>CEP:</strong></td>
            <td align='left'>
                <input type="hidden" name="consumidor_cep_anterior" value="<?php echo $consumidor_cep; ?>" />
                <input
                    name="consumidor_cep"
                    id="consumidor_cep"
                    value="<? echo $consumidor_cep ;?>"
                    class="input_req addressZip"
                    type="text"
                    size="14"
                    maxlength="9"
                    onchange="atualizaQuadroMapas();"
                    onkeypress="return txtBoxFormat(this.form, this.name, '99999-999', event);"
                    <?php echo $endereco_readonly; ?>
                    data-before-ajax-zip="beforeAjaxZip"
                    data-after-ajax-zip="afterAjaxZip"
                    data-fail-ajax-zip="failAjaxZip"
                />
                <script>
                    document.beforeAjaxZip = function(e) {
                        return new Promise(function(resolve, reject) {
                            var cep = $(".addressZip").val().replace(/\D/, '');

                            if (cep.length != 8) {
                                reject(false);
                                return false;
                            }

                            $("#btn_mapa").prop({ disabled: true });
                            Shadowbox.open({
                                content: "",
                                player: "html",
                                height: 50,
                                width: 230,
                                options: {
                                    modal: true,
                                    enableKeys: false,
                                    displayNav: false
                                }
                            });
                            resolve(true);
                        });
                    }

                    document.afterAjaxZip = function(e) {
                        $("#btn_mapa").prop({ disabled: false });
                        Shadowbox.close();
                    }

                    document.failAjaxZip = function(e) {
                        $("#btn_mapa").prop({ disabled: false });
                        Shadowbox.close();
                    }

                    document.afterLoadCities = function() {
                        $("#mapa_cidade").val($("#consumidor_cidade").val());
                        $("#mapa_estado").val($("#consumidor_estado").val());
                    }
                </script>
            </td>
        </tr>
        <?php } ?>
		<tr>
			<td align='left'><strong><?=$campos_obrig;?><?=(in_array($login_fabrica, array(169,170))) ? '<label class="asteristico">*</label>' : '';?>Endereço:<?=$fx_cmp_obg;?></strong></td>
			<td align='left'>
				<input type="hidden" name="consumidor_endereco_anterior" value="<?php echo $consumidor_endereco; ?>" />
				<input name="consumidor_endereco" id='consumidor_endereco' value='<? echo $consumidor_endereco ;?>' placeholder='Ex: Rua Carlos Eduardo de Almeida' class="input_req address" type="text" size="40" maxlength="70" <?php echo $endereco_readonly; ?> >
			</td>
			<td align='left' class='td_midea_carrier'><strong><?=$campos_obrig;?><?=(in_array($login_fabrica, array(169,170))) ? '<label class="asteristico">*</label>' : '';?>Número:<?=$fx_cmp_obg;?></strong></td>
			<td align='left'>
				<input type="hidden" name="consumidor_numero_anterior" value="<?php echo $consumidor_numero; ?>" />
				<input name="consumidor_numero" id='consumidor_numero' value='<? echo $consumidor_numero ;?>' class="input_req" type="text" size="15" maxlength="15" <?php echo $endereco_readonly; ?> >
			</td>
			<td align='left'><strong>Complem.</strong></td>
			<td align='left'>
				<input type="hidden" name="consumidor_complemento_anterior" value="<?php echo $consumidor_complemento; ?>" />
				<input name="consumidor_complemento" id='consumidor_complemento' value='<? echo $consumidor_complemento ;?>' class="input_req" type="text" size="15" maxlength="30" <?php echo $endereco_readonly; ?> >
			</td>
		</tr>
		<?php if (in_array($login_fabrica, array(52,183))) { ?>
			<tr>
				<td align="left"><strong>Ponto de Referência</strong></td>
				<td align="left">
					<input type="hidden" name="ponto_referencia_anterior" value="<?=$ponto_referencia?>" >
					<input type="text" name="ponto_referencia" id="ponto_referencia" class="input_req" value="<?=$ponto_referencia?>" size="40" maxleght="255" >
				</td>
			</tr>
		<?php } ?>
		<tr>
			<td align='left'><strong><?=$campos_obrig;?><?=(in_array($login_fabrica, array(169,170))) ? '<label class="asteristico">*</label>' : '';?>Bairro:<?=$fx_cmp_obg;?></strong></td>
			<td align='left'>
				<input type="hidden" name="consumidor_bairro_anterior" value="<?php echo $consumidor_bairro; ?>" />
				<input name="consumidor_bairro" id='consumidor_bairro' value="<? echo $consumidor_bairro ;?>" <?if ($login_fabrica <> 24) { ?>class="input_req addressDistrict" <? }?>type="text" class="input_req addressDistrict" size="40" maxlength="50" <?php echo $endereco_readonly; ?> >
			</td>
            <?php if (in_array($login_fabrica, [52,161])) { /*HD - 4304128*/
                if (strlen($callcenter) > 0) {
                    $aux_sql = "SELECT array_campos_adicionais FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter LIMIT 1";
                    $aux_res = pg_query($con, $aux_sql);
                    $aux_arr = json_decode(pg_fetch_result($aux_res, 0, 'array_campos_adicionais'), true);

                    if (!empty($aux_arr["pais"])) {
                        $consumidor_pais = $aux_arr["pais"];
                    }
                } ?>
                <td align='left'><strong>País:</strong></td>
                <td align='left'>
                    <select name="consumidor_pais" id="consumidor_pais">
                        <option value="">Selecione</option>
                        <?php
                            $aux_sql = "SELECT pais, nome FROM tbl_pais ORDER BY nome";
                            $aux_res = pg_query($con, $aux_sql);
                            $aux_row = pg_num_rows($aux_res);

                            for ($wz=0; $wz < $aux_row; $wz++) {
                                $aux_pais = pg_fetch_result($aux_res, $wz, 'pais');
                                $aux_nome = pg_fetch_result($aux_res, $wz, 'nome');

                                if (strlen($consumidor_pais) > 0) {
                                    if ($consumidor_pais == $aux_pais) {
                                        $selected = "selected";
                                    }
                                }
								if(empty($consumidor_pais) and $aux_pais =='BR' and empty($selected)) {
									$selected = "selected";
								}
                                ?> <option <?=$selected;?> value="<?=$aux_pais;?>"><?=$aux_nome;?></option> <?
                                unset($selected);
                            }
                        ?>
                    </select>
                </td>
            <?php } ?>
            <td align='left' class='td_midea_carrier'>
                <strong>
                    <?=$campos_obrig;?>
                    <?=(in_array($login_fabrica, array(169,170,198))) ? '<label class="asteristico">*</label>' : '';?>Estado:
                    <?=$fx_cmp_obg;?>
                </strong>
            </td>
            <td align='left'>
                <input type="hidden" name="consumidor_estado_anterior" value="<?php echo (!empty($consumidor_pais) and !empty($estado_exterior)) ? $estado_exterior : $consumidor_estado; ?>" />
                <? if (in_array($login_fabrica, array(30,50,158))) { ?>
                    <acronym title='Campo Obrigatório'>
                <? } ?>
                <select name="consumidor_estado" id='consumidor_estado' class='input addressState' >
                    <?php
                        $ArrayEstados = array('','AC','AL','AM','AP',
                                                'BA','CE','DF','ES',
                                                'GO','MA','MG','MS',
                                                'MT','PA','PB','PE',
                                                'PI','PR','RJ','RN',
                                                'RO','RR','RS','SC',
                                                'SE','SP','TO'
                                            );

                        if(in_array($login_fabrica, array(152))){
                            $ArrayEstados[] = $estado_adicional;
                        }

                        if ($login_fabrica == 52) {
                            if (empty($consumidor_pais)) {
                                $ArrayEstados = getListaDeEstadosDoPais('BR');
                            } else {
                                $ArrayEstados = getListaDeEstadosDoPais($consumidor_pais);
                            }
                        }

                        $countEstados = count($ArrayEstados);

                        if ($login_fabrica == 183){
                            $consumidor_estado = strtoupper($consumidor_estado);
                        }

                        if ($login_fabrica == 52) {
                            for ($i=0; $i<=$countEstados; $i++){
                                echo"<option value='".$ArrayEstados[$i]['sigla']."'";
                                if ($consumidor_estado == $ArrayEstados[$i]['sigla']) echo " selected";
                                echo ">".$ArrayEstados[$i]['descricao']."</option>\n";
                            }
                        } else {
                            for ($i=0; $i<=$countEstados; $i++){
                                echo"<option value='".$ArrayEstados[$i]."'";
                                if ($consumidor_estado == $ArrayEstados[$i]) echo " selected";
                                echo ">".$ArrayEstados[$i]."</option>\n";
                            }
                        }

                        $i=0;
                    ?>
                </select>
                <? if (in_array($login_fabrica, array(30,50,158))) { ?>
                    </acronym>
                <? } ?>
            </td>
            <td align='left'>
                <strong>
                    <?=$campos_obrig;?>
                    <?=(in_array($login_fabrica, array(169,170,198))) ? '<label class="asteristico">*</label>' : '';?>Cidade:
                    <?=$fx_cmp_obg;?>
                </strong>
            </td>
            <td align='left'>
                <input type="hidden" name="consumidor_cidade_anterior" value="<?php echo $consumidor_cidade; ?>" />
                <? if (in_array($login_fabrica, array(30,50,158))) { ?>
                <acronym title='Campo Obrigatório'>
                <? } ?>
                <select name="consumidor_cidade" <?if ($login_fabrica == 24) {?>class="input_req2 addressCity"<?} else {?> class="input_req addressCity" <?}?> id='consumidor_cidade' style="width:150px" >
                    <option value="" >Selecione</option>
                    <?php
                    if (strlen($consumidor_estado) > 0) {
                        $sql = "SELECT DISTINCT * FROM
                                    (
                                        SELECT UPPER(fn_retira_especiais(nome)) AS cidade FROM tbl_cidade WHERE UPPER(estado) = UPPER('".$consumidor_estado."')
                                    UNION (
                                        SELECT UPPER(fn_retira_especiais(cidade)) AS cidade FROM tbl_ibge WHERE UPPER(estado) = UPPER('".$consumidor_estado."')
                                    )
                                    ) AS cidade
                                    ORDER BY cidade ASC";
                        $res = pg_query($con, $sql);

                        if (pg_num_rows($res) > 0) {
                            while ($result = pg_fetch_object($res)) {
                                $selected  = (trim($result->cidade) == strtoupper(retira_acentos(retira_especiais($consumidor_cidade)))) ? "SELECTED" : "";
                                echo "<option value='{$result->cidade}' {$selected} >{$result->cidade} </option>";
                            }
                        }
                    }
                    ?>
                </select>
                <? if (in_array($login_fabrica, array(30,50,158))) { ?>
                    </acronym>
                <? } ?>
                <input name="cidade"  class="input_req" value='<? echo $cidade ;?>' type="hidden">
            </td>
        </tr>
        <?php
        if ($login_fabrica == 115 OR $login_fabrica == 116) {?>
            <tr>
            <td align='left'>
                <strong>Data de Retorno: </strong>
            </td>
            <td align='left'>
                <input type="hidden" name="data_retorno_antiga" value="<?=$data_de_retorno?>">
                <input name="data_de_retorno" id="data_de_retorno" class="input_req" rel="data" value="<?=$data_de_retorno?>" <? if($ck_data_de_retorno == "t") echo "readonly";?> />
            </td>
        </tr>
        <?php
        }
        ?>
        <tr>
            <?php if(!in_array($login_fabrica, array(3,24,85,186,189))) { // HD 48900 ?>
            <td align='left'>
                <strong>Melhor horário p/ contato: </strong>
            </td>
            <td>
                <input name="hora_ligacao" id='hora_ligacao' class="input_req" value='<?echo $hora_ligacao ;?>' type="text" maxlength='5' size='7'>
            </td>
            <? } ?>

            <?php if(in_array($login_fabrica, array(186))) {?>
            <td align='left'>
                <strong>Observação p/ contato: </strong>
            </td>
            <td>
                <input name="obs_para_contato" size='40' id='obs_para_contato' class="input_req" value='<?php echo $obs_para_contato ;?>' type="text">
            </td>
            <? } ?>
            <?php if(in_array($login_fabrica, array(24))) {?>
               <td align='left'><strong>Nome Contato:</strong></td>
               <td align='left'>
                    <input type="hidden" name="contato_nome_anterior" value="<?php echo $contato_nome; ?>" />
                    <input name="contato_nome" id="contato_nome" maxlength='50' size="40" value='<?php echo $contato_nome ;?>' class="input_req" type="text" size="35" onkeyup="somenteMaiusculaSemAcento(this);" />
               </td>
            <?php }
            if (!in_array($login_fabrica, array(169,170))) {
            ?>
                <td align='left'>
                    <strong>
                        <?
                        if ($login_fabrica == 158)
                            echo $campos_obrig;

                        if ($login_fabrica == 101)
                            echo "Origem do Contato:";
                        elseif ($login_fabrica == 186)
                            echo "Canal:";
                        elseif ($login_fabrica == 189)
                            echo "Depto. Gerador da RRC:";
                        elseif ($login_fabrica == 198)
                            echo "<label class='asteristico'>*</label> Origem:";
                        else
                            echo "Origem:";

                        if ($login_fabrica == 158)
                            echo $fx_cmp_obg;
                        ?>
                    </strong>
                </td>
                <td align='left'>
                    <?php
        if ($usaOrigemCadastro) {
        ?>
            <?php
            if (in_array($login_fabrica, array(174,176,191)))
            {
                if ($origem == '' || $origem == NULL || empty($origem))
                {
                    $origem = 'Telefone';
                    $valida_obrigatorio = 't';
                }
            }


            if($login_fabrica == 151 and !empty($origem)){
                $cond_origem = preg_match("/[a-zA-Z]/", $origem)  ? " descricao = '$origem' " : " hd_chamado_origem = $origem " ;
                $condAtivo = " AND (ativo IS TRUE OR $cond_origem) ";
            }else{
                $condAtivo = " AND ativo IS TRUE ";
            }

            if ($login_fabrica == 183){
                $orderBy = "ORDER BY descricao ASC";
            }

            $sqlOrigem = "
                SELECT hd_chamado_origem, descricao, valida_obrigatorio
                FROM tbl_hd_chamado_origem
                WHERE fabrica = $login_fabrica
                $condAtivo
                $orderBy
            ";
            $resOrigem = pg_query($con, $sqlOrigem);
       ?>

            <select name="origem" id="origem" class="input">
                <option value="" >Escolha</option>
                <?php

				if (pg_num_rows($resOrigem)) {
					while ($row = pg_fetch_object($resOrigem)) {
                        if (in_array($login_fabrica, array(178,183,193,194))){
                            if (empty($callcenter)){
                                $selected = ($row->descricao == "Telefone") ? "selected" : "";
                            }else{
                                $selected = ($origem == $row->hd_chamado_origem || $origem == $row->descricao) ? "selected" : "";
                            }
                        }else{
                            $selected = ($origem == $row->hd_chamado_origem || $origem == $row->descricao) ? "selected" : "";
                        }
                        if (in_array($login_fabrica, [174]) AND $callcenter == 0) {
                            $selected = "";
                        }
                        if($login_fabrica == 174 AND $origem == 51 and ($row->hd_chamado_origem != 51)  ){
                            $desativado_facebook = " disabled ";
                        }else{
                            $desativado_facebook = "";
                        }

                        if(in_array($login_fabrica, [177,184,200]) and $row->descricao == 'Telefone' and empty($origem)){
                            $selected = " selected ";
                        }
                        echo "<option valida_obrigatorio='{$row->valida_obrigatorio}' value='{$row->hd_chamado_origem}' {$selected} {$desativado_facebook} >{$row->descricao}</option>";
                    }
                }
                ?>
            </select>
        <?php
        } else {
                    // MLG Inverti o array, o 'value' do OPTION está na KEY do array,
                    // e o value da key é o que mostra em tela(innert text do OPTION)
                        if ($login_fabrica == 158) {
                            $origemOptions = array('Email' => 'Email' );
                        } else {
                            $origemOptions = array('Telefone' => ($login_fabrica == 171) ? '0800' : 'Telefone', 'Email' => 'Email' );
                        }

                        if($login_fabrica == 85){

                            if(strlen(trim($origem)) > 0){
                                if(mb_detect_encoding($origem,'UTF-8', true)){
                                    $origem = utf8_decode($origem);
                                }
                            }

                            $origemOptions["Integração"] = "Integração";

                        }

                    switch ($login_fabrica) {
                        case 2:
                            $origemOptions = array_merge($origemOptions,array(
                                '0800'      => 'Atendimento 0800',
                                '9166'      => 'Atendimento 9166',
                                'Outros'    => 'Outros'
                            ));
                            break;
                        case 15:
                            $origemOptions = array_merge($origemOptions,array(
                                'revenda'   => 'Revenda',
                                'reclame'   => 'Reclame Aqui',
                                'redes'     => 'Facebook',
                                'gov'       => 'Consumidor Gov.',
                                'globo'     => 'O Globo',
                                'fale'      => 'Fale Conosco'
                            ));
                            break;
                        case 30:
                            $origemOptions = array_merge($origemOptions,array(
                                'fale'      => 'Site Esmaltec'
                            ));
                            break;
                        case 59:
                            $origemOptions = array_merge($origemOptions,array(
                                'Chat'              => 'Chat',
                                'Facebook'          => 'Facebook',
                                'LASA'              => 'LASA',
                                'NAJ'               => 'NAJ',
                                'ReclameAqui'       => 'Reclame Aqui',
                                'Relacionamento'    => 'Relacionamento'
                            ));
                            break;
                            case 80: /*HD - 6164934*/
                            $origemOptions = array_merge($origemOptions,array(
                                'Chat'              => 'Chat',
                                'whatsApp'      => 'WhatsApp'
                            ));
                        case 88:
                            $origemOptions = array_merge($origemOptions,array(
                                'whatsApp'      => 'WhatsApp',
                                'facebook'      => 'Facebook',
                                'reclame_aqui'  => 'Reclame Aqui',
                                'procon'        => 'Procon',
                                'jec'           => 'JEC/Justiça Comum',
                                'auditoria'     => 'Auditoria'
                            ));
                            break;
                        case 101:
                            $origemOptions = array_merge($origemOptions,array(
                                'whatsApp'      => 'WhatsApp',
                                'facebook'      => 'Facebook',
                                'reclame_aqui'  => 'Reclame Aqui',
                                'procon'        => 'Procon',
                                'jec'           => 'JEC/Justiça Comum',
                                'ecommerce'     => 'E-Commerce'
                            ));
                            break;
                        case 124:
                            $origemOptions['faleconosco'] = 'Fale Conosco';
                            break;
                        case 136:
                            $origemOptions = array_merge($origemOptions,array(
                                'whatsApp' => 'WhatsApp',
                                'facebook' => 'Facebook',
                                'site'     => 'Site'
                            ));
                            break;
                        case 151:
                            $origemOptions = array_merge($origemOptions,array(
                                'reclame'       => 'Reclame Aqui',
                                'procon'        => 'Procon',
                                'redes'         => 'Redes Sociais',
                                'patrulha'      => 'Patrulha do Consumidor',
                                'faleconosco'   => 'Fale Conosco',
                                'midia'         => 'MÃ­dia'
                            ));
                            break;
                        case 156:
                            $origemOptions = array_merge($origemOptions,array(
                                'Chat'                     => 'Chat',
                                'Skype'                    => 'Skype',
                                'Email'                    => 'Email',
                                '0800'                     => '0800',
                                'Combinado com Consumidor' => 'Combinado com Consumidor',
                                'Revenda'                  => 'Revenda',
                                'Posto'                    => 'Posto',
                                'Software House'           => 'Software House'
                            ));
                            break;
                        case 162:
                            $origemOptions = array(
                                'Telefone'  => 'Telefone',
                                'Email'     => 'Email',
                                'Chat'      => "Chat",
                                'CIP'       => "CIP",
                                'Juizado'   => "Juizado",
                                'Procon'    => "Procon",
                                'Midias Sociais' => "Midias Sociais" //HD-3352176
                            );
                            break;
                        case 165:
                            $origemOptions = array(
                                'Telefone'     => 'Telefone',
                                'Email'        => 'Email',
                                'Chat'         => 'Chat',
                                'redessociais' => 'Redes Sociais',
                                'faleconosco'  => "Fale Conosco",
                            );
                            break;
                        case 167:
                        case 203:
                            $origemOptions = array(
                                'Telefone'     => 'Telefone',
                                'Email'        => 'Email',
                                'Chat' => 'Chat'
                            );
                            break;
                        case 171://hd-3624967 - fputti
                            $origemOptions = array_merge($origemOptions,array(
                                'facebook'   => 'Facebook',
                                'Falecom'    => "Falecom",
                                'presencial' => 'Presencial',
                                'reclame'    => 'Reclame Aqui',
                                'Telefone'   => 'Telefone'
                            ));
                            break;
                        case 174:
                            $origemOptions = array_merge($origemOptions,array(
                                'faleconosco'  => "Fale Conosco",
                            ));
                            break;
                    }

                    if ($login_fabrica == 158) {
                        $origem = 'Email';
                    }

                    if (in_array($login_fabrica, array(174,176,203)))
                    {
                        if ($origem == '' || $origem == NULL || empty($origem))
                        {
                            $origem = 'Telefone';
                            $valida_obrigatorio = 't';
                        }
                    }

                    if($login_fabrica != 88){
                        ksort($origemOptions, SORT_STRING);
                    }

                    echo array2select(
                        'origem', 'origem',
                        $origemOptions,
                        $origem,
                        'class="input"', 'Escolha', true
                    );
        }
        ?>
                </td>
            <?php
            }
            ?>
            <?php if (in_array($login_fabrica, array(189))) { ?>
                <td align='left'><strong> Registro Ref. a:</strong></td>
                <td align='left'>
                    <select name='hd_classificacao' id='hd_classificacao'  <?=$aux_read_only;?>>
                        <option value=''>Escolha</option><?php

                        if(!empty($callcenter) and !empty($hd_classificacao)) {
                            $cond_hdc = " or hd_classificacao = $hd_classificacao ";
                        }
                        $sqlClassificacao = "SELECT hd_classificacao, descricao FROM tbl_hd_classificacao WHERE fabrica = $login_fabrica AND (ativo IS TRUE $cond_hdc) ORDER BY descricao";
                        $resClassificacao = pg_query($con,$sqlClassificacao);
                        for ($i = 0; $i < pg_num_rows($resClassificacao); $i++) {

                            $hd_classificacao_aux = pg_fetch_result($resClassificacao,$i,'hd_classificacao');
                            $classificacao    = pg_fetch_result($resClassificacao,$i,'descricao');

                            echo " <option value='".$hd_classificacao_aux."' ".($hd_classificacao_aux == $hd_classificacao ? "selected='selected'" : '').">$classificacao</option>";

                        }?>

                    </select>
                </td>
                <td align='left'><strong> Especificação de Referência de Registro:</strong></td>
                <td align='left'>
                    <select name='hd_subclassificacao' id='hd_subclassificacao'  <?=$aux_read_only;?>>
                        <option value=''>Escolha</option><?php

                        if(!empty($callcenter) and !empty($hd_classificacao)) {
                            $cond_hdc = " AND tbl_hd_fluxo_atendimento.hd_classificacao = {$hd_classificacao}";
                        }
                        $sqlSub = "SELECT distinct tbl_hd_subclassificacao.hd_subclassificacao,
                                          tbl_hd_subclassificacao.descricao
                                     FROM tbl_hd_fluxo_atendimento
                                     JOIN tbl_hd_subclassificacao  ON tbl_hd_subclassificacao.hd_subclassificacao = tbl_hd_fluxo_atendimento.hd_subclassificacao
                                    WHERE tbl_hd_subclassificacao.fabrica = $login_fabrica
                                    AND tbl_hd_subclassificacao.hd_subclassificacao IS NOT NULL
                                    AND (tbl_hd_subclassificacao.ativa IS TRUE $cond_hdc)
                               ORDER BY tbl_hd_subclassificacao.descricao";
                        $resSub = pg_query($con, $sqlSub);
                        for ($i = 0; $i < pg_num_rows($resSub); $i++) {

                            $hd_subclassificacao_aux = pg_fetch_result($resSub,$i,'hd_subclassificacao');
                            $subclassificacao        = pg_fetch_result($resSub,$i,'descricao');

                            echo " <option value='".$hd_subclassificacao_aux."' ".($hd_subclassificacao_aux == $hd_subclassificacao ? "selected='selected'" : '').">$subclassificacao</option>";

                        }?>

                    </select>
                </td>
            <?php }?>


            <!-- -->
            <?php
                if ($login_fabrica == 174)
                {
                    echo "<input type='hidden' name='valida_obrigatorio' id='valida_obrigatorio' value='".$valida_obrigatorio."'/>";
                }
            ?>
            <!--HD36903-->
            <?php if (!in_array($login_fabrica, array(2,10,91))) ?>
            <td align='left' class="td_midea_carrier"><strong><?=$campos_obrig;?><?=(in_array($login_fabrica, array(169,170))) ? '<label class="asteristico">*</label>' : '';?><?php echo ($login_fabrica == 189)  ? "Identificação" : "Tipo";?>:<?=$fx_cmp_obg;?></strong></td>
            <td align='left'>
            <?php
                if ($login_fabrica == 158) {
                    $tipos_atendimento = array(
                        'C'=>'Consumidor',
                    );
                } else {
                    /*HD - 4382764*/
                    if ($login_fabrica == 174) {
                        $tipos_atendimento = array(
                            'C'=>'B2C',
                            'R'=>'B2B'
                        );
                    }else {
                        $tipos_atendimento = array(
                            'C'=>'Consumidor',
                            'R'=>'Revenda'
                        );
                    }
                }

                // Adiciona as customizaçÃµes...
                switch ($login_fabrica) {
                    case 86:
                        // HD 48900
                        $tipos_atendimento['T'] = 'Representante';
                        $tipos_atendimento['N'] = 'Consultor';
                        $tipos_atendimento['P'] = 'PA';
                    break;
                    case 50: case 101:
                        $tipos_atendimento['A'] = 'Posto Autorizado';
                    break;
                    case 156:
                        // Sobrescreve, pois não usa C/R
                        $tipos_atendimento = array(
                            'C' => 'Contrato',
                            'S' => 'Sem Contrato',
                            'G' => 'Garantia'
                        );
                    break;
                    case 157:
                        $tipos_atendimento['L'] = 'Loja';
                        $tipos_atendimento['A'] = 'Assistência Técnica';
                        $tipos_atendimento['T'] = 'Representante';
                    break;
                    case 178:
                        $tipos_atendimento['S'] = 'Construtora';
                    break;

                    case 189:
                        unset($tipos_atendimento['R'], $tipos_atendimento['C']);
                        $tipos_atendimento['R'] = 'Representante';
                        $tipos_atendimento['V'] = 'Viapol';
                        $tipos_atendimento['C'] = 'Clientes';
                        $tipos_atendimento['T'] = 'Transportadora';
                        break;
                    case 186:
                        unset($tipos_atendimento['R'], $tipos_atendimento['C']);
                        $tipos_atendimento['D'] = 'Distribuidor';
                        $tipos_atendimento['C'] = 'Consumidor';
                        $tipos_atendimento['M'] = 'Merc. Especializado';
                        //$tipos_atendimento['R'] = 'Revenda';
                    break;
                }

                if (in_array($login_fabrica , array(158, 176))) {
                    $consumidor_revenda = "C";
                }

                if (empty($_POST['consumidor_revenda']) && empty($callcenter) && in_array($login_fabrica,[141])) {
                    $consumidor_revenda = "R";
                }

                if (in_array($login_fabrica, [178,183,184,191,193,194,200,203]) AND empty($callcenter) AND empty($consumidor_revenda)){
                    $consumidor_revenda = "C";
                }

                if (in_array($login_fabrica, array(11, 81, 103, 114, 119, 122, 123, 125, 147, 160, 172, 174, 187, 188)) && !$telecontrol_distrib){
                    $funcao_ie = " onchange='fnc_tipo_atendimento(this)'";
                } elseif ($login_fabrica == 189) {
                    $funcao_ie = " onchange='fnc_tipo_atendimento(this, 1)'";
                }
                echo array2select(
                    'consumidor_revenda', 'consumidor_revenda',
                    $tipos_atendimento, $consumidor_revenda,
                    'class="input"' . $funcao_ie, 'Escolha', true
                );
                ?>
            </td>
            <? if (in_array($login_fabrica, array(169,170))){
                if ($abre_os == "t" && !empty($os)) {
                    $readonly_169 = "readonly";
                    $display_169 = "display:none;";
                }

            ?>
                <td align='left' width=50><strong>OS:</strong></td>

                <td align='left' width=150>
                <input name="os" id="os"  class="input"  size="15" <?=$readonly_169?> value='<?= ($_POST["os"]) ? $os : $sua_os ;?>' onblur="if ($(this).length > 0) { $('input[name=os][id!=os]').val($(this).val()); } else { $('input[name=os][id!=os]').val($(this).val('')); }" >
                <img class='lupa_os_consumidor' style="cursor: pointer; <?=$display_169?>" align="absmiddle" onclick='fnc_pesquisa_consumidor_callcenter(document.getElementById("os").value, "os", false, "os_consumidor")' title="Buscar" src="imagens/lupa.png"  />
                </td>
            <? } ?>

            <?php if ($login_fabrica == 178 AND !empty($callcenter)){?>
                <td align='left' width=50><strong>OS:</strong></td>
                <td align='left' width=150>
                    <input name="id_os_revenda" id="id_os_revenda" type="text" class="input"  size="15" value="<?=$id_os_revenda?>" >
                    <input name="os_revenda_anterior" type="hidden" id="os_revenda_anterior"  class="input"  size="15" value="<?=$os_revenda_anterior?>" >
                </td>
            <?php } ?>
        </tr>
        <?php if(in_array($login_fabrica, [189])) {?>
            <tr>
                <td><b>Mercado Gerencia</b></td>
                <td>
                    <select name="mercado_gerencia" id='mercado_gerencia' class="frm">
                        <option value="">Selecione</option>
                        <?php
                            $sqlMercado = "SELECT * FROM tbl_mercado_gerencia WHERE fabrica = {$login_fabrica} ORDER BY descricao";
                            $resMercado = pg_query($con, $sqlMercado);
                            foreach (pg_fetch_all($resMercado) as $key => $value) {

                        ?>
                        <option value="<?php echo $value["mercado_gerencia"];?>" <?php if($mercado_gerencia == $value["mercado_gerencia"]) echo " SELECTED " ?>><?php echo $value["descricao"];?></option>
                        <?php } ?>
                    </select>
                </td>
                <td><b>Planta</b></td>
                <td>
                    <select name="planta" id='planta' class="frm">
                        <option value="">Selecione</option>
                        <option value="SP" <?php if($planta == "SP") echo " SELECTED " ?>>SP</option>
                        <option value="BA" <?php if($planta == "BA") echo " SELECTED " ?>>BA</option>
                        <option value="PE" <?php if($planta == "PE") echo " SELECTED " ?>>PE</option>
                    </select>
                </td>
            </tr>
        <?php } ?>
        <?php if(in_array($login_fabrica, [42, 101])):?>
            <tr>
                <td></td>
                <td></td>
                <td><b><?=($login_fabrica == 42) ? "Referência do Atendimento": "Tipo de Contato:" ?></b></td>
                <td>
                    <select name="consumidor_tipo_contato" id='consumidor_tipo_contato' class="frm">
                        <option value="">Selecione</option>
                        <option value="Ativo" <?php if($tipo_registro == "Ativo") echo " SELECTED " ?>>Ativo</option>
                        <option value="Receptivo"  <?php if($tipo_registro == "Receptivo") echo " SELECTED " ?>>Receptivo</option>
                    </select>
                </td>
                <?php if($login_fabrica == 101){ ?>
                <td><b>Motivo do Contato:</b></td>
                <td>
                    <select name="motivo_contato" id='motivo_contato' class="frm">
                        <option value="">Selecione</option>
                        <option value="1" <?php if($motivo_contato == "1") echo " SELECTED " ?>>1 - Reclamação sobre o Produto</option>
                        <option value="2" <?php if($motivo_contato == "2") echo " SELECTED " ?>>2 - Reclamação sobre a Empresa</option>
                        <option value="3" <?php if($motivo_contato == "3") echo " SELECTED " ?>>3 - Reclamação sobre a Assitência Técnica</option>
                        <option value="4" <?php if($motivo_contato == "4") echo " SELECTED " ?>>4 - Onde Comprar</option>
                        <option value="5" <?php if($motivo_contato == "5") echo " SELECTED " ?>>5 - Orientação sobre o Produto</option>
                        <option value="6" <?php if($motivo_contato == "6") echo " SELECTED " ?>>6 - Indicação de Posto Autorizado</option>
                        <option value="7" <?php if($motivo_contato == "7") echo " SELECTED " ?>>7 - Sugestão</option>
                        <option value="8" <?php if($motivo_contato == "8") echo " SELECTED " ?>>8 - Elogio</option>
                        <?php if($login_fabrica == 101){ ?>
                            <option value="9" <?php if($motivo_contato == "9") echo " SELECTED " ?>> 9 - Produto/Acessório Não Entregue</option>
                            <?php } ?>
                    </select>
                </td>
                <?php } ?>
            </tr>
        <?php endif?>
        <? if($login_fabrica == 86) { ?>
            <tr class='hd_motivo_ligacao'>
                <td colspan='4'>&nbsp;</td>
                <td align='left'><strong>Motivo:</strong></td>
                <td align='left'>
                    <select name='hd_motivo_ligacao' id='hd_motivo_ligacao'></select>
                </td>
            </tr>
            <? } ?>
        <? if(in_array($login_fabrica,array(74,50))) {
                if($login_fabrica == 50){
                    $titulo_campo = "Tipo de Atendimento:";
                    $color_texto = "style='color: #ae0000; ' ";
                }else{
                    $titulo_campo = "Classe do atendimento:";
                }
            ?>
            <tr>
                <td align='left'<?=$color_texto?>><strong><?=$titulo_campo?></strong></td>
                <td align='left'>
                    <select name='hd_motivo_ligacao' id='hd_motivo_ligacao'>
                        <option value=''>Escolha</option><?php
                        $sqlLigacao = "SELECT hd_motivo_ligacao, descricao FROM tbl_hd_motivo_ligacao WHERE fabrica = $login_fabrica AND ativo IS TRUE $disabled; ";

                        $resLigacao = pg_query($con,$sqlLigacao);
                            for ($i = 0; $i < pg_num_rows($resLigacao); $i++) {
                                $hd_motivo_ligacao_aux = pg_result($resLigacao,$i,'hd_motivo_ligacao');
                                $motivo_ligacao    = pg_result($resLigacao,$i,'descricao');
                                echo " <option value='".$hd_motivo_ligacao_aux."' ".($hd_motivo_ligacao_aux == $hd_motivo_ligacao ? "selected='selected'" : '').">$motivo_ligacao</option>";

                            }?>

                    </select>
                </td>
            </tr>
            <? } ?>

        <? if(($moduloProvidencia && !in_array($login_fabrica, array(169,170,189))) || $classificacaoHD) {

                /*HD - 6165391*/
                if ($login_fabrica == 52 && strlen($callcenter) > 0) {

                    if ($privilegios != "*" && $login_callcenter_supervisor != 't' && !empty($hd_classificacao)) {
                        $aux_read_only = " style='background: #eee; pointer-events: none; touch-action: none;' ";
                    }
                }
        ?>
            <tr>
                <td align='left'>
                    <?= (in_array($login_fabrica, [198])) ? "<label class='asteristico'>*</label>" : ""; ?> 
                    <strong>Classificação do atendimento:</strong></td>
                <td align='left'>
		        <?=($login_fabrica == 178)? "<span style='color: #c73e10; font-weight: bold; margin-left: -8px;'>*</span>": "" ?>
                    <select name='hd_classificacao' id='hd_classificacao'  <?=$aux_read_only;?> <?php echo ($login_fabrica == 30) ? 'onChange="logomarca_select()"' : '' ?>>
                        <option value=''>Escolha</option><?php

                        if(!empty($callcenter) and !empty($hd_classificacao)) {
                            $cond_hdc = " or hd_classificacao = $hd_classificacao ";
                        }
                        $sqlClassificacao = "SELECT * FROM tbl_hd_classificacao WHERE fabrica = $login_fabrica AND (ativo IS TRUE $cond_hdc) ORDER BY descricao";
                        $resClassificacao = pg_query($con,$sqlClassificacao);
                        for ($i = 0; $i < pg_num_rows($resClassificacao); $i++) {

                            $hd_classificacao_aux = pg_fetch_result($resClassificacao,$i,'hd_classificacao');
                            $classificacao    = pg_fetch_result($resClassificacao,$i,'descricao');
                            $abre_os_pre_os    = pg_fetch_result($resClassificacao,$i,'abre_os_pre_os');

                            echo " <option value='".$hd_classificacao_aux."' data-abre_os_pre_os='".$abre_os_pre_os."' ".($hd_classificacao_aux == $hd_classificacao ? "selected='selected'" : '').">$classificacao</option>";

                        }?>
					</select>
				</td>
                <?php

                if ($login_fabrica == 183){
                    $sql_hd_devolucao = "SELECT descricao AS descricao FROM tbl_hd_classificacao WHERE fabrica = {$login_fabrica} AND hd_classificacao = {$hd_classificacao}";
                    $res_hd_devolucao = pg_query($con, $sql_hd_devolucao);

                    if (pg_num_rows($res_hd_devolucao) > 0){
                        $descricao_devolucao = pg_fetch_result($res_hd_devolucao, 0, "descricao");
                        $descricao_devolucao = retira_acentos($descricao_devolucao);
                        $descricao_devolucao = strtolower($descricao_devolucao);

                    }

                    if ($descricao_devolucao == "devolucao"){
                        $display_devolucao = "display:block;";
                    }else{
                        $display_devolucao = "display:none;";
                    }

                    if ($descricao_devolucao == "reclamacao - moveis"){
                        $style_pedido_sap = "display:block;";
                    }else{
                        $style_pedido_sap = "display:none;";
                    }
                    extract($array_campos_adicionais);
                ?>
                    <td>
                        <strong>número Zendesk:</strong>
                    </td>
                    <td>
                        <input type="text" readonly name="id_zendesk" class="input" id="id_zendesk" value="<?=$id_zendesk?>">
                    </td>

                    <td class="pedido_sap" style="<?=$style_pedido_sap?>">
                        <strong>Pedido SAP:</strong>
                    </td>
                    <td class="pedido_sap" style="<?=$style_pedido_sap?>">
                        <input type="text" name="pedido_sap" class="input" id="pedido_sap" value="<?=$pedido_sap?>">
                    </td>
                <?php
                }

                if (in_array($login_fabrica, [184,200])) { ?>
                    <td>
                        <strong>Pedido de Venda:</strong>
                    </td>
                    <td>
                        <input name="pedido_venda" id="pedido_venda"  class="input"  size="13" value="<?= $pedido_venda ?>" />
                    </td>
                    <td>
                        <strong>NF de Venda:</strong>
                    </td>
                    <td>
                        <input name="nf_venda" id="nf_venda"  class="input"  size="13" value="<?= $nf_venda ?>" />
                    </td>
                <?php
                }
                ?>
                <?php
                if (in_array($login_fabrica, [186])) { ?>
                    <td>
                        <strong>Assunto:</strong>
                    </td>
                    <td>
                        <input name="assunto_fale_conosco" id="assunto_fale_conosco"  class="input"  size="35" value="<?= $assunto_fale_conosco ?>" />
                    </td>

                <?php
                }
                ?>

                <?php if($login_fabrica == 42){ ?>
                <td colspan="4"></td>

                <td align='left' width=50><strong>OS:</strong></td>

                <td align='left' width=150>
                <input name="os" id="os"  class="input"  size="13" value='<?= ($_POST["os"]) ? $os : $sua_os ;?>' onblur="if ($(this).length > 0) { $('input[name=os][id!=os]').val($(this).val()); } else { $('input[name=os][id!=os]').val($(this).val('')); }" >
               <!--  <img class='lupa_os_consumidor' style="cursor: pointer; <?=$display_169?>" align="absmiddle" onclick='fnc_pesquisa_consumidor_callcenter(document.getElementById("os").value, "os", false, "os_consumidor")' title="Buscar" src="imagens/lupa.png"  /> -->
                </td>


                <?php
                }
                $display_obs_sac = "style='display: none;'";

                if($login_fabrica == 30){

                    if($hd_classificacao == 47){
                        $display_backoffice_cb = "style='display: run-in;'";
                    }else{
                        $display_backoffice_cb = "style='display: none;'";
                    }

                    if (in_array($hd_classificacao, array(44,45))) {
                        $display_obs_sac = "style='display: run-in;'";
                    }
                } else {
                    $display_backoffice_cb = "style='display: none;'";
                }
                if (in_array($login_fabrica, array(162,164))) {
                    $display_backoffice_cb = "style='display: none;'";
                }

                ?>

                <td class="backoffice_cb" <?php echo $display_backoffice_cb; ?> >
                    <strong>OS Revenda:</strong>
                </td>
                <td class="backoffice_cb" <?php echo $display_backoffice_cb; ?> >
			<?php
			if($login_fabrica == 30){
			?>
                    	<input type="text" name="os_revenda" id="os_revenda" class="input_req" maxlength="30" value="<?php echo $os_revenda; ?>" />
			<?php
			}
			?>
                </td>

                <?php
                if (in_array($login_fabrica, array(166,174,186))) {
                ?>
                    <td>
                        <strong>Referência do atendimento:</strong>
                    </td>
                    <td>
                        <?php
                        if (strlen($tipo_venda) == 0 and !empty($callcenter)) {

                            $query_tipo_venda = "SELECT
                                                    tbl_hd_chamado_extra.tipo_venda
                                                FROM tbl_hd_chamado_extra
                                                JOIN tbl_hd_chamado ON tbl_hd_chamado.hd_chamado = tbl_hd_chamado_extra.hd_chamado
                                                WHERE tbl_hd_chamado.hd_chamado = {$callcenter}
                                                AND tbl_hd_chamado.fabrica = {$login_fabrica}";
                            $res_tipo_venda = pg_query($con, $query_tipo_venda);
                            $tipo_venda = pg_fetch_result($res_tipo_venda, 0, 'tipo_venda');
                        }
                        ?>
                        <input type="radio" name="tipo_venda" id="tipo_venda_pre" class="input_req" value="PRE" <?= $tipo_venda == 'PRE' ? 'checked' : '' ?>>Pré-Venda
                        <input type="radio" name="tipo_venda" id="tipo_venda_pos" class="input_req" value="POS" <?= $tipo_venda == 'POS' ? 'checked' : '' ?>>Pós-Venda
                    </td>
                <?php } ?>
            </tr>
<?
            }
?>

        <?php if ( in_array( $login_fabrica, $fab_usa_tipo_cons) ) : //HD 317864 ?>
            <tr>
                <td colspan="2">
                    <fieldset style="width:230px; text-align:left;">
                        <legend style="font-weight:bold;">Tipo de Consumidor</legend>
                        <?php

                            if (!isset($_POST['tipo_consumidor']) && !empty($callcenter) ) {

                                $sql = "SELECT tipo_consumidor FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter ";
                                $res = pg_query($con,$sql);
                                if(pg_num_rows($res)) {
                                    $checked = pg_result ($res,0,0);
                                    $CA = $checked == 'CA' ? 'checked' : '';
                                    $CF = $checked == 'CF' ? 'checked' : '';
                                }
                            }
                        ?>
                        <input type="radio" name="tipo_consumidor" <?=$CF?> value="CF" id="CF" <? echo $_POST['tipo_consumidor'] == 'CF' ? 'checked' : ''; ?> /><label for="CF">&nbsp;Consumidor Final</label>&nbsp;&nbsp;
                        <input type="radio" name="tipo_consumidor" <?=$CA?> value="CA" id="CA"  <? echo $_POST['tipo_consumidor'] == 'CA' ? 'checked' : ''; ?> /><label for="CA">&nbsp;Cabeleireiro</label>
                    </fieldset>
                </td>
            </tr>
        <?php endif; ?>

        <?php if($login_fabrica == 164){ ?>

            <?php

            $tentativas_contato = $array_campos_adicionais["tentativas_contato"];
            $genero             = $array_campos_adicionais["genero"];
            $faixa_etaria       = $array_campos_adicionais["faixa_etaria"];

            ?>

            <tr>
                <td><strong>Tentativas de Contato:</strong></td>
                <td>
                    <select name="tentativas_contato" class="input tentativas_contato">
                        <?php
                            for($h = 0; $h <= 10; $h++){
                                $selected = ($tentativas_contato == $h) ? "SELECTED" : "";
                                echo "<option value='{$h}' {$selected}> {$h} </option>";
                            }
                        ?>
                    </select>
                </td>
                <td><strong>Gênero:</strong></td>
                <td>
                    <select name="genero" class="input genero">
                        <option value="">Selecione</option>
                        <option value="M" <?php echo ($genero == "M") ? "SELECTED" : ""; ?> >Masculino</option>
                        <option value="F" <?php echo ($genero == "F") ? "SELECTED" : ""; ?> >Feminino</option>
                    </select>
                </td>
                <td><strong>Faixa Etária (anos):</strong></td>
                <td>
                    <select name="faixa_etaria" class="input genero">
                        <option value="">Selecione</option>
                        <option value="1 a 18" <?php echo ($faixa_etaria == "1 a 18") ? "SELECTED" : ""; ?> >1 a 18</option>
                        <option value="19 a 25" <?php echo ($faixa_etaria == "19 a 25") ? "SELECTED" : ""; ?> >19 a 25</option>
                        <option value="26 a 35" <?php echo ($faixa_etaria == "26 a 35") ? "SELECTED" : ""; ?> >26 a 35</option>
                        <option value="Acima de 35" <?php echo ($faixa_etaria == "Acima de 35") ? "SELECTED" : ""; ?> >Acima de 35</option>
                    </select>
                </td>
            </tr>
        <?php } ?>

        <tr>
<?php

			if (!in_array($login_fabrica,array(3,85,169,170,184,191,193,195,198,200))) { // HD 48900
?>
            <td colspan='2' align='left'>
                <input type="checkbox" name="receber_informacoes" id="receber_informacoes" <?=($receber_informacoes=="t") ? "checked" : ""?> value='t'>
                <strong>
                <?=($login_fabrica == 101) ? "Aceita receber informações sobre nossos produtos/serviços ?" : "Aceita receber informações sobre nossos produtos?"?>
                </strong>
                <br>
                <?php if($login_fabrica == 101) {?>
                    <a  href="javascript:fnc_pesquisa_os (document.querySelector('#cpf'), 'os')">Clique para ver todos os protocolos/OSs cadastradas com o NOME e CPF deste consumidor</a>
                    <?php }else{ ?>
                    <a  href="javascript:fnc_pesquisa_os (document.querySelector('#cpf'), 'os')">Clique aqui para ver todas as OSs cadastradas com CPF deste consumidor</a>
                    <?php } ?>
<?php

				if ($callcenter != "" && ($telecontrol_distrib || in_array($login_fabrica,array(35,74,151,162,183)))) {
					$callcenter = preg_replace('/\D/','',$callcenter);
					$sqlCallcenter = "SELECT pedido from tbl_hd_chamado_extra where hd_chamado = $callcenter AND pedido is not null";

                    if($login_fabrica == 151){
                        $sqlCallcenter .= " UNION SELECT pedido FROM tbl_hd_chamado_item WHERE hd_chamado = $callcenter AND pedido IS NOT NULL";
                    }

                    $resCallcenter = pg_query($con,$sqlCallcenter);

                    $mostra_solicitar_pedido = true;

                    if ($login_fabrica == 183 AND !empty($os)){
                        $mostra_solicitar_pedido = false;
                    }
?>
                    </br>
<?php
                    if(pg_num_rows($resCallcenter) == 0){
                        if ($mostra_solicitar_pedido === true){
?>
                        <a href="#" onclick="criarPedido(<?=$callcenter?>)">Criar um pedido para o chamado <?php  echo $callcenter ?></a>
<?php
                        }
					}else{

                        if($login_fabrica == 151){
?>
                            <a href="#" onclick="criarPedido(<?=$callcenter?>)">Criar um pedido para o chamado <?php  echo $callcenter ?></a><br>
<?php
                        }

                        for($k = 0; $k < pg_num_rows($resCallcenter); $k++){

                            $pedCallcenter = pg_result($resCallcenter,$k,'pedido');

                            if(empty($pedCallcenter)) continue;

?>
                        <a  target="_BLANK" href="pedido_admin_consulta.php?pedido=<?php echo pg_result($resCallcenter,$k,pedido) ?>">Consultar pedido <?php  echo $pedCallcenter ?></a> 
                        <br>
<?php
                        }
                    }
                }

                ?>
            </td>
            <? }

            //HD 201434 - Retirado o Telefone 2 para Gama Italy, pois é o mesmo campo de Telefone comercial
            ?>
            <?php if (!in_array($login_fabrica, array(169,170))){ ?>
            <td align='left' colspan='1'><strong>Telefone Comercial:</strong></td>
            <td align='left' colspan='1'>
                <input type="hidden" name="consumidor_fone2_anterior" value="<?php echo $consumidor_fone2; ?>" />
                <?php $idFone = ($login_fabrica == 161) ? "telefone7" : "telefone2"; ?>
                <input name="consumidor_fone2" id="<?=$idFone?>" value='<?php echo $consumidor_fone2 ;?>'  class="input telefone"  type="text" size="15" maxlength="15" >
                <? if($integracaoTelefonia === true) {
                    if(!empty($callcenter) && ($login_sac_telecontrol === true)) { ?>
                        <img style="cursor: pointer; margin-bottom: -4px;" onclick='fnc_discar(document.getElementById("telefone2").value)' title="Discar Telefone" src="imagens/telefone_002.png" width="15" height="15" id='icone_telefone' />
                <? }} ?>
            </td>

            <td align='left' colspan='1'>
                    <strong>Telefone Celular:</strong>
                    <?php echo ($login_fabrica == 52) ? " <br /> <strong>Operadora / Celular</strong>" : ""; ?>
            </td>
            <td align='left' colspan='1'>
                <input type="hidden" name="consumidor_fone3_anterior" value="<?php echo $consumidor_fone3; ?>" />
                <?php $idFone = ($login_fabrica == 161) ? "telefone6" : "telefone3"; ?>
                <input name="consumidor_fone3" id="<?=$idFone?>" value='<?php echo $consumidor_fone3 ;?>'  class="input telefone"  type="text" size="15" maxlength="15" >
                <? if($integracaoTelefonia === true) {
                    if(!empty($callcenter) && ($login_sac_telecontrol === true)) { ?>
                        <img style="cursor: pointer; margin-bottom: -4px;" onclick='fnc_discar(document.getElementById("telefone3").value)' title="Discar Telefone" src="imagens/telefone_002.png" width="15" height="15" id='icone_telefone' />
                <? }} ?>


                <?php
                    if($login_fabrica == 52){
                        ?>
                        <br />
                        <input type="hidden" name="operadora_celular" value="<?=$operadora_celular?>" />
                        <input type="text" name="operadora_celular" id="operadora_celular" class="input_req" value="<?=$operadora_celular?>" size="15" maxleght="255"onkeyup="somenteMaiusculaSemAcento(this);" />
                        <?php
                    }
                ?>

            </td>
            <?php } ?>
            <?php if(in_array($login_fabrica, [42,189])){ ?>

            <td align='left' width=50><strong>Pedido:</strong></td>
            <td>
                <input type="text" name="pedido" id="pedido" value="<?=$pedido?>" size="13">
            </td>
            <?php } ?>

            <?php if(in_array($login_fabrica, [169,170])){ ?>

            <td align='left' width=50 style="display:none;" class="pedido_ecommerce"><strong>Pedido:</strong></td>
            <td style="display:none;" class="pedido_ecommerce">
                <input type="text" name="pedido_ecommerce" id="pedido_ecommerce" value="<?=(!empty($pedido_ecommerce)) ? $pedido_ecommerce : $array_campos_adicionais['pedido_ecommerce']?>" size="13">
            </td>
            <?php } ?>

            <?php if($login_fabrica == 74){ ?>
                <td>
                    <button name='envia_email_atlas' id='envia_email_atlas' style="display:none;">Enviar Email</button>
                </td>
            <?php } ?>

            <? if ((in_array($login_fabrica, array(11,15,24,30,50,81,114,138,155,166,172,183,190))) or $telecontrol_distrib) { // HD 14549, //HD 907550 +114-Cobimex
            ?>
            <td align='left' width=50><strong>OS:</strong></td>

            <td align='left' width=150>
            <input name="os" id="os"  class="input"  size="15" <?=$readonly_169?> value='<?= ($_POST["os"]) ? $os : $sua_os ;?>' onblur="if ($(this).length > 0) { $('input[name=os][id!=os]').val($(this).val()); } else { $('input[name=os][id!=os]').val($(this).val('')); }" >
            <img class='lupa_os_consumidor' style="cursor: pointer; <?=$display_169?>" align="absmiddle" onclick='fnc_pesquisa_consumidor_callcenter(document.getElementById("os").value, "os", false, "os_consumidor")' title="Buscar" src="imagens/lupa.png"  />

            </td>
            <? } ?>
            <?  if ($login_fabrica == 24 AND strlen($familia) > 0 AND strlen($callcenter) > 0) { // HD 98922?>
            <td align='right' colspan='1'><br /><a href="envio_email_callcenter.php?callcenter=<?=$callcenter?>&KeepThis=true&TB_iframe=true&height=500&width=700" class='thickbox' title='Enviar E-mail para consumidor'>Clique aqui para enviar E-mail para <?=$consumidor_email?></a>
            </td>
            <? } ?>
        </tr>
        <? if (in_array($login_fabrica, array(184,200))){
        ?>
            <tr>
                <td colspan="2">
                </td>
                <td align='left' width=50 colspan="1"><strong>OS:</strong></td>

                <td align='left' width=150 colspan="2">
                <input name="os" id="os"  class="input"  size="15" value='<?= ($_POST["os"]) ? $os : $sua_os ;?>' onblur="if ($(this).length > 0) { $('input[name=os][id!=os]').val($(this).val()); } else { $('input[name=os][id!=os]').val($(this).val('')); }" >
                <img class='lupa_os_consumidor' style="cursor: pointer;" align="absmiddle" onclick='fnc_pesquisa_consumidor_callcenter(document.getElementById("os").value, "os", false, "os_consumidor")' title="Buscar" src="imagens/lupa.png"  />
                </td>
            </tr>
        <? } ?>
        <?php
            if (in_array($login_fabrica, [189])) {
                 $display_rep = "display:none;";
                if (strlen($pedido) > 0) {
                    $sqlPedidoVia = "SELECT tbl_pedido.cliente_nome AS nome_representante,
                                            tbl_pedido.cliente_email AS email_representante,
                                            tbl_pedido.visita_obs AS dados_entrega,
                                            tbl_pedido.obs AS obs_pedido,
                                            tbl_transportadora.nome,
                                            tbl_transportadora.contato,
                                            tbl_transportadora.fone,
                                            tbl_transportadora.cidade,
                                            tbl_transportadora.estado
                                       FROM tbl_pedido
                                  LEFT JOIN tbl_transportadora ON tbl_transportadora.transportadora=tbl_pedido.transportadora
                                      WHERE tbl_pedido.pedido_cliente = '{$pedido}'
                                        AND tbl_pedido.fabrica = {$login_fabrica}";
                    $resPedidoVia = pg_query($con, $sqlPedidoVia);

                    if (pg_num_rows($resPedidoVia ) > 0) {
                        $xnome_transportadora = pg_fetch_result($resPedidoVia, 0, 'nome');
                        $xcontato_transportadora = pg_fetch_result($resPedidoVia, 0, 'contato');
                        $xfone_transportadora   = pg_fetch_result($resPedidoVia, 0, 'fone');
                        $xcidade_transportadora = pg_fetch_result($resPedidoVia, 0, 'cidade');
                        $xestado_transportadora = pg_fetch_result($resPedidoVia, 0, 'estado');
                        $xobs_pedido            = pg_fetch_result($resPedidoVia, 0, 'obs_pedido');
                        $xdados_entrega         = pg_fetch_result($resPedidoVia, 0, 'dados_entrega');
                        $nome_representante         = pg_fetch_result($resPedidoVia, 0, 'nome_representante');
                        $email_representante         = pg_fetch_result($resPedidoVia, 0, 'email_representante');
                        $display_rep = "";
                    }
                }

            ?>
            <tr id="mostra_representante" style="<?php echo $display_rep;?>">
                <td align='left'><strong>Nome do Representante:</strong></td>
                <td align='left'>
                    <input name="nome_representante" readonly id="nome_representante"  class="input"  size="35"  value='<?= $nome_representante ;?>' >
                </td>
                <td align='left'><strong>E-mail do Representante:</strong></td>
                <td align='left'>
                    <input name="email_representante" readonly id="email_representante"  class="input"  size="35"  value='<?= $email_representante ;?>' >
                </td>
            </tr>
            <?php if ($callcenter) {?>
            <tr>
                <td align='center' colspan="100%" style="padding-top: 40px;">
                    <button type="button" class="btn_custo_atendimento">Informar Custo de Atendimento</button>
                </td>
            </tr>
            <tr>
                <td align='center' id='carrega_custos_atendimentos' colspan="100%" style="padding-bottom: 40px;">

                </td>
            </tr>
            <?php }?>
        <?php }?>

<?php
        if (in_array($login_fabrica, array(35,151,164,186))) {
            if (is_numeric($callcenter) && strlen($callcenter) > 0 ) {
                if ($login_fabrica != 35) {
                    $sql_rel = "
                        SELECT  tbl_os.os,
                                tbl_os.sua_os,
                                tbl_os.consumidor_revenda
                        FROM    tbl_hd_chamado_item
                        JOIN    tbl_hd_chamado ON tbl_hd_chamado_item.hd_chamado = tbl_hd_chamado.hd_chamado
                        JOIN    tbl_os ON tbl_os.os = tbl_hd_chamado_item.os
                        WHERE   tbl_hd_chamado_item.hd_chamado = $callcenter AND tbl_hd_chamado_item.os is not null
                  ORDER BY      hd_chamado_item ";
                } else {
                    $sql_rel = "
                        SELECT  tbl_os.os,
                                tbl_os.sua_os,
                                tbl_os.consumidor_revenda
                        FROM    tbl_hd_chamado_extra
                        JOIN    tbl_hd_chamado          ON tbl_hd_chamado_extra.hd_chamado  = tbl_hd_chamado.hd_chamado
                        JOIN    tbl_os                  ON tbl_os.os                        = tbl_hd_chamado_extra.os
                        WHERE   tbl_hd_chamado_extra.hd_chamado = $callcenter
                        AND     tbl_hd_chamado_extra.os IS NOT NULL
                    ";
                }
                $res_rel  = pg_query($con, $sql_rel);
            }

            if ($_POST['os_relacionadas']) {
                $os_relacionadas = $_POST['os_relacionadas'];
            }
?>

        <tr>
            <td colspan="6"> <div style="border-top: 1px solid #ccc; width: 100%; margin-top: 8px; margin-bottom: 8px;"> </td>
        </tr>

        <tr>
            <td align='center' colspan="6">
                <?php if ($login_fabrica == 151) { /*HD - 6177097*/
                    $aux_style = ' style="float: left; padding-left: 12%;" ';

                    if (strlen($_POST["titular_nota_fiscal"]) > 0) {
                        $titular_nota_fiscal = $_POST["titular_nota_fiscal"];
                    }

                    if (strlen($_POST["titular_cpf"]) > 0) {
                        $titular_cpf = $_POST["titular_cpf"];
                    }

                    if (strlen($callcenter) > 0) {
                        if (strlen($array_campos_adicionais["cpf_titular_nf"]) > 0) {
                            $titular_cpf = $array_campos_adicionais["cpf_titular_nf"];
                        }

                        if (strlen($array_campos_adicionais["nome_titular_nf"]) > 0) { /* HD - 6232912*/
                            $titular_nota_fiscal = $array_campos_adicionais["nome_titular_nf"];
                        }
                    } ?>
                    <table style="float: left;">
                        <tr>
                            <td><strong>Titular da Nota Fiscal</strong></td>
                            <td>
                                <input name="titular_nota_fiscal" type="text" size='40' class="input" value="<?=$titular_nota_fiscal;?>">
                            </td>
                        </tr>
                        <tr>
                            <td><strong>CPF do Titular</strong></td>
                            <td>
                                <input name="titular_cpf" type="text" class="input" size="25" value="<?=$titular_cpf;?>">
                            </td>
                        </tr>
                    </table>
                <?php } ?>
                <b <?=$aux_style;?> class="titulo_relacionar_os">Relacionar OSs no atendimento:</b>
            </td>
        </tr>


        <tr>
            <td align='center' colspan="6">
                <table border="0" align='center'>
                    <tr>
                        <td align='right' width=50><strong>OS:</strong></td>
                        <td align='left' colspan="5">
                            <input name="os_relacionar" id="os_relaciona" class="input os_relaciona"  size="15">
                            <img class="btn-add-os" onclick="add_os_relaciona();" style="cursor: pointer;width:17px;vertical-align: top;" title="Adicionar" src="imagens/Plus.png"  />
                            <div id="mensagem_relaciona_os"></div>
                        </td>
                    </tr>
                </table>
                <table border="0" style="margin:0 auto;" cellspacing="1" cellpadding="1" align="center" width="300">
                    <tr bgcolor="#596d9b" style="color:#ffffff;">
                        <td align="center" style="padding-top: 4px !important; padding-bottom: 2px !important;">OS RELACIONADAS</td>
                        <td width="25%" align="center" style="padding-top: 4px !important; padding-bottom: 2px !important;">AÃÃES</td>
                    </tr>
<?php
            $disabledOs = '';

            if (empty($os_relacionadas)) {
                $key = 0;

                while ($os_relacionadas = pg_fetch_object($res_rel)) {
                    if (strlen($callcenter) > 0) {
                        $revenda_status = $os_relacionadas->consumidor_revenda;
                        if ($revenda_status == 'R') {
                            $os_relacionar = $os_relacionadas->sua_os;
                        } else {
                            $os_relacionar = $os_relacionadas->os;
                        }
                    }
?>
                    <tr bgcolor='#ffffff' id="os_rel_<?=$key?>">
                        <td align='center'>
                            <input name="os_relacionadas[]" id="os_relacionadas" type="hidden" value='<?=$os_relacionar?>'> <?=$os_relacionar?>
                        </td>
                        <td align='center' width=50>
<?php
                    if (strlen($callcenter) == 0 || in_array($login_fabrica,array(35,151,186))) {
?>
                            <img style='cursor: pointer;' onclick='remove_os_relaciona("<?=$key?>")' align='absmiddle' title='Remover' src='imagens/btn_delete.png' />
<?php
                    }
?>
                        </td>
                    </tr>
<?php
                    $key++;
                }
            }
?>


                    <tbody id="relaciona_os">
			<?php if (strlen($callcenter) == 0 && count($_POST["os_relacionadas"]) > 0) {?>
			<?php for ($i=0; $i < count($_POST["os_relacionadas"]); $i++) { ?>
			<tr bgcolor='#ffffff' id='os_rel_<?php echo $i;?>'>
			    <td align='center'>
				<input name='os_relacionadas[]' id='os_relacionadas' type='hidden' value='<?php echo $_POST["os_relacionadas"][$i];?>'  size='15'>
				<?php echo $_POST["os_relacionadas"][$i];?>
			    </td>
			    <td align='center'>
				<img style='cursor: pointer;' onclick='remove_os_relaciona(<?php echo $i;?>)' align='absmiddle' title='Remover' src='imagens/btn_delete.png' />
			    </td>
			</tr>
			<?php }?>
			<?php }?>
                    </tbody>
                </table><br />
                <input type="hidden" name="qtde_os_relacionar" id="qtde_os_relacionar"  value='1'>
            </td>
        </tr>
<?php
        }

        if ($login_fabrica == 30) { //HD-2902269
            $notaConsumidor = array( //HD-3194503
                '1' => '1',
                '2' => '2',
                '3' => '3',
                '4' => '4',
                '5' => '5',
                '6' => '6',
                '7' => '7',
                '8' => '8',
                '9' => '9',
                '10' => '10',
                'moderacao' => 'MODERAÃÃO',
                'desativado' => 'DESATIVADO'
            );
            if(in_array($hd_classificacao,array(37,46,50))){
                $display_block = "style='height: 50px; display: block table-row;'";
            } else {
                $display_block = "style='height: 50px; display: none;'";
            }

            if ($hd_classificacao == 61) {
                $display_block_reclame = "style='height: 50px; display: block table-row;'";
            } else {
                $display_block_reclame = "style='height: 50px; display: none;'";
            }

?>
            <tr id='campos_backofice' <?php echo $display_block; ?>>
                <td align='left'>
                    <label>nº da SR:</label>
                    <input type='text' id='numero_sr' name='numero_sr' value='<?=$numero_sr?>'>
                </td>
                <td align='left'>
                    <label>nº do Processo:</label>
                    <input type='text' id='numero_process' name='numero_process' value='<?=$numero_process?>'>
                </td>
                <td align='left'>
                    <label>Data Recebimento:</label>
                    <input type='text' id='data_recebimento' class='input' rel='data' name='data_recebimento' value='<?=$data_recebimento?>'>
                </td>
                <td align='left'>
                    <label>Data Fatal:</label>
                    <input type='text' id='data_fatal' name='data_fatal' class='input' rel='data' value='<?=$data_fatal?>'>
                </td>
                <td align='left' colspan='4'>
                    <label>Notificado:</label>
                    <input style='width: 300px;' type='text' id='info_notificado' name='info_notificado' value='<?=$info_notificado?>'>
                </td>
            </tr>
            <tr id='campos_reclameaqui' <?php echo $display_block_reclame; ?>>
                <td align='left'>

                    <label>Nota do Consumidor:</label>
                    <!--
                    <input type='text' id='nota_consumidor' name='nota_consumidor' value='<?=$nota_consumidor?>'>
                    -->

                    <!-- HD-3194503 -->
                    <select name='nota_consumidor' id='nota_consumidor' >
                        <option value='' selected>Selecione</option>
                            <?php
                                foreach ($notaConsumidor as $key => $value) {
                                    $selected_nota = ($_POST['nota_consumidor'] == $key || $nota_consumidor == $key) ? ' SELECTED ' : '' ;
                                ?>
                                    <option value='<?=$key?>'  <?php echo $selected_nota?> ><?=$value?></option>
                                <?
                                }
                            ?>
                    </select>
                    <!-- FIM HD-3194503 -->
                </td>
                <td align='left'>
                    <label>Id da Reclamação:</label>
                    <input type='text' id='id_reclamacao' name='id_reclamacao' class="input_req" value='<?=$id_reclamacao?>'>
                    <!-- HD-3194503 -->
                    <img style="cursor: pointer;" onclick='fnc_pesquisa_consumidor_callcenter(document.getElementById("id_reclamacao").value, "id_reclamacao")' title="Buscar" src="imagens/lupa.png"/></acronym>
                    <!-- FIM HD-3194503 -->
                </td>
            </tr>
        <?php } ?>
        <?php if ($login_fabrica == 156): ?>
        <tr>
            <td colspan="2"></td>
            <td align="left"><strong>nº Controle Cliente</strong></td>
            <td>
                <input type="text" class="input" pattern="[0-9]+" value="<?=$protocolo_cliente?>" name="protocolo_cliente" />
            </td>
            <td align="left"><strong>Prazo Limite:</strong></td>
            <td>
                <input id="prazo_limite" class="input_req datahora" type="text" name="data_providencia" pattern="<?=$dateRegEx?>"
                    value="<?=is_date($data_providencia, 'ISO', 'EUR')?>" size="16">
            </td>
        </tr>
        <tr>
            <td colspan="2"></td>
            <td align="left"><strong>Responsável</strong></td>
            <td>
                <input id="responsavel_nome" type="text" class="input" value="<?=$responsavel?>" name="responsavel_nome" />
            </td>
            <td align="left"><strong>Telefone Resp.:</strong></td>
            <td>
                <input id="responsavel_fone" class="input" type="text" name="responsavel_fone" value="<?=$tel_responsavel?>" size="16">
            </td>
        </tr>
        <?php endif; ?>

        <?php
        if ($login_fabrica == 24) {
        ?>
            <tr>
                <td colspan="2" >
                    <strong>Ligação Agendada:</strong>
                    &nbsp;
                    <input type="text" style="width: 90px;" name="ligacao_agendada" id="ligacao_agendada" value="<?=$ligacao_agendada?>" />
                </td>
            </tr>
        <?php
        }

        if(strlen($callcenter) > 0 && !in_array($login_fabrica, array(85,152))){
            $sql_campos_adicionais = "SELECT array_campos_adicionais FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter";
            $res_campos_adicionais = pg_query($con, $sql_campos_adicionais);

            if(pg_num_rows($res_campos_adicionais) > 0){

                $arr_campos_adicionais = pg_fetch_result($res_campos_adicionais, 0, "array_campos_adicionais");
                $arr_campos_adicionais = json_decode($arr_campos_adicionais, true);

                if(count($arr_campos_adicionais) > 0){
                    extract($arr_campos_adicionais);
                }
            }
        }

        if ($login_fabrica == 85) {
            if(strlen($callcenter) > 0){
                $sql_ambev = "SELECT array_campos_adicionais FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter";
                $res_ambev = pg_query($con, $sql_ambev);

                if(pg_num_rows($res_ambev) > 0){
                    $arr_ambev = pg_fetch_result($res_ambev, 0, "array_campos_adicionais");
                    $arr_ambev = json_decode($arr_ambev, true);
                    /*
                        Array // Exemplo
                        (
                            [atendimento_ambev] => t
                            [codigo_ambev] => teste
                            [data_fabricacao_ambev] => 26/02/2016
                            [data_previsao_ambev] => 11/12/2019
                            [data_encerramento_ambev] => 06/05/2016
                            [atendimento_ambev_nome] => teste
                            [garantia_estendida_ambev] => f
                            [consumidor_cpf_cnpj] => C
                            [voltagem] => 110 V
                        )
                    */
                    extract($arr_ambev);
                    $data_fabricacao_ambev = str_replace('\\','',$data_fabricacao_ambev);
                    $data_previsao_ambev   = str_replace('\\','',$data_previsao_ambev);
                }

            }
        ?>
            <tr id="nome_fantasia" style="display: <?=($consumidor_cpf_cnpj == "R") ? 'table-row' : 'none'?>;" >
                <td>
                    <strong>Nome Fantasia:</strong>
                    &nbsp;
                    <input type="text" name="nome_fantasia" value="<?=utf8_decode($nome_fantasia)?>" />
                </td>
            </tr>
            <tr>
                <td>&nbsp;</td>
            </tr>
            <tr>
                <td colspan='3'>
                    <strong>Atendimento AMBEV ?</strong>
                    &nbsp;
                    <input type="radio" id="atendimento_ambev_sim" name="atendimento_ambev" value="t" <?=($atendimento_ambev == "t") ? "CHECKED" : "" ?> <?=($atendimento_ambev != "t" && !empty($callcenter)) ? "disabled" : "" ?> />Sim
                    &nbsp;
                    <input type="radio" name="atendimento_ambev" value="f" <?=($atendimento_ambev == "f") ? "CHECKED" : "" ?> <?=($atendimento_ambev == "t" && !empty($callcenter)) ? "disabled" : "" ?> />Não
                    &nbsp;
                    &nbsp;
                    <!-- Retirado no hd-2504690 - Lucas -->
                    <!--<span id="garantia_estendida_ambev" style="display: <?=($atendimento_ambev == 't') ? 'block' : 'none' ?>;">
                        <strong>Possui Garantia Estendida?</strong>
                        &nbsp;
                        <input type="checkbox" name="garantia_estendida_ambev" value="t" <?=($garantia_estendida_ambev == "t") ? "CHECKED" : "" ?> />
                    </span>-->
                </td>
                <td colspan="2">
                    <strong>Atendimento GARANTIA CONTRATUAL ?</strong>
                    &nbsp;
                    <input id="contratual_sim" type="radio" name="atendimento_contratual" value="t" <?=($atendimento_contratual == "t") ? "CHECKED" : "" ?> <?=($atendimento_contratual != "t" && !empty($callcenter)) ? "disabled" : "" ?> />Sim
                    &nbsp;
                    <input id="contratual_nao" type="radio" name="atendimento_contratual" value="f" <?=($atendimento_contratual == "f") ? "CHECKED" : "" ?> <?=($atendimento_contratual == "t" && !empty($callcenter)) ? "disabled" : "" ?> />Não
                    &nbsp;
                    &nbsp;
                    <!-- Retirado no hd-2504690 - Lucas -->
                    <!--<span id="garantia_estendida_ambev" style="display: <?=($atendimento_ambev == 't') ? 'block' : 'none' ?>;">
                        <strong>Possui Garantia Estendida?</strong>
                        &nbsp;
                        <input type="checkbox" name="garantia_estendida_ambev" value="t" <?=($garantia_estendida_ambev == "t") ? "CHECKED" : "" ?> />
                    </span>-->
                </td>
            </tr>
            <tr id="informacoes_ambev">
                <td colspan="3">
                    <table border="0" >
                        <tr>
                            <td id="codigo_ambev" style="display: <?=($atendimento_ambev == 't') ? 'table-cell' : 'none' ?>;">
                                Código AMBEV<br />
                                <input type="text" name="codigo_ambev" value="<?=utf8_decode($codigo_ambev)?>" style="width: 100px;" />
                            </td>
                            <td>
                                Nome <br />
                                <input type="text" name="atendimento_ambev_nome" value="<?=utf8_decode($atendimento_ambev_nome)?>" style='width:150px;' />
                            </td>
                            <td>
                                Data de Fabricação<br />
                                <input type="text" name="data_fabricacao_ambev" value="<?=$data_fabricacao_ambev?>" style="width: 100px;" />
                            </td>
                            <?php if ($login_fabrica == 85) { ?>

                            <td>
                                Data de Previsão<br />
                                <input type="text" name="data_previsao_ambev" value="<?=$data_previsao_ambev?>" style="width: 100px;" />
                            </td>
                            <?php } ?>
                            <?php if ($login_fabrica == 85 && strlen($callcenter) > 0) { ?>
                                <td colspan="3">
                                    Data 1ê Visita<br/>
                                    <input type="text" class="data_primeira_visita" name="data_primeira_visita" value = "<?=$data_primeira_visita?>" style="width: 100px;" />
                                </td>
                            <?php } ?>
                            <td nowrap id="data_encerramento_ambev" style="display: <?=($atendimento_ambev == 't') ? 'table-cell' : 'none' ?>;">
                                Data de Encerramento<br />
                                <input type="text" name="data_encerramento_ambev" value="<?=$data_encerramento_ambev?>" style="width: 100px; " />
                            </td>
                        </tr>
                    </table>
                </td>
                <td>
                    <table border="0" class="cliente_contratual">
                        <td>
                            Código<br />
                            <input type="text" name="codigo_cliente_contratual" value="<?=utf8_decode($codigo_cliente_contratual)?>" style="width: 100px;" />
                            <img src='imagens/lupa.png' border='0' align='absmiddle' style='cursor:pointer' data-tipo="codigo" class="cliente_contratual_lupa" />
                        </td>
                        <input type="hidden" name="id_cliente_contratual" value="<?= $id_cliente_contratual ?>" id="id_cliente_contratual" />
                        <td>
                            Cliente <br />
                            <input type="text" name="nome_cliente_contratual" value="<?=utf8_decode($nome_cliente_contratual)?>" style='width:150px;' />
                            <img src='imagens/lupa.png' border='0' align='absmiddle' style='cursor:pointer' data-tipo="nome" class="cliente_contratual_lupa" />
                        </td>
                    </table>
                </td>
            </tr>
        <?php
        }

        if (in_array($login_fabrica, array(51))) {
            include 'pesquisa_satisfacao_new.php';
        }
        ?>

        </table>
    </div>
    <? if($moduloProvidencia and in_array($login_fabrica, array(169,170))) { ?>
    <div style="margin-top: 5px;" id='cassificacao_origem'>
        <table width='100%' border='0' align='center' cellpadding='2' cellspacing='2' style='border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left: 4px;' id='tabela_classificacao_origem'>

             
                    
            <tr>
                  <td align='left' width="197">
                    <strong><?=(in_array($login_fabrica, array(169,170))) ? '<label class="asteristico">*</label>' : '';?>Origem:</strong>
                </td>
                <td align='left' width="299">
                    <?php echo $origem;
                        if((strlen(trim($callcenter)) > 0 AND strlen(trim($origem)) > 0) OR strlen($Id) > 0){
                            $sql = "SELECT hd_chamado_origem, descricao
                                    FROM tbl_hd_chamado_origem
                                    WHERE fabrica = {$login_fabrica}
                                    AND descricao = '{$origem}'";
                            $res = pg_query($con, $sql);
                            $res_hd_origem = pg_fetch_all($res);
                            $not_in_origem = " AND tbl_hd_chamado_origem.hd_chamado_origem NOT IN (".$res_hd_origem[0]["hd_chamado_origem"].") ";
                            $cond_origem = " AND tbl_hd_chamado_origem.descricao = '$origem'";
                        }else{
                            /* RETIRANDO CHAT, EMAIL E FALE CONOSCO */
                            $not_in_origem = '';
                            $sql = "SELECT hd_chamado_origem
                                    FROM tbl_hd_chamado_origem
                                    WHERE fabrica = {$login_fabrica} AND lower(descricao) IN('chat', 'email', 'fale conosco')";
                            $res = pg_query($con, $sql);
                            if (pg_num_rows($res) > 0) {
                                for ($i = 0; $i < pg_num_rows($res); $i++) {
                                    $not_in_origem .= (!empty($not_in_origem)) ? ',' : '';
                                    $not_in_origem .= pg_fetch_result($res, $i, 'hd_chamado_origem');
                                }
                                $not_in_origem = " AND tbl_hd_chamado_origem.hd_chamado_origem NOT IN (".$not_in_origem.")";
                            }
                            $cond_ativo = " AND tbl_hd_chamado_origem.ativo IS TRUE ";
                        }
                        $sql = "SELECT tbl_hd_chamado_origem.hd_chamado_origem, tbl_hd_chamado_origem.descricao
                                    FROM tbl_hd_origem_admin
                                    JOIN tbl_hd_chamado_origem ON tbl_hd_chamado_origem.hd_chamado_origem = tbl_hd_origem_admin.hd_chamado_origem
                                        AND tbl_hd_chamado_origem.fabrica = {$login_fabrica}
                                    WHERE tbl_hd_origem_admin.fabrica = {$login_fabrica}
                                    AND tbl_hd_origem_admin.admin = {$login_admin}
                                    $cond_ativo
                                    $cond_origem
                                    $not_in_origem ";
                        $res = pg_query($con, $sql);

                        if(pg_num_rows(($res)) > 0){
                            $res_hd_chamado_origem = pg_fetch_all($res);
                        } else {
                            $res_hd_chamado_origem = array();
                        }
                    ?>
                            <select name="origem" id="origem" class='input'>
                            <option value="">Escolha</option>
                    <?php
                            if(count($res_hd_origem) > 0){
                                $res_hd_chamado_origem = array_merge($res_hd_origem, $res_hd_chamado_origem);
                            }else{
                                $res_hd_chamado_origem = $res_hd_chamado_origem;
                            }
                            foreach ($res_hd_chamado_origem as $key => $value) {
                                $selected_origem = ( isset($origem) and ($origem == $value['hd_chamado_origem'] OR $origem == $value['descricao']) ) ? "SELECTED" : '' ;
                                if(strlen(trim($callcenter)) == 0 AND empty($origem)){
                                    if($value['descricao'] == 'Telefone'){
                                        $selected_origem = "selected";
                                    }
                                }
                    ?>
                                <option value="<?php echo $value['hd_chamado_origem']?>" <?php echo $selected_origem ?> >
                                    <?php echo $value['descricao']?>
                                </option>
                    <?php
                            }
                        //}
                    ?>
                </td>

                <td align='left' width="133"><strong><?=(in_array($login_fabrica, array(169,170))) ? '<label class="asteristico">*</label>' : '';?>Classificação do atendimento:</strong></td>
                <td align='left' width="574">
                    <select name='hd_classificacao' id='hd_classificacao'>
                        <option value=''>Escolha</option><?php

                        $sqlClassificacao = "SELECT hd_classificacao, descricao, envia_email FROM tbl_hd_classificacao WHERE fabrica = $login_fabrica AND ativo IS TRUE ORDER BY descricao";
                        $resClassificacao = pg_query($con,$sqlClassificacao);

                        for ($i = 0; $i < pg_num_rows($resClassificacao); $i++) {

                            $hd_classificacao_aux = pg_fetch_result($resClassificacao,$i,'hd_classificacao');
                            $classificacao    = pg_fetch_result($resClassificacao,$i,'descricao');
                            $classificacao_email = pg_fetch_result($resClassificacao, $i, 'envia_email');

                            echo " <option data-classificacao_email='$classificacao_email' value='".$hd_classificacao_aux."' ".($hd_classificacao_aux == $hd_classificacao ? "selected='selected'" : '').">$classificacao</option>";

                        }?>

                    </select>
                </td>
            </tr>
        </table>
    </div>
<? } ?>
    <br>

    <?php if ($login_fabrica == 152) {?>
        <table width="100%" border='0'>
            <tr>
                <td align='left'><div style="padding-top: 4px; padding-bottom: 4px; font: 10px arial;"><b>DÃºvida</b></div></td>
            </tr>
        </table>
        <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <tr>
                <td align='left' width='20%'><input type="radio" <?php echo ($duvida_consumidor == 'TE') ? 'checked' : '';?> name="duvida_consumidor" value="TE"> <b>Técnica de Equipamento</b></td>
                <td align='left' width='20%'><input type="radio" <?php echo ($duvida_consumidor == 'TC') ? 'checked' : '';?> name="duvida_consumidor" value="TC"> <b>Técnica de ConsumÃ­vel</b></td>


                <td align='left' width='20%'><input type="radio" <?php echo ($duvida_consumidor == 'C') ? 'checked' : '';?> name="duvida_consumidor" value="C"> <b>Comercial</b></td>
                <td align='left' width='10%'><input type="radio" <?php echo ($duvida_consumidor == 'R') ? 'checked' : '';?> name="duvida_consumidor" value="R"> <b>Reclamação</b></td>
                <td align='left' width='50%'></td>
            </tr>

            <tr class="exibe_equipamentos_consumiveis" style="display:<?php echo ($duvida_consumidor == 'TE' OR $duvida_consumidor == 'TC') ? '' : 'none';?>;">
                <td align='left' class="exibe_equipamentos"  style="display:<?php echo (strlen($equipamentoeconsumivel)> 0 AND $duvida_consumidor == "TE") ? 'block' : 'none' ;?>;">
                    <label>Equipamento</label>
                    <select name='equipamento_consumidor' id='equipamento_consumidor'>
                        <option value=''>Escolha ...</option>
                        <option <?php echo ($equipamentoeconsumivel == 'Codigo de Pecas' OR $equipamentoeconsumivel == 'Manuais' OR $equipamentoeconsumivel == "codigo_pecas_manuais") ? 'selected' : '';?> value='codigo_pecas_manuais'>Código de Peças / Manuais</option>
                        <option <?php echo ($equipamentoeconsumivel == 'Manutencao de Equipamento') ? 'selected' : '';?> value='Manutencao de Equipamento'>Manutenção de Equipamento</option>
                        <option <?php echo ($equipamentoeconsumivel == 'Selecao de Produto') ? 'selected' : '';?> value='Selecao de Produto'>Seleção de Produto</option>
                        <option <?php echo ($equipamentoeconsumivel == 'Utilizacao Produto') ? 'selected' : '';?> value='Utilizacao Produto'>Utilização Produto</option>


                    </select>
                </td>
                <td align='left' class="exibe_consumiveis"  style="display:<?php echo (strlen($equipamentoeconsumivel)> 0 AND $duvida_consumidor == "TC") ? 'block' : 'none' ;?>;">
                    <label>ConsumÃ­vel</label>
                    <select name='consumivel_consumidor' id='consumivel_consumidor'>
                        <option value=''>Escolha</option>

                        <option <?php echo ($equipamentoeconsumivel == 'Selecao de Produtos') ? 'selected' : '';?> value='Selecao de Produtos'>Seleção de Produtos</option>

                        <option <?php echo ($equipamentoeconsumivel == 'Consumo Consumiveis') ? 'selected' : '';?> value='Consumo Consumiveis'>Consumo ConsumÃ­veis</option>

                        <option <?php echo ($equipamentoeconsumivel == 'Utilizacao do Produto (Processo)') ? 'selected' : '';?> value='Utilizacao do Produto (Processo)'>Utilização do Produto (Processo)</option>

                        <option <?php echo ($equipamentoeconsumivel == 'Duvidas gerais') ? 'selected' : '';?> value='Duvidas gerais'>DÃºvidas gerais</option>

                        <option <?php echo ($equipamentoeconsumivel == 'Certificados') ? 'selected' : '';?> value='Certificados'>Certificados</option>

                        <option <?php echo ($equipamentoeconsumivel == 'FISPQ') ? 'selected' : '';?> value='FISPQ'>FISPQ</option>
                    </select>
                </td>
                <td align='left' colspan="3"></td>
            </tr>
        </table>
    <?php }?>
    <br>
    <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
        <tr>
            <td align='right' width='150'></td>
            <td align='right' width='55'>
                <img src='imagens/ajuda_call.png' align='absmiddle' >
            </td>
            <td align='center'>
                <?
                $sql = "SELECT pergunta FROM tbl_callcenter_pergunta WHERE codigo='2' AND fabrica = $login_fabrica";
                $pe = pg_query($con,$sql);
                echo (pg_num_rows($pe)>0) ? pg_fetch_result($pe,0,0) : "Qual o produto comprado?";
                ?>
            </td>
            <td align='right' width='150'></td>
        </tr>
    </table>

    <?php
        if ($login_fabrica == 183){
    ?>
        <table class='div_devolucao' style="<?=$display_devolucao?>" width="100%" border='0'>
            <tr>
                <td align='left'><strong><div style="padding-top: 4px; padding-bottom: 4px; font: 10px arial;">Informações para devolução</strong></div></td>
            </tr>
        </table>

        <table class='div_devolucao' width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style='<?=$display_devolucao?> border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;' name='tabela_itens' id='tabela_itens'>
            <tr>
                <td align='left'><strong>Transportadora</strong></td>
                <td align='left'>
                    <input style="width: 350px;" name="dev_transportadora" id="dev_transportadora" class="input" value='<?=utf8_decode($dev_transportadora);?>' type="text" size="50" maxlength="100" />
                </td>

                <td align='left'><strong>Motorista</strong></td>
                <td align='left'>
                    <input name="dev_motorista" id="dev_motorista" class="input" value='<?=utf8_decode($dev_motorista);?>' type="text" size="40" maxlength="100" />
                </td>

                <td align='left'><strong>Aprovador</strong></td>
                <td align='left'>
                    <input name="dev_aprovador" id="dev_aprovador" class="input" value='<?=utf8_decode($dev_aprovador);?>' type="text" size="40" maxlength="100" />
                </td>
            </tr>
        </table>
    <?php } ?>
    <table width="100%" border='0'>
        <tr>
            <td align='left'><strong><div style="padding-top: 4px; padding-bottom: 4px; font: 10px arial;">Informações do produto</strong></div></td>
        </tr>
    </table>
    <?

        //alteracao para Fricon lancar varios item num mesmo callcenter hd 165524 waldir
    if (in_array($login_fabrica,array(52,96))) {
        unset($defeito_reclamado);
    ?>
    <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;' name='tabela_itens' id='tabela_itens'>
        <thead>
        <tr>
            <td align='left'><strong>NF compra:</strong></td>
            <td align='left'>
                <input type="hidden" name="nota_fiscal_anterior" value="<?php echo $nota_fiscal; ?>"/>
                <input name="nota_fiscal" id="nota_fiscal" class="input" value="<?php echo $nota_fiscal;?>" maxlength="10" />
            </td>
            <td align='left'><strong>Data NF:</strong></td>
            <td align='left'>
                <input type="hidden" name="data_nf_anterior" value="<?php echo $data_nf; ?>" />
                <input name="data_nf" id="data_nf" class="input" rel="data" value="<?php echo $data_nf ;?>">
            </td>
            <?php
            if ($login_fabrica == 52) {
            ?>
            <td align='left'><strong>Marca:</strong></td>
            <td align='left'>
                <?
                $sql_fricon = "SELECT marca, nome
                                FROM tbl_marca
								WHERE tbl_marca.fabrica = $login_fabrica
								AND ativo
                                ORDER BY tbl_marca.nome ";
                $res_fricon = pg_query($con, $sql_fricon); ?>

                <select name='marca' id='marca' class="frm">
                <?
                if (pg_numrows($res_fricon) > 0) { ?>
                    <option value=''>ESCOLHA</option> <?
                    for ($x = 0 ; $x < pg_numrows($res_fricon) ; $x++){
                        $marca_aux = trim(pg_result($res_fricon, $x, marca));
                        $nome_aux = trim(pg_result($res_fricon, $x, nome));
                        if ($marca == $marca_aux) {
                            $selected = "SELECTED";
                        }else {
                            $selected = "";
                            }?>
                        <option value='<?=$marca_aux?>' <?=$selected?>><?=$nome_aux?></option> <?
                    }
                }else { ?>
                    <option value=''>Não existem linhas cadastradas</option><?
                } ?>
                </select>
                <input type="hidden" name="marca_anterior" value="<?php echo $marca; ?>">
            </td>
            <?
            }
            ?>
        </tr>
        </thead>
        <tbody>
        <?php
        if (strlen($callcenter)>0) {
            $campo = "";
            if($login_fabrica == 52){
                $join_ativo = "LEFT JOIN tbl_numero_serie   USING(produto, fabrica, serie)\n";
                $join_ativo.= 'LEFT JOIN tbl_serie_controle AS bloqueio_ns USING(produto, fabrica, serie) ';
                $campo = ", tbl_numero_serie.ordem , tbl_hd_chamado_item.hd_chamado_item, bloqueio_ns.motivo ";
            }

            $sql_produto = "SELECT tbl_produto.produto,
                                   descricao,
                                   referencia,
                                   tbl_hd_chamado_item.serie,
                                   defeito_reclamado,
                                   protocolo_cliente
                                   $campo
                              FROM tbl_hd_chamado_item
                              JOIN tbl_produto USING(produto)
                              JOIN tbl_hd_chamado USING(hd_chamado)
                              $join_ativo
                             WHERE tbl_hd_chamado_item.hd_chamado = $callcenter
                             ORDER BY hd_chamado_item ";
            $res_produto = pg_query($con,$sql_produto);
            $qtde_produto = pg_num_rows($res_produto);

        }

        if ($_POST['qtde_produto'] > 0 and $msg_erro){
            $qtde_produto = $_POST['qtde_produto'];
        }

        if (empty($qtde_produto)) {
            $qtde_produto = 1;
        }

        for ( $i = 1 ; $i <= $qtde_produto ; $i++ ) {
            if (strlen($msg_erro)>0) {
                $serie              = $_POST['serie_'.$i];
                $produto_referencia = $_POST['produto_referencia_'.$i];
                $produto_nome       = $_POST['produto_nome_'.$i];
                $defeito_reclamado  = $_POST['defeito_reclamado_'.$i];
                if($login_fabrica == 52){
                    $numero_ativo           = $_POST['numero_ativo_'.$i];
                    $hd_chamado_item_fricon = $_POST['hd_chamado_item_'.$i];
                    $controle_cliente       = $_POST['controle_cliente_'.$i];
                    $hd_motivo_bloqueio_ns  = $_POST['hd_motivo_bloqueio_ns_'.$i];
                }
            } else {

                if (strlen($callcenter)>0) {
                    $serie              = pg_fetch_result($res_produto, $i-1, 'serie');
                    $produto_referencia = pg_fetch_result($res_produto, $i-1, 'referencia');
                    $produto_nome       = pg_fetch_result($res_produto, $i-1, 'descricao');
                    $defeito_reclamado  = pg_fetch_result($res_produto, $i-1, 'defeito_reclamado');
                    if($login_fabrica == 52){
                        $numero_ativo              = pg_fetch_result($res_produto, $i-1, 'ordem');
                        $produto_defeito_reclamado = pg_fetch_result($res_produto, $i-1, 'produto');
                        $hd_chamado_item_fricon    = pg_fetch_result($res_produto, $i-1, 'hd_chamado_item');
                        $controle_cliente          = pg_fetch_result($res_produto, $i-1, 'protocolo_cliente');
                        $hd_motivo_bloqueio_ns     = pg_fetch_result($res_produto, $i-1, 'motivo');

                        if (!empty($hd_chamado_item_fricon)){
                            $readonlyFricon = 'readonly="readonly"';
                        }else{
                            $readonlyFricon = 'readonly=""';
                        }
                    }
                }
            }

            $td_motivo_visibility = 'oculto';
            $input_motivo_status  = 'disabled="disabled"';
            if (isset($hd_motivo_bloqueio_ns) and strlen($hd_motivo_bloqueio_ns)) {
                $chk_motivo_status = 'checked="checked"';
                $td_motivo_visibility = '';
                $input_motivo_status  = '';
            }

            if ($login_fabrica == 52 and strlen($callcenter) > 0) {
                $sql = "SELECT os_item FROM tbl_os_item
                        INNER JOIN tbl_os_produto ON tbl_os_produto.os_produto = tbl_os_item.os_produto
                        INNER JOIN tbl_os ON tbl_os.os = tbl_os_produto.os AND tbl_os.fabrica = $login_fabrica
                    WHERE tbl_os.hd_chamado = $callcenter";
                $res_is_item = pg_query($con,$sql);

                if(pg_num_rows($res_is_item) > 0){
                    // if (!empty($hd_chamado_item_fricon)){
                        $readonlyFricon = 'readonly="readonly"';
                        $disabledFricon = 'y';
                    // }
                }else{
                    $disabledFricon = '';
                    $readonlyFricon = '';
                }

               // até porque o motivo apenas é salvo no INSERT, não tem nada no UPDATE...
                $chk_motivo_status   .= (strpos($chk_motivo_status, 'checked') !== false) ? ' disabled="disabled" readonly="readonly"' : '';
                $input_motivo_status .= (strpos($chk_motivo_status, 'checked') !== false) ? ' readonly="readonly"' : '';
            }

        if ($login_fabrica == 52) { /*HD - 6165474*/
            if (strlen($_POST["nota_fiscal_fricon_" . $i]) > 0) {
                $nota_fiscal_fricon = $_POST["nota_fiscal_fricon_" . $i];
            }

            if (strlen($_POST["data_nf_fricon_" . $i]) > 0) {
                $data_nf_fricon = $_POST["data_nf_fricon_" . $i];
            }

            if (strlen($callcenter) > 0) {
                $aux_sql = "SELECT nota_fiscal, TO_CHAR(data_venda, 'DD/MM/YYYY') AS data_venda FROM tbl_numero_serie WHERE fabrica = $login_fabrica AND serie = '$serie'";
                $aux_res = pg_query($con, $aux_sql);

                $aux_val = pg_fetch_result($aux_res, 0, 'nota_fiscal');
                if (strlen($aux_val) > 0) {
                    $nota_fiscal_fricon = $aux_val;
                }

                $aux_val = pg_fetch_result($aux_res, 0, 'data_venda');
                if (strlen($aux_val) > 0) {
                    $data_nf_fricon = $aux_val;
                }
            }
        ?>
            <tr>
                <td align='left'><strong>NF Saída Fricon:</strong></td>
                <td align='left'>
                    <input name="nota_fiscal_fricon_<?=$i;?>" id="nota_fiscal_fricon_<?=$i;?>" class="input" value="<?=$nota_fiscal_fricon;?>" readonly='readonly'>
                </td>
                <td align='left'><strong>Data NF Fricon:</strong></td>
                <td align='left'>
                    <input name="data_nf_fricon_<?=$i;?>" id="data_nf_fricon_<?=$i;?>" class="input" value="<?=$data_nf_fricon;?>" readonly='readonly'>
                </td>
            </tr>
    <?php } ?>
        <tr>
            <td align='left'><strong>Série:</strong></td>
            <td align='left'>
            <?php
                if($login_fabrica == 52){
                    $blur_serie = "onblur=\"fnc_pesquisa_serie (document.frm_callcenter.produto_referencia_$i,document.frm_callcenter.produto_nome_$i,'serie',mapa_linha,document.frm_callcenter.serie_$i, $i)\"";
                }
            ?>
                <input type="hidden" name="hd_chamado_item_<?=$i?>" value="<?=$hd_chamado_item_fricon?>">
                <input type="hidden" name="serie_anterior_<?=$i?>" value="<?php echo $serie; ?>" />
                <input name="serie_<?=$i;?>" id="serie_<?=$i;?>"  maxlength="10"  class="<?php echo ($login_fabrica==24) ? 'input_req' : 'input' ; ?>" value="<?php echo $serie;?>" />
                <img src='imagens/lupa.png' border='0' align='absmiddle'
                style='cursor: pointer'
                onclick="javascript: fnc_pesquisa_serie (document.frm_callcenter.produto_referencia_<?=$i;?>,document.frm_callcenter.produto_nome_<?=$i;?>,'serie',mapa_linha,document.frm_callcenter.serie_<?=$i;?>, <?=$i?>)">
            </td>
            <td align='left'><strong>Referência:</strong></td>
            <td align='left'>
                <input type="hidden" name="produto_referencia_anterior_<?=$i?>" value="<?= $produto_referencia; ?>" />
                <input name="produto_referencia_<?=$i?>" id="produto_referencia_<?=$i?>" class="input" value='<?= $produto_referencia;?>' onblur="javascript:fnc_pesquisa_produto2(document.frm_callcenter.produto_referencia_<?=$i;?>,document.frm_callcenter.produto_nome_<?=$i;?>,'referencia',mapa_linha, <?=$i?>);atualizaQuadroMapas();" type="text" size="15" maxlength="15" />
                <img src='imagens/lupa.png' border='0' align='absmiddle' style='cursor:pointer' onclick="javascript: fnc_pesquisa_produto2(document.frm_callcenter.produto_referencia,document.frm_callcenter.produto_nome,'descricao',mapa_linha, <?=$i?>)" />
            </td>
            <td align='left'><strong>Descrição:</strong></td>
            <td align='left'>
                <input type="hidden" name="produto_nome_anterior_<?=$i?>" value="<?= $produto_nome; ?>" />
                <input type='hidden' name='produto_<?=$i?>'  value="<?= $produto; ?>" />
                <input name="produto_nome_<?=$i?>" size='20' class="input" value='<?= $produto_nome ;?>' onblur="javascript:fnc_pesquisa_produto2(document.frm_callcenter.produto_referencia,document.frm_callcenter.produto_nome,'descricao',mapa_linha,<?=$i?>);atualizaQuadroMapas();" type="text" size="35" maxlength="500" />
                <img src='imagens/lupa.png' border='0' align='absmiddle' style='cursor:pointer' onclick="javascript: fnc_pesquisa_produto2(document.frm_callcenter.produto_referencia_<?=$i;?>,document.frm_callcenter.produto_nome_<?=$i;?>,'descricao',mapa_linha, <?=$i?>)" />
            </td>
            <td align='left'>
                <strong>Defeito Reclamado</strong>
            </td>
            <td align='left'>
                <select class='input' name='defeito_reclamado_<?=$i?>' <?=$disabledFricon?> id='defeito_reclamado_<?=$i?>'  <?php if($login_fabrica == 52) {?> onblur="fnc_valida_num_serie(<?=$i?>)" rel="serie" <?php }?> >
                    <option> </option>
                    <?php
                    //HD 706810
                    if (in_array($login_fabrica,$fabricas_defeito_reclamado_sem_integridade)){

                        $sqldef = "
                            SELECT
                                defeito_reclamado,
                                descricao
                            FROM tbl_defeito_reclamado
                            WHERE fabrica = $login_fabrica
                            AND ativo = 't'
                            ORDER BY descricao;
                        ";

                    } else {
                    //HD 706810 END

                        if (!empty($produto_defeito_reclamado)) {
                            $cond_defeito_produto = " AND tbl_produto.produto = $produto_defeito_reclamado ";
                        } else {
                            $cond_defeito_produto = "";
                        }

                        if ($login_fabrica <> 52) {
                            $and_linha = " AND tbl_diagnostico.linha = tbl_produto.linha ";
                        } else {
                            $and_linha = '';
                        }

                        if(empty($callcenter) && $login_fabrica != 52) { /*HD-3791256 18/10/2017*/
                            $cond_ativo = " AND tbl_diagnostico.ativo IS TRUE";
                        }

                        $sqldef = "
                            SELECT DISTINCT
                                tbl_defeito_reclamado.descricao,
                                tbl_defeito_reclamado.defeito_reclamado
                            FROM tbl_diagnostico
                            JOIN tbl_defeito_reclamado ON tbl_diagnostico.defeito_reclamado = tbl_defeito_reclamado.defeito_reclamado
                            JOIN tbl_produto ON tbl_diagnostico.familia = tbl_produto.familia $and_linha
                            WHERE tbl_diagnostico.fabrica = $login_fabrica
                            $cond_defeito_produto
                            $cond_ativo
                            ORDER BY tbl_defeito_reclamado.descricao;
                        ";

                    }

                    $resdef = pg_query($con,$sqldef);
                    if (pg_num_rows($resdef)>0) {
                            for ($w=0;$w<pg_num_rows($resdef);$w++) {
                            unset($selected);
                            $xdefeito_reclamado = pg_fetch_result($resdef,$w,defeito_reclamado);
                            $descricao          = pg_fetch_result($resdef,$w,descricao);
                            $descricao          = substr($descricao,0,30);
                            if ($defeito_reclamado == $xdefeito_reclamado) {
                                $selected = "SELECTED";
                            }
                            echo "<option value='$xdefeito_reclamado' $selected> $descricao</option>";
                        }
                    }
                ?>
            </select>
            </td>

            <? if($login_fabrica == 52){ ?>
                    <td align='right'>
                        <strong>nº Controle Cliente</strong>
                    </td>
                    <td align='left'>
                        <input type="text" name="controle_cliente_<?=$i?>" id="controle_cliente_<?=$i?>" <?=$readonlyFricon?> class="input" value="<?php echo $controle_cliente; ?>" maxlength='20'>
                    </td>

            <td align='left'>
                <strong>número do Ativo</strong>
            </td>
            <td align='left'>
                <input type="text" name="numero_ativo_<?=$i?>" id="numero_ativo_<?=$i?>" <?=$readonlyFricon?> class="input" value="<?php echo $numero_ativo; ?>">
                <img src='imagens/lupa.png' border='0' align='absmiddle'
                style='cursor: pointer'
                onclick="javascript: fnc_pesquisa_ordem (document.frm_callcenter.produto_referencia_<?=$i;?>,document.frm_callcenter.produto_nome_<?=$i;?>,'ordem',mapa_linha,document.frm_callcenter.serie_<?=$i;?>,document.frm_callcenter.numero_ativo_<?=$i;?>, <?=$i?>)">
            </td>
            <? } ?>

            <td>
                <input type='button' name='addlinha' value='+' onclick='function1(<?=$i?>)'>
            </td>
        </tr>
        <tr>
            <td></td>
            <td>
                <input  id="perdeu_garantia_<?=$i?>" data-linha="<?=$i?>" class="chk-motivo" <?=$chk_motivo_status?> type="checkbox" name="hd_perdeu_garantia_<?=$i?>">
                <label for='perdeu_garantia_<?=$i?>'><strong>Perda de garantia</strong></label>
            </td>
            <td class="motivo-perda <?=$td_motivo_visibility?>">
                <label for="motivo_perda_gar_<?=$i?>"><strong>Motivo Perda de Garantia:</strong></label>
            </td>
            <td class="motivo-perda <?=$td_motivo_visibility?>">
                <input  id="motivo_perda_gar_<?=$i?>" type="text" name="hd_motivo_bloqueio_ns_<?=$i?>" required
                     class="input" value="<?=$hd_motivo_bloqueio_ns?>" <?=$input_motivo_status?>>
            </td>
        </tr>
        <? }?>
        <INPUT TYPE='hidden' NAME='qtde_produto' value='<? echo $i= $i-1;?>' id='qtde_produto'>
        </tbody>
    </table>
    <?php } elseif (in_array($login_fabrica,array(138,151,186,189,190,195)) OR $moduloOSMultipla == "t") {
        unset($defeito_reclamado);
        ##Mondial Postagem
    ?>

    <table id='tabela-principal' <?=(in_array($login_fabrica,array(178,186,190,195))) ? "width='100%'" : "" ?> border='0' align='center' cellpadding="4" cellspacing="14" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
        <tr>
            <td>
                <table border='0' align='center' cellpadding="2" cellspacing="2" style="width: 1305px;" >
                    <?php if (!in_array($login_fabrica,array(186,189))){ ?>
                    <tr>
                        <td align='left' width="<?=(in_array($login_fabrica,array(178,186,189,190,195))) ? "1%" : "14%" ?>">
                            <strong>CNPJ da Revenda:</strong><br />
                            <?php 
                            $cnpj_revenda = ($_POST['cnpj_revenda']) ? $_POST['cnpj_revenda'] : $cnpj_revenda ; 
                            $revenda_nome = ($_POST['nome_revenda']) ? $_POST['nome_revenda'] : $revenda_nome ; 

                            ?>
                            <input name="cnpj_revenda" id="cnpj_revenda" class="input" value="<?php echo $cnpj_revenda;?>" type="text" <?=$disabled_rev?> />
                            <?php if (in_array($login_fabrica,array(178,186,189,190,195))){ ?>
                                <img src='imagens/lupa.png' border='0' align='absmiddle' style='cursor: pointer'
                                    onclick="javascript: fnc_lupa_callcenter_revenda (
                                        document.frm_callcenter.cnpj_revenda,
                                        'cnpj'
                                    );
                                ">
                            <?php } ?>
                        </td>
                        <td align='left' width="20%">
                            <strong>Nome da Revenda:</strong><br />
                            <input name="nome_revenda" id="nome_revenda" class="input" value="<?php echo $revenda_nome;?>" size=35 maxlength="50" <?=$disabled_rev?> />
                            <?php if (in_array($login_fabrica,array(178,186,189,190,195))){ ?>
                                <img src='imagens/lupa.png' border='0' align='absmiddle' style='cursor: pointer'
                                    onclick="javascript: fnc_lupa_callcenter_revenda (
                                        document.frm_callcenter.nome_revenda,
                                        'nome'
                                    );
                                ">
                            <?php } ?>
                        </td>
                    </tr>
                <?php } ?>
                    <tr>
                        <?php
                        $mostraCorreio = true;
                        if ($login_fabrica == 195  && $abre_os <> "t") {
                        	$mostraCorreio = false;
                        }
                        if($mostraCorreio && !empty($callcenter) and strlen(trim($posto)) == 0 and $moduloLGRCorreio){
                            echo "<td colspan='3'><font color='#ff0000' size='2' ><b> Para solicitar postagem por favor gravar o atendimento com um posto autorizado.</b></font></td>";
                        }elseif($mostraCorreio && !empty($callcenter) and strlen(trim($posto))>0 and $moduloLGRCorreio) {
                        ?>
                        <td align='left' width="10%">
                            <strong>Obs. Postagem</strong><br />
                            <input type='text' name='consumidor_final_nome' id='consumidor_final_nome'  class='input' value='<?=$consumidor_final_nome?>'>
                        </td>
                        <td align='left' width="10%">
                            <strong>Tipo Postagem</strong><br />
                            <select name='tipo_postagem' id='tipo_postagem' style="width: 50%;" >
                                <option value=''>Escolha</option>
                                <option value='A' <?PHP if ($tipo_postagem == 'A'){ echo "Selected";}?>>Postagem</option>
                                <option value='C' <?PHP if ($tipo_postagem == 'C'){ echo "Selected";}?>>Coleta</option>
                            </select>
                        </td>
                        <td align='left' width="10%">
                            <strong>Modo de Envio</strong><br />
                            <select name='sedex_pac' id='sedex_pac'>
                                <option value=''>Escolha</option>
				<option value='<?=(!in_array($login_fabrica,[186,151])) ? '04677' : '03301'?>' <?PHP if ($sedex_pac == '04677'){ echo "Selected";}?>>PAC REVERSO</option>
				<option value='<?=(!in_array($login_fabrica,[186,151])) ? '04170' : '03247'?>' <?PHP if ($sedex_pac == '04170'){ echo "Selected";}?>>SEDEX</option>
                            </select>
                        </td>
                         <td align='left' width="25%">
                            <input name="btn_lgr" id="btn_lgr" value='Solicitar Logistica Reversa Correios' type='button' onclick='solicitaPostagem(<?=$callcenter?>)'>
                        </td>
            <? } ?>
                    </tr>
                </table>
            </td>
        </tr>
        <tr>
            <td>
                <table name='tabela_itens' id='tabela_itens' border='0' align='center' cellpadding="2" cellspacing="2" >
                    <tbody>
                    <?php
                if (strlen($callcenter)>0) {
                    if ($moduloOSMultipla == "t"){
                        $joins_produto = "
                            LEFT JOIN tbl_produto using(produto)
                            LEFT JOIN tbl_hd_chamado ON tbl_hd_chamado_item.hd_chamado = tbl_hd_chamado.hd_chamado ";
                        if (in_array($login_fabrica, [178])) {
                            $cond_os = " AND tbl_hd_chamado_item.produto IS NOT NULL";
                        } else {
                            $cond_os = " AND tbl_hd_chamado_item.os IS NOT NULL";
                        }

                    }else{
                        $joins_produto = "
                            JOIN tbl_produto using(produto)
                            JOIN tbl_hd_chamado ON tbl_hd_chamado_item.hd_chamado = tbl_hd_chamado.hd_chamado ";
                    }
                    $sql_produto = "SELECT  distinct tbl_produto.produto,
                                            tbl_produto.descricao,
                                            tbl_produto.referencia,
                                            tbl_hd_chamado_item.serie,
                                            tbl_hd_chamado_item.voltagem,
                                            tbl_hd_chamado_item.data_nf,
                                            tbl_hd_chamado_item.nota_fiscal,
                                            tbl_hd_chamado_item.defeito_reclamado,
                                            tbl_hd_chamado_item.defeito_reclamado_descricao,
                                            tbl_hd_chamado_item.hd_chamado_item,
                                            tbl_hd_chamado_item.qtde,
                                            tbl_hd_chamado_item.tincaso,
                                            tbl_hd_chamado_item.campos_adicionais,
                                            tbl_serie_controle.motivo
                                    FROM tbl_hd_chamado_item
                                    $joins_produto
                                    LEFT JOIN tbl_serie_controle ON tbl_serie_controle.produto = tbl_produto.produto AND tbl_serie_controle.serie = tbl_hd_chamado_item.serie AND tbl_serie_controle.fabrica = {$login_fabrica}
                                    WHERE tbl_hd_chamado_item.hd_chamado = $callcenter
                                    $cond_os
                                    ORDER BY hd_chamado_item ";
                    $res_produto  = pg_query($con,$sql_produto);
                    $qtde_produto = pg_num_rows($res_produto);
                    $qtde_produto_antes = pg_num_rows($res_produto);

                    if($qtde_produto == 0) {
                        $sql_produto = "SELECT  tbl_produto.produto,
                            tbl_produto.descricao,
                            tbl_produto.referencia,
                            tbl_hd_chamado_extra.serie,
                            tbl_produto.voltagem,
                            tbl_hd_chamado_extra.data_nf,
                            tbl_hd_chamado_extra.nota_fiscal,
                            tbl_hd_chamado_extra.defeito_reclamado,
                            null as defeito_reclamado_descricao,
                            null as hd_chamado_item,
                            tbl_serie_controle.motivo
                            FROM tbl_hd_chamado_extra
                            JOIN tbl_produto using(produto)
                            JOIN tbl_hd_chamado ON tbl_hd_chamado_extra.hd_chamado = tbl_hd_chamado.hd_chamado
                            LEFT JOIN tbl_serie_controle ON tbl_serie_controle.produto = tbl_produto.produto AND tbl_serie_controle.serie = tbl_hd_chamado_extra.serie AND tbl_serie_controle.fabrica = {$login_fabrica}
                            WHERE tbl_hd_chamado_extra.hd_chamado = $callcenter      ";
                        $res_produto  = pg_query($con,$sql_produto);
                        $qtde_produto = pg_num_rows($res_produto);
                    }
                }

                if ($_POST['qtde_produto'] > 0 and $msg_erro){
                    $qtde_produto = $_POST['qtde_produto'];
                }

                if (empty($qtde_produto)) {
                    $qtde_produto = 1;
                }

                if ($login_fabrica == 178 AND empty($callcenter) AND !empty($msg_erro)){
                    unset($qtde_produto_antes);
                }

                for ( $i = 1 ; $i <= $qtde_produto ; $i++ ) {
                        if (strlen($msg_erro)>0) {
                            $voltagem               = $_POST['voltagem_'.$i];
                            $data_nf                = $_POST['data_nf_'.$i];
                            $nota_fiscal            = $_POST['nota_fiscal_'.$i];
                            $serie                  = $_POST['serie_'.$i];
                            $produto_referencia     = $_POST['produto_referencia_'.$i];
                            $produto_nome           = $_POST['produto_nome_'.$i];
                            $defeito_reclamado      = $_POST['defeito_reclamado_'.$i];
                            $hd_chamado_item_mondial = $_POST['hd_chamado_item_'.$i];
                            $obs_num_serie          = $_POST['obs_num_serie_'.$i];
                            $b_num_serie            = $_POST['b_num_serie_'.$i];

                            $qtde_prod_lancado         = $_POST['qtde_prod_lancado_'.$i];
                            $reclamado_cliente_produto = $_POST['reclamado_cliente_produto_'.$i];

                            if ($login_fabrica == 178){
                                $produto_defeito_reclamado = $_POST['produto_'.$i];
                            }
                            if ($login_fabrica == 189){
                                $lote = $_POST['lote_'.$i];
                                $preco = $_POST['preco_'.$i];
                            }

                            if($login_fabrica == 151){
                                $voucher_codigo  = $_POST['voucher_codigo_'.$i];
                                $voucher_id      = $_POST['voucher_id_'.$i];
                                $voucher_familia = $_POST['voucher_familia_'.$i];
                                $voucher_gerado = false;  
                            }


                        } else {

                            if (strlen($callcenter)>0) {

                                $voltagem               = pg_fetch_result($res_produto,$i-1,voltagem);
                                $data_nf                = pg_fetch_result($res_produto,$i-1,data_nf);
                                $nota_fiscal            = pg_fetch_result($res_produto,$i-1,nota_fiscal);
                                $serie                  = pg_fetch_result($res_produto,$i-1,serie);
                                $produto_referencia     = pg_fetch_result($res_produto,$i-1,referencia);
                                $produto_nome           = pg_fetch_result($res_produto,$i-1,descricao);
                                $defeito_reclamado      = pg_fetch_result($res_produto,$i-1,defeito_reclamado);

                                $produto_defeito_reclamado = pg_fetch_result($res_produto, $i-1, 'produto');
                                $hd_chamado_item_mondial = pg_fetch_result($res_produto,$i-1,'hd_chamado_item');
                                $obs_num_serie          = pg_fetch_result($res_produto,$i-1,'motivo');
                                if (!empty($obs_num_serie)) {
                                    $b_num_serie = 't';
                                }

                                if($login_fabrica == 151){

                                    $campos_adicionais = pg_fetch_result($res_produto, $i-1, campos_adicionais);
                                
                                    if(!empty($campos_adicionais)){

                                        $campos_adicionais = json_decode($campos_adicionais);
                                        $voucher_codigo = $campos_adicionais->voucher_codigo;
                                        $voucher_id = $campos_adicionais->voucher_id;
                                        $voucher_familia = $campos_adicionais->voucher_familia;
                                        $voucher_gerado = true;  
                                    }else{
                                        $voucher_gerado = false;
                                    }
                                }

                                if ($moduloOSMultipla == "t"){
                                    if (!empty($produto_referencia) AND !empty($produto_nome)){
                                        #$qtde_prod_lancado = 1;
                                        $qtde_prod_lancado = pg_fetch_result($res_produto, $i-1, 'qtde');
                                    }
                                    $reclamado_cliente_produto = pg_fetch_result($res_produto, $i-1, 'defeito_reclamado_descricao');
                                }
                                if ($login_fabrica == 186){
                                    $qtde_prod_lancado = pg_fetch_result($res_produto, $i-1, 'qtde');
                                }

                                if ($login_fabrica == 189){
                                    $lote = pg_fetch_result($res_produto,$i-1,'tincaso');
                                }

                                if (!empty($data_nf)){
                                    list($y,$m,$d) = explode("-",$data_nf);
                                    $data_nf = "$d/$m/$y";
                                }

                                if ($login_fabrica == 189) {
                                    $reclamado_cliente_produto = pg_fetch_result($res_produto, $i-1, 'defeito_reclamado_descricao');
                                    $qtde_prod_lancado = pg_fetch_result($res_produto, $i-1, 'qtde');
                                    $campos_adicionais = json_decode(pg_fetch_result($res_produto, $i-1, 'campos_adicionais'),1);
                                    $preco = $campos_adicionais["preco"];
                                }
                            }
                        }
                        if (!empty($hd_chamado_item_mondial)){
                            $class_produtos = "class='produtos_lancados'";
                        }else{
                            $class_produtos = "";
                        }
                        if (strlen($callcenter) > 0) {
                            $sql = "SELECT os_item FROM tbl_os_item
                                    INNER JOIN tbl_os_produto ON tbl_os_produto.os_produto = tbl_os_item.os_produto
                                    INNER JOIN tbl_os ON tbl_os.os = tbl_os_produto.os AND tbl_os.fabrica = $login_fabrica
                                WHERE tbl_os.hd_chamado = $callcenter";
                            $res_is_item = pg_query($con,$sql);

                            if(pg_num_rows($res_is_item) > 0){
                                $disabledMondial = 'disabled="disabled"';
                            }else{
                                $disabledMondial = '';
                            }
                        }

                        if ($login_fabrica == 178){
                            $width_table = "12%";
                        }else{
                            $width_table = "7%";
                        }
                    ?>
                        <tr rel="<?=$i;?>" id="tr-pd-<?=$i;?>" <?=$class_produtos?> >
                            <td align='left' width="<?=$width_table?>">
                                <strong>NF compra:</strong>
                                <input type="hidden" name="hd_chamado_item_<?=$i?>" value="<?=$hd_chamado_item_mondial?>">
                                <input type="hidden" name="nota_fiscal_anterior_<?=$i?>" value="<?php echo $nota_fiscal; ?>"/>
                                <input name="nota_fiscal_<?=$i?>" id="nota_fiscal_<?=$i?>" style="width:70% !important" class="input" value="<?php echo $nota_fiscal;?>" maxlength="10" />
                            </td>
                            <td align='left' width="7%">
                                <strong>Data NF:</strong>
                                <input type="hidden" name="data_nf_anterior_<?=$i?>" value="<?php echo $data_nf; ?>" />
                                <input name="data_nf_<?=$i?>" id="data_nf_<?=$i?>" style="width:70% !important" class="input" rel="data" value="<?php echo $data_nf ;?>">
                            </td>
                            <?php if (!in_array($login_fabrica,array(178,189))){ ?>
                            <td align='left'>
                                <strong>Série:</strong><br/>
                                <input type="hidden" name="serie_anterior_<?=$i?>" value="<?php echo $serie; ?>" />
                                <? if($login_fabrica == 151) { ?>
                                    <input name="serie_<?=$i;?>" id="serie_<?=$i;?>" style="width:80% !important"  maxlength="20"  class="input" value="<?php echo $serie;?>" />
                                <?} else {?>
                                    <input name="serie_<?=$i;?>" id="serie_<?=$i;?>" style="width:80% !important"  maxlength="15"  class="input" value="<?php echo $serie;?>" />
                                <? } ?>
                            </td>
                            <?php } ?>
                            <td align='left'>
                                <strong>Referência:</strong>
                                <input type="hidden" name="produto_referencia_anterior_<?=$i?>" value="<?php echo $produto_referencia;  ?>" />
                                <input style="width:80% !important" name="produto_referencia_<?=$i?>" id="produto_referencia_<?=$i?>" class="input"  value='<? echo $produto_referencia ;?>'
                                onblur="javascript: fnc_pesquisa_produto2 (document.frm_callcenter.produto_referencia_<?=$i;?>,document.frm_callcenter.produto_nome_<?=$i;?>,'referencia',null,<?=$i;?>); mostraDefeitos('Reclamado',document.frm_callcenter.produto_referencia_<?=$i;?>.value);atualizaQuadroMapas();" type="text" size="15" maxlength="15"><img src='imagens/lupa.png' class="lupa" border='0' align='absmiddle'
                                style='cursor: pointer'
                                onclick="javascript: fnc_pesquisa_produto2 (document.frm_callcenter.produto_referencia_<?=$i?>,document.frm_callcenter.produto_nome_<?=$i?>,'referencia',null,<?=$i;?>)">
                            </td>
                            <td align='left'>
                                <strong>Descrição:</strong>
                                <input type="hidden" name="produto_nome_anterior_<?=$i?>" value="<?php echo $produto_nome; ?>" />
                                <input type='hidden' name='produto_<?=$i?>'  value="<? echo $produto; ?>">
                				<input style="width:80% !important" name="produto_nome_<?=$i?>" id="produto_nome_<?=$i?>"  size='20' class="input" value='<?php echo $produto_nome ;?>' <?php echo ($login_fabrica == 178) ? 'readonly' : ''?>
								<? if($login_fabrica <> 178){ ?>
								onblur="javascript: fnc_pesquisa_produto2 (document.frm_callcenter.produto_referencia_<?=$i?>,document.frm_callcenter.produto_nome_<?=$i?>,'descricao',mapa_linha, <?=$i?>);"
								<? } ?>
                                mostraDefeitos('Reclamado',document.frm_callcenter.produto_referencia_<?=$i;?>.value);" atualizaQuadroMapas();" type="text" size="35" maxlength="500">
                			<?php
                			if($login_fabrica != 178){
                			?>
                				<img src='imagens/lupa.png' class="lupa-descricao" border='0' align='absmiddle'
                                                style='cursor: pointer'
                				onclick="javascript: fnc_pesquisa_produto2 (document.frm_callcenter.produto_referencia_<?=$i;?>,document.frm_callcenter.produto_nome_<?=$i;?>,'descricao',mapa_linha, <?=$i?>)">
                			<?php
                			}
                			?>
                            </td>
                            <?
                                if(in_array($login_fabrica, array(151)) AND !empty($callcenter) and !empty($familia)){
                                    $sqlFamilia = "SELECT
                                                        descricao
                                                    FROM tbl_familia
                                                    WHERE familia = {$familia}";

                                    $resFamilia = pg_query($con, $sqlFamilia);

                                    $familia_descricao = pg_fetch_result($resFamilia, 0, 'descricao');
                            ?>
                                <td align='left'>
                                    <?=$campos_obrig;?><strong>FamÃ­lia:</strong><?=$fx_cmp_obg;?><br />
                                    <input style="width:85% !important" name="familia_<?=$i?>" id="familia_<?=$i?>" class="input" value='<?php echo $familia_descricao;?>' size="30" readonly="true">
                                </td>
                            <?
                                }
                            ?>
                            <? if($login_fabrica == 151) : ?>

                                <td align="left" style="padding-right:5px; padding-top:2px">
                                    <strong>Família</strong>
                                    <select <?=($voucher_gerado == true) ? "disabled" : "" ?> name="voucher_familia_<?=$i?>" id="voucher_familia_<?=$i?>" data-familia="<?=$voucher_familia?>" style="width:130px">
                                        <option value="">Escolha</option>
                                    </select>
                                </td>
                                 <td align="left" style="padding-right:5px; padding-top:2px">
                                    <strong>Voucher</strong>
                                    <div style="display:flex;">
                                        <input type="hidden" name="voucher_id_<?=$i?>" id="voucher_id_<?=$i?>" value="<?=$voucher_id?>" />
                                        <input <?=($voucher_gerado == true) ? "disabled" : "" ?> type="text" readonly name="voucher_codigo_<?=$i?>" id="voucher_codigo_<?=$i?>" style="width:100px;" value="<?=$voucher_codigo?>"/>
                                        <button <?=($voucher_gerado == true) ? "disabled" : "" ?> type="button" name="btn_gerar_voucher_<?=$i?>" id="btn_gerar_voucher_<?=$i?>" data-linha="<?=$i?>" style="padding-left:6px; padding-right:6px;cursor:pointer">Gerar</button>
                                    </div>
                                </td>

                            <?php endif; ?>

                            <?php if (!in_array($login_fabrica,array(178,189))){ ?>
                            <td align='left'>
                                <?=$campos_obrig;?><strong>Voltagem:</strong><?=$fx_cmp_obg;?><br />
                                <input type="hidden" name="voltagem_anterior_<?=$i?>" value="<?php echo $voltagem; ?>" />
                                <input style="width:50% !important" name="voltagem_<?=$i?>" id="voltagem_<?=$i?>" class="input" value='<?php echo $voltagem;?>' size='15' maxlength="5" >
                            </td>
                            <?php } ?>
                <?php
                    if(in_array($login_fabrica, array(151,178,186,189,190,195))){
                ?>
                        <?php if(!in_array($login_fabrica, array(178,186,189,190,195))){ ?>
                            <td align='left' width="10%">
                                <?php if($login_fabrica == 151) {
                                    echo "<strong>Bloquear Série</strong><br />";
                                } else {
                                    echo "<strong>Bloquear número de Série</strong><br />";
                                }?>
                                <input type="hidden" name="valida_num_serie" value="<?=(in_array($window_cadastra_pedido,array('false', 'true'))) ? $window_cadastra_pedido : 'true'; ?>">
                                <input type="checkbox" name="b_num_serie_<?=$i?>" id="b_num_serie_<?=$i?>" class="input" value='t' <?=($b_num_serie == 't') ? 'checked' : ''; ?> >
                            </td>
                                <?  if($login_fabrica == 151 AND !empty($callcenter)) { ?>
                                        <td>
                                            <input type='button' name='btn_garantia_estendida_<?=$i?>' id="btn_garantia_estendida_<?=$i?>" value='Garantia Estendida' onclick="garantiaEstendida(document.frm_callcenter.produto_referencia_<?=$i?>.value, document.frm_callcenter.nota_fiscal_<?=$i?>.value, document.frm_callcenter.nota_fiscal_<?=$i?>.value);" />
                                        </td>
                                        <td>&nbsp;</td>
                                       <script>
                                            function garantiaEstendida(produto_referencia, nf_compra, n_serie){
                                                var consumidor_cpf     = document.getElementById("consumidor_cpf");
                                                var consumidor_email   = document.getElementById("consumidor_email");

                                                if(produto_referencia != null){
                                                    var p_referencia = produto_referencia;
                                                }
                                                if(consumidor_cpf != null){
                                                    var c_cpf = consumidor_cpf.value;
                                                }
                                                if(consumidor_email != null){
                                                    var c_email = consumidor_email.value;
                                                }

                                                if(nf_compra != "" && n_serie != "" && p_referencia != "" && c_cpf != "" && c_email != ""){
                                                    Shadowbox.init();
                                                    $.ajax({
                                                        url: window.location,
                                                        type: 'POST',
                                                        data: {
                                                            ajax_garantia_estendida_mondial: true,
                                                            nf_compra: nf_compra,
                                                            n_serie: n_serie,
                                                            p_referencia: p_referencia,
                                                            c_cpf: c_cpf,
                                                            c_email: c_email
                                                        }
                                                    }).done(function(data){
                                                        Shadowbox.open({
                                                            content: "verifica_interventor.php?callcenter=<?=$callcenter?>&produto=" + p_referencia,
                                                            player:"iframe",
                                                            title:"Garantia Estendida",
                                                            height: 220,
                                                            width: 600,
                                                            options: {
                                                                modal: true,
                                                                enableKeys: false,
                                                                displayNav: false,
                                                                onFinish: function(){
                                                                    $("#sb-nav-close").hide();
                                                                }
                                                            }
                                                        });
                                                    });

                                                } else {
                                                    alert("Campos 'NF Compra', 'Série', 'Referência', 'CPF' e 'E-Mail' devem ser preenchidos\nPreencha todos os campos e grave as alteraçÃµes");
                                                }
                                            }
                                       </script>
                                <?  }
                        } ?>
            			<?php if(!in_array($login_fabrica, array(178,186,189,190,195))){ ?>
                            <td align='left' width="10%">
                                <strong>Observação</strong><br />
                                <textarea rows="3" name="obs_num_serie_<?=$i?>" id="obs_num_serie_<?=$i?>" class="input" style="width:80% !important" <?=(empty($obs_num_serie) && empty($msg_erro))? 'disabled' :
				''; ?>><?php echo $obs_num_serie;?></textarea>
                            </td>
                        <?php } ?>

                        <?php if(in_array($login_fabrica, array(178,186,189))){ ?>

                            <td align='left'>
                                <strong>Qtde:</strong><br/>
                                <input type="hidden" name="qtde_prod_lancado_anterior_<?=$i?>" value="<?php echo $qtde_prod_lancado; ?>" />
                                <input name="qtde_prod_lancado_<?=$i?>" type='text' id="qtde_prod_lancado_<?=$i?>" style="width:25% !important" class="input" rel="qtde_prod_lancado" value="<?php echo $qtde_prod_lancado ;?>">
                			    </td>
                			    <?php if(in_array($login_fabrica, array(178))){ ?>
                					<td align='left'>
                						<strong>Defeito reclamado cliente:</strong>
                						<input type="hidden" name="reclamado_cliente_produto_anterior_<?=$i?>" value="<?php echo $reclamado_cliente_produto; ?>" />
                						<input name="reclamado_cliente_produto_<?=$i?>" type='text' id="reclamado_cliente_produto_<?=$i?>" style="width:70% !important" class="input" rel="reclamado_cliente_produto"       value="<?php echo $reclamado_cliente_produto ;?>">
                					</td>
                			    <?php } ?>
                            <?php if(in_array($login_fabrica, array(189))){ ?>
                                <td align='left'>
                                    <strong>Preço:</strong><br/>
                                    <input type="hidden" name="preco_anterior_<?=$i?>" value="<?php echo $preco; ?>" />
                                    <input name="preco_<?=$i?>" size='10' type='text' id="preco_<?=$i?>"  class="input preco_pd" rel="preco" value="<?php echo $preco ;?>">
                                </td>
                                <td align='left'>
                                    <strong>Lote:</strong><br/>
                                    <input type="hidden" name="hd_chamado_item_<?=$i?>" value="<?=$hd_chamado_item_mondial?>">
                                    <input type="hidden" name="lote_anterior_<?=$i?>" value="<?php echo $lote; ?>" />
                                    <input name="lote_<?=$i?>" type='text' id="lote_<?=$i?>"  class="input" rel="lote" value="<?php echo $lote ;?>">
                                </td>
                            <?php } ?>
                        <?php } ?>
                            <td align='left'>
                        <?php if(!in_array($login_fabrica, array(195))){ ?>
                                <strong>Defeito Reclamados</strong>
                                <select style="width:70% !important" class='input' name='defeito_reclamado_<?=$i?>' id='defeito_reclamado_<?=$i?>' <?php echo $disabledMondial;?>>
                                    <option> </option>
                                    <?php
                                        if (!empty($produto_defeito_reclamado)) {
                                            $cond_defeito_produto = " AND tbl_produto.produto = $produto_defeito_reclamado ";
                                        } else {
                                            $cond_defeito_produto = "";
                                        }
                                        if ($login_fabrica == 186) {
                                            $sql = "SELECT familia
                                                      FROM tbl_produto
                                                     WHERE referencia = '{$produto_referencia}'
                                                       AND fabrica_i  = {$login_fabrica}
                                                     LIMIT 1";
                                            $res = pg_query($con,$sql);

                                            if (pg_num_rows($res) > 0) {
                                                $familia = pg_fetch_result($res,0,0);
                                                $cond_1 = "AND tbl_produto.familia = {$familia}";
                                            }

                                            $sqldef = "SELECT DISTINCT DR.defeito_reclamado,
                                                           DR.descricao
                                                        FROM tbl_diagnostico DI
                                                        JOIN tbl_defeito_reclamado DR ON DR.defeito_reclamado = DI.defeito_reclamado
                                                        JOIN tbl_produto              ON tbl_produto.familia  = DI.familia AND tbl_produto.fabrica_i=$login_fabrica
                                                        WHERE DI.fabrica = $login_fabrica
                                                        AND DI.ativo IS TRUE
                                                        $cond_1
                                            ";
                                        } else {

                                            $sqldef = "
                                                SELECT DISTINCT
                                                    tbl_defeito_reclamado.descricao,
                                                    tbl_defeito_reclamado.defeito_reclamado
                                                FROM tbl_diagnostico
                                                JOIN tbl_defeito_reclamado ON tbl_diagnostico.defeito_reclamado = tbl_defeito_reclamado.defeito_reclamado
                                                JOIN tbl_produto ON tbl_diagnostico.familia = tbl_produto.familia $and_linha
                                                WHERE tbl_diagnostico.fabrica = $login_fabrica
                                                $cond_defeito_produto
                                                $cond_ativo
                                                ORDER BY tbl_defeito_reclamado.descricao;
                                            ";
                                        }
                                        $resdef = pg_query($con,$sqldef);


                                        if (pg_num_rows($resdef)>0) {
                                            for ($w=0;$w<pg_num_rows($resdef);$w++) {
                                                unset($selected);
                                                $xdefeito_reclamado = pg_fetch_result($resdef,$w,defeito_reclamado);
                                                $descricao          = pg_fetch_result($resdef,$w,descricao);
                                                $descricao          = substr($descricao,0,30);
                                                if ($defeito_reclamado == $xdefeito_reclamado) {
                                                    $selected = "SELECTED";
                                                }
                                                echo "<option value='$xdefeito_reclamado' $selected> $descricao</option>";
                                            }
                                        } ?>
                                </select>
                        <?php } ?>

                                
                                <? if ($i == 1) { ?>
                                    <?php if(in_array($login_fabrica, array(189))){ ?>
                                    <img alt="Remover Linha"  class="btn-limpa-linha-os bt-linha-<?=$i?>"  data-iditem="<?php echo $hd_chamado_item_mondial;?>" data-linha="<?=$i?>" style="cursor: pointer;width:17px;vertical-align: top;" title="Remover Linha" src="imagens/btn_delete.png">
                                <?php }?>
                                    <img class="btn-add-os" onclick='add_linha()' style="cursor: pointer;width:17px;vertical-align: top;" title="Adicionar" src="imagens/Plus.png">

                                <? } else { ?>
                                    <img alt="Remover Linha" data-iditem="<?php echo $hd_chamado_item_mondial;?>" class="btn-remove-os" data-linha="<?=$i?>" style="cursor: pointer;width:17px;vertical-align: top;" title="Remover Linha" src="imagens/btn_delete.png">
                                <? }?>
                            </td>
                <?php
                    }else{
                ?>
                        <td>
                                <? if ($i == 1) { ?>
                                    <img class="btn-add-os" onclick='add_linha()' style="cursor: pointer;width:17px;vertical-align: top;" title="Adicionar" src="imagens/Plus.png">
                                <? } else { ?>
                                    <img alt="Remover Linha" class="btn-remove-os" data-linha="<?=$i?>" style="cursor: pointer;width:17px;vertical-align: top;" title="Remover Linha" src="imagens/btn_delete.png">
                                <? }?>
                        </td>
                <?php
                    }
                ?>

                        </tr>
                    <?
            } ?>
                    </tbody>
                    <INPUT TYPE='hidden' NAME='qtde_produto_antes' value='<?=$qtde_produto_antes?>' id='qtde_produto_antes'>
                    <INPUT TYPE='hidden' NAME='qtde_produto' value='<? echo $i= $i-1;?>' id='qtde_produto'>
                </table>
            </td>
        </tr>
    </table>
    <?php
        } else {
     ?>
    <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
        <?php if ($fab_filtra_prod_familia): ?>
        <tr>
            <td><label for="familia_produto" style="font-weight:bold">FamÃ­lia do Produto:</label></td>
            <td>
                <?=array2select(
                    "familia_produto", "familia_produto",
                    pg_fetch_pairs($con, "SELECT familia, descricao FROM tbl_familia WHERE fabrica = $login_fabrica AND ativo"),
                    $familia,
                    null, 'Familia', true
                );
                ?>
            </td>
            <td colspan="2" width="50%"></td>
        </tr>
        <?php endif; ?>

        <?php if($login_fabrica == 161){ ?>

        <tr>
            <td align='left' width="200px"><strong>Série:</strong></td>
            <td align='left' width="200px">
                <input type="hidden" name="hd_chamado_item_<?=$i?>" value="<?=$hd_chamado_item_fricon?>">
                <input type="hidden" name="serie_anterior_<?=$i?>" value="<?php echo $serie; ?>" />
                <input name="serie" id="serie"  maxlength="20"  class="input" value="<?php echo $serie;?>" />
                <img src='imagens/lupa.png' id="lupa_pesquisa_serie" border='0' align='absmiddle'
                style='cursor: pointer'
                onclick="javascript: fnc_pesquisa_serie (document.frm_callcenter.produto_referencia_<?=$i;?>,document.frm_callcenter.produto_nome_<?=$i;?>,'serie',mapa_linha,document.frm_callcenter.serie, <?=$i?>)">
            </td>
            <td width="200px">
                <?php $checked_sem_serie = (strlen($callcenter) > 0 && strlen($serie) == 0) ? "checked" : ""; ?>
                <input type="checkbox" name="produto_sem_serie" id="produto_sem_serie" value="t" <?php if($produto_sem_serie == "t" && strlen($checked_sem_serie) == 0){ echo "checked"; }else{ echo $checked_sem_serie; } ?> /> Produto Sem número de Série
            </td>
        </tr>

        <?php }

        if (in_array($login_fabrica, array(169, 170))) {
            $produto_generico_aux = true;
        }elseif ($usaProdutoGenerico) {
            $produto_generico_aux = true;
        }
        ?>

        <tr>
            <?php if ($login_fabrica == 183){ ?>
            <td align='left' class='numero_serie' id='lb_num_serie' style="<?=(in_array($login_fabrica, array(169, 170)) && (empty($serie) || !isset($serie)))? 'display:none' : '' ?>">
                <strong>Série:</strong>
            </td>
            <td align='left' id='num_serie_cadastro'>
                <input type="hidden" name="serie_anterior" value="<?= $serie; ?>" />
                <input name="serie" id="serie" maxlength="20" class="<?= ($login_fabrica==24) ? 'input_req' : 'input' ?>" value="<?php echo $serie;?>" />
                <img class='img_lupa' src='imagens/lupa.png' border='0' align='absmiddle' style='cursor: pointer' onclick="javascript: fnc_pesquisa_serie (document.frm_callcenter.produto_referencia,document.frm_callcenter.produto_nome,'serie',mapa_linha,document.frm_callcenter.serie)">
            </td>
            <?php } ?>
            <? if(!$produto_generico_aux){ ?>
            <td align='left'><?=$campos_obrig;?><strong><?= ($login_fabrica == 101) ? "Referência/SKU:" : "Referência:" ?></strong><?=$fx_cmp_obg;?></td>
            <td align='left'>
                <input type="hidden" name="produto_referencia_anterior" value="<?php echo $produto_referencia;  ?>" />
                <?php
                if ((in_array($login_fabrica, array(11,81,114,115,116,120,201,125,128,155,160,161,172)))  or $telecontrol_distrib){

                    if (empty($callcenter)){
                        $mostra_defeito = "mostraDefeitos('Reclamado',document.frm_callcenter.produto_referencia.value);";
                    }

                    if (!empty($callcenter) and empty($defeito_reclamado)) {
                        $mostra_defeito = "mostraDefeitos('Reclamado',document.frm_callcenter.produto_referencia.value);";
                    }

				}else{
					$mostra_defeito = "mostraDefeitos('Reclamado',document.frm_callcenter.produto_referencia.value);";
				}
				?>
				<input name="produto_referencia"
						class="input"
						value='<?= $produto_referencia ;?>'
						<? if (!in_array($login_fabrica, array(81,183))) { ?>
						onchange="fnc_pesquisa_produto2(document.frm_callcenter.produto_referencia,document.frm_callcenter.produto_nome,'referencia', null);
							atualizaQuadroMapas();"
						<?php } ?> type="text" size="15" maxlength="15">
				<img src='imagens/lupa.png' id="lupa_referencia_produto" border='0' align='absmiddle'
				style='cursor: pointer' onclick="fnc_pesquisa_produto2(document.frm_callcenter.produto_referencia,document.frm_callcenter.produto_nome,'referencia', null);
					atualizaQuadroMapas();">
			</td>
			<td align='left'><?= $campos_obrig; ?><strong> <?= ($login_fabrica == 101) ? "Descrição/Modelo:": "Descrição:" ?></strong><?=$fx_cmp_obg;?></td>
			<td align='left'>
				<input type="hidden" name="produto_nome_anterior" value="<?php echo $produto_nome; ?>" />
				<input type='hidden' name='produto' value="<? echo $produto; ?>">
				<input name="produto_nome"  class="input" value="<?php echo $produto_nome ;?>"
				<? if($produto_nome != "" && $novaTelaOs == true){
					echo "localizarNovoFaq('','')";
				}
				if (!in_array($login_fabrica, array(81,161,183))) {  ?>
				<? if ($login_fabrica <> 52) { ?>
					onblur="fnc_pesquisa_produto2 (document.frm_callcenter.produto_referencia,document.frm_callcenter.produto_nome,'descricao', null);
				<? } if ($login_fabrica <> 51){
				 	echo $mostra_defeito;
				 } ?>
					 atualizaQuadroMapas();"
				<?php } ?> type="text" size="35" maxlength="80">
				<img src='imagens/lupa.png' id="lupa_descricao_produto" border='0' align='absmiddle'
				style='cursor: pointer'
				onclick='clearTimeout(janela_descricao); fnc_pesquisa_produto2(document.frm_callcenter.produto_referencia,document.frm_callcenter.produto_nome,"descricao", null, <?=$i?>);'>

                <?php if($validaGarantiaCallcenter){ ?>
                    <input type='hidden' name='produto_garantia' value='<?=$produto_garantia?>'>
                <?php } ?>
            </td>
                <?php if($login_fabrica == 42){?>
                    <td><button type="button" style="display: none;" id="consultar_informacoes_tecnicas">Consultar Informações Técnicas</button></td>
            <?php
                }
            }else{

                $disabled_produto = ($login_fabrica == 171) ? 'disabled="disabled"' : '';

                if(in_array($login_fabrica, array(169,170))){
                    if(strlen(trim($callcenter)) > 0 AND strlen(trim($produto)) > 0 and !empty($defeito_reclamado_banco)){
                        $display_lupa = "style='display:none;'";
                        $disabled_select = "disabled";
                    }else{
                        $display_lupa = "";
                        $disabled_select = "";
                    }

                    echo "<input type='hidden' name='produto_garantia' value='$produto_garantia'>";
                }
                echo "<input type='hidden' name='produto' value='$produto'>
                    <input type='hidden' name='produto_referencia' value='$produto_referencia'>
                ";

                if(!empty($produto_nome)){
                    if (!strpos($produto_nome, " - ")) {
                        $produto_nome = $produto_referencia." - ".$produto_nome;
                    }
                }
                echo '<td align="left">
                        <strong>Produto</strong>
                    </td>
                    <td align="left">';

                if (in_array($login_fabrica, array(169,170,171))) {   ?>
                    <div style="display:inline-block; position:relative;">
                <?php
                }
                    echo  '<input name="produto_nome" '.$disabled_produto.' class="input" value="'.$produto_nome.'" type="text" size="40" maxlength="80" readonly>';

                if (in_array($login_fabrica, array(169,170,171))) { ?>
                        <div onclick="javascript: pesquisa_produto_generico()"  style="position:absolute; left:0; right:0; top:0; bottom:0;"></div>
                    </div>
                <?php
                }

                echo '<img class="img_lupa"'.$display_lupa.'src="imagens/lupa.png" border="0" align="absmiddle" style="cursor: pointer" onclick="javascript: pesquisa_produto_generico()">
                        <input type="hidden" name="setor_atividade" id="setor_atividade" value="'.$setor_atividade.'">
                        <input type="hidden" name="garantia_estendida" id="garantia_estendida" value="'.$garantia_estendida.'">
                        <input type="hidden" name="produto_nome_generico" value="'.$_POST["produto_nome_generico"].'">
                    </td>';
            }
            if(in_array($login_fabrica, [167, 203])){ //HD-3428316

                if(strlen($produto) > 0){

                    $sqf = "SELECT
                                tbl_familia.descricao
                            FROM tbl_produto
                            INNER JOIN tbl_familia ON tbl_familia.familia = tbl_produto.familia
                            WHERE
                                tbl_produto.produto = {$produto}
                                AND tbl_produto.fabrica_i = {$login_fabrica}
                                AND tbl_familia.fabrica = {$login_fabrica}";
                    $ref = pg_query($con, $sqf);

                    if(pg_num_rows($ref) > 0){
                        $familia_descricao = pg_fetch_result($ref, 0, "descricao");
                    }

                }

                if(strlen(trim($contador)) == 0 && strstr($familia_descricao, "Impressora") == false && strstr($familia_descricao, "Multifunciona") == false){
                    $display_167 = "style='display: none'";
                }
            ?>
                <td align="left" <?=$display_167?> class='contador'>
                    <strong>Contador:</strong> &nbsp;
                    <input type='text' <?=$display_167?> size='7' class='contador' name='contador' maxlength="6" value="<?=$contador?>">
                </td>
                <input type='hidden' id="linha_descricao" name='linha_descricao' value="<?=$linha_descricao?>">
                <input type='hidden' id="familia_descricao" name='familia_descricao' value="<?=$familia_descricao?>">
            <?php
            }

            if(in_array($login_fabrica, array(158))){
                ?>
                 <td align='left'><strong>Tensão</strong></td>
                 <td align='left'>
                    <input type='text' class="input" name='tensao' id='tensao'   value='<?=$_POST['tensao']? $_POST['tensao']:$array_campos_adicionais['tensao'];?>'>
                 </td>
                 <td align='left'><strong>Tempo de Instalação</strong></td>
                 <td align='left'>
                    <input type='text' class="input" name='tempo_instalacao' id='tempo_instalacao'   value='<?=$_POST['tempo_instalacao']? $_POST['tempo_instalacao']: $array_campos_adicionais['tempo_instalacao'];?>'>
                 </td>
                <?php
            }
            ?>

             <? if (in_array($login_fabrica, array(14,43))) { ?>
                 <td align='left'><strong>Ordem de Montagem</strong></td>
                 <td align='left'>
                 <input type='text' class="input" name='ordem_montagem' size='20'  value='<?=$ordem_montagem;?>'>
                 </td>
                  <?}?>
                <?
                if(in_array($login_fabrica, array(11,104,172))){ // HD-2357100
                    if (strlen($callcenter) > 0) {
                        $sqlReversa = "SELECT abre_os FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter";
                        $resReversa = pg_query($con, $sqlReversa);
                        if(pg_num_rows($resReversa) > 0){
                            $abrePreOS = pg_fetch_result($resReversa, 0, 'abre_os');
                        }
                    }
                }

                if ((in_array($login_fabrica, array(42,81,155,114,122,123,125,162,164,174))) or $telecontrol_distrib) { ?>
                     <td align='left'><strong>NF Valor</strong></td>
                     <td align='left'>
                          <input type='text' class="input" name='valor_nf' id='valor_nf' size='20'  value='<?=$valor_nf;?>'>
                     </td>
                 </tr>
                 <tr>
                <?}?>
                <?php
                if (!in_array($login_fabrica, array(171))) {
                ?>
                    <td align='left'><?=$campos_obrig;?><strong>Voltagem:</strong><?=$fx_cmp_obg;?></td>
                    <td align='left'>
                        <input type="hidden" name="voltagem_anterior" value="<?php echo $voltagem; ?>" />
                        <input name="voltagem" id="voltagem" class="input" value='<?php echo $voltagem;?>' maxlength="5" >
                    </td>
                <?php
                }
                if (in_array($login_fabrica, array(171))) {//hd-3624967 - fputti?>
                                <td align='left' class='pressao_agua_mca'><strong>Pressão da Ãgua (MCA)</strong></td>
                                <td align='left'><input type="text" value="<?= $pressao_agua_mca ?>" name="pressao_agua_mca" id="pressao_agua_mca" class="input" /></td>
                        <?php
                }
                if (!in_array($login_fabrica, array(145,161,171,183))) {
                ?>
                    <td align='left' class='numero_serie' id='lb_num_serie' style="<?=(in_array($login_fabrica, array(169, 170)) && (empty($serie) || !isset($serie)))? 'display:none' : '' ?>">
                        <strong>
                            <?
                            if ($login_fabrica == 158) {
                                if (strlen($produto_referencia) > 0) {
                                    $sqlSerieObrig = "SELECT numero_serie_obrigatorio FROM tbl_produto WHERE referencia = '{$produto_referencia}' AND fabrica_i = {$login_fabrica};";
                                    $resSerieObrig = pg_query($con, $sqlSerieObrig);
                                    if (strlen(pg_last_error()) == 0) {
                                        $serie_obrigatorio = pg_fetch_result($resSerieObrig, 0, numero_serie_obrigatorio);
                                        if ($serie_obrigatorio == 't') {
                                            echo $campos_obrig;
                                        } else {
                                            $serie_obrigatorio = 'f';
                                        }
                                    }
                                }
                            }

                            if (!in_array($login_fabrica, array(137, 160)) and !$replica_einhell) {
                                if ($login_fabrica == 164) {
                                    echo "Série/Lote";
                                } else {
                                    echo "Série:";
                                }
                            } else {
                                echo "nº Lote:";
                            }

                            if ($login_fabrica == 158) {
                                if ($serie_obrigatorio == 't') {
                                    echo $fx_cmp_obg;
                                }
                            }
                            ?>
                        </strong>
                    </td>
                    <td align='left' id='num_serie_cadastro' style="<?=(in_array($login_fabrica, array(169, 170)) && (empty($serie) || !isset($serie)))? 'display:none' : '' ?>">
                        <input type="hidden" name="serie_anterior" value="<?= $serie; ?>" />
                        <img src='imagens/loading_bar.gif' class="loading_serie" style="display: none;">
                        <input name="serie" id="serie" maxlength="20" class="<?= ($login_fabrica==24) ? 'input_req' : 'input' ?>" value="<?php echo $serie;?>" size="11" />
                        <?php
                        if (!in_array($login_fabrica, array(138,142,160)) and !$replica_einhell) {
                        ?>
                            <img class='img_lupa' src='imagens/lupa.png' border='0' align='absmiddle' style='cursor: pointer'
                            onclick="javascript: fnc_pesquisa_serie (document.frm_callcenter.produto_referencia,document.frm_callcenter.produto_nome,'serie',mapa_linha,document.frm_callcenter.serie)">
                        <?php
                        }

                        if($login_fabrica == 74 AND ((!empty($produto) AND !empty($serie)) or empty($callcenter))){
                            if(!empty($serie)) {
                                $sql_ps = "SELECT observacao
                                    FROM tbl_produto_serie
                                    WHERE produto = $produto
                                    and '$serie'
                                    between serie_inicial and serie_final";
                                $res_ps = pg_query($con, $sql_ps);
                                if(pg_num_rows($res_ps)>0){
                                    $observacao = pg_fetch_result($res_ps, 0, observacao);
                                    $style = "display:block;";
                                }else{
                                    $style = "display:none;";
                                }
                            }else{
                                $style = "display:none;";
                            }
                            echo "<p class='machine' style='$style font-size:14px; color:red;'>$observacao</p>";
                        }

                        ?>
                    </td>
                <?php if($login_fabrica == 160 or $replica_einhell){?>
                    <td align='left'><strong>Versão do Produto:</strong></td>
                    <td><input type='text' name='versao' id='versao' maxlength="10" class='input' value='<?=$versao?>'></td>
                <? }
                    if($login_fabrica == 162){
                            $mostrar_imei = " style='display:none' ";

                            if($linha_informatica == 'f'){
                                $mostrar_imei = " style='display:block' ";
                            }

                    ?>
                        <td align='left' valign:'bottom' id="label_imei" <?=$mostrar_imei?> ><strong>IMEI:</strong></td>
                        <td><input type='text' name='imei' id='imei' maxlength="18" class='input' value='<?=$imei?>' <?=$mostrar_imei ?> >
                        <input type='hidden' name='linha_informatica' id='linha_informatica' maxlength="18" class='input' value='<?=$linha_informatica?>' >
                        </td>
                    <?php }
                 ?>
                <?php
                    if ($login_fabrica == 74) {
                    ?>
                        <td id="serie_adcional">
                        <?php
                            if (!empty($serie)) {

                                $sql_s = "SELECT
                                              tbl_hd_chamado.hd_chamado
                                            FROM tbl_hd_chamado
                                              JOIN tbl_hd_chamado_extra USING(hd_chamado)
                                            WHERE tbl_hd_chamado_extra.serie = '{$serie}'
                                              AND tbl_hd_chamado.categoria = 'garantia_adicional'
                                              AND tbl_hd_chamado.fabrica_responsavel = {$login_fabrica}; ";
                                $res_s = pg_query($con,$sql_s);


                                if (pg_num_rows($res_s) > 0) {
                                    $res_hd = array();
                                    for ($s=0; $s < pg_num_rows($res_s) ; $s++) {
                                        $hd_chamado_g = pg_fetch_result($res_s, $s, hd_chamado);
                                        $res_hd[] = $hd_chamado_g;
                                    }
                                    $res_hd = implode(",", $res_hd);
                                    echo "<p style='color:red'><strong>Serie com Garantia Adicional - Protocolo: ".$res_hd."</strong></p>";
                                }
                            }
                            ?>
                        </td>
                    <?php
                    }
                }
                ?>
                <?php
                   if( ((in_array($login_fabrica,array(35))  and $abre_os == 't')) AND !empty($callcenter) ){ ?>
                    </tr>
                    <tr>
                    <td align='left'><strong>Tipo Postagem</strong></td>
                     <td align='left'>
                        <select name='tipo_postagem' id='tipo_postagem'>
                            <option value=''>Escolha</option>
                            <option value='A' <?php if ($tipo_postagem == 'A'){ echo "Selected";}?>> Postagem</option>
                    </td>
                    <td align='left'><strong>Modo de Envio</strong></td>
                     <td align='left'>
                        <select name='sedex_pac' id='sedex_pac'>
                            <option value=''>Escolha</option>
                            <option value='04677' <?php if ($sedex_pac == "04677"){ echo "Selected";}?>>PAC</option>
                    </td>
                    <td align='left'>
                        <input name="btn_lgr" id="btn_lgr" value='Solicitar Logistica Reversa Correios' type='button' onclick='solicitaPostagem(<?=$callcenter?>)'>
                    </td>
                <?php }

                if( ((in_array($login_fabrica,array(11,104,172))  AND $abrePreOS == 't')) AND !empty($callcenter) ){ // HD-2357100
                    $sedex_value = (in_array($login_fabrica, array(11,172))) ? "04170" : "40517";
                    $pac_value   = "04677";
                ?>
                    <td align='left'><strong>Tipo Postagem</strong></td>
                     <td align='left'>
                        <select name='tipo_postagem' id='tipo_postagem'>
                            <option value=''>Escolha</option>
                            <option value='A' <?PHP if ($tipo_postagem == 'A'){ echo "Selected";}?>>Autorização de Postagem</option>
                    </td>

                    <td align='left'><strong>Modo de Envio</strong></td>
                     <td align='left'>
                        <select name='sedex_pac' id='sedex_pac'>
                            <option value=''>Escolha</option>
                            <option value='<?=$sedex_value?>' <?PHP if ($sedex_pac == $sedex_value){ echo "Selected";}?>>SEDEX</option>
                            <option value='<?=$pac_value?>' <?PHP if ($sedex_pac == $pac_value){ echo "Selected";}?>>PAC</option>
                    </td>
                <?php
                 }

                if($login_fabrica == 74) { ?>
                <td align='left'><strong>Data de Fabricação:</strong></td>
                <td align='left'>
                    <input name="dt_fabricacao" readonly="readonly" id="dt_fabricacao" class="input" value="<?php echo $dt_fabricacao;?>" size="15" maxlength="10" />
                </td>
            <? } ?>
                <?if (in_array($login_fabrica, array(43,14,157))) {
                    if(empty($codigo_postagem) && !empty($callcenter)){
                        $sql = "SELECT codigo_postagem FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter";
                        $resCodigo = pg_query($con,$sql);
                        if(pg_num_rows($resCodigo) > 0){
                            $codigo_postagem = pg_fetch_result($resCodigo, 0, "codigo_postagem");
                        }
                    }

                    ?>
                    <td align='left'><strong>
                    Codigo de Postagem</strong>
                    </td>
                    <td align='left'>
                    <input type='text' class="input" name='codigo_postagem' size='30' value='<?=$codigo_postagem;?>'>
                    </td>
                <?}?>
        </tr>
        <?php if($login_fabrica == 158){ 
            if($data_fabricacao == "" || strlen($data_fabricacao) == 0){
                $data_fabricacao = $_POST["data_fabricacao"];
            }
            ?>
            <tr>
                <td><b>Data Fabricação<b></td>
                <td><input name="data_fabricacao" id="data_fabricacao" value="<?=$data_fabricacao?>" readonly /></td>
                <td><b>Data Venda<b></td>
                <td><input name="data_venda" id="data_venda" value="<?= $data_venda;?>" readonly />
                </td>
            </tr>
        <?php }

        if (in_array($login_fabrica, array(169,170,158)) OR $usaScriptFalha OR $defeitoReclamadoCadastroDefeitoReclamadoCliente){

            if($usaScriptFalha OR in_array($login_fabrica, array(169,170))){
                if(strlen(trim($callcenter)) > 0 AND strlen(trim($produto)) > 0 and !empty($defeito_reclamado_banco)){
                    $display_lupa = "style='display:none;'";
                    $disabled_select = "disabled";
                }else{
                    $display_lupa = "";
                    $disabled_select = "";
                }
            }
            if ($defeitoReclamadoCadastroDefeitoReclamadoCliente == 't' || in_array($login_fabrica, [177])){
        ?>
                <tr>
                    <td>
                        <strong>Reclamação Cliente:</strong>
                    </td>
                    <td align='left'>
                        <input name='hd_extra_defeito' <?=$maxlength_169?> id='hd_extra_defeito' size='30' class='input' value='<?= $hd_extra_defeito; ?>'>
                    </td>
                    <?php if (in_array($login_fabrica, [177])) { ?>
                            <td align='left'><strong>Lote:</strong></td>
                            <td align='left'><input type='text' name='lote' id='lote' class="input" value='<?=$lote?>' size="30" >
                            </td>
                    <?php } ?>
                </tr>
        <?php } ?>
            <tr>
                <?php
                if($login_fabrica != 158){
                ?>
                <td><strong>Defeitos Reclamados:</strong></td>
                <td align='left'>
                    <div id='div_defeitos' style='display:inline; Position:relative;background-color: #e6eef7;width:100%'>
                        <select id="defeito_reclamado"  name="defeito_reclamado" >
                            <option value="" <?=$disabled_select?> >Selecione o Defeito</option>
                            <?php
                                if ($login_fabrica == 175){
                                    $sql_linha_produto = "
                                        SELECT  tbl_linha.linha
                                        FROM    tbl_produto
                                        JOIN    tbl_linha ON tbl_linha.linha = tbl_produto.linha
                                        WHERE   tbl_produto.referencia  = '$produto_referencia'
                                        AND     tbl_linha.fabrica     = $login_fabrica
                                        AND     tbl_produto.fabrica_i   = $login_fabrica; ";
                                    $res_linha_produto = pg_query($con,$sql_linha_produto);
                                    $produtoLinhaFamilia = pg_fetch_result($res_linha_produto,0,0);
                                }else{
                                    $sql_familia_produto = "
                                        SELECT  familia
                                        FROM    tbl_produto
                                        JOIN    tbl_familia USING (familia)
                                        WHERE   tbl_produto.referencia  = '$produto_referencia'
                                        AND     tbl_familia.fabrica     = $login_fabrica
                                        AND     tbl_produto.fabrica_i   = $login_fabrica; ";
                                    $res_familia_produto = pg_query($con,$sql_familia_produto);
                                    $familia_produto = pg_fetch_result($res_familia_produto,0,0);
                                    $produtoLinhaFamilia = pg_fetch_result($res_familia_produto,0,0);
                                }

                                if ($produtoLinhaFamilia) {

                                    if ($login_fabrica == 175){
                                        $cond_linha_familia = " AND tbl_diagnostico.linha = {$produtoLinhaFamilia}";
                                    }else{
                                        $cond_linha_familia = " AND tbl_diagnostico.familia = {$produtoLinhaFamilia}";
                                    }

                                    $sql_diagnostico_reclamado = "
                                        SELECT  DISTINCT
                                                tbl_defeito_reclamado.defeito_reclamado,
                                                tbl_defeito_reclamado.descricao
                                        FROM    tbl_defeito_reclamado
                                        JOIN    tbl_diagnostico ON  tbl_defeito_reclamado.defeito_reclamado = tbl_diagnostico.defeito_reclamado
                                                                AND tbl_diagnostico.fabrica                 = {$login_fabrica}
                                                                AND tbl_diagnostico.ativo                   IS TRUE
                                        WHERE   tbl_defeito_reclamado.fabrica   = {$login_fabrica}
                                        {$cond_linha_familia}
                                        ORDER BY      tbl_defeito_reclamado.descricao
                                    ";
                                    $res_diagnostico_reclamado = pg_query($con, $sql_diagnostico_reclamado);

                                    if (pg_num_rows($res_diagnostico_reclamado) > 0) {
                                        for ($i = 0;$i < pg_num_rows($res_diagnostico_reclamado); $i++){
                                            $xdefeito_reclamado           = pg_result($res_diagnostico_reclamado, $i, 0);
                                            $xdefeito_reclamado_descricao = pg_result($res_diagnostico_reclamado, $i, 1);
                                            $selected = ($defeito_reclamado == $xdefeito_reclamado) ? "SELECTED" : null;
                                            if(strlen(trim($callcenter)) > 0 && !empty($defeito_reclamado_banco)){
                                                $xdisabled = ($defeito_reclamado != $xdefeito_reclamado) ? "disabled" : null;
                                            }
                                            ?>
                                            <option value="<?echo $xdefeito_reclamado?>" <?=$xdisabled?> <?=$selected?>><?= $xdefeito_reclamado_descricao?></option>
                                        <? }
                                    }
                                }
                            ?>
                        </select>
                    </div>
                    <input type="hidden" name="defeito_reclamado_anterior" id="defeito_reclamado_anterior" value="<?=$xdefeito_reclamado?>" >
                </td>
                <?php
                }

                if (!in_array($login_fabrica, [175]) AND $usaScriptFalha == "t") {
                ?>
                    <td>
                        <strong>Reclamação Cliente:</strong>
                    </td>
                    <td align='left'>
                        <?php if ($login_fabrica == 183){ ?>
                                <textarea name='hd_extra_defeito' <?=$maxlength_169?> id='hd_extra_defeito' size='50' class='input' value='<?= $hd_extra_defeito; ?>'><?= $hd_extra_defeito; ?></textarea>
                        <?php }else{ ?>
                                <input name='hd_extra_defeito' <?=$maxlength_169?> id='hd_extra_defeito' size='50' class='input' value='<?= $hd_extra_defeito; ?>'>
                        <?php } ?>
                    </td>
                <?php
                }
                ?>
               <?php
                if ($login_fabrica == 174) {
                ?>
                    <td>
                        <strong>Entregue em:</strong>
                    </td>
                    <td align='left'>
                        <input name='hd_extra_data_entrega' id='hd_extra_data_entrega' size='10'rel="data" class='input' value='<?= $hd_extra_data_entrega; ?>'>
                    </td>
                <?php
                }
                ?>
            </tr>
            <?php
                if ($usaScriptFalha OR in_array($login_fabrica, array(169,170))){
                    if (strlen(trim($callcenter)) > 0){
                        $sql = "SELECT  hd_chamado_script_falha,
                                        ultima_pergunta,
                                        ultima_resposta,
                                        instrucao,
                                        hd_chamado,
                                        historico_resolucao
                                FROM tbl_hd_chamado_script_falha
                                WHERE fabrica = {$login_fabrica}
                                AND hd_chamado = {$callcenter}";
                        $res = pg_query($con, $sql);

                        if (pg_num_rows($res) > 0){
                            $hd_chamado_script_falha = pg_fetch_result($res, 0, 'hd_chamado_script_falha');
                            $ultima_pergunta_script = pg_fetch_result($res, 0, 'ultima_pergunta');
                            $ultima_resposta_script = pg_fetch_result($res, 0, 'ultima_resposta');
                            $ultima_instrucao_script = pg_fetch_result($res, 0, 'instrucao');
                            $script_resolution = pg_fetch_result($res, 0, 'historico_resolucao');

                            $display_script = "";
                            $display_script_resolution = "";
                            $bnt_script_disabled = "disabled='true'";
                        }else{
                            $display_script = "style='display:none;'";
                            $display_script_resolution = "style='display:none;'";
                            $bnt_script_disabled = "";
                        }
                    }else{
                        $display_script_resolution = "style='display:none;'";

                        if (strlen(trim($script_resolution)) > 0){
                            $display_script = "";
                            $display_script_resolution = "";
                            $bnt_script_disabled = "disabled='true'";
                        }else if(empty(trim($defeito_reclamado))){
                            $display_script = "style='display:none;'";
                            $bnt_script_disabled = "";
                        }
                    }

                    if(empty(trim($script_resolution)) && !empty($defeito_reclamado) && !empty($produto)){
                        $sql = "
                            SELECT sf.*
                            FROM tbl_script_falha sf
                            INNER JOIN tbl_produto p ON p.familia = sf.familia AND p.fabrica_i = {$login_fabrica}
                            WHERE sf.fabrica = {$login_fabrica}
                            AND sf.defeito_reclamado = {$defeito_reclamado}
                            AND p.produto = {$produto}
                        ";
                        $res = pg_query($con, $sql);

                        if (pg_num_rows($res) > 0) {
                            $script_falha = pg_fetch_result($res, 0, "script_falha");
                            $json_script = pg_fetch_result($res, 0, "json_script");
                            $json_execucao_script = pg_fetch_result($res, 0, "json_execucao_script");
                            $familia_script = pg_fetch_result($res, 0, "familia");
                            $display_script = "";
                            $bnt_script_disabled = "";
                        } else {
                            $display_script = "style='display:none;'";
                            $bnt_script_disabled = "";
                        }
                    }
                    if (strlen(trim($script_resolution)) > 0 && preg_match("/\<br\/\>|\<br\s\/\>|<br>/", $script_resolution)) {
                        $script_resolution = preg_replace("/\<br\/\>|\<br\s\/\>|<br>/", "\n", $script_resolution);
                        $script_resolution = preg_replace("/\s{2,}/", "\n", $script_resolution);
                    }
            ?>
                    <tr id='bloco_script_falha' <?=$display_script?>>
                        <td >
                            <input type="hidden" name="script_falha" id='script_falha' value='<?=$script_falha?>'>
                            <input type="hidden" name="json_script" id='json_script' value='<?=$json_script?>'>
                            <input type="hidden" name="json_execucao_script" id='json_execucao_script' value='<?=$json_execucao_script?>'>
                            <input type="hidden" name="familia_script" id='familia_script' value='<?=$familia_script?>'>

                            <!-- Função executarScript esta em: plugins/rappid/script_midea_callcenter.php -->
                            <button type='button' id='executar_script' <?=$bnt_script_disabled?> onclick="executarScript('<?=$tab_atual?>');" style="width: 155px; height: 30px; margin-top: 6px; margin-bottom: 6px;" >Executar Script Falha</button>
                        </td>
                    </tr>
            <?php
                }
                $display_tr_instalador = (!empty($garantia_estendida)) ? "table-row" : "none";
            ?>
                <tr class="tr-instalador" style="display: <?=$display_tr_instalador?>;" >
                    <td align="left"><strong>Instalador:</strong></td>
                    <td align="left" colspan="6" >
                        <input name="instalador_id" id="instalador_id" value="<?=$instalador_id?>" type="hidden" />
                        <input name="instalador_nome"  id="instalador_nome" class="input" type="text" style="width: 250px;" value='<?echo $instalador_nome ;?>'>
                        <img src='imagens/lupa.png' border='0' align='absmiddle' style='cursor: pointer'
                            onclick="javascript: fnc_pesquisa_posto_tab (
                            document.frm_callcenter.codigo_posto_tab,
                            document.frm_callcenter.posto_nome_tab,
                            'instalador',
                            document.frm_callcenter.posto_fone_tab,
                            document.frm_callcenter.posto_email_tab,
                            document.frm_callcenter.mapa_linha,
                            document.frm_callcenter.posto_tab,
                            document.frm_callcenter.linhas_posto_tab,
                            document.frm_callcenter.instalador_id,
                            document.frm_callcenter.instalador_nome
                            );
                        ">
                    </td>
                <tr>
            <?php
            }
        ?>
		<tr>
			<td align='left' class='nf_compra'><strong><?= ($login_fabrica != 158) ? $campos_obrig : "";?>NF compra:<?= ($login_fabrica != 158) ? $fx_cmp_obg : ""; ?></strong></td>
			<td align='left'>
				<?php if ($nota_fiscal == 'null'){
					$nota_fiscal = '';
				} ?>
					<input type="hidden" name="nota_fiscal_anterior" value="<?php echo $nota_fiscal; ?>"/>
                    <img src='imagens/loading_bar.gif' class="loading_nf" style="display: none;">
				<input name="nota_fiscal" id="nota_fiscal" class="<?php echo ($login_fabrica==24) ? 'input_req' : 'input' ; ?>" value="<?php echo $nota_fiscal;?>" maxlength="10" />
			</td>
			<td align='left' class='nf_data'><strong>
                <?= ($login_fabrica != 158) ? $campos_obrig : ""; ?>
                <?= ($login_fabrica == 186) ? "Data Compra:" : "Data NF:"; ?>
                <?= ($login_fabrica != 158) ? $fx_cmp_obg : ""; ?></strong></td>
			<td align='left'>
				<input type="hidden" name="data_nf_anterior" value="<?php echo $data_nf_anterior; ?>" />
				<input name="data_nf" id="data_nf" class="<?php echo ($login_fabrica==24) ? 'input_req' : 'input' ; ?>" rel="data" value="<?php echo $data_nf ;?>">
			</td>
            <?php
            if (in_array($login_fabrica, [35])) { ?>
                <td align='left'><strong>CNPJ Emitente NF:</strong></td>
                <td align='left'>
                    <input type="text" name="cnpj_emitente_nf" id="cnpj_emitente_nf" class="input" rel="cnpj_emitente_nf" value="<?= $cnpj_emitente_nf ?>" />
                </td>
            <?php
            }

            if ($login_fabrica == 174) { ?>
                <td align='left'><strong>Pedido:</strong></td>
                <td align='left'>
                    <input type="hidden" name="pedido_info_anterior" value="<?= $pedido_info ?>" />
                    <input name="pedido_info" id="pedido_info" class="input" rel="pedido" value="<?= $pedido_info ?>">
                </td>
            <?php
            }
            if($login_fabrica==24 AND strlen($familia) > 0) {
                echo "<td align='left'><strong>Familia:</strong></td>";
                echo "<td align='left'>";
                $sql = " SELECT descricao FROM tbl_familia WHERE familia = $familia ";
                $res = pg_query($con,$sql);
                if(pg_num_rows($res) > 0){
                    echo "".pg_fetch_result($res,0,descricao);
                }
                echo "</td>";
            }?>
        </tr>
        <? //fputi
        //HD 204082: Busca de revenda para fábricas >= 81 e Telecontrol Net
        if(in_array($login_fabrica,array(2,15,30,42,46,50,74)) OR ($login_fabrica >= 80 and $login_fabrica <> 172))  {
        if ($login_fabrica <> 80) {
            if ($nome_revenda == "" && strlen($revenda_nome)) {
                $nome_revenda = $revenda_nome;
            }
        ?>
            <tr>
                <?php
                    if($login_fabrica == 94 AND $posicao == 8){
                        $disabled_rev = "readonly";
                    }else if(in_array($login_fabrica, array(161))){
                        $disabled_rev = "readonly";
                    }
                ?>
                <td align='left'><strong>CNPJ da Revenda:</strong></td>
                <td align='left'>
                    <?php $cnpj_revenda = ($_POST['cnpj_revenda']) ? $_POST['cnpj_revenda'] : $cnpj_revenda ; ?>
                    <input name="cnpj_revenda" id="cnpj_revenda" class="<?php echo (in_array($login_fabrica,array(24,85))) ? 'input_req' : 'input' ; ?>" value="<?php echo $cnpj_revenda;?>"type="text" maxlength="18" <?=$disabled_rev?> />
                    <input name="revenda_tab" id="revenda_tab" type="hidden" value="<?php echo $revenda;?>" />
                    <?php if (in_array($login_fabrica, array(30,169,170)) OR $callcenterLupaRevenda == 't'){ ?>
                        <img src='imagens/lupa.png' border='0' align='absmiddle' style='cursor: pointer'
                            onclick="javascript: fnc_lupa_callcenter_revenda (
                                document.frm_callcenter.cnpj_revenda,
                                'cnpj'
                            );
                        ">
                    <?php } ?>
                </td>
                <td align='left'><strong>Nome da Revenda:</strong></td>
                <td align='left'>
                    <input name="nome_revenda" id="nome_revenda" class="<?php echo (in_array($login_fabrica,array(24,85))) ? 'input_req' : 'input' ; ?>" value="<?php echo $nome_revenda;?>" size=35 maxlength="50" <?=$disabled_rev?> />
                    <?php if (in_array($login_fabrica, array(30,169,170)) OR $callcenterLupaRevenda == 't'){ ?>
                        <img src='imagens/lupa.png' border='0' align='absmiddle' style='cursor: pointer'
                            onclick="javascript: fnc_lupa_callcenter_revenda (
                                document.frm_callcenter.nome_revenda,
                                'nome'
                            );
                        ">
                    <?php } ?>
                </td>
                <?php if($login_fabrica == 30 ) {?>
                    <td align='left'><div  id="logomarca_titulo" style="display: none"><strong>Logomarca:</strong></div></td>
                    <td align='left'><div id="logomarca_select" style="display: none">
                        <select name='logomarca' id='logomarca' style="width: 75%">
                        <option value=''>Escolha</option><?php

                            $sqlLogomarca = "SELECT logomarca, descricao FROM tbl_logomarca WHERE fabrica = $login_fabrica AND ativo IS TRUE ORDER BY descricao";
                            $resLogomarca = pg_query($con,$sqlLogomarca);
                            for ($i = 0; $i < pg_num_rows($resLogomarca); $i++) {

                                $codigo = pg_fetch_result($resLogomarca,$i,'logomarca');
                                $descricao_logomarca    = pg_fetch_result($resLogomarca,$i,'descricao');

                                echo " <option value='".$codigo."' ".($codigo == $codigo_logomarca ? "selected='selected'" : '').">$descricao_logomarca</option>";

                            }?>
					    </select>
                    </div></td>
                <?php } ?>
                <?php
                if (in_array($login_fabrica, [177]) && !empty($callcenter)) {
                    $sqlRevenda = "SELECT tbl_revenda.fone, tbl_revenda.email
                                   FROM tbl_hd_chamado_extra
                                   JOIN tbl_revenda ON tbl_revenda.revenda = tbl_hd_chamado_extra.revenda
                                   WHERE tbl_hd_chamado_extra.hd_chamado = {$callcenter}";
                    $resRevenda = pg_query($con, $sqlRevenda);

                    $telefone_revenda = pg_fetch_result($resRevenda, 0, 'fone');
                    $email_revenda    = pg_fetch_result($resRevenda, 0, 'email');

                ?>
                </tr>
                <tr>
                    <td align='left'><strong>Telefone Revenda</strong></td>
                    <td align='left'>
                        <input name="telefone_revenda" id="telefone_revenda" size=35 maxlength="50" value="<?= $telefone_revenda ?>" />
                    </td>
                    <td align='left'><strong>E-mail Revenda</strong></td>
                    <td align='left'>
                        <input name="email_revenda" id="email_revenda" size=35 maxlength="50" value="<?= $email_revenda ?>" />
                    </td>
                </tr>
                <tr>
                <?php
                }

                if ($login_fabrica == 174) { /*HD - 4382764*/
                    if (!empty($hd_chamado)) {
                        $aux_sql = "SELECT array_campos_adicionais FROM tbl_hd_chamado_extra WHERE hd_chamado = $hd_chamado";
                        $aux_res = pg_query($con, $aux_sql);
                        $aux_arr = json_decode(pg_fetch_result($aux_res, 0, 'array_campos_adicionais'), true);

                        if (isset($aux_arr["nome_loja"])) {
                            if (!empty($aux_arr["nome_loja"])) {
                                $nome_loja = $aux_arr["nome_loja"];
                            }
                        }
                    }
                ?>
                    <td align='left'><strong>Nome da Loja:</strong></td>
                    <td align='left'>
                        <input name="nome_loja" id="nome_loja" class="input" value="<?php echo $nome_loja;?>" size=35 maxlength="50" <?=$disabled_rev?> onkeyup="somenteMaiusculaSemAcento(this);"/>
                    </td>
                <?php }
            if (in_array($login_fabrica, array(174))) {
                    if ($_REQUEST['troca_obrg_val'] == 't' || $troca_obrigatoria_campo == 't'){
                        $show_laudo = "style='display: block;'";
                    }else{
                        $show_laudo = "style='display: none;'";
                    }
                ?>
                <input type='hidden' id='troca_obrg_val' name='troca_obrg_val' value='<?php echo $_REQUEST['troca_obrg_val']; ?>' />
                <td align='left' id="laudo" <?= $show_laudo; ?>><input type='checkbox' name='emitir_laudo' id='emitir_laudo' value='t' <?php if ($_REQUEST['emitir_laudo'] == 't') echo 'checked'; ?>/> <labeL>Emitir laudo de troca de produto para o consumidor</label></td>
            <?php } ?>
            <? if($login_fabrica == 74) { ?>
                <td align='left'>
                    <strong>Telefone da Revenda 1:</strong> <br /> <br />
                    <strong>Telefone da Revenda 2:</strong>
                </td>
                <td align='left'>
                    <input name="fone_revenda" id="fone_revenda" class="input" value="<?php echo $fone_revenda;?>" size="35" maxlength="50" /> <br /> <br />
                    <input name="fone_revenda2" id="fone_revenda2" class="input" value="<?php echo $fone_revenda2;?>" size="35" maxlength="50" />
                </td>
            <? }
                if($login_fabrica == 162){ ?>
                    <td></td>
                    <td></td>
                    <td></td>
                <?}
             ?>
            <?
        }
        ###### Qdo mexer aqui referente a postagem, deve verificar se vai influenciar para Mondial, o codigo está com comentario #Mondial Postagem
        if(($moduloLGRCorreio or $telecontrol_distrib) and !empty($callcenter) and empty($posto)){
            if(!in_array($login_fabrica, array(169,170))){
                echo "</tr><tr><td colspan='3'><font color='#ff0000' size='2' ><b> Para solicitar postagem por favor gravar o atendimento com um posto autorizado.</b></font></td>";
            }
        }elseif(($moduloLGRCorreio or $telecontrol_distrib) and !empty($callcenter) and strlen(trim($posto))>0 and !in_array($login_fabrica, array(11,104,169,170,172,195))) {
                if($login_fabrica <> 104){//HD-3139131
                ?>
                </tr><tr>
                <td>
                <strong>Obs. Postagem</strong>
                </td>
                <td align='left'>
                    <input type='text' name='consumidor_final_nome' id='consumidor_final_nome'  class='input' value='<?=$consumidor_final_nome?>'>
                </td>
                     <td align='left'><strong>Tipo Postagem</strong></td>
                     <td align='left'>
                        <select name='tipo_postagem' id='tipo_postagem'>
                            <option value=''>Escolha</option>
                            <option value='A' <?PHP if ($tipo_postagem == 'A'){ echo "Selected";}?>>Postagem</option>
                            <?php if(!in_array($login_fabrica,array(162,166))){?>
                            <option value='C' <?PHP if ($tipo_postagem == 'C'){ echo "Selected";}?>>Coleta</option>
                            <?php } ?>
                    </td>
                    <td align='left'><strong>Modo de Envio</strong></td>
                       <td align='left'>
                        <select name='sedex_pac' id='sedex_pac'>
                          <option value=''>Escolha</option>
                          <?php
                          if(in_array($login_fabrica, array(151))){
                          ?>
                            <option value='0481-2' <?PHP if ($sedex_pac == '0481-2'){ echo "Selected";}?>>PAC REVERSO</option>
                          <?php
                          } elseif(in_array($login_fabrica, array(80))){
                          ?>
                            <option value='04677' <?PHP if ($sedex_pac == '04677'){ echo "Selected";}?>>PAC REVERSO</option>
                          <?php
                          }else if(!in_array($login_fabrica, array(42,80,162,164,174))){
                            // 81430 - e-SEDEX Reverso
                              // 40584 - SEDEX 10 Reverso
                            $sedex_value = "40517";
                            $pac_value   = "04677";

                            if($login_fabrica == 80){
                                $sedex_value = "04170";
                            }

							if($login_fabrica == 187){
								$sedex_value = "04170";
								$pac_value   = "04677";
							}

                          ?>
                            <option value='<?=$sedex_value?>' <?PHP if ($sedex_pac == $sedex_value){ echo "Selected";}?>>SEDEX</option>
                            <option value='<?=$pac_value?>' <?PHP if ($sedex_pac == $pac_value){ echo "Selected";}?>>PAC</option>

                          <?php
                          }

                          if($login_fabrica == 42){
                            $sedex_value = "4669";
                            $pac_value   = "4162";
                            ?>
                                <option value='<?=$sedex_value?>' <?PHP if ($sedex_pac == $sedex_value){ echo "Selected";}?>>SEDEX</option>
                                <option value='<?=$pac_value?>' <?PHP if ($sedex_pac == $pac_value){ echo "Selected";}?>>PAC</option>
                            <?php
                          }

                          if(in_array($login_fabrica, array(162))){
                            ?>
                            <option value='04677' <?PHP if ($sedex_pac == '04677'){ echo "Selected";}?>>PAC</option>
                            <option value='40517' <?PHP if ($sedex_pac == '40517'){ echo "Selected";}?>>SEDEX Reverso</option>
                            <option value='81043' <?PHP if ($sedex_pac == '81043'){ echo "Selected";}?>>e-SEDEX</option>
                            <?php
                          }

                          if(in_array($login_fabrica, array(164,174))){
                            ?>
                            <option value='04677' <?PHP if ($sedex_pac == '04677'){ echo "Selected";}?>>PAC</option>
                            <option value='04170' <?PHP if ($sedex_pac == '04170'){ echo "Selected";}?>>SEDEX</option>
                            <?php
                          }
                          if(in_array($login_fabrica, array(80))){
                            ?>
                            <option value='04170' <?PHP if ($sedex_pac == '04170'){ echo "Selected";}?>>SEDEX</option>
                            <?php
                          }
                          ?>
                      </td>

                    <?php if($login_fabrica == 162){//HD-3224475
                        switch ($checklist) {
                            case '2':
                                $selecionado = "selected";
                                break;
                            case '4':
                                $selecionado = "selected";
                                break;
                            case '5':
                                $selecionado = "selected";
                                break;
                            case '7':
                                $selecionado = "selected";
                                break;
                        }
                    ?>
                        <td align="left"><strong>Check List</strong>
                            <select id='checklist' name="checklist">
                                <option value=''></option>
                                <option value='2' <?=$selecionado?>>Checklist Celular</option>
                                <option value='4'>Checklist EletrÃ´o</option>
                                <option value='5'>Checklist Documento</option>
                                <option value='7'>Checklist ConteÃºoption>
                            </select>
                        </td>
                    <?php } ?>
                    <?php if ($login_fabrica == 80) {?>
                        <td> <strong>Volumes</strong> </td>
                        <td align='left'>
                            <input type='text' name='volumes' id='volumes'  class='input' value='<?=$volumes?>'>
                        </td>
                    <?php }?>

                    <td align='left'>
                        <input name="btn_lgr" id="btn_lgr" value='Solicitar Logistica Reversa Correios' type='button' onclick='solicitaPostagem(<?=$callcenter?>)'>
                    </td>
                <?
                    }
                }

            if($login_fabrica == 162){//HD-3224475 ?>
                <td style="display: none;" id='td_numero_documento'>
                    <strong>número Documento</strong>
                    <input type="text" name="numero_documento" id='numero_documento' class='input' value="<?=$numero_documento?>">
                </td>
            <?php } ?>
            </tr>

            <?php
                if(in_array($login_fabrica, array(169,170))){
            ?>
                <tr>
                    <?php
                        if (strlen($msg_erro) > 0){
                            $observacao_os = $_POST['observacao_os'];
                        }
                    ?>
                    <td colspan="2" style="width: 50px;"><b>Observações do Callcenter</b> (O que for informado neste campo refletirá na OS para o Posto Autorizado)</td>
                    <td valign='top' colspan="3" >
                        <textarea name="observacao_os" id="observacao_os" class="input" rows="4" cols="100"><?=$observacao_os?></textarea>
                    </td>
                </tr>
                <tr>

                </tr>
            <?php
                }
                if($login_fabrica == 125){

                if($consumidor_revenda == "R"){
                    $display_campos_adicionais_revenda = "";
                }else{
                    $display_campos_adicionais_revenda = "none";
                }

            ?>
                <tr class="campos_adicionais_revenda" style="display:<?=$display_campos_adicionais_revenda ?>">
                    <td>Contato Fixo:</td>
                    <td><input type="text" name="tel_fixo_revenda" id="tel_fixo_revenda" class='input telefone' value="<?= $tel_fixo_revenda ?>"></td>
                    <td>Contato Celular</td>
                    <td><input type="text" name="cel_revenda" id="cel_revenda" class='input telefone' value="<?= $cel_revenda?>"></td>
                </tr>
                <tr class="campos_adicionais_revenda"  style="display:<?=$display_campos_adicionais_revenda ?>">
                    <td>E-mail</td>
                    <td><input type="text" name="email_revenda" id="email_revenda" maxlength="50" class='input' size="35" value="<?=$email_revenda?>"></td>                <td>Responsável</td>
                    <td><input type="text" name="responsavel_revenda" id="responsavel_revenda" size="35" maxlength="50" value="<?= $responsavel_revenda ?>" class='input'></td>
                </tr>
            <? } ?>
        <?  if($login_fabrica == 74){ ?>
            <tr>
                <td align='left'><strong>Data visita técnico:</strong></td>
                <td align='left'>
                    <?php $data_visita_tecnico = ($_POST['data_visita_tecnico']) ? $_POST['data_visita_tecnico'] : $data_visita_tecnico ; ?>
                    <input name="data_visita_tecnico" id="data_visita_tecnico" class="input" rel="data" value="<?php echo $data_visita_tecnico;?>"type="text" maxlength="14"  />
                </td>
                <td align='left'><strong>Garantia:</strong></td>
                <td>
                    <?php
                        $checked_garantia = ($garantia_produto == "f") ? "checked" : "";
                    ?>
                    <input type='radio' name='garantia_produto' value='t' checked> Sim &nbsp;
                    <input type='radio' name='garantia_produto' value='f' <?=$checked_garantia?>>Não
                </td>
            </tr>
        <?
            }
        }

        if(in_array($login_fabrica,array(11,104,172))){ // HD-2357100
            if($moduloLGRCorreio){
                if(!empty($callcenter) AND $abrePreOS == 't') { ?>
                    <td colspan="100%" align='center'>
                        <input name="btn_lgr" id="btn_lgr" value='Solicitar Logistica Reversa Correios' type='button' onclick='solicitaPostagem(<?=$callcenter?>)'>
                    </td>
                <? }
            }
        }
        if($login_fabrica==3) {?>
        <tr>
        <tr>
            <td colspan='2' align='left'>
                <a  href="javascript:fnc_pesquisa_os (document.frm_callcenter.nota_fiscal, 'nota_fiscal')">Clique aqui para ver todas as OSs cadastradas com esta nota fiscal</a>
            </td>
        </tr>
        <?}?>

        <?php

        if(in_array($login_fabrica, array(164)) and !empty($os)){

            $sql_nf = "SELECT nota_fiscal_saida, data_nf_saida FROM tbl_os WHERE os = {$os}";
            $res_nf = pg_query($con, $sql_nf);

            if(pg_num_rows($res_nf) > 0){

                $nota_fiscal_saida = pg_fetch_result($res_nf, 0, "nota_fiscal_saida");
                $data_nf_saida     = pg_fetch_result($res_nf, 0, "data_nf_saida");

                if(strlen($nota_fiscal_saida) > 0 && strlen($data_nf_saida) > 0){

                    list($ano, $mes, $dia) = explode("-", $data_nf_saida);
                    $data_nf_saida = $dia."/".$mes."/".$ano;

                ?>

                    <tr>
                        <td align='left' colspan="2"><strong>Informações de Faturamento (Produto Consertado)</strong></td>
                    </tr>
                    <tr>
                        <td align='left' colspan="2">
                            Nota Fiscal de SaÃ­da: <strong><?php echo $nota_fiscal_saida; ?></strong> <br />
                            Data da NF de SaÃ­da: <strong><?php echo $data_nf_saida; ?></strong>
                        </td>
                    </tr>

                <?php
                    }
                }
            }
        ?>

    </table>
    <?php
    }
    if (in_array($login_fabrica, array(169,170)) OR $usaScriptFalha ){
    ?>
    <div id="resolution" <?=$display_script_resolution?> >
        <table width="100%" border="0">
            <tbody>
                <tr>
                    <td align="left">
                        <div style="padding-top: 4px; padding-bottom: 4px; font: 10px arial;">
                            <strong>Script Falha</strong>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
        <table width="100%" border="0" align="center" cellpadding="2" cellspacing="2" style=" border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;">
            <tr>
                <td align="left" valign="top" width="175"><strong>Resolução do Script de Falha:</strong></td>
                <td>
                    <input type="hidden" name="script_resolution" id="script_resolution" value='<?=$script_resolution?>'>
                    <input type="hidden" name="ultima_pergunta_script" id="ultima_pergunta_script" value="<?=$ultima_pergunta_script?>">
                    <input type="hidden" name="ultima_resposta_script" id="ultima_resposta_script" value="<?=$ultima_resposta_script?>">
                    <input type="hidden" name="ultima_instrucao_script" id="ultima_instrucao_script" value="<?=$ultima_instrucao_script?>">

                    <textarea class='result_resolution' style="width: 900px; height: 200px;" readonly="true"><?=$script_resolution?></textarea>
                </td>
            </tr>
        </table>
    </div>
    <?php
    }
    if($login_fabrica <> 3){ //HD 40086
        if($login_fabrica == 136){

            if(strlen($callcenter) > 0){

                $sql_pedido = "SELECT pedido FROM tbl_hd_chamado_extra WHERE hd_chamado = {$callcenter}";
                // echo nl2br($sql_pedido); exit;
                $res_pedido = pg_query($con, $sql_pedido);

                $pedido = (pg_num_rows($res_pedido) > 0) ? pg_fetch_result($res_pedido, 0, "pedido") : "";

                $link_pedido = (strlen($pedido) > 0) ? "<a href='pedido_cadastro.php?pedido={$pedido}' target='_blank'>{$pedido}</a>" : "";
                $disabled_check = (strlen($pedido) > 0) ? "disabled" : "";
                $checked_check = (strlen($pedido) > 0) ? "checked" : "";

                if(strlen($pedido) == 0){
                    $callcenter = preg_replace("/\D/", "", $callcenter);
                    $sql_status = "SELECT status FROM tbl_hd_chamado WHERE hd_chamado = {$callcenter} AND fabrica = {$login_fabrica}";
                    $res_status = pg_query($con, $sql_status);

                    $status_callcenter = pg_fetch_result($res_status, 0, "status");

                    if($status_callcenter == "Peças Pendentes"){
                        $checked_check = "checked";
                    }

                }

            }else{

                $checked_check = ($_POST["gerar_pedido_posto_interno"] == "t") ? "checked" : "";

            }

        ?>

                <table width="100%" border='0'>
                    <tr>
                        <td align='left'>

                            <input type="checkbox" id="gerar_pedido_posto_interno" name="gerar_pedido_posto_interno" value="t" <?php echo $disabled_check." ".$checked_check; ?> /> GERAR PEDIDO PARA O P.A INTERNO? <?php echo $link_pedido; ?>

                        </td>
                    </tr>
                </table>
        <?php
        }

    if ($login_fabrica == 158) { /*HD - 6088097*/ ?>
        <div id="tabela_garantia" style="display: none;">
            <table width="100%" border='0'>
                <tr>
                    <td align='left'><div style="padding-top: 4px; padding-bottom: 4px; font: 10px arial;"><strong>Tabela de Garantia</strong></div></td>
                </tr>
            </table>
            <div id="tabela_garantia_colar"></div>
        </div>
    <?php } ?>

    <?php
        if ($login_fabrica == 189) {
                $display_ped = "display:none;";
            if (strlen($pedido) > 0) {
                $display_ped = "";
            }
    ?>
        <table class='mostra_dados_pedidos' width="100%" border='0' style="<?php echo $display_ped;?>">
            <tr>
                <td align='left'><div style="padding-top: 4px; padding-bottom: 4px; font: 10px arial;"><strong>ObservaçÃµes do Pedido</strong></div></td>
            </tr>
        </table>
        <table class='mostra_dados_pedidos' width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style='<?php echo $display_ped;?> border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <tr>
                <td align='left' class="txt_obs_pedido">
                    <?php echo utf8_decode($xobs_pedido);?>
                </td>
            </tr>
        </table>
        <table class='mostra_dados_pedidos' width="100%" border='0' style="<?php echo $display_ped;?>">
            <tr>
                <td align='left'><div style="padding-top: 4px; padding-bottom: 4px; font: 10px arial;"><strong>Entrega</strong></div></td>
            </tr>
        </table>
        <table class='mostra_dados_pedidos' width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style='<?php echo $display_ped;?> border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <tr>
                <td align='left' width='250'><strong>Endereço de entrega:</strong></td>
                <td align='left' colspan="6" class='txt_obs_entrega'><?php echo $xdados_entrega;?></td>
            </tr>
            <tr>
                <td align='left' width='250'><strong>Nome Transportadora:</strong></td>
                <td align='left' class='txt_nome_transp'><?php echo $xnome_transportadora;?></td>
                <td align='left' width='250'><strong>Contato Transportadora:</strong></td>
                <td align='left' class='txt_contato_transp'><?php echo $xcontato_transportadora;?></td>
                <td align='left' width='250'><strong>Fone Transportadora:</strong></td>
                <td align='left' class='txt_fone_transp'><?php echo $xfone_transportadora;?></td>
                <td align='left' width='250'><strong>Cidade/UF Transportadora:</strong></td>
                <td align='left' class='txt_end_transp'><?php echo $xcidade_transportadora .'/'. $xestado_transportadora;?></td>
            </tr>
        </table>

    <?php }?>
    <table width="100%" border='0'>
        <tr>
            <td align='left'><div style="padding-top: 4px; padding-bottom: 4px; font: 10px arial;"><strong><?php echo ($login_fabrica == 42) ? "Coleta de Produtos" : "Mapa da Rede"; ?></strong></div></td>
        </tr>
    </table>
    <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
        <tr>
            <?php
                //HD 211895: Habilitar abertura de pré-os em um chamado após o mesmo já estar em aberto
            if (strlen($callcenter) > 0) {
                // echo ">>ENTREI<<";
                $sql = "SELECT abre_os FROM tbl_hd_chamado_extra WHERE hd_chamado=$callcenter";
                $res_abre_os = pg_query($con, $sql);
				$xabre_os = pg_result($res_abre_os, 0, abre_os);

                if ($xabre_os == 't') {
                    if ($login_fabrica == 74) {
                        $disabled = "readonly";
                    } else {
                        $disabled = "disabled";
                    }

                    if ($login_fabrica != 74) {
                       $checked = "checked";
                    }
                } else {
                    if (isset($abre_os_submeteu)) {
                        if ($abre_os == 't') {
                            $checked = "checked";
                        }
                        else {
                            $abre_os = $xabre_os;
                        }
                    }
                }
            } else {
                if (isset($abre_os_submeteu)) {
                    if ($abre_os == 't') {
                        $checked = "checked";
                    }
                } else if ($login_fabrica == 52) {
                    $checked = "checked";
                }
            }

			//HD 205933: Habilitar abertura de ORDEM DE SERVIÃO para a Esmaltec
			if (strlen($callcenter) > 0 && in_array($login_fabrica, array(30,50,171,176,183,190)) OR $moduloOSMultipla == "t") {
				if ($moduloOSMultipla == "t"){
                    $sql = "SELECT os FROM tbl_os WHERE fabrica = $login_fabrica AND hd_chamado = $callcenter ";
                    $res_abre_ordem_servico = pg_query($con, $sql);
                }else{
                    $sql = "SELECT os FROM tbl_hd_chamado_extra WHERE hd_chamado=$callcenter";
                    $res_abre_ordem_servico = pg_query($con, $sql);
                }

                if (pg_num_rows($res_abre_ordem_servico)) {
					$xabre_ordem_servico = pg_result($res_abre_ordem_servico, 0, os);
				}
				else {
					$xabre_ordem_servico = false;
				}

                if ($xabre_ordem_servico) {
				    $disabled = "disabled";
					$checked_abre_ordem_servico = "checked";
                    if (in_array($login_fabrica, array(171,178,183))) {
                        $abre_ordem_servico = 't';
                    }
                }
                else {
                    if (isset($abre_ordem_servico_submeteu)) {
                        if ($abre_ordem_servico == 't') {
                            $checked_abre_ordem_servico = "checked";
                        }
                        else {
                            if ($xabre_ordem_servico) {
                                $abre_ordem_servico = 't';
                            }
                            else {
                                $abre_ordem_servico = "";
                            }
                        }
                    }
                }
            }else {

                if (isset($abre_ordem_servico_submeteu)) {
                    if ($abre_ordem_servico == 't') {
                        $checked_abre_ordem_servico = "checked";
                    }
                }else{

                    if(in_array($login_fabrica, array(74)) && strlen($callcenter) > 0){
                        $sql_abre_os = "SELECT abre_os FROM tbl_hd_chamado_extra WHERE hd_chamado = {$callcenter}";
                        $res_abre_os = pg_query($con, $sql_abre_os);
                        $checked_abre_ordem_servico = (pg_fetch_result($res, 0, "abre_os") == "t") ? "checked" : "";
                    }elseif(in_array($login_fabrica, array(74)) && strlen($callcenter) == 0){
                        $checked_abre_ordem_servico = " ";
                    }else{
                        if($login_fabrica != 50) {
                          $checked_abre_ordem_servico = "checked";
                        }
                    }

                }

			}

            if(($login_fabrica == 94 AND $posicao == 9) or $xabre_os == 't' or $abre_ordem_servico == 't'){

				if(!in_array($login_fabrica, array(7,74,151,171))) {
                    if(in_array($login_fabrica, array(169,170))){
                        if(empty($msg_erro)){
                            if (strlen($os) > 0){
                                $sql = "SELECT status_checkpoint FROM tbl_os WHERE os = {$os} AND status_checkpoint NOT IN (0,1);";
                                $res = pg_query($con,$sql);

                                if (pg_num_rows($res) > 0){
                                    $disabled_posto = "readonly";
                                }
                            }
                        }else{
                            $disabled_posto = "";
                        }

                    }else{

                        if (in_array($login_fabrica, array(176,183,190))){

                            if (empty($msg_erro) AND !empty($posto_nome_tab) AND !empty($codigo_posto_tab)){
                                $disabled_posto = "readonly";
                            }else{
                                $disabled_posto = "";
                            }
                        }else if ($login_fabrica == 178){
                            if (empty($msg_erro)){
                                $disabled_posto = "readonly";
                            }
                        }else{
                            $disabled_posto = "readonly";

                            if(in_array($login_fabrica, array(158))){
                                if(strlen($posto_nome_tab) == 0){
                                    $disabled_posto = "";
                                }
                            }
                        }
                    }
                }
            }

            if (strlen($callcenter) > 0 && $login_fabrica == 52) {

                $sql = "SELECT os FROM tbl_hd_chamado_item WHERE hd_chamado = {$callcenter} AND os IS NOT NULL;";
                $res_abre_ordem_servico = pg_query($con, $sql);

                if (pg_num_rows($res_abre_ordem_servico)>0) {
                    $abre_ordem_servico = 't' ;
                    $checked_abre_ordem_servico = "checked";
                    $disabled = 'disabled';
                    $disabled_posto = "";
                }

            }

            if ($login_fabrica == 52 and !empty($msg_erro)){

                $checked_abre_ordem_servico = "checked";
                $disabled = '';
                $disabled_posto = "";

            }

            if (in_array($login_fabrica, array(169,170)) && !empty($os)) {
                $sql = "SELECT status_checkpoint FROM tbl_os WHERE os = {$os} AND status_checkpoint NOT IN (0,1);";
                $res = pg_query($con,$sql);
                if (pg_num_rows($res) > 0 AND empty($msg_erro)) {
                    $disabled_posto = "readonly";
                }
            } ?>
            <td align='left' width='50'><strong><?=(in_array($login_fabrica, array(117)) ? 'Macro-FamÃ­lia' : 'Linha')?>:</strong></td>
            <td align='left'>
            <?

            if (!in_array($login_fabrica, array(117))) {
                if (in_array($login_fabrica, array(169,170))){
                    if (isset($_POST['mapa_linha']) AND strlen(trim($_POST['mapa_linha'])) > 0){
                        $linha = $_POST['mapa_linha'];
                    }

                    if (strlen(trim($linha)) > 0){
                       $sql = "SELECT * FROM tbl_linha
                                WHERE tbl_linha.fabrica = {$login_fabrica}
                                AND tbl_linha.linha = {$linha}
                                AND tbl_linha.ativo ORDER BY tbl_linha.nome";
                        $res = pg_query($con, $sql);

                        if (pg_num_rows($res) > 0){
                            $aux_linha = pg_fetch_result($res, 0, 'linha');
                            $aux_linha_descricao = pg_fetch_result($res, 0, 'nome');
                        }
                    }
                    echo "<input type='hidden'  name='mapa_linha' id='mapa_linha' value='$aux_linha'>";
                    echo "<input type='text' readonly name='nome_mapa_linha' id='nome_mapa_linha' value='$aux_linha_descricao'>";

                }else{
                    $cond_linha = (in_array($login_fabrica, array(59))) ? " AND (tbl_linha.ativo = true OR nome = 'ACESSÃRIOS') " : " AND tbl_linha.ativo " ;


                    $sql = "SELECT  *
                            FROM    tbl_linha
                            WHERE   tbl_linha.fabrica = $login_fabrica
                              {$cond_linha}
                            ORDER BY tbl_linha.nome;";
                    $res = pg_query ($con,$sql);
                    if (pg_num_rows($res) > 0) {
                        echo "<select name='mapa_linha' id='mapa_linha' >\n";
                        echo "<option value=''>Escolha</option>\n";
                        for ($x = 0 ; $x < pg_num_rows($res) ; $x++){
                            $aux_linha = trim(pg_fetch_result($res,$x,linha));
                            $aux_nome  = trim(pg_fetch_result($res,$x,nome));

                            if ($_POST['mapa_linha'] == $aux_linha || $linha == $aux_linha){
                                $selected_linha = " SELECTED ";
                                $mostraMsgLinha = "<br> da LINHA $aux_nome";
                            }else{
                                $selected_linha = "  ";
                                $mostraMsgLinha = " ";
                            }
                             if ($login_fabrica == 186 && $aux_nome == 'Cuidados Pessoais') {
                                 $selected_linha = " SELECTED ";
                            }
                            echo "<option value='$aux_linha' $selected_linha style='text-transform: uppercase;' >$aux_nome</option>\n";
                        }
                        echo "</select>\n&nbsp;";
                    }
                }
            }else{
                echo "<select name='mapa_linha' id='mapa_linha' >\n";
                echo "<option value=''>Escolha</option>\n";
                $sql_linha = "SELECT DISTINCT
                              tbl_linha.linha,
                              tbl_linha.nome
                            FROM tbl_linha
                            JOIN tbl_macro_linha_fabrica ON tbl_linha.linha = tbl_macro_linha_fabrica.linha
                                  JOIN tbl_macro_linha ON tbl_macro_linha_fabrica.macro_linha = tbl_macro_linha.macro_linha
                            WHERE tbl_linha.fabrica = {$login_fabrica} AND tbl_linha.ativo IS TRUE
                            ORDER BY tbl_linha.nome ";

                $res_linha = pg_query($con, $sql_linha);
                if (pg_num_rows($res_linha) > 0) {
                    for ($x = 0 ; $x < pg_num_rows($res_linha) ; $x++){
                        $aux_linha = trim(pg_fetch_result($res_linha, $x, linha));
                        $aux_nome = trim(pg_fetch_result($res_linha, $x, nome));

                        $linha_select .= "<option value='$aux_linha'>$aux_nome</option>";
                    }
                    echo $linha_select;
                }
                echo "</select>\n&nbsp;";
            }


            #flag 7
            if($login_fabrica == 7 and $consumidor_cidade != ""){

                $sql = "SELECT *
                        FROM tbl_cidade_sla
                        WHERE cidade ilike('%".$consumidor_cidade."%') LIMIT 1";

                $res = pg_query($con,$sql);
                if(pg_num_rows($res)>0){
                    $ssl_horas = pg_result($res,0,'hora');
                }else{
                    $ssl_horas = "20";
                }

            }

            if (in_array($login_fabrica, [177])) { ?>
                </td>
                <td align='left' width='50'><strong>PaÃ­s:</strong></td>
                <td align='left'>
                    <select name='pais' id='pais'>
                        <?php
                            $sql_pais = "SELECT pais, nome
                                            FROM tbl_pais
                                        WHERE nome IS NOT NULL";
                            $res_pais = pg_query($con, $sql_pais);
                            if (pg_num_rows($res_pais) > 0) {
                                for ($i_pais=0; $i_pais < pg_num_rows($res_pais); $i_pais++) {
                                    $pais = pg_fetch_result($res_pais, $i_pais, 'pais');
                                    $nome = pg_fetch_result($res_pais, $i_pais, 'nome');
                                    if ($pais == 'BR' || $nome == 'BRASIL') {
                                        $selected = 'selected=selected';
                                    } else {
                                        $selected = '';
                                    }
                        ?>
                                    <option value='<?=$pais?>' <?=$selected?> ><?=$nome?></option>
                        <?php   }
                            }
                        ?>
                    </select>
                </td>
        <?php }

            /* FABRICAS SEM ESTADO E CIDADE PARA PESQUISA NO MAPA DA REDE */
            if (!in_array($login_fabrica, array(117))) {
            ?>
            </td>

            <?php if (in_array($login_fabrica, array(189))) {?>

            <td align='left'>
                <?php
                    $sqlTipo = "SELECT * FROM tbl_tipo_posto WHERE fabrica={$login_fabrica};";
                    $resTipo = pg_query($con, $sqlTipo);
                    foreach(pg_fetch_all($resTipo) as $key => $rows) {
                        if ($tipo_posto == $rows["tipo_posto"]) {
                            $checked  = " checked='checked'";
                        }  else {
                            $checked  = "";
                        }

                ?>
                <input type="radio" <?=$checked;?> data-descricao="<?php echo trim($rows["descricao"]);?>" name="tipo_posto" value="<?php echo $rows["tipo_posto"];?>"> <?php echo $rows["descricao"];?>
                <?php }?>
            </td>

            <td align='left' width='80' style="text-align: right;"><strong>Tipo de Cliente:</strong></td>
            <td align='left' colspan='2'>
                <?php
                    $array_tipo_cliente = [
                        "Cliente Final" => "Cliente Final",
                        "Varejo" => "Varejo",
                        "Industria" => "IndÃºstria",
            			"Tecnico" => "Técnico",
            			"Exportacao" => "Exportação"
                    ];
                echo "<select name='tipo_cliente' id='tipo_cliente'>";
                    echo "<option value=''>Selecione...</option>";
                    foreach ($array_tipo_cliente as $key => $value) {
                            if($tipo_cliente == $value){
                                $selected = " selected ";
                            }else{
                                $selected = "";
                            }
                        echo "<option value='{$key}' {$selected}>{$value}</option>";

                    }
                echo "</select>";


                ?>
            </td>
            <?php }?>
            <td align='left' width='50'><strong>Estado:</strong></td>
            <td align='left'>
                <?php

                if ($callcenter and $posto) {
                    $sql = "SELECT contato_estado,contato_cidade
                            from tbl_posto_fabrica
                            where fabrica=$login_fabrica
                            AND posto = $posto;";
                    $res = pg_query($con,$sql);

                    if (pg_num_rows($res)>0) {
                        $estado = pg_fetch_result($res,0,0);
                        $cidade = pg_fetch_result($res,0,1);
                    }

                }

                if (in_array($login_fabrica, array(169,170))){
                    $cidade_readonly = "readonly";
                    $estados = array('AC' => 'Acre',
                                     'AL' => 'Alagoas',
                                     'AP' => utf8_encode('Amapá'),
                                     'AM' => utf8_encode('Amazonas') ,
                                     'BA' => utf8_encode('Bahia'),
                                     'CE' => utf8_encode('Ceará'),
                                     'DF' => utf8_encode('Distrito Federal') ,
                                     'GO' => utf8_encode('Goiás') ,
                                     'ES' => utf8_encode('Espirito Santo'),
                                     'MA' => utf8_encode('Maranhão'),
                                     'MT' => utf8_encode('Mato Grosso'),
                                     'MS' => utf8_encode('Mato Grosso do Sul'),
                                     'MG' => utf8_encode('Minas Gerais'),
                                     'PA' => utf8_encode('Pará'),
                                     'PB' => utf8_encode('ParaÃ­ba'),
                                     'PR' => utf8_encode('Paraná'),
                                     'PE' => utf8_encode('Pernambuco'),
                                     'PI' => utf8_encode('Piaui'),
                                     'RJ' => utf8_encode('Rio de Janeiro'),
                                     'RN' => utf8_encode('Rio Grande do Norte'),
                                     'RS' => utf8_encode('Rio Grande do Sul'),
                                     'RO' => utf8_encode('RondÃ´nia'),
                                     'RR' => utf8_encode('Roraima'),
                                     'SC' => utf8_encode('Santa Catarina'),
                                     'SE' => utf8_encode('Sergipe'),
                                     'SP' => utf8_encode('São Paulo'),
                                     'TO' => utf8_encode('Tocantins'),
                                     'BR-N' => utf8_encode('Região Norte'),
                                     'BR-NE' => utf8_encode('Região Nordeste'),
                                     'BR-CO' => utf8_encode('Região Centro-Oeste'),
                                     'BR-SE' => utf8_encode('Região Sudeste'),
                                     'BR-S' => utf8_encode('Região Sul')
                    );

                    $dados_estados = json_encode($estados);

                    foreach ($estados as $key => $value) {
                        if ($estado == $key){
                            $xestado = $key;
                            $estado_descricao = utf8_decode($value);
                        }
                    }

                    ?>
                    <input type="hidden" name="dados_estados" id="dados_estados" value='<?=$dados_estados?>'>
                    <input name='mapa_estado' type="hidden" id='mapa_estado' value='<?=$xestado?>'>
                    <input name='nome_mapa_estado' readonly type="text" id='nome_mapa_estado' value='<?=$estado_descricao?>'>
                    <?php
                }else{

                ?>
                    <select name='mapa_estado' id='mapa_estado' <?=$disabled_posto?>>
                        <?php if($login_fabrica != 74){?>
                        <option value='00' selected>Todos</option>
                        <?php }?>
                        <? if ($login_fabrica == 5) {
                            $estados = array('SUL' => 'Sul',
                                             'SP-campital' => 'São Paulo - Capital',
                                             'SP-interior' => 'São Paulo - Interior',
                                             'RJ' => 'Rio de Janeiro' ,
                                             'MG' => 'Minas Gerais',
                                             'PE' => 'Pernambuco',
                                             'BA' => 'Bahia' ,
                                             'BR-NEES' => 'Nordeste + E.S.' ,
                                             'BR-NCO' => 'Norte + C.O.'

                                            );
                            foreach ($estados as $key => $value) {

                                $selected_estado = ($_POST['mapa_estado'] == $key || $estado == $key) ? ' SELECTED ' : '' ;
                                ?>
                                <option value='<?=$key?>'  <?=$selected?> ><?=$value?></option>
                                <?
                            }
                        } else {
                            $estados = array('AC' => 'Acre',
                                             'AL' => 'Alagoas',
                                             'AP' => 'Amapá',
                                             'AM' => 'Amazonas' ,
                                             'BA' => 'Bahia',
                                             'CE' => 'Ceará',
                                             'DF' => 'Distrito Federal' ,
                                             'GO' => 'Goiás' ,
                                             'ES' => 'Espirito Santo',
                                             'MA' => 'Maranhão',
                                             'MT' => 'Mato Grosso',
                                             'MS' => 'Mato Grosso do Sul',
                                             'MG' => 'Minas Gerais',
                                             'PA' => 'Pará',
                                             'PB' => 'Paraí­ba',
                                             'PR' => 'Paraná',
                                             'PE' => 'Pernambuco',
                                             'PI' => 'Piaui',
                                             'RJ' => 'Rio de Janeiro',
                                             'RN' => 'Rio Grande do Norte',
                                             'RS' => 'Rio Grande do Sul',
                                             'RO' => 'Rondônia',
                                             'RR' => 'Roraima',
                                             'SC' => 'Santa Catarina',
                                             'SE' => 'Sergipe',
                                             'SP' => 'São Paulo',
                                             'TO' => 'Tocantins',
                                             'BR-N' => 'Região Norte',
                                             'BR-NE' => 'Região Nordeste',
                                             'BR-CO' => 'Região Centro-Oeste',
                                             'BR-SE' => 'Região Sudeste',
                                             'BR-S' => 'Região Sul'

                                            );
                            foreach ($estados as $key => $value) {

                                $selected_estado = ($_POST['mapa_estado'] == $key || $estado == $key) ? ' SELECTED ' : '' ;
                                ?>
                                <option value='<?=$key?>'  <?php echo $selected_estado?> ><?=$value?></option>
                                <?
                            }
                        ?>
                        <? }?>
                    </select>
                <?php
                }
                ?>
            <td align='left' width='50'><strong>Cidade:</strong></td>
            <? if ($cidade) {
                $mapa_cidade = $cidade;
            }

            if (in_array($login_fabrica,array(74,85))) { ?>
                <td align="left">
                    <select id="mapa_cidade" name="mapa_cidade" style="width: 150px;">
                        <option value=""></option>
                    </select>
                </td>

                <?php if($login_fabrica == 74){ ?>
                <td><strong>Bairro:</strong></td>
                <td align="left">
                    <select id="mapa_bairro" name="mapa_bairro" style="width: 150px;">
                        <option value=""></option>
                    </select>
                </td>
                <?php } ?>

                <td><strong>Postos:</strong></td>
                <td>
                    <select id="postos_cidade" name="postos_cidade" style="width: 150px;">
                        <option value=""></option>
                    </select>
                </td>

                <td>
                    <input type='button' name='btn_mapa' id="btn_mapa" value=' Mapa '  <?=$disabled_posto?>>
                </td>

            <? } else if ($login_fabrica == 140) { ?>
                <td align='left'><input type='text' id='mapa_cidade' name='mapa_cidade' value='<?=$mapa_cidade?>' <?=$disabled_posto?>>
                <input type='button' name='btn_mapa' value=' Mapa ' onclick='javascript:mapa_rede_new(mapa_linha,mapa_estado,mapa_cidade,consumidor_cep,consumidor_endereco,consumidor_numero,consumidor_bairro,consumidor_cidade,consumidor_estado)' <?=$disabled_posto?>>
            <? } else { ?>
				<td align='left'><input type='text' id='mapa_cidade' <?=$cidade_readonly?> name='mapa_cidade' value='<?=$mapa_cidade?>' <?=$disabled_posto?>>
				<input type='button' name='btn_mapa' id="btn_mapa" value=' Mapa ' <?=$disabled_posto?>>
            <? } ?>
			</td>
        <?php }else{ ?>
            <input type='button' name='btn_mapa' id="btn_mapa" value=' Mapa '  <?=$disabled_posto?>>
        <?php } ?>
        </tr>
            <tr>
                <td align='left' nowrap><strong class='txt_cod_posto'><?= ($login_fabrica == 42) ? "Código da Filial Makita:" : "Código do Posto:" ?></strong></td>
                <td align='left'>
                    <?php if (in_array($login_fabrica, array(169,170)) OR $callcenterLupaPosto == 't'){ ?>
                        <input type="hidden" name="bloqueia_campos_dealer" id="bloqueia_campos_dealer" value="<?=$_POST['bloqueia_campos_dealer']?>">
                        <input type='hidden' name='linhas_posto_tab' id='linhas_posto_tab' value="" >
                        <input name="codigo_posto_tab"  id="codigo_posto_tab" class="posto_codigo input"  value='<?echo $codigo_posto_tab ;?>' <?=$disabled_posto?>>
                        <img src='imagens/lupa.png' border='0' align='absmiddle' style='cursor: pointer'
                            onclick="javascript: fnc_pesquisa_posto_tab (
                            document.frm_callcenter.codigo_posto_tab,
                            document.frm_callcenter.posto_nome_tab,
                            'codigo',
                            document.frm_callcenter.posto_fone_tab,
                            document.frm_callcenter.posto_email_tab,
                            document.frm_callcenter.mapa_linha,
                            document.frm_callcenter.posto_tab,
                            document.frm_callcenter.linhas_posto_tab,
                            '',
            			    '',
			                <?php echo ($login_fabrica == 189) ? "document.frm_callcenter.tipo_cliente.value" : "''"; ?>,
			                <?php echo ($login_fabrica == 189) ? "document.frm_callcenter.tipo_posto.value" : "''"; ?>,
                            <?php echo (in_array($login_fabrica, [183,190])) ? "document.frm_callcenter.posto_contato_endereco" : "''"; ?>,
                            <?php echo (in_array($login_fabrica, [183,190])) ? "document.frm_callcenter.posto_contato_numero" : "''"; ?>,
                            <?php echo (in_array($login_fabrica, [183,190])) ? "document.frm_callcenter.posto_contato_bairro" : "''"; ?>,
                            <?php echo (in_array($login_fabrica, [183,190])) ? "document.frm_callcenter.posto_contato_cidade" : "''"; ?>,
                            <?php echo (in_array($login_fabrica, [183,190])) ? "document.frm_callcenter.posto_contato_estado" : "''"; ?>
                            );
                        ">
                    <?php }else{?>
                        <input name="codigo_posto_tab" id="codigo_posto_tab"  class="posto_codigo input" value='<?echo $codigo_posto_tab;?>'  type="text" size="15" maxlength="20" <?=$disabled_posto?>>
                    <?php } ?>
                </td>
                <td align='left' nowrap><strong class='txt_nome_posto'><?=($login_fabrica == 42) ? "Nome da Filial Makita:":" Nome do Posto:" ?></strong></td>
                <td align='left'>
                    <input type='hidden' name='posto_tab' id='posto_tab' value="<? echo $posto_tab; ?>">
                    <input type='hidden' name='posto_banco' value="<? echo $posto; ?>">
                    <?php if ($login_fabrica == 162) { ?>
                    <input type='hidden' name='interno' id='interno' value="<?=$posto_interno_tab?>">
                    <?php } ?>
                    <?php if (in_array($login_fabrica, array(169,170)) OR $callcenterLupaPosto == 't'){ ?>
                        <input name="posto_nome_tab" id="posto_nome_tab" class="posto_nome input" value='<?echo $posto_nome_tab ;?>' type="text" size="30" maxlength="150" <?=$disabled_posto?>>
                        <img src='imagens/lupa.png' border='0' align='absmiddle' style='cursor: pointer'
                            onclick="javascript: fnc_pesquisa_posto_tab (
                            document.frm_callcenter.codigo_posto_tab,
                            document.frm_callcenter.posto_nome_tab,
                            'nome',
                            document.frm_callcenter.posto_fone_tab,
                            document.frm_callcenter.posto_email_tab,
                            document.frm_callcenter.mapa_linha,
                            document.frm_callcenter.posto_tab,
                            document.frm_callcenter.linhas_posto_tab,
                            '',
            			    '',
			                <?php echo ($login_fabrica == 189) ? "document.frm_callcenter.tipo_cliente.value" : "''"; ?>,
                            <?php echo ($login_fabrica == 189) ? "document.frm_callcenter.tipo_posto.value" : "''"; ?>,
                            <?php echo (in_array($login_fabrica, [183,190])) ? "document.frm_callcenter.posto_contato_endereco" : "''"; ?>,
                            <?php echo (in_array($login_fabrica, [183,190])) ? "document.frm_callcenter.posto_contato_numero" : "''"; ?>,
                            <?php echo (in_array($login_fabrica, [183,190])) ? "document.frm_callcenter.posto_contato_bairro" : "''"; ?>,
                            <?php echo (in_array($login_fabrica, [183,190])) ? "document.frm_callcenter.posto_contato_cidade" : "''"; ?>,
                            <?php echo (in_array($login_fabrica, [183,190])) ? "document.frm_callcenter.posto_contato_estado" : "''"; ?>
                        );
                        ">
                    <?php }else{ ?>
                       <input name="posto_nome_tab" id="posto_nome_tab"  class="posto_nome input" value='<?echo $posto_nome_tab ;?>'  type="text" size="30" maxlength="150" <?=$disabled_posto?>>
                    <?php } ?>
                    <?php
                    if($login_fabrica == 30){
                        echo "<input type='button' name='btn_consulta_cidades_atendidas' id='btn_consulta_cidades_atendidas' class='btn_consulta_cidades_atendidas input_req2' style='background-color:#DDDDDD' value='Cidades atendidas'/>";
                    }
                    if ($login_fabrica == 74) {
                        $id_posto = (empty($id_posto)) ? $posto : $id_posto;
                        echo "<input type='hidden' id='posto_atual' name='posto_atual' value='{$id_posto}' />";
                    }
                    ?>
                </td>
                <?php if (in_array($login_fabrica, [189])) {
                    if($envia_email_representante == 't'){
                        $display = "display:block;";
                        $checked_email_representatne = " checked ";
                    }else{
                        $display = "display:none;";
                        $checked_email_representatne = "";
                    }
                ?>
                <td align='left'  id="envia_email_representante" colspan="4" style='<?=$display_email_representante?>'><strong><input type="checkbox" name="envia_email_representante" value="t" <?=$checked_email_representatne?> > Enviar e-mail Indicação de Representante</strong></td>
                <?php } ?>

<?
                if($login_fabrica == 52){
?>                  <td align='left' rowspan="3"><strong>Observação OS:</strong></td>
                    <td align='left' rowspan="3">
                        <textarea name="observacao_os" id="observacao_os" class="input" cols="45"><?=$observacao_os?></textarea>
                    </td>
<?              }
?>
            </tr>
        <tr>
                <?php

                $posto_fone_tab = ($_POST['posto_fone_tab']) ? trim($_POST['posto_fone_tab']) : $posto_fone_tab ;
                $posto_email_tab = ($_POST['posto_email_tab']) ? trim($_POST['posto_email_tab']) : $posto_email_tab ;
                ?>
                <td align='left'><strong>Telefone:</strong></td>
                <td align='left'>
                    <input name="posto_fone_tab" id="posto_fone_tab"  class="posto_fone input" value='<?echo $posto_fone_tab;?>'  type="text" size="15" maxlength="15" readonly>
                </td>
                <?php
                $ajuste_largura_4 = "";
                $ajuste_largura_20 = "";

                if($login_fabrica == 30){
                    $ajuste_largura_4 = " width='4%'";
                    $ajuste_largura_20 = " width='20%'";
				?>
					<td align='left' width="4%"><strong>Celular 1:</strong></td>
					<td align='left'>
						<input name="posto_fone1_tab" id="posto_fone1_tab"  class="posto_fone1 input" value='<?echo $posto_fone1_tab;?>'  type="text" size="15" maxlength="15" readonly>
					</td>
					<td align='left' width="4%"><strong>Celular 2:</strong></td>
					<td align='left'>
						<input name="posto_fone2_tab" id="posto_fone2_tab"  class="posto_fone2 input" value='<?echo $posto_fone2_tab;?>'  type="text" size="15" maxlength="15" readonly>
					</td>
				<?php
				}
				?>
				<td align='left' <?php echo $ajuste_largura_4;?>><strong>E-mail:</strong></td>
				<td align='left'>
					<input name="posto_email_tab" id="posto_email_tab"  class="posto_email input" value='<?echo $posto_email_tab ;?>'  type="text" size="35" maxlength="50" readonly>
				</td>
                <?php if(in_array($login_fabrica,array(30,74,156,183,190))){
                    if($login_fabrica == 74){
                        $readonly = "readonly='true'";
                    }
                ?>

                    <input type="hidden" name="posto_contato_endereco" id="posto_contato_endereco" value="<?=$posto_contato_endereco?>">
                    <input type="hidden" name="posto_contato_numero" id="posto_contato_numero" value="<?=$posto_contato_numero?>">
                    <input type="hidden" name="posto_contato_bairro" id="posto_contato_bairro" value="<?=$posto_contato_bairro?>">
                    <input type="hidden" name="posto_contato_cidade" id="posto_contato_cidade" value="<?=$posto_contato_cidade?>">
                    <input type="hidden" name="posto_contato_estado" id="posto_contato_estado" value="<?=$posto_contato_estado?>">
                    <?php if(!in_array($login_fabrica,array(190))){?>
                        <td align="right" width="5%">KM:</td>
                        <td <?php echo $ajuste_largura_20;?>>
                            <input type="text" name="posto_km_tab" id="posto_km_tab" class="posto_email input" value="<?=$posto_km_tab ?>" <?=$readonly ?>>
                            <div id="botao_km"></div>
                            <input type="button" id="btn_calcula_km" name="btn_calcula_km" value="Calcular KM" onclick="calcRoute()">
                        </td>
                        
                    <?php } ?>
                <?php } ?>

                <?
                if ($login_fabrica == 52 AND strlen($callcenter) > 0) {
                    $sqlXX = "SELECT os,sua_os, obs_adicionais FROM tbl_os JOIN tbl_os_extra USING(os) where tbl_os.hd_chamado=$callcenter and tbl_os.fabrica=$login_fabrica";

                    $resXX = pg_query($con,$sqlXX);
                ?>
                <td colspan='2' align='left'>
                    <?php
                        for($xx = 0; $xx < pg_numrows($resXX); $xx++){
                            $inf_adicional = pg_result($resXX,$xx,'obs_adicionais');
                            if(!empty($inf_adicional)){
                                echo "<b>".$inf_adicional."</b>";
                                echo "<br />";
                            }
                        }
                    ?>
                </td>
                <? } ?>

				<?
				if ($login_fabrica == 74) {
					if(empty($data_prov) && !empty($data_providencia)){
						$data_prov = $data_providencia;
					}
				?>
				<td align='left' nowrap><strong>Data Providência:</strong></td>
				<td colspan='2' align='left'>
					<input name="data_prov" id="data_prov" class="input" rel="data" value="<?=$data_prov?>" size='10'>
				</td>
				<? } ?>
			</tr>

            <?php 
                if (in_array($login_fabrica, [183,190,195])){ 

                    if (empty($id_tipo_atendimento)){
                        $id_tipo_atendimento = $_POST["tipo_atendimento_os"];
                    }

                    if (!empty($id_tipo_atendimento) OR $abre_ordem_servico == "t"){
                        $style_atendimento = "";
                    }else{
                        if (in_array($login_fabrica, [190])){ 
                            $style_atendimento = "style=''";
                        } else {
                            $style_atendimento = "style='display:none;'";
                        }
                    }
            ?>
            <tr id="tipo_atendimento_os" <?=$style_atendimento?>>
                <td align='left'  nowrap><strong>Tipo de atendimento:</strong></td>
                <td >
                    <select id="select_atendimento_os" name="tipo_atendimento_os">
                        <option <?=(!empty($os))?'disabled' : ''?> value=''>Escolha</option>
                        <?php
                            $sql = "
                                SELECT tipo_atendimento,
                                       descricao,
                                       codigo,
                                       fora_garantia,
                                       km_google
                                FROM tbl_tipo_atendimento
                                WHERE fabrica = $login_fabrica
                                ORDER BY descricao ASC";
                            $res = pg_query($con, $sql);

                            if (pg_num_rows($res) > 0) {
                                while ($rows = pg_fetch_array($res)) {

                                    if ($login_fabrica == 190 && in_array(trim($rows['descricao']), ['Proposta Comercial','Preventiva','Entrega Técnica / Treinamento'])) {
                                        continue;
                                    }
                                    $selectedTipo = ($id_tipo_atendimento == $rows['tipo_atendimento']) ? "selected" : "";
                                    if (!empty($os)){
                                        $selectedDisabled = ($id_tipo_atendimento != $rows['tipo_atendimento']) ? "disabled" : "";
                                    }
                                    echo "<option {$selectedDisabled} km-google='{$rows['km_google']}' fora-garantia='{$rows['fora_garantia']}' value='{$rows['tipo_atendimento']}' {$selectedTipo}>{$rows['descricao']}</option>";
                                }
                            }
                        ?>
                    </select>
                </td>
            </tr>

            <?php } ?>


			<?php
			if($login_fabrica == 30) {
				echo "<tr><td style='vertical-align: top;'><strong>Particularidades: </strong></td> <td colspan='3'><textarea cols='50' rows='5' id='particularidade_posto' readonly>$obs_posto</textarea></td></tr>";
			}

			if((in_array($login_fabrica,array(85,162)) && !empty($os)) || ($login_fabrica == 156 && strlen($cliente_admin) > 0)){

                if (strlen($callcenter) > 0) {
                    $sql_abre_os = "SELECT abre_os FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter";
                    $res_abre_os = pg_query($con, $sql_abre_os);

                    if(pg_num_rows($res_abre_os) > 0){

                        $abre_os = pg_fetch_result($res_abre_os, 0, 'abre_os');
                        if(empty($abre_os)){
                            $abre_ordem_servico = 't';
                            $checked            = "";
                            $disabled           = 'disabled';
                        }
                    }
                }

                $sql_reabrir_os = "SELECT tbl_os.data_fechamento
                        FROM tbl_hd_chamado
                        JOIN tbl_os ON tbl_os.os = {$os} AND tbl_os.data_fechamento IS NOT NULL
                        WHERE tbl_hd_chamado.hd_chamado = {$callcenter}
                        AND UPPER(tbl_hd_chamado.status) <> 'RESOLVIDO'";
                $res_reabrir_os = pg_query($con, $sql_reabrir_os);
                $res_reabrir_os = pg_num_rows($res_reabrir_os);

                if($res_reabrir_os > 0){

                    $button_reabrir_os = "<br /> <button type='button' onClick='inserirMotivoReabrirOS(\"{$os}\")' style='padding-left: 10px; padding-right: 10px;'>Reabrir OS</button> <br /> ";


                    ?>
                    <script>
                        function inserirMotivoReabrirOS(os){

                            Shadowbox.open({
                                content: 'tela_motivo_reabrir_os.php?os=<?=$os?>&callcenter=<?=$callcenter?>&login_admin=<?=$login_admin?>',
                                player: "iframe",
                                title: "Motivo para Reabrir OS",
                                enableKeys: false,
                                width: 400,
                                height: 250
                            });

                        }

                    </script>
                    <?php

                }

            }
            $aux_colspan = ($login_fabrica == 85) ? "2" : "6";

            echo "<tr><td align='left' colspan='$aux_colspan'>";
            if(in_array($login_fabrica,array(30,50,52,158,171,176,178,190,195))){
                echo "";
            }else{
                if($login_fabrica == 156) {

                    $sql = "SELECT sua_os FROM tbl_os WHERE os = (SELECT os FROM tbl_hd_chamado_extra WHERE hd_chamado = {$callcenter})";
                    $res = pg_query($con, $sql);
                    $abre_os_sua_os = pg_fetch_result($res, 0, "sua_os");

                    if(strlen($abre_os_sua_os) == 0){
                        $checked = (strlen($checked) == 0) ? "checked" : $checked;

                        if (empty($cliente_admin) and empty($checked)) {
                            $checked = '';
                        }

                        echo "<strong><input type=hidden name='abre_os_submeteu' value='sim'><input type='checkbox' name='abre_os' id='abre_os' value='t' onClick='verificarImpressao(this)' $checked> <span style='font-size: 14px;'>Abrir OS para esta Autorizada</span></strong>";
                    }

                    echo (strlen($abre_os_sua_os) > 0) ? " <strong>OS:</strong> <a href='os_press.php?os=$os' target='_blank'>$abre_os_sua_os</a>" : "";

                }else{

                    if($login_fabrica == 74){
                        if(strlen(trim($os))>0){
                            $disabled = " disabled ";
                        }else{
                            $disabled = "";
                        }
                    }

                    if(!in_array($login_fabrica, array(169,170,183,189,190,195))){

                        echo "<strong $display_abre_os class='class_169' ><input type=hidden name='abre_os_submeteu' value='sim'><input $disabled $display_abre_os type='checkbox' name='abre_os' id='abre_os' value='t' class='class_169' onClick='verificarImpressao(this)' $checked> Abrir PRE-OS para esta Autorizada</strong>";
                        echo "<input type='hidden' name='abre_os_check' id='abre_os_check' value='".$abre_os_check."'/>";
                    }

                    if(in_array($login_fabrica, array(151))){
                        if ($callcenter && $abre_os_mondial == 't') {
                           $disabled = " disabled ";
                        }
                        $checkAbre = ($abre_os_mondial == 't') ? "checked" : "";
                        echo "<strong style='padding-left:30px;'><input {$checkAbre} $disabled type='checkbox' name='abre_os_mondial' id='abre_os_mondial' value='t'> Abrir OS</strong>";
                    }

                    if ($login_fabrica == 80 && strlen($callcenter) > 0 && !empty($callcenter)) {
                        $aux_sql  = "SELECT abre_os FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter LIMIT 1";
                        $aux_res  = pg_query($con, $aux_sql);
                        $auxiliar = pg_fetch_result($aux_res, 0, 0);
                        ?> <input type="hidden" name="aux_abre_os" id="aux_abre_os" value="<?=$auxiliar;?>"> <?php
                    }
                }
            }

			//HD 205933: Habilitar abertura de ORDEM DE SERVIÃO para a Esmaltec
			if (in_array($login_fabrica,array(30,50,52,72,74,85,104,139,151,158,162,164,165,169,170,171, 176,178,183,190,195))) {
				if ($login_fabrica == 52){

                    if (strlen($callcenter) == 0) {
                        $hd_classificacao = $_POST["hd_classificacao"]; 
                    }

                    if ($hd_classificacao != "237") {
                        if ($disabled){
                                echo "<input type='hidden' name='abre_ordem_servico' value='t' />";
                                echo "<br><strong id='strong_abrir_os'><input type=hidden name='abre_ordem_servico_submeteu' value='sim'><input type='checkbox' $disabled $checked_abre_ordem_servico> Abrir ORDEM DE SERVIÃO para esta Autorizada</strong>";
                        }else{
                                echo "<br><strong id='strong_abrir_os'><input type=hidden name='abre_ordem_servico_submeteu' value='sim'><input type='checkbox' name='abre_ordem_servico' $disabled  id='abre_ordem_servico' value='t' onClick='verificarImpressao(this)' $checked_abre_ordem_servico> Abrir ORDEM DE SERVIÃO para esta Autorizada</strong>";
                        }
                    } else {
                        $display_imprimir_os = " style='display: none;' ";
                    }

                }elseif(in_array($login_fabrica,array(50,74,158,169,170,190))){

                    if($login_fabrica == 74){
                        if(strlen(trim($os))>0){
                            $disabled = " disabled ";
                        }else{
                            $disabled = "";
                        }
                    }

                    $mensagem_abre_os = " Abrir ORDEM DE SERVIÃO para esta Autorizada?";
                    
                    if(!in_array($login_fabrica, array(169,170))){
                        echo "<br><strong class='abre_os_169' $display_abre_ordem_servico ><input type=hidden name='abre_ordem_servico_submeteu' value='sim'><input type='checkbox' name='abre_ordem_servico' $disabled $display_abre_ordem_servico class='abre_os_169' id='abre_ordem_servico' value='t' onClick='verificarImpressao(this)' $checked_abre_ordem_servico>$mensagem_abre_os</strong>";
                    }

                    // if(in_array($login_fabrica, array(169,170))){
                    //     echo (strlen($os) > 0) ? " <br/><strong>OS:</strong> <a href='os_press.php?os=$os' target='_blank'>$os</a>" : "";
                    // }
                }elseif(in_array($login_fabrica, array(30,171,176, 178,183))){
                    $display = 'none';

                    if (in_array($login_fabrica, array(171,176,178,183))){
                        if (strlen($msg_erro) > 0 && $abre_ordem_servico == 't') {
                            $checked = " checked ";
                            $display = 'block';
                            $disabled = "";
                        } elseif (strlen($callcenter) > 0 && $abre_ordem_servico == 't') {
                            if ($moduloOSMultipla == "t"){
                                $disabled = "onclick='return(false);'";
                            }else{
                                $disabled = "disabled";
                            }
                            $checked = " checked ";
                            $display = 'block';
                        }

                        echo "<br><strong><input type=hidden name='abre_ordem_servico_submeteu' value='sim'><input type='checkbox' name='abre_ordem_servico' $checked $disabled  id='abre_ordem_servico' value='t' onClick='verificarImpressao(this);carregaTipoAtendimento(this);'> Abrir ORDEM DE SERVIÃO para esta Autorizada</strong>";

                    } else {
                        if($login_fabrica == 30){
                            if($abre_ordem_servico == 't'){
                                $checked = " checked ";
                            }else{
                                 $checked = " ";
                            }
                        }
                        echo "<br><strong><input type=hidden name='abre_ordem_servico_submeteu' value='sim'><input type='checkbox' $checked name='abre_ordem_servico' $disabled  id='abre_ordem_servico' value='t' onClick='verificarImpressao(this);'> Abrir ORDEM DE SERVIÃO para esta Autorizada</strong>";
                    }
                }elseif(in_array($login_fabrica, array(195))){
                
                    $exibe_oculta_pre_os = "style='display:none;'";
                    $exibe_oculta_os = "style='display:none;'";
                    if (strlen($callcenter) > 0) {

                        $sqlHdClassProduto = "SELECT * 
                                                FROM tbl_hd_classificacao 
                                               WHERE hd_classificacao={$hd_classificacao} 
                                                 AND fabrica={$login_fabrica}";
                        $resHdClassProduto = pg_query($con, $sqlHdClassProduto);
                        if (pg_num_rows($resHdClassProduto) > 0) {

                            $abre_os_pre_os = pg_fetch_result($resHdClassProduto, 0, 'abre_os_pre_os');
                            if ($abre_os_pre_os == "pre") {
                                $exibe_oculta_pre_os = "";
                            } 
                            if ($abre_os_pre_os == "os") {
                                $exibe_oculta_os = "";
                            } 

                        }

                        $sql = "SELECT sua_os FROM tbl_os WHERE os = (SELECT os FROM tbl_hd_chamado_extra WHERE hd_chamado = {$callcenter})";
                        $res = pg_query($con, $sql);
                        $abre_os_sua_os = pg_fetch_result($res, 0, "sua_os");

                        if(strlen($abre_os_sua_os) > 0){
                            $checked = (strlen($checked) == 0) ? "checked disabled" : $checked;
                        }

                        $checkedPre = ($abre_os == 't') ? "checked disabled" : "";
                    }
                    echo "
                        <strong class='class_169 abre_pre_os' {$exibe_oculta_pre_os}>
                            <input type='checkbox' $checkedPre  name='abre_os' id='abre_os' value='t' class='class_169' onClick='verificarImpressao(this)'> Abrir PRE-OS para esta Autorizada
                        </strong>
                        <strong id='strong_abrir_os'class='abre_os_os' {$exibe_oculta_os}>
                            <input type='checkbox'  $checked  name='abre_ordem_servico' value='t'> Abrir ORDEM DE SERVIÇO para esta Autorizada
                        </strong>


                    ";
                
                }

                if ($os && in_array($login_fabrica,array(30,50,74,104,158,162,164,165,171, 176, 178))) {

                    $sql = "SELECT sua_os FROM tbl_os WHERE os=$os";
                    $res = pg_query($con, $sql);
                    $abre_os_sua_os = pg_result($res, 0, sua_os);

                    echo " <a href='os_press.php?os=$os' target='_blank'>$abre_os_sua_os</a>";
                }elseif ($login_fabrica == 52  && $callcenter) {

                    if (pg_num_rows($resXX)>0) {
                        for ($xx=0; $xx < pg_num_rows($resXX); $xx++) {
                            $os_fricon = pg_fetch_result($resXX, $xx, 'os');
                            $sua_os_fricon = pg_fetch_result($resXX, $xx, 'sua_os');
                            echo "&nbsp; <a href='os_press.php?os=$os_fricon' target='_blank'>$sua_os_fricon</a>&nbsp;";
                        }
                    }
                }elseif($os AND in_array($login_fabrica,array(72,85,139))){
                    $sql = "SELECT tbl_os.sua_os, tbl_status_checkpoint.descricao
                                FROM tbl_os
                                JOIN tbl_status_checkpoint ON tbl_os.status_checkpoint = tbl_status_checkpoint.status_checkpoint
                                WHERE tbl_os.os = $os ";
                    $res = pg_query($con, $sql);
                    $abre_os_sua_os = pg_result($res, 0, 'sua_os');
                    $abre_os_status = pg_result($res, 0, 'descricao');


                    echo "  <table class='tabela'>
                                <tr class='titulo_tabela'>
                                    <th>OS</th>
                                    <th>Status</th>";
                    echo "
                                </tr>
                                <tr>
                                    <td><a href='os_press.php?os=$os' target='_blank'>$abre_os_sua_os</a></td>
                                    <td>".$abre_os_status."</td>
                                    <input name='xos' value='$xos' type='hidden'>";
                        echo"
                                </tr>
                            </table>";
                }elseif($callcenter AND in_array($login_fabrica,array(190,195))){
                    $sql = "SELECT tbl_os.sua_os, 
                                   tbl_status_checkpoint.descricao, 
                                   tbl_tipo_atendimento.descricao AS descricao_tipo
                                FROM tbl_os
                                JOIN tbl_hd_chamado_item ON tbl_os.os = tbl_hd_chamado_item.os 
                                LEFT JOIN tbl_status_checkpoint ON tbl_os.status_checkpoint = tbl_status_checkpoint.status_checkpoint
                                LEFT JOIN tbl_tipo_atendimento ON tbl_tipo_atendimento.tipo_atendimento = tbl_os.tipo_atendimento AND tbl_tipo_atendimento.fabrica=$login_fabrica
                                WHERE tbl_hd_chamado_item.hd_chamado=$callcenter ";

                    $res = pg_query($con, $sql);
                    if (pg_num_rows($res) > 0) {

                        echo "  <table class='tabela'>
                                    <tr class='titulo_tabela'>
                                        <th>OS</th>
                                        <th>Status</th>
                                        <th>ação</th>
                                    </tr>";

                                    foreach (pg_fetch_all($res) as $key => $value) {
                                        if ($value['descricao_tipo'] == "Orçamento") {
                                            $tr_lanca = "<a target='_blank' href='cadastro_os.php?os_id=".$value['sua_os']."'>Lançar Itens</a>";
                                        }
                                echo "
                                    
                                    <tr>
                                        <td style='padding:5px;'><a href='os_press.php?os=".$value['sua_os']."' target='_blank'>".$value['sua_os']."</a></td>
                                        <td style='padding:5px;'>".$value['descricao']."</td>
                                        <input name='xos' value='".$value['sua_os']."' type='hidden'>
                                        <td style='padding:5px;'>".$tr_lanca."</td>

                            
                                    </tr>";
                                }
                                echo"</table>";
                    }
                }
            }

            echo ($login_fabrica == 156 && strlen($cliente_admin) > 0 || in_array($login_fabrica, array(164,169,170,171,189,190,193,195))) ? "" : "<div id='imprimir_os' $display  $display_imprimir_os ><strong>&nbsp;&nbsp;&nbsp;&nbsp;<input type='checkbox' name='imprimir_os' value='t'> Imprimir OS</strong></div>";

            //hd-3624967 - fputti
            if (in_array($login_fabrica, array(171))) {

                if (strlen($callcenter) > 0 && $abre_ordem_servico == 't' AND empty($msg_erro)) {
                    $display = "block";
                    $disabledGrohe = "disabled";
                }

                if (empty($tipo_atendimento_grohe)){
                    $tipo_atendimento_grohe = $_POST["tipo_atendimento_grohe"];
                }

                $checkedProjeto = ($projeto == 't') ? "checked" : "";
                echo "<div id='extra_grohe' style='display:$display'>
                        <strong>&nbsp;&nbsp;&nbsp;&nbsp;<input type='checkbox' $disabledGrohe {$checkedProjeto} name='projeto' value='t'> Canal Projetos</strong><br />
                        <label>Tipo de Atendimento: </label>
                        <select name='tipo_atendimento_grohe' $disabledGrohe >
                        <option value=''>Escolha</option>";

                        $sql = "SELECT tipo_atendimento,
                                       descricao,
                                       codigo,
                                       fora_garantia,
                                       km_google
                                  FROM tbl_tipo_atendimento
                                 WHERE fabrica = $login_fabrica
                              ORDER BY descricao ASC";
                        $res = pg_query($con, $sql);

                        if (pg_num_rows($res) > 0) {
                            while ($rows = pg_fetch_array($res)) {
                                $selectedTipo = ($tipo_atendimento_grohe == $rows['tipo_atendimento']) ? "selected" : "";
                                echo "<option km-google='".$rows['km_google']."' fora-garantia='".$rows['fora_garantia']."' value='".$rows['tipo_atendimento']."' {$selectedTipo}>".$rows['codigo']." - ".$rows['descricao']."</option>";
                            }
                        }

                echo "  </select>
                      </div>" ;

            }
            echo "</td>";

            /*HD - 4258409*/
            if (in_array($login_fabrica, array(85))) {
                if (!empty($callcenter)) {
                    $aux_sql = "SELECT array_campos_adicionais FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter LIMIT 1";
                    $aux_res = pg_query($con, $aux_sql);

                    $campos_add = json_decode(pg_fetch_result($aux_res, 0, 'array_campos_adicionais'), true);

                    if (!empty($campos_add["tecnico_esporadico_id"])) {
                        $aux_disabled      = '$("#abre_os").attr("disabled", "disabled");';
                        $aux_check_tec_esp = "checked";

                        $tecnico_esporadico_id   = $campos_add["tecnico_esporadico_id"];
                        $valor_servico_combinado = "R$ " . str_replace(".", ",", $campos_add["valor_servico_combinado"]);

                        $aux_sql = "SELECT codigo_externo, nome FROM tbl_tecnico WHERE tecnico = $tecnico_esporadico_id";
                        $aux_res = pg_query($con, $aux_sql);

                        $codigo_tecnico_esporadico = pg_fetch_result($aux_res, 0, 'codigo_externo');
                        $tecnico_esporadico        = pg_fetch_result($aux_res, 0, 'nome');
                    }

                }
            ?>
                <script type="text/javascript">
                    function fnc_pesquisa_tecnico_esporadico (tipo, valor) {
                        var url = "pesquisa_tecnico_esporadico.php?tipo=" + tipo + "&valor=" + valor + "&fabrica=" + <?=$login_fabrica;?>;

                        Shadowbox.open({
                            content :   url,
                            player  :   "iframe",
                            title   :   "Pesquisa",
                            width   :   800,
                            height  :   500
                        });
                    }

                    function retorna_tecnico_esporadico (tecnico_id, codigo, nome) {
                        $("#tecnico_esporadico_id").val(tecnico_id);
                        $("#codigo_tecnico_esporadico").val(codigo);
                        $("#tecnico_esporadico").val(nome);
                    }


                    $(function() {
                        <?=$aux_disabled;?>

                        if ($("#check_tecnico_esporadico").is(':checked')) {
                            $("#abre_os").attr("disabled", "disabled");
                        }

                        $("#valor_servico_combinado").maskMoney({
                             prefix: "R$ ",
                             decimal: ",",
                             thousands: "."
                         });

                        $("#check_tecnico_esporadico").click(function() {
                            if ($(this).is(':checked')) {
                                $("#abre_os").attr("disabled", "disabled");
                            } else {
                                $("#abre_os").removeAttr("disabled");
                            }
                        });

                        $("#abre_os").click(function() {
                            if ($(this).is(':checked')) {
                                $("#check_tecnico_esporadico").attr("disabled", "disabled");
                                $("#tecnico_esporadico_id").attr("disabled", "disabled");
                                $("#codigo_tecnico_esporadico").attr("disabled", "disabled");
                                $("#tecnico_esporadico").attr("disabled", "disabled");
                                $("#valor_servico_combinado").attr("disabled", "disabled");
                                $("#tecnico_esporadico_id").val("");
                                $("#codigo_tecnico_esporadico").val("");
                                $("#tecnico_esporadico").val("");
                                $("#valor_servico_combinado").val("");
                            } else {
                                $("#check_tecnico_esporadico").removeAttr("disabled");
                                $("#tecnico_esporadico_id").removeAttr("disabled");
                                $("#codigo_tecnico_esporadico").removeAttr("disabled");
                                $("#tecnico_esporadico").removeAttr("disabled");
                                $("#valor_servico_combinado").removeAttr("disabled");
                            }
                        });
                    });
                </script>

                <td>
                    <input type="hidden" name="tecnico_esporadico_id" id="tecnico_esporadico_id" value="<?=$tecnico_esporadico_id;?>">
                    <input type="checkbox" name="check_tecnico_esporadico" id="check_tecnico_esporadico" class='class_169' <?=$aux_check_tec_esp;?> >&nbsp;
                    <strong>Técnico Esporádico</strong>
                </td>
                <td>
                    <strong>Código</strong>
                    <input name="codigo_tecnico_esporadico" id="codigo_tecnico_esporadico" class="input" type="text" size="10" maxlength="10" spellcheck="true" value="<?=$codigo_tecnico_esporadico;?>">
                    <img src="imagens/lupa.png" id="lupa_referencia_produto" border="0" align="absmiddle" style="cursor: pointer" onclick="fnc_pesquisa_tecnico_esporadico('codigo',document.getElementById('codigo_tecnico_esporadico').value);">
                </td>
                <td colspan="2">
                    <strong>Nome</strong>
                    <input name="tecnico_esporadico" id="tecnico_esporadico" class="input" type="text" size="35" maxlength="50" spellcheck="true" value="<?=$tecnico_esporadico;?>">
                    <img src="imagens/lupa.png" id="lupa_referencia_produto" border="0" align="absmiddle" style="cursor: pointer" onclick="fnc_pesquisa_tecnico_esporadico('nome',document.getElementById('tecnico_esporadico').value);">
                </td>
                <td colspan="3">
                    <strong>Valor do Serviço Combinado</strong>
                    <input name="valor_servico_combinado" id="valor_servico_combinado" class="input" type="text" size="15" maxlength="15" spellcheck="true" value="<?=$valor_servico_combinado;?>">
                </td>
            <?php }

            echo "</tr>";

            if (in_array($login_fabrica, array(30,50,190,195))) {

                if (!empty($os)) {
                    $sqlV = "SELECT TO_CHAR(data,'DD/MM/YYYY') AS data, os_visita FROM tbl_os_visita WHERE os = $os ORDER BY data";
                    $resV = pg_query($con,$sqlV);

                    if (pg_num_rows($resV) > 0) {

                        for($i = 0; $i < pg_num_rows($resV); $i++){
                            $data_agendamento = pg_fetch_result($resV,$i,'data');
                            $os_visita = pg_fetch_result($resV,$i,'os_visita');
                            $linha = $i + 1;
                            echo "<tr class='abre_os_os' $exibe_oculta_os>";
                            echo "<td style='text-align:left;font-weight:bold;' nowrap>Data Agendamento {$linha}</td>";
                            echo "<td>
                                    <input type='text' class='input' rel='data' name='data_agendamento[]' size='10' maxlength='12' value='{$data_agendamento}' />
                                    <input type='hidden' name='os_visita[]' value='{$os_visita}' />
                                    </td>";
                            echo "</tr>";
                        }
                        echo "<tr class='abre_os_os' $exibe_oculta_os>";
                        echo "<tr><td colspan='100%'>&nbsp;</td></tr>";
                    }
                }else{

?>
                    <tr class='abre_os_os abre_os_os_agendamento' <?php echo $exibe_oculta_os;?>>
                        <td style="text-align:left;font-weight:bold;" nowrap>Data Agendamento</td>
                        <td><input type="text" class="input" rel="data" id="data_agendamento" name="data_agendamento[]" value="<?=$_POST['data_agendamento'][0]?>" size="10" maxlength="12" /></td>

		                <?php 
		                if (in_array($login_fabrica, array(190,195))) {
		                    if ($xperiodo == "manha" OR $periodo == "manha"){
		                        $selected_periodo_manha = "selected";
		                    }

		                    if ($xperiodo == "tarde" OR $periodo == "tarde"){
		                        $selected_periodo_tarde = "selected";
		                    }
		                ?>
                        <td style="text-align:left;font-weight:bold;" nowrap>Período</td>
                        <td>
                            <select name='periodo'>
                                <option value="">Selecione</option>
                                <option value="manha" <?=$selected_periodo_manha?> >Manhã</option>
                                <option value="tarde" <?=$selected_periodo_tarde?> >Tarde</option>
                            </select>
                        </td>

                <?php }?>


                <?php
                }
                $display_limite = (!empty($data_limite) || !empty($cliente_nome_admin)) ? "block" : "none";
//                 echo $data_limite." -- ".
                ?>
                        <td class="limite" style="text-align:left;font-weight:bold;display:<?=$display_limite?>;" nowrap>Data Limite</td>
                        <td class="limite" style="display:<?=$display_limite?>;"><input type="text" class="input" rel="data" id="data_limite" name="data_limite" value="<?=$data_limite?>" size="10" maxlength="12" /></td>
                    </tr>

                    <tr class="agendamento abre_os_os" <?php echo $exibe_oculta_os;?>>
                        <td style="text-align:left;font-weight:bold;">Observação</td>
                        <td colspan="3">
                            <textarea name="observacao_os" id="observacao_os" rows="4" class="input" cols="45"><?=$observacao_os?></textarea>
                        </td>

                        <?php if($login_fabrica == 30){ ?>

                        <td <?php echo $display_backoffice_cb; ?> width="100px" class="backoffice_cb"> <strong>Orientação ao Posto</strong> </td>
                        <td colspan="3" class="backoffice_cb" <?php echo $display_backoffice_cb; ?> >
                            <textarea name="orientacao_posto" id="orientacao_posto" rows="4" class="input" cols="45"><?=$orientacao_posto?></textarea>
                        </td>

                        <?php } ?>

                    </tr>
    <?

            }
            ?>
            </td>
        </tr>


       <tr>
            <?php if(in_array($login_fabrica, array(186))){?>
                <td align='left'><strong>Obs. OS:</strong></td>
                <td align='left'>
                    <textarea name="observacao_os" id="observacao_os" class="input" cols="45"><?=$observacao_os?></textarea>
                </td>
            <?php }?>
        </tr>

        <tr>
            <td colspan="6">

                <?php
                    if($login_fabrica == 85){
                        echo $button_reabrir_os;
                    }
                ?>

            </td>
        </tr>

        </table>
<?
    }

    if ($login_fabrica == 162) {
        $display = "display:none;";
        if (!empty($posto_interno_tab)) {
            $display = "";
        }
?>
    <div id="posto_interno" style="<?=$display?>">
    <table>
        <tr>
            <td><strong>Informações adicionais do produto (Posto Interno)</strong></td>
        </tr>
    </table>
    <table id="tbl_posto_interno" width="100%" border ="0" align="center" cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;;'>
        <tr>
            <td width="96" style="font-weight:bold">Aparência</td>
            <td>
                <input class="input" id="interno_aparencia" type="text" name="interno_aparencia" value="<?=$interno_aparencia?>">
            </td>
            <td width="96" style="font-weight:bold">Acessórios</td>
            <td>
                <input class="input" id="interno_acessorios" type="text" name="interno_acessorios" value="<?=$interno_acessorios?>">
            </td>
            <td width="96" style="font-weight:bold">Tipo Atendimento</td>
            <td>
                <select id="interno_atendimento" name="interno_atendimento">
                    <option value="">ESCOLHA</option>
<?php
    $sqlTipoAtend = "
        SELECT  tipo_atendimento,
                descricao
        FROM    tbl_tipo_atendimento
        WHERE   fabrica = $login_fabrica
        AND     ativo IS TRUE
      --  AND     grupo_atendimento = 'I'
    ";
    $resTipoAtend = pg_query($con,$sqlTipoAtend);

    foreach(pg_fetch_all($resTipoAtend) as $valor) {
?>
                    <option value="<?=$valor['tipo_atendimento']?>" <?=($valor['descricao'] == "Atendimento Balcão") ? "selected" : ""?>><?=$valor['descricao']?></option>
<?php
    }
?>
                </select>
            </td>
        </tr>
        <tr>
            <td width="96" style="font-weight:bold;vertical-align:top;">Observação</td>
            <td colspan="5">
                <textarea id="interno_observacao" name="interno_observacao" cols="80"><?=$interno_observacao?></textarea>
            </td>
        </tr>
    </table>
    </div>
    <table>
        <tr>
            <td><strong>Informações do Cliente</strong></td>
        </tr>
    </table>
    <table id="tbl_informacao" width="100%" border ="0" align="center" cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;;'>
        <tr>
            <td width="120" style="font-weight:bold">Perfil do Cliente</td>
            <td>
                <select name="perfil_cliente">
                    <option value="">Selecione o Perfil</option>
                    <option value="normal" <?php if ($perfil_cliente == "normal" ){echo " selected ";} ?> >Normal</option>
                    <option value="critico" <?php if ($perfil_cliente == "critico" ){echo " selected ";} ?> >CrÃ­tico</option>
                    <option value="Super Critico" <?php if ($perfil_cliente == "Super Critico" ){echo " selected ";} ?> >Super CrÃ­tico</option>
                    <option value="nervoso" <?php if ($perfil_cliente == "nervoso" ){echo " selected ";} ?> >Nervoso</option>
                </select>
            </td>

            <td width="120" style="font-weight:bold">Pedido do Cliente</td>
            <td>
                <select name="pedido_cliente">
                    <option value="">Selecione o Pedido Cliente</option>
                    <option value="Ressarcimento" <?php if ($pedido_cliente == "Ressarcimento" ){echo " selected ";} ?> >Ressarcimento</option>
                    <option value="Troca"  <?php if ($pedido_cliente == "Troca" ){echo " selected ";} ?> >Troca</option>
                    <option value="Reparo Produto"  <?php if ($pedido_cliente == "Reparo Produto" ){echo " selected ";} ?> >Reparo do Produto</option>
                    <option value="Codigo Postagem"  <?php if ($pedido_cliente == "Codigo Postagem" ){echo " selected ";} ?> >Código de Postagem</option>
                    <option value="Orcamento"  <?php if ($pedido_cliente == "Orcamento" ){echo " selected ";} ?> >Orçamento</option>
                    <option value="Prioridade Reparo"  <?php if ($pedido_cliente == "Prioridade Reparo" ){echo " selected ";} ?> >Prioridade no Reparo</option>
                </select>
            </td>
        </tr>
        <tr>
            <td width="120" style="font-weight:bold">Acordo Realizado</td>
            <td>
                <input type="radio" id="acordo_realizado_sim" name="acordo_realizado" value="SIM"  <?php if ($acordo_realizado == "SIM" ){echo " checked ";} ?>>SIM
                <input type="radio" id="acordo_realizado_nao" name="acordo_realizado" value="NAO" <?php if ($acordo_realizado == "NAO" ){echo " checked ";} ?> >NÃO
            </td>

            <td width="120" style="font-weight:bold">Data de Realização</td>
            <td><input type="text" name="data_realizacao_acordo" rel="data" size="10" maxlength="10" value="<?=$data_realizacao_acordo?>"></td>

            <?php if($login_fabrica == 162){
                if($_POST["acordo_realizado"] == "sim" or $acordo_realizado == "SIM"){
                    $tipo_acordo_realizado_display = " block ";
                }else{
                    $tipo_acordo_realizado_display = " none ";
                }

            }
            ?>

            <td width="150" class='tipo_acordo_realizado' style="font-weight:bold; display:<?=$tipo_acordo_realizado_display?>">Tipo de Acordo Realizado</td>
            <td>
                <select name="tipo_acordo_realizado" id="tipo_acordo_realizado" class='tipo_acordo_realizado' style="display:<?=$tipo_acordo_realizado_display?>">
                    <option value="">Selecione Tipo de Acordo</option>
                    <option value="troca"  <?php if ($tipo_acordo_realizado == "troca" ){echo " selected ";} ?> >Troca</option>
                    <option value="Reparo Produto"  <?php if ($tipo_acordo_realizado == "Reparo Produto" ){echo " selected ";} ?> >Reparo do Produto</option>
                    <option value="Ressarcimento" <?php if ($tipo_acordo_realizado == "Ressarcimento" ){echo " selected ";} ?> >Ressarcimento</option>
                    <option value="Troca Superior" <?php if ($tipo_acordo_realizado == "Troca Superior" ){echo " selected ";} ?> >Troca por Superior</option>
                </select>
            </td>
        </tr>
    </table>


<?
    }

    if ($fab_nova_filial) {
        if (!empty($filial["cidade"])) {
            $qry_filial_cidade = pg_query($con, "SELECT nome, estado FROM tbl_cidade WHERE cidade = {$filial["cidade"]}");
            $filial["cidade"] = pg_fetch_result($qry_filial_cidade, 0, 'nome');
            $filial["estado"] = pg_fetch_result($qry_filial_cidade, 0, 'estado');
        }
        ?>
    <table>
        <tr>
            <td><strong>Filial?</strong></td>
        </tr>
    </table>
    <table id="tbl_filial" width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;;'>
        <tr>
            <td colspan="6">
                <input id="sim_encaminha_filial" type="radio" name="encaminha_filial"
                    value="t" <?=($_POST["encaminha_filial"] == "t") ? "checked" : ""?> />
                <label for="sim_encaminha_filial">&nbsp;Sim&nbsp;&nbsp;</label>
                <input id="nao_encaminha_filial" type="radio" name="encaminha_filial"
                    value="" <?=(empty($_POST["encaminha_filial"])) ? "checked" : ""?> />
                <label for="nao_encaminha_filial">&nbsp;Não</label>
            </td>
        </tr>
    <tr class="info_filial">
        <td width="96" style="font-weight:bold">Loja:</td>
        <td>
                <input class="input" id="cod_filial" type="text" name="filial[cod_filial]" value="<?=$filial['cod_filial']?>">
            </td>
    </tr>
        <tr class="info_filial">
            <td width="96" style="font-weight:bold">Razão Social:</td>
            <td>
            <input id="filial" type="hidden" name="filial_id" value="<?=$filial_id?>">
                <input class="input" id="filial_nome" type="text" name="filial[razao_social]" value="<?=$filial['razao_social']?>">
            </td>
            <td width="96" style="font-weight:bold">CNPJ:</td>
            <td><input class="input" id="filial_cnpj" type="text" name="filial[cnpj]" value="<?=$filial['cnpj']?>"></td>
            <td width="96" style="font-weight:bold">Inscrição Estadual:</td>
            <td><input class="input" id="filial_ie" type="text" name="filial[ie]" value="<?=$filial['ie']?>"></td>
        </tr>
        <tr class="info_filial">
            <td width="96" style="font-weight:bold" title="Nome comercial">Fantasia:</td>
            <td><input class="input" id="filial_fantasia" type="text" name="filial[fantasia]" value="<?=$filial['fantasia']?>"></td>
            <td width="96" style="font-weight:bold">Telefone:</td>
            <td><input class="input" id="filial_fone" type="text" name="filial[fone]" value="<?=$filial['fone']?>"></td>
            <td width="96" style="font-weight:bold">CEP:</td>
            <td><input class="input" id="filial_cep" type="text" name="filial[cep]" value="<?=$filial['cep']?>"></td>
        </tr>
        <tr class="info_filial">
            <td width="96" style="font-weight:bold">Endereço:</td>
            <td><input class="input" id="filial_endereco" type="text" name="filial[endereco]" value="<?=$filial['endereco']?>"></td>
            <td width="96" style="font-weight:bold">número:</td>
            <td><input class="input" id="filial_numero" type="text" name="filial[numero]" value="<?=$filial['numero']?>"></td>
            <td width="96" style="font-weight:bold">Complemento:</td>
            <td><input class="input" id="filial_complemento" type="text" name="filial[complemento]" value="<?=$filial['complemento']?>"></td>
        </tr>
        <tr class="info_filial">
            <td width="96" style="font-weight:bold">Bairro:</td>
            <td><input class="input" id="filial_bairro" type="text" name="filial[bairro]" value="<?=$filial['bairro']?>"></td>
            <td width="96" style="font-weight:bold">Cidade:</td>
            <td><input class="input" id="filial_cidade" type="text" name="filial[cidade]" value="<?=$filial['cidade']?>"></td>
            <td width="96" style="font-weight:bold">Estado:</td>
            <td>
        <?php
            echo array2select(
                'filial[estado]', 'filial_estado',
                $estadosBrasil,
                $filial['estado'],
                ' class="input"', 'Estado', true
            );
    ?>
                <button type="button" id="BtnSaveSubsidiary" style="display:none;float:right">Gravar Filial</button>
                <button type="button" id="BtnEditSubsidiary" style="display:none;float:right">Atualizar Filial</button>
            </td>
        </tr>
    </table>
    <? } ?>

    <?php
        if (in_array($login_fabrica, [189])) {
            $array_analise = [
                "Embalagem" => "Embalagem",
                "Erros Operacionais" => "Erros Operacionais",
                "Produto" => "Produto",
            ];
            $sqlTipo = "SELECT tipo_posto FROM tbl_tipo_posto WHERE fabrica={$login_fabrica} AND codigo='REP'";
            $resTipo = pg_query($con, $sqlTipo);
            $tipoPosto = pg_fetch_result($resTipo, 0, 'tipo_posto');
    ?>
        <table width="100%" border='0'>
            <tr>
                <td align='left'><strong>Registros do pedido manual</strong></td>
            </tr>
        </table>
        <table  width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style='border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;padding-bottom:10px;padding-top:10px;'>
            <tr>
                <td align='left' width='450' colspan="2">
                    <strong>Nome do Representante:</strong><br>
                    <input type="text" name="manual_nome_repre" size="50" value="<?php echo $manual_nome_repre;?>">
                    <img src='imagens/lupa.png' border='0' align='absmiddle' style='cursor: pointer' onclick="javascript: fnc_pesquisa_posto_tab(
                            '',
                            document.frm_callcenter.manual_nome_repre,
                            'nome',
                            '',
                            document.frm_callcenter.manual_email_repre,
                            '',
                            '',
                            '',
                            '',
                            '',
                            '',
                            '<?php echo $tipoPosto;?>');
                        ">
                </td>
                <td align='left' colspan="4">
                    <strong>E-mail Representante:</strong><br>
                    <input type="text" name="manual_email_repre" size="35" value="<?php echo $manual_email_repre;?>">
                </td>
            </tr>
            <tr>
                <td align='left' width='190'>
                    <strong>Cód. Transp.:</strong><br>
                    <input type="text" name="manual_cod_transp" size="21" value="<?php echo $manual_cod_transp;?>">

                    <img src='imagens/lupa.png' border='0' align='absmiddle' class="btn_lupa_transporte" data-posicao="1" data-tipo="codigo" style='cursor: pointer'>
                </td>
                <td align='left' width='350'>
                    <strong>Nome Transp.:</strong><br>
                    <input type="text" name="manual_nome_transp" size="45" value="<?php echo $manual_nome_transp;?>">
                    <img src='imagens/lupa.png' border='0' align='absmiddle' class="btn_lupa_transporte" data-posicao="1" data-tipo="nome" style='cursor: pointer'>
                </td>
                <td align='left' width='250'>
                    <strong>Contato Transp.:</strong><br>
                    <input type="text" name="manual_contato_transp" size="35" value="<?php echo $manual_contato_transp;?>">
                </td>
                <td align='left' width='250'>
                    <strong>Fone Transp.:</strong><br>
                    <input type="text" name="manual_fone_transp" size="25" value="<?php echo $manual_fone_transp;?>">
                </td>
                <td align='left' width='250'>
                    <strong>Cidade/UF Transp.:</strong><br>
                    <input type="text" name="manual_end_transp" size="35" value="<?php echo $manual_end_transp;?>">
                </td>
            </tr>
            <tr>
                <td align='left' width='190'>
                    <strong>Cód. Transp. Redespacho:</strong><br>
                    <input type="text" name="manual_cod_transp_redespacho" size="21" value="<?php echo $manual_cod_transp_redespacho;?>">
                    <img src='imagens/lupa.png' border='0' align='absmiddle' style='cursor: pointer' class="btn_lupa_transporte" data-posicao="2" data-tipo="codigo">
                </td>
                <td align='left' width='350'>
                    <strong>Nome Transp. Redespacho:</strong><br>
                    <input type="text" name="manual_nome_transp_redespacho" size="45" value="<?php echo $manual_nome_transp_redespacho;?>">
                    <img src='imagens/lupa.png' border='0' align='absmiddle' style='cursor: pointer' class="btn_lupa_transporte" data-posicao="2" data-tipo="nome">
                </td>
                <td align='left' width='250'>
                    <strong>Contato Transp. Redespacho:</strong><br>
                    <input type="text" name="manual_contato_transp_redespacho" size="35" value="<?php echo $manual_contato_transp_redespacho;?>">
                </td>
                <td align='left' width='250'>
                    <strong>Fone Transp. Redespacho:</strong><br>
                    <input type="text" name="manual_fone_transp_redespacho" size="25" value="<?php echo $manual_fone_transp_redespacho;?>">
                </td>
                <td align='left' width='250'>
                    <strong>Cidade/UF Transp. Redespacho:</strong><br>
                    <input type="text" name="manual_end_transp_redespacho" size="35" maxlength='100' value="<?php echo $manual_end_transp_redespacho;?>">
                </td>
            </tr>
        </table>

        <table width="100%" border='0'>
            <tr>
                <td align='left'><strong>Análise da Reclamação</strong></td>
            </tr>
        </table>
        <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style='padding-bottom:10px;padding-top:10px;border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <tr>
                <td align='left'>
                    <select name="analise_reclamacao" style="width: 250px;" id="analise_reclamacao">
                        <option value="">Selecione ....</option>
                        <?php
                            foreach ($array_analise as $key => $analise) {
                                if($analise == trim($analise_reclamacao)){
                                    $selected = "selected";
                                } else {
                                    $selected = "";
                                }
                            ?>
                        <option value="<?php echo $key;?>" <?php echo $selected;?>><?php echo $analise;?></option>
                        <?php }?>
                    </select>
                </td>

            </tr>
        </table>
    <?php }?>
    <?if (((in_array($login_fabrica, array(81,155, 114, 122, 123, 128))) or $telecontrol_distrib) and !$replica_einhell) {

        if(strlen($callcenter) > 0){

            $sql_ambev = "SELECT array_campos_adicionais FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter";
            $res_ambev = pg_query($con, $sql_ambev);

            if(pg_num_rows($res_ambev) > 0){

                $arr_ambev = pg_fetch_result($res_ambev, 0, "array_campos_adicionais");
                $arr_ambev = preg_replace('/\n|\r/','   ',$arr_ambev);
                $arr_ambev = json_decode($arr_ambev, true);

                foreach ($arr_ambev as $key => $value) {
                    $arr_ambev[$key] =  utf8_decode($value);
                }

                /*
                    Array // Exemplo
                    (
                        [atendimento_ambev] => t
                        [codigo_ambev] => teste
                        [data_fabricacao_ambev] => 26/02/2016
                        [data_encerramento_ambev] => 06/05/2016
                        [atendimento_ambev_nome] => teste
                        [garantia_estendida_ambev] => f
                        [consumidor_cpf_cnpj] => C
                        [voltagem] => 110 V
                    )
                */
                extract($arr_ambev);

            }

        }
	$descricao_analise = str_replace("\\\\u","\\u",$descricao_analise);
	$str     = str_replace('\u','u',$descricao_analise);
	$descricao_analise = preg_replace('/u([\da-fA-F]{4})/', '&#x\1;', $str);

    ?>

    <script>

        $(function () {
            $("input[name='origem_reclamacao[]'][value=outro]").change(function () {
                if ($(this).is(":checked")) {
                    $("input[name=origem_reclamacao_outro]").show();
                } else {
                    $("input[name=origem_reclamacao_outro]").hide().val("");
                }
            });
        });
    </script>

    <table width="100%" border='0'>
        <tr>
            <td align='left'><strong>Análise da Reclamação</strong></td>
        </tr>
    </table>
    <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>

            <tr>
                <td align='left'><strong>Produto:</strong></td>
                <td align='left'>
                    <input name="referencia_adi" class="input" value='<? echo $referencia_adi ;?>' type="text" size="40" maxlength="60">
                </td>
                <td align='left'><strong>Quantidade:</strong></td>
                <td align='left'>
                    <input name="qtde_adi"  class="input" value="<?php echo $qtde_adi ;?>" type="text" size='4' maxlength='4' >
                </td>
            </tr>
            <tr>
                <td align='left'><strong>Recebido:</strong></td>
                <td align='left'><input type='text' name='recebido' class="input" value='<?=$recebido?>'  size="13" maxlength="13" rel='data'>
                </td>
                <td align='left'><strong>Análise:</strong></td>
                <td align='left'><input type='text' name='analise' id='analise' class="input" value='<?=$analise?>' size="13" maxlength="13" rel="data">

                </td>
            </tr>
            <tr>
                <td align='left'><strong>Validade:</strong></td>
                <td align='left'><input type='text' name='validade' id='validade' class="input" value='<?=$validade?>' size="13" maxlength="8" rel='mes_ano'>
                </td>
                <td align='left'><strong>Lote:</strong></td>
                <td align='left'><input type='text' name='lote' id='lote' class="input" value='<?=$lote?>' size="30" >
                </td>
            </tr>
            <tr>
                <td align='left'><strong>Origem:</strong></td>
                <td align='left'><input type='text' name='origem_adi' id='origem_adi' class="input" value='<?=$origem_adi?>' size="30" >
                </td>
                <td align='left'><strong>Acompanhado De :</strong></td>
                <td align='left' colspan='2'><input type='text' name='aco_de' id='aco_de' class="input" value='<?=$aco_de?>'  size="30">
                </td>
            </tr>
            <tr>
                <td align='left'><strong>Status da Reclamação:</strong></td>
                <td align='left'>
                <input type='radio' name='procedente'  class="input" value='procedente' <?if ($procedente == 'procedente') echo " checked "?>  >PROCEDENTE
                <input type='radio' name='procedente'  class="input" value='improcedente'<?if ($procedente == 'improcedente') echo " checked "?> >IMPROCEDENTE
                <input type='checkbox' name='reposicao'  class="input" value='reposicao' <?if ($reposicao == 'reposicao') echo " checked "?> >FAZER REPOSIÃÃO
                </td>
                <td align='left'><strong>Disposição:</strong></td>
                <td align='left'><input type='text' name='disposicao' id='disposicao' class="input" value='<?=$disposicao?>' size="30" >
                </td>
            </tr>

            <tr>
                <td align='left'><strong>Descrição Da Análise</strong></td>
                <td colspan="5"><textarea name="descricao_analise" rows="6" cols="110" class="input" style="font-size: 10px;"><?=$descricao_analise?></textarea></td>
            </tr>
            </table>
        </div>

    <?}?>
    <br>

    <div rel='div_ajuda' style='display:inline; Position:relative;'>
        <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
        <tr>
            <td align='right' width='150'></td>
            <td align='right' width='55'><img src='imagens/ajuda_call.png' align=absmiddle></td>
            <td align='center'><STRONG><?echo$consumidor_nome;?></STRONG><BR>
            <?
            $sql = "SELECT pergunta FROM tbl_callcenter_pergunta WHERE codigo='3' AND fabrica = $login_fabrica";
            $pe = pg_query($con,$sql);
            echo (pg_num_rows($pe)>0) ? pg_fetch_result($pe,0,0) : "em que posso ajudá-lo?";
            ?>
            </td>
            <td align='right' width='150'></td>
        </tr>
        </table>
    </div>
    </td>
</tr>

<?php if($login_fabrica == 101){
    echo "<tr>";
        echo "<td style='font-size:16px'> <strong> Natureza/Motivo de Contato </strong> </td>";
    echo "</tr>";
    }
?>
<tr>
    <td align='left'>
        <br />
        <?php
        if (strlen($callcenter) > 0 and strlen($msg_erro) == 0) {
            $tab_atual = $natureza_chamado;
        } else if (strlen($tab_atual) == 0) {
            $tab_atual = "reclamacao_produto";
        }
        if(in_array($login_fabrica, array(169,170))){
            if(strlen(trim($callcenter)) == 0){
                $tabs_ativas = $_POST['tabs_ativas'];
            }else{
                $sql = "SELECT  tbl_natureza.nome
                        FROM tbl_hd_motivo_ligacao
                        JOIN tbl_natureza ON tbl_natureza.natureza = tbl_hd_motivo_ligacao.natureza
                            AND tbl_natureza.fabrica = {$login_fabrica}
                        WHERE tbl_hd_motivo_ligacao.fabrica = {$login_fabrica}
                        AND tbl_hd_motivo_ligacao.hd_classificacao = {$hd_classificacao}
                        AND tbl_hd_motivo_ligacao.ativo IS TRUE
                        ORDER BY tbl_hd_motivo_ligacao.descricao ASC";
                $res = pg_query($con, $sql);

                $tabs_ativas = implode(',', pg_fetch_all_columns($res));
            }

            if(strlen(trim($id_hd_motivo_ligacao)) == 0){
                $id_hd_motivo_ligacao = $_POST['id_hd_motivo_ligacao'];
            }

            echo "<input type='hidden' name='categoria_anterior' value='".$categoria_anterior."'>";
        }
        ?>

        <input type='hidden' name='tab_atual' id='tab_atual' value='<? echo $tab_atual; ?>' >
        <input type="hidden" name="id_hd_motivo_ligacao" id="id_hd_motivo_ligacao" value="<?=$id_hd_motivo_ligacao?>">
        <input type="hidden" name='tabs_ativas' id='tabs_ativas' value='<?=$tabs_ativas?>'>
        <div id="container-Principal"><?php

        if ($usuario_abriu == 2473 && $login_fabrica == 24) {//HD 262718?>

            <strong>DESEJA FALAR SOBRE: </strong>
            <select name='tipo_contato_categoria' id='tipo_contato_categoria' onchange="alteraAba(this.value)">
                <option value=''></option><?php
                $vet_ordem = array(1,2,3,4,6,8);
                $xx = 0;
                foreach ($assuntos AS $topico => $opcoes) {
                    echo " <option value='".$vet_ordem[$xx]."' ".($topico == $tipo_contato_categoria ? "selected='selected'" : '').">$topico</option>";
                    $xx++;
                }?>
            </select>

            <br />
            <br /><?php

        }?>

        <ul><?php
            if ($login_fabrica == 25) {?>
                <li>
                    <a href="#extensao" rel="extensao" id='extensao_click'>
                    <span><img src='imagens/garantia_estendida.png' width='10' align="absmiddle">Garantia</span>
                    </a>
                </li><?php
            }
                if(!in_array($login_fabrica, array(169,170))){
                    $tabs_selected = "class='tabs-selected'";
                }

            ?>


 			<li <?php if( empty($callcenter) || in_array($login_fabrica, array(158,198)) ){ 
                echo $tabs_selected; /* HD 896924 - setando a aba */ }
            ?> >
				<a href="#reclamacao_produto" <?php if(in_array($login_fabrica, array(169,170))){ ?> onClick="valida_aba_atendimento('reclamacao_produto');" <?php } ?> id="reclamacao_produto_click" rel="reclamacao_produto">
				<span>
				<!--<img src='imagens/rec_produto.png' width='10' align="absmiddle" alt='Reclamao Produto/Defeito'>-->Reclamação</span>
				</a>
			</li><?php

			if (!in_array($login_fabrica, [2,42,178,184,186,189,191,193,198,200])) { ?>
				<li>
					<a href="#reclamacao_empresa" <?php if(in_array($login_fabrica, array(169,170))){ ?> onClick="valida_aba_atendimento('reclamacao_empresa');" <?php } ?> rel="reclamacao_empresa" id="reclamacao_empresa_click">
						<span><!--<img src='imagens/rec_empresa.png' width='10' align="absmiddle" alt='Reclamao Empresa'>--><?php
						if ($login_fabrica == 24) {
							echo "Empresa";
						} else {
							echo "Recl. Empresa";
						}?>
						</span>
					</a>
				</li>
				<li><?php
					if (($login_fabrica == 11 or $login_fabrica == 172) and strlen($tipo_reclamacao) > 0) {

						if (in_array($tipo_reclamacao, $sub_tipo_reclamacao)) {
							$tab_atual = 'reclamacao_at';
						}

                        if (in_array($tipo_reclamacao, $sub_tipo_reclamacao)) {
                            $tab_atual = 'reclamacao_at';
                        }

                    }?>
                    <a href="#reclamacao_at" <?php if(in_array($login_fabrica, array(169,170))){ ?> onClick="valida_aba_atendimento('reclamacao_at');" <?php } ?> rel="reclamacao_at" id='reclamacao_at_click'>
                        <span><!--<img src='imagens/rec_empresa.png' width='10' align="absmiddle" alt='Reclamao Assistncia Tcnica'>-->
                        <? echo ($login_fabrica==11 or $login_fabrica == 172) ? "A.T." : "Recl. A.T."; ?>
                        </span>
                    </a>
                </li><?php

            }

            if ($login_fabrica == 2) {

                if ($tab_atual == 'reclamacao_at') {// or $tab_atual == 'reclamacao_produto')
                    $tab_atual = "reclamacoes";
                }?>

                <li>
                    <a href="#reclamacoes" rel="reclamacoes" id ='reclamacoes_click'>
                    <span><!--<img src='imagens/rec_empresa.png' width='10' align="absmiddle" alt='Reclamao Assistncia Tcnica'>-->ReclamaçÃµes</span>
                    </a>
                </li><?php

            }?>

            <?php if (!in_array($login_fabrica, array(42,178,184,186,189,191,193,195,198,200))){ ?>
            <li>
                <a href="#duvida_produto" <?php if(in_array($login_fabrica, array(169,170))){ ?> onClick="valida_aba_atendimento('duvida_produto');" <?php } ?> rel="duvida_produto" id='duvida_produto_click' >
                <span><!--<img src='imagens/duv_produto.png' width='10' align=absmiddle>-->Dúvida Prod.</span>
                </a>
            </li>
            <?php }

            if(!in_array($login_fabrica, [42,178,184,186,189,191,193,195,198,200])){  ?>
            <li>
                <a href="#sugestao" rel="sugestao" <?php if(in_array($login_fabrica, array(169,170))){ ?> onClick="valida_aba_atendimento('sugestao');" <?php } ?> id='sugestao_click'>
                <span><!--<img src='imagens/sugestao_call.png' width='10' align=absmiddle>-->Sugestão</span>
                </a>
            </li><?php
            }

            if (!in_array($login_fabrica, array(42,59,169,170,178,184,186,189,191,193,195,198,200))) {
                if ($login_fabrica == 11 or $login_fabrica == 172) {

                    if ($natureza_chamado2 == 'reclamacao_at_procon') {
                        $tab_atual = 'procon';
                    }

                }?>

                <li>
                    <a href="#procon" rel="procon" id='procon_click'>
                    <span><!--<img src='imagens/lupa.png' width='10' align=absmiddle>-->Procon/Jec.</span>
                    </a>
                </li><?php
            }

            if (!in_array($login_fabrica, array(42,178,184,186,189,191,193,195,198,200))){
            ?>
            <li>
                <a href="#onde_comprar" rel="onde_comprar" <?php if(in_array($login_fabrica, array(169,170))){ ?> onClick="valida_aba_atendimento('onde_comprar');" <?php } ?> id='onde_comprar_click'>
                <span><!--<img src='imagens/lupa.png' width='10' align=absmiddle>-->Onde Comprar</span>
                </a>
            </li>
            <?php
            }
            if($login_fabrica == 101){?>
            <li>
                <a href="#elogio" rel="elogio" id='elogio_click'>
                <span><!--<img src='imagens/lupa.png' width='10' align=absmiddle>-->Elogio</span>
                </a>
            </li>
            <li>
                <a href="#produto_acessorio_nao_entregue" rel="produto_acessorio_nao_entregue" id='produto_acessorio_nao_entregue_click'>
                <span><!--<img src='imagens/lupa.png' width='10' align=absmiddle>-->Produto/Acessório Não Entregue</span>
                </a>
            </li>
            <?php
            }
            if ($login_fabrica == 85) {
            ?>
                <li>
                    <a href="#garantia_contratual" rel="garantia_contratual" id='garantia_contratual_click'>
                    <span><!--<img src='imagens/lupa.png' width='10' align=absmiddle>-->Garantia Contratual</span>
                    </a>
                </li>
            <?php
            }

            if ($login_fabrica == 45) {?>
                <li>
                    <a href="#garantia" rel="garantia" id='garantia_click'>
                    <span><!--<img src='imagens/garantia_estendida.png' width='10' align="absmiddle">-->Garantia</span>
                    </a>
                </li><?php
            }

            if ($login_fabrica==1 and strlen($callcenter) > 0) {?>
                <li>
                    <a href="#hd_posto" rel="hd_posto" id='hd_posto_click'>
                    <span><!--<img src='imagens/garantia_estendida.png' width='10' align="absmiddle">-->HD Posto</span>
                    </a>
                </li><?php
            }

            if ((in_array($login_fabrica, array(59,81,155,114))) or $telecontrol_distrib) {
            ?>
                    <li>
                        <a href="#ressarcimento" rel="ressarcimento" id='ressarcimento_click'>
                        <span><!--<img src='imagens/garantia_estendida.png' width='10' align="absmiddle">-->Ressarcimento</span>
                        </a>
                    </li>
            <?php

                if (!in_array($login_fabrica, array(81,155,114))) {?>
                    <li>
                        <a href="#sedex_reverso" rel="sedex_reverso" id='sedex_reverso_click'>
                        <span><!--<img src='imagens/garantia_estendida.png' width='10' align="absmiddle">-->Sedex Reverso</span>
                        </a>
                    </li><?php
                }

            }

            if ($login_fabrica == 24) {?>
                <li>
                    <a href="#outros_assuntos" rel="outros_assuntos" id='outros_assuntos_click'>
                    <span><!--<img src='imagens/garantia_estendida.png' width='10' align="absmiddle">-->Outros Assuntos</span>
                    </a>
                </li><?php
            }?>

            <?php
            if ($login_fabrica == 94) {?>
                <li>
                    <a href="#indicacao_rev" rel="indicacao_rev" id='indicacao_rev_click'>
                    <span>Indicação Revenda</span>
                    </a>
                </li>
                <li>
                    <a href="#indicacao_at" rel="indicacao_at" id='indicacao_at_click'>
                    <span>Indicação A.T.</span>
                    </a>
                </li>
            <?php
            }

            if ($login_fabrica == 74) {
            ?>
                <li>
                    <a href="#informacoes" rel="informacoes" id ='informacoes_click'>
                    <span>Informacoes</span>
                    </a>
                </li>
                <li>
                    <a href="#garantia_adicional" rel="garantia_adicional" id ='garantia_adicional_click'>
                    <span>Garantia Adicional</span>
                    </a>
                </li>
            <?php
            }
            if($login_fabrica == 85 ){?>
                <li>
                    <a href="#garantia_estendida" rel="garantia_estendida"  id ='garantia_estendida_click'>
                    <span>Garantia Estendida</span>
                    </a>
                </li>
            <?php }
            if ($login_fabrica == 165) { ?>
                <li>
                    <a href="#indicacao_instalador" rel="indicacao_instalador"  id ='indicacao_instalador_click'>
                    <span>Indic. de Instalador</span>
                    </a>
                </li>
            <?php }
            if(in_array($login_fabrica, array(169,170))){ ?>
                <li>
                    <a href="#indicacao_at" <?php if(in_array($login_fabrica, array(169,170))){ ?> onClick="valida_aba_atendimento('indicacao_at');" <?php } ?> rel="indicacao_at"  id ='indicacao_at_click'>
                        <span>Indicação de Assistência Técnica</span>
                    </a>
                </li>
                <li>
                    <a href="#informacao" <?php if(in_array($login_fabrica, array(169,170))){ ?> onClick="valida_aba_atendimento('informacao');" <?php } ?> rel="informacao"  id ='informacao_click'>
                        <span>Informação</span>
                    </a>
                </li>
            <?php
            }
            ?>
        </ul><?php

        if ($login_fabrica == 25) {?>

            <div id="extensao" class='tab_content'>

                <div rel='div_ajuda' style='display:inline; Position:relative;'><?php

                if (strlen($callcenter) == 0) {?>

                    <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
                        <tr>
                            <td align='right' width='150'></td>
                            <td align='right' width='55'>
                                <img src='imagens/ajuda_call.png' align=absmiddle>
                            </td>
                            <td align='center'>
                                <STRONG>Oferecer Garantia Estendida.</STRONG><br />
                                O Sr.(a) gostaria de cadastrar a garantia estendida do seu produto?
                            </td>
                            <td align='right' width='150'></td>
                        </tr>
                    </table><?php

                }?>

                Informações do Produto

                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                    <tr>
                        <td align='left'><strong>Referência:</strong></td>
                        <td align='left'>
                            <input name="produto_referencia_es" id="produto_referencia_es"  class="input"  value='<?echo $produto_referencia ;?>'
                            onblur="fnc_pesquisa_produto (document.frm_callcenter.produto_referencia_es,document.frm_callcenter.produto_nome_es,'referencia')" type="text" size="10" maxlength="15">
                            <img src='imagens/lupa.png' border='0' align='absmiddle'
                            style='cursor: pointer'
                            onclick="fnc_pesquisa_produto (document.frm_callcenter.produto_referencia,document.frm_callcenter.produto_nome,'descricao')">
                        </td>
                        <td align='left'><strong>Descrição:</strong></td>
                        <td align='left'>
                            <input type='hidden' name='produto' value="<? echo $produto; ?>">
                            <input name="produto_nome_es"  id="produto_nome_es"  class="input" value='<?echo $produto_nome ;?>'
                            onblur="fnc_pesquisa_produto (document.frm_callcenter.produto_referencia_es,document.frm_callcenter.produto_nome_es,'descricao')" type="text" size="30" maxlength="500">
                            <img src='imagens/lupa.png' border='0' align='absmiddle'
                            style='cursor: pointer'
                            onclick="fnc_pesquisa_produto (document.frm_callcenter.produto_referencia,document.frm_callcenter.produto_nome,'descricao')">
                        </td>
                        <td align='left'><strong>Série:</strong></td>
                        <td align='left'>
                            <input name="serie_es" id='serie_es' maxlength="20" class="input"  value='<?echo $serie ;?>'>
                        </td>
                        <td align='left'><?php
                        if (strlen($callcenter) == 0) {?>
                            <INPUT TYPE="button" onClick='fn_verifica_garantia();' name='Verificar' value='Verificar'><?php
                        }?>
                        </td>
                    </tr>
                    <tr>
                        <td colspan='7'>

                            <div id='div_estendida'><?php

                            if (strlen($callcenter) > 0) {

                                if (strlen($serie) > 0) {

                                    include "conexao_hbtech.php";

                                    $sql = "SELECT idNumeroSerie ,
                                                    idGarantia   ,
                                                    revenda      ,
                                                    cnpj
                                            FROM numero_serie
                                            WHERE numero = '$serie'";

                                    $res = mysql_query($sql) or die("Erro no Sql:".mysql_error());

                                    if (mysql_num_rows($res) > 0) {

                                        $idNumeroSerie = mysql_result($res, 0, 'idNumeroSerie');
                                        $idGarantia    = mysql_result($res, 0, 'idGarantia');
                                        $es_revenda    = mysql_result($res, 0, 'revenda');
                                        $es_cnpj       = mysql_result($res, 0, 'cnpj');

                                        if (strlen($idGarantia) > 0) {

                                            $sql = "SELECT  nf                ,
                                                            dataCompra        ,
                                                            municipioCompra   ,
                                                            estadoCompra      ,
                                                            dataNascimento    ,
                                                            estadoCivil       ,
                                                            filhos            ,
                                                            sexo              ,
                                                            dddComercial      ,
                                                            foneComercial     ,
                                                            dddCelular        ,
                                                            foneCelular       ,
                                                            prefMusical
                                                    FROM garantia
                                                    WHERE idGarantia = $idGarantia; ";

                                            $res = mysql_query($sql) or die("Erro no Sql:".mysql_error());

                                            if (mysql_num_rows($res) > 0) {

                                                $es_nf              = mysql_result($res, 0, 'nf');
                                                $es_dataCompra      = mysql_result($res, 0, 'dataCompra');
                                                $es_municipioCompra = mysql_result($res, 0, 'municipioCompra');
                                                $es_estadoCompra    = mysql_result($res, 0, 'estadoCompra');
                                                $es_dataNascimento  = mysql_result($res, 0, 'dataNascimento');
                                                $es_estadoCivil     = mysql_result($res, 0, 'estadoCivil');
                                                $es_filhos          = mysql_result($res, 0, 'filhos');
                                                $es_sexo            = mysql_result($res, 0, 'sexo');
                                                $es_dddComercial    = mysql_result($res, 0, 'dddComercial');
                                                $es_foneComercial   = mysql_result($res, 0, 'foneComercial');
                                                $es_telComercial    = "($es_dddComercial) $es_foneComercial";
                                                $es_dddCelular      = mysql_result($res, 0, 'dddCelular');
                                                $es_foneCelular     = mysql_result($res, 0, 'foneCelular');
                                                $es_prefMusical     = mysql_result($res, 0, 'prefMusical');
                                                $es_telCelular      = "($es_dddCelular) $es_foneCelular";

                                                $es_dataCompra = converte_data($es_dataCompra);
                                                $es_dataCompra = str_replace("-","/",$es_dataCompra);

                                                $es_dataNascimento = converte_data($es_dataNascimento);
                                                $es_dataNascimento = str_replace("-","/",$es_dataNascimento);

                                            }

                                            echo "<input name='es_id_numeroserie' id='es_id_numeroserie' value='$idNumeroSerie' type='hidden'>";

                                            echo "<table width='100%' border='0' align='center' cellpadding='2' cellspacing='2' style=' font-size:10px'>";
                                                echo "<tr>";
                                                    echo "<td><B>Cnpj Revenda:</B></td>";
                                                    echo "<td><input name='es_revenda_cnpj' id='es_revenda_cnpj' class='input' value='$es_cnpj' type='text' maxlength='14' size='15' readonly></td>";
                                                    echo "<td><B>Nome Revenda:</B></td>";
                                                    echo "<td><input name='es_revenda' id='es_revenda' class='input' value='$es_revenda' type='text' maxlength='50' size='25' readonly></td>";
                                                    echo "<td><B>Nota Fiscal:</B></td>";
                                                    echo "<td><input name='es_nota_fiscal' id='es_nota_fiscal' class='input' value='$es_nf' type='text' maxlength='8' size='8'> </td>";
                                                echo "</tr>";

                                                echo "<tr>";
                                                    echo "<td><B>Data Compra:</B></td>";
                                                    echo "<td><input name='es_data_compra' id='es_data_compra' class='input' value='$es_dataCompra' type='text' maxlength='10' size='12'></td>";
                                                    echo "<td><B>Municipio Compra:</B></td>";
                                                    echo "<td><input name='es_municipiocompra' id='es_municipiocompra' class='input' value='$es_municipioCompra' type='text' maxlength='255' size='25'></td>";
                                                    echo "<td><B>Estado Compra:</B></td>";
                                                    echo "<td>";
                                                        echo "<select name='es_estadocompra' id='es_estadocompra' style='width:52px; font-size:9px' >";
                                                         $ArrayEstados = array('AC','AL','AM','AP',
                                                                                    'BA','CE','DF','ES',
                                                                                    'GO','MA','MG','MS',
                                                                                    'MT','PA','PB','PE',
                                                                                    'PI','PR','RJ','RN',
                                                                                    'RO','RR','RS','SC',
                                                                                    'SE','SP','TO'
                                                                                );

                                                        for ($i = 0; $i <= 26; $i++) {
                                                            echo"<option value='".$ArrayEstados[$i]."'";
                                                            if ($es_estadoCompra == $ArrayEstados[$i]) echo " selected";
                                                            echo ">".$ArrayEstados[$i]."</option>\n";
                                                        }

                                                        echo "</select>";
                                                    echo "</td>";
                                                echo "</tr>";

                                                echo "<tr>";
                                                    echo "<td><B>Data Nascimento:</B></td>";
                                                    echo "<td><input name='es_data_nascimento' id='es_data_nascimento' class='input' value='$es_dataNascimento' type='text' maxlength='10' size='12'></td>";
                                                    echo "<td><B>Estado Civil:</B></td>";
                                                    echo "<td>";
                                                        echo "<select name='es_estadocivil' id='es_estadocivil' style='width:100px; font-size:9px' >";
                                                        echo "<option value=''></option>";
                                                        echo "<option value='0' ";
                                                        if ($es_estadoCivil=="0")echo "SELECTED";
                                                        echo ">Solteiro(a)</option>";
                                                        echo "<option value='1' ";
                                                        if ($es_estadoCivil=="1")echo "SELECTED";
                                                        echo ">Casado(a)</option>";
                                                        echo "<option value='2' ";
                                                        if ($es_estadoCivil=="2")echo "SELECTED";
                                                        echo ">Divorciado(a)</option>";
                                                        echo "<option value='3' ";
                                                        if ($es_estadoCivil=="3")echo "SELECTED";
                                                        echo ">Viuvo(a)</option>";
                                                        echo "</select>";
                                                    echo "</td>";
                                                    echo "<td><B>Sexo:</B></td>";
                                                    echo "<td>";
                                                        echo "<INPUT TYPE='radio' NAME='es_sexo' ";
                                                        if ($es_sexo == "0") echo "CHECKED ";
                                                        echo "value='0'>M. ";
                                                        echo "<INPUT TYPE='radio' NAME='es_sexo' ";
                                                        if ($es_sexo == "1") echo "CHECKED ";
                                                        echo " value='1'>F. ";
                                                    echo "</td>";
                                                echo "</tr>";

                                                    echo "<tr>";
                                                        echo "<td><B>Filhos:</B></td>";
                                                        echo "<td>";
                                                            echo "<INPUT TYPE='radio' NAME='es_filhos' ";
                                                            if ($es_filhos == "0") echo "CHECKED ";
                                                            echo "value='0'>Sim ";
                                                            echo "<INPUT TYPE='radio' NAME='es_filhos' ";
                                                            if ($es_filhos == "1") echo "CHECKED ";
                                                            echo "value='1'>No ";
                                                        echo "</td>";
                                                        echo "<td><B>Fone Comercial:</B></td>";
                                                        echo "<td><input name='es_fonecomercial' id='es_fonecomercial' class='input' value='$es_telComercial' type='text' maxlength='14' size='16'></td>";

                                                        echo "<td><B>Celular:</B></td>";
                                                        echo "<td>";
                                                            echo "<input name='es_celular' id='es_celular' class='input' value='$es_telCelular' type='text' maxlength='14' size='16'>";
                                                        echo "</td>";
                                                    echo "</tr>";

                                                    echo "<tr>";
                                                        echo "<td colspan='6'><B>Preferência Musical:</B> ";
                                                            echo "<input name='es_preferenciamusical' id='es_preferenciamusical' class='input' value='$es_prefMusical' type='text' maxlength='255' size='100'>";
                                                        echo "</td>";
                                                    echo "</tr>";

                                                echo "</table>";


                                            }

                                        } else {
                                            echo "número de série não encontrado nas vendas";
                                        }

                                    }

                                }?>

                                </div>

                            </td>
                        </tr>
                        <tr>
                            <td align='left'><strong>Descrição:</strong></td>
                            <td colspan='6'>
                                <TEXTAREA NAME="reclamado_es" ROWS="6" COLS="110"  class="input" style='font-size:10px'><?echo $reclamado ;?></TEXTAREA>
                            </td>
                        </tr>
                    </table>

                </div>

            </div><?php

        }

        if ($login_fabrica == 5 and strlen($callcenter) > 0) { // hd 58796
            $read = " readonly='readonly' ";
        }
        ?>
        <div id="reclamacao_produto" class='tab_content'>

            <div rel='div_ajuda' style='display:inline; Position:relative;'>

            <!-- IncluÃ­do solicitação de TIPO DE PRODUTO/DEFEITO HD 173649 --><?php

            if ($login_fabrica == 2) {?>

                Tipo da Produro/Defeito
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                    <tr>
                        <td align='left' class="padding" width='50%' nowrap>
                            <input type="radio" name="tipo_reclamacao" value="aquisicao_mat" <?php
                                if ($natureza_chamado2 == 'aquisicao_mat') {echo "CHECKED";}?>> AQUISIÃÃO DE MATERIAIS
                        </td>
                        <td align='left' class="padding" width='50%' nowrap>
                            <input type="radio" name="tipo_reclamacao" value="aquisicao_prod" <?php
                                if ($natureza_chamado2 == 'aquisicao_prod') { echo "CHECKED";}?>>AQUISIÃÃO DE PRODUTO
                        </td>
                    </tr>
                    <tr>
                        <td align='left' class="padding" width='50%' nowrap>
                            <input type="radio" name="tipo_reclamacao" value="indicacao_posto" <?php
                                if ($natureza_chamado2 == 'indicacao_posto') { echo "CHECKED";}?>>INDICAÃÃO DE POSTO
                        </td>
                        <td align='left' class="padding" width='50%' nowrap>
                            <input type="radio" name="tipo_reclamacao" value="solicitacao_manual"
                                <?PHP if ($natureza_chamado2 == 'solicitacao_manual') { echo "CHECKED";}?>>SOLICITAÃÃES DE MANUAIS / CATÃLOGOS
                        </td>
                    </tr>
                </table>

                <!-- FIM solicitação de TIPO DE PRODUTO/DEFEITO HD 173649 --><?php

            } else {?>

                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
                    <tr>
                        <td align='right' width='150'></td>
                        <td align='right' width='55'>
                            <img src='imagens/ajuda_call.png' align=absmiddle>
                        </td>
                        <td align='center'>
                            <STRONG>Confirmar ou perguntar a reclamação.</STRONG><br /><?php

                            $sql = "SELECT pergunta FROM tbl_callcenter_pergunta WHERE codigo='4' AND fabrica = $login_fabrica";
                            $pe  = pg_query($con, $sql);

                            if (pg_num_rows($pe) > 0) {
                                echo pg_fetch_result($pe,0,0);
                            } else {
                                echo ($login_fabrica == 11 or $login_fabrica == 172) ? "Qual a sua solicitação SR.(a)?<BR>" : "Qual a sua reclamação SR.(a)?<BR>";?> ou<BR> O Sr.(a) diz que...., correto?<?php
                            }?>
                        </td>
                        <td align='right' width='150'></td>
                    </tr>
                </table><?php

            }?>
            </div>

            <?php
            if ((in_array($login_fabrica, array(81,155, 114, 122, 123, 128))) or $telecontrol_distrib) {
                if (!empty($_GET['callcenter'])) {
                    $hd_origem_recl = (int) $_GET['callcenter'];
                    $sql_origem_recl = "SELECT array_campos_adicionais::jsonb->'origem_reclamacao' AS origem_reclamacao FROM tbl_hd_chamado_extra WHERE hd_chamado = $hd_origem_recl";
                    $res_origem_recl = pg_query($con, $sql_origem_recl);
                    $origem_reclamacao = (count($origem_reclamacao > 0)) ? $origem_reclamacao : json_decode(pg_fetch_result($res_origem_recl, 0, 'origem_reclamacao'), true);
                }
            ?>
                <br />
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                    <tr>
                        <td style="width: 150px;">
                            <strong>Origem da Reclamação:</strong>
                        </td>
                        <td>
                            <input type="checkbox" name="origem_reclamacao[]" value="0800" <?=((!isset($origem_reclamacao) && !isset($_GET["hd_chamado"]) && !$_POST) || (in_array("0800", $origem_reclamacao))) ? "CHECKED" : ""?> /> 0800
                            <input type="checkbox" name="origem_reclamacao[]" value="reclame_aqui" <?=(in_array("reclame_aqui", $origem_reclamacao)) ? "CHECKED" : ""?> /> Reclame Aqui
                            <input type="checkbox" name="origem_reclamacao[]" value="facebook" <?=(in_array("facebook", $origem_reclamacao)) ? "CHECKED" : ""?> /> Facebook
                            <input type="checkbox" name="origem_reclamacao[]" value="twitter" <?=(in_array("twitter", $origem_reclamacao)) ? "CHECKED" : ""?> /> Twitter
                            <input type="checkbox" name="origem_reclamacao[]" value="procon" <?=(in_array("procon", $origem_reclamacao)) ? "CHECKED" : ""?> /> Procon
                        <?php if ($login_fabrica == 122 ){  ?>
                            <input type="checkbox" name="origem_reclamacao[]" value="fora_garantia" <?=(in_array("fora_garantia", $origem_reclamacao)) ? "CHECKED" : ""?> /> Fora de Garantia
                        <?php } ?>
                            <input type="checkbox" name="origem_reclamacao[]" value="outro" <?=(in_array("outro", $origem_reclamacao)) ? "CHECKED" : ""?> /> Outros
                            <input type="text" name="origem_reclamacao_outro" value="<?=$origem_reclamacao_outro?>" <?=(in_array("outro", $origem_reclamacao)) ? "style='display: inline;'" : "style='display: none;'"?> />
                        </td>
                    </tr>
                </table>
                <br />
            <?php
            }

            if (in_array($login_fabrica, array(169,170)) && !empty($callcenter)) {
                if (!strlen($posto) > 0) {
                    $aux_sql = "
                        SELECT posto FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter
                    ";
                    $aux_res = pg_query($con, $aux_sql);
                    $posto = pg_fetch_result($aux_res, 0, 0);
                }

                $sql_posto = "SELECT permite_envio_produto FROM tbl_posto_fabrica WHERE posto = $posto AND fabrica = $login_fabrica";
                $res_posto = pg_query($con, $sql_posto);
                $permite_envio_produto = (pg_fetch_result($res_posto, 0, 'permite_envio_produto') == 't') ? 't' : '';

                if (!strlen($produto) > 0) {
                    $aux_sql = "
                        SELECT produto FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter
                    ";
                    $aux_res = pg_query($con, $aux_sql);
                    $produto = pg_fetch_result($aux_res, 0, 0);
                }

                $sql_produto = "SELECT JSON_FIELD('eticket', parametros_adicionais) AS eticket FROM tbl_produto WHERE produto = $produto AND fabrica_i = $login_fabrica";
                $res_prod = pg_query($con, $sql_produto);
                $eticket = pg_fetch_result($res_prod, 0, 'eticket');

                if(!empty($hd_motivo_ligacao)) {
                    $sql_abre_os = "SELECT abre_os FROM tbl_hd_motivo_ligacao WHERE hd_motivo_ligacao = $hd_motivo_ligacao";
                    $res_abre_os = pg_query($con, $sql_abre_os);
                    $abre_os_valida = (pg_fetch_result($res_abre_os, 0, 'abre_os') == 't') ? 't' : '';
                }

                //if (!empty($permite_envio_produto) && !empty($eticket) && !empty($abre_os_valida) && $abre_os == 't' && $solicita_postagem == "true") {
                if (!empty($permite_envio_produto) && !empty($eticket) AND strlen(trim($produto)) > 0) {
            ?>
                    <div style="padding-top: 4px; padding-bottom: 4px; font: 10px arial;">Solicitação de Postagem/Coleta</div>
                    <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                        <tr>
                            <td>
                                Tipo de Postagem
                                <select name="tipo_postagem" id="tipo_postagem">
                                    <option value=""></option>
                                    <option value="C">Coleta</option>
                                    <option value="A">Postagem</option>
                                </select>
                            </td>
                            <td>
                                Modo de Envio
                                <select name="sedex_pac" id="sedex_pac">
                                    <option value=""></option>
                                    <option value="40517">SEDEX</option>
                                    <option value="04677">PAC</option>
                                </select>
                            </td>
                            <td>
                                Observação: <input type="text" name="consumidor_final_nome">
                            </td>
                            <td>
                                <button type="button" onclick="javascript: solicitaPostagem(<?=$callcenter?>);">Solicitar Logistica Reversa Correios</button>
                            </td>
                        </tr>
                    </table>
            <?php
                }
            }
            ?>

            <div style="padding-top: 4px; padding-bottom: 4px; font: 10px arial;">Informações do Produto</div>

            <?php

            //HD 235203: Alterar assuntos Fale Conosco e CallCenter
            //           O array $assuntos é definido dentro do arquivo callcenter_suggar_assuntos.php
            //           que está sendo incluÃ­do no começo deste arquivo

            if ($login_fabrica == 24) {
?>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                    <tr>
                        <td width="350px">
                        Assunto: <select name="callcenter_assunto[reclamacao_produto]" id="callcenter_assunto" class="input_req">
                        <option value=''>>>> Escolha <<<</option> <?php

                        foreach ($assuntos["PRODUTOS"] AS $label => $valor) {

                            if ($valor == $callcenter_assunto) {
                                $selected = "selected";
                            } else {
                                $selected = "";
                            }

                            echo " <option value='$valor' $selected>PRODUTOS >> $label</option>";

                        }

                        foreach ($assuntos["MANUAL"] AS $label => $valor) {

                            if ($valor == $callcenter_assunto) {
                                $selected = "selected";
                            } else {
                                $selected = "";
                            }

                            echo " <option value='$valor' $selected>MANUAL >> $label</option>";

                        }

                        // HD 751794
                        if (strlen($callcenter) > 0){
                            $sql = "SELECT CASE WHEN orientacao_uso IS TRUE THEN 'checked' ELSE '' END as orientacao
                                FROM tbl_hd_chamado_extra WHERE hd_chamado = $callcenter";
                            $res = pg_query($con,$sql);

                            $orientacao_uso = pg_result($res,0,0);
                        }

                        if ($_POST['orientacao_uso'] == 't') {

                                $orientacao_uso = 'checked';

                        } else if ( strlen($btn_acao) > 0 ) {

                            $orientacao_uso = '';

                        } ?>
                        </select>
                        </td>
                        <td style="display:none;" id="orientacao_uso">
                            <input type="checkbox" name="orientacao_uso" value="t" id="orientacao_uso_check" <?=$orientacao_uso?> />&nbsp;
                            <label for="orientacao_uso_check">Orientação de Uso</label>
                        </td>
                    </tr>
                </table><?php

            } ?>
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <?php
            // HD 2867215: retirar Motivo para Fricon(52)


                if ((in_array($login_fabrica, array(11, 172)) || $moduloProvidencia)) {
                    $titulo_combo = in_array($login_fabrica, array(11,52,172)) ? "Motivo" : "Providência";
                    $disabled = (!empty($hd_motivo_ligacao) && !empty($callcenter) && (in_array($login_fabrica, array(11, 172)))) ? " AND tbl_hd_motivo_ligacao.hd_motivo_ligacao = $hd_motivo_ligacao " : "";
                    if (in_array($login_fabrica, array(169,170))) {
                        if (strlen(trim($hd_classificacao)) > 0 AND strlen(trim($callcenter)) > 0) {
                            $cond_providencia = " AND hd_classificacao = {$hd_classificacao} ";
                        } else {
                            if (strlen(trim($hd_classificacao)) > 0) {
                                $cond_providencia = " AND hd_classificacao = {$hd_classificacao} ";
                            }
                        }
                    }
                    if (in_array($login_fabrica, [178,198]) AND !empty($callcenter) AND !empty($hd_classificacao)) {
                        $cond_providencia = " AND hd_classificacao = {$hd_classificacao} ";
                    }
                    if ($login_fabrica == 171){
                        $tr_providencia = "style='display:none;'";
                    }else{
                        $tr_providencia = "";
                    }
?>
                        <tr <?=$tr_providencia?> >
                            <td>
<?php
                    if (in_array($login_fabrica, array(169,170))) {
?>
                                <label class='asteristico'>*</label>
<?php
                    }
                        /*HD - 4382764*/
                    if (in_array($login_fabrica, [174,189])) {
                        $titulo_combo = "ação";
                    }
?>
                                <strong><?=$titulo_combo?>:</strong>
                            </td>
                            <td>
                                <select name='hd_motivo_ligacao' class='select_motivo_ligacao' id='hd_motivo_ligacao' data-aba="reclamacao_produto">
<?php
                                    if ($login_fabrica == 30) {
                                        echo "<option value=''>Escolha a Providência</option>";
                                    }

                    if (empty($callcenter) || empty($hd_motivo_ligacao) || (!empty($callcenter) && in_array($login_fabrica, array(184,200)))) {
                        $option_text =  (in_array($login_fabrica, [11, 52, 172])) ? "Escolha o motivo" : "Escolha a Providência";
                        if (in_array($login_fabrica, [189])) {
                            $option_text = "Escolha a ação";
                        }
?>
                        <option value=''><?=$option_text?></option><?php
                    }

                    if ($login_fabrica == 189) {
                        if (strlen(trim($hd_subclassificacao)) > 0) {
                            $cond_providencia = " AND tbl_hd_fluxo_atendimento.hd_subclassificacao = {$hd_subclassificacao} ";
                        } elseif (strlen(trim($hd_motivo_ligacao)) > 0) {
                            $cond_providencia = " AND tbl_hd_fluxo_atendimento.hd_motivo_ligacao = {$hd_motivo_ligacao} ";
                        }
                        $sqlLigacao = "

                                  SELECT tbl_hd_motivo_ligacao.descricao,
                                  tbl_hd_motivo_ligacao.hd_motivo_ligacao,
                                    tbl_hd_motivo_ligacao.descricao,
                                    tbl_hd_motivo_ligacao.categoria,
                                    tbl_hd_motivo_ligacao.prazo_dias
                                    FROM tbl_hd_fluxo_atendimento
                                    JOIN tbl_hd_subclassificacao ON tbl_hd_subclassificacao.hd_subclassificacao = tbl_hd_fluxo_atendimento.hd_subclassificacao
                                    JOIN tbl_hd_motivo_ligacao ON tbl_hd_motivo_ligacao.hd_motivo_ligacao = tbl_hd_fluxo_atendimento.hd_motivo_ligacao AND tbl_hd_motivo_ligacao.fabrica = $login_fabrica
                                   WHERE tbl_hd_fluxo_atendimento.fabrica = $login_fabrica
                                   $cond_providencia
                                   ORDER BY tbl_hd_motivo_ligacao.descricao";
                    } else {

                        $mt = " AND tbl_hd_motivo_ligacao.ativo IS TRUE";

                        if (!empty($hd_motivo_ligacao)) {
                            $mt = " AND (tbl_hd_motivo_ligacao.ativo IS TRUE OR tbl_hd_motivo_ligacao.hd_motivo_ligacao = $hd_motivo_ligacao)";
                        }

                        $sqlLigacao = "
                            SELECT  DISTINCT ON (tbl_hd_motivo_ligacao.descricao)
                                    tbl_hd_motivo_ligacao.hd_motivo_ligacao,
                                    tbl_hd_motivo_ligacao.descricao,
                                    tbl_hd_motivo_ligacao.categoria,
                                    tbl_hd_motivo_ligacao.prazo_dias,
                                    tbl_hd_motivo_ligacao.os_obrigatoria,
                                    tbl_hd_providencia.hd_providencia
                            FROM    tbl_hd_motivo_ligacao
                            LEFT JOIN tbl_hd_providencia ON tbl_hd_providencia.hd_motivo_ligacao = tbl_hd_motivo_ligacao.hd_motivo_ligacao
                            AND       tbl_hd_providencia.ativo IS TRUE
                            WHERE   tbl_hd_motivo_ligacao.fabrica = $login_fabrica
                            $mt   
                            $cond_providencia
                            $disabled
                            ORDER BY      tbl_hd_motivo_ligacao.descricao ";
                    }
                    $resLigacao = pg_query($con,$sqlLigacao);

                    $resMotivo = pg_fetch_all($resLigacao);

                    $displayProvNv3             = "hidden";
                    $mostra_providencia_nivel3  = "nao";

                    foreach ($resMotivo as $key => $value) {
                        $selected_hd_motivo_ligacao = ( isset($hd_motivo_ligacao) and ($hd_motivo_ligacao == $value['hd_motivo_ligacao']) ) ? "SELECTED" : '' ;

                        if ($hd_motivo_ligacao == $value['hd_motivo_ligacao'] && !empty($value['hd_providencia'])) {
                            $displayProvNv3 = "";
                            $mostra_providencia_nivel3  = "sim";
                        }

?>
                                <option data-os_cortesia='<?=$value["categoria"]?>' data-prazodias="<?=$value["prazo_dias"]?>" value="<?=$value['hd_motivo_ligacao']?>" <?=$selected_hd_motivo_ligacao?>>
                                    <?=$value['descricao']?>
                                </option>
<?php
                    }
                    $resMotivo = json_encode($resMotivo);
?>
                            </select>
                            <input type="hidden" name="abre_os_preos" id='abre_os_preos' value="<?=$abre_os_preos?>">
                            <input type="hidden" id="motivosLigacao" value='<?=$resMotivo?>' />
                            <input type="hidden" name="os_cortesia" id='os_cortesia' value="<?=$os_cortesia?>">
                            <input type="hidden" name="mostra_providencia_nivel3" value="<?= $mostra_providencia_nivel3 ?>" />

                            <?php
                        if (in_array($login_fabrica, [35])) { 

                            $displayValor = "none";
                            if (!empty($hd_motivo_ligacao)) {

                                $sqlVerificaReembolso = "SELECT hd_motivo_ligacao
                                                         FROM tbl_hd_motivo_ligacao
                                                         WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}
                                                         AND (descricao = 'Ressarcimento'
                                                         OR descricao = 'Reembolso ( boleto E-com)')";
                                $resVerificaReembolso = pg_query($con, $sqlVerificaReembolso);

                                if (pg_num_rows($resVerificaReembolso) > 0) {

                                    $displayValor = "inline-block";

                                }

                            }

                        ?>
                            <span style="display: <?= $displayValor ?>;width: 400px;" class="div-valor-reembolso">
                                &nbsp; &nbsp; <strong>Valor R$</strong>
                                <input type="text" class="valor_ressarcimento_reembolso" name="valor_ressarcimento_reembolso" value="<?= $valor_ressarcimento_reembolso ?>" />
                            </span>
                        <?php
                        }
                        ?>

                        </td>
                        
                        <?php if ($login_fabrica == 30) {?>
                        <td width="150" align="left" class="obs_sac" rowspan="2" style="vertical-align:top;" >
                            <strong>Observação do SAC:</strong>
                        </td>
                        <td class="obs_sac" rowspan="2" style="vertical-align:top;">
                            <textarea style="resize:none;" name="obs_sac_adicionais" id="obs_sac_adicionais" cols="80" rows="5" ><?=$obs_sac_adicionais?> </textarea>
                            <input type="hidden" name="obs_sac_adicionais_anterior" id="obs_sac_adicionais_anterior" value="<?php echo $obs_sac_adicionais; ?>" />
                        </td>
                        <?php }?>
                    </tr>

                <?php
                    if(in_array($login_fabrica, array(169,170,171))){
                        if(in_array($login_fabrica, array(169,170))){ ?>
                            <tr <?= $displayProvNv3 ?>>
                                <td>
                                    <label class='asteristico'>*</label>
                                    <strong>Providência nÃ­vel 3:</strong>
                                </td>
                                <td>
                                    <select name="providencia_nivel3_reclamacao_produto" id="providencia_nivel3_reclamacao_produto" style="width: 300px;">
                                        <option value=""></option>
                                        <?php
                                        if ($mostra_providencia_nivel3 == "sim" && $tab_atual == "reclamacao_produto") {
                                            $sqlHdProvidencia = "SELECT descricao, hd_providencia
                                                                 FROM tbl_hd_providencia
                                                                 WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}
                                                                 AND ativo IS TRUE
                                                                 AND fabrica = {$login_fabrica}";
                                            $resHdProvidencia = pg_query($con, $sqlHdProvidencia);

                                            if (pg_num_rows($resHdProvidencia) > 0) {
                                                while ($dadosProv3 = pg_fetch_object($resHdProvidencia)) {

                                                    $selected = ($dadosProv3->hd_providencia == $hd_providencia_callcenter) ? "selected" : "";

                                                ?>
                                                    <option value="<?= $dadosProv3->hd_providencia ?>" <?= $selected ?>><?= $dadosProv3->descricao ?></option>
                                                <?php
                                                }
                                            }
                                        }
                                        ?>

                                    </select>
                                </td>
                            </tr>
                            <?php

                            if(strlen(trim($callcenter)) > 0 AND strlen(trim($os)) > 0 ){
                                $style_os_pre_os = "";
                            }else{
                                if(strlen(trim($_POST['produto_nome'])) > 0 || strlen($produto_nome) > 0){
                                    $display_abre_os = "";
                }else{
                                    $style_os_pre_os = "style='display:none;'";
                                }
                            }
                            echo "<tr id='os_pre_os' $style_os_pre_os ><td colspan='8'>";

                            $disabled = "";
                            $checked = "";
                            $checked_abre_ordem_servico = "";
                            $display_abre_os = "";
                            $display_abre_ordem_servico = "";

                if ((strlen($_POST["produto_deslocamento"]) > 0 && $_POST["produto_deslocamento"] != "t") || $produto_deslocamento != "t") {
                                $display_abre_os = "";

                                if ($_POST["abre_os"] == "t" || $abre_os == "t") {
                                    $checked = "checked";
                                }

                                if (!empty($os)) {
                                    $disabled = "disabled";
                                }
                } else {
                                $display_abre_os = "style='display: none;'";
                            }

                            if ($abre_os != "t" && $_POST["abre_ordem_servico"] != "t" && !empty($os)) {
                                $checked_abre_ordem_servico = "";
                                $disabled = "disabled";
                                $display_abre_ordem_servico = "style='display: none;'";
                            }

                            echo "
                                <strong $display_abre_os class='class_169' >
                                    <input
                                        type=hidden
                                        name='abre_os_submeteu'
                                        value='sim'
                                    />
                                    <input
                                        $disabled
                                        $display_abre_os
                                        type='checkbox'
                                        name='abre_os'
                                        id='abre_os'
                                        value='t'
                                        class='class_169'
                                        onClick='verificarImpressao(this)'
                                        $checked
                                    />
                                    &nbsp;Abrir PRE-OS para esta Autorizada
                                </strong>
                            ";

                            if(strlen(trim($id_tipo_atendimento)) > 0){
                                $tipo_atendimento = $id_tipo_atendimento;
                            }else{
                                $tipo_atendimento = $_POST['tipo_atendimento'];
                            }
                            echo "<input type='hidden' name='tipo_atendimento' value='".$tipo_atendimento."'>";
                            echo "<input type='hidden' name='tipo_atendimento_anterior'>";

                            $sql = "SELECT tipo_atendimento FROM tbl_tipo_atendimento WHERE grupo_atendimento = 'I' AND fabrica = {$login_fabrica};";
                            $res = pg_query($con, $sql);

                            if($setor_atividade == 'I' OR $setor_atividade == 'C' OR $setor_atividade == 'IC') {
                                if(isset($_POST['servico_instalacao'])){
                                    $servico_checked = $_POST['servico_instalacao'];

                                    if (empty($servico_checked)) {
                                        $servico_ss_checked  = "checked";
                                    }
                                }else{
                                    $servico_checked   = "";
                                    $servico_ic_checked = "";
                                    $servico_c_checked  = "";
                                    $servico_i_checked  = "";
                                    $servico_ss_checked  = "checked";
                                }

                                if(isset($_POST['abre_ordem_servico'])){
                                    if ($setor_atividade == "IC") {
                                        $style_setor_ic = "";
                                        $style_setor_c  = "";
                                        $style_setor_i  = "";
                                    } else if ($setor_atividade == "I") {
                                        $style_setor_ic = "style='display:none;'";
                                        $style_setor_c  = "style='display:none;'";
                                        $style_setor_i  = "";
                                    } else {
                                        $style_setor_ic = "style='display:none;'";
                                        $style_setor_c  = "";
                                        $style_setor_i  = "style='display:none;'";
                                    }

                                    $style_setor_ss  = "";
                                }else{
                                    $style_setor_ic = "style='display:none;'";
                                    $style_setor_i  = "style='display:none;'";
                                    $style_setor_c  = "style='display:none;'";
                                    $style_setor_ss = "style='display:none;'";
                                }
                            }else{
                                $servico_checked   = "";

                                if(strlen(trim($callcenter)) > 0 and !empty($tipo_atendimento)){
                                    $sql_tipo_at = "SELECT grupo_atendimento, LOWER(fn_retira_especiais(descricao)) AS descricao FROM tbl_tipo_atendimento WHERE fabrica = {$login_fabrica} AND grupo_atendimento = 'I' AND tipo_atendimento = $tipo_atendimento";
                                    $res_tipo_at = pg_query($con, $sql_tipo_at);

                                    if(pg_num_rows($res_tipo_at) > 0){
                                        $tipo_atendimento_descricao = pg_fetch_result($res_tipo_at, 0, 'descricao');

                                        if ($tipo_atendimento_descricao == "instalacao e conversao") {
                                            $servico_ic_checked = "checked";
                                        } else if ($tipo_atendimento_descricao == "instalacao") {
                                            $servico_i_checked = "checked";
                                        } else if ($tipo_atendimento_descricao == "conversao") {
                                            $servico_c_checked = "checked";
                                        } else {
                                            $servico_ss_checked = "checked";
                                        }

                                        $servico_disabled = "disabled";

                                        if ($setor_atividade == "IC") {
                                            $style_setor_ic = "";
                                            $style_setor_c  = "";
                                            $style_setor_i  = "";
                                        } else if ($setor_atividade == "I") {
                                            $style_setor_ic = "style='display:none;'";
                                            $style_setor_c  = "style='display:none;'";
                                            $style_setor_i  = "";
                                        } else {
                                            $style_setor_ic = "style='display:none;'";
                                            $style_setor_c  = "";
                                            $style_setor_i  = "style='display:none;'";
                                        }

                                        $style_setor_ss  = "";
                                    }else{
                                        $servico_disabled = "";
                                        $style_setor_ic = "style='display:none;'";
                                        $style_setor_i  = "style='display:none;'";
                                        $style_setor_c  = "style='display:none;'";
                                        $style_setor_ss  = "style='display:none;'";
                                    }
                                }else{
                                    $style_setor_ic = "style='display:none;'";
                                    $style_setor_i  = "style='display:none;'";
                                    $style_setor_c  = "style='display:none;'";
                                    $style_setor_ss  = "style='display:none;'";
                                }
                            }

                            if (!empty($os)) {
                                $sqlOsTipoAtendimento = "
                                    SELECT ta.grupo_atendimento
                                    FROM tbl_os o
                                    INNER JOIN tbl_tipo_atendimento ta ON ta.tipo_atendimento = o.tipo_atendimento AND ta.fabrica = {$login_fabrica}
                                    WHERE o.os = {$os}
                                ";
                                $resOsTipoAtendimento = pg_query($con, $sqlOsTipoAtendimento);

                                if (pg_fetch_result($res, 0, 'grupo_atendimento') != "I") {
                                    $style_setor_i = "style='display:none;'";
                                    $style_setor_c = "style='display:none;'";
                                }
                            }

                            $sqlTipoAtendimentoInstalacaoConversao = "
                                SELECT tipo_atendimento, descricao FROM tbl_tipo_atendimento WHERE fabrica = $login_fabrica AND grupo_atendimento = 'I'
                            ";
                            $resTipoAtendimentoInstalacaoConversao = pg_query($con, $sqlTipoAtendimentoInstalacaoConversao);

                            while ($row = pg_fetch_object($resTipoAtendimentoInstalacaoConversao)) {
                                if (!is_numeric($servico_checked)) {
                                    $servico_checked = "";
                                }

                                switch (strtolower($row->descricao)) {
                                    case 'instalação e conversão':
                                        if (is_numeric($servico_checked) && $servico_checked == $row->tipo_atendimento) {
                                            $servico_checked = "checked";
                                        } else if (!empty($servico_ic_checked)) {
                                            $servico_checked = $servico_ic_checked;
                                        }

                                        $style_setor = $style_setor_ic;
                                        $servico_radio_id = "serv_install_conv";
                                        $servico_label_id = "servico_instalacao_conversao";
                                        break;

                                    case 'instalação':
                                        if (is_numeric($servico_checked) && $servico_checked == $row->tipo_atendimento) {
                                            $servico_checked = "checked";
                                        } else if (!empty($servico_i_checked)) {
                                            $servico_checked = $servico_i_checked;
                                        }

                                        $style_setor = $style_setor_i;
                                        $servico_radio_id = "serv_install";
                                        $servico_label_id = "servico_instalacao";
                                        break;

                                    case 'conversão':
                                        if (is_numeric($servico_checked) && $servico_checked == $row->tipo_atendimento) {
                                            $servico_checked = "checked";
                                        } else if (!empty($servico_c_checked)) {
                                            $servico_checked = $servico_c_checked;
                                        }

                                        $style_setor = $style_setor_c;
                                        $servico_radio_id = "serv_conv";
                                        $servico_label_id = "servico_conversao";
                                        break;

                                    default:
                                        $servico_checked = "";
                                        $style_setor = "style='display:none;'";
                                        $servico_radio_id = "";
                                        $servico_label_id = "";
                                        break;
                                }

                                echo "
                                    <label style='cursor: pointer;' >
                                        <input
                                            $servico_checked
                                            $servico_disabled
                                            $style_setor
                                            type='radio'
                                            id='{$servico_radio_id}'
                                            name='servico_instalacao'
                                            value='{$row->tipo_atendimento}'
                                        />
                                        <strong id='{$servico_label_id}' $style_setor > Serviço de {$row->descricao}</strong>
                                    </label>
                                    <br />
                                ";
                            }

                            echo "
                                <label style='cursor: pointer;' >
                                    <input
                                        $servico_ss_checked
                                        $servico_disabled
                                        $style_setor_ss
                                        type='radio'
                                        id='sem_servico_install_conv'
                                        name='servico_instalacao'
                                        value=''
                                    />
                                    <strong id='sem_servico_instalacao_conversao' $style_setor_ss > Sem Serviço</strong>
                                </label>
                            ";

                            if ($produto_deslocamento == "t" || (isset($_POST["produto_deslocamento"]) && $_POST["produto_deslocamento"] == "t") ) {
                                if (!empty($callcenter) && !empty($os)) {
                                    $disabled = "disabled";
                                }

                                $display_abre_ordem_servico = "";

                                if ($_POST["abre_ordem_servico"] == "t" || !empty($os)) {
                                    $checked_abre_ordem_servico = "checked";
                                }
                            } else {
                                $display_abre_ordem_servico = "style='display: none;'";
                            }

                            if ($abre_os != "t" && $_POST["abre_ordem_servico"] != "t" && !empty($os)) {
                                $checked_abre_ordem_servico = "";
                                $disabled = "disabled";
                                $display_abre_ordem_servico = "style='display: none;'";
                            }

                            echo "<input class='produto_deslocamento' type='hidden' name='produto_deslocamento' value='$produto_deslocamento'>";
                            echo "<input class='garantia_estendida_tempo' type='hidden' name='garantia_estendida_tempo' value='$garantia_estendida_tempo'>";
                            echo "<br><strong class='abre_os_169' $display_abre_ordem_servico ><input type=hidden name='abre_ordem_servico_submeteu' value='sim'><input type='checkbox' name='abre_ordem_servico' $disabled $display_abre_ordem_servico class='abre_os_169' id='abre_ordem_servico' value='t' onClick='verificarImpressao(this)' $checked_abre_ordem_servico> Abrir ORDEM DE SERVIÃO para esta Autorizada</strong>";
                            echo (strlen($os) > 0) ? " <br/><strong>OS:</strong> <a href='os_press.php?os=$os' target='_blank'>$os</a>" : "";

                            echo "</td></tr>";
                        }else{
                            echo "<input class='produto_deslocamento' type='hidden' name='produto_deslocamento' value='$produto_deslocamento'>";
                        }
                        $displayAgendaOrdem = 'style="display:none;"';

                        if (($produto_deslocamento == "t" || $_POST['produto_deslocamento'] == "t") && ((isset($_POST['abre_ordem_servico']) && $_POST['abre_ordem_servico'] == 't') || !empty($os))) {
                            $displayAgendaOrdem = 'style="display:table-row;"';
                        }

                        if (!empty($os)) {
                            $sqlOsDeslocamento = "
                                SELECT tbl_os.os
                                FROM tbl_os
                                INNER JOIN tbl_tipo_atendimento ON tbl_tipo_atendimento.tipo_atendimento = tbl_os.tipo_atendimento
                                WHERE tbl_os.os = {$os}
                                AND tbl_tipo_atendimento.km_google IS TRUE
                            ";
                            $resOsDeslocamento = pg_query($con, $sqlOsDeslocamento);

                            if (pg_num_rows($resOsDeslocamento) > 0) {
                            ?>
                                <tr>
                                    <td colspan="8">
                                        <button
                                            type="button"
                                            class="input"
                                            id="btn_agendamentos"
                                            name="btn_agendamentos"
                                        >
                                            Mostrar Agendamentos efetuados
                                        </button>
                                    </td>
                                </tr>
                                <?
                                $sqlAgenda = "
                                    SELECT
                                        TO_CHAR(ta.data_agendamento,'DD/MM/YYYY') AS data_agendamento,
                                        ta.periodo,
                                        p.nome AS posto_nome,
                                        CASE WHEN ta.confirmado IS NOT NULL THEN TO_CHAR(ta.confirmado,'DD/MM/YYYY') ELSE NULL END AS confirmado,
                                        CASE WHEN ta.hora_inicio_trabalho IS NOT NULL THEN TO_CHAR(ta.hora_inicio_trabalho,'DD/MM/YYYY') ELSE NULL END AS hora_inicio_trabalho
                                    FROM tbl_tecnico_agenda ta
                                    JOIN tbl_os o ON o.os = ta.os AND o.fabrica = {$login_fabrica}
                                    LEFT JOIN tbl_tecnico t ON t.tecnico = ta.tecnico AND t.fabrica = {$login_fabrica}
                                    LEFT JOIN tbl_posto_fabrica pf ON pf.posto = o.posto AND pf.fabrica = {$login_fabrica}
                                    LEFT JOIN tbl_posto p ON p.posto = pf.posto
                                    WHERE ta.fabrica = {$login_fabrica}
                                    AND o.os = {$os}
                                    ORDER BY ta.data_input DESC;
                                ";

                                $resAgenda = pg_query($con,$sqlAgenda);

                                if(strlen(trim($callcenter)) > 0 AND strlen(trim($msg_erro)) == 0){//ver com maicon
                                    $data_agendamento_ordem = pg_fetch_result($resAgenda, 0, 'data_agendamento');
                                    $xperiodo = pg_fetch_result($resAgenda, 0, 'periodo');

                                }

                                if (pg_num_rows($resAgenda) > 0) {
                                ?>
                                    <tr id="tbl_agendamentos" style="display:none;">
                                        <td colspan="8">
                                            <table class="tabela_agenda" style="min-width:700px;" cellspacing="1" id="rel_agenda">
                                                <thead>
                                                    <tr class="titulo_coluna">
                                                        <th>Agendado</th>
                                                        <th>Confirmado</th>
                                                        <th>Atendimento</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <? for ($p = 0; $p < pg_num_rows($resAgenda); $p++) {
                                                        $data_agendada = pg_fetch_result($resAgenda, $p, data_agendamento);
                                                        $posto_nome = pg_fetch_result($resAgenda, $p, posto_nome);
                                                        $confirmado = pg_fetch_result($resAgenda, $p, confirmado);
                                                        $auxConfirmado = (!empty($confirmado)) ? $confirmado." - Posto: ".$posto_nome : $confirmado;
                                                        $hora_inicio_trabalho = pg_fetch_result($resAgenda, $p, hora_inicio_trabalho); ?>
                                                        <tr class="texto_avulso">
                                                            <td><?= $data_agendada; ?></td>
                                                            <td><?= $auxConfirmado; ?></td>
                                                            <td><?= $hora_inicio_trabalho; ?></td>
                                                        </tr>
                                                    <? } ?>
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                <?
                                }
                            }
                        }

                        if ($xperiodo == "manha" OR $periodo == "manha"){
                            $selected_periodo_manha = "selected";
                        }

                        if ($xperiodo == "tarde" OR $periodo == "tarde"){
                            $selected_periodo_tarde = "selected";
                        }

                        if (in_array($login_fabrica, array(169,170))) {
                            if (!($produto_deslocamento == "t" && ($abre_os == "t" || $_POST["abre_ordem_servico"] == "t"))) {
                                $displayAgendaOrdem = "style='display: none;'";
                            }

                            if (($produto_deslocamento == "t" || $_POST['produto_deslocamento'] == "t") && ($abre_os == "t" || $_POST["abre_ordem_servico"] == "t")){
                                $displayAgendaOrdem = "";
                            }
                        }
                        ?>
                        <tr id="div_data_agendamento_ordem" <?= $displayAgendaOrdem; ?>>
                            <td width="245px;"><strong>Data Agendamento da Ordem de serviço:</strong></td>
                            <td>
                                <input type="text" id="data_agendamento_ordem" name="data_agendamento_ordem" size="10" maxlength="12" value="<?= $data_agendamento_ordem; ?>" />
                            </td>
                        </tr>
                        <tr id="div_periodo_agendamento_ordem" <?= $displayAgendaOrdem; ?>>
                            <td>
                                <strong>Período do agendamento:</strong>
                            </td>
                            <td>
                                <select name='periodo'>
                                    <option value="">Selecione</option>
                                    <option value="manha" <?=$selected_periodo_manha?> >Manhã</option>
                                    <option value="tarde" <?=$selected_periodo_tarde?> >Tarde</option>
                                </select>
                            </td>
                            <td>
                                <strong><input type='checkbox' name='reagenda_manual' id='reagenda_manual' value='t'> Reagendar Visita</strong>
                                <br/> <span class='obs_interno'>Caso tenha que alterar a data de agendamento após confirmação do posto<br/>deve-se selecionar está opção, para que a mesma seja efetuada !</span>
                            </td>
                        </tr>
                    <? }

                    if ($moduloProvidencia && !empty($callcenter)) {
                        $sqlProvidencia = "SELECT data_providencia FROM tbl_hd_chamado WHERE hd_chamado = {$callcenter}";
                        $resProvidencia = pg_query($con, $sqlProvidencia);
                        if(pg_num_rows($resProvidencia)>0){
                            $data_providencia = substr(pg_fetch_result($resProvidencia, 0, 'data_providencia'), 0, 10);

                            list($y, $m, $d) = explode("-", $data_providencia);

                            $data_providencia = $d."/".$m."/".$y;

?>
                    <tr <?=$tr_providencia?> >
                        <td><strong><?php echo ($login_fabrica == 189) ? 'Data ação:' : 'Data Providência:';?></strong></td>
                        <td width="150" class="td_data_providencia" >
<?php
                            if(!in_array($status_interacao,array('Resolvido','Cancelado'),TRUE)){
                                if(in_array($login_fabrica, array(169,170))){
                                    $data_disabled = "disabled";
                                }
?>
                            <input type="text" <?=$data_disabled?> class="limite" id="data_prov" name="data_prov" value="<?=$data_providencia?>" rel="data" size="10" maxlength="12" />
                            <input type="hidden" class="limite" id="data_prov_ant" name="data_prov_ant" value="<?=$data_providencia?>" />
<?php
                            } else {
                                echo $data_providencia;
                            }

                            if($login_fabrica == 30 AND !empty($callcenter)){
                            ?>
				    <input type="button" id="prorroga_providencia" rel="<?=$callcenter?>" value="Prorrogar">
				    <input type="button" id="antecipa_providencia" rel="<?=$callcenter?>" value="Antecipar">
                        <?php
                            }
                        ?>
                        </td>
                        
                    </tr>
<?php
                        }
                    }
                ?>

            <?php
                }
                if ($login_fabrica == 30 and !empty($_GET['callcenter'])) {
                    $sql = "SELECT os FROM tbl_hd_chamado_extra WHERE hd_chamado = ".$_GET['callcenter'];
                    $res = pg_query($con, $sql);
                    if (pg_num_rows($res) > 0)
                        $os_aux = pg_fetch_result($res, 0, "os");

                    $os_c_troca = (isset($_REQUEST['os_c_troca']) && !empty($_REQUEST['os_c_troca'])) ? trim($_REQUEST['os_c_troca']) : $os_aux;
                    $display = (!empty($os_c_troca)) ? '' : 'display: none';
                ?>
                <tr id="os_comprovante_troca" style="<?=$display; ?>;">
                <td align='left'>
                <strong>OS:</strong>
                </td>
                <td align='left'>
                    <input name='os_c_troca' id='os_c_troca' size='15' class='input' value='<?=$os_c_troca; ?>'>
                </td>
                </tr>
                <?
                }
    ?>

            <?php
            if (in_array($login_fabrica, array(189))) {
                /*
                if (!empty($callcenter)) {

                    if (strlen(trim($hd_subclassificacao)) > 0 AND strlen(trim($callcenter)) > 0) {
                        $cond_providencia = " AND tbl_hd_fluxo_atendimento.hd_subclassificacao = {$hd_subclassificacao} ";
                    }
                    $sqlProvidencia = "
                                  SELECT tbl_hd_motivo_ligacao.descricao
                                    FROM tbl_hd_fluxo_atendimento
                                    JOIN tbl_hd_subclassificacao ON tbl_hd_classificacao.hd_subclassificacao = tbl_hd_fluxo_atendimento.hd_subclassificacao
                                    JOIN tbl_hd_motivo_ligacao ON tbl_hd_motivo_ligacao.hd_motivo_ligacao = tbl_hd_fluxo_atendimento.hd_motivo_ligacao AND tbl_hd_motivo_ligacao.fabrica = $login_fabrica
                                   WHERE tbl_hd_fluxo_atendimento.fabrica = $login_fabrica $cond_providencia";
                    $resProvidencia = pg_query($con, $sqlProvidencia);
                    if (pg_num_rows($resProvidencia) > 0) {
                        $xxdescricao = pg_fetch_result($resProvidencia, 0, 'descricao');
                        if (in_array(strtoupper($xxdescricao), ["DEVOLUCAO PARCIAL", "DEVOLUCAO TOTAL"])) {
                            $display = "block";
                            $displayLight = "block";
                        } elseif (in_array(strtoupper($xxdescricao), ["REENTREGA"])) {
                            $display = "block";
                            $displayLight = "none";
                        }
                    } else {
                        $display = "none";
                        $displayLight = "none";

                    }
                } else {
                    $display = "none";
                    $displayLight = "none";

                }*/

                ?>
                <tr class="oculta_registro_tr">
                    <td align='left' colspan="100%">
                        <table width="100%" border="0" cellpadding="1" cellspacing="1">
                            <tr class="titulo_coluna">
                                <td colspan="2">nº CTE</td>
                                <td colspan="2">nº da Ordem de Entrada</td>
                                <td colspan="2">nº Remessa</td>
                                <td colspan="2">nº da Nota Fiscal de Entrada</td>
                            </tr>
                            <tr>
                                <td><input type="text" name="cte_1" value="<?php echo (isset($cte_1) && strlen($cte_1) > 0) ? $cte_1: "";?>" style="width: 90%"></td>
                                <td><input type="text" name="cte_2" value="<?php echo (isset($cte_2) && strlen($cte_2) > 0) ? $cte_2: "";?>" style="width: 90%"></td>
                                <td><input type="text" value="<?php echo (isset($n_ordem_entrada_1) && strlen($n_ordem_entrada_1) > 0) ? $n_ordem_entrada_1: "";?>" name="n_ordem_entrada_1" style="width: 90%"></td>
                                <td><input type="text" value="<?php echo (isset($n_ordem_entrada_2) && strlen($n_ordem_entrada_2) > 0) ? $n_ordem_entrada_2: "";?>" name="n_ordem_entrada_2" style="width: 90%"></td>
                                <td><input type="text" value="<?php echo (isset($n_remessa_1) && strlen($n_remessa_1) > 0) ? $n_remessa_1: "";?>" name="n_remessa_1" style="width: 90%"></td>
                                <td><input type="text" value="<?php echo (isset($n_remessa_2) && strlen($n_remessa_2) > 0) ? $n_remessa_2: "";?>" name="n_remessa_2" style="width: 90%"></td>
                                <td><input type="text" value="<?php echo (isset($n_nf_entrada_1) && strlen($n_nf_entrada_1) > 0) ? $n_nf_entrada_1: "";?>" name="n_nf_entrada_1" style="width: 90%"></td>
                                <td><input type="text" value="<?php echo (isset($n_nf_entrada_2) && strlen($n_nf_entrada_2) > 0) ? $n_nf_entrada_2: "";?>" name="n_nf_entrada_2" style="width: 90%"></td>
                            </tr>
                        </table>
                    </td>
                </tr>
            <?php } ?>
            <tr>
                <?php
                if (in_array($login_fabrica, array(173))) { ?>
                    <td width="130">
                <?php
                } else { ?>
                    <td>
                <?php
                } ?>

                <?
                //HD 201434 - Verifica como a fabrica trabalha com defeito reclamado na configuracao da tbl_fabrica e
                //            trata devidamente para mostrar o tipo de campo correto
                $sql_defeito = "
                    SELECT
                        pedir_defeito_reclamado_descricao
                    FROM tbl_fabrica
                    WHERE fabrica = {$login_fabrica}
                    AND pedir_defeito_reclamado_descricao IS TRUE;
                ";

                $res_defeito_reclamado = pg_query($con, $sql_defeito);

                if (isset($novaTelaOs) && !$defeitoReclamadoCadastroDefeitoReclamadoCliente && !in_array($login_fabrica, array(157,158,161,162,164,165,166,167,169,170,171,173,174,176,178,179,183,184,186,189,190,191,193,195,198,200,203)) and !$replica_einhell) { ?>
					<strong>Defeitos</strong>
					</td>
					<td align='left'>
						<acronym title='Descreva o relato do consumidor para o defeito do produto'>
                        <input name='hd_extra_defeito' id='hd_extra_defeito' size='50' class='input' value='<?=$hd_extra_defeito; ?>'>
                        </acronym>
                    </td>
                    </tr>
                    <tr>
                        <td>
                <? }

                // HD 219939: Para a Cadence deverá selecionar o defeito reclamado no CallCenter e digitar na OS
                //HD-3282875 Adicionada fábrica 50
                if (pg_num_rows($res_defeito_reclamado) && !in_array($login_fabrica,array(11,15,30,35,50,81,90,114,115,116,117,120,201,122,123,125,128,129,134,137,155,172)) && !isset($novaTelaOs) && $login_fabrica <= 130) { ?>
                    <strong> Defeitos</strong>
                    </td>
                    <td align='left'>
                        <input name='hd_extra_defeito' id='hd_extra_defeito' size='50' class='input' value='<?= $hd_extra_defeito; ?>' >
                    </td>
                <? } else {
                    if ((!in_array($login_fabrica, array(52,147,151,156,157,163,169,170,178,186,189,190,195)) AND !$usaScriptFalha AND !$defeitoReclamadoCadastroDefeitoReclamadoCliente)) {
                        //HD-3282875 Adicionada fábrica 50
                        if ((in_array($login_fabrica, array(11,15,30,50,81,90,114,115,116,117,120,201,122,123,125,128,129)) || $telecontrol_distrib) || isset($novaTelaOs) || $login_fabrica > 130) {?>
                            <!-- <a href="javascript:mostraDefeitos('Reclamado',document.frm_callcenter.produto_referencia.value)">
                            </a> -->
                            <strong>Defeitos Reclamados: </strong>
                        <? } else { ?>
                            <a href="javascript:mostraDefeitos('Reclamado',document.frm_callcenter.produto_referencia.value)">Defeitos</a>
                        <? } ?>
                        </td>
                        <td align='left' colspan='5' width='630' valign='top'>
                            <div id='div_defeitos' style='display:inline; Position:relative;background-color: #e6eef7;width:100%'>
                                <? if (strlen($defeito_reclamado) > 0 || ((in_array($login_fabrica,array(11,15,30,50,74,81,90,101,114,115,116,117,120,201,122,123,125,128,129,134,155,158,172)) || $telecontrol_distrib) ) || isset($novaTelaOs) || $login_fabrica > 130) {
                                    if (!in_array($login_fabrica, array(11,15,30,50,74,81,90,101,114,115,116,117,120,201,122,123,125,128,134,137,140,147,155,172)) && !isset($novaTelaOs) && $login_fabrica <= 130) {

                                        //HD-3282875 Adicionada fábrica 50 nos in_array acima
                                        if(strlen($defeito_reclamado) > 0){
                                            $sql = "
                                                SELECT
                                                    defeito_reclamado,
                                                    descricao
                                                FROM tbl_defeito_reclamado
                                                WHERE defeito_reclamado = {$defeito_reclamado};
                                            ";

                                            $res = pg_query($con, $sql);

                                            if (pg_num_rows($res) > 0) {
                                                $defeito_reclamado_descricao = pg_fetch_result($res,0,descricao); ?>
                                                <input type='radio' name='defeito_reclamado' id='defeito_reclamado' checked value='<?=$defeito_reclamado;?>'><font size='1'><?=$defeito_reclamado_descricao;?></font>
                                            <? }
                                        }
                                    } else { ?>
                                        <select id="defeito_reclamado" name="defeito_reclamado" >
                                            <option value="">Selecione o Defeito</option>
                                            <?
                                            $sql_familia_produto = "
                                                SELECT  familia
                                                FROM    tbl_produto
                                                JOIN    tbl_familia USING (familia)
                                                WHERE   tbl_produto.referencia  = '$produto_referencia'
                                                AND     tbl_familia.fabrica     = $login_fabrica
                                                AND     tbl_produto.fabrica_i   = $login_fabrica ";
                                            $res_familia_produto = pg_query($con,$sql_familia_produto);
                                            $familia_produto = pg_fetch_result($res_familia_produto,0,0);

                                            if ($familia_produto) {
                                                $sql_diagnostico_reclamado = "
                                                    SELECT  DISTINCT
                                                            tbl_defeito_reclamado.defeito_reclamado,
                                                            tbl_defeito_reclamado.descricao
                                                    FROM    tbl_defeito_reclamado
                                                    JOIN    tbl_diagnostico ON  tbl_defeito_reclamado.defeito_reclamado = tbl_diagnostico.defeito_reclamado
                                                                            AND tbl_diagnostico.fabrica                 = {$login_fabrica}
                                                                            AND tbl_diagnostico.ativo                   IS TRUE
                                                    WHERE   tbl_diagnostico.familia         = {$familia_produto}
                                                    AND     tbl_defeito_reclamado.fabrica   = {$login_fabrica}
                                              ORDER BY      tbl_defeito_reclamado.descricao
                                                ";

                                                $res_diagnostico_reclamado = pg_query($con, $sql_diagnostico_reclamado);

                                                if (pg_num_rows($res_diagnostico_reclamado) > 0) {
                                                    for ($i = 0;$i < pg_num_rows($res_diagnostico_reclamado); $i++){
                                                        $xdefeito_reclamado           = pg_result($res_diagnostico_reclamado, $i, 0);
                                                        $xdefeito_reclamado_descricao = pg_result($res_diagnostico_reclamado, $i, 1);
                                                        $selected = ($defeito_reclamado == $xdefeito_reclamado) ? "SELECTED" : null;?>

                                                        <option value="<?echo $xdefeito_reclamado?>" <?=$selected?>><?= $xdefeito_reclamado_descricao?></option>
                                                    <? }
                                                }
                                            } ?>
                                        </select>
                                    <? }
                                } ?>
                            </div>
                        <? }
				    } ?>
				</td>
			</tr>
            <?php if (in_array($login_fabrica, array(141,178))) {
                    $readonly_obs = '';

                    if ($login_fabrica == 178){
                        if (!empty($callcenter)){
                            $sql_obs = "SELECT obs_causa FROM tbl_os_revenda WHERE hd_chamado = $callcenter AND fabrica = $login_fabrica";
                            $res_obs = pg_query($con, $sql_obs);
                            if (pg_num_rows($res_obs) > 0){
                                $obs_sac_adicionais = pg_fetch_result($res_obs, 0, 'obs_causa');
                                $obs_sac_adicionais = str_replace("<br>", "\n", $obs_sac_adicionais);
                                $readonly_obs = 'readonly';
                            }
                        }else{
                            $obs_sac_adicionais = str_replace("<br>", "\n", $obs_sac_adicionais);
                        }
                    }

                    if (!empty($os)) {
                        $readonly_obs = 'readonly';
                    }
            ?>
                <tr>
                    <td width="150" align="left" class="obs_sac" rowspan="2" style="vertical-align:top;" >
                        <strong>Observação do SAC:</strong>
                        <acronym class='ac' title="A observação gravada neste campo poderá ser visualizada pela Assistência Técnica e ficará gravada na O.S do consumidor."><img src='imagens/help.png'></acronym></p>
                    </td>
                    <td class="obs_sac" rowspan="2" style="vertical-align:top;">
                        <textarea style="resize:none;font-size: 14px  !important;;" name="obs_sac_adicionais" id="obs_sac_adicionais" cols="80" rows="5" <?=$readonly_obs?> ><?=$obs_sac_adicionais?> </textarea>
                        <input type="hidden" name="obs_sac_adicionais_anterior" id="obs_sac_adicionais_anterior" value="<?php echo $obs_sac_adicionais; ?>" />
                    </td>
                </tr>
                <tr>
                    <td></td>
                </tr>
            <? }
            if(!in_array($login_fabrica, array(169,170,171,178,189)) AND !$usaScriptFalha AND !$defeitoReclamadoCadastroDefeitoReclamadoCliente){
                if (pg_num_rows($res_defeito_reclamado) == false && (in_array($login_fabrica,array(11,15,30,35,50,81,114,115,116,117,120,201,122,123,125,128,129,134,137,155)) || isset($novaTelaOs) || $login_fabrica > 130)) {
            ?>
                <tr>
                    <td>
                        <strong>Reclamação Cliente:</strong>
                    </td>
                    <td align='left'>
                        <input name='hd_extra_defeito' <?=$maxlength_169?> id='hd_extra_defeito' size='50' class='input' value='<?= $hd_extra_defeito; ?>'>
                    </td>
                </tr>
            <? }
            }
                if(in_array($login_fabrica, array(169,170))){
                    $descricao_campo = "Informações Complementares:";
                }else{
                    $descricao_campo = "Descrição:";
                }
            ?>
            <tr>
                <td align='left' valign='top' width='80'>
                    <?php
                        if(in_array($login_fabrica, array(169,170,198))){
                            echo "<label class='asteristico'>*</label>";
                        }
                    ?>
                    <strong><?=$descricao_campo?></strong>
                </td>
				<td align='left' colspan='5'>
                    <?=($login_fabrica == 178)? "<span style='color: #c73e10; font-weight: bold; margin-left: -8px;'>*</span>": "" ?>
                    <TEXTAREA NAME="reclamado_produto_x" ROWS="6" COLS="110"  class="input" style='display: none;font-size:10px' <? echo $read; ?>>
					<?php
						#94971
						if ($_GET['herdar']=='sim' AND $login_fabrica == 59) {
							$sql2 ="SELECT		tbl_hd_chamado_extra.reclamado
									FROM tbl_hd_chamado
									JOIN tbl_hd_chamado_extra on tbl_hd_chamado.hd_chamado = tbl_hd_chamado_extra.hd_chamado
									LEFT JOIN tbl_cidade on tbl_hd_chamado_extra.cidade = tbl_cidade.cidade
									JOIN tbl_admin  on tbl_hd_chamado.atendente = tbl_admin.admin
									LEFT JOIN tbl_posto on tbl_hd_chamado_extra.posto = tbl_posto.posto
									LEFT JOIN tbl_posto_fabrica on tbl_posto.posto = tbl_posto_fabrica.posto  and tbl_posto_fabrica.fabrica = 59
									LEFT JOIN tbl_produto on tbl_produto.produto = tbl_hd_chamado_extra.produto
									LEFT JOIN tbl_revenda on tbl_revenda.revenda = tbl_hd_chamado_extra.revenda
									LEFT JOIN tbl_defeito_reclamado on tbl_defeito_reclamado.defeito_reclamado = tbl_hd_chamado_extra.defeito_reclamado
									LEFT JOIN tbl_os on tbl_os.os = tbl_hd_chamado_extra.os
									WHERE tbl_hd_chamado.fabrica_responsavel = 59
									AND tbl_hd_chamado.hd_chamado = $Id";
							$res2 = pg_query($con,$sql2);

							if(pg_num_rows($res2)>0){
								$reclamado2       = pg_fetch_result($res2,0,reclamado);
							}
							echo $reclamado2;
						}
					?>
					</TEXTAREA>
					<?php
					if ($login_fabrica == 74 && !empty($callcenter) && $admin != 6437) {
						$bloqueia_reclamado_produto = "readonly";
						echo $reclamado;
						echo "<input type='hidden' name='reclamado_produto' value='$reclamado' />";
					}else{
						if ($login_fabrica == 74 && !empty($callcenter) && isset($_POST["reclamado_produto"])) {
							$reclamado = $_POST["reclamado_produto"];
						}
			            if (in_array($login_fabrica, array(169,170))){
                            $read = (strtoupper($status_interacao) == "RESOLVIDO" || (strlen($reclamado) > 0 AND !empty($callcenter)) AND empty($msg_erro)) ? "readonly='readonly'" : "";
                        }else{
                            $read = (strtoupper($status_interacao) == "RESOLVIDO" || strlen($reclamado) > 0) ? "readonly='readonly'" : "";
                        }
                        ?>
                        <TEXTAREA NAME="reclamado_produto" ROWS="6" COLS="110"  class="input" style='font-size:10px' <? echo $read; ?> <?=$bloqueia_reclamado_produto?> >
                            <?php
                                if ($login_fabrica == 158 && strlen($reclamado) == 0){
                                    echo utf8_decode($descricao_defeito);
                                }else{
                                    if ($login_fabrica == 178){
                                        echo utf8_decode($reclamado);
                                    }else{
                                        echo $reclamado;
                                    }

                                }
                            ?>
                            </TEXTAREA>
                    <? } ?>
                </td>
            </tr>

            <!-- hd-2553553 -->
            <?php if (in_array($login_fabrica, array(30)) AND 1 == 2) { ?>
            <tr>
                <td align='left' valign='top' title="Data programada para resolver este atendimento.">
                    <strong>Data de Retorno ao Cliente:</strong>
                </td>
                <td align='left' colspan='5' title="Data programada para resolver este atendimento.">
                    <input type="text" class="frm" rel="data" name="data_programada" style="width: 80px;" value="<?=$data_prov?>" />
                </td>
            </tr>
            <?php } ?>


            <!-- HD 196942: Controle de autorização de postagem -->
            <?
            if ($login_fabrica == 11 or $login_fabrica == 172) {
            ?>
            <tr>
                <td align='left' valign='top' title="Data programada para resolver este atendimento.">
                    <strong>Data Programada:</strong>
                </td>
                <td align='left' colspan='5' title="Data programada para resolver este atendimento.">
                    <input type="text" class="frm" rel="data" name="data_programada" style="width: 80px;" value="<?=$data_programada?>" />
                </td>
            </tr>
            <tr>
                <td align='left' valign='top'><strong>Postagem:</strong></td>
                <td align='left' colspan='5'>
                <?

                if (strlen($callcenter)) {
                    $sql = "
                    SELECT
                    TO_CHAR(tbl_hd_chamado_postagem.data, 'DD/MM/YYYY HH24:MI:SS') AS data,
                    TO_CHAR(tbl_hd_chamado_postagem.data_aprovacao, 'DD/MM/YYYY HH24:MI:SS') AS data_aprovacao,
                    tbl_hd_chamado_postagem.aprovado,
                    tbl_hd_chamado_postagem.admin,
                    tbl_admin.nome_completo AS admin_nome_completo,
                    tbl_admin.login AS admin_login,
                    tbl_hd_chamado_postagem.motivo,
                    tbl_hd_chamado_postagem.obs,
                    tbl_hd_chamado_postagem.codigo_postagem

                    FROM
                    tbl_hd_chamado_postagem
                    LEFT JOIN tbl_admin ON tbl_hd_chamado_postagem.admin=tbl_admin.admin

                    WHERE
                    hd_chamado=$callcenter
                    ";
                    $res_postagem = pg_query($con, $sql);
                }

                //Verifica se já existe solicitação de postagem cadastrada
                if (strlen($callcenter) && pg_num_rows($res_postagem)) {
                    $postagem_aprovado = pg_result($res_postagem, 0, aprovado);
                    $postagem_data = pg_result($res_postagem, 0, data);
                    $postagem_data_aprovacao = pg_result($res_postagem, 0, data_aprovacao);
                    $postagem_admin_nome_completo = pg_result($res_postagem, 0, admin_nome_completo);
                    $postagem_admin = pg_result($res_postagem, 0, admin);
                    $postagem_motivo = pg_result($res_postagem, 0, motivo);
                    $postagem_obs = pg_result($res_postagem, 0, obs);
                    $postagem_codigo_postagem = pg_result($res_postagem, 0, codigo_postagem);
                    $postagem_aprovado = empty($postagem_admin) ? "" : $postagem_aprovado;

                    switch ($postagem_aprovado) {

                        case 't':
                            if ($_POST["hd_chamado_codigo_postagem"]) {
                                $hd_chamado_codigo_postagem = $_POST["hd_chamado_codigo_postagem"];
                            } else {
                                $hd_chamado_codigo_postagem = $postagem_codigo_postagem;
                            }

                            if ($postagem_obs) {
                                $postagem_obs = "- <u>ObservaçÃµes:</u> $postagem_obs";
                            }

                            echo "<div style='display:inline; background: #44FF44; padding: 2px;'>Aprovado por $postagem_admin_nome_completo em $postagem_data_aprovacao - <u>Motivo:</u> $postagem_motivo $postagem_obs</div>";

                            echo "</td></tr>";
                            echo "<tr>
                            <td align='left' valign='top'><strong>Código de Postagem:</strong></td>
                            <td align='left' colspan='5'>
                            <input class='input' type='text' name='hd_chamado_codigo_postagem' id='hd_chamado_codigo_postagem' value='$hd_chamado_codigo_postagem' size='30'>";
                        break;

                        case 'f':
                            if ($postagem_obs) {
                                $postagem_obs = "- <u>ObservaçÃµes:</u> $postagem_obs";
                            }

                            echo "<div style='display:inline; background: #FFAA99; padding: 2px;'>Reprovado por $postagem_admin_nome_completo em $postagem_data_aprovacao - <u>Motivo:</u> $postagem_motivo $postagem_obs</div>";
                        break;

                        default:
                            echo "Em aprovação desde $postagem_data $postagem_aprovado";
                    }

                } else {

                    if ($_POST["hd_chamado_postagem"] == "sim") {
                        $checked = "checked";
                    } else {
                        $checked = "";
                    }

                    echo "<input type='checkbox' name='hd_chamado_postagem' id='hd_chamado_postagem' value='sim' $checked onchange=''> este chamado precisa de postagem";
                } ?>
                </td>
            </tr> <?
            }

            if (in_array($login_fabrica, [178])) { ?>
                <tr><td>&nbsp;</td></tr>
                <tr>
                    <td><strong>Resposta para o consumidor:</strong></td>
                    <td>
                        <textarea name="resposta_consumidor" style="width: 500px;font-size: 14px !important;"><?= utf8_decode($resposta_consumidor) ?></textarea>
                    </td>
                </tr>
            <?php
            }

            ?>
            <!-- FIM - HD 196942: Controle de autorização de postagem -->

            </table>

            <? if (in_array($login_fabrica, array(30))) { // HD 674943 ?>
                <br /><div id="questionario">
                    <?php include 'pesquisa_satisfacao.php'; ?>
                </div> <br />
            <? } // HD 674943 - FIM

            $aEsconderDuvidaProduto = array(2,169,170,198);

            if (in_array($login_fabrica, $aEsconderDuvidaProduto)):?>
                <div style="display:none">
            <?php endif; ?>

            <div style="padding-top: 4px; padding-bottom: 4px; font: 10px arial;">Consultar FAQs sobre o Produto</div>

            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <tr>
                <td align='left' width='60'><strong>Dúvida:</strong></td>
                <td align='left'>
                    <input name="faq_duvida_produto"  id='faq_duvida_produto' size='50' class="input" value='<?echo $faq_duvida ;?>'>
                    <input  id="faq_duvida_produto_btn" class="input"  type="button" name="bt_localizar" value='<?=($login_fabrica == 42)? "Listar DÃºvidas": "Localizar"; ?>' onclick="javascript:localizarFaq(document.frm_callcenter.produto_referencia.value,'faq_duvida_produto')">
                </td>
            </tr>
            <tr>
                <td colspan='2'>
                    <div id='div_faq_duvida_produto' style='display:inline; Position:relative;background-color: #e6eef7;width:100%'>
                    </div>
                </td>
            </tr>
            </table>
            <?php if ( in_array($login_fabrica, $aEsconderDuvidaProduto) ): ?>
                </div>
            <?php endif;
            if (1 ==2 /*$login_fabrica != 45 AND $login_fabrica != 3 Samuel retirou isto...a consulta do posto mais prximo  atravs do Mapa da Rede */ ) { ?>
                Consultar Posto Autorizado
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                    <tr>
                        <td align='left' colspan='6'><strong><a href="javascript: fnc_pesquisa_at_proximo('<?echo $login_fabrica?>')" title="Localize o Posto Autorizado" >Clique aqui para consultar o posto autorizado mais próximo do consumidor</a></strong></td>
                    </tr>
                </table><?PHP
                }
            ?>
        </div>

    <? if($login_fabrica <> 2){ ?>

        <div id="reclamacao_empresa" class='tab_content'>
            <div rel='div_ajuda' style='display:inline; Position:relative;'>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
                <tr>
                    <td align='right' width='150'></td>
                    <td align='right' width='55'>
                        <img src='imagens/ajuda_call.png' align=absmiddle>
                    </td>
                    <td align='center'>
                        <STRONG>Confirmar ou perguntar a reclamação.</STRONG><BR>
                        <?
                        $sql = "SELECT pergunta FROM tbl_callcenter_pergunta WHERE codigo='5' AND fabrica = $login_fabrica";
                        $pe = pg_query($con,$sql);
                        if(pg_num_rows($pe)>0) {
                            echo pg_fetch_result($pe,0,0);
                        }else{
                            echo "Qual a sua reclamação SR.(a)?<BR> ou<BR> O Sr.(a) diz que...., correto?";
                        }?>
                    </td>
                    <td align='right' width='150'></td>
                </tr>
                </table>
            </div> <?PHP
            if ($login_fabrica == 2) {

                if ($natureza_chamado2 == 'reclamacao_at') {
                    $mostra_reclamacao = "Assitência Técnica";
                } else if ($natureza_chamado2 == 'reclamacao_produto') {
                    $mostra_reclamacao = "o Produto";
                } else if ($natureza_chamado2 == 'reclamacao_revenda') {
                    $mostra_reclamacao = "a Loja";
                } else if ($natureza_chamado2 == 'reclamacao_enderecos') {
                    $mostra_reclamacao = "a Lista de Endereços Desatualizada";
                }

            }

            if ($login_fabrica == 24) {
                echo "Informações";
            } else {
                echo "Informações da Reclamação";
            }

            if ($login_fabrica == 2 and strlen($mostra_reclamacao) > 0) {
                echo "Sobre $mostra_reclamacao";
            }

            //HD 235203: Alterar assuntos Fale Conosco e CallCenter
            //           O array $assuntos é definido dentro do arquivo callcenter_suggar_assuntos.php
            //           que está sendo incluÃ­do no começo deste arquivo

            if ($login_fabrica == 24) {?>

                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                    <tr>
                        <td>
                        Assunto: <select name="callcenter_assunto[reclamacao_empresa]" id="callcenter_assunto" class="input_req">
                        <option value=''>>>> Escolha <<<</option><?php

                        foreach ($assuntos["EMPRESA"] AS $label => $valor) {

                            if ($valor == $callcenter_assunto) {
                                $selected = "selected";
                            } else {
                                $selected = "";
                            }

                            echo " <option value='$valor' $selected>EMPRESA >> $label</option>";

                        } ?>
                        </select>
                        </td>
                    </tr>
                </table><?php

            } ?>
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                <?php if(in_array($login_fabrica, array(169,170))){ ?>
                <tr>
                    <td>
                        <label class="asteristico">*</label>
                        <strong><?=$titulo_combo?>:</strong>
                    </td>
                    <td>
                        <select name='hd_motivo_ligacao_reclamacao_empresa' class='select_motivo_ligacao' id='hd_motivo_ligacao_reclamacao_empresa' data-aba='reclamacao_empresa'>
                            <option value=''>Escolha a Providência</option>
                        </select>
                    </td>
                </tr>
                <tr <?= $displayProvNv3 ?>>
                        <td>
                            <label class='asteristico'>*</label>
                            <strong>Providência nÃ­vel 3:</strong>
                        </td>
                        <td>
                            <select name="providencia_nivel3_reclamacao_empresa" id="providencia_nivel3_reclamacao_empresa" style="width: 300px;">
                                <option value=""></option>
                                <?php
                                if ($mostra_providencia_nivel3 == "sim" && $tab_atual == "reclamacao_reclamacao") {
                                    $sqlHdProvidencia = "SELECT descricao, hd_providencia
                                                         FROM tbl_hd_providencia
                                                         WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}
                                                         AND ativo IS TRUE
                                                         AND fabrica = {$login_fabrica}";
                                    $resHdProvidencia = pg_query($con, $sqlHdProvidencia);

                                    if (pg_num_rows($resHdProvidencia) > 0) {
                                        while ($dadosProv3 = pg_fetch_object($resHdProvidencia)) {

                                            $selected = ($dadosProv3->hd_providencia == $hd_providencia_callcenter) ? "selected" : "";

                                        ?>
                                            <option value="<?= $dadosProv3->hd_providencia ?>" <?= $selected ?>><?= $dadosProv3->descricao ?></option>
                                        <?php
                                        }
                                    }
                                }
                                ?>

                            </select>
                        </td>
                    </tr>
                <?php } ?>
                <tr>
                    <td align='left' valign='top' width='80'>
                        <?php
                            if(in_array($login_fabrica, array(169,170))){
                                echo "<label class='asteristico'>*</label>";
                            }
                        ?>
                        <strong>Reclamação:</strong>
                    </td>
                    <td align='left' colspan='5'>
                        <?php
                        if ($login_fabrica == 74 && !empty($callcenter) && $admin != 6437) {
                            $bloqueia_reclamado_produto = "readonly";

                            echo $reclamado;
                            echo "<input type='hidden' name='reclamado_empresa' value='$reclamado' />";
                        }else{
                            if ($login_fabrica == 74 && !empty($callcenter) && isset($_POST["reclamado_empresa"])) {
                                $reclamado = $_POST["reclamado_empresa"];
                            }

                            ?>
                            <TEXTAREA NAME="reclamado_empresa" ROWS="6" COLS="110"  class="input" style='font-size:10px' <? echo $read;?>><?echo $reclamado ;?></TEXTAREA>
                        <? } ?>
                    </td>
                </tr>
            </table>

            <BR>

            <div rel='div_ajuda' style='display:inline; Position:relative;'>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
                    <tr>
                        <td align='right' width='150'></td>
                        <td align='right' width='55'><img src='imagens/ajuda_call.png' align=absmiddle></td>
                        <td align='center'><STRONG>Sr.(a) estou encaminhando a sua reclamação ao Depto. responsável, que responderá em 12 h.
                        </td>
                        <td align='right' width='150'></td>
                    </tr>
                </table>
            </div>
        </div>

        <div id="reclamacao_at" class='tab_content'>
            <div rel='div_ajuda' style='display:inline; Position:relative;'>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
                    <tr>
                        <td align='right' width='150'></td>
                        <td align='right' width='55'>
                            <img src='imagens/ajuda_call.png' align=absmiddle>
                        </td>
                        <td align='center'>
                            <STRONG>Confirmar ou perguntar a reclamação.</STRONG><BR><?php

                            $sql = "SELECT pergunta FROM tbl_callcenter_pergunta WHERE codigo='6' AND fabrica = $login_fabrica";
                            $pe  = pg_query($con, $sql);

                            if (pg_num_rows($pe) > 0) {
                                echo pg_fetch_result($pe,0,0);
                            } else {
                                echo "Qual a sua reclamação SR.(a)?<BR> ou<BR> O Sr.(a) diz que...., correto?";
                            }?>
                        </td>
                        <td align='right' width='150'></td>
                    </tr>
                </table>
            </div>

            Informações da Assistência
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <tr>
                <td align='left'><strong>Código:</strong></td>
                <td align='left'>
                    <input
                        name="codigo_posto"
                        id="codigo_posto"
                        class="input"
                        value="<?=$codigo_posto?>"
                        onblur="javascript:
                            if (this.value.trim().length > 0) {
                                fnc_pesquisa_posto(
                                    document.frm_callcenter.codigo_posto,
                                    document.frm_callcenter.posto_nome,
                                    'codigo'
                                );
                            }
                        "
                        type="text"
                        size="15"
                        maxlength="15"
                    /><!-- end input -->
                    <img src='imagens/lupa.png' border='0' align='absmiddle'
                    style='cursor: pointer'
                    onclick="javascript: fnc_pesquisa_posto (document.frm_callcenter.codigo_posto,document.frm_callcenter.posto_nome,'codigo');">
                </td>
                <td align='left'><strong>Nome:</strong></td>
                <td align='left'>
                    <input
                        name="posto_nome"
                        id="posto_nome"
                        class="input"
                        value="<?=$posto_nome?>"
                        onblur="javascript:
                            if (this.value.trim().length > 0) {
                                fnc_pesquisa_posto(
                                    document.frm_callcenter.codigo_posto,
                                    document.frm_callcenter.posto_nome,
                                    'nome'
                                );
                            }
                        "
                        type="text"
                        size="35"
                        maxlength="500"
                    /><!-- end input -->
                    <img src='imagens/lupa.png' border='0' align='absmiddle'
                    style='cursor: pointer'
                    onclick="javascript: fnc_pesquisa_posto (document.frm_callcenter.codigo_posto,document.frm_callcenter.posto_nome,'nome');">
                </td>
                <?if ($login_fabrica <> 11 and $login_fabrica <> 172) { // HD 14549?>
                <td align='left'><strong>OS:</strong></td>
                <td align='left'>
                    <input name="at_os"  class="input"  value='<?echo $sua_os ;?>'>
                </td>
                <? } ?>
            </tr>
            </table>

            <? if($login_fabrica==11 or $login_fabrica == 172){ ?>
                Tipo da Reclamação
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                <tr>
                    <td align='left' class="padding" width='50%' nowrap><input type="radio" name="tipo_reclamacao" value="reclamacao_at" <?PHP if ($natureza_chamado2 == 'reclamacao_at' OR $natureza_chamado2 =='') { echo "CHECKED";}?>> RECLAMAÃÃO DA  ASSIST. TÃCN.</td>
                    <td align='left' class="padding" width='50%' nowrap><input type="radio" name="tipo_reclamacao" value="reclamacao_at_info" <?PHP if ($natureza_chamado2 == 'reclamacao_at_info') { echo "CHECKED";}?>>INFORMAÃÃES DE A.T</td>
                </tr>
                <tr>
                    <td align='left' class="padding" width='50%' nowrap><input type="radio" name="tipo_reclamacao" value="mau_atendimento" <?PHP if ($natureza_chamado2 == 'mau_atendimento') { echo "CHECKED";}?>>MAU ATENDIMENTO</td>
                    <td align='left' class="padding" width='50%' nowrap><input type="radio" name="tipo_reclamacao" value="posto_nao_contribui" <?PHP if ($natureza_chamado2 == 'posto_nao_contribui') { echo "CHECKED";}?>>POSTO NÃO CONTRIBUI COM INFORMAÃÃES</td>
                </tr>
                <tr>
                    <td align='left' class="padding" width='50%' nowrap><input type="radio" name="tipo_reclamacao" value="demonstra_desorg" <?PHP if ($natureza_chamado2 == 'demonstra_desorg') { echo "CHECKED";}?>>DEMONSTRA DESORGANIZAÃÃO</td>
                    <td align='left' class="padding" width='50%' nowrap><input type="radio" name="tipo_reclamacao" value="possui_bom_atend" <?PHP if ($natureza_chamado2 == 'possui_bom_atend') { echo "CHECKED";}?>>POSSUI BOM ATENDIMENTO</td>
                </tr>
                <tr>
                    <td align='left' class="padding" width='50%' nowrap><input type="radio" name="tipo_reclamacao" value="demonstra_org" <?PHP if ($natureza_chamado2 == 'demonstra_org') { echo "CHECKED";}?>>DEMONSTRA ORGANIZAÃÃO</td>
                </tr>
                </table>
            <? }
                echo ($login_fabrica==11 || $login_fabrica == 24 || $login_fabrica == 172) ? "Informações" : "Informações da Reclamação";

            //HD 235203: Alterar assuntos Fale Conosco e CallCenter
            //           O array $assuntos é definido dentro do arquivo callcenter_suggar_assuntos.php
            //           que está sendo incluÃ­do no começo deste arquivo

            if ($login_fabrica == 24) {?>

                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                    <tr>
                        <td>
                            Assunto: <select name="callcenter_assunto[reclamacao_at]" id="callcenter_assunto" class="input_req">
                            <option value=''>>>> Escolha <<<</option><?php

                            foreach ($assuntos["ASSISTÃNCIA TÃCNICA"] AS $label => $valor) {

                                if ($valor == $callcenter_assunto) {
                                    $selected = "selected";
                                } else {
                                    $selected = "";
                                }

                                echo " <option value='$valor' $selected>ASSISTÃNCIA TÃCNICA >> $label</option>";
                            } ?>
                            </select>
                        </td>
                    </tr>
                </table><?php

            }?>

            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                <?php if(in_array($login_fabrica, array(169,170))){ ?>
                    <tr>
                        <td>
                            <label class='asteristico'>*</label>
                            <strong><?=$titulo_combo?>:</strong>
                        </td>
                        <td>
                            <select name='hd_motivo_ligacao_reclamacao_at' class='select_motivo_ligacao' id='hd_motivo_ligacao_reclamacao_at' data-aba='reclamacao_at'>
                                <option value=''>Escolha a Providência</option>
                            </select>
                                <input type="hidden" id="motivosLigacao" value='<?=$resMotivo?>' />
                        </td>
                    </tr>
                    <tr <?= $displayProvNv3 ?>>
                        <td>
                            <label class='asteristico'>*</label>
                            <strong>Providência nÃ­vel 3:</strong>
                        </td>
                        <td>
                            <select name="providencia_nivel3_reclamacao_at" id="providencia_nivel3_reclamacao_at" style="width: 300px;">
                                <option value=""></option>
                                <?php
                                if ($mostra_providencia_nivel3 == "sim" && $tab_atual == "reclamacao_at") {
                                    $sqlHdProvidencia = "SELECT descricao, hd_providencia
                                                         FROM tbl_hd_providencia
                                                         WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}
                                                         AND ativo IS TRUE
                                                         AND fabrica = {$login_fabrica}";
                                    $resHdProvidencia = pg_query($con, $sqlHdProvidencia);

                                    if (pg_num_rows($resHdProvidencia) > 0) {
                                        while ($dadosProv3 = pg_fetch_object($resHdProvidencia)) {

                                            $selected = ($dadosProv3->hd_providencia == $hd_providencia_callcenter) ? "selected" : "";

                                        ?>
                                            <option value="<?= $dadosProv3->hd_providencia ?>" <?= $selected ?>><?= $dadosProv3->descricao ?></option>
                                        <?php
                                        }
                                    }
                                }
                                ?>

                            </select>
                        </td>
                    </tr>
                <?php } ?>
                <tr>
                    <td align='left' valign='top' width='80'>
                        <?php
                            if(in_array($login_fabrica, array(169,170))){
                                echo "<label class='asteristico'>*</label>";
                            }
                        ?>
                        <strong>Reclamação:</strong>
                    </td>
                    <td align='left' colspan='5'>
                        <?php
                        if ($login_fabrica == 74 && !empty($callcenter) && $admin != 6437) {
                            $bloqueia_reclamado_produto = "readonly";

                            echo $reclamado;
                            echo "<input type='hidden' name='reclamado_at' value='$reclamado' />";
                        }else{
                            if ($login_fabrica == 74 && !empty($callcenter) && isset($_POST["reclamado_at"])) {
                                $reclamado = $_POST["reclamado_at"];
                            }

                            ?>
                            <TEXTAREA NAME="reclamado_at" ROWS="6" COLS="110"  class="input" style='font-size:10px' <?echo $read;?>><?echo $reclamado ;?></TEXTAREA>
                        <? } ?>

                    </td>
                </tr>
            </table>
            <BR>

            <div rel='div_ajuda' style='display:inline; Position:relative;'>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
                <tr>
                    <td align='right' width='150'></td>
                    <td align='right' width='55'>
                        <img src='imagens/ajuda_call.png' align=absmiddle>
                    </td>
                    <td align='center'>
                        <STRONG>Sr.(a) estou encaminhando a sua reclamação ao Depto. responsável, que responderá em 12 h.
                    </td>
                    <td align='right' width='150'></td>
                </tr>
                </table>
            </div>
        </div>
        <?}

        if ($login_fabrica == 2) {?>

        <div id="reclamacoes" class='tab_content'>
            <div rel='div_ajuda' style='display:inline; Position:relative;'>
                Tipo da Reclamação
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                    <tr>
                        <td align='left' class="padding" width='50%'><input type="radio" name="tipo_reclamacao" value="reclamacao_revenda" onclick="MudaCampo(this)" <?PHP if ($natureza_chamado2 == 'reclamacao_revenda' OR $natureza_chamado2 == '') { echo "CHECKED";}?>> RECLAMAÃÃO DA LOJA</td>
                        <td align='left' class="padding" width='50%'><input type="radio" name="tipo_reclamacao" value="reclamacao_at" onclick="MudaCampo(this)" <?PHP if ($natureza_chamado2 == 'reclamacao_at') { echo "CHECKED";}?>> RECLAMAÃÃO DA ASSIST. TÃCN.</td>
                    </tr>
                    <tr>
                        <td align='left' class="padding" width='50%'><input type="radio" name="tipo_reclamacao" value="reclamacao_enderecos" onclick="MudaCampo(this)"<?PHP if ($natureza_chamado2 == 'reclamacao_enderecos') { echo "CHECKED";}?>> RECL. LISTA ENDEREÃOS DESATUALIZADA </td>
                        <td align='left' class="padding" width='50%'><input type="radio" name="tipo_reclamacao" value="reclamacao_produto" onclick="MudaCampo(this)" <?PHP if ($natureza_chamado2 == 'reclamacao_produto') { echo "CHECKED";}?>> RECLAMAÃÃO DO PRODUTO</td>
                    </tr>
                    <tr>
                        <td align='left' class="padding" width='50%'><input type="radio" name="tipo_reclamacao" value="reclamacao_conserto" onclick="MudaCampo(this)"<?PHP if ($natureza_chamado2 == 'reclamacao_conserto') { echo "CHECKED";}?>> RECLAMAÃÃO DE CONSERTOS </td>
                        <td align='left' class="padding" width='50%'><input type="radio" name="tipo_reclamacao" value="reclamacao_posto_aut" onclick="MudaCampo(this)" <?PHP if ($natureza_chamado2 == 'reclamacao_posto_aut') { echo "CHECKED";}?>> RECLAMAÃÃO DE POSTOS AUTORIZADOS</td>
                    </tr>
                    <tr>
                        <td align='left' class="padding" width='50%'><input type="radio" name="tipo_reclamacao" value="reclamacao_orgao_ser" onclick="MudaCampo(this)"<?PHP if ($natureza_chamado2 == 'reclamacao_orgao_ser') { echo "CHECKED";}?>> RECLAMAÃÃO DE ÃRGÃO DE SERVIÃO</td>
                        <td align='left' class="padding" width='50%'><input type="radio" name="tipo_reclamacao" value="repeticao_chamado" onclick="MudaCampo(this)"<?PHP if ($natureza_chamado2 == 'repeticao_chamado') { echo "CHECKED";}?>> REPETIÃÃO DE CHAMADO</td>
                    </tr>
                    <tr>
                        <td align='left' class="padding" width='50%'><input type="radio" name="tipo_reclamacao" value="reclamacao_outro" onclick="MudaCampo(this)"<?PHP if ($natureza_chamado2 == 'reclamacao_outro') { echo "CHECKED";}?>> OUTRAS RECLAMAÃÃES</td>
                    </tr>
                </table>

                <div id="info_posto" style=" <?php echo ($natureza_chamado2 == 'reclamacao_at') ? "display:inline" : "display:none"; ?> ;">

                <br/>
                Informações da Assistência
                <table width='100%' class="tab_content" border='0' align='center' cellpadding="2" cellspacing="2" style='border:#485989 1px solid; background-color: #e6eef7;font-size:10px'>
                    <tr>
                        <td>
                            <strong>Código do Posto:&nbsp;</strong>
                            <input name="codigo_posto" id="codigo_posto" class="input" value='<?echo $codigo_posto ;?>' <?php
                                if (strlen($codigo_posto)>0){
                                    echo " disabled";
                                } ?>
                                onblur="javascript: fnc_pesquisa_posto (document.frm_callcenter.codigo_posto,document.frm_callcenter.posto_nome,'codigo');" type="text" size="15" maxlength="15"> <img src='imagens/lupa.png' border='0' align='absmiddle' style='cursor: pointer' onclick="javascript: fnc_pesquisa_posto (document.frm_callcenter.codigo_posto,document.frm_callcenter.produto_nome,'codigo');">
                        </td>
                        <td>
                            <strong>Nome do Posto:&nbsp;</strong>
                            <input name="posto_nome" class="input" value='<?echo $posto_nome ;?>'
                            <?php
                                if (strlen($posto_nome)>0){
                                    echo " disabled";
                                } ?>
                                onblur="javascript: fnc_pesquisa_posto (document.frm_callcenter.codigo_posto,document.frm_callcenter.posto_nome,'nome');" type="text" size="35" maxlength="500"> <img src='imagens/lupa.png' border='0' align='absmiddle' style='cursor: pointer' onclick="javascript: fnc_pesquisa_posto (document.frm_callcenter.codigo_posto,document.frm_callcenter.posto_nome,'nome');">
                        </td>
                    </tr>
                </table>
                </div>

                <br>
                Informações da Reclamação
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                    <tr>
                        <td align='right' width='35%'><strong>Reclamação:</strong></td>
                        <td align='center' colspan='5'>
                            <TEXTAREA NAME="reclamado" ROWS="6" COLS="110"  class="input" style='font-size:10px'><?echo $reclamado ;?></TEXTAREA>
                        </td>
                    </tr>
                </table>
            </div>
        </div> <?PHP
        } ?>

        <div id="duvida_produto" class='tab_content'>
            <div rel='div_ajuda' style='display:inline; Position:relative;'>
            <!-- IncluÃ­do solicitação de TIPO DE PRODUTO/DEFEITO HD 173649 -->
            <? if($login_fabrica==2){ ?>
                DÃºvida dos produtos
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                    <tr>
                        <td align='left' class="padding" width='50%' nowrap>
                            <input type="radio" name="tipo_reclamacao" value="especificacao_manuseio"
                                <?PHP if ($natureza_chamado2 == 'especificacao_manuseio') {echo "CHECKED";}?>> ESPECIFICAÃÃES DE MANUSEIO
                        </td>
                        <td align='left' class="padding" width='50%' nowrap>
                            <input type="radio" name="tipo_reclamacao" value="informacao_manuseio"
                                <?PHP if ($natureza_chamado2 == 'informacao_manuseio') { echo "CHECKED";}?>>INFORMAÃÃO DE MANUSEIO
                        </td>
                    </tr>
                    <tr>
                        <td align='left' class="padding" width='50%' nowrap>
                            <input type="radio" name="tipo_reclamacao" value="informacao_tecnica"
                                <?PHP if ($natureza_chamado2 == 'informacao_tecnica') { echo "CHECKED";}?>>INFORMAÃÃO TÃCNICA
                        </td>
                        <td align='left' class="padding" width='50%' nowrap>
                            <input type="radio" name="tipo_reclamacao" value="orientacao_instalacao"
                                <?PHP if ($natureza_chamado2 == 'orientacao_instalacao') { echo "CHECKED";}?>>ORIENTAÃÃO PARA INSTALAÃÃO
                        </td>
                    </tr>
                </table>
                <!-- FIM solicitação de TIPO DE PRODUTO/DEFEITO HD 173649 -->
            <?}else{?>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
                    <tr>
                        <td align='right' width='150'></td>
                        <td align='right' width='55'>
                            <img src='imagens/ajuda_call.png' align=absmiddle>
                        </td>
                        <td align='center'>
                            <STRONG>Confirmar ou perguntar a dÃºvida.</STRONG><BR>
                            <?
                            $sql = "SELECT pergunta FROM tbl_callcenter_pergunta WHERE codigo='7' AND fabrica = $login_fabrica";
                            $pe = pg_query($con,$sql);
                            if(pg_num_rows($pe)>0) {
                                echo pg_fetch_result($pe,0,0);
                            }else{
                                echo "Qual a sua dÃºvida SR.(a)?<BR> ou<BR>A dÃºvida do Sr.(a) sobre como...., correto?";
                            }?>
                        </td>
                        <td align='right' width='150'></td>
                    </tr>
                </table>
            <?}?>
            <br>
            <br>
            </div>
            <?php if($novaTelaOs == true){ ?>
                <div id="div_situacao"></div>
                <div id="div_causa_solucao"></div>
            <?php } ?>
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <?php if(in_array($login_fabrica, array(169,170))){ ?>
                <tr>
                    <td>
                        <label class="asteristico">*</label>
                        <strong><?=$titulo_combo?>:</strong>
                    </td>
                    <td>
                        <select name='hd_motivo_ligacao_duvida_produto' class='select_motivo_ligacao' id='hd_motivo_ligacao_duvida_produto' data-aba='duvida_produto'>
                            <option value=''>Escolha a Providência</option>
                        </select>
                    </td>
                </tr>
                <tr <?= $displayProvNv3 ?>>
                        <td>
                            <label class='asteristico'>*</label>
                            <strong>Providência nÃ­vel 3:</strong>
                        </td>
                        <td>
                            <select name="providencia_nivel3_duvida_produto" id="providencia_nivel3_duvida_produto" style="width: 300px;">
                                <option value=""></option>
                                <?php
                                if ($mostra_providencia_nivel3 == "sim" && $tab_atual == "duvida_produto") {
                                    $sqlHdProvidencia = "SELECT descricao, hd_providencia
                                                         FROM tbl_hd_providencia
                                                         WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}
                                                         AND ativo IS TRUE
                                                         AND fabrica = {$login_fabrica}";
                                    $resHdProvidencia = pg_query($con, $sqlHdProvidencia);

                                    if (pg_num_rows($resHdProvidencia) > 0) {
                                        while ($dadosProv3 = pg_fetch_object($resHdProvidencia)) {

                                            $selected = ($dadosProv3->hd_providencia == $hd_providencia_callcenter) ? "selected" : "";

                                        ?>
                                            <option value="<?= $dadosProv3->hd_providencia ?>" <?= $selected ?>><?= $dadosProv3->descricao ?></option>
                                        <?php
                                        }
                                    }
                                }
                                ?>

                            </select>
                        </td>
                    </tr>
            <?php } ?>
            <?php if(!in_array($login_fabrica, array(169,170))){ ?>
                <tr>
                    <td><strong>DÃºvida :</strong></td>
                    <td align='left' colspan='5'>
                        <input name="faq_duvida_duvida"  id="faq_duvida_duvida" class="input" size="74" value="<? echo $faq_duvida ;?>">
                        <?php if($novaTelaOs == true){ ?>
                            <input  class="input"  type="button" name="bt_localizar" value="Localizar" onclick="javascript:localizarNovoFaq('','')">
                            <?php }else{ ?>
                            <input  class="input"  type="button" name="bt_localizar" value="Localizar" onclick="javascript:localizarFaq(document.frm_callcenter.produto_referencia.value,'faq_duvida_duvida')">
                            <?php } ?>
                    </td>
                    <? if($login_fabrica==2) {
                            $coluna ="7";
                            echo "<td align='left' nowrap>";
                            echo "<a href=\"javascript:listaFaq(document.frm_callcenter.produto_referencia.value)\">Listar todas dvidas cadastradas ou cadastrar a nova</a>";
                            echo "</td>";
                        }else{
                            $coluna ="6";
                        }
                    ?>
                </tr>
            <?php } ?>
            <?php if ($login_fabrica == 24) { ?>
            <tr>
                <td>Assunto:</td>

                <td>
                    <select name="callcenter_assunto[duvida_produto]" id="callcenter_assunto" class="input_req">
                        <option value=''>>>> Escolha <<<</option><?php

                        foreach ($assuntos["REVENDA"] AS $label => $valor) {

                            if ($valor == $callcenter_assunto) {
                                $selected = "selected";
                            } else {
                                $selected = "";
                            }

                            echo " <option value='$valor' $selected>REVENDA >> $label</option>";
                        } ?>
                    </select>
                </td>
            </tr>
            <?php
            }
            ?>

            <?php if(in_array($login_fabrica, array(169,170,176))){ ?>
            <tr>
                <td align='left' valign='top' width='80'>
                    <label class="asteristico">*</label>
                    <strong>Observação:</strong>
                </td>
                <td>
                    <TEXTAREA NAME="duvida_produto_obs" ROWS="6" COLS="110"  class="input" style='font-size:10px' <? echo $read;?>><?echo $reclamado ;?></TEXTAREA>
                </td>
            </tr>
            <?php } ?>
            <tr>
                <td colspan='<? echo $coluna; ?>' id="div_faq_duvida_duvida" class="div_faq_duvida_duvida"> &nbsp; </td>
            </tr>
            </table>

            <?php if(in_array($login_fabrica, array(101,145))){ ?>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                    <tr>
                        <td align='left' valign='top' width='80'><strong>Observação:</strong></td>
                        <td>
                            <TEXTAREA NAME="duvida_produto_obs" ROWS="6" COLS="110"  class="input" style='font-size:10px' <? echo $read;?>><?echo $reclamado ;?></TEXTAREA>
                        </td>
                    </tr>
                </table>
            <?php } ?>
        </div>

        <div id="sugestao" class='tab_content'>
            <input type='hidden' name='callcenter_assunto[sugestao]' value='sugestao'>
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <?php if(in_array($login_fabrica, array(169,170))){ ?>
                <tr>
                    <td>
                        <label class="asteristico">*</label>
                        <strong><?=$titulo_combo?>:</strong>
                    </td>
                    <td>
                        <select name='hd_motivo_ligacao_sugestao' class='select_motivo_ligacao' id='hd_motivo_ligacao_sugestao' data-aba='sugestao'>
                            <option value=''>Escolha a Providência</option>
                        </select>
                    </td>
                </tr>
                <tr <?= $displayProvNv3 ?>>
                        <td>
                            <label class='asteristico'>*</label>
                            <strong>Providência nÃ­vel 3:</strong>
                        </td>
                        <td>
                            <select name="providencia_nivel3_sugestao" id="providencia_nivel3_sugestao" style="width: 300px;">
                                <option value=""></option>
                                <?php
                                if ($mostra_providencia_nivel3 == "sim" && $tab_atual == "sugestao") {
                                    $sqlHdProvidencia = "SELECT descricao, hd_providencia
                                                         FROM tbl_hd_providencia
                                                         WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}
                                                         AND ativo IS TRUE
                                                         AND fabrica = {$login_fabrica}";
                                    $resHdProvidencia = pg_query($con, $sqlHdProvidencia);

                                    if (pg_num_rows($resHdProvidencia) > 0) {
                                        while ($dadosProv3 = pg_fetch_object($resHdProvidencia)) {

                                            $selected = ($dadosProv3->hd_providencia == $hd_providencia_callcenter) ? "selected" : "";

                                        ?>
                                            <option value="<?= $dadosProv3->hd_providencia ?>" <?= $selected ?>><?= $dadosProv3->descricao ?></option>
                                        <?php
                                        }
                                    }
                                }
                                ?>

                            </select>
                        </td>
                    </tr>
            <?php } ?>
            <tr>
                <td align='left' valign='top' width='80'>
                    <?php
                        if(in_array($login_fabrica, array(169,170))){
                            echo "<label class='asteristico'>*</label>";
                        }
                    ?>
                    <strong>Sugestão:</strong>
                </td>
                <td align='left' colspan='5'>
                    <?php
                    if ($login_fabrica == 74 && !empty($callcenter) && $admin != 6437) {
                        $bloqueia_reclamado_produto = "readonly";

                        echo $reclamado;
                        echo "<input type='hidden' name='reclamado_sugestao' value='$reclamado' />";
                    }else{
                        if ($login_fabrica == 74 && !empty($callcenter) && isset($_POST["reclamado_sugestao"])) {
                            $reclamado = $_POST["reclamado_sugestao"];
                        }

                        ?>
                        <TEXTAREA NAME="reclamado_sugestao" ROWS="6" COLS="110"  class="input" style='font-size:10px' <? echo $read;?>><?echo $reclamado ;?></TEXTAREA>
                    <? } ?>

                </td>
            </tr>
            </table>

            <BR>

            <div rel='div_ajuda' style='display:inline; Position:relative;'>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
                <tr>
                    <td align='right' width='150'></td>
                    <td align='right' width='55'>
                        <img src='imagens/ajuda_call.png' align=absmiddle>
                    </td>
                    <td align='center'>
                        <STRONG>
                        <?
                        $sql = "SELECT pergunta FROM tbl_callcenter_pergunta WHERE codigo='8' AND fabrica = $login_fabrica";
                        $pe = pg_query($con,$sql);
                        if(pg_num_rows($pe)>0) {
                            echo pg_fetch_result($pe,0,0);
                        }else{
                            echo "Sr.(a) estou encaminhando a sua reclamação ao Depto. responsável, que responderá em 12 h.";
                        }
                        ?>
                    </td>
                    <td align='right' width='150'></td>
                </tr>
                </table>
            </div>
        </div>

        <?if(!in_array($login_fabrica, array(59,169,170))){ # HD 37805 ?>
        <div id="procon" class='tab_content'>
            <div rel='div_ajuda' style='display:inline; Position:relative;'>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
                <tr>
                    <td align='right' width='150'></td>
                    <td align='right' width='55'>
                        <img src='imagens/ajuda_call.png' align=absmiddle>
                    </td>
                    <td align='center'>
                        <STRONG>Confirmar ou perguntar a reclamação.</STRONG><BR>
                        <?
                        $sql = "SELECT pergunta FROM tbl_callcenter_pergunta WHERE codigo='10' AND fabrica = $login_fabrica";
                        $pe = pg_query($con,$sql);
                        if(pg_num_rows($pe)>0) {
                            echo pg_fetch_result($pe,0,0);
                        }else{
                            echo "Qual a reclamação feita no Procon pelo SR.(a)?<BR>    ou<BR> O Sr.(a) diz que...., correto?";
                        }
                        ?>
                    </td>
                    <td align='right' width='150'></td>
                </tr>
                </table>
            </div>

            <? if($login_fabrica ==11 || $login_fabrica == 172) { // HD 55995?>
            Informações da Assistência
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                <tr>
                    <td align='left'><strong>Código:</strong></td>
                    <td align='left'>
                        <input name="procon_codigo_posto"  class="input"  value='<?echo $procon_codigo_posto ;?>'
                        onblur="javascript: fnc_pesquisa_posto (document.frm_callcenter.procon_codigo_posto,document.frm_callcenter.procon_posto_nome,'codigo');" type="text" size="15" maxlength="15">
                        <img src='imagens/lupa.png' border='0' align='absmiddle'
                        style='cursor: pointer'
                        onclick="javascript: fnc_pesquisa_posto (document.frm_callcenter.procon_codigo_posto,document.frm_callcenter.procon_posto_nome,'codigo');">
                    </td>
                    <td align='left'><strong>Nome:</strong></td>
                    <td align='left'>
                        <input name="procon_posto_nome"  class="input" value='<?echo $procon_posto_nome ;?>'
                        onblur="javascript: fnc_pesquisa_posto (document.frm_callcenter.procon_codigo_posto,document.frm_callcenter.procon_posto_nome,'nome');" type="text" size="35" maxlength="500">
                        <img src='imagens/lupa.png' border='0' align='absmiddle'
                        style='cursor: pointer'
                        onclick="javascript: fnc_pesquisa_posto (document.frm_callcenter.procon_codigo_posto,document.frm_callcenter.procon_posto_nome,'nome');">
                    </td>
                </tr>
            </table>
                Tipo da Reclamação
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                <tr>
                    <td align='left' class="padding" width='50%' nowrap><input type="radio" name="reclamacao_procon" value="pr_reclamacao_at" <?PHP if ($natureza_chamado2 == 'pr_reclamacao_at' OR $natureza_chamado2 =='') { echo "CHECKED";}?>> RECLAMAÃÃO DA ASSIST. TÃCN.</td>
                    <td align='left' class="padding" width='50%' nowrap><input type="radio" name="reclamacao_procon" value="pr_info_at" <?PHP if ($natureza_chamado2 == 'pr_info_at') { echo "CHECKED";}?>>INFORMAÃÃES DE A.T</td>
                </tr>
                <tr>
                    <td align='left' class="padding" width='50%' nowrap><input type="radio" name="reclamacao_procon" value="pr_mau_atend" <?PHP if ($natureza_chamado2 == 'pr_mau_atend') { echo "CHECKED";}?>>MAU ATENDIMENTO</td>
                    <td align='left' class="padding" width='50%' nowrap><input type="radio" name="reclamacao_procon" value="pr_posto_n_contrib" <?PHP if ($natureza_chamado2 == 'pr_posto_n_contrib') { echo "CHECKED";}?>>POSTO NÃO CONTRIBUI COM INFORMAÃÃES</td>
                </tr>
                <tr>
                    <td align='left' class="padding" width='50%' nowrap><input type="radio" name="reclamacao_procon" value="pr_demonstra_desorg" <?PHP if ($natureza_chamado2 == 'pr_demonstra_desorg') { echo "CHECKED";}?>>DEMONSTRA DESORGANIZAÃÃO</td>
                    <td align='left' class="padding" width='50%' nowrap><input type="radio" name="reclamacao_procon" value="pr_bom_atend" <?PHP if ($natureza_chamado2 == 'pr_bom_atend') { echo "CHECKED";}?>>POSSUI BOM ATENDIMENTO</td>
                </tr>
                <tr>
                    <td align='left' class="padding" width='50%' nowrap><input type="radio" name="reclamacao_procon" value="pr_demonstra_org" <?PHP if ($natureza_chamado2 == 'pr_demonstra_org') { echo "CHECKED";}?>>DEMONSTRA ORGANIZAÃÃO</td>
                </tr>
                </table>
            <? } ?>
            Informações da Reclamação
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <?php if($login_fabrica == 160 or $replica_einhell){ ?>
                <tr>
                    <td><strong>número do Processo:</strong></td>
                    <td>
                        <input type="text" name="numero_processo" class="input" value="<?=$numero_processo?>" maxlength="30">
                    </td>
                </tr>
                <tr>
                    <td><strong>Data da Audiência de Conciliação:</strong></td>
                    <td>
                        <input type="text" name="data_conciliacao" rel="data" id="data_conciliacao" class="input" value="<?=$data_conciliacao?>" maxlength="10" >
                    </td>
                </tr>
                <tr>
                    <td><strong>Data da Audiência de Julgamento:</strong></td>
                    <td>
                        <input type="text" name="data_julgamento" rel="data" id="data_julgamento" class="input" value="<?=$data_julgamento?>" maxlength="10" >
                    </td>
                </tr>
            <?}

            if ($login_fabrica == 35) {

                $sqlDefeitoProcon = "SELECT defeito_reclamado,
                                            descricao
                                     FROM tbl_defeito_reclamado
                                     WHERE fabrica = $login_fabrica
                                     AND duvida_reclamacao = 'PR'";
                $resDefeitoProcon = pg_query($con, $sqlDefeitoProcon);

            ?>
                <tr>
                    <td><strong>Defeito Reclamado:</strong></td>
                    <td>
                        <select name="defeito_reclamado_procon" id="defeito_reclamado_procon">
                            <option value="">Selecione</option>
                            <?php

                            for ($i=0;$i < pg_num_rows($resDefeitoProcon);$i++) {
                                $defeito_pr           = pg_fetch_result($resDefeitoProcon, $i, 'defeito_reclamado');
                                $defeito_pr_descricao = pg_fetch_result($resDefeitoProcon, $i, 'descricao');

                                $selected_pr_defeito = (($_POST["defeito_reclamado_procon"] == $defeito_pr) || ($defeito_reclamado == $defeito_pr)) ? "selected" : "";
                            ?>
                                <option value="<?= $defeito_pr ?>" <?= $selected_pr_defeito ?> >
                                    <?= $defeito_pr_descricao ?>
                                </option>
                            <?php
                            }

                            ?>
                        </select>
                    </td>
                </tr>
            <?php
            }
            ?>
            <tr>
                <td align='left' valign='top' width='160'><strong>Reclamação:</strong></td>
                <td align='left' colspan='5'>
                    <?php
                    if ($login_fabrica == 74 && !empty($callcenter) && $admin != 6437) {
                        $bloqueia_reclamado_produto = "readonly";

                        echo $reclamado;
                        echo "<input type='hidden' name='reclamado_procon' value='$reclamado' />";
                    }else{
                        if ($login_fabrica == 74 && !empty($callcenter) && isset($_POST["reclamado_procon"])) {
                            $reclamado = $_POST["reclamado_procon"];
                        }

                        ?>
                        <TEXTAREA NAME="reclamado_procon" ROWS="6" COLS="110"  class="input" style='font-size:10px' <? echo $read; ?>><?echo $reclamado ;?></TEXTAREA>
                    <? } ?>

                </td>
            </tr>
            <?php if ($login_fabrica == 24) { ?>
            <tr>
                <td>Assunto:</td>

                <td>
                    <select name="callcenter_assunto[procon]" id="callcenter_assunto" class="input_req">
                        <option value=''>>>> Escolha <<<</option><?php

                        foreach ($assuntos["PROCON"] AS $label => $valor) {

                            if ($valor == $callcenter_assunto) {
                                $selected = "selected";
                            } else {
                                $selected = "";
                            }

                            echo " <option value='$valor' $selected>PROCON >> $label</option>";
                        } ?>
                    </select>
                </td>
            </tr>
            <?php
            } ?>
            </table>
            <BR>
        </div>
        <?}?>
        <div id="onde_comprar" class='tab_content'>
            <div rel='div_ajuda' style='display:inline; Position:relative;'>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
                <tr>
                    <td align='right' width='150'></td>
                    <td align='right' width='55'>
                        <img src='imagens/ajuda_call.png' align=absmiddle>
                    </td>
                    <td align='center'>
                        <STRONG>Informar dados da Revenda.</STRONG><BR>
                        <?
                        $sql = "SELECT pergunta FROM tbl_callcenter_pergunta WHERE codigo='11' AND fabrica = $login_fabrica";
                        $pe = pg_query($con,$sql);
                        if(pg_num_rows($pe)>0) {
                            echo pg_fetch_result($pe,0,0);
                        }else{
                            echo "Quais são os dados da Revenda?";
                        }
                ?>
                    </td>
                    <td align='right' width='150'></td>
                </tr>
                </table>

            </div>

            <?
            # HD 31204 - Francisco Ambrozio
            #   Alterado campo onde comprar para a Dynacom
            # HD - 3120493 adicionada fabrica 161
            if ($login_fabrica == 2 || $login_fabrica == 24 || $login_fabrica == 161){
                if (strlen($revenda) > 0){
                $sql = "SELECT tbl_revenda.nome,
                            tbl_revenda.endereco,
                            tbl_revenda.numero,
                            tbl_revenda.complemento,
                            tbl_revenda.bairro,
                            tbl_revenda.fone,
                            tbl_cidade.nome AS revenda_city,
                            tbl_cidade.estado AS revenda_uf
                            FROM tbl_revenda
                            JOIN tbl_cidade USING (cidade)
                            WHERE revenda = $revenda";
                $res = pg_query($con,$sql);

                if(pg_num_rows($res)>0){
                    $revenda_nome             = pg_fetch_result($res,0,nome);
                    $revenda_endereco         = pg_fetch_result($res,0,endereco);
                    $revenda_nro              = pg_fetch_result($res,0,numero);
                    $revenda_cmpto            = pg_fetch_result($res,0,complemento);
                    $revenda_bairro           = pg_fetch_result($res,0,bairro);
                    $revenda_city             = pg_fetch_result($res,0,revenda_city);
                    $revenda_uf               = pg_fetch_result($res,0,revenda_uf);
                    $revenda_fone             = pg_fetch_result($res,0,fone);
                }
            }
            ?>
                Informações da Revenda

            <?
            //HD 235203: Alterar assuntos Fale Conosco e CallCenter
            //           O array $assuntos é definido dentro do arquivo callcenter_suggar_assuntos.php
            //           que está sendo incluÃ­do no começo deste arquivo

            if ($login_fabrica == 24) {?>

                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                    <tr>
                        <td>
                            Assunto: <select name="callcenter_assunto[onde_comprar]" id="callcenter_assunto" class="input_req">
                            <option value=''>>>> Escolha <<<</option><?php

                            foreach ($assuntos["REVENDA"] AS $label => $valor) {

                                if ($valor == $callcenter_assunto) {
                                    $selected = "selected";
                                } else {
                                    $selected = "";
                                }

                                echo " <option value='$valor' $selected>REVENDA >> $label</option>";
                            } ?>
                            </select>
                        </td>
                    </tr>
                </table><?php

            } ?>


            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                <tr>
                    <td align='left' width='68'><strong>Localizar:</strong></td>
                    <td align='left' nowrap colspan=5>
                        <?php if($login_fabrica == 161){//hd_chamado=3120493 ?>
                            <input name="localizarrevenda" id='localizarrevenda' value='<?echo $localizarrevenda ;?>' class="input" type="text" size="40" maxlength="500"> <a href='#onde_comprar' onclick='javascript: fnc_pesquisa_revenda (document.frm_callcenter.localizarrevenda, "nome","")'>Por Nome</a> | <a href='#onde_comprar' onclick='javascript:fnc_pesquisa_revenda (document.frm_callcenter.localizarrevenda, "cidade","")'>Por Cidade</a> | <a href='#onde_comprar' onclick='javascript:fnc_pesquisa_revenda (document.frm_callcenter.localizarrevenda, "cnpj","")'>Por CNPJ</a>
                        <?php }else{?>
                            <input name="localizarrevenda" id='localizarrevenda' value='<?echo $localizarrevenda ;?>' class="input" type="text" size="40" maxlength="500"> <a href='#onde_comprar' onclick='javascript: fnc_pesquisa_revenda (document.frm_callcenter.localizarrevenda, "nome","")'>Por Nome</a> | <a href='#onde_comprar' onclick='javascript:fnc_pesquisa_revenda (document.frm_callcenter.localizarrevenda, "cidade","")'>Por Cidade</a> | <a href='#onde_comprar' onclick='javascript:fnc_pesquisa_revenda (document.frm_callcenter.localizarrevenda, "cnpj","")'>Por CNPJ</a> | <a href='#onde_comprar' onclick='javascript:fnc_pesquisa_revenda (document.frm_callcenter.localizarrevenda, "familia",document.frm_callcenter.consumidor_cidade)'>Por FamÃ­lia do Produto</a>
                        <?php } ?>
                    </td>
                </tr>
                <tr>
                    <td align='left'><strong>Nome:</strong></td>
                    <td align='left'><input type='hidden' name='revenda' id='revenda' value='<?=$revenda?>'><input type='text' name='revenda_nome' id='revenda_nome' value='<?=$revenda_nome?>'  size="40" maxlength="50">
                    </td>
                </tr>
                <tr>
                    <td align='left'><strong>Endereço:</strong></td>
                    <td align='left'><input type='text' name='revenda_endereco' id='revenda_endereco' value='<?=$revenda_endereco?>'  size="40" maxlength="500">
                    </td>
                    <td align='left'><strong>Nro.:</strong></td>
                    <td align='left'><input type='text' name='revenda_nro' id='revenda_nro' value='<?=$revenda_nro?>'>
                    </td>
                    <td align='left'><strong>Complemento:</strong></td>
                    <td align='left'><input type='text' name='revenda_cmpto' id='revenda_cmpto' value='<?=$revenda_cmpto?>'>
                    </td>
                </tr>
                    <tr>
                    <td align='left'><strong>Bairro:</strong></td>
                    <td align='left'><input type='text' name='revenda_bairro' id='revenda_bairro' value='<?=$revenda_bairro?>'>
                    </td>
                    <td align='left' valign='top'><strong>Cidade:</strong></td>
                    <td align='left'><input type='text' name='revenda_city' id='revenda_city' value='<?=$revenda_city?>'>
                    </td>
                    <td align='left'><strong>UF:</strong></td>
                    <td align='left'><input type='text' name='revenda_uf' id='revenda_uf' value='<?=$revenda_uf?>'>
                    </td>
                </tr>
                <tr>
                    <td align='left'><strong>Telefone:</strong></td>
                    <td align='left'><input type='text' name='revenda_fone' id='revenda_fone' value='<?=$revenda_fone?>'>
                    </td>
                </tr><tr><td colspan='4'>Para cadastrar <a href='revenda_cadastro.php' target='_blank'>clique aqui</a></td><?php
                //HD 235203: Alterar assuntos Fale Conosco e CallCenter

                if ($login_fabrica == 24) {?>
                    <tr><td colspan='7' height='10'></td></tr>
                    <tr>
                        <td align='left' valign='top'><strong>Informações:</strong></td>
                        <td align='left' colspan='6'>
                            <TEXTAREA NAME="reclamado_onde_comprar" ROWS="6" COLS="110"  class="input" style='font-size:10px' <?echo $read;?>><?echo $reclamado ;?></TEXTAREA>
                        </td>
                    </tr><?php
                }?>

                </table><?php

            } else {?>

            Informações da Reclamação
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                <?php if(in_array($login_fabrica, array(169,170))){ ?>
                    <tr>
                        <td>
                            <label class="asteristico">*</label>
                            <strong><?=$titulo_combo?>:</strong>
                        </td>
                        <td>
                            <select name='hd_motivo_ligacao_onde_comprar' class='select_motivo_ligacao' id='hd_motivo_ligacao_onde_comprar' data-aba='onde_comprar'>
                                <option value=''>Escolha a Providência</option>
                            </select>
                        </td>
                    </tr>
                    <tr <?= $displayProvNv3 ?>>
                        <td>
                            <label class='asteristico'>*</label>
                            <strong>Providência nÃ­vel 3:</strong>
                        </td>
                        <td>
                            <select name="providencia_nivel3_onde_comprar" id="providencia_nivel3_onde_comprar" style="width: 300px;">
                                <option value=""></option>
                                <?php
                                if ($mostra_providencia_nivel3 == "sim" && $tab_atual == "onde_comprar") {
                                    $sqlHdProvidencia = "SELECT descricao, hd_providencia
                                                         FROM tbl_hd_providencia
                                                         WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}
                                                         AND ativo IS TRUE
                                                         AND fabrica = {$login_fabrica}";
                                    $resHdProvidencia = pg_query($con, $sqlHdProvidencia);

                                    if (pg_num_rows($resHdProvidencia) > 0) {
                                        while ($dadosProv3 = pg_fetch_object($resHdProvidencia)) {

                                            $selected = ($dadosProv3->hd_providencia == $hd_providencia_callcenter) ? "selected" : "";

                                        ?>
                                            <option value="<?= $dadosProv3->hd_providencia ?>" <?= $selected ?>><?= $dadosProv3->descricao ?></option>
                                        <?php
                                        }
                                    }
                                }
                                ?>

                            </select>
                        </td>
                    </tr>
                <?php } ?>
                <tr>
                    <td align='left' valign='top'><strong>CNPJ:</strong></td>
                    <td align='left' colspan='5'><input type='hidden' name='revenda' id='revenda' value='<?=$revenda?>'><input type='text' name='revenda_cnpj' id='revenda_cnpj' value='<?=$revenda_cnpj?>'>
                    </td>
                    <td align='left' valign='top'><strong>Nome:</strong></td>
                    <td align='left' colspan='5'><input type='text' name='revenda_nome' id='revenda_nome' value='<?=$revenda_nome?>' maxlength='50'>
                    </td>
                </tr>
                <tr><td colspan='4'>Para cadastrar <a href='revenda_cadastro.php' target='_blank'>clique aqui</a></td>

                <?php if(in_array($login_fabrica,array(169,170))){ ?>
                <tr>
                    <td  align="left" colspan='5'>
                        <button style="height: 22px; font-size: 12px !important;" type='button' onClick='onde_comprar_midea();'>Clique aqui para acessar a lista de lojas/revendas</button>
                    </td>
                </tr>
                <?php } ?>
            </table>

                <?php if($login_fabrica == 101 || $login_fabrica == 145){ ?>
                    <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                        <tr>
                            <td align='left' valign='top' width='80'><strong>Observação:</strong></td>
                            <td>
                                <TEXTAREA NAME="onde_comprar_obs" ROWS="6" COLS="110"  class="input" style='font-size:10px' <? echo $read;?>><?echo $reclamado ;?></TEXTAREA>
                            </td>
                        </tr>
                    </table>
                <?php } ?>

            <? } ?>
            <BR>
        </div>

        <?php if(in_array($login_fabrica, array(169,170))){ ?>
        <div id="indicacao_at" class='tab_content'>
            <div rel='div_indicacao_at' style='display:inline; Position:relative;'>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
                    <tr>
                        <td align='right' width='150'></td>
                        <td align='right' width='55'>
                            <img src='imagens/ajuda_call.png' align=absmiddle>
                        </td>
                        <td align='center'>
                            <STRONG>Indicação de Assistência Técnica</STRONG><BR>
                        </td>
                        <td align='right' width='150'></td>
                    </tr>
                </table>
            </div>
            <br/><br/>
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                <tr>
                    <td>
                        <label class="asteristico">*</label>
                        <strong><?=$titulo_combo?>:</strong>
                    </td>
                    <td>
                        <select name='hd_motivo_ligacao_indicacao_at' class='select_motivo_ligacao' id='hd_motivo_ligacao_indicacao_at' data-aba='indicacao_at'>
                            <option value=''>Escolha a Providência</option>
                        </select>
                    </td>
                </tr>
                <tr <?= $displayProvNv3 ?>>
                    <td>
                        <label class='asteristico'>*</label>
                        <strong>Providência nÃ­vel 3:</strong>
                    </td>
                    <td>
                        <select name="providencia_nivel3_indicacao_at" id="providencia_nivel3_indicacao_at" style="width: 300px;">
                            <option value=""></option>
                            <?php
                            if ($mostra_providencia_nivel3 == "sim" && $tab_atual == "indicacao_at") {
                                $sqlHdProvidencia = "SELECT descricao, hd_providencia
                                                     FROM tbl_hd_providencia
                                                     WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}
                                                     AND ativo IS TRUE
                                                     AND fabrica = {$login_fabrica}";
                                $resHdProvidencia = pg_query($con, $sqlHdProvidencia);

                                if (pg_num_rows($resHdProvidencia) > 0) {
                                    while ($dadosProv3 = pg_fetch_object($resHdProvidencia)) {

                                        $selected = ($dadosProv3->hd_providencia == $hd_providencia_callcenter) ? "selected" : "";

                                    ?>
                                        <option value="<?= $dadosProv3->hd_providencia ?>" <?= $selected ?>><?= $dadosProv3->descricao ?></option>
                                    <?php
                                    }
                                }
                            }
                            ?>

                        </select>
                    </td>
                </tr>
                <tr>
                    <td align='left' valign='top' width='80'>
                        <label class="asteristico">*</label>
                        <strong>Reclamação:</strong>
                    </td>
                    <td align='left' colspan='5'>
                        <TEXTAREA NAME="reclamado_assitencia" ROWS="6" COLS="110"  class="input" style='font-size:10px' <?echo $read;?>><?echo $reclamado ;?></TEXTAREA>
                    </td>
                </tr>
            </table>
        </div>

        <div id="informacao" class='tab_content'>
            <div rel='div_informacao' style='display:inline; Position:relative;'>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
                    <tr>
                        <td align='right' width='150'></td>
                        <td align='right' width='55'>
                            <img src='imagens/ajuda_call.png' align=absmiddle>
                        </td>
                        <td align='center'>
                            <STRONG>Informação.</STRONG><BR>
                        </td>
                        <td align='right' width='150'></td>
                    </tr>
                </table>
            </div>
            <br/><br/>
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                <tr>
                    <td>
                        <label class="asteristico">*</label>
                        <strong><?=$titulo_combo?>:</strong>
                    </td>
                    <td>
                        <select name='hd_motivo_ligacao_informacao' class='select_motivo_ligacao' id='hd_motivo_ligacao_informacao' data-aba='informacao'>
                            <option value=''>Escolha a Providência</option>
                        </select>
                    </td>
                </tr>
                <tr <?= $displayProvNv3 ?>>
                        <td>
                            <label class='asteristico'>*</label>
                            <strong>Providência nível 3:</strong>
                        </td>
                        <td>
                            <select name="providencia_nivel3_informacao" id="providencia_nivel3_informacao" style="width: 300px;">
                                <option value=""></option>
                                <?php
                                if ($mostra_providencia_nivel3 == "sim" && $tab_atual == "informacao") {
                                    $sqlHdProvidencia = "SELECT descricao, hd_providencia
                                                         FROM tbl_hd_providencia
                                                         WHERE hd_motivo_ligacao = {$hd_motivo_ligacao}
                                                         AND ativo IS TRUE
                                                         AND fabrica = {$login_fabrica}";
                                    $resHdProvidencia = pg_query($con, $sqlHdProvidencia);

                                    if (pg_num_rows($resHdProvidencia) > 0) {
                                        while ($dadosProv3 = pg_fetch_object($resHdProvidencia)) {

                                            $selected = ($dadosProv3->hd_providencia == $hd_providencia_callcenter) ? "selected" : "";

                                        ?>
                                            <option value="<?= $dadosProv3->hd_providencia ?>" <?= $selected ?>><?= $dadosProv3->descricao ?></option>
                                        <?php
                                        }
                                    }
                                }
                                ?>

                            </select>
                        </td>
                    </tr>
                <tr>
                    <td align='left' valign='top' width='80'>
                        <label class="asteristico">*</label>
                        <strong>Informação:</strong>
                    </td>
                    <td align='left' colspan='5'>
                        <TEXTAREA NAME="reclamacao_informacao" ROWS="6" COLS="110"  class="input" style='font-size:10px' <?echo $read;?>><?echo $reclamado ;?></TEXTAREA>
                    </td>
                </tr>
            </table>
        </div>
        <?php } ?>
        <?php if($login_fabrica == 101){?>
        <div id="elogio" class='tab_content'>
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                <tr>
                    <td align='left' valign='top'><strong>Informações:</strong></td>
                    <td align='left' colspan='6'>
                        <TEXTAREA NAME="reclamado_elogio" ROWS="6" COLS="110"  class="input" style='font-size:10px' <?echo $read;?>><?echo $reclamado ;?></TEXTAREA>
                    </td>
                </tr>
            </table>
        </div>
        <div id="produto_acessorio_nao_entregue" class='tab_content'>
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                <tr>
                    <td align='left' valign='top'><strong>Informações:</strong></td>
                    <td align='left' colspan='6'>
                        <TEXTAREA NAME="reclamado_produto_acessorio_nao_entregue" ROWS="6" COLS="110"  class="input" style='font-size:10px' <?echo $read;?>><?echo $reclamado ;?></TEXTAREA>
                    </td>
                </tr>
            </table>
        </div>
        <?}

        if ($login_fabrica == 85) {
            $descricao_garantia_contratual = empty($_POST['descricao_garantia_contratual']) ? $reclamado : $_POST['descricao_garantia_contratual'];
        ?>

            <div id="garantia_contratual" class='tab_content'>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                    <tr>
                        <td align='left' colspan='4'>
                            <strong>
                                Garantia Contratual:
                                <input type="checkbox" value="t" name="garantia_contratual_check" <?php if($categoria  == "garantia_contratual" OR $garantia_contratual_check == 't') echo " checked "?> ></input>
                            </strong>
                        </td>
                    </tr>
                    <tr>
                        <td align='left' valign='top'><strong>Informações:</strong></td>
                        <td align='left' colspan='6'>
                            <TEXTAREA NAME="descricao_garantia_contratual" ROWS="6" COLS="110"  class="input" style='font-size:10px' <?echo $read;?>><?echo $descricao_garantia_contratual ;?></TEXTAREA>
                        </td>
                    </tr>
                </table>
            </div>

        <?php
        }

        if ($login_fabrica == 1 and strlen($callcenter) > 0) {

            $aDados = hdBuscarChamado($callcenter);

            switch ($aDados['categoria']) {

                case ('digitacao_fechamento_de_os') :   $categoria = "Digitação e/ou fechamento de OS\'s"; break;
                case ('utilizacao_do_site') :           $categoria = "Utilização do site"; break;
                case ('falha_no_site') :                $categoria = "Falha no site"; break;
                case ('pendencias_de_pecas') :          $categoria = "Pendências de peças"; break;
                case ('pedido_de_pecas') :              $categoria = "Pedido de peças"; break;
                case ('duvida_tecnica_sobre_produto') : $categoria = "DÃºvida técnica sobre o produto"; break;
                case ('outros') :                       $categoria = "Outros"; break;

            }?>

            <div id="hd_posto" class='tab_content'>
                <div rel='div_ajuda' style='display:inline; Position:relative;'>
                    <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
                        <tr>
                            <td align='right' width='150'></td>
                            <td align='right' width='55'>
                                <img src='imagens/ajuda_call.png' align=absmiddle>
                            </td>
                            <td align='center'>
                                <STRONG>Informações cadastrados pelo posto.</STRONG><BR>
                            </td>
                            <td align='right' width='150'></td>
                        </tr>
                    </table>

                    <br />
                    <center>
                    <table width='90%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:12px'>
                        <tbody>
                                <tr>
                                    <td class=" border "> Tipo de Solicitação: </td>
                                    <td class="dados"> <?php echo $categoria; ?> </td>

                                    <td class=" border "> Produto em Garantia: </td>
                                    <td class="dados"> <?php echo ($aDados['garantia'] =='t') ? "Sim" : "Não" ; ?> </td>
                                </tr>
                                <tr>
                                    <td class=" border "> Produto: </td>
                                    <td class="dados"> <?php echo $aDados['referencia']; ?> </td>

                                    <td class=" border "> OS: </td>
                                    <td class="dados"> <?php echo (!empty($aDados['sua_os'])) ? $aDados['codigo_posto']."".$aDados['sua_os'] : ""; ?> </td>
                                </tr>
                                <tr>
                                    <td class=" border "> Pedido: </td>
                                    <td class="dados"> <?php echo $aDados['pedido']; ?> </td>

                                    <td class=" border "> Posto recebe peça em garantia: </td>

                                    <td class="dados"> <?php echo ($aDados['pedido_em_garantia'] =='t') ? "Sim" : "Não" ; ?> </td>
                                </tr>
                            </tbody>
                        </table>
                    </center>
                </div>
                <br />
            </div><?php

        }

        if ($login_fabrica == 45) {?>
        <div id="garantia" class='tab_content'>
            <p style='font-size: 14px'><b>Garantia</b></p>
            Informações do Produto
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <tr>
                <td align='left'><strong>Referência:</strong></td>
                <td align='left'>
                    <input name="produto_referencia_garantia"  class="input"  value='<?echo $produto_referencia ;?>'
                    onblur="javascript: fnc_pesquisa_produto (document.frm_callcenter.produto_referencia_garantia,document.frm_callcenter.produto_nome_garantia,'referencia');mostraDefeitos('Reclamado',document.frm_callcenter.produto_referencia_garantia.value)" type="text" size="15" maxlength="15">
                    <img src='imagens/lupa.png' border='0' align='absmiddle'
                    style='cursor: pointer'
                    onclick="javascript: fnc_pesquisa_produto (document.frm_callcenter.produto_referencia_garantia,document.frm_callcenter.produto_nome_garantia,'descricao')">
                </td>
                <td align='left'><strong>Descrição:</strong></td>
                <td align='left'>
                    <input type='hidden' name='produto_garantia' value="<? echo $produto; ?>">
                    <input name="produto_nome_garantia"  class="input" value='<?echo $produto_nome ;?>'
                    onblur="javascript: fnc_pesquisa_produto (document.frm_callcenter.produto_referencia_garantia,document.frm_callcenter.produto_nome_garantia,'descricao');mostraDefeitos('Reclamado',document.frm_callcenter.produto_referencia_garantia.value)" type="text" size="35" maxlength="500">
                    <img src='imagens/lupa.png' border='0' align='absmiddle'
                    style='cursor: pointer'
                    onclick="javascript: fnc_pesquisa_produto (document.frm_callcenter.produto_referencia_garantia,document.frm_callcenter.produto_nome_garantia,'descricao')">
                </td>
                <td align='left'><strong>Série:</strong></td>
                <td align='left'>
                    <input name="serie_garantia" maxlength="20" class="input"  value='<?echo $serie ;?>'>
                </td>
            </tr>

            <tr>
                <td align='left' valign='top'><strong>Descrição:</strong></td>
                <td align='left' colspan='5'>
                    <TEXTAREA NAME="reclamado_produto_garantia" ROWS="6" COLS="110"  class="input" style='font-size:10px'><?echo $reclamado ;?></TEXTAREA>
                </td>
            </tr>
            </table>
        </div>
        <? } ?>

        <?if((in_array($login_fabrica, array(59,81,155,114))) or $telecontrol_distrib) { /* HD 37805 */?>
        <div id="ressarcimento" class='tab_content'>

        <!-- SEDEX REVERSO -->
        <!--
            <div rel='div_ajuda' style='display:inline; Position:relative;'>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
                <tr>
                    <td align='right' width='150'></td>
                    <td align='right' width='55'>
                        <img src='imagens/ajuda_call.png' align=absmiddle>
                    </td>
                    <td align='center'>
                        <STRONG>Informar dados Bancários.</STRONG><BR>
                        <?
                        $sql = "SELECT pergunta FROM tbl_callcenter_pergunta WHERE codigo='11' AND fabrica = $login_fabrica";
                        $pe = pg_query($con,$sql);
                        if(pg_num_rows($pe)>0) {
                            echo pg_fetch_result($pe,0,0);
                        }else{
                            echo "Quais são os dados da Revenda?";
                        }
                ?>
                    </td>
                    <td align='right' width='150'></td>
                </tr>
                </table>
            </div>
-->
            <?
            if (strlen($callcenter) > 0){
                $sql = "SELECT  banco            ,
                                agencia          ,
                                contay           ,
                                nomebanco        ,
                                favorecido_conta ,
                                cpf_conta        ,
                                tipo_conta
                        FROM tbl_hd_chamado_extra_banco
                        WHERE hd_chamado = $callcenter";
                $res = pg_query($con,$sql);

                if(pg_num_rows($res)>0){
                    $banco            = pg_fetch_result($res,0,banco);
                    $agencia          = pg_fetch_result($res,0,agencia);
                    $contay           = pg_fetch_result($res,0,contay);
                    $nomebanco        = pg_fetch_result($res,0,nomebanco);
                    $favorecido_conta = pg_fetch_result($res,0,favorecido_conta);
                    $cpf_conta        = pg_fetch_result($res,0,cpf_conta);
                    $tipo_conta       = pg_fetch_result($res,0,tipo_conta);
                }
            }
            ?>
            Dados Bancários
            <table width='100%' border='0' align='center' cellpadding="0" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <tr>
                <? if (strlen($xos)==0) { $xos = $os ;}?>
                <td align='left'><strong>OS:</strong></td>
                <td align='left'><input type='text' name='os_ressarcimento' id='os_ressarcimento' class="input" value='<?=$xos?>'  size="13" maxlength="13">
                </td>
            </tr>
            <tr>
                <td align='left'><strong>Banco:</strong></td>
                <?

                $sql = "SELECT banco,codigo,nome from tbl_banco order by nome";
                $res = pg_exec($con,$sql);
                ?>
                <td align='left'>
                    <select name='banco' id='banco' class='input'>
                        <option>- Escolha</option>
                            <?
                                for ($i=0;$i<pg_num_rows($res);$i++) {
                                    $xbanco = pg_result($res,$i,banco);
                                    $codigo = pg_result($res,$i,codigo);
                                    $nome = pg_result($res,$i,nome);

                                    if ($banco == $xbanco) {
                                        $selected = "SELECTED";
                                    }
                                    echo "<option value='$xbanco' $selected>$codigo-$nome</option>";
                                    $selected = '';
                                }
                            ?>
                        </select>
                </td>
            </tr>
            <tr>
                <td align='left'><strong>Agência:</strong></td>
                <td align='left'><input type='text' name='agencia' id='agencia' class="input" value='<?=$agencia?>' size="15" maxlength="10">
                </td>
            </tr>
            <tr>
                <td align='left'><strong>Conta:</strong></td>
                <td align='left'><input type='text' name='contay' id='contay' class="input" value='<?=$contay?>' size="15" maxlength="10">
                </td>
            </tr>
            <tr>
                <td align='left'><strong>Tipo de Conta:</strong></td>
                <td align='left'>
                    <select name='tipo_conta' id='tipo_conta' class="input" style='width:150px; font-size:10px' >
                        <option value='' <? if (strlen($tipo_conta)==0)echo "SELECTED";?> ></option>
                        <option value='Conta conjunta' <? if ($tipo_conta == 'Conta conjunta')echo "SELECTED";?> >Conta conjunta</option>
                        <option value='Conta corrente' <? if ($tipo_conta == 'Conta corrente')echo "SELECTED";?>>Conta corrente</option>
                        <option value='Conta individual' <? if ($tipo_conta == 'Conta individual')echo "SELECTED";?>>Conta individual</option>
                        <option value='Conta jurdica' <? if ($tipo_conta == 'Conta jurdica')echo "SELECTED";?>>Conta jurÃ­dica</option>
                        <option value='Conta poupana' <? if ($tipo_conta == 'Conta poupana')echo "SELECTED";?>>Conta poupança</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td align='left'><strong>Nome do Favorecido:</strong></td>
                <td align='left' colspan='2'><input type='text' name='favorecido_conta' id='favorecido_conta' class="input" value='<?=$favorecido_conta?>'  size="40" maxlength="50" <?if(strlen($callcenter)>0) echo " READONLY "?>>
                </td>
                <td align='left'><strong>CPF:</strong></td>
                <td align='left'><input type='text' name='cpf_conta' id='cpf_conta' class="input" value='<?=$cpf_conta?>'  size="15" maxlength="14" <?if(strlen($callcenter)>0) echo " READONLY "?>>
                </td>
            </tr>
            <tr>
                <td align='left'><strong>ObservaçÃµes:</strong></td>
                <td align='left' colspan='5'><TEXTAREA NAME="obs_ressarcimento" ROWS="6" COLS="110"  class="input" style='font-size:10px' <?if(strlen($callcenter)>0) echo " READONLY "?>><?echo $defeito;?></TEXTAREA></td>
            </tr>
            <tr>
                <td align='left'><strong>Procon? <input type="checkbox" name="procon" value='t' <?if (strlen($numero_processo) > 0) echo "CHECKED ";?> onClick='if (this.checked) {this.form.numero_processo.disabled = false;} else {this.form.numero_processo.disabled = true;}'></strong></td>
                <td align='left'><strong>número do Processo:</strong></td>
                <td align='left'><input type='text' name='numero_processo' id='numero_processo' class="input" value='<?=$numero_processo?>' <?if(strlen($callcenter)>0) echo " READONLY "?> size="40" maxlength="30">
                </td>
            </tr>
            </table>

            <br>
            Valores do Produto
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <tr>
                <td align='left'><strong>Valor do Produto:</strong></td>
                <td align='left'><input type='text' name='valor_produto' id='valor_produto' class="input" value='<?=$valor_produto?>'  size="20" maxlength="10" <?if(strlen($callcenter)>0) echo " READONLY "?>>
                </td>
                <td align='left'><!--<strong>Valor INPC.:</strong>--></td>
                <td align='left'><input type='hidden' name='valor_inpc' id='valor_inpc' class="input" value='<?=$valor_inpc?>' size="15" maxlength="10">
                </td>
                <td align='left'><strong>Valor Corrigido:</strong></td>
                <td align='left'><input type='text' name='valor_corrigido' id='valor_corrigido' readonly class="input" value='<?=$valor_corrigido?>' size="15" maxlength="10">
                </td>
            </tr>
            <tr>
                <td align='left'><strong>Data do Pagamento:</strong></td>
                <td align='left'><input type='text' name='data_pagamento' rel='data' id='data_pagamento' class="input" value='<?=$data_pagamento?>'  size="20" maxlength="10">
                </td>
            </tr>
            </table>
            <BR>

        </div>

        <!-- SEDEX REVERSO -->
        <div id="sedex_reverso" class='tab_content'>
        <!--
            <div rel='div_ajuda' style='display:inline; Position:relative;'>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
                <tr>
                    <td align='right' width='150'></td>
                    <td align='right' width='55'>
                        <img src='imagens/ajuda_call.png' align=absmiddle>
                    </td>
                    <td align='center'>
                        <STRONG>Informar dados Bancários.</STRONG><BR>
                        <?
                        $sql = "SELECT pergunta FROM tbl_callcenter_pergunta WHERE codigo='11' AND fabrica = $login_fabrica";
                        $pe = pg_query($con,$sql);
                        if(pg_num_rows($pe)>0) {
                            echo pg_fetch_result($pe,0,0);
                        }else{
                            echo "Quais são os dados da Revenda?";
                        }
                ?>
                    </td>
                    <td align='right' width='150'></td>
                </tr>
                </table>
            </div>
-->
            <?
            if (strlen($callcenter) > 0){
                $sql = "SELECT  banco            ,
                                agencia          ,
                                contay           ,
                                nomebanco        ,
                                favorecido_conta ,
                                cpf_conta        ,
                                tipo_conta
                        FROM tbl_hd_chamado_extra_banco
                        WHERE hd_chamado = $callcenter";
                $res = pg_query($con,$sql);

                if(pg_num_rows($res)>0){
                    $banco            = pg_fetch_result($res,0,banco);
                    $agencia          = pg_fetch_result($res,0,agencia);
                    $contay           = pg_fetch_result($res,0,contay);
                    $nomebanco        = pg_fetch_result($res,0,nomebanco);
                    $favorecido_conta = pg_fetch_result($res,0,favorecido_conta);
                    $cpf_conta        = pg_fetch_result($res,0,cpf_conta);
                    $tipo_conta       = pg_fetch_result($res,0,tipo_conta);
                }
            }
            ?>
            Informações do Produto
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <tr>
                <td align='left'><strong>Referência:</strong></td>
                <td align='left'>
                    <input name="troca_produto_referencia"  class="input"  value='<?echo $produto_referencia ;?>'
                    onblur="javascript: fnc_pesquisa_produto (document.frm_callcenter.troca_produto_referencia,document.frm_callcenter.troca_produto_nome,'referencia');mostraDefeitos('Reclamado',document.frm_callcenter.troca_produto_referencia.value)" type="text" size="15" maxlength="15" <?if(strlen($callcenter)>0) echo " READONLY "?>>
                    <img src='imagens/lupa.png' border='0' align='absmiddle'
                    style='cursor: pointer'
                    onclick="javascript: fnc_pesquisa_produto (document.frm_callcenter.troca_produto_referencia,document.frm_callcenter.troca_produto_nome,'descricao')">
                </td>
                <td align='left'><strong>Descrição:</strong></td>
                <td align='left'>
                    <input type='hidden' name='produto' value="<? echo $produto; ?>">
                    <input name="troca_produto_nome"  class="input" value='<?echo $produto_nome ;?>'
                    onblur="javascript: fnc_pesquisa_produto (document.frm_callcenter.troca_produto_referencia,document.frm_callcenter.troca_produto_nome,'descricao');mostraDefeitos('Reclamado',document.frm_callcenter.troca_produto_referencia.value)" type="text" size="35" maxlength="500" <?if(strlen($callcenter)>0) echo " READONLY "?>>
                    <img src='imagens/lupa.png' border='0' align='absmiddle'
                    style='cursor: pointer'
                    onclick="javascript: fnc_pesquisa_produto (document.frm_callcenter.troca_produto_referencia,document.frm_callcenter.troca_produto_nome,'descricao')">
                </td>
            </tr>
            <tr>
                <td align='left' valign='top'><strong>ObservaçÃµes:</strong></td>
                <td align='left' colspan='5'>
                    <TEXTAREA NAME="troca_observacao" ROWS="6" COLS="110"  class="input" style='font-size:10px' <?if(strlen($callcenter)>0) echo " READONLY "?>><?echo $reclamado ;?></TEXTAREA>
                </td>
            </tr>
            </table>
            Informações de Envio
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <tr>
                <td align='left'><strong>Data do Retorno do Produto (Cliente):</strong></td>
                <td align='left'><input type='text' name='data_retorno_produto' id='data_retorno_produto' class="input" value='<?=$data_retorno_produto?>' size="12" maxlength="12" rel='data' <?if(strlen($callcenter)>0) echo " READONLY "?>>
                </td>
                <td align='left'><strong>Código de Postagem:</strong></td>
                <td align='left'><input type='text' name='numero_objeto' id='numero_objeto' class="input" value='<?=$numero_objeto?>'  size="25" maxlength="20" <?if(strlen($callcenter)>0) echo " READONLY "?>>
                </td>
            </tr>
            <tr>
                <td align='left' colspan='4'><strong>Procon? <input type="checkbox" name="procon2" value='t' <?if (strlen($numero_processo)>0) echo "CHECKED ";?> <?if(strlen($callcenter)>0) echo " READONLY "?> onClick='if (this.checked) {this.form.numero_processo2.disabled = false;} else {this.form.numero_processo2.disabled = true;}'></strong>
                &nbsp;&nbsp;&nbsp;
                <strong>número do Processo:</strong>
                &nbsp;&nbsp;&nbsp;&nbsp;
                <input type='text' name='numero_processo2' id='numero_processo2' class="input" value='<?=$numero_processo?>'  size="25" maxlength="30" <?if(strlen($callcenter)>0) echo " READONLY "?>>
                </td>
            </tr>
            </table>
            <BR>
        </div>
        <? } ?>
        <?if(in_array($login_fabrica,array(11,46,151,172))){?>
        <div id="troca_produto" class='tab_content'>
            <p style='font-size: 14px'><b>Troca de Produto</b></p>
            Informações do Produto
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <tr>
                <td align='left'><strong>Referência:</strong></td>
                <td align='left'>
                    <input name="troca_produto_referencia"  class="input"  value='<?echo $produto_referencia ;?>'
                    onblur="javascript: fnc_pesquisa_produto (document.frm_callcenter.troca_produto_referencia,document.frm_callcenter.troca_produto_nome,'referencia');mostraDefeitos('Reclamado',document.frm_callcenter.troca_produto_referencia.value)" type="text" size="15" maxlength="15">
                    <img src='imagens/lupa.png' border='0' align='absmiddle'
                    style='cursor: pointer'
                    onclick="javascript: fnc_pesquisa_produto (document.frm_callcenter.troca_produto_referencia,document.frm_callcenter.troca_produto_nome,'descricao')">
                </td>
                <td align='left'><strong>Descrição:</strong></td>
                <td align='left'>
                    <input type='hidden' name='produto' value="<? echo $produto; ?>">
                    <input name="troca_produto_nome"  class="input" value='<?echo $produto_nome ;?>'
                    onblur="javascript: fnc_pesquisa_produto (document.frm_callcenter.troca_produto_referencia,document.frm_callcenter.troca_produto_nome,'descricao');mostraDefeitos('Reclamado',document.frm_callcenter.troca_produto_referencia.value)" type="text" size="35" maxlength="500">
                    <img src='imagens/lupa.png' border='0' align='absmiddle'
                    style='cursor: pointer'
                    onclick="javascript: fnc_pesquisa_produto (document.frm_callcenter.troca_produto_referencia,document.frm_callcenter.troca_produto_nome,'descricao')">
                </td>
                <td align='left'><strong>Série:</strong></td>
                <td align='left'>
                    <input name="troca_serie" maxlength="20" class="input"  value='<?echo $serie ;?>'>
                </td>
            </tr>

            <tr>
                <td align='left' valign='top'><strong>Descrição:</strong></td>
                <td align='left' colspan='5'>
                    <TEXTAREA NAME="troca_produto_descricao" ROWS="6" COLS="110"  class="input" style='font-size:10px'><?echo $reclamado ;?></TEXTAREA>
                </td>
            </tr>
            </table>
        </div>
        <? } ?>

    <?if($login_fabrica==24){?>
        <div id="outros_assuntos" class='tab_content'>
            <p style='font-size: 14px'><b>Outros Assuntos</b></p>
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <tr>
                <td align='left' valign='top'><strong>Descrição:</strong></td>
                <td align='left' colspan='5'>
                    <TEXTAREA NAME="outros_assuntos_descricao" ROWS="6" COLS="110"  class="input" style='font-size:10px'><?echo $reclamado ;?></TEXTAREA>
                </td>
            </tr>
            <?php if ($login_fabrica == 24) { ?>
            <tr>
                <td>Assunto:</td>

                <td>
                    <select name="callcenter_assunto[outros_assuntos]" id="callcenter_assunto" class="input_req">
                        <option value=''>>>> Escolha <<<</option><?php

                        foreach ($assuntos["OUTROS ASSUNTOS"] AS $label => $valor) {

                            if ($valor == $callcenter_assunto) {
                                $selected = "selected";
                            } else {
                                $selected = "";
                            }

                            echo " <option value='$valor' $selected>Outros Assuntos >> $label</option>";
                        } ?>
                    </select>
                </td>
            </tr>
            <?php
            } ?>
            </table>
        </div>
        <? } ?>

            <?php if($login_fabrica == 94){ ?>
            <div id="indicacao_rev" class='tab_content'>
                <div rel='div_ajuda' style='display:inline; Position:relative;'>
                    <table  width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;;'>
                        <tr>
                            <td align='right' valign='top' width="100"><strong>CNPJ:</strong></td>
                            <td align='left'width="200">
                                <input type='hidden' name='revenda_ind' id='revenda_ind' value='<?=$revenda?>'>
                                <input type='text' name='revenda_ind_cnpj' id='revenda_ind_cnpj' value='<?=$revenda_cnpj?>' class="input">
                                <img src="imagens/lupa.png" border="0" align="absmiddle" style="cursor: pointer" onclick="javascript: pesquisaRevenda (document.frm_callcenter.revenda_ind_cnpj,'cnpj');">
                            </td>
                            <td align='right' valign='top' width="100"><strong>Nome:</strong></td>
                            <td align='left'><input type='text' name='revenda_ind_nome' id='revenda_ind_nome' value='<?=$revenda_nome?>' maxlength='50' size="50" class="input">
                            <img src="imagens/lupa.png" border="0" align="absmiddle" style="cursor: pointer" onclick="javascript: pesquisaRevenda (document.frm_callcenter.revenda_ind_nome,'nome');">
                            </td>
                        </tr>

                        <tr>
                            <td colspan="4">
                                <strong>Descrição:</strong>
                                <TEXTAREA NAME="ind_revenda_desc" ROWS="6" COLS="110"  class="input" style='font-size:10px'> <? echo $reclamado; ?></textarea>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <div id="indicacao_at" class='tab_content'>
                <div rel='div_ajuda' style='display:inline; Position:relative;'>
                    <table  width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;;'>
                        <tr>
                            <td align='right' width="100"><strong>Código:</strong></td>
                            <td align='left' width="150">
                                <input name="codigo_posto_ind"  class="input"  value='<?echo $codigo_posto ;?>'
                                 type="text" size="15" maxlength="15">
                                <img src='imagens/lupa.png' border='0' align='absmiddle'
                                style='cursor: pointer'
                                onclick="javascript: pesquisaPosto (document.frm_callcenter.codigo_posto_ind,'codigo');">
                            </td>
                            <td align='right' width="100"><strong>Nome:</strong></td>
                            <td align='left'>
                                <input name="posto_nome_ind"  class="input" value='<?echo $posto_nome ;?>'
                                 type="text" size="35" maxlength="500">
                                <img src='imagens/lupa.png' border='0' align='absmiddle'
                                style='cursor: pointer'
                                onclick="javascript: pesquisaPosto (document.frm_callcenter.posto_nome_ind,'nome');">
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4">
                                <strong>Descrição:</strong>
                                <TEXTAREA NAME="ind_posto_desc" ROWS="6" COLS="110"  class="input" style='font-size:10px' ><? echo $reclamado; ?></textarea>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        <?php } ?>

        <?php if($login_fabrica == 74) { ?>
            <div id="informacoes" class='tab_content'>
                    <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                    <tr>
                        <td align='left' valign='top' width='80'><strong>Informações:</strong></td>
                        <td align='left' colspan='5'>
                            <?php
                            if ($login_fabrica == 74 && !empty($callcenter) && $admin != 6437) {
                                $bloqueia_reclamado_produto = "readonly";

                                echo $reclamado;
                                echo "<input type='hidden' name='informacoes_cliente' value='$reclamado' />";
                            }else{
                                if ($login_fabrica == 74 && !empty($callcenter) && isset($_POST["informacoes_cliente"])) {
                                    $reclamado = $_POST["informacoes_cliente"];
                                }

                                ?>
                                <TEXTAREA NAME="informacoes_cliente" ROWS="6" COLS="110"  class="input" style='font-size:10px'><?echo $reclamado ;?></TEXTAREA>
                            <? } ?>

                        </td>
                    </tr>
                    </table>
            </div>
            <div id="garantia_adicional" class='tab_content'>
                    <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                        <tr>
                            <td align='left' colspan='4'>
                                <strong>
                                    Garantia Adicional:
                                    <input type="checkbox" value="t" name="garantia_adicional_check" checked disabled></input>
                                </strong>
                            </td>
                        </tr>
                    </table>
            </div>
        <? }
        if ($login_fabrica == 85) { ?>
        <div id="garantia_estendida" class='tab_content'>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                    <tr>
                        <td align='left' colspan='4'>
                            <strong>
                                Garantia Estendida:
                                <input type="checkbox" value="t" name="garantia_estendida_check" <?php if($categoria  == "garantia_estendida" OR $garantia_estendida_check == 't') echo " checked "?> ></input>
                            </strong>
                        </td>
                    </tr>
                    <tr>
                        <td align='left' valign='top' width='80'><strong>Descrição:</strong></td>
                        <td align='left' colspan='5'>
                            <TEXTAREA NAME="reclamado_garantia_estendida" ROWS="6" COLS="110"  class="input" style='font-size:10px' <? echo $read; ?>>
                            <?php echo $reclamado_garantia_estendida ?>
                            </TEXTAREA>
                        </td>
                    </tr>
                </table>
        </div>
        <? }
        if ($login_fabrica == 165) { ?>
        <div id="indicacao_instalador" class='tab_content'>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
                    <tr>
                        <td align='left' colspan='4'>
                            <strong>
                                Instalador:
                                <select id="indicacao_instalador_tecnico" name="indicacao_instalador_tecnico">
                                    <? if (strlen($indicacao_instalador_tecnico) > 0) {
                                        $whereInstalador = "AND tecnico = {$indicacao_instalador_tecnico}";
                                    }

                                    $sqlInstalador = "
                                        SELECT
                                            *
                                        FROM tbl_tecnico
                                        WHERE fabrica = {$login_fabrica}
                                        AND tipo_tecnico = 'TF'
                                        AND ativo IS TRUE
                                        {$whereInstalador};
                                    ";

                                    $resInstalador = pg_query($con, $sqlInstalador);
                                    $count = pg_num_rows($resInstalador);

                                    for ($i = 0; $i < $count; $i++) {
                                        $tecnicoInstalador = pg_fetch_result($resInstalador, $i, tecnico);
                                        $nomeInstalador = pg_fetch_result($resInstalador, $i, nome);
                                        $telefoneInstalador = pg_fetch_result($resInstalador, $i, telefone);

                                        $textInst = $nomeInstalador.((!empty($telefoneInstalador)) ? " - Fone: ".$telefoneInstalador : ""); ?>
                                        <option value="<?= $tecnicoInstalador; ?>"><?= $textInst; ?></option>
                                    <? } ?>
                                </select>
                            </strong>
                        </td>
                    </tr>
                    <tr>
                        <td align='left' valign='top' width='80'><strong>Comentário:</strong></td>
                        <td align='left' colspan='5'>
                            <textarea name="indicacao_instalador_comentario" rows="6" cols="110" class="input" style='font-size:10px' <?= $read; ?>>
                                <?= $indicacao_instalador_comentario; ?>
                            </textarea>
                        </td>
                    </tr>
                </table>
        </div>

        <? } ?>
    </div>
    </td>
</tr>

<? if(strlen($callcenter)>0 && ($login_fabrica == 24 OR $login_fabrica == 52 OR $login_fabrica == 115)) { //hd_chamado=2710901 ADICIONADA FABRICA 115
        // HD 277105
        $sql = 'SELECT hd_chamado_anterior
                FROM tbl_hd_chamado
                WHERE hd_chamado = ' . $callcenter . '
                AND fabrica = '.$login_fabrica . '
                LIMIT 1';
        $res = pg_query($sql);

        if(pg_numrows($res) > 0)
            $hd_pesquisa_ini = pg_result ($res,0,hd_chamado_anterior);

        if(strlen($hd_pesquisa_ini) == 0) { // verifica se ele pode ser o chamado raiz

            $sql = 'SELECT hd_chamado
                FROM tbl_hd_chamado
                WHERE hd_chamado_anterior = ' . $callcenter . '
                AND fabrica = '.$login_fabrica . '
                LIMIT 1';
            $res = pg_query($sql);

            if(pg_numrows($res) > 0)
                $hd_pesquisa_ini = pg_result ($res,0,hd_chamado);

        }

        if(strlen($hd_pesquisa_ini) > 0 AND $login_fabrica != 24) { //se tiver chamados anteriores

            function busca_chamados_filhos($hd_pai) { //busca os chamados vindo do passado

                global $con;
                $sql = "SELECT hd_chamado FROM tbl_hd_chamado WHERE hd_chamado_anterior=$hd_pai";
                //echo $sql;
                $res = pg_query($con, $sql);

                $hd_filhos  = array();

                for($i=0; $i<pg_num_rows($res); $i++) {
                    $hd_atual = pg_result($res,$i,hd_chamado);
                    $hd_filhos[$hd_atual] = busca_chamados_filhos($hd_atual);
                }

                return($hd_filhos);

            }

            function onlyOne($arr) { //deixa o array unidimensional
                $rpltext = print_r($arr,true);
                $chars = array("Array","(",")","[","]"," ","\n");
                $repls = array("","","","=>","","","");
                $text = str_replace($chars,$repls,$rpltext);
                $expl = explode('=>',$text);

                foreach ($expl AS $result) {
                    if (!empty($result)) $arrOrg[] = $result;
                }

                $count = count($arrOrg);
                $retorno = array();

                for ($i=0; $i<$count; $i++) {
                    if ($i%2==0) $retorno[$arrOrg[$i]] = $arrOrg[($i+1)];
                }

                return $retorno;

            }
            /**********     busca o primeiro chamado a partir do chamado aberto      **********/
            $controle = false;  //variavel que finaliza o loop
            $ultimo_reg = 0;    //pega o ultimo registro, sem chamado anterior
            $i = 0;             //contadora p/ zebrado e ajax/jQuery

            while($controle == false) {

                if(isset($hd_pesquisa_ini)) //inicia pesquisando o hd anterior do visualizado na tela
                    $hd_pesquisa = $hd_pesquisa_ini;

                $i++;
                $sql = 'SELECT
                        hd_chamado_anterior, hd_chamado
                        FROM tbl_hd_chamado
                        WHERE hd_chamado = ' . $hd_pesquisa . '
                        AND fabrica = '.$login_fabrica . '
                        LIMIT 1';
                $res = pg_query($sql);

                if(pg_numrows($res) > 0) {
                    $hd_pesquisa    = pg_result ($res,0,hd_chamado_anterior);
                    $hd_chamado_cp  = pg_result ($res,0,hd_chamado);

                    if(strlen($hd_pesquisa) == 0 && $ultimo_reg == 0 ) {
                        $hd_pesquisa = $hd_chamado_cp; // $hd_pesquisa = chamado raiz
                        $ultimo_reg++;
                    }
                    if ($ultimo_reg == 1)
                        $controle = true;
                }

                if($i == 1)
                    unset($hd_pesquisa_ini); //usa essa variavel só na primeira iteração do loop
            }
            /*******      fim da busca      @return $hd_pesquisa       *****/
            $vet = array();

            $vet = busca_chamados_filhos($hd_pesquisa); // pega todos os chamados vindo desse

            $res_chamados = onlyOne($vet); //tira o vetor multidimensional em um só

            $new_res_chamados = array();

            foreach ($res_chamados as $key => $value){ //tira as chaves pra ficar total unidimensional
                if(!in_array($key, $new_res_chamados))
                    $new_res_chamados[] = $key;
                if(!in_array($value, $new_res_chamados))
                    $new_res_chamados[] = $value;
            }

            $new_res_chamados[] = $hd_pesquisa; //adiciona no vetor chamado raiz

            asort($new_res_chamados);
            /*
            echo '<pre>';
            print_r($new_res_chamados);
            echo '</pre>';
            */
            echo "
                    <table width='100%' border='0' align='center' cellpadding=\"1\" cellspacing=\"1\" style=' border:#5AA962 1px solid; background-color:#E6E6FA;font-size:10px'>
                            <tr><th colspan='4' style='border-bottom:1px solid #ccc'>Chamados Anteriores</th></tr>
                            <tr align='left'>
                                <th>nº do Chamado/Protocolo</th>
                                <th>Data</th>
                                <th>Status</th>
                                <th>AçÃµes</th>
                            </tr>
                ";
            // percorre o vetor e exibe os protocolos anteriores (finalmente :) )
            if(!empty($new_res_chamados))
            foreach ($new_res_chamados as $hd_pesquisa){
                if($hd_pesquisa == $callcenter || is_null($hd_pesquisa))
                    continue;
                $i++;
                $sql = 'SELECT
                        TO_CHAR(data,\'DD/MM/YYY\') as data, status, hd_chamado
                        FROM tbl_hd_chamado
                        WHERE hd_chamado = ' . $hd_pesquisa . '
                        AND fabrica = '.$login_fabrica . '
                        LIMIT 1';

                $res = pg_query($sql);

                if(pg_numrows($res) > 0) {

                    $cor = ($i % 2) ? "#F7F5F0" : "#F1F4FA";

                    $hd_chamado_cp  = pg_result ($res,0,hd_chamado);
                    $data           = pg_result ($res,0,data);
                    $status         = pg_result ($res,0,status);

                    // entra no if se tiver hd e for até o ultimo registro
                    if (strlen($hd_pesquisa)) {
                        echo '<tr id="dados'.$i.'" style="cursor:pointer;" bgcolor="'.$cor.'" onclick="exibe_interacao_anterior('.$hd_chamado_cp.','.$i.')">
                            <td>'.$hd_chamado_cp.'</td>
                            <td>'.$data.'</td>
                            <td>'.$status.'</td>
                            <td><a href="#dados'.$hd_chamado_cp.'">Exibir <img src="imagens/mais.bmp" style="cursor:pointer" id="seta'.$i.'"></a></td>
                        </tr>';
                    }
                }
            }
            echo '</table><br />
                ';

        } ?>

        <script type="text/javascript">

            function exibe_interacao_anterior(id, linha) {

                if ($("#seta"+linha).attr( "src" )=="imagens/menos.bmp"){
                    $(".resp"+linha).fadeOut("slow");
                    $("#seta"+linha).attr("src", "imagens/mais.bmp");
                } else {

                    $("#seta"+linha).attr("src", "imagens/menos.bmp");

                    url = '<?php echo $_SERVER[PHP_SELF]; ?>?ajax=sim&hdanterior='+id+'&resp='+linha;

                    $.get(url, function(dados) {
                        $("#dados" + linha).after(dados);
                    });

                }

            }

        </script><?php

}

    if($login_fabrica == 115){ //hd_chamado=2710901
        $xhd_chamado_anterior_n = $_GET['Id'];
?>
        <input type="hidden" name="hd_chamado_anterior_n" value="<?=$xhd_chamado_anterior_n?>">
<?php
    }

    if (strlen($callcenter) > 0) {
        if (in_array($login_fabrica, [138]) AND !empty($os)) {
            $qVerifyPesquisaPendente = "
                SELECT
                    tbl_resposta.resposta
                FROM tbl_resposta
                JOIN tbl_os ON tbl_os.os = tbl_resposta.os AND tbl_os.fabrica = {$login_fabrica}
                WHERE tbl_resposta.sem_resposta IS TRUE
                AND tbl_os.fabrica = {$login_fabrica}
                AND tbl_resposta.os = {$os}
            ";
            $rVerifyPesquisaPendente = pg_query($con, $qVerifyPesquisaPendente);

            if (pg_num_rows($rVerifyPesquisaPendente) > 0) {
    ?>
                <style>
                    #pesquisa-satisfacao:hover {
                        cursor: pointer;
                    }
                </style>
                    <table style="width:100%;background-color:#cbe3ed;padding:15px 0;margin-top:5px;border:1px solid #61a6ce;text-align:center">
                        <tr>
                            <td style="width:40%"></td>
                            <td style="height:40px;background-color:#0176c4;border-radius:3px;box-shadow:0 0 10px #888" id="pesquisa-satisfacao">
                                <span style="font-size:14px;color:#FFF;font-weight:bold">Responder Pesquisa de Satisfação</span>
                            </td>
                            <td style="width:40%"></td>
                        </tr>
                    </table>
                    <?php $pesquisaToken = sha1($login_fabrica . $os); ?>
                    <script type="text/javascript">
                        $(function () {
                            Shadowbox.init();
                            $("#pesquisa-satisfacao").on("click", function () {
                                let os = '<?= $os ?>';
                                let token = '<?= $pesquisaToken ?>';
                                Shadowbox.open({
                                    content: '../externos/pesquisa_satisfacao_os.php?token=' + token + '&os=' + os,
                                    player: 'iframe',
                                    height: 800
                                });
                            });
                        });
                    </script>
        <?php
                }
            }
        ?>
        <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px;margin-top: 10px;'>
            <tr>
                <td align='right' width='150'></td>
                <td align='right' width='55'><img src='imagens/ajuda_call.png' align=absmiddle></td>
                <td align='center'>
                    <STRONG>Por favor, queira anotar o nº do protocolo de atendimento</STRONG><BR>
                    número <font color='#D1130E'><?echo $callcenter;?></font>
                </td>
                <td align='right' width='150'></td>
            </tr>
        </table>
        <br />
    <?php
    }
    ?>

    <?php if (in_array($login_fabrica, [166,174,186]) AND !empty($callcenter)) { ?>
    <table>
    <?php
        $queryFrases = "SELECT
                            frase_callcenter,
                            titulo,
                            frase
                        FROM tbl_frase_callcenter
                        WHERE fabrica = {$login_fabrica}
                        ORDER BY titulo";
        $result = pg_query($con, $queryFrases);
        $resultFrases = pg_fetch_all($result);

        $arrayCount = 0;
        $arrayColors = ["#2b8dce", "#e52935", "#16af4f", "#6316af", "#1abcbf", "#2D2D2D", "#14e0a9", "#e0a914"];

        $textData = [];
    ?>
        <tr>
            <?php foreach ($resultFrases as $frase) {
                $frase['frase'] = textoProvidencia_new($frase['frase'], $callcenter, $consumidor_nome);
                $textData[] = [
                    'frase_callcenter' => $frase['frase_callcenter'],
                    'titulo' => iconv('ISO-8859-1', 'UTF-8', $frase['titulo']),
                    'frase' => preg_replace("/<[a-z]+>|<\/[a-z]+>|<[a-z]+\s\/>/i", "", iconv('ISO-8859-1', 'UTF-8', $frase['frase']) . "\n")
                ];
                if ($arrayCount > count($arrayColors) - 1) {
                    $arrayCount = 0;
                }
            ?>
                <td style="cursor:pointer;margin:0 2px 2px 0;display:inline-block;">
                    <div
                        class="ready_msg"
                        style="
                            font-size:14px;
                            padding:5px 10px;
                            background-color:<?= $arrayColors[$arrayCount] ?>;
                            color:#FFF;
                            text-align:center;
                            border-radius:2px;
                            font-weight:bold;"
                        title="<?= preg_replace("/<[a-z]+>|<\/[a-z]+>|<[a-z]+\s\/>/i", "", $frase['frase'] . "\n") ?>"
                        data-id="<?= $frase['frase_callcenter'] ?>"
                    >
                        @<?= $frase['titulo'] ?>
                    </div>
                </td>
            <?php
                $arrayCount++;
            } ?>
        </tr>
    </table>
    <?php
    $textData = json_encode($textData);
    ?>
    <script type="text/javascript">
        var matchFloat = false;
        var textData = <?= $textData ?>;
        var activeItem = null;
        $(window).on("load", function () {
            $(".ready_msg").on("click", function () {
                CKEDITOR.instances['resposta'].insertText($(this).attr("title"));
            });

            CKEDITOR.instances['resposta'].on('key', function (e) {
                if (e.data.keyCode == 2228274) {
                    $("html").append(
                        $("<div></div>", {
                            id: "div-float",
                            css: {
                                height: "130px",
                                width: "250px",
                                "background-color": "#F1F1F1",
                                "position": "absolute",
                                "box-shadow": "0px 0px 10px #CCC",
                                "overflow-y": "scroll"
                            }
                        })
                    );

                    $("#div-float").append(
                        $("<ul></ul>", {
                            id: "ul-float",
                            css: {
                                width: "100%",
                                "list-style-type":"none",
                                "font-size":"12px",
                                "font-family":"sans-serif"
                            }
                        })
                    );

                    matchFloat = true;
                }

                if (matchFloat == true) {
                    $("#ul-float").find("li").remove();
                    var matchText = CKEDITOR.instances['resposta'].getData().split("@")[1];
                    var reg = new RegExp($("<input></input>").html(matchText).text(), 'gi');
                    $(textData).each(function (index, element) {
                        if (decodeURIComponent(element.titulo).match(reg)) {
                            var li = $("<li></li>");
                            $(li).attr("data-frase", element.frase_callcenter);
                            $(li).attr("title", element.frase);
                            $(li).css({
                                "padding": "5px",
                                "background-color":"#F1F1F1",
                                "cursor": "pointer",
                                "font-weight": "bold"
                            });
                            $(li).hover(function () {
                                $(this).css("background-color", "#CCC");
                            }, function () {
                                $(this).css("background-color", "#F1F1F1");
                            });
                            $(li).text(element.titulo);
                            $(li).addClass("item-menu");
                            $(li).on("click", function () {
                                matchFloat = false;
                                var text = CKEDITOR.instances['resposta'].getData();
                                var newText = text.replace("@"+matchText, element.frase);
                                CKEDITOR.instances['resposta'].setData(newText);
                                $($(e.editor.container.$).find("iframe")[0].contentDocument).find(".div-float").remove();
                                $("#div-float").remove();
                                activeItem = null;
                            });

                            $("#ul-float").append(li);
                        }
                    });

                    if (e.data.keyCode != 40 && e.data.keyCode != 38) {
                        var s = e.editor.getSelection();

                        $(s._.cache.nativeSel.anchorNode).after(
                            $("<div></div>", {
                                class: "div-float",
                                css: {
                                    height: "1px",
                                    width: "1px",
                                    position: "absolute"
                                }
                            })
                        );

                        var p = $("<p></p>", {
                            text: $(s._.cache.nativeSel.anchorNode).text(),
                            css: {
                                display: "inline-block",
                                visibility: "hidden",
                                width: "auto"
                            }
                        });

                        $(s._.cache.nativeSel.anchorNode).after(p);
                        var left = parseInt($(p).css("width").replace("px", ""));
                        $(p).remove();

                        var div = $($(e.editor.container.$).find("iframe")[0].contentDocument).find(".div-float");
                        var top = div[0].offsetTop;
                        $(div).remove();

                        if (top > $(e.editor.container.$).find(".cke_contents")[0].offsetHeight) {
                            top = $(e.editor.container.$).find(".cke_contents")[0].offsetHeight;
                        }

                        var wtop = $(e.editor.container.$).find(".cke_contents").offset().top;
                        var wleft = $(e.editor.container.$).find(".cke_contents").offset().left;

                        $("#div-float").css({
                            top: (top + wtop) + "px",
                            left: (left + wleft) + "px"
                        });
                    }

                    var ul = $("#div-float").find("#ul-float");

                    if (e.data.keyCode == 40) {
                        if (activeItem == null) {
                            activeItem = $(ul).find("li").first();
                            $(activeItem).css({
                                "background-color": "#CCC"
                            });
                        } else {
                            fraseCallcenter = $(activeItem).data("frase");
                            activeItem = $("#ul-float").find("li[data-frase=" + fraseCallcenter + "]").next();
                            if (activeItem.length == 0) {
                                activeItem = $(ul).find("li").first();
                            }
                            $(activeItem).css({
                                "background-color": "#CCC"
                            });

                            let divFloat = document.querySelector("#div-float");
                            divFloat.scrollTop = $(activeItem)[0].offsetTop;
                        }
                    } else if (e.data.keyCode == 38) {
                        if (activeItem != null) {
                            fraseCallcenter = $(activeItem).data("frase");
                            activeItem = $("#ul-float").find("li[data-frase=" + fraseCallcenter + "]").prev();
                            if (activeItem.length == 0) {
                                activeItem = $(ul).find("li").last();
                            }
                            $(activeItem).css({
                                "background-color": "#CCC"
                            });

                            let divFloat = document.querySelector("#div-float");
                            divFloat.scrollTop = $(activeItem)[0].offsetTop;
                        }
                    } else if (e.data.keyCode == 9) {
                        $(textData).each(function (index, element) {
                            var reg = new RegExp(matchText, "gi");
                            if (unescape(encodeURIComponent(element.titulo)).match(reg)) {
                                var text = CKEDITOR.instances['resposta'].getData();
                                var newText = text.replace("@"+matchText, element.frase);
                                CKEDITOR.instances['resposta'].setData(newText);
                            }
                            matchFloat = false;
                            $($(e.editor.container.$).find("iframe")[0].contentDocument).find(".div-float").remove();
                            $("#div-float").remove();
                            activeItem = null;
                        });
                    } else if (e.data.keyCode == 13) {
                        if (activeItem != null) {
                            var text = CKEDITOR.instances['resposta'].getData();
                            var newText = text.replace("@"+matchText, $(activeItem).attr("title"));
                            CKEDITOR.instances['resposta'].setData(newText);
                        }
                        matchFloat = false;
                        $($(e.editor.container.$).find("iframe")[0].contentDocument).find(".div-float").remove();
                        $("#div-float").remove();
                        activeItem = null;
                    } else if (e.data.keyCode == 8 && CKEDITOR.instances['resposta'].getData().length == 0) {
                        $($(e.editor.container.$).find("iframe")[0].contentDocument).find(".div-float").remove();
                        $("#div-float").remove();
                        activeItem = null;
                    }
                }

                if (e.data.keyCode == 27) {
                    matchFloat = false;
                    $($(e.editor.container.$).find("iframe")[0].contentDocument).find(".div-float").remove();
                    $("#div-float").remove();
                    activeItem = null;
                }
            });
        });
    </script>
    <?php } ?>

    <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#5AA962 1px solid; background-color:#D1E7D3;font-size:10px;padding:10px;'>

    <!-- HD-1667397 MONTEIRO -->
        <? if(strlen($callcenter)>0){
            if(in_array($login_fabrica, array(90,169,170))){
                if($status_interacao == "Resolvido"){
                    $display_resolvido = "style='display:none;'";
                    $disabled_situacao = "disabled";
                }
            }
        ?>
             <tr>
                <td colspan='11'></td>
             </tr>
             <tr <?=$display_resolvido?>>
                 <td align='left' valign='top'> <strong>Resposta:</strong></td>
             </tr>
             <?php if (in_array($login_fabrica, array(90,169,170))) { ?>
             <button type="button" class="btn" onclick="javascript: seleciona_frase_pronta()">Frases prontas</button>
             <?php } ?>
             </td>
             <td colspan='6' align='left'><TEXTAREA NAME="resposta" ROWS="6" COLS="110"  class="input" style='font-size:10px'><?echo $resposta ;?></TEXTAREA></td>
             <td colspan='5'>
<?php
        if (in_array($login_fabrica,array(35,151,178,183))) {
            if ($login_fabrica == 178){
                $sqlHD = "
                    SELECT
                        tbl_os_campo_extra.os
                    FROM tbl_hd_chamado_extra
                    JOIN tbl_hd_chamado ON tbl_hd_chamado_extra.hd_chamado = tbl_hd_chamado.hd_chamado
                    JOIN tbl_os_revenda ON tbl_os_revenda.hd_chamado = tbl_hd_chamado.hd_chamado AND tbl_os_revenda.fabrica = $login_fabrica
                    JOIN tbl_os_campo_extra ON tbl_os_campo_extra.os_revenda = tbl_os_revenda.os_revenda AND tbl_os_campo_extra.fabrica = $login_fabrica
                    WHERE tbl_hd_chamado_extra.hd_chamado = $callcenter";
                $resHD = pg_query($con, $sqlHD);
            }else{
                $sqlHD = "SELECT DISTINCT tbl_hd_chamado_item.os
                        FROM tbl_hd_chamado_item
                        JOIN tbl_hd_chamado ON tbl_hd_chamado_item.hd_chamado = tbl_hd_chamado.hd_chamado
                        JOIN tbl_os ON tbl_hd_chamado_item.os = tbl_os.os
                        WHERE tbl_hd_chamado_item.hd_chamado = $callcenter";
                $resHD = pg_query($con, $sqlHD);

                if (pg_num_rows($resHD) == 0 || $login_fabrica == 35) {
                    $sqlHD = "SELECT
                            tbl_hd_chamado_extra.os
                        FROM tbl_hd_chamado_extra
                        JOIN tbl_hd_chamado ON tbl_hd_chamado_extra.hd_chamado = tbl_hd_chamado.hd_chamado
                        JOIN tbl_os ON tbl_hd_chamado_extra.os = tbl_os.os
                        WHERE tbl_hd_chamado_extra.hd_chamado = $callcenter";
                    $resHD = pg_query($con, $sqlHD);
                }
            }

            if (pg_num_rows($resHD) > 0) {
                $solicitar_pecas = '';
                if ($login_fabrica == 35) {
                    $solicitar_pecas = '<td>Solicitar Peças</td>';
                }
                if ($login_fabrica == 183){
                    $td_padding = "style='padding: 10px;'";
                }
                echo "
                    <table>
                        <tr class='titulo_coluna'>
                            <td $td_padding>OS</td>
                            <td $td_padding>Status</td>
                        ";
                    if (!in_array($login_fabrica, array(178,183))){
                        echo "<td nowrap > Código de Rastreio</td>";

                        if ($login_fabrica == 151) {
                            echo "<td nowrap > Conhecimento</td>";
                        }

                        echo "<td nowrap > Data de SaÃ­da</td>
                            <td>SPD</td>";

                    }
                echo "
                            <td $td_padding>Trocar Produto</td>
                            $solicitar_pecas
                        </tr>
                ";
                $WhereCancelamento = "";
                if (in_array($login_fabrica, array(151))) {
                    $WhereCancelamento = " AND tbl_faturamento.cancelada IS NULL";
                }
                for ($i=0; $i < pg_num_rows($resHD); $i++) {
                    $os = pg_result($resHD, $i, 'os');

                    $sql = "SELECT tbl_os.sua_os, tbl_status_checkpoint.descricao
                    FROM tbl_os
                    JOIN tbl_status_checkpoint ON tbl_os.status_checkpoint = tbl_status_checkpoint.status_checkpoint
                    WHERE tbl_os.os = $os ";
                    $res = pg_query($con, $sql);

                    $abre_os_sua_os = pg_result($res, 0, 'sua_os');
                    $abre_os_status = pg_result($res, 0, 'descricao');

                    $sqlCodigoRastreio = "
                        SELECT DISTINCT tbl_faturamento.conhecimento,
                        TO_CHAR(tbl_faturamento.saida, 'DD/MM/YYYY') AS saida,
                        tbl_os_extra.extrato
                        FROM tbl_os
                        INNER JOIN tbl_posto_fabrica ON tbl_posto_fabrica.posto = tbl_os.posto AND tbl_posto_fabrica.fabrica = {$login_fabrica}
                        INNER JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto AND tbl_tipo_posto.fabrica = {$login_fabrica}
                        LEFT JOIN tbl_os_troca ON tbl_os_troca.os = tbl_os.os AND tbl_os_troca.fabric = {$login_fabrica}
                        INNER JOIN tbl_os_extra ON tbl_os_extra.os = tbl_os.os
                        INNER JOIN tbl_os_produto ON tbl_os_produto.os = tbl_os.os
                        INNER JOIN tbl_os_item ON tbl_os_produto.os_produto = tbl_os_item.os_produto
                        INNER JOIN tbl_pedido_item ON tbl_pedido_item.pedido_item = tbl_os_item.pedido_item
                        INNER JOIN tbl_faturamento_item ON tbl_faturamento_item.pedido_item = tbl_pedido_item.pedido_item
                        INNER JOIN tbl_faturamento ON tbl_faturamento.faturamento = tbl_faturamento_item.faturamento AND tbl_faturamento.fabrica = {$login_fabrica}
                        WHERE tbl_os.fabrica = {$login_fabrica}
                        AND tbl_os.os = {$os}
                        AND (
                            tbl_tipo_posto.posto_interno IS TRUE OR COALESCE(tbl_os_troca.envio_consumidor, FALSE) = TRUE
                        )
                        $WhereCancelamento
                        GROUP BY tbl_faturamento.conhecimento,tbl_faturamento.saida,tbl_os_extra.extrato
                        ";
                    $resCodigoRastreio = pg_query($con, $sqlCodigoRastreio);

                    $sqlSPD = "
                        SELECT tbl_ressarcimento.autorizacao_pagto
                        FROM tbl_ressarcimento
                        INNER JOIN tbl_os ON tbl_os.os = tbl_ressarcimento.os AND tbl_os.fabrica = {$login_fabrica}
                        WHERE tbl_ressarcimento.fabrica = {$login_fabrica}
                        AND tbl_ressarcimento.os = {$os}
                    ";
                    $resSPD = pg_query($con, $sqlSPD);

                    $spd = "";

                    if (pg_num_rows($resSPD) > 0) {
                        $spd = pg_fetch_result($resSPD, 0, "autorizacao_pagto");
                    }

                    echo  "
                        <tr>
                        <td nowrap><a href='os_press.php?os=$os' target='_blank'>$abre_os_sua_os</a></td>
                        <td nowrap>$abre_os_status</td>
                        ";

                    if (pg_num_rows($resCodigoRastreio) > 0) {
                        echo "<td nowrap>";

                        for($j=0; $j < pg_num_rows($resCodigoRastreio); $j++){

                            $conhecimento = pg_fetch_result($resCodigoRastreio, $j, "conhecimento");
                            $saida = pg_fetch_result($resCodigoRastreio, $j, "saida");
                            $extrato_os = pg_fetch_result($resCodigoRastreio, $j, "extrato");

                            if (preg_match("/^\[.+\]$/", $conhecimento)) {
                                $conhecimento = json_decode($conhecimento, true);

                                $codigos_rastreio = array();

                                foreach ($conhecimento as $key => $codigo_rastreio) {
                                    $codigos_rastreio[] = "<A HREF='http://www.websro.com.br/correios.php?P_COD_UNI=$codigo_rastreio' target = '_blank'>$codigo_rastreio</A>";
                                }

                                if($j > 0 AND count($conhecimento) > 0){
                                    echo " , ";
                                }
                                echo implode(", ", $codigos_rastreio);

                            } else {

                                if($j > 0 AND strlen($conhecimento) > 0){
                                    echo " , ";
                                }

                                echo "<A HREF='http://www.websro.com.br/correios.php?P_COD_UNI=$conhecimento' target = '_blank'>";
                                echo $conhecimento;
                                echo "</A>";
                            }
                        }

                        echo "</td>";

                         if ($login_fabrica == 151 and strlen($codigo_rastreio) > 5) {

                            $query = "SELECT situacao FROM tbl_faturamento_correio WHERE fabrica = {$login_fabrica} AND conhecimento = '{$codigo_rastreio}' ORDER BY data DESC limit 1";

                            $res = pg_query($con,$query);

                            $res = pg_fetch_result($res, 0, situacao);

                            echo "<td>" . utf8_decode($res) . "</td>";
                        }

                        if(!empty($saida)){
                            echo "<td>{$saida}</td>";
                        }
                    } else {
                        if (!in_array($login_fabrica, array(178,183))){
                            echo "<td nowrap></td>";
							 if ($login_fabrica == 151 and strlen($codigo_rastreio) > 5) {

                                $query = "SELECT situacao FROM tbl_faturamento_correio WHERE fabrica = {$login_fabrica} AND conhecimento = '{$codigo_rastreio}' ORDER BY data DESC limit 1";

                                $res = pg_query($con,$query);

                                $res = pg_fetch_result($res, 0, situacao);

                                echo "<td>" . utf8_decode($res) . "</td>";

                                echo "<td></td>";
                            }
                        }
                    }


                    if (!in_array($login_fabrica, array(178,183))){
                        echo "<td>&nbsp;{$spd}</td>";
                    }

                    if ($abre_os_status == "Finalizada" AND strlen($extrato_os) > 0) {
                        echo "<td></td>";
                    } else if ($abre_os_status == "Finalizada"){
                        echo "<td></td>";
                    } else {
                        if(in_array($login_fabrica,array(151,178))) {
                            if ($troca_reembolso == 'f') {
                                echo "<td align='center'><a href='#' title='Usuário sem permissão para Troca/ Reembolso'>Trocar</a></td>";
                            } else {
                                echo "<td align='center'><a href='os_troca_subconjunto.php?os=$os&hd_chamado=$callcenter' target='_blank'>Trocar</a></td>";
                            }
                        }else if ($login_fabrica == 183){
                            echo "<td align='center'><a href='os_troca_subconjunto.php?os=$os&hd_chamado=$callcenter' target='_blank'>Trocar</a></td>";
                        } else {

                            if (in_array($login_fabrica, [35])) {
                                $retornoAn = retorna_dados_analise_obrigatoria($produto, $linha, $consumidor_cidade, $consumidor_estado);
                                if ($retornoAn["tem_posto"] && $codigo_posto == "REVERSA SAC") {
                                    $getAudTroca = "&auditoria_obrigatoria=t";
                                }
                            }
                            echo "<td align='center'><a href='os_cadastro.php?os=$os&osacao=trocar{$getAudTroca}' target='_blank'>Trocar</a></td>";
                        }

                        if ($login_fabrica == 35) {
                            echo "<td align='center'><a href='cadastro_os.php?os_id=$os' target='_blank'>Lançar Peças</a></td>";
                        }
                    }
                    echo "</tr>";
                }
                echo "  </table>";
            }
        } else if ($login_fabrica == 166) {
            $sqlHD = "SELECT
                tbl_os.sua_os,tbl_status_checkpoint.descricao
                FROM tbl_hd_chamado_extra
                JOIN tbl_hd_chamado ON tbl_hd_chamado_extra.hd_chamado = tbl_hd_chamado.hd_chamado
                JOIN tbl_os ON tbl_hd_chamado_extra.os = tbl_os.os
                JOIN tbl_status_checkpoint ON tbl_os.status_checkpoint = tbl_status_checkpoint.status_checkpoint
                WHERE tbl_hd_chamado_extra.hd_chamado = $callcenter";
            $resHD = pg_query($con, $sqlHD);

            if (pg_num_rows($resHD) > 0) {
                echo "
                <table>
                    <tr class='titulo_coluna'>
                        <td width='15%'>OS</td>
                        <td>Status</td>
                    </tr>
                ";

                for ($i=0; $i < pg_num_rows($resHD); $i++) {

                    $abre_os_sua_os = pg_result($resHD, 0, 'sua_os');
                    $abre_os_status = pg_result($resHD, 0, 'descricao');

                    echo  "
                    <tr>
                        <td><a href='os_press.php?os=$os' target='_blank'>$abre_os_sua_os</a></td>
                        <td nowrap>$abre_os_status</td>
                    </tr>
                    ";
                }
                echo "</table>";
            }
        } else if (($telecontrol_distrib || in_array($login_fabrica, [174])) && !empty($callcenter)) {

                $arrayStatusCallcenter = ["FCR"                         => "#0000FF",
                                          "Aguard. Postagem"            => "#FFFF00",
                                          "Produto postado"             => "#FF8000",
                                          "Entregue para avaliação"     => "#00BFFF",
                                          "Resolvido"                   => "#40FF00",
                                          "Aguard. Contato Consumidor"  => "white",
                                          "Pedido gerado"               => "#ff0000"];

                $sqlBuscaHistorico = "WITH dados as (
                                        SELECT
                                                 tbl_hd_chamado.hd_chamado,
                                                 tbl_hd_chamado_extra.os,
                                                 tbl_hd_chamado_extra.pedido,
                                                 tbl_hd_chamado.data as data_chamado,
                                                 status_item,
                                                 TO_CHAR(tbl_hd_chamado_item.data, 'dd/mm/yyyy') as data,
                                                 tbl_hd_chamado_item.data as data_input_item,
                                                 (
                                                    SELECT TO_CHAR(tbl_hd_chamado_item.data, 'dd/mm/yyyy')
                                                    FROM tbl_hd_chamado_item
                                                    WHERE tbl_hd_chamado_item.status_item = 'Resolvido'
                                                    AND tbl_hd_chamado_item.hd_chamado = tbl_hd_chamado.hd_chamado
                                                    ORDER BY tbl_hd_chamado_item.data DESC
                                                    LIMIT 1
                                                 ) as data_finalizado,
                                                 EXTRACT(day FROM (tbl_hd_chamado_item.data - tbl_hd_chamado.data)) as dias_abertura,
                                                 ROW_NUMBER() OVER(ORDER BY tbl_hd_chamado_item.data) as numero_registro
                                          FROM tbl_hd_chamado_item
                                          JOIN tbl_hd_chamado USING(hd_chamado)
                                          JOIN tbl_hd_chamado_extra USING(hd_chamado)
                                          WHERE tbl_hd_chamado.hd_chamado = {$callcenter}
                                          AND status_item IN ('".implode("','", array_keys($arrayStatusCallcenter))."')
                                      ), dadosOsPedido as (

                    SELECT DISTINCT dadosOs.os,
                            dadosOs.sua_os,
                                                        0 as pedido,
                                                        dadosOs.data_digitacao,
                                                        dadosOs.data_postado,
                                                        dadosOs.data_entregue
                                        FROM (
                        SELECT tbl_os.os,
                           tbl_os.sua_os,
                                                   tbl_os.data_digitacao,
                                                   postado.data  as data_postado,
                                                   entregue.data as data_entregue
                                            FROM tbl_os
                                            LEFT JOIN tbl_faturamento_item    ON tbl_os.os = tbl_faturamento_item.os
                                            LEFT JOIN tbl_faturamento_correio postado ON tbl_faturamento_item.faturamento = postado.faturamento
                                            AND  postado.situacao ILIKE '%Objeto postado%'
                                            LEFT JOIN tbl_faturamento_correio entregue ON tbl_faturamento_item.faturamento = entregue.faturamento
                                            AND  entregue.situacao ILIKE '%Objeto entregue%'
                                            JOIN dados ON dados.os = tbl_os.os
                                        ) as dadosOs

                                        UNION

                    SELECT DISTINCT 0 as os,
                            '0' as sua_os,
                                                        dadosPedido.pedido as pedido,
                                                        dadosPedido.data as data_digitacao,
                                                        dadosPedido.data_postado,
                                                        dadosPedido.data_entregue
                                        FROM (
                                            SELECT tbl_pedido.pedido,
                                                   tbl_pedido.data,
                                                   postado.data  as data_postado,
                                                   entregue.data as data_entregue
                                            FROM tbl_pedido
                                            LEFT JOIN tbl_faturamento_item    ON tbl_pedido.pedido = tbl_faturamento_item.pedido
                                            LEFT JOIN tbl_faturamento_correio postado ON tbl_faturamento_item.faturamento = postado.faturamento
                                            AND  postado.situacao ILIKE '%Objeto postado%'
                                            LEFT JOIN tbl_faturamento_correio entregue ON tbl_faturamento_item.faturamento = entregue.faturamento
                                            AND  entregue.situacao ILIKE '%Objeto entregue%'
                                            JOIN dados ON dados.pedido = tbl_pedido.pedido
                                        ) as dadosPedido

                                      )
                                      SELECT DISTINCT ON(status_item, dados.data_input_item::timestamp)
                                             dados.status_item,
                                             dados.data,
                                             dados.data_finalizado,
                                             dados.dias_abertura,
                                             dados.numero_registro,
                                             dadosOsPedido.pedido,
                         dadosOsPedido.os,
                         dadosOsPedido.sua_os,
                                             dadosOsPedido.data_postado::date,
                                             dadosOsPedido.data_entregue::date,
                                             dadosOsPedido.data_digitacao::date as data_abertura,
                                             EXTRACT(day FROM (dadosOsPedido.data_digitacao - dados.data_chamado)) as dias_abertura_pedido_os
                                      FROM dados
                                      LEFT JOIN dadosOsPedido ON (dadosOsPedido.pedido = dados.pedido OR dadosOsPedido.os = dados.os)
                                      ";
                $resBuscaHistorico = pg_query($con, $sqlBuscaHistorico);
                ?>
                <style>

                    #tabela_historico {
                        border-collapse: collapse;
                        font-family: Calibri;
                        background-color: white;
                        width: 110%;
                        height: 100%;
                        margin-left: -10%;
                    }

                    #tabela_historico td {
                        border-bottom: solid 1px black;
                        text-align: center;
                    }

                    #tabela_historico th {
                        background-color: #596d9b;
                        color: white;
                        font-weight: bolder;
                        padding: 3px;
                        text-align: center;
                    }

                    .status_chamado {
                        width: 9px;
                        height: 15px;
                        margin: 2px 5px;
                        padding: 0 5px;
                        border: 1px solid #666;
                    }

                </style>
                <table id="tabela_historico">
                    <tr>
                        <th colspan="100%">Histórico do Atendimento</th>
                    </tr>
                    <?php
                    while ($dadosHistorico = pg_fetch_assoc($resBuscaHistorico)) {

                        $dataProximoRegistro = pg_fetch_result($resBuscaHistorico, $dadosHistorico['numero_registro'], 'data');

                        if (empty($dataProximoRegistro)) {

                            if (!empty($dadosHistorico['data_finalizado'])) {
                                $dataProximoStatus = $dadosHistorico['data_finalizado'];
                            } else {
                                $dataProximoStatus = date("d/m/Y");
                            }

                            $dataCompara           = date("Y-m-d");

                        } else {
                            $dataProximoStatus = $dataProximoRegistro;
                            $dataCompara       = formata_data($dataProximoRegistro);
                        }

                        $dataProximoStatusFormat = strtotime(formata_data($dataProximoStatus));
                        $dataStatusAtualFormat   = strtotime(formata_data($dadosHistorico['data']));

                        $tempoPermanencia        = $dataProximoStatusFormat - $dataStatusAtualFormat;

                        $corStatus = $arrayStatusCallcenter[$dadosHistorico['status_item']];

                        ?>
                        <tr>
                            <td>
                                <div class="status_chamado" style="background-color:<?= $corStatus ?>">&nbsp;</div>
                            </td>
                            <td style="width: 70%;">
                                <p>
                                    <strong><?= $dadosHistorico['status_item'] ?></strong><br />
                                    <?= $dadosHistorico['data'] ?> - Permanência no status:
                                    <strong><?= round($tempoPermanencia / (60 * 60 * 24)) ?></strong> dias
                                </p>
                            <td>
                            <td style="width: 30%;">
                                Em aberto: <strong><?= $dadosHistorico['dias_abertura'] ?></strong> dias
                            <td>
                        </tr>
                        <?php

                        if (strtotime($dadosHistorico['data_abertura']) >= $dataStatusAtualFormat && strtotime($dadosHistorico['data_abertura']) <= strtotime($dataCompara)) {

                            if ($dadosHistorico['pedido'] > 0) {
                                $descricaoHistorico = "Gerado o pedido <a href='pedido_admin_consulta.php?pedido=".$dadosHistorico['pedido']."'>".$dadosHistorico['pedido']."</a>";
                            } else {
                                $descricaoHistorico = "Aberta a ordem de serviço <a href='os_press.php?os=".$dadosHistorico['os']."' target='_blank'>".$dadosHistorico['sua_os']."</a>";
                            }

                            ?>
                            <tr>
                                <td>
                                    <div class="status_chamado" style="background-color: red;">&nbsp;</div>
                                </td>
                                <td style="width: 70%;">
                                    <p>
                                        <strong>Gerado OS/PEDIDO</strong><br />
                                        <?= mostra_data($dadosHistorico['data_abertura']) ?> - <?= $descricaoHistorico ?>
                                    </p>
                                <td>
                                <td style="width: 30%;">
                                    Em aberto: <strong><?= $dadosHistorico['dias_abertura_pedido_os'] ?></strong> dias
                                <td>
                            </tr>
                        <?php
                        }

                        if (strtotime($dadosHistorico['data_postado']) >= $dataStatusAtualFormat && strtotime($dadosHistorico['data_postado']) <= strtotime($dataCompara)) {
                            ?>
                            <tr>
                                <td>
                                    <div class="status_chamado" style="background-color: darkgreen;">&nbsp;</div>
                                </td>
                                <td style="width: 70%;">
                                    <p>
                                        <strong>Produto em trÃ¢nsito</strong><br />
                                        <?= mostra_data($dadosHistorico['data_postado']) ?> - Produto enviado ao consumidor
                                    </p>
                                <td>
                                <td style="width: 30%;">
                                    Em aberto: <strong><?= $dadosHistorico['dias_abertura_pedido_os'] ?></strong> dias
                                <td>
                            </tr>
                        <?php
                        }

                        if (strtotime($dadosHistorico['data_entregue']) >= $dataStatusAtualFormat && strtotime($dadosHistorico['data_entregue']) <= strtotime($dataCompara)) {
                            ?>
                            <tr>
                                <td>
                                    <div class="status_chamado" style="background-color: lightgrey;">&nbsp;</div>
                                </td>
                                <td style="width: 70%;">
                                    <p>
                                        <strong>Produto entregue</strong><br />
                                        <?= mostra_data($dadosHistorico['data_entregue']) ?> - Produto entregue ao consumidor
                                    </p>
                                <td>
                                <td style="width: 30%;">
                                    Em aberto: <strong><?= $dadosHistorico['dias_abertura_pedido_os'] ?></strong> dias
                                <td>
                            </tr>
                        <?php
                        }

                    } ?>
                </table>
        <?php
        }
            ?>
            </td>
             </tr>
        <?}?>
        <?php if (in_array($login_fabrica, [174]) AND strlen(trim($callcenter)) > 0) { ?>
        <tr>
            <td>
                <table style="padding:5px;">
                    <tr>
                        <td>
                            <input type="checkbox" id="saudacao_ml" name="saudacao_ml"> <strong>ADICIONAR SAUDAÃÃO INICIAL</strong>
                        </td>
                        <td>
                            <input type="checkbox" id="assinatura_ml" name="assinatura_ml"> <strong>ADICIONAR ASSINATURA DE ATENDENTE</strong>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
        <script type="text/javascript">
            var callcenter = <?= $callcenter ?>;
            $(window).on("load", function () {
                $("#saudacao_ml").on("change", function () {
                    if ($(this).prop("checked")) {
                        var consumidor = $("#consumidor_nome").val();
                        $.ajax("callcenter_interativo_new.php", {
                            type: 'POST',
                            async: true,
                            data: {
                                saudacaoML: true,
                                callcenter: callcenter,
                                consumidor: consumidor
                            }
                        }).done(function (response) {
                            response = JSON.parse(response);
                            if (response.message) {
                                CKEDITOR.instances['resposta'].insertText(decodeURIComponent(response.message) + "\n");
                            }
                            CKEDITOR.instances['resposta'].focus();
                        });
                    }
                });

                $("#assinatura_ml").on("change", function () {
                    if ($(this).prop("checked")) {
                        $.ajax("callcenter_interativo_new.php", {
                            type: 'POST',
                            async: true,
                            data: {
                                assinaturaML: true,
                                callcenter: callcenter
                            }
                        }).done(function (response) {
                            response = JSON.parse(response);
                            if (response.message) {
                                CKEDITOR.instances['resposta'].insertText("\n" + decodeURIComponent(response.message));
                            }
                            CKEDITOR.instances['resposta'].focus();
                        });
                    }
                });
            });
        </script>
        <?php } ?>
        <tr>
        <td colspan='11'>
        <table align='center' style="padding:5px;border:0px">
        <?php if(in_array($login_fabrica, array(169,170))){

                if (strlen(trim($_POST['hd_classificacao'])) > 0){
                    $xhd_classificacao = $_POST['hd_classificacao'];
                }else{
                    $xhd_classificacao = $hd_classificacao;
                }
                $email_display = "style='display:none;'";
                if(!empty($xhd_classificacao)) {
                    $sql_email = "SELECT envia_email FROM tbl_hd_classificacao WHERE hd_classificacao = $xhd_classificacao
                                    AND fabrica = $login_fabrica AND envia_email IS TRUE";
                    $res_email = pg_query($con, $sql_email);
                    if(pg_num_rows($res_email) > 0){
                        $email_display = "";
                    }
                }

        ?>
        <tr id="classificacao_email" <?=$email_display?>>
            <td colspan="6">
                <span class='classificacao_email'>
                    Para a classificação selecionada será enviado um email para o posto com o texto digitado na interação
                </span>
            </td>
        </tr>
        <?php } ?>
        <tr>
        <?php if((in_array($login_fabrica , [30,189]) AND strlen($callcenter) > 0) OR !in_array($login_fabrica , [30,189])){ ?>
                <td align='left' id="texto_transferir" style="width:80px;">
                    <strong>Transferir p/:</strong>
                </td>
                <td align='left' id="campo_transferir" style="width: <?=($login_fabrica == 24)? "210px;" : "80px;"?>">
                    <select name="transferir" style='width:200px;font-size:12px' class="input" >
                        <option value=''></option>
                        <?
                            if ($login_fabrica == 24) {
                                $sql_fale = " AND atendente_callcenter = true ";
                            }
                            if($login_fabrica==30 and strlen($login_cliente_admin)>0) {
                                $sql_marca = "SELECT marca FROM tbl_cliente_admin WHERE cliente_admin = $login_cliente_admin";
                                $res_marca           = pg_exec($con,$sql_marca);
                                $marca_cliente_admin = pg_result($res_img,0,marca);
                                $sql_marca = " JOIN tbl_cliente_admin on tbl_cliente_admin.cliente_admin = tbl_admin.cliente_admin AND tbl_cliente_admin.marca = $marca_cliente_admin ";
                            }
                            else $sql_marca = '';

                            if (in_array($login_fabrica, array(169,170,183))){

								$whereMotivoLigacao = "";
								if (!empty($hd_motivo_ligacao)) {
									$whereMotivoLigacao = "AND tbl_admin_atendente_estado.hd_motivo_ligacao = {$hd_motivo_ligacao}";
								}

                                if (strlen(trim($hd_classificacao)) > 0){
                                    $sql = "SELECT tbl_admin.admin, tbl_admin.login, tbl_admin.nome_completo
                                            FROM tbl_admin
                                            JOIN tbl_admin_atendente_estado ON tbl_admin_atendente_estado.admin = tbl_admin.admin
                                                AND tbl_admin_atendente_estado.fabrica = $login_fabrica
                                            WHERE tbl_admin.fabrica = $login_fabrica
                                            AND tbl_admin.ativo is true
                                            AND tbl_admin_atendente_estado.hd_classificacao = $hd_classificacao
											{$whereMotivoLigacao}
                                            AND (privilegios like '%call_center%' or privilegios like '*')
                                            ORDER by tbl_admin.login ";
                                    $res = pg_query($con,$sql);
                                }

                            }else{
                                $sql = "SELECT admin, login, nome_completo
                                        from tbl_admin
                                        $sql_marca
                                        where tbl_admin.fabrica = $login_fabrica
                                        and tbl_admin.ativo is true
                                        and (privilegios like '%call_center%' or privilegios like '*')
                                        $sql_fale
                                        order by login
                                        ";
                                $res = pg_query($con,$sql);
                            }

                            if(pg_num_rows($res)>0){
    							for($i=0;pg_num_rows($res)>$i;$i++){
    								$tranferir = pg_fetch_result($res,$i,admin);
                                    $tranferir_nome = pg_fetch_result($res,$i,login);
                                    $tranferir_nome_completo = pg_fetch_result($res,$i,nome_completo);

                                    if (!empty($tranferir_nome_completo)) {
                                        $tranferir_nome = $tranferir_nome_completo;
                                    }
                                    $transferir_selected = ($_POST['transferir'] == $tranferir) ? "SELECTED" : null;
                                    echo "<option value='$tranferir' $transferir_selected >$tranferir_nome</option>";
                                }
                            }
                        ?>
                    </select>
                </td>
        <?php } ?>
        <?php if ($login_fabrica != 24){ ?>
        </tr>
        <tr>
        <?php } ?>
        <? if (in_array($login_fabrica,array(11,24,85,151,172))) { ?>
        <td align='left' width="<?=($login_fabrica == 24)? "90" : "50"?>"><strong>Interventor p/:</strong></td>
        <td align='left' width='90'>
            <select name="intervensor" style='width:80px; font-size:9px' class="input" >
            <option value=''></option>
            <?
                if (in_array($login_fabrica,array(11,24,85,151,172)))  {
                    $sql_fale = " AND intervensor = true ";
                }
                $sql = "SELECT admin, login
                        from tbl_admin
                        where fabrica = $login_fabrica
                        and ativo is true
                        and (privilegios like '%call_center%' or privilegios like '*')
                        $sql_fale
                        order by login
                        ";
                $res = pg_query($con,$sql);
                if(pg_num_rows($res)>0){
                    for($i=0;pg_num_rows($res)>$i;$i++){
                        $tranferir_intervensor = pg_fetch_result($res,$i,admin);
                        $tranferir_nome_intervensor = pg_fetch_result($res,$i,login);
                        echo "<option value='$tranferir_intervensor'>$tranferir_nome_intervensor</option>";
                    }
                }
            ?>
            </select>
        </td>
        <?}?>
        <?php if ($login_fabrica != 24){ ?>
        </tr>
        <?php if (in_array($login_fabrica, [189])) { ?>
        <tr>
            <td align='left' width="50"><strong>Prioridade:</strong></td>
            <td align='left' width='90'>
                <select name="prioridade" style='width:180px; font-size:9px' class="input" >
                <option value=''></option>
                <?php
                $array_prioridade = [
                    "Prioridade 1" => "Prioridade 1",
                    "Prioridade 2" => "Prioridade 2",
                    "Prioridade 3" => "Prioridade 3",
                ];
                    foreach ($array_prioridade as $key => $value) {
                        if($array_campos_adicionais['prioridade'] == $value){
                            $selected = " selected ";
                        }else{
                            $selected = " ";
                        }
                        echo "<option value='$key' $selected >$value</option>";
                    }
                ?>
                </select>
            </td>
        </tr>
        <?php } ?>


        <tr>
        <?php }

         if($login_fabrica == 35 AND strlen($callcenter) > 0 ){ ?>

				<td align='left' width='120'><strong>Enviar para Consumidor:</strong></td>
				<td align="left" style=" width: 14px;">
					<input type="checkbox" name="transferir_consumidor" id="transferir_consumidor" class="input"/>
				</td>
			<?php
				}
			?>
        <?php if ($login_fabrica == 162) { //HD-3352176 ?>
            <td align='left' width='50'><strong>Motivo:</strong></td>
            <td align='left' width='85'>
                <select name="motivo_situacao" id="motivo_situacao" style="width:80px; font-size:9px" class="input" >
                    <option value=""></option>
                <?php

                    if($login_fabrica == 162 AND strlen(trim($situacao_interacao)) > 0){ //HD-3352176
                        $condAtivo = " AND (ativo IS TRUE) OR (hd_situacao = $situacao_interacao)";
                    }else{
                        $condAtivo = " AND ativo IS TRUE ";
                    }

                    $sql = " SELECT hd_situacao,descricao FROM tbl_hd_situacao where fabrica=$login_fabrica $condAtivo order by descricao ";

                    $res = pg_query($con,$sql);
                    for ($i = 0; $i < pg_num_rows($res);$i++){

                        $hd_situacao = pg_result($res,$i,'hd_situacao');

                        $hd_situacao_desc = pg_result($res,$i,'descricao');

                        $selected_situacao = ($hd_situacao == $situacao_interacao OR $_POST['motivo_situacao'] == $hd_situacao) ? "SELECTED" : null;
                ?>
                        <option value="<?=$hd_situacao?>" <?echo $selected_situacao?> ><?echo $hd_situacao_desc?></option>
                <?
                    }
                ?>
                </select>
            </td>
            </tr>
            <tr>
        <?php } ?>
        <td align='left' width='40'><strong>Situação:</strong></td>
        <td align='left' width='<?=($login_fabrica == 24)? "210" : "85"?>'>

            <?php
            if($login_fabrica == 74){
                ?>

                <script>

                function verificaStatus(n){

                    if(n == "button"){
                        n = $('#status_interacao').val();
                    }

                    if(n == "PROTOCOLO DE INFORMACAO"){

                        var info_cliente = $('textarea[name=informacoes_cliente]').val();

                        if(info_cliente == ""){

                            alert("Por favor insira as informações do Cliente!");

                        }

                    }

                }
                </script>

                <?php
            }
            ?>
            <?php
            if($login_fabrica == 15){
                ?>

                <script>

                function verificaStatus(n){

                        if(n == "button"){
                            n = $('#status_interacao').val();
                        }
                        if(n == "Retorno"){
                            $('#data_para_retorno').show();
                        }
                        else {
                            $('#data_para_retorno').hide();
                        }

                  }
                </script>

                <?php
            }
            ?>

            <?php
            if($login_fabrica == 90){
                echo "<input type='hidden' name='status_interacao_anterior' value='$status_interacao' >";
            }
            ?>
            <select <?=$disabled_situacao?> name="status_interacao" id="status_interacao" style="width:200px;font-size:12px" class="input" <?php if ($login_fabrica == 74 OR $login_fabrica == 15 ) { echo "onchange=\"verificaStatus(this.value)\""; } ?> >


			<?php
				$sql = " SELECT status FROM tbl_hd_status where fabrica = $login_fabrica order by status ";
                $res = pg_query($con,$sql);

                for ($i = 0; $i < pg_num_rows($res); $i++){

                    $status_hd = pg_result($res,$i,0);

                    $status_hd_desc = ($status_hd == 'Ag. Consumidor') ? 'Aguardando Consumidor' : $status_hd;

                    $selected_status = ($status_hd == $status_interacao) ? "SELECTED" : null;

            ?>
                    <option value="<?=$status_hd?>" <?echo $selected_status?> ><?echo $status_hd_desc; ?></option>
            <?
                }
            ?>
            </select>
        </td>
    <?php if ($login_fabrica != 24){ ?>
    </tr>
    </table>
    <table style="padding:5px">
        <tr>
    <?php } ?>
        <?php if($login_fabrica == 81){ ?>
            <td align='left' width='40'><strong>Solução</strong></td>
            <td align='left' width='85'>
                <select id="solucao" name="solucao">
                    <?=$optionSolucao?>
                </select>
            </td>

        <?php } ?>
        <?php
        $mostra_data_consertado = false;

        if ($login_fabrica == 74 and !empty($callcenter)) {
            $qry = pg_query(
                $con,
                "SELECT TO_CHAR(tbl_os.data_conserto, 'DD/MM/YYYY') as data_consertado
                FROM tbl_hd_chamado_extra
                JOIN tbl_os USING(os)
                JOIN tbl_produto ON tbl_produto.produto = tbl_os.produto
                JOIN tbl_linha USING(linha)
                WHERE tbl_hd_chamado_extra.hd_chamado = $callcenter
                AND LOWER(tbl_linha.nome) = 'fogo'"
            );

            if (pg_num_rows($qry) == 1) {
                if (empty($data_consertado)) {
                    $data_consertado = pg_fetch_result($qry, 0, 'data_consertado');
                } else {
                    if (isset($dtdc) and $dtdc instanceof DateTime) {
                        $data_consertado = $dtdc->format('d/m/Y');
                    }
                }

                $mostra_data_consertado = true;
            }
        }
        ?>
        <?php if (true === $mostra_data_consertado): ?>
        <td align='left' width='105' class="data_consertado"><strong>Data Consertado:</strong></td>
        <td align='left' width='85' class="data_consertado">
            <input type="text" value="<?php echo $data_consertado; ?>" name="data_consertado" id="data_consertado" class="input" disabled="disabled" />
        </td>
        <?php endif ?>
        <?php if ($login_fabrica == 30) {?>
        <td align='left' width='50'><strong>Motivo:</strong></td>
        <td align='left' width='85'>
            <select name="motivo_situacao" id="motivo_situacao" style="width:80px; font-size:9px" class="input" >
                <option value=""></option>
            <?php

                $sql = " SELECT hd_situacao,descricao FROM tbl_hd_situacao where fabrica=$login_fabrica order by descricao ";
                $res = pg_query($con,$sql);
                for ($i = 0; $i < pg_num_rows($res);$i++){

                    $hd_situacao = pg_result($res,$i,'hd_situacao');

                    $hd_situacao_desc = pg_result($res,$i,'descricao');

                    $selected_situacao = ($hd_situacao == $situacao_interacao OR $_POST['motivo_situacao'] == $hd_situacao) ? "SELECTED" : null;
            ?>
                    <option value="<?=$hd_situacao?>" <?echo $selected_situacao?> ><?echo $hd_situacao_desc?></option>
            <?
                }
            ?>
            </select>
        </td>
        <?php } ?>
        <?php
            if ($login_fabrica == 15) {
                $display1 = ($status_interacao == "Retorno") ? "display: block;" : "display: none;";
            ?>
            <td align="left" id="data_para_retorno" nowrap style="width: 130px; <?=$display1?>" >
                <label for="marcar_data_para_retorno"><strong>Retorno: </strong></label>
                <input type="text" value="<?php echo $xdata_retorno; ?>" name="data_retorno" id="data_retorno"  rel="data" class="input" />
                <input type="hidden" id="data_retorno_alterou" name="data_retorno_alterou" value="<?=$_POST['data_retorno_alterou']?>" />
            </td>
<?php
            }
?>
<?php
        if (in_array($login_fabrica,array(85,94,129,145,157,161))) {
            $display = strtoupper($status_interacao) == "RESOLVIDO" ? "display:block" : "display:none";
?>
            <td align="left" id="satisfacao" nowrap style="width: 230px; <?=$display?>">
                <input type="checkbox" value="t" name="disparar_pesquisa" id="disparar_pesquisa" class="input" <?php echo (isset($_POST['disparar_pesquisa'])) ? 'checked="checked"' : '' ; ?> />
                <label for="disparar_pesquisa"><strong>Disparar Pesquisa ao Consumidor</strong></label>
            </td>
<?php

            if ($login_fabrica == 85 && !empty($os)) {
                $sql24hrs = "
                    SELECT  tbl_os.os
                    FROM    tbl_os
                    JOIN    tbl_os_extra            USING(os)
                    JOIN    tbl_hd_chamado_extra    USING(os)
                    JOIN    tbl_hd_chamado          ON tbl_hd_chamado.hd_chamado = tbl_hd_chamado_extra.hd_chamado
                    WHERE   tbl_os.fabrica          = $login_fabrica
                    AND     tbl_os.os               = $os
                    AND     tbl_os_extra.extrato    IS NULL
                    AND     tbl_os.finalizada       IS NOT NULL
                    AND     tbl_os.data_digitacao_fechamento < (tbl_hd_chamado.data + INTERVAL '36 hours')
                ";
                $res24hrs = pg_query($con,$sql24hrs);
                if (pg_num_rows($res24hrs) > 0) {
?>
            <td align="left" id="satisfacao" nowrap style="width: 70px;">
                <input type="checkbox" value="t" name="bonificacao" id="bonificacao" class="input" />
                <label for="bonificacao"><strong>Bonificação por serviço diferenciado</strong></label>
            </td>
<?php
                } else {
?>
                <input type="hidden" name="sem_bonificacao" value="t" />
<?php
                }
            }
        }
        if($login_fabrica != 74){
            if(in_array($login_fabrica,array(169,170))){
                if(strlen(trim($callcenter)) > 0){
                    $obs_interno = "<br/> <span class='obs_interno'>Caso o campo Chamado Interno seja desmarcado, será enviado um email para o cliente <br/> caso o mesmo esteja cadastrado no chamado</span>";
                    $style_width = "style='width: 730px;'";
                }else{
                    $style_width = "style='width: 130px;'";
                }
                $checked_interno = 'checked="checked"';
            }else{
                if(isset($_POST["chamado_interno"])){
                    $checked_interno = 'checked="checked"';
                }
                $style_width = "style='width: 130px;'";
            }

        if (in_array($login_fabrica, [169,170])) { ?>
                    <td style="width: 40px;"><strong>Contato:</strong></td>
                    <td style="width: 80px;">
                        <select name="motivo_contato_callcenter">
                            <option value=""></option>
                            <?php
                            $sqlMotivoContato = "SELECT descricao, motivo_contato
                                                 FROM tbl_motivo_contato
                                                 WHERE ativo IS TRUE
                                                 AND fabrica = {$login_fabrica}";
                            $resMotivoContato = pg_query($con, $sqlMotivoContato);

                            if (pg_num_rows($resMotivoContato) > 0) {
                                while ($dadosMotivo = pg_fetch_object($resMotivoContato)) {

                                    $selected = ($dadosMotivo->motivo_contato == $motivo_contato_callcenter) ? "selected" : "";

                                ?>
                                    <option value="<?= $dadosMotivo->motivo_contato ?>" <?= $selected ?>><?= $dadosMotivo->descricao ?></option>
                                <?php
                                }
                            } ?>
                        </select>
                    </td>
        <?php
        }

        if ($login_fabrica != 24){ ?>
            </tr>
        </table>
        <table style="padding:5px">
            <tr>
    <?php } ?>
            <?php if ($login_fabrica != 178){ ?>
				<td align="left" nowrap <?=$style_width?> >
                <?php if (in_array($login_fabrica, [166,174,186,189]) || (in_array($login_fabrica, [144]) && !empty($callcenter))) { ?>
                    <input type="checkbox" name="enviar_email" id="enviar_email" class="input"/>
                    <label for="enviar_email"><strong>Enviar por e-mail ao consumidor</strong></label>
                    <?php if (in_array($login_fabrica, [189])) { ?>
                        <br>
                        <input type="checkbox" name="enviar_email_rep" value="t" id="enviar_email_rep" class="input"/>
                        <label for="enviar_email_rep"><strong>Enviar por e-mail ao representante</strong></label>
                    <?php }  ?>
                <?php } else { ?>
					<input type="checkbox" name="chamado_interno" id="chamado_interno" class="input" <?php echo $checked_interno; ?> />
					<label for="chamado_interno"><strong>Chamado Interno</strong></label>

                <?php }

                    if (in_array($login_fabrica, [144]) && !empty($callcenter)) { ?>
                        <br /><br />
                        <input type="checkbox" name="chamado_interno" id="chamado_interno" class="input" <?php echo $checked_interno; ?> />
                        <label for="chamado_interno"><strong>Chamado Interno</strong></label>
                <?php
                    }

                        echo $obs_interno;
                        if(in_array($login_fabrica, array(169,170))){
                            $sql_sup = "SELECT admin FROM tbl_admin WHERE fabrica = {$login_fabrica} AND tbl_admin.admin = {$login_admin} AND tbl_admin.callcenter_supervisor IS TRUE ";
                            $res_sup = pg_query($con, $sql_sup);
                            if(pg_num_rows($res_sup) > 0){
                                $admin_supervisor = pg_fetch_result($res_sup, 0, 'admin');
                            }
                            echo "<input type='hidden' name='admin_supervisor' value='{$admin_supervisor}'>";
                            echo "<input type='hidden' name='valida_senha_supervisor' value='{$valida_senha_supervisor}'>";
                            echo "<p class='msg_prazo_dias' style='display:none;' >Para a providência selecionada deve ser selecionado o status RESOLVIDO <br/> ou da permissão de um SUPERVISOR</p>";

                            echo "<button class='permissao_supervisor' style='display:none;' type='button' onClick='permissao_supervisor($callcenter);'>Permissão Supervisor</button>";
                        }
				       // !110180 - Nome do atendente que abriu o chamado no rodapé
					   $fabrica_exibir_nome_atentende = array(30);
					   $fabrica_exibir_nome_atentende = array_flip($fabrica_exibir_nome_atentende);
					?>
					<?php if ( ! empty($callcenter) && isset($fabrica_exibir_nome_atentende[$login_fabrica])): ?>
						<?php
							/**
							 * Colocar nome de usuário que abriu o chamado no rodapé.
							 * HD 110180
							 *
							 * @author Augusto Pascutti <augusto.pascuti@telecontrol.com.br>
							 */
							$sql_abriu = "SELECT nome_completo
										  FROM tbl_admin
										  WHERE admin = %s";
							$sql_abriu = sprintf($sql_abriu,$usuario_abriu);
							$sql_abriu = pg_escape_string($sql_abriu);
							$res_abriu = @pg_query($con,$sql_abriu);
							if ( is_resource($res_abriu) ) {
								$row_abriu = pg_num_rows($res_abriu);
								if ( $row_abriu > 0 ) {
									$nome_abriu = pg_fetch_result($res_abriu,0,'nome_completo');
								}
							}

							if (empty($nome_abriu) ) {
								$nome_abriu = "Erro";
							}?>
						&nbsp; Chamado aberto por <?php echo $nome_abriu; ?>
					<?php endif; ?>
				</td>
			<?php
                    }
				}
			if ($login_fabrica == 25) {?>
				<td align='center' nowrap><a href='sedex_cadastro.php' target='blank'><strong>Abrir OS Sedex</strong></a></td><?php
			}

            if ($login_fabrica == 138) {
                $cancela_mobra_checked = ($cancela_mobra == "t") ? "CHECKED" : "";
            ?>
                <td align='' nowrap>
                    <input type="checkbox"  name="cancela_mobra" class="input" <?=$cancela_mobra_checked?>  >
                    <strong>Cancelar Mão-de-Obra da Ordem de Serviço <a href='os_press.php?os=<?=$os?>' target='_blank'><?=$os?></a></strong>
                </td>
            <?php
            }

            $checked_troca = ($atendimento_com_troca == "t") ? "CHECKED" : "";

            if (in_array($login_fabrica,array(35,151)) && strlen($callcenter) > 0) {
                ($login_fabrica == 35) ? $label_produto = 'Gerar Troca Produto/Peça' : $label_produto = 'Trocar Produto';
                if($troca_reembolso == 'f'){
                    $readonly_title_troca_reembolso = " TITLE='Usuário sem permissão para Troca/ Reembolso' disabled='true' ";
                }else{
                    $readonly_troca_reembolso = "";
                }
?>
                <td align='center' style="width: 220px;"><input <?=$readonly_title_troca_reembolso?> TYPE="checkbox"  NAME="trocar_produto" class="input" <?=$checked_troca?>  > <strong><?=$label_produto?></strong></td><?php
            }

            if(in_array($login_fabrica, array(169,170)) AND strlen(trim($callcenter)) > 0 AND strlen(trim($produto)) > 0 AND strlen(trim($os)) > 0){

                $sql_troca = "SELECT os_troca FROM tbl_os_troca WHERE fabric = {$login_fabrica} AND os = {$os}";
                $res_troca = pg_query($con, $sql_troca);

                if(pg_num_rows($res_troca) > 0){
                    $sql_auditoria = "SELECT liberada FROM tbl_auditoria_os WHERE os = $os ORDER BY auditoria_os DESC LIMIT 1";
                    $res_auditoria = pg_query($con, $sql_auditoria);

                    if (pg_num_rows($res) > 0) {
                        $auditoria_liberada = pg_fetch_result($res_auditoria, 0, 'reprovada');

                        if (!empty($auditoria_liberada)) {
                            $display_os_troca = "style='display:none;'";
                        }
                    }
                }
                ?>
                <td <?=$display_resolvido?> <?=$display_os_troca?> align='center' style="width: 120px;"><input TYPE="checkbox"  NAME="trocar_produto" class="input" <?=$checked_troca?> > <strong>Trocar Produto</strong></td><?php
            }

			//HD 234227: Enviar e-mail para o consumidor
			if (in_array($login_fabrica,array(24,30,42,86,90,178)) && strlen($callcenter) > 0) {?>
				<td align='left' nowrap><input type="checkbox" <?php if ($envia_email) { echo "checked"; } ?> NAME="envia_email" class="input"  id='enviar_email' > <strong>Envia e-mail para consumidor</strong></td><?php
			}

            ?>
        </tr>
    </table>
    <table style="padding:5px;">
        <tr>
            <?php

            if ((in_array($login_fabrica,array(42,80,104,151,186)) and !empty($callcenter)) || ($login_fabrica == 174 || $login_fabrica == 189 )){
                if($login_fabrica == 80 || $login_fabrica == 104){
                    if($login_fabrica == 80){
                ?>
                        <td align='left' style="width: 220px;"><input TYPE="checkbox"  NAME="enviar_por_email" class="input" id="enviar_por_email"> <label for="enviar_por_email"><strong>Enviar por e-mail ao consumidor</strong></label></td>
                <?php
                    }
                }

                if(in_array($login_fabrica, $fabricas_sms)){
                ?>
                    <td>
                        <label><b>Digite o texto SMS aqui:</b></label><br />
                        <textarea style="width:270px;height:60px;margin-right:10px;" name="texto_sms_digitado" id="texto_sms_digitado"><?=$texto_sms_digitado?></textarea>
                        <label id="qtde_caracteres"></label>
                    </td>
                <?php
                }

                if(!in_array($login_fabrica, array(11,101,172))) {
                ?>
                    <td align='left' style="width: 220px;"><input type="checkbox" id="enviar_por_sms" NAME="enviar_por_sms" class="input" <?php echo (isset($_POST["enviar_por_sms"])) ? "checked" : ""; ?> >
                        <label for="enviar_por_sms"><strong>Enviar por SMS ao consumidor</strong></label>
                    </td>
            <?php
                }

            }
            ?>
        </tr>
    </table>
    <table style="padding:5px;">
        <?php
            if ($atendimentoML == true AND strlen($callcenter) > 0) {
                $queryUserMeLibre = "SELECT
                                        json_field('mlUserId', thce.array_campos_adicionais) AS user_id
                                    FROM tbl_hd_chamado_extra thce
                                    JOIN tbl_hd_chamado thc ON thce.hd_chamado = thc.hd_chamado
                                    WHERE thc.hd_chamado = {$callcenter}
                                    AND thc.fabrica = {$login_fabrica}";
                $resultUserMeLibre = pg_query($con, $queryUserMeLibre);
                $meLibreUser = pg_fetch_result($resultUserMeLibre, 0, 'user_id');

                if (!empty($meLibreUser)) {
        ?>
                    <tr>
                        <td>
                            <input type='checkbox' id='melibre-response' name='envia_melibre' class='form-control'>
                            <label for='melibre-response'><strong>ENVIAR RESPOSTA VIA MERCADO LIVRE</strong></label>
                        </td>
                    </tr>
        <?php
                    $queryHdType = "SELECT
                                        tbl_hd_chamado_item_externo.id_integracao
                                    FROM tbl_hd_chamado_item_externo
                                    JOIN tbl_hd_chamado ON tbl_hd_chamado.hd_chamado = tbl_hd_chamado_item_externo.hd_chamado
                                    JOIN tbl_hd_chamado_item ON tbl_hd_chamado_item.hd_chamado_item = tbl_hd_chamado_item_externo.hd_chamado_item
                                    WHERE tbl_hd_chamado.hd_chamado = {$callcenter}
                                    AND tbl_hd_chamado.fabrica = {$login_fabrica}
                                    AND tbl_hd_chamado_item.admin IS NULL
                                    ORDER BY tbl_hd_chamado_item_externo.data_input DESC
                                    LIMIT 1";
                    $result = pg_query($con, $queryHdType);
                    $resultHdType = pg_fetch_result($result, 0, 'id_integracao');

                    $resultHdType = json_decode($resultHdType, true);

                    if ($resultHdType['itemType'] == "message") {
        ?>
                    <tr id="melibre-att-line" style="display:none;">
                        <td style="padding:10px 0px;">
                            <input style="width:260px;" type="file" id="melibre-attachment" name="melibre_attachment" class="form-control">
                        </td>
                    </tr>
                    <script>
                    $(function () {
                        $("#melibre-response").on("click", function () {
                            $("#melibre-att-line").slideToggle(200);
                        });
                    });
                    </script>

        <?
                    }
                } elseif (preg_match("/Mercado Livre/", $origem) AND strlen($callcenter) > 0) {
        ?>
                    <tr>
                        <td>
                            <strong>Atendimento aberto manualmente, não será possível interagir diretamente com a plataforma Mercado Livre.</strong>
                        </td>
                    </tr>
        <?php
                }
            }
        ?>
    </table>
    <center>
    <table style="padding:5px;">
        <tr>
            <td <?=$display_resolvido?>>
                <?php

                if($login_fabrica == 74){

                    if(strlen($callcenter)){

                        $sql_atendente = "SELECT atendente FROM tbl_hd_chamado WHERE hd_chamado = {$callcenter} AND fabrica = {$login_fabrica}";
                        $res_atendente = pg_query($con, $sql_atendente);

                        if(pg_num_rows($res_atendente) > 0){

                            $atendente = pg_fetch_result($res_atendente, 0, "atendente");

                        }

                        $atendente_transf = ($atendente != $login_admin) ? $atendente : $login_admin;

                    }else{
                        $atendente_transf = $login_admin;

                    }

                    $atendente_hidden = "<input type='hidden' name='atendente_transferencia' id='atendente_transferencia' value='{$atendente_transf}' />";

                }

                ?>

                <?php
                    if($login_fabrica == 24 AND strlen($callcenter) == 0){ // HD-2252587
                        $style_button = "display:none;";

                            echo "<input class='input' type='button' name='bt' value='Gravar Atendimento' style='width:120px;height:30px' onclick=\"javascript: if ($('input[name=btn_acao]').val() == '') {
                                    if (fn_valida_consumidor_cpf(document.frm_callcenter.consumidor_cpf.value, document.frm_callcenter.consumidor_nome.value) == true) {
                                        $('input[name=btn_acao]').val('final'); $('#frm_callcenter').submit(); $(this).hide();
                                    }
                                } else {
                                    alert('Aguarde o Envio...'); return false;
                                }\">";
                            echo "<input class='botao' type='hidden' name='btn_acao'  value=''>";
                    } else {

                        if($login_fabrica == 74){
                            echo $atendente_hidden;

                            echo "<input class='input' type='button' name='bt' value='Gravar Atendimento' style='width:120px;height:30px' onclick=\"javascript: if ($('input[name=btn_acao]').val() == '') { $('input[name=btn_acao]').val('final'); transferir_chamado(); $(this).hide(); } else {alert('Aguarde o Envio...'); return false; }\">";
                            echo "<input class='botao' type='hidden' name='btn_acao'  value=''>";

                        }else{
                            if (in_array($login_fabrica, array(169,170))) {
                                $removeDisabledAbreOsPreOs = "$('#abre_ordem_servico, #abre_os, #serv_install').prop({ disabled: false });";
                            }
                        ?>

                            <input class="botao" type="hidden" name="btn_acao"  value=''>
                            <input type="hidden" name="autoriza_gravacao" id="autoriza_gravacao" value=''>
                            <input type="hidden" name="autoriza_gravacao_esmaltec" id="autoriza_gravacao_esmaltec" value=''>
                            <input type="hidden" name="autoriza_admin_esmaltec" id="autoriza_admin_esmaltec" value=''>
                            <?php
                            if($login_fabrica == 30 and empty($os)){
                                echo "<input id='anexoEsmaltec' type='hidden' name='anexoEsmaltec' value='$anexoEsmaltec'>";

                                echo "<input id='dadosDiferenteEsmaltec' type='hidden' name='dadosDiferenteEsmaltec' value='$dadosDiferenteEsmaltec'>";
                            }if($login_fabrica == 90){
                                echo "<input type='hidden' name='confirmaEmail' id='confirmaEmail' value=''>";

                            }

                            if($login_fabrica == 30  and empty($os)){
                                echo "<input type='hidden' name='fabrica_hidden' class='fabrica_hidden' value='$login_fabrica'>";
                                echo '<input type="hidden" name="desbloquear_atendimento" class="desbloquear_atendimento" value="">';
                                echo "<input class='input' type='button' name='bt' value='Gravar Atendimento' style='width:180px;height:30px' onclick=\"
                                    fnc_grava_callcenter_esmaltec();

                                     \">";

                            }else{

                            ?>
                             <input type='hidden' name='fabrica_hidden' class='fabrica_hidden' value='<?=$login_fabrica?>'>
                            <input type="hidden" name="desbloquear_atendimento" class="desbloquear_atendimento" value="">
                            <input class="input verifica_servidor input_grava_atendimento"
                                rel="frm_callcenter"
                                type="button"
                                name="bt"
                                value='Gravar Atendimento'
                                style='width:120px;height:30px; <?=$style_button?>'
                                onclick="$(this).hide();

                                    <?php
                                    if($login_fabrica == 90 and !empty($callcenter)){ ?>
                                            var enviar_email = document.getElementById('enviar_email').checked;

                                            if(enviar_email == true){
                                                if(confirm('O conteÃºdo da interação deve realmente ser enviado por e-mail ao cliente?') == true){
                                                    document.getElementById('confirmaEmail').value='sim';
                                                }else{
                                                    document.getElementById('confirmaEmail').value='nao';
                                                    return false;
                                                }
                                            }

                                    <?php }
                                    ?>
                                    if (document.frm_callcenter.btn_acao.value!='') {
                                        alert('Dados já gravados. Se você clicou em Voltar no seu browser ou clicou mais de uma vez no botão, acesse novamente a tela pelos Menus do sistema.');
                                    } else {
                                        <?
                                        echo $removeDisabledAbreOsPreOs;

                                        if($login_fabrica == 3) { // HD 48680
                                            echo "
                                                if(confirm('Deseja confirmar o atendimento?') == true){
                                                    document.frm_callcenter.btn_acao.value='final';
                                                }else{
                                                    return;
                                                }
                                            ";
                                        } else {
                                            echo "document.frm_callcenter.btn_acao.value='final'; liberar_campos();";
                                        }
                                        ?>
                                    }
                                "
                            /><!-- end input -->

                            <?php
                            }
                            if($os_externa_atendimento === true){
                            ?>
                            <script>

                                Shadowbox.init({
                                    skipSetup: true
                                });

                                function lista_os_atendimento(){

                                    Shadowbox.open({
                                        content: "lista_admin_atendimento.php",
                                        player: "iframe",
                                        width: 700,
                                        height: 200
                                    });

                                }

                                function desbloqueia_finalizacao_atendimento(){

                                    $(".input_grava_atendimento").removeAttr("disabled");
                                    $(".desbloquear_atendimento").val("sim");

                                }

                            </script>
                            <?php
                            }
                        }
                }
?>
            </td>
            <?php
                if(strlen($callcenter) > 0 AND $login_fabrica == 45){
                    if(file_exists("xls/$callcenter.zip")){
                        echo "<td align='left' width='150'>
                                <input type='button' value='Download XML' onclick=\"window.open('xls/$callcenter.zip');\">
                              </td>
                              <td>
                                <iframe src='upload_xml_nks.php?hd_chamado=".$callcenter."' width='500' height='60' style='border:0;'></iframe>
                              </td>";
                    }else{
            ?>
                        <td align='left' id='gerar_xml'>
                            <input type='button' value='Gerar XML' onclick="javascript: geraXml(<?=$callcenter?>)">
                            <input type='radio' name='coleta' value='CA' checked> Coleta Domiciliar
                            <input type='radio' name='coleta' value='A'> Autorização de Coleta &nbsp;&nbsp;
                             <input type='text' name='valor_declarado' id='valor_declarado' size='8' class='frm'> Valor Declararo
                        </td>
            <?php
                    }
                }
            ?>
        </td>
    </table>
    </center>
    </td>
    </tr>
</table>
        <!-- FIM HD-1667397 MONTEIRO -->
<!-- INICIO HD-4314164 ELEOTERIO -->
<?php


if (in_array($login_fabrica, [174]) && $_GET['callcenter']) {
    $sqlValida = "SELECT aprovado, orcamento FROM tbl_orcamento where hd_chamado = {$_GET['callcenter']} order by data_digitacao desc limit 1";
    $resValida = pg_query($con, $sqlValida);
    $aprovado = pg_fetch_result($resValida, 0, aprovado);
    $orcamento = pg_fetch_result($resValida, 0, orcamento);
    $enviarOrcamento    = "";
    $aprovarOrcamento   = "disabled";
    $reprovarOrcamento  = "disabled";
    if (pg_num_rows($resValida) > 0){
        $text_status = "Orcamento sem Status";
        $aprovarOrcamento   = "";
        $reprovarOrcamento  = "";

    } else {
        $text_status = "Sem Orçamento";
    }
    $color = 'black';
    if ($aprovado == 't') {
        $enviarOrcamento    = "disabled";
        $aprovarOrcamento   = "disabled";
        $reprovarOrcamento   = "";
        $text_status = "Orçamento Aprovado";
        $color = 'green';
    }
    if ($aprovado == 'f') {
        $enviarOrcamento    = "";
        $aprovarOrcamento   = "";
        $reprovarOrcamento   = "disabled";
        $text_status = "Orçamento Reprovado";
        $color = 'red';
    }
    ?>
    <script>
        function shadowbox_orcamento_chamado(){//IBBL
            var hd_chamado = $('#btn_orcamento_chamado').data('chamado');
            Shadowbox.open({
                content: "shadowbox_orcamento_hd_chamado.php?chamado=" + hd_chamado,
                player: "iframe",
                width: 900,
                height: 450
            });
        }
        function aprovar_orcamento(){
            $.get(
                '../externos/aquarius/orcamento_hd_chamado.php?orcamento=<?=$orcamento?>&resposta=aprovado&admin_callcenter=true',
                function(retorno) {
                 $('#btn_aprovar_orcamento').attr('disabled', 'disabled');
                 $('#btn_orcamento_chamado').attr('disabled', 'disabled');
                 $('#btn_reprovar_orcamento').removeAttr('disabled');
                 $('#status_orcamento').css('color', 'green');
                 $('#status_orcamento').html("Orçamento Aprovado");
                }
            );
        };
        function reprovar_orcamento(){
            $.get(
                '../externos/aquarius/orcamento_hd_chamado.php?orcamento=<?=$orcamento?>&resposta=reprovado&admin_callcenter=true',
                function(retorno) {
                 $('#btn_aprovar_orcamento').removeAttr('disabled');
                 $('#btn_orcamento_chamado').removeAttr('disabled');
                 $('#btn_reprovar_orcamento').attr('disabled', 'disabled');
                 $('#status_orcamento').css('color', 'red');
                 $('#status_orcamento').html("Orçamento Reprovado");
                }
            );
        };
    </script>
    </Br>
    <table width="100%" border="0" align="center" cellpadding="2" cellspacing="2" style=" border:#5AA962 1px solid; background-color:#D1E7D3;font-size:10px">
    <tr>
        <td align="center" colspan="2">
            <h1>Orçamento</h1>
        </td>
    </tr>
    <tr>
        <td align="center" colspan="2">
            <h1 id="status_orcamento" style='color: <?=$color?>;text-align: center;'><?=$text_status?></h1>
        </td>
    </tr>
    <tr>
        <td align="center">
            <button type="button" class="btn btn-large btn-primary" <?=$enviarOrcamento?> id="btn_orcamento_chamado" data-chamado="<?=$_GET['callcenter']?>" onclick="shadowbox_orcamento_chamado()" rel="2"><i class="icon-picture icon-white"></i><b>Enviar Orçamento</b></button>
        </td>
        <td align="center">
            <button type="button" class="btn btn-large btn-primary" <?=$aprovarOrcamento?> id="btn_aprovar_orcamento" onclick="aprovar_orcamento()" rel="2"><i class="icon-picture icon-white"></i><b>Aprovar Orçamento</b></button>
            <button type="button" class="btn btn-large btn-primary" <?=$reprovarOrcamento?> id="btn_reprovar_orcamento" onclick="reprovar_orcamento()" rel="2"><i class="icon-picture icon-white"></i><b>Reprovar Orçamento</b></button>
        </td>
    </tr>
    </table>
<?php
}
?>
<!-- FIM HD-4314164 ELEOTERIO -->
<tr>
    <td colspan='5'>
        <?php

        ### 94971
        if (strlen($_GET['Id']) > 0) {
            $id_x = $_GET['Id'];
        } else {
            $id_x = "";
        }

        if (strlen($callcenter) > 0 OR strlen($id_x) > 0) {
            ### respostas do chamado
            $_hd_chamado = (strlen($id_x) > 0 AND strlen($_GET['herdar']) > 0 AND $login_fabrica == 59) ? $id_x : $callcenter;

            $integraInstagram = false;
            if ($atendimentoIG === true) {
                $qCamposAdicionais = "SELECT
                    thce.array_campos_adicionais,
                    thco.descricao
                FROM tbl_hd_chamado_extra thce
                JOIN tbl_hd_chamado_origem thco ON thco.hd_chamado_origem = thce.hd_chamado_origem
                WHERE hd_chamado = {$callcenter}";
                $resCamposAdicionais = pg_query($con, $qCamposAdicionais);
                if (pg_num_rows($resCamposAdicionais) > 0 && strlen(pg_last_error()) === 0) {
                    $integracaoCamposAdicionais = pg_fetch_result($resCamposAdicionais, 0, 'array_campos_adicionais');
                    $integracaoOrigem = pg_fetch_result($resCamposAdicionais, 0, 'descricao');

                    $integracaoCamposAdicionais = json_decode($integracaoCamposAdicionais, true);
                }

                if ($integracaoOrigem == "Instagram" && array_key_exists('instagram', $integracaoCamposAdicionais)) {
                    $integraInstagram = true;
                }
            }

            if($integracaoTelefonia === true) {
                ## funcao declarada em 'assist/www/helpdesk.inc.php'
                $aRespostas = hdBuscarRespostas($_hd_chamado, false, true, true);
            } elseif ($integraInstagram) {
                $aRespostas = hdBuscarRespostas($_hd_chamado, false, true, false, true);
            } else {
                ## funcao declarada em 'assist/www/helpdesk.inc.php'
                $aRespostas = hdBuscarRespostas($_hd_chamado, false, true);
            }
        ?>

            <br />
            <table cellpadding="2" cellspancing="1" border="0" class="tabela" style="width: 100%; margin: 0 auto; border: #485989 1px solid; font-size: 10px; margin-bottom: 10px;" >
                <tr>
					<th class="titulo_coluna">nº</th>
					<th class="titulo_coluna">Data</th>
					<th class="titulo_coluna">Usuário</th>
                <?php if($login_fabrica == 24) { ?>
                    <th class="titulo_coluna">Situação/Protocolo</th>
                <?php } else { ?>
                    <th class="titulo_coluna">Situação</th>
                <?php } ?>
					<th class="titulo_coluna">Descrição</th>
				<?php if($login_fabrica == 1) { ?>
					<th class="titulo_coluna">Imagem</th>
				<?php }
                    if ($integracaoTelefonia === true) { ?>
                    <th class="titulo_coluna">Ligação</th>
                <?php }
                    if ($integraInstagram) {
                ?>
                    <th class="titulo_coluna">AçÃµes</th>
                <?php } ?>
				</tr>
        <?php

            $count_interacao = 1;
            foreach ($aRespostas as $iResposta=>$aResposta) {
                if (!is_null($aResposta['id_integracao'])) {
                    if ($integraInstagram) {
                        $integracaoData = json_decode($aResposta['id_integracao'], true);
                        if ($integracaoData['is_node'] === false) {
                            continue;
                        }
                    }
                }

                if ($aResposta['comentario']) {
        ?>
                    <tr>
                        <td align="center"><strong><?=$iResposta + 1?></strong></td>
                        <td align="center" nowrap="nowrap">
                            <?=$aResposta['data']?> <?=($login_fabrica == 74) ? "(GMT -3)" : ""?>
                        </td>
                        <td align="center">
                            <strong><?=((!empty($aResposta['atendente'])) ? ((!empty($aResposta['nome_completo']) && !in_array($login_fabrica, array(30))) ? $aResposta['nome_completo'] : $aResposta['atendente']) : $aResposta['posto_nome'])?></strong>
                        </td>
                        <td style="text-align: center; font-weight:bold; font-size: 10px;">
                            <?php
                                echo $aResposta['status_item'];
                                if($login_fabrica == 24 and strlen($aResposta['tincaso']) > 0){
                                    echo "/". $aResposta['tincaso'];
                                }
                            ?>
                        </td>
                        <td valign="top" style="padding: 5px !important;">
                        <?php if ($aResposta['interno'] == "t") {
                            if($login_fabrica != 74){
                        ?>
                                <table width="100%" style="margin-bottom: 5px !important;">
                                    <tr>
                                        <td style="text-align: center; font-weight:bold; font-size: 10px; background-color: #EFEBCF; padding: 5px;" valign="top">
                                            Chamado Interno
                                        </td>
                                    </tr>
                                </table>
                        <?php
                            }
                        }
                        ?>
                        <?php
                            if (in_array($login_fabrica, [186])) {
                                $respostaBase64 = $aResposta['comentario'];
                                $respostaBase64 = explode('Enviado via Email:', $respostaBase64);
								if(strpos($respostaBase64[1],'<br>') !== false) {
									$respostaBase64 = explode('<br>', $respostaBase64[1]);
								}

                                if (base64_decode(trim($respostaBase64[1]), true)) {
                                    $aResposta['comentario'] = 'Enviado via Email: ' . base64_decode($respostaBase64[1]);
                                }

                                $aResposta['comentario']     = mb_detect_encoding($aResposta['comentario'],'UTF-8', true) ? utf8_decode($aResposta['comentario']) : $aResposta['comentario'];
                            }
                        ?>
                        <?= stripslashes(nl2br($aResposta['comentario']))?>
                        </td>

                        <?php if ($login_fabrica == 1) { ?>
                        <td style="text-align: center; width: 50px;" valign="middle" >
                        <?php
                            $file = hdNomeArquivoUpload($aResposta['hd_chamado_item']);

                            if (empty($file)) {
                                echo '&nbsp';
                            } else {
                        ?>
                                <a href="<?=TC_HD_UPLOAD_URL.$file?>" target="_blank" >
                                    <img src="../helpdesk/imagem/clips.gif" alt="Baixar Anexo" />
                                    Baixar Anexo
                                </a>
                        <?php
                            }
                        ?>
                        </td>
                        <?php
                        }

                        if ($integracaoTelefonia === true) {
                            if (!empty($aResposta["id_ligacao"])) {
                        ?>
                                <td align="center"><button type='button' class="input" id="ouvirgravacao" onclick='ouvir_gravacoes("<?=$aResposta["id_ligacao"]?>")'>Baixar Gravação</button></td>
                        <?php
                            } else {
                        ?>
                                <td>&nbsp;</td>
                        <?php
                            }
                        }

                        if ($integraInstagram && !empty($integracaoData)) {
                        ?>
                            <td align="center">
                                <a
                                    href="javascript:void(0)"
                                    class="replyComentarioInstagram"
                                    onclick="toggleInstagramComment(this, '<?= $callcenter ?>', '<?= $login_admin ?>', '<?= $integracaoCamposAdicionais['instagram']['business_account'] ?>', '<?= $integracaoData['comment_id'] ?>')"
                                >
                                    <i class="far fa-comment" style="font-size:18px"></i>
                                </a>
                            </td>
                        <?php
                        } elseif ($integraInstagram && empty($integracaoData)) {
                        ?>
                            <td align="center">&nbsp;</td>
                        <?php } ?>
                    </tr>
            <?php
                $count_interacao++;
            }
        }
            echo "</table>";

        unset($aRespostas,$iResposta,$aResposta,$_hd_chamado);

            if ($login_fabrica == 59 AND strlen($admin_abriu) > 0) { // HD 52082 14/11/2008
                $sqlAdm = " SELECT login
                            FROM tbl_admin
                            WHERE fabrica = $login_fabrica AND admin = $admin_abriu";
                $resAdm = pg_query($con, $sqlAdm);

                if (pg_num_rows($resAdm ) > 0) $login_abriu = pg_fetch_result($resAdm, 0, $login);

                echo "<div style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>";
                    echo "<b>CHAMADO ABERTO PELO ATENDENTE: " . $login_abriu."</b>";
                echo "</div>";
            }
        }

    ?>
    </td>
</tr>
<tr>
    <td align='center' colspan='5'>
    <? if($login_fabrica == 3){ ?>
        <table width="100%" border='0'>
            <tr>
                <td align='left'><strong>Mapa da Rede</strong></td>
            </tr>
        </table>
        <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#485989 1px solid; background-color: #e6eef7;font-size:10px;padding-left:4px;'>
            <tr>
                <td align='left' width='50'><strong>Linha:</strong></td>
                <td align='left'>
                <?
                $sql = "SELECT  *
                        FROM    tbl_linha
                        WHERE   tbl_linha.fabrica = $login_fabrica
                        ORDER BY tbl_linha.nome;";
                $res = pg_query ($con,$sql);

                if (pg_num_rows($res) > 0) {
                    echo "<select name='mapa_linha'a id='mapa_linha' class='frm'>\n";
                    echo "<option value=''>Escolha</option>\n";
                    for ($x = 0 ; $x < pg_num_rows($res) ; $x++){
                        $aux_linha = trim(pg_fetch_result($res,$x,linha));
                        $aux_nome  = trim(pg_fetch_result($res,$x,nome));

                        if ($linha == $aux_liha){
                            $selected_linha = "SELECTED";
                            $mostraMsgLinha = "<br> da LINHA $aux_nome";
                        }
                        echo "<option value='$aux_linha' $selected_linha >$aux_nome</option>\n";
                    }
                    echo "</select>\n&nbsp;";
                }
                ?>
                </td>
                <td align='left' width='50'><strong>Estado:</strong></td>
                <td align='left'>


                    <select name='mapa_estado' id='mapa_estado'>
                        <option value='00'         >Todos</option>
                        <option value='SP' selected>São Paulo</option>
                        <option value='RJ'         >Rio de Janeiro</option>
                        <option value='PR'         >Paraná</option>
                        <option value='SC'         >Santa Catarina</option>
                        <option value='RS'         >Rio Grande do Sul</option>
                        <option value='MG'         >Minas Gerais</option>
                        <option value='ES'         >EspÃ­rito Santo</option>
                        <option value='BR-CO'      >Centro-Oeste</option>
                        <option value='BR-NE'      >Nordeste</option>
                        <option value='BR-N'       >Norte</option>
                    </select>
                <td align='left' width='50'><strong>Cidade:</strong></td>
                <td align='left'><input type='text' id='mapa_cidade' name='mapa_cidade' value='<?=$mapa_cidade?>'>

                    <input type='button' name='btn_mapa' value='mapa' onclick='javascript:mapa_rede(mapa_linha,mapa_estado,mapa_cidade)'>
                    </font>
                </td>
            </tr>
            <tr>
                <td align='left'><strong>Código:</strong></td>
                <td align='left'>
                    <input name="codigo_posto_tab" id="codigo_posto_tab"  class="input" value='<?echo $codigo_posto_tab;?>'  type="text" size="15" maxlength="15">
                </td>
                <td align='left'><strong>Nome:</strong></td>
                <td align='left'>
                    <input type='hidden' name='posto_tab' value="<? echo $posto_tab; ?>">
                    <input name="posto_nome_tab" id="posto_nome_tab"  class="input" value='<?echo $posto_nome_tab ;?>'  type="text" size="35" maxlength="500">
                </td>
            </tr>

            <tr>
                <td colspan='6'>
                <?
                if(strlen($callcenter)==0){
                    echo "<tr><td align='left' colspan='6'>";
                    if (in_array($login_fabrica, array(30,50,158,190))) {
                        echo "<strong><input type='checkbox' name='abre_os' id='abre_os' value='t' onClick='verificarImpressao(this)'> Abrir OS para esta Autorizada</strong>";
                    }else{
                        echo "<strong><input type='checkbox' name='abre_os' id='abre_os' value='t' onClick='verificarImpressao(this)'> Abrir PRE-OS para esta Autorizada</strong>";
                    }
                    
                    if (!in_array($login_fabrica, array(190,195))) {
                        echo "<div id='imprimir_os' style='display:none'><strong>&nbsp;&nbsp;&nbsp;&nbsp;<input type='checkbox' name='imprimir_os' value='t'> Imprimir OS</strong></div>";
                    }
                    echo "</td></tr>";
                }
                ?>
                </td>
            </tr>
            </table>
            <BR>
        <? } ?>

    <?php
    if ($login_fabrica == 11 or $login_fabrica == 172) {
    ?>
        <br />
        <table border="0" cellpadding="2" cellspacing="2" style="width: 100%; margin: 0 auto; border: #A95F5A 1px solid; background-color: #E7D1D2; font-size: 10px;" >
            <tr>
                <td style="center; width: 250px; font-weight: bold;" >
                    Data programada para resolver este atendimento:
                </td>
                <td>
                    <input type="text" class="frm" rel="data" name="data_programada" style="width: 80px;" value="<?=$data_programada?>" />
                </td>
            </tr>
        </table>
        <br />
    <?php
    }
    ?>
</td>
</tr>
<?php
if (strlen($callcenter) > 0) {
    if (!in_array($login_fabrica, array(169,170))) {

?>

    <tr>
        <td align='center' colspan='5'>
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" id="continuar_chamado" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
                <tr>
                    <td align='right' width='150'></td>
                    <td align='right' width='55'><img src='imagens/ajuda_call.png' align=absmiddle></td>
                    <td align='center'><STRONG>Posso ajudá-lo(a) em algo mais Sr.(a)?</STRONG><BR>
                    </td>
                    <td align='right' width='150'></td>
                </tr>
                <tr>
                    <td align='right' width='150'></td>
                    <td align='right' width='55'></td>
                    <td align='center'>
                        <input type="hidden" name="hd_chamado_anterior" value="<?=$_POST['hd_chamado_anterior']?>" id="chamado_anterior" /><?php
                            //HD 94971 acrescentei um botão que pergunta se quer enviar o históico ou não
                            if ($login_fabrica == 59) {?>

                                <script>
                                    function questiona(){
                                        {
                                            var name=confirm("VÃµcê deseja herdar o histórico desse chamado?")
                                            if (name==true)
                                            {
                                                window.location='<?=$PHP_SELF?>?Id=<?echo $callcenter;?>&herdar=sim';
                                            }
                                            else
                                            {
                                                window.location='<?=$PHP_SELF?>?Id=<?echo $callcenter;?>';
                                            }
                                        }
                                    }
                                </script>
                                <input  class="input"  type="button" name="bt" value='Sim' onclick="javascript:questiona();"><?php

                            } else if(in_array($login_fabrica, array(24, 52, 74, 90, 114, 115, 122,123, 125, 147, 160, 187, 188, 189)) && $status_interacao == 'Resolvido') { //hd_chamado=2710901 LIBERADO PARA FABRICA 115

                                ?>

                                <script>
                                    function questiona(){
                                        {
                                            var name=confirm("Dar continuidade ao chamado atual?")

                                            if (name==true)
                                                {
                                                window.location='<?=$PHP_SELF?>?Id=<?echo $callcenter;?>&continuar_chamado=sim';
                                            }
                                            else
                                            {
                                                window.location='<?=$PHP_SELF?>?Id=<?echo $callcenter;?>';
                                            }
                                            document.getElementById('bt_final').disabled = true;
                                        }
                                    }

                                </script>
                                <input  class="input" id="bt_final" type="button" name="bt" value='Sim' onclick="javascript:questiona();"><?php

                            } else {?>

                                <input  class="input"  type="button" name="bt" value='Sim' onclick="javascript:window.location='<?=$PHP_SELF?>?Id=<?echo $callcenter;?>';"><?php

                            }?>
                        <input  class="input"  type="button" name="bt" value='Não' onclick="javascript:window.location='<?=$PHP_SELF?>';">
                    </td>
                    <td align='right' width='150'></td>
                </tr>
            </table>
            <bR>
        </td>
    </tr>
    <?php } ?>
    <tr>
        <td>

        <?php
        /**
         * PESQUISA DE SATISFAÃÃO CALLCENTER FRICON
         */
        if ($login_fabrica == 52 and strtoupper($status_interacao) == 'RESOLVIDO'){ ?>

            <table>
                <tr>
                    <td>
                        <strong>PESQUISA COM CLIENTE</strong>
                    </td>
                </tr>
            </table>

            <?php
            /**
             * Verifica se o chamado ja existe resposta cadastrada do formato antigo (com tbl_resposta.pesquisa null) e exibe o formato antigo
             * sempre que tiver um chamado ja antigo com respostas na
             * tbl_resposta irá incluir o formulario antigo e exibir as respostas
             * visto que, o processo novo de exibição/cadastro da pesquisa é totalmente diferente do antigo.
             */

            $sql_verifica_antigo = "SELECT count(tbl_resposta.*)
                        from tbl_resposta
                        join tbl_pergunta using(pergunta)
                        WHERE tbl_pergunta.fabrica = $login_fabrica
                        AND tbl_resposta.pesquisa is null
                        AND tbl_resposta.hd_chamado = $callcenter";
            $res_verifica_antigo = pg_query($con,$sql_verifica_antigo);

            $qtde_respostas_antigo = pg_fetch_result($res_verifica_antigo, 0, 0);

            if ($qtde_respostas_antigo > 0) {


                include_once "form_pesquisa_callcenter_antigo.php";

            }else{
            ?>
                <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>

                    <tr>
                        <td>
                            <?php
                            /**
                             * VERIFICA SE O CHAMADO JA POSSUI PESQUISA RESPONDIDA.
                             * SE POSSUIR NAO PODE DEXAR GRAVAR NOVAS RESPOSTAS E
                             * DEVE MOSTRAR AS OPÃÃES JA PREENCHIDAS
                             */

                            $sql = "SELECT pesquisa  from tbl_resposta where hd_chamado = $callcenter";
                            $res = pg_query($con,$sql);
                            if (pg_num_rows($res)>0) {
                                $pesquisa_respondida = pg_fetch_result($res,0,0);
                                $disabled_pesquisa_respondida = ' disabled="DISABLED"';

                            }else{
                                $pesquisa_respondida = '';
                            }

                            $sql = "SELECT pesquisa, descricao FROM tbl_pesquisa where fabrica = $login_fabrica and categoria = 'callcenter' and ativo is true";
                            $res = pg_query($con,$sql);

                            foreach (pg_fetch_all($res) as $key) {

                                $checked_pesquisa_respondida = ($key['pesquisa'] == $pesquisa_respondida) ? 'checked="CHECKED"' : '' ;
                                echo $key['descricao']." ";
                                ?>
                                <input type="radio" name="pesquisa_fricon" id="pesquisa_<?echo $key['pesquisa']?>" value="<?echo $key['pesquisa']?>" rel="<?echo $key['descricao']?>" <?php echo $checked_pesquisa_respondida.$disabled_pesquisa_respondida?> > <br>
                                <?

                            }
                            ?>
                        </td>
                    </tr>
                </table>

                <div class='errorPergunta' style='background-color:#F92F2F;color:#FFF;font:bold 14px Arial'></div>

                <div class='divTranspBlock' style='margin-top:57px;margin-left:378px;display:none;background-color:#000;position:absolute; z-index:1;width:900px;height:295px;opacity:0.65;-moz-opacity: 0.65;filter: alpha(opacity=65);'>
                </div>

                <div id="div_pesquisa" style="width:100%;border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px;display:none">

                </div>

                <div class='agradecimentosPesquisa' style='display:none'>
                    <p >
                        Gravado com Sucesso
                    </p>
                    <p>
                        BOM......EM NOME DA <b>FRICON</b>, GOSTARIAMOS DE AGRADECER SUA ATENÃÃO, E DESEJAMOS-LHE UM EXCELENTE DIA.
                    </p>
                </div>

            <?
            }

            ?>


        <?php
        }
        if(in_array($login_fabrica, array(30,35,85,88,94,129,145,157,161))){
            if((in_array($login_fabrica, array(35,85,94,129,145,157,161)) && strtoupper($status_interacao) == 'RESOLVIDO' && strlen($msg_erro) == 0) or ($login_fabrica == 138)){
    ?>
                    <?php
                    if($login_fabrica == 94){ //hd_chamado=2414398

                        $sqlResposta = "SELECT tbl_resposta.pesquisa
                                                FROM tbl_resposta
                                                JOIN tbl_pesquisa USING (pesquisa)
                                                WHERE tbl_resposta.hd_chamado = $callcenter
                                                AND tbl_pesquisa.categoria LIKE 'callcenter%'";
                        $resResposta = pg_query($con, $sqlResposta);
                        if(pg_num_rows($resResposta) > 0){
                            $pesquisaSelecionada = pg_fetch_result($resResposta, 0, 'pesquisa');
                            $displayNone = "display:none;";
                        }

                            $sqlPesquisa = "SELECT  tbl_pesquisa.pesquisa,
                                                            tbl_pesquisa.descricao,
                                                            tbl_pesquisa.ativo
                                                    FROM tbl_pesquisa
                                                    WHERE tbl_pesquisa.fabrica = $login_fabrica
                                                    AND tbl_pesquisa.ativo IS TRUE
                                                    AND tbl_pesquisa.categoria LIKE 'callcenter%'";
                            $resPesquisa = pg_query($con, $sqlPesquisa);
                ?>
                <br /><div id="questionario" style="text-align:center;width:100%;height:100px;background-color: #596D9B;">

                        <div style='text-align: center; <?=$displayNone?>' id='seleciona_pesquisa'><br/>
                                <span style='font-size:14px; color:#FFF;'>Selecione o Tipo de pesquisa</span><br/>
                                <select name="tipo_pesquisa_callcenter" id="tipo_pesquisa_callcenter" style="width:205px; font-size:12px; height:20px; border-radius:3px;" class="input" >
                                    <?php
                                        for ($i = 0; $i < pg_num_rows($resPesquisa);$i++){
                                            $pesquisaID     = pg_result($resPesquisa,$i,'pesquisa');
                                            $pesquisaDesc   = pg_result($resPesquisa,$i,'descricao');
                                            $selected_pesquisa = ($pesquisaID == $pesquisaSelecionada) ? "SELECTED" : null;
                                    ?>
                                                <option value="<?=$pesquisaID?>" <?echo $selected_pesquisa?> ><?echo $pesquisaDesc?></option>
                                    <?php
                                        }
                                    ?>
                                </select>
                            </div><br/>
                            <span onclick="fnc_pesquisa_satisfacao(<?=$callcenter?>)" style="vertical-align:middle;cursor:pointer;color:#FFF; font-size:14px">Pesquisa de Satisfação</span>
                <?php
                } elseif (in_array($login_fabrica, array(35,157)) && $pesquisaSatisfacao) {

                    $token_pesquisa = sha1($login_fabrica.$callcenter);

                ?>
                    <br />
                    <div id="questionario" style="text-align:center;width:100%;">
                        <div onclick="fnc_pesquisa_satisfacao_new('<?= $token_pesquisa?>', <?= $callcenter?>, 'email')" style="width:48%;float:left;background-color: #596D9B;vertical-align:middle;cursor:pointer;color:#FFF; font-size:18px;font-weight: bold;padding: 7px;">
                            Pesquisa de Satisfação E-mail
                        </div>
                          <div onclick="fnc_pesquisa_satisfacao_new('<?= $token_pesquisa?>', <?= $callcenter?>, 'callcenter')" style="width:48%;float:right;background-color: #596D9B;vertical-align:middle;cursor:pointer;color:#FFF; font-size:18px;font-weight: bold;padding: 7px;">
                            Pesquisa de Satisfação
                        </div><br /><br />

                <?php }else{ ?>

                            <br /><div id="questionario" style="text-align:center;width:100%;height:40px;background-color: #596D9B;">
                            <span onclick="fnc_pesquisa_satisfacao(<?=$callcenter?>)" style="vertical-align:middle;cursor:pointer;color:#FFF; font-size:14px">Pesquisa de Satisfação</span>

                <?php } ?>
            </div> <br />
<?
            }
        }

        ?>

        </td>
    </tr>
    <tr>
        <td align='center' colspan='5'>
            <br>
            <table width='100%' border='0' align='center' cellpadding="2" cellspacing="2" style=' border:#CC3300 1px solid; background-color: #F4E6D7;font-size:10px'>
                <tr>
                    <td align='right' width='150'></td>
                    <td align='right' width='55'><img src='imagens/ajuda_call.png' align=absmiddle></td>
                    <td align='center'>
                        <STRONG>FINALIZAR LIGAÃÃO</STRONG><BR>
                        A <?echo "$nome_da_fabrica";?> agradece a sua ligação, tenha um(a) <?echo saudacao();?>.
                    </td>
                    <td align='right' width='150'></td>
                </tr>
            </table>
        </td>
    </tr>
    <tr>
        <td colspan="5" style="text-align: center;">
            <br />
            <div style="margin: 0 auto; text-align: center;">
                <a href='callcenter_interativo_print.php?callcenter=<?echo $callcenter;?>' target='_blank' style='font-size:14px; font-family:arial;'>
                    <img src='imagens/img_impressora.gif'>
                    Imprimir
                </a>
            </div>
        </td>
    </tr>
<?php
}

?>
</table>
</form>
<input type="hidden" class="address_url" value="callcenter_interativo_new">
<script language='javascript' src='address_components.js?time=<?=time()?>'></script>
<style>
    select, textarea, input, .input, .ac_input, .frm, .frm-on, .input_req, .input_req2{
        font-family: arial !important,
        font-size: 12px !important;
        font-weight: normal !important;
        padding: 3px 5px !important;
        background: #fff !important;
        border: 1px solid #999 !important;
    }

    input, textarea, keygen, select{
        font: 10px arial !important;
    }

    input[type="button"]{
        font-family: arial !important;
        font-size: 12px !important;
    }
    input[type="file"]{
        font-family: arial !important;
        font-size: 12px !important;
        padding: 1px !important;
    }
    table, table tr, table tr td{
        font-family: arial !important;
        font-size: 12px !important;
    }
    form table tr td{
        padding-bottom: 1px !important;
    }
    body{
        font-family: arial !important;
        padding: 0px 4px !important;
    }
    .titulo_coluna{
        padding: 3px;
    }
    select.datepick-month-year{
        color: #666 !important;
        height: 20px !important;
    }

    <?php if (in_array($login_fabrica, array(169,170))){ ?>
    .td_midea_carrier {
        padding-left: 160px;
    }
    <?php } ?>
    .msg_prazo_dias{
        margin-top: 5px;
        display: inline-block;
        padding: 2px 4px;
        font-size: 11.844px;
        font-weight: bold;
        line-height: 14px;
        color: #ffffff;
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        white-space: nowrap;
        vertical-align: baseline;
        background-color: #b94a48;
        border-radius: 5px;
    }

    .obs_interno{
        display: inline-block;
        padding: 2px 4px;
        font-size: 11.844px;
        font-weight: bold;
        line-height: 14px;
        color: #ffffff;
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        white-space: nowrap;
        vertical-align: baseline;
        background-color: #3a87ad;
        border-radius: 5px;
    }

    .classificacao_email{
        margin-left: 11%;
        margin-top: 5px;
        display: inline-block;
        padding: 3px 7px;
        font-size: 11.844px;
        font-weight: bold;
        line-height: 14px;
        color: #ffffff;
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        white-space: nowrap;
        vertical-align: baseline;
        background-color: #b94a48;
        border-radius: 5px;
    }


    .permissao_supervisor{
        display: block;
        margin-top: 5px;
        padding: 4px 12px;
        font-size: 12px !important;
        cursor: pointer;
        background-color: #f5f5f5;
        border-radius: 4px;
        color: #ffffff;
        background-color: #006dcc;
        background-repeat: repeat-x;
        border-color: #0044cc #0044cc #002a80;
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    }
</style>

<?php
if(in_array($login_fabrica, array(169,170)) OR $usaScriptFalha){
    include "../plugins/rappid/script_midea_callcenter.php";
}
include "rodape.php";?>
<?php

function buscaChamado($hd_chamado){
    global $con;
    global $login_fabrica;
    $sql = ' SELECT * FROM tbl_hd_chamado WHERE hd_chamado = $1;';
    $result = pg_query_params($con,$sql,array($hd_chamado));
    if(!$result || pg_num_rows($result) != 1)
        throw new Exception("Chamado não Encontrado\n".pg_last_error($con));
    return pg_fetch_assoc($result);
}

function buscaAdmin($admin){
    global $con;
    global $login_fabrica;
    $sql = 'SELECT * FROM tbl_admin WHERE admin = $1 AND fabrica = $2;';
	$result = pg_query_params($con,$sql,array($admin,$login_fabrica));

    return pg_fetch_assoc($result);
}

function enviaEmail($mail){
    global $externalId;
    if (!is_object($mailTc))
        $mailTc = new TcComm($externalId);

    $mailTc->sendMail($mail['to'], $mail['subject'], $mail['body'], $mail['from']);
}

function montaEmail($chamado,$newAdmin,$interacao=''){
    global $externalEmail;

    $oldAdmin = buscaAdmin($chamado['atendente']);
    $newAdmin = buscaAdmin($newAdmin);
    $mail['to'] = $oldAdmin['email'];
    $mail['from'] = $externalEmail;
    $body = $oldAdmin['nome_completo'].",<br />";
    $body.= 'o chamado '.$chamado['hd_chamado'].' sofreu uma interação realizada por '.$newAdmin['nome_completo'].".<br /><br />";
    $body.= "Interação:<br />";
    $body.= $interacao;
    $mail['body'] = $body;
    $mail['subject'] = 'Seu chamado foi Alterado : '.$chamado['hd_chamado'];
    return $mail;
}

function Valida_Data($dt){
    $data = explode("/","$dt");
    $d = $data[0];
    $m = $data[1];
    $y = $data[2];

    $res = checkdate($m,$d,$y);
    if ($res == 1){
       return "ok";
    } else {
       return "erro";
    }
}

if ($login_fabrica == 24 && isset($_GET['novo_hd'])) { ?>
<script>
        $(function(){
            $("body #container-Principal > ul.tabs-nav > li").each(function(){
                if($(this).hasClass("tabs-disabled")){
                    $(this).removeClass("tabs-disabled");
                }
            });
        });
</script>
<?php } ?>

<?php if($login_fabrica == 30) {?>   <script>
        function logomarca_select() {
            var select = document.getElementById('hd_classificacao');
	        var classificacao = select.options[select.selectedIndex].value;

            if(classificacao == 49){
                $('#logomarca_titulo').css('display', 'block');
                $('#logomarca_select').css('display', 'block');
            }else{
                $('#logomarca_titulo').css('display', 'none');
                $('#logomarca_select').css('display', 'none');
            }
        }
        $(document).ready(function() {
            logomarca_select()
        })
    </script>
<?php } ?>


<? if($login_fabrica == 151)  :?>   

<script type="text/javascript">  

    var _self_voucher = this;
    var linha_voucher = '';

    $(document).ready(function(){

        var qtde_produtos = $('#qtde_produto').val();
        var counter = 1;
        preencheSelects();

        function preencheSelects(){

            if(counter > qtde_produtos){
                return false;
            }

            var produto_referencia = $("#produto_referencia_" + counter).val();

            if(produto_referencia != ""){

                var select = $("#voucher_familia_" + counter);
                var familia_selected = select.data('familia');

                 $.ajax({
                    url: 'callcenter_interativo_new.php',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        ajax_busca_familias_produto : true,
                        referencia_produto_familia : produto_referencia
                    },
                    success : function(response){
                        addOptionsSelectFamilia(response, counter, familia_selected);
                        counter++;
                        preencheSelects();
                    }
                });
            }
        }

        for(var i=1; i <= qtde_produtos; i++){

            var btn_gerar = $("#btn_gerar_voucher_" + i);

            if(btn_gerar[0] != undefined){
                btn_gerar.on("click", function(){
                     gerarVoucher(this);
                })
            }
        }
    });

    function gerarVoucher(element){

        var linha = $(element).data('linha');
        _self_voucher.linha_voucher = linha;

        if($("#voucher_familia_" + linha).val() != ""){
            verificaInterventor(linha);
        }else{
            alert("Por favor informe a família do produto para gerar o voucher.");
        }      
    }

    function verificaInterventor(linha){

        Shadowbox.open({
            content: "verifica_interventor.php?permissao_supervisor=true&gerar_voucher=t",
            player: "iframe",
            width: 600,
            height: 250,
            options: {
                modal: true,
                enableKeys: false,
                displayNav: false
            }
        });
    }

    function retorna_permissao_supervisor_voucher(retorno){

        Shadowbox.close();

        if(retorno == 'login_supervisor'){


            if(_self_voucher.linha_voucher != ''){

                var voucher_familia = $("#voucher_familia_" + _self_voucher.linha_voucher);
                var voucher_codigo = $("#voucher_codigo_" + _self_voucher.linha_voucher);
                var voucher_id = $("#voucher_id_" + _self_voucher.linha_voucher)
          
                 $.ajax({
                    url: 'callcenter_interativo_new.php',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        ajax_busca_voucher_ativo : true,
                        familia_produto : voucher_familia.val()
                    },
                    success : function(response){
                        if(response.codigo){
                            voucher_codigo.val(response.codigo);
                            voucher_id.val(response.id_voucher);
                        }else{
                            alert("Voucher ativo não encontrado para essa família de produto.");
                        }
                    }
                });
             }    
        }
    }

    function addOptionsSelectFamilia(response, linha, familia_selected){

        var select = $("#voucher_familia_" + linha);

        if(!familia_selected){
           $("#voucher_codigo_" + linha).val(""); 
        }

        if(response.result){

            var result = response.result;

            // Verifica se o option não existe no select
            if (select.find('option[value="' +result.familia +'"]').length === 0){ 

                // Remove o option caso o usuário altera um produto já informado
                select.find('[data-linha="'+linha+'"]').remove();

                // Cria um novo option
                var option = new Option(result.descricao, result.familia);
                $(option).html(result.descricao);
                $(option).attr('data-linha', linha);

                if(familia_selected){
                    $(option).attr('selected', true);
                }
                select.append(option);
            } 
           
        }else{
            select.find('[data-linha="'+linha+'"]').remove();
        }    
    }

    // Função usada para recuperar as famílias do produto quando selecionado pelo shadowbox(iframe de pesquisa), pois
    // ao sair da busca por produtos, não é ativado nenhum evento do campo referência
    function buscaFamilias(element){

        var produto_referencia = false;

        // Recupera o parâmetro posição do content do shadowbox para  saber qual produto 
        // está sendo inserido, a mondial pode inserir mais de um produto
        if(element){
            var content = element.content;
            var pos = content.search("&pos=")+5;
            var linha = content.substr(pos, pos);
            var produto_referencia = $("#produto_referencia_" + linha);
        }
        
        if(produto_referencia){
            produto_referencia = produto_referencia.val();
        }

        if(produto_referencia){

             $.ajax({
                url: 'callcenter_interativo_new.php',
                type: 'POST',
                dataType: 'json',
                data: {
                    ajax_busca_familias_produto : true,
                    referencia_produto_familia : produto_referencia
                },
                success : function(response){
                    addOptionsSelectFamilia(response, linha);
                }
            });
        }else{
            $("#voucher_familia_" + linha).find('[data-linha="'+linha+'"]').remove();
            $("#voucher_codigo_" + linha).val("");
        }
    }
</script>

<? endif; ?>

<?php if ($login_fabrica == 161) { ?>
    <script type="text/javascript">
        $("#telefone5, #telefone6, #telefone7, .telefone5").each(function() {
            var valor = $(this).val().replace(/[^0-9]/g,'').length;

            if(valor <= 10 && valor != 0){
                $('#telefone5, #telefone6, #telefone7, .telefone').keydown(function(){
                    $(this).mask('(00) 00000-0000', $(this).val());
                })
                $(this).mask('(00) 0000-0000',  $(this).val()); /* Máscara default */
            } else if (valor == 11) {
                $(this).mask('(00) 00000-0000', $(this).val());  // 9Âº DÃ­gito
            }
        });

        $("#telefone5, #telefone6, #telefone7, .telefone5").blur(function() {
            var valor = $(this).val().replace(/[^0-9]/g,'').length;

            if(valor <= 10 && valor != 0){
                $('#telefone5, #telefone6, #telefone7, .telefone').keydown(function(){
                    $(this).mask('(00) 00000-0000', $(this).val());
                })
                $(this).mask('(00) 0000-0000',  $(this).val()); /* Máscara default */
            } else if (valor == 11) {
                $(this).mask('(00) 00000-0000', $(this).val());  // 9Âº DÃ­gito
            }
        });

        $("#telefone5, #telefone6, #telefone7, .telefone5").focus(function() {
            $(this).mask('999999999999999');
        });

        if ($("#cpf1").val().replace(/[^a-zA-Z 0-9]+/g,'').length <= 11 && $("#cpf1").val().replace(/[^a-zA-Z 0-9]+/g,'').length > 0) {
            $("#cpf1").mask('999.999.999-99');
        }

        $("#cpf1").blur(function() {
            var valor = $(this).val().replace(/[^a-zA-Z 0-9]+/g,'').length;

            if (valor <= 11) {
                $(this).mask('999.999.999-99');
            } else {
                $(this).mask('AAAAAAAAAAAAAAA');
            }
        });

        $("#cpf1").focus(function() {
            $(this).mask('AAAAAAAAAAAAAAA');
        });

        if ($("#consumidor_rg1").val().replace(/[^a-zA-Z 0-9]+/g,'').length <= 9 && $("#consumidor_rg1").val().replace(/[^a-zA-Z 0-9]+/g,'').length > 0) {
            $(this).mask('99.999.999-A');
        }

        $("#consumidor_rg1").blur(function() {
            var valor = $(this).val().replace(/[^a-zA-Z 0-9]+/g,'').length;

            if (valor <= 9) {
                $(this).mask('99.999.999-A');
            } else {
                $(this).mask('AAAAAAAAAAAAAAA');
            }
        });

        $("#consumidor_rg1").focus(function() {
            $(this).mask('AAAAAAAAAAAAAAA');
        });

    </script>
<?php } ?>
