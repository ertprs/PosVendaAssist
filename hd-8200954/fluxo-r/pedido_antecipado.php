<?include 'dbconfig.php';include 'includes/dbconnect-inc.php';include "autentica_usuario.php";$aba=2;include "cabecalho.php";?><script type="text/javascript" src="js/bibliotecaAJAX.js"></script><?$produto_rg = $_GET['produto_rg'];if (strlen ($produto_rg) == 0) $produto_rg = $_POST['produto_rg'];$produto_rg = str_replace ("'","",$produto_rg);if (strlen ($produto_rg) > 0) {	$sql = "SELECT TO_CHAR (data_digitacao,'DD/MM/YYYY') AS data_digitacao, pedido_antecipado FROM tbl_produto_rg where produto_rg = $produto_rg";	$res = pg_exec ($con,$sql);	$data_digitacao    = pg_result ($res,0,data_digitacao);	$pedido_antecipado = pg_result ($res,0,pedido_antecipado);	echo "<center><b>Pedido antecipado do lote $produto_rg - $data_digitacao</b></center>";	if (strlen ($pedido_antecipado) > 0) {		echo "<center><b>Pedido já realizado (#$pedido_antecipado) - Apenas conferência</b></center>";		echo "<br>";	}	echo "<br>";	$sql = "SELECT  tbl_produto.referencia, 					tbl_produto.descricao, 					tbl_produto.produto, 					x.qtde_produtos			FROM tbl_produto			JOIN (SELECT produto, COUNT(*) AS qtde_produtos FROM tbl_produto_rg_item WHERE produto_rg = $produto_rg GROUP BY produto) x ON tbl_produto.produto = x.produto			ORDER BY x.qtde_produtos DESC";				$res = pg_exec ($con,$sql);	echo "<center>Peças em vermelho estão bloqueadas para garantia</center>";	echo "<table align='center' border='1' cellspacing='0' cellpadding='15'>";	echo "<tr bgcolor='#99CCFF' align='center' height='20'>";	echo "<td><b>Referência</b></td>";	echo "<td><b>Descrição</b></td>";	echo "<td width='60'><b>Qtde</b></td>";	echo "<td><b>Peças</b></td>";	echo "<td><b>O.S.</b></td>";	echo "</tr>";	for ($i = 0 ; $i < pg_numrows ($res) ; $i++) {		$produto       = pg_result ($res,$i,produto);		$referencia    = pg_result ($res,$i,referencia);		$descricao     = pg_result ($res,$i,descricao);		$qtde_produtos = pg_result ($res,$i,qtde_produtos);		echo "<tr height='25' bgcolor='$cor' valign='top' 				onmouseover=\"this.style.cursor='pointer' ; this.bgColor='#cccccc'\" 				onmouseout=\"this.bgColor='$cor'\" ";		if (strlen ($pedido_antecipado) == 0) {			echo " onclick=\"div_lanca_pecaCarrega($produto_rg,$produto) ; div_lanca_peca.style.position='absolute' ; div_lanca_peca.style.left='300px' ; div_lanca_peca.style.top=(this.offsetTop+200) + 'px' ; div_lanca_peca.style.display='block' ; div_lanca_peca_rg.innerText='$qtde_produtos - $descricao' ; frm_lanca_peca.produto.value='$produto' ; frm_lanca_peca.produto_rg.value='$produto_rg' ; frm_lanca_peca.linha.value=$i ; frm_lanca_peca.peca_1.focus() \" ";		}		echo " >\n";		echo "<td>";		echo pg_result ($res,$i,referencia);		echo "</td>\n";		echo "<td>";		echo pg_result ($res,$i,descricao);		echo "</td>\n";		echo "<td align='right'>";		echo pg_result ($res,$i,qtde_produtos);		echo "</td>\n";		$sql = "SELECT tbl_produto_rg_pedido.qtde, tbl_peca.referencia, tbl_peca.descricao, tbl_peca.bloqueada_garantia FROM tbl_peca JOIN tbl_produto_rg_pedido USING (peca) WHERE tbl_produto_rg_pedido.produto_rg = $produto_rg AND tbl_produto_rg_pedido.produto = $produto ORDER BY tbl_produto_rg_pedido.produto_rg_pedido";		$resP = pg_exec ($con,$sql);		$pecas = "";		for ($p = 0 ; $p < pg_numrows ($resP) ; $p++) {			$bloqueada_garantia = pg_result ($resP,$p,bloqueada_garantia);			if ($bloqueada_garantia == "t") {				$pecas .= "<font color='red'><b>";			}			$pecas .= pg_result ($resP,$p,qtde) . " - " . pg_result ($resP,$p,referencia) ." - " . pg_result ($resP,$p,descricao) . "<br>";			if ($bloqueada_garantia == "t") {				$pecas .= "</b></font>";			}		}		echo "<td nowrap><span id='pecas_$i'>";		if (strlen ($pecas) > 0) {			echo $pecas ;		}else{			echo "&nbsp;";		}		echo "</span></td>\n";				#------ Lista as Ordens de Serviços geradas ------------		echo "<td>";		$sqlO = "SELECT tbl_os.sua_os FROM tbl_os JOIN tbl_produto_rg_item USING (os) WHERE tbl_produto_rg_item.produto_rg = $produto_rg AND tbl_produto_rg_item.produto = $produto ORDER BY os";		$resO = pg_exec ($con,$sqlO);		for ($o = 0 ; $o < pg_numrows ($resO) ; $o++) {			echo pg_result ($resO,$o,0);			echo "; ";		}		echo "</td>";		echo "</tr>\n";	}	echo "</table>\n";}?>	<!-- --------------------- DIV para Lançamento de Peças ------------------- --><script language='javascript'>function fn_alertar (texto) {	if (texto.length > 0){		if (texto.indexOf('<erro>') >= 0){			texto = texto.substring (texto.indexOf('>')+1,texto.length);			texto = texto.substring (0,texto.indexOf('</'));			alert (texto);		}	}}</script><script language='javascript'>function div_lanca_pecaLimpa() {	document.getElementById('produto').value = "";	document.getElementById('produto_rg').value = "";	document.getElementById('produto_rg_item').value = "";	document.getElementById('serie').value = "";	document.getElementById('defeito_reclamado').value = "";	document.getElementById('linha').value = "";	document.getElementById('peca_1').value = "";	document.getElementById('peca_2').value = "";	document.getElementById('peca_3').value = "";	document.getElementById('peca_4').value = "";	document.getElementById('peca_5').value = "";	document.getElementById('peca_6').value = "";	document.getElementById('peca_7').value = "";	document.getElementById('peca_8').value = "";	document.getElementById('peca_9').value = "";	document.getElementById('peca_10').value = "";	document.getElementById('qtde_1').value = "";	document.getElementById('qtde_2').value = "";	document.getElementById('qtde_3').value = "";	document.getElementById('qtde_4').value = "";	document.getElementById('qtde_5').value = "";	document.getElementById('qtde_6').value = "";	document.getElementById('qtde_7').value = "";	document.getElementById('qtde_8').value = "";	document.getElementById('qtde_9').value = "";	document.getElementById('qtde_10').value = "";}function div_lanca_pecaFecha() {	div_lanca_pecaLimpa();	div_lanca_peca.style.display='none';}function div_lanca_pecaCarrega (produto_rg, produto) {	requisicaoHTTP ('GET','div_lanca_peca_carrega_ajax.php?produto_rg=' + produto_rg + '&produto=' + produto , true , 'div_lanca_pecaCarregaCampos');}function div_lanca_pecaCarregaCampos (campos) {	campos = campos.substring (campos.indexOf('>')+1,campos.length);	campos = campos.substring (0,campos.indexOf('</'));	campos_array = campos.split("|");	document.getElementById('serie').value = campos_array[0] ;	document.getElementById('serie').defaultValue = campos_array[0] ;	document.getElementById('defeito_reclamado').value = campos_array[1] ;	document.getElementById('defeito_reclamado').defaultValue = campos_array[1] ;	peca_qtde = campos_array[2].split(";");	document.getElementById('peca_1').value        = peca_qtde[0] ;	document.getElementById('peca_1').defaultValue = peca_qtde[0] ;	document.getElementById('qtde_1').value        = peca_qtde[1] ;	document.getElementById('qtde_1').defaultValue = peca_qtde[1] ;	peca_qtde = campos_array[3].split(";");	document.getElementById('peca_2').value        = peca_qtde[0] ;	document.getElementById('peca_2').defaultValue = peca_qtde[0] ;	document.getElementById('qtde_2').value        = peca_qtde[1] ;	document.getElementById('qtde_2').defaultValue = peca_qtde[1] ;	peca_qtde = campos_array[4].split(";");	document.getElementById('peca_3').value        = peca_qtde[0] ;	document.getElementById('peca_3').defaultValue = peca_qtde[0] ;	document.getElementById('qtde_3').value        = peca_qtde[1] ;	document.getElementById('qtde_3').defaultValue = peca_qtde[1] ;	peca_qtde = campos_array[5].split(";");	document.getElementById('peca_4').value        = peca_qtde[0] ;	document.getElementById('peca_4').defaultValue = peca_qtde[0] ;	document.getElementById('qtde_4').defaultValue = peca_qtde[1] ;	document.getElementById('qtde_4').value        = peca_qtde[1] ;	peca_qtde = campos_array[6].split(";");	document.getElementById('peca_5').value        = peca_qtde[0] ;	document.getElementById('peca_5').defaultValue = peca_qtde[0] ;	document.getElementById('qtde_5').defaultValue = peca_qtde[1] ;	document.getElementById('qtde_5').value        = peca_qtde[1] ;	peca_qtde = campos_array[7].split(";");	document.getElementById('peca_6').value        = peca_qtde[0] ;	document.getElementById('peca_6').defaultValue = peca_qtde[0] ;	document.getElementById('qtde_6').defaultValue = peca_qtde[1] ;	document.getElementById('qtde_6').value        = peca_qtde[1] ;	peca_qtde = campos_array[8].split(";");	document.getElementById('peca_7').value        = peca_qtde[0] ;	document.getElementById('peca_7').defaultValue = peca_qtde[0] ;	document.getElementById('qtde_7').defaultValue = peca_qtde[1] ;	document.getElementById('qtde_7').value        = peca_qtde[1] ;	peca_qtde = campos_array[9].split(";");	document.getElementById('peca_8').value        = peca_qtde[0] ;	document.getElementById('peca_8').defaultValue = peca_qtde[0] ;	document.getElementById('qtde_8').defaultValue = peca_qtde[1] ;	document.getElementById('qtde_8').value        = peca_qtde[1] ;	peca_qtde = campos_array[10].split(";");	document.getElementById('peca_9').value        = peca_qtde[0] ;	document.getElementById('peca_9').defaultValue = peca_qtde[0] ;	document.getElementById('qtde_9').defaultValue = peca_qtde[1] ;	document.getElementById('qtde_9').value        = peca_qtde[1] ;	peca_qtde = campos_array[11].split(";");	document.getElementById('peca_10').value        = peca_qtde[0] ;	document.getElementById('peca_10').defaultValue = peca_qtde[0] ;	document.getElementById('qtde_10').defaultValue = peca_qtde[1] ;	document.getElementById('qtde_10').value        = peca_qtde[1] ;}</script><script language="JavaScript">function autocompletar(campo1,campo2, produto) {	$('#'+campo1).autocomplete("pesquisa.php?tipo=lista-basica&produto=" + produto, {		minChars: 3,		delay: 150,		width: 350,		scroll: true,		scrollHeight: 500,		matchContains: false,		highlightItem: true,		formatItem: function (row)   {return row[4]},		formatResult: function(row)  {return row[2];}	});	$('#'+campo1).result(function(event, data, formatted) {		$('#'+campo2).val(data[0])    ;		$('#'+campo1).focus() ;	});}</script><script language='javascript'>function lanca_peca_retorna_form (texto) {	var div_ok = false ;	if (texto.length > 0){		if (texto.indexOf('<erro>') >= 0){			texto = texto.substring (texto.indexOf('>')+1,texto.length);			texto = texto.substring (0,texto.indexOf('</'));			alert (texto);		}else{			div_ok = true;		}	}else{		div_ok = true;	}	if (div_ok) {		var linha = frm_lanca_peca.linha.value ;		var pecas = "";		for (var i = 1 ; i < 20 ; i++) {			linha_peca = 'frm_lanca_peca.peca_' + i;			linha_qtde = 'frm_lanca_peca.qtde_' + i;			if (typeof (eval (linha_peca)) != "undefined") {				var descricao = eval (linha_peca).value ;				descricao = descricao.split(" - ");				descricao = descricao[1];				if (typeof (descricao) != "undefined"){					var qtde = eval (linha_qtde).value ;					if (typeof (qtde) != "undefined"){						pecas = pecas + qtde + " - " + descricao + "<br>";					}				}			}		}		span_pecas = 'pecas_' + linha;		document.getElementById(span_pecas).innerHTML = pecas;		div_lanca_pecaFecha();	}}</script><div id="div_lanca_peca" style="display:none ; border:solid 1px #330099 ; width:400px ; height:350px ; background-color:#EEEEFF ; padding: 5px " onkeypress="if(event.keyCode==27){div_lanca_pecaFecha()}">	<div id="div_lanca_peca_fecha" style="float:right ; align:center ; width:20px ; background-color:#FFFFFF " onclick="div_lanca_pecaFecha()" onmouseover="this.style.cursor='pointer'"><center><b>X</b></center></div>	<div id="div_lanca_peca_titulo" style="width:270px ">		<font size='+0'><b>		<span id="div_lanca_peca_rg">&nbsp;</span>		</b></font>	</div>	<form name='frm_lanca_peca'>	<input type='hidden' name='produto'           id='produto'>	<input type='hidden' name='produto_rg'        id='produto_rg'>	<input type='hidden' name='produto_rg_item'   id='produto_rg_item'>	<input type='hidden' name='linha'             id='linha'>	<input type='hidden' name='serie'             id='serie'>	<input type='hidden' name='defeito_reclamado' id='defeito_reclamado'>	<hr><br>	Peça 1 <input type="text"   id="peca_1"    name="peca_1" size="35" onfocus="autocompletar('peca_1','id_peca_1',frm_lanca_peca.produto.value)" >	       <input type="hidden" id="id_peca_1" name="id_peca_1">	Qtde   <input type="text"   id="qtde_1"    name="qtde_1" size="4">	<br> 	Peça 2 <input type="text"   id="peca_2"    name="peca_2" size="35" onfocus="autocompletar('peca_2','id_peca_2',frm_lanca_peca.produto.value)" >	       <input type="hidden" id="id_peca_2" name="id_peca_2">	Qtde   <input type="text"   id="qtde_2"    name="qtde_2" size="4">	<br> 	Peça 3 <input type="text"   id="peca_3"    name="peca_3" size="35" onfocus="autocompletar('peca_3','id_peca_3',frm_lanca_peca.produto.value)" >	       <input type="hidden" id="id_peca_3" name="id_peca_3">	Qtde   <input type="text"   id="qtde_3"    name="qtde_3" size="4">	<br> 	Peça 4 <input type="text"   id="peca_4"    name="peca_4" size="35" onfocus="autocompletar('peca_4','id_peca_4',frm_lanca_peca.produto.value)" >	       <input type="hidden" id="id_peca_4" name="id_peca_4">	Qtde   <input type="text"   id="qtde_4"    name="qtde_4" size="4">	<br> 	Peça 5 <input type="text"   id="peca_5"    name="peca_5" size="35" onfocus="autocompletar('peca_5','id_peca_5',frm_lanca_peca.produto.value)" >           <input type="hidden" id="id_peca_5" name="id_peca_5">	Qtde   <input type="text"   id="qtde_5"    name="qtde_5" size="4">	<br> 	Peça 6 <input type="text"   id="peca_6"    name="peca_6" size="35" onfocus="autocompletar('peca_6','id_peca_6',frm_lanca_peca.produto.value)" >           <input type="hidden" id="id_peca_6" name="id_peca_6">	Qtde   <input type="text"   id="qtde_6"    name="qtde_6" size="4">	<br> 	Peça 7 <input type="text"   id="peca_7"    name="peca_7" size="35" onfocus="autocompletar('peca_7','id_peca_7',frm_lanca_peca.produto.value)" >	       <input type="hidden" id="id_peca_7" name="id_peca_7">	Qtde   <input type="text"   id="qtde_7"    name="qtde_7" size="4">	<br> 	Peça 8 <input type="text"   id="peca_8"    name="peca_8" size="35" onfocus="autocompletar('peca_8','id_peca_8',frm_lanca_peca.produto.value)" >	       <input type="hidden" id="id_peca_8" name="id_peca_8">	Qtde   <input type="text"   id="qtde_8"    name="qtde_8" size="4">	<br> 	Peça 9 <input type="text"   id="peca_9"    name="peca_9" size="35" onfocus="autocompletar('peca_9','id_peca_9',frm_lanca_peca.produto.value)" >	       <input type="hidden" id="id_peca_9" name="id_peca_9">	Qtde   <input type="text"   id="qtde_9"    name="qtde_9" size="4">	<br> 	Peça 10 <input type="text"   id="peca_10"    name="peca_10" size="35" onfocus="autocompletar('peca_10','id_peca_10',frm_lanca_peca.produto.value)" >	        <input type="hidden" id="id_peca_10" name="id_peca_10">	Qtde    <input type="text"   id="qtde_10"    name="qtde_10" size="4">	<br> 	<br>	<input type="button" id="btn_gravar" name="btn_gravar" value="Gravar" onclick="requisicaoHTTP('POST','div_lanca_peca_grava_ajax.php',true,'lanca_peca_retorna_form',false,document.frm_lanca_peca)">	</form></div><?include "rodape.php";?>