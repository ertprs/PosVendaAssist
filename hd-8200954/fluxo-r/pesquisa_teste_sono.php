<?include 'dbconfig.php';include 'includes/dbconnect-inc.php';include "autentica_usuario_teste.php";if (isset($_GET["q"])){	$q    = strtolower($_GET["q"]);	$tipo = $_GET["tipo"];	if (strlen($q)>2){		//--== Inicio da Busca de Peças ==--		if($tipo=="peca"){			$sql = "SELECT   tbl_posto_fabrica.item_aparencia,						 tbl_posto_fabrica.tabela				FROM     tbl_posto				JOIN     tbl_posto_fabrica USING(posto)				WHERE    tbl_posto.posto           = $login_posto				AND      tbl_posto_fabrica.fabrica = $login_fabrica";			$res = pg_exec ($con,$sql);			if (pg_numrows ($res) > 0) {				$item_aparencia = pg_result($res,0,item_aparencia);				$tabela         = pg_result($res,0,tabela);			}			if ($item_aparencia == 'f') {				$sql_add .= " AND item_aparencia IS FALSE ";			}			$sql_add .= " AND (UPPER(TRIM(referencia)) ILIKE UPPER(TRIM('%$q%')) ";		    $sql_add .= " OR UPPER(TRIM(descricao)) ILIKE UPPER(TRIM('%$q%')) )";			$sql =	"SELECT z.peca                                ,							z.referencia       AS peca_referencia ,							z.descricao        AS peca_descricao  ,							z.bloqueada_garantia                  ,							z.peca_fora_linha                     ,							z.de                                  ,							z.para                                ,							z.peca_para                           ,							tbl_peca.descricao AS para_descricao  ,							z.libera_garantia					FROM (							SELECT  y.peca               ,									y.referencia         ,									y.descricao          ,									y.bloqueada_garantia ,									y.peca_fora_linha    ,									tbl_depara.de        ,									tbl_depara.para      ,									tbl_depara.peca_para ,									y.libera_garantia							FROM (									SELECT  x.peca                                      ,											x.referencia                                ,											x.descricao                                 ,											x.bloqueada_garantia                        ,											tbl_peca_fora_linha.peca AS peca_fora_linha ,											tbl_peca_fora_linha.libera_garantia									FROM (											SELECT  tbl_peca.peca              ,													tbl_peca.referencia        ,													tbl_peca.descricao         ,													tbl_peca.bloqueada_garantia											FROM  tbl_peca 											WHERE fabrica = $login_fabrica											AND   ativo                    IS     TRUE											AND   tbl_peca.produto_acabado IS NOT TRUE											$sql_add									) AS x									LEFT JOIN tbl_peca_fora_linha ON tbl_peca_fora_linha.peca = x.peca							) AS y							LEFT JOIN tbl_depara ON tbl_depara.peca_de = y.peca							JOIN tbl_lista_basica ON y.peca = tbl_lista_basica.peca							WHERE produto = $produto					) AS z					LEFT JOIN tbl_peca ON tbl_peca.peca = z.peca_para					ORDER BY z.referencia, z.descricao";			$sql = "SELECT peca, fabrica, descricao, referencia FROM tbl_peca ORDER BY peca LIMIT 50";			$res = pg_exec($con,$sql);			if (pg_numrows ($res) > 0) {				for ($i=0; $i<pg_numrows ($res); $i++ ){					$peca       = trim(pg_result($res,$i,peca));					$descricao  = trim(pg_result($res,$i,descricao));					$referencia = trim(pg_result($res,$i,referencia));					$fabrica    = trim(pg_result($res,$i,fabrica));					if($cor<>'#FFFFFF') {						$cor = "#FFFFFF";					}else{						$cor = "#EEEEEE";					}					echo "$peca|$referencia|$referencia - $descricao|$fabrica|<span style='font-size:10px;font-family:verdana;'>$referencia - $descricao</span>\n";				}			}		}		//--== Inicio da Busca pela Lista Básica ==--		if ($tipo == "lista-basica"){			$produto_rg_item = $_GET['produto_rg_item'];			if (strlen ($produto_rg_item) > 0) {				$produto_rg_item = str_replace ("'","",$produto_rg_item);				$sql = "SELECT produto FROM tbl_produto_rg_item WHERE produto_rg_item = $produto_rg_item";				$res = pg_exec($con,$sql);				if (pg_numrows ($res) > 0) {					$produto = pg_result ($res,0,0);				}			}else{				$produto = $_GET['produto'];			}			$y = trim (strtoupper ($q));			$palavras = explode(' ',$y);			$count = count($palavras);			$sql_and = "";			for($i=0 ; $i < $count ; $i++){				if(strlen(trim($palavras[$i]))>0){					$sql_and .= " AND (tbl_peca.referencia ILIKE '%".trim($palavras[$i])."%' OR tbl_peca.descricao ILIKE '%".trim($palavras[$i])."%' )";				}			}			$sql = "SELECT tbl_peca.peca, tbl_peca.fabrica, tbl_peca.descricao, tbl_peca.referencia 					FROM tbl_peca 					JOIN tbl_lista_basica ON tbl_lista_basica.peca = tbl_peca.peca					WHERE tbl_lista_basica.produto = $produto					$sql_and					ORDER BY tbl_peca.descricao";#				echo `echo "$sql" > /tmp/x.x2`;			$res = pg_exec($con,$sql);			if (pg_numrows ($res) > 0) {				for ($i=0; $i<pg_numrows ($res); $i++ ){					$peca       = trim(pg_result($res,$i,peca));					$descricao  = trim(pg_result($res,$i,descricao));					$referencia = trim(pg_result($res,$i,referencia));					$fabrica    = trim(pg_result($res,$i,fabrica));					if ($cor <> "#FFFFFF") {						$cor =  "#FFFFFF";					}else{						$cor =  "#EEEEEE";					}					echo "$peca|$referencia|$referencia - $descricao|$fabrica|<span style='font-size:10px;font-family:verdana;'>$referencia - $descricao</span>\n";				}			}		}				//--== Inicio da Busca de Produtos ==--		if($tipo=="produto"){			$sql = "				SELECT  PR.produto   ,						PR.descricao ,						PR.referencia,						FA.nome      				FROM tbl_produto PR				JOIN tbl_linha   LI USING(linha)				JOIN tbl_fabrica FA USING(fabrica)				WHERE  fabrica=$cook_fabrica ";				$y = trim($q);				$palavras = explode(' ',$y);				$count = count($palavras);				for($i=0 ; $i < $count ; $i++){					if(strlen(trim($palavras[$i]))>0){						$sql .= " AND (									referencia LIKE '%".trim($palavras[$i])."%'									OR    descricao     ILIKE '%".trim($palavras[$i])."%'									)";					}				}			//if ($tipo_busca == "codigo") $sql .= " AND UPPER(PR.referencia) LIKE UPPER('%$q%') ";			//else                         $sql .= " AND UPPER(PR.descricao)  LIKE UPPER('%$q%') ";			$res = pg_exec($con,$sql);			if (pg_numrows ($res) > 0) {				for ($i=0; $i<pg_numrows ($res); $i++ ){					$produto    = trim(pg_result($res,$i,produto));					$descricao  = trim(pg_result($res,$i,descricao));					$referencia = trim(pg_result($res,$i,referencia));					$fabrica    = trim(pg_result($res,$i,nome));					if($cor<>'#FFFFFF') {						$cor = "#FFFFFF";					}else{						$cor = "#EEEEEE";					}					echo "$produto|$referencia|$referencia - $descricao|$fabrica|<span style='font-size:10px;font-family:verdana;'>$referencia - $descricao<br>Fabricante: $fabrica</div>\n";				}			}		}		//--== Inicio da Busca de RG ==--		if($tipo=="rg"){			$sql = "SELECT  RI.produto_rg_item,							RI.rg             ,							RI.codigo_barra					FROM tbl_produto_rg      RG					JOIN tbl_produto_rg_item RI USING(produto_rg)					WHERE RG.posto   = $login_posto					AND   RI.produto IS NULL					AND   RI.rg ILIKE '%$q%'";			$res = pg_exec($con,$sql);			if (pg_numrows ($res) > 0) {				for ($i=0; $i<pg_numrows ($res); $i++ ){					$produto_rg_item = trim(pg_result($res,$i,produto_rg_item));					$rg              = trim(pg_result($res,$i,rg));					$codigo_barra    = trim(pg_result($res,$i,codigo_barra));					if($cor<>'#FFFFFF') $cor = "#FFFFFF";					else                $cor = "#EEEEEE";					echo "$produto_rg_item|$rg|$codigo_barra|xxx|<span style='font-size:10px;font-family:verdana;'>RG: $rg - Código Barra: $codigo_barra</div>\n";				}			}		}	}}?>