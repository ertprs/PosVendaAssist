<?include 'dbconfig.php';include 'includes/dbconnect-inc.php';include "autentica_usuario.php";$q = strtolower($_GET["q"]);if (isset($_GET["q"])){	$tipo_busca = $_GET["busca"];	if (strlen($q)>2){		$sql = "			SELECT  PR.produto   ,					PR.descricao ,					PR.referencia,					FA.nome      			FROM tbl_produto PR			JOIN tbl_linha   LI USING(linha)			JOIN tbl_fabrica FA USING(fabrica)			WHERE  fabrica=45			";		if ($tipo_busca == "codigo") $sql .= " AND UPPER(PR.referencia) LIKE UPPER('%$q%') ";		else                         $sql .= " AND UPPER(PR.descricao)  LIKE UPPER('%$q%') ";		$res = pg_exec($con,$sql);		if (pg_numrows ($res) > 0) {			for ($i=0; $i<pg_numrows ($res); $i++ ){				$produto    = trim(pg_result($res,$i,produto));				$descricao  = trim(pg_result($res,$i,descricao));				$referencia = trim(pg_result($res,$i,referencia));				$fabrica    = trim(pg_result($res,$i,nome));				if($cor<>'#FFFFFF') $cor = "#FFFFFF";				else                $cor = "#EEEEEE";				echo "$produto|$referencia|$descricao|$fabrica|<span style='font-size:10px;font-family:verdana;'>$referencia - $descricao<br>Fabricante: $fabrica</div>\n";			}		}	}	exit;}if ($acao == "gravar" AND $ajax == "sim") {	$tecnico = $_POST["tecnico"];	if(strlen($tecnico)==0) $msg_erro = "Selecione o técnico!";	if (strlen($msg_erro) == 0) {		$res = pg_exec ($con,"BEGIN TRANSACTION");		if(strlen($id_conta_corrente_tecnico)==0){			$sql =	"INSERT INTO tbl_conta_corrente_tecnico(						posto           ,						login_unico					)VALUES(						$login_posto    ,						$tecnico					) ";			$res = @pg_exec($con,$sql);			$msg_erro .= pg_errormessage($con);			$res = @pg_exec ($con,"SELECT CURRVAL ('seq_conta_corrente_tecnico')");			$conta_corrente_tecnico  = pg_result ($res,0,0);		}		if(strlen($msg_erro)==0){			for ($i = 0 ; $i < $qtde_item ; $i++) {				$produto_rg_item   = $_POST["produto_rg_item_$i"];;				if(strlen($produto_rg_item)==0) continue;				if(strlen($msg_erro)>0)         break;				$x = $i+1;				$sql = "SELECT produto_rg 						FROM tbl_produto_rg_item 						WHERE produto_rg_item = $produto_rg_item";				$res = @pg_exec($con,$sql);				$msg_erro .= pg_errormessage($con);				if(pg_numrows($res)>0){					$produto_rg = @pg_result($res,0,0);					if(strlen($msg_erro)==0){						$sql =	"INSERT INTO tbl_conta_corrente_tecnico_item(									conta_corrente_tecnico      ,									produto_rg                  ,									produto_rg_item								)VALUES(									$conta_corrente_tecnico,									$produto_rg            ,									$produto_rg_item																) ";						$res = @pg_exec($con,$sql);						$msg_erro .= pg_errormessage($con);						if(strlen($msg_erro)>0) $msg_erro = "$sql $produto_rg_item";					}else $msg_erro_linha = $i;				}			}		}	}	if (strlen($msg_erro) == 0) {		$res = pg_exec($con,"COMMIT TRANSACTION");		echo "ok|Gravado com Sucesso|$conta_corrente_tecnico";	}else{		$res = pg_exec($con,"ROLLBACK TRANSACTION");		echo "1|$msg_erro|$msg_erro_linha";	}	exit;}$aba=3;include "cabecalho.php";?><script>function createRequestObject(){	var request_;	var browser = navigator.appName;	if(browser == "Microsoft Internet Explorer"){		 request_ = new ActiveXObject("Microsoft.XMLHTTP");	}else{		 request_ = new XMLHttpRequest();	}	return request_;}var http_forn = new Array();function gravar(formulatio,redireciona,pagina,janela) {	var acao = 'gravar';	url = "<?=$PHP_SELF?>?ajax=sim&acao="+acao;	parametros = "";	for( var i = 0 ; i < formulatio.length; i++ ){		if (formulatio.elements[i].type !='button'){			//alert(formulatio.elements[i].name+' = '+formulatio.elements[i].value);			if(formulatio.elements[i].type=='radio' || formulatio.elements[i].type=='checkbox'){								if(formulatio.elements[i].checked == true){//					alert(formulatio.elements[i].value);					parametros = parametros+"&"+formulatio.elements[i].name+"="+escape(formulatio.elements[i].value);				}			}else{				parametros = parametros+"&"+formulatio.elements[i].name+"="+escape(formulatio.elements[i].value);			}		}	}	var com       = document.getElementById('erro');	var saida     = document.getElementById('saida');	com.innerHTML = "&nbsp;&nbsp;Aguarde...&nbsp;&nbsp;<br><img src='imagens/carregar2.gif' >";	saida.innerHTML = "&nbsp;&nbsp;Aguarde...&nbsp;&nbsp;<br><img src='imagens/carregar2.gif' >";	var curDateTime = new Date();	http_forn[curDateTime] = createRequestObject();	http_forn[curDateTime].open('POST',url,true);		http_forn[curDateTime].setRequestHeader("Content-type", "application/x-www-form-urlencoded");	http_forn[curDateTime].setRequestHeader("CharSet", "ISO-8859-1");	http_forn[curDateTime].setRequestHeader("Content-length", url.length);	http_forn[curDateTime].setRequestHeader("Connection", "close");	http_forn[curDateTime].onreadystatechange = function(){		if (http_forn[curDateTime].readyState == 4){			if (http_forn[curDateTime].status == 200 || http_forn[curDateTime].status == 304){			//alert(http_forn[curDateTime].responseText);			var response = http_forn[curDateTime].responseText.split("|");				if (response[0]=="debug"){					alert(http_forn[curDateTime].responseText);				}				if (response[0]=="ok"){					com.style.visibility = "hidden";					com.innerHTML = response[1];					saida.innerHTML = response[1];					if (document.getElementById('btn_continuar')){						document.getElementById('btn_continuar').style.display='inline';					}					formulatio.btn_acao.value='Gravar';					for( var i = 0 ; i < formulatio.length; i++ ){						if (formulatio.elements[i].type !='button'){							if(formulatio.elements[i].type=='radio' || formulatio.elements[i].type=='checkbox'){								if(formulatio.elements[i].checked == true){									formulatio.elements[i].checked=false;								}							}else{								formulatio.elements[i].value='';							}						}					}					window.location="planilha_print.php?cc="+response[2];				}else{					formulatio.btn_acao.value='Gravar';				}				if (response[0]=="1"){					com.style.visibility = "visible";					saida.innerHTML = "<font color='#990000'>Ocorreu um erro, verifique!</font>";					com.innerHTML = response[1];					formulatio.btn_acao.value='Gravar';				}			}		}	}	http_forn[curDateTime].send(parametros);}</script><script language="JavaScript">$().ready(function() {	function formatItem(row) {		return row[4];	}		function formatResult(row) {		return row[0];	}		/* Busca pelo Código */	$("input[@rel='referencia']").autocomplete("<?echo 'login_unico_rg_conferencia.php?busca=codigo'; ?>", {		minChars: 3,		delay: 150,		width: 350,		matchContains: true,		formatItem: formatItem,		formatResult: function(row) {return row[1];}	});	$("input[@rel='referencia']").result(function(event, data, formatted) {		$("input[@name=produto_"+$(this).attr("alt")+"]").val(data[0])   ;		$("input[@name=descricao_"+$(this).attr("alt")+"]").val(data[2]) ;		$("input[@name=serie_"+$(this).attr("alt")+"]").focus()          ;		//$("input[@name=fabrica_"+$(this).attr("alt")+"]").html(data[3]);	});	/* Busca pelo Nome */	$("input[@rel='descricao']").autocomplete("<?echo 'login_unico_rg_conferencia.php?busca=nome'; ?>", {		minChars: 3,		delay: 150,		width: 350,		matchContains: true,		highlightItem: false,		formatItem: formatItem,		formatResult: function(row) {return row[2];}	});	$("input[@rel='descricao']").result(function(event, data, formatted) {		$("input[@name=produto_"+$(this).attr("alt")+"]").val(data[0])    ;		$("input[@name=referencia_"+$(this).attr("alt")+"]").val(data[1]) ;		$("input[@name=serie_"+$(this).attr("alt")+"]").focus()           ;		//$("input[@name=fabrica_"+$(this).attr("alt")+"]").html(data[3]);	});});function marcar(){	$("input[@rel='check']").each(function(){		this.checked = !this.checked;	});}</script><div id="m_1" class="modbox">	<h2 class="modtitle">		<div id="m_1_h">			<a class="mtlink" id="m_1_url" href="#">			<span id="m_1_title" class="modtitle_text"><font color="#005f9d">Planilha de Produto - Produtos disponíveis para análise ou concerto</font></span>			</a>		</div>	</h2>	<div id="m_1_b" class="modboxin">		<div id="ftl_1_0" class="uftl" style='text-align:justify'>		<form name="frm_os" method="post" action="<? echo $PHP_SELF ?>">			<table align='center'>				<tr>					<th>Lote: </th>					<td><input type='text' name='produto_rg' value='<?=$produto_rg?>'></td>				</tr>				<tr>					<th>Linha: </th>					<td>						<?						$sql = "SELECT  *								FROM    tbl_linha								WHERE   tbl_linha.fabrica = 45 								ORDER BY tbl_linha.nome;";						$res = pg_exec ($con,$sql);												if (pg_numrows($res) > 0) {							echo "<select name='linha' class='frm'>\n";							echo "<option value=''>ESCOLHA</option>\n";							for ($x = 0 ; $x < pg_numrows($res) ; $x++){								$aux_linha = trim(pg_result($res,$x,linha));								$aux_nome  = trim(pg_result($res,$x,nome));																echo "<option value='$aux_linha'"; 								if ($linha == $aux_linha){									echo " SELECTED "; 									$mostraMsgLinha = "<br> da LINHA $aux_nome";								}								echo ">$aux_nome</option>\n";							}							echo "</select>\n&nbsp;";						}					?>				</td>			</tr>			<tr>				<th>Família: </th>				<td>					<?					$sql = "SELECT  *							FROM    tbl_familia							WHERE   tbl_familia.fabrica = 45 							ORDER BY tbl_familia.descricao;";					$res = pg_exec ($con,$sql);										if (pg_numrows($res) > 0) {						echo "<select name='familia' class='frm'>\n";						echo "<option value=''>ESCOLHA</option>\n";						for ($x = 0 ; $x < pg_numrows($res) ; $x++){							$aux_familia   = trim(pg_result($res,$x,familia));							$aux_descricao = trim(pg_result($res,$x,descricao));														echo "<option value='$aux_familia'"; 							if ($familia == $aux_familia){								echo " SELECTED "; 								$mostraMsgLinha = "<br> da FAMÍLIA $aux_descricao";							}							echo ">$aux_descricao</option>\n";						}						echo "</select>\n&nbsp;";					}					?>				</td>			</tr>							<tr>				<td colspan='2'><input type='submit' name='btn_acao' value='Pesquisar'></td>			</tr>		</table>		</form>		<form name="frm_tecnico" method="post" action="<? echo $PHP_SELF ?>">		<?		if(strlen($btn_acao)>0){			if(strlen($produto_rg)>0) $sql_add .= " AND RI.produto_rg = $produto_rg ";			if(strlen($familia)>0)    $sql_add .= " AND PR.familia    = $familia ";			if(strlen($linha)>0)      $sql_add .= " AND PR.linha      = $linha ";			$sql = "SELECT  RI.produto_rg_item                                           ,							RI.rg                                                        ,							RI.codigo_barra                                              ,							PR.produto                                                   ,							PR.referencia                           AS produto_referencia,							PR.descricao                            AS produto_descricao ,							LI.nome                                 AS linha_nome        ,							FA.descricao                            AS familia_nome      ,							TO_CHAR(RI.data_digitacao,'dd/mm/YYYY') AS data					FROM       tbl_produto_rg      RG					JOIN       tbl_produto_rg_item RI USING(produto_rg)					LEFT JOIN  tbl_produto         PR USING(produto)					LEFT JOIN  tbl_linha           LI USING(linha)					LEFT JOIN  tbl_familia         FA USING(familia)					WHERE RG.posto = $login_posto					AND   RI.data_devolucao IS NULL					$sql_add					AND produto_rg_item NOT IN(					SELECT produto_rg_item					FROM   tbl_conta_corrente_tecnico_item CC					JOIN   tbl_produto_rg             RG USING(PRODUTO_RG)					WHERE RG.posto = $login_posto					AND   CC.data_devolucao IS NULL)					ORDER BY RI.data_digitacao";			$res = pg_exec($con,$sql);			$total = pg_numrows($res);			echo "<input type='hidden' name='qtde_item' id='qtde_item' value='$total'>";			if(pg_numrows($res)>0){				echo "<table style=' background-color: #e6eef7;font-size:12px;border-collapse: collapse' align='center'  border='1' cellpadding='5' cellspacing='0' bordercolor='#000000' width='98%'>\n";				echo "<thead>\n";				echo "<tr bgcolor='#596D9B' style='color:#FFFFFF;' ALIGN='CENTER'>\n";				echo "<td width='5' height='20' onclick='marcar()'><b><img src='imagens/selecione_todas.gif'></b></td>\n";				echo "<td ><b>RG</b></td>\n";				echo "<td ><b>CÓDIGO BARRA</b></td>\n";				echo "<td ><b>PRODUTO</b></td>\n";				echo "<td ><b>LINHA</b></td>\n";				echo "<td ><b>FAMÍLIA</b></td>\n";				echo "<td ><b>SÉRIE</b></td>\n";				echo "<td ><b>DEFEITO RECLAMADO</b></td>\n";				echo "<td ><b>DEFEITO CONSTATADO</b></td>\n";				echo "<td ><b>PEÇAS</b></td>\n";				echo "<td ><b>DATA</b></td>\n";				echo "<td ><b>OBSERVAÇÃO</b></td>\n";				echo "</tr>\n";				echo "</thead>\n";				echo "<tbody>\n";				for($i=0;$i<pg_numrows($res);$i++) {					$produto_rg_item = pg_result($res,$i,produto_rg_item);					$rg              = pg_result($res,$i,rg);					$codigo_barra    = pg_result($res,$i,codigo_barra);					$produto         = pg_result($res,$i,produto);					$familia_nome    = pg_result($res,$i,familia_nome);					$linha_nome      = pg_result($res,$i,linha_nome);					$produto_nome    = pg_result($res,$i,produto_descricao);					$data            = pg_result($res,$i,data);					$x = $i+1;					if($cor<>'#FFFFFF') $cor = '#FFFFFF';					else                $cor = '#e6eef7';					echo "<tr bgcolor='$cor' >\n";					echo "<td height='20'><input type='checkbox' name='produto_rg_item_$i' id='produto_rg_item_$i' value='$produto_rg_item' checked rel='check'></td>\n";					echo "<td>&nbsp;&nbsp;$rg</td>\n";					echo "<td>$codigo_barra</td>\n";					echo "<td>$produto_nome</td>\n";					echo "<td>$linha_nome</td>\n";					echo "<td>$familia_nome</td>\n";					echo "<td>$serie&nbsp;</td>\n";					echo "<td>$defeito_reclamado&nbsp;</td>\n";					echo "<td>$defeito_constatado&nbsp;</td>\n";					echo "<td>$pecas&nbsp;</td>\n";					echo "<td>$data&nbsp;</td>\n";					echo "<td>$observacao&nbsp;</td>\n";					echo "</tr>\n";				}				echo "</tr>\n";				echo "</tbody>\n";				echo "<tfoot>\n";				echo "<tr>\n";				echo "<td colspan='13'>\n";					$sql = "SELECT  *							FROM    tbl_login_unico							WHERE   posto  = $login_posto 							ORDER BY nome;";					$res = pg_exec ($con,$sql);										if (pg_numrows($res) > 0) {						echo "<select name='tecnico' class='frm'>\n";						echo "<option value=''>ESCOLHA</option>\n";						for ($x = 0 ; $x < pg_numrows($res) ; $x++){							$aux_login_unico   = trim(pg_result($res,$x,login_unico));							$aux_nome          = trim(pg_result($res,$x,nome));														echo "<option value='$aux_login_unico'"; 							if ($x_login_unico == $aux_login_unico) echo " SELECTED "; 							echo ">$aux_nome</option>\n";						}						echo "</select>\n&nbsp;";					}				echo "<input type='button' name='btn_acao'  value='Gravar' onClick=\"if (this.value!='Gravar'){ alert('Aguarde');}else {this.value='Gravando...'; gravar(this.form,'sim','$PHP_SELF','nao');}\" style=\"width: 150px;\"></td>";				echo "<div id='saida' style='display:inline;'></div>";				echo "</td>\n";				echo "</tr>\n";				echo "</tfoot>\n";				echo "</table>\n";			}else echo "Nenhum produto está em análise";		}		?>		<div id='erro' style='visibility:hidden;opacity:0.85' class='Erro'></div>		</form>		</div>	</div></div><?include "rodape.php";?>