<?include 'dbconfig.php';include 'includes/dbconnect-inc.php';include "autentica_usuario.php";$aba=2;include "cabecalho.php";?><script type="text/javascript" src="js/bibliotecaAJAX.js"></script><table border='1' cellspacing='0' cellpadding='10' bgcolor='#99CCFF' align='center'><tr align='center'>	<?	$pesq = $_POST['pesq'];	$pesq = str_replace ("'","",$pesq);	$pesq = trim (strtoupper ($pesq));	?>	<form method='post' action='<?= $PHP_SELF ?>' name='frm_pesq'>	<td>	<b>Pesquisar produto</b> <input type='text' name='pesq' value='<?=$pesq?>'> <input type='submit' name='btn_pesq' value=' ? '>	<br>	<font size='-2'>Número do registro "P" ; Número de Série ; Número da OS ; Número do Pedido</font>	</td>	</form></tr></table><br><?$produto_rg_selecionado = $_GET['produto_rg_selecionado'];$produto_rg_selecionado = str_replace ("'","",$produto_rg_selecionado);if (strlen ($produto_rg_selecionado) == 0 and strlen ($pesq) == 0) {	$sql = "SELECT x.produto_rg, TO_CHAR (data_digitacao, 'DD/MM/YYYY') AS data, x.qtde_aberto, tbl_produto_rg.pedido_antecipado			FROM tbl_produto_rg			JOIN (				SELECT produto_rg, count(*) AS qtde_aberto				FROM tbl_produto_rg				JOIN tbl_produto_rg_item USING (produto_rg)				WHERE tbl_produto_rg_item.posto = $cook_posto				/* AND   tbl_produto_rg_item.data_devolucao IS NULL 				ronaldo esta consultando lotes anteriores para acertar OSs que a NKS nao quer pagar. As OSs estao sem defeito e com pedido de peças esquisito. Uma OS tem um monte de peças e outras tem somente um pouco */				GROUP BY tbl_produto_rg.produto_rg			) x ON tbl_produto_rg.produto_rg = x.produto_rg			WHERE data_conferencia IS NOT NULL			ORDER BY tbl_produto_rg.data_digitacao";	$res = pg_exec ($con,$sql);	echo "<table align='center' border='1' cellspacing='0' cellpadding='15'>";	echo "<tr bgcolor='#99CCFF' align='center' height='20'>";	echo "<td><b>Lote</b></td>";	echo "<td><b>Data</b></td>";	echo "<td width='60'><b>Qtde</b></td>";	echo "<td><b>Pedido Antecipado</b></td>";	echo "</tr>";	for ($i = 0 ; $i < pg_numrows ($res) ; $i++) {		$produto_rg = pg_result ($res,$i,produto_rg);		echo "<tr height='20'>";		echo "<td onmouseover=\"this.style.cursor='pointer'\" onclick=\"this.href='$PHP_SELF?produto_rg_selecionado=$produto_rg'\">";		echo "<a href='$PHP_SELF?produto_rg_selecionado=$produto_rg'>\n";		echo pg_result ($res,$i,produto_rg);		echo "</a>";		echo "</td>\n";		echo "<td>";		echo pg_result ($res,$i,data);		echo "</td>\n";		echo "<td align='right'>";		echo pg_result ($res,$i,qtde_aberto);		echo "</td>\n";		echo "<td>";		$pedido_antecipado = pg_result ($res,$i,pedido_antecipado);		if (strlen ($pedido_antecipado) == 0) {			echo "<a href='pedido_antecipado.php?produto_rg=$produto_rg'>Fazer Pedido</a>";		}else{			echo "<a href='pedido_antecipado.php?produto_rg=$produto_rg'>$pedido_antecipado</a>";		}		echo "</td>\n";		echo "</tr>\n";	}	echo "</table>\n";}#------------------- Mostra os produtos de um lote -----------------------if (strlen ($produto_rg_selecionado) > 0) {	echo "<center><a href='$PHP_SELF'><b><font color='blue'>";	echo "Clique aqui para consultar outro lote";	echo "</font></b></a></center><br>";	echo "<center>";	echo "<b>Lote - $produto_rg_selecionado</b>";	$sql = "SELECT TO_CHAR (data_digitacao, 'DD/MM/YYYY') AS data FROM tbl_produto_rg WHERE produto_rg = $produto_rg_selecionado";	$res = pg_exec ($con,$sql);	echo " - " . pg_result ($res,0,0);	echo "</center>";		$sql = "SELECT  tbl_produto.referencia,					tbl_produto.descricao,					tbl_produto_rg_item.produto_rg_item,					tbl_produto_rg_item.rg,					tbl_produto_rg_item.serie,					tbl_produto_rg_item.defeito_reclamado,					(	SELECT tbl_os.sua_os						FROM tbl_os						WHERE tbl_os.os = tbl_produto_rg_item.os						LIMIT 1					) AS sua_os , 					(	SELECT tbl_os_item.pedido						FROM tbl_os_produto						JOIN tbl_os_item USING (os_produto)						WHERE tbl_os_produto.os = tbl_produto_rg_item.os						LIMIT 1					) AS os_pedido ,					(	SELECT tbl_peca.referencia						FROM tbl_os_produto						JOIN tbl_os_item USING (os_produto)						JOIN tbl_peca    ON tbl_os_item.peca = tbl_peca.peca						WHERE tbl_os_produto.os = tbl_produto_rg_item.os						LIMIT 1					) AS peca_referencia			FROM tbl_produto_rg			JOIN tbl_produto_rg_item USING (produto_rg)			JOIN tbl_produto ON tbl_produto_rg_item.produto = tbl_produto.produto			WHERE tbl_produto_rg_item.produto_rg = $produto_rg_selecionado			ORDER BY tbl_produto_rg_item.produto";		$res = pg_exec ($con,$sql);	echo "<font size='-2'><b>pesquisa por lote</b></font>";	echo "<table align='center' border='1' cellspacing='0' cellpadding='15'>";	echo "<tr bgcolor='#ddddff' align='center' height='20'>";	echo "<td><b>\"P\"</b></td>";	echo "<td><b>Referência</b></td>";	echo "<td><b>Descrição</b></td>";	echo "<td><b>Série</b></td>";	echo "<td><b>Defeito Reclamado</b></td>";	echo "<td><b>Sua OS</b></td>";	echo "<td><b>Pedido</b></td>";	echo "<td><b>Peças</b></td>";	echo "</tr>";	for ($i = 0 ; $i < pg_numrows ($res) ; $i++) {		$produto_rg_item = pg_result ($res,$i,produto_rg_item);		echo "<tr height='25' bgcolor='$cor' valign='top' onmouseover=\"this.style.cursor='pointer' ; this.bgColor='#cccccc'\" onmouseout=\"this.bgColor='$cor'\" onclick=\"div_lanca_pecaCarrega($produto_rg_item) ; div_lanca_peca.style.position='absolute' ; div_lanca_peca.style.left='300px' ; div_lanca_peca.style.top=(this.offsetTop+200) + 'px' ; div_lanca_peca.style.display='block' ; div_lanca_peca_rg.innerText='$rg' ; frm_lanca_peca.produto_rg_item.value='$produto_rg_item' ; frm_lanca_peca.linha.value=$i ; frm_lanca_peca.serie.focus() \">\n";		echo "<td>";		echo pg_result ($res,$i,rg);		echo "</td>";		echo "<td nowrap>";		echo pg_result ($res,$i,referencia);		echo "</td>";		echo "<td nowrap>";		echo "<font size='-2'>";		echo pg_result ($res,$i,descricao);		echo "</font>";		echo "</td>";		echo "<td nowrap><span id='serie_$i'>";		echo pg_result ($res,$i,serie);		echo "</span></td>";		echo "<td nowrap><span id='defeito_reclamado_$i'>";		echo pg_result ($res,$i,defeito_reclamado);		echo "</span></td>";		echo "<td nowrap>";		echo pg_result ($res,$i,sua_os);		echo "</td>";		echo "<td nowrap>";		echo pg_result ($res,$i,os_pedido);		echo "</td>";		$sql = "SELECT tbl_peca.descricao FROM tbl_peca JOIN tbl_produto_rg_peca USING (peca) WHERE tbl_produto_rg_peca.produto_rg_item = $produto_rg_item ORDER BY tbl_produto_rg_peca.produto_rg_peca";		$resP = pg_exec ($con,$sql);		$pecas = "";		for ($p = 0 ; $p < pg_numrows ($resP) ; $p++) {			$pecas .= pg_result ($resP,$p,descricao) . "<br>";		}		echo "<td nowrap><span id='pecas_$i'>";		echo $pecas;		echo "</span></td>";		echo "</tr>";	}	echo "</table>";}#------------------- Mostra o resultado da pesquisa -----------------------if (strlen ($pesq) > 0) {	echo "<center><a href='$PHP_SELF'><b><font color='blue'>";	echo "Clique aqui para consultar lotes";	echo "</font></b></a></center><br>";	if (is_numeric ($pesq) ) {		$pesq_pedido = $pesq;	}else{		$pesq_pedido = 0;	}	$sql = "SELECT  tbl_produto.referencia,					tbl_produto.descricao,					tbl_produto_rg_item.produto_rg,					tbl_produto_rg_item.produto_rg_item,					tbl_produto_rg_item.rg,					tbl_produto_rg_item.serie,					tbl_produto_rg_item.defeito_reclamado,					(	SELECT tbl_os.sua_os						FROM tbl_os						WHERE tbl_os.os = tbl_produto_rg_item.os						LIMIT 1					) AS sua_os , 					(	SELECT tbl_os_item.pedido						FROM tbl_os_produto						JOIN tbl_os_item USING (os_produto)						WHERE tbl_os_produto.os = tbl_produto_rg_item.os						LIMIT 1					) AS os_pedido ,					(	SELECT tbl_peca.referencia						FROM tbl_os_produto						JOIN tbl_os_item USING (os_produto)						JOIN tbl_peca    ON tbl_os_item.peca = tbl_peca.peca						WHERE tbl_os_produto.os = tbl_produto_rg_item.os						LIMIT 1					) AS peca_referencia			FROM tbl_produto_rg			JOIN tbl_produto_rg_item USING (produto_rg)			JOIN tbl_produto ON tbl_produto_rg_item.produto = tbl_produto.produto			JOIN (	SELECT produto_rg_item					FROM   tbl_produto_rg_item					WHERE  tbl_produto_rg_item.rg = '$pesq'					AND    tbl_produto_rg_item.posto = $cook_posto				UNION					SELECT produto_rg_item					FROM   tbl_produto_rg_item					WHERE  tbl_produto_rg_item.serie = '$pesq'					AND    tbl_produto_rg_item.posto = $cook_posto				UNION					SELECT produto_rg_item					FROM   tbl_produto_rg_item					JOIN   tbl_os USING (os)					WHERE  tbl_os.sua_os = '$pesq'					AND    tbl_produto_rg_item.posto = $cook_posto				UNION					SELECT tbl_produto_rg_item.produto_rg_item					FROM   tbl_produto_rg_item					JOIN   tbl_os USING (os)					JOIN   tbl_os_produto ON tbl_os.os = tbl_os_produto.os					JOIN   tbl_os_item ON tbl_os_produto.os_produto = tbl_os_item.os_produto					WHERE  tbl_os_item.pedido = $pesq_pedido					AND    tbl_produto_rg_item.posto = $cook_posto			) x ON tbl_produto_rg_item.produto_rg_item = x.produto_rg_item			ORDER BY tbl_produto_rg_item.produto";		$res = pg_exec ($con,$sql);#	echo "<hr>$sql<hr>";	echo "<font size='-2'><b>resultado da pesquisa</b></font>";	echo "<table align='center' border='1' cellspacing='0' cellpadding='15'>";	echo "<tr bgcolor='#ddddff' align='center' height='20'>";	echo "<td><b>Lote</b></td>";	echo "<td><b>\"P\"</b></td>";	echo "<td><b>Referência</b></td>";	echo "<td><b>Descrição</b></td>";	echo "<td><b>Série</b></td>";	echo "<td><b>Defeito Reclamado</b></td>";	echo "<td><b>Sua OS</b></td>";	echo "<td><b>Pedido</b></td>";	echo "<td><b>Peça</b></td>";	echo "</tr>";	for ($i = 0 ; $i < pg_numrows ($res) ; $i++) {		$produto_rg_item    = pg_result($res,$i,produto_rg_item);		echo "<tr height='25' bgcolor='$cor' valign='top' onmouseover=\"this.style.cursor='pointer' ; this.bgColor='#cccccc'\" onmouseout=\"this.bgColor='$cor'\" onclick=\"div_lanca_pecaCarrega($produto_rg_item) ; div_lanca_peca.style.position='absolute' ; div_lanca_peca.style.left='300px' ; div_lanca_peca.style.top=(this.offsetTop+200) + 'px' ; div_lanca_peca.style.display='block' ; div_lanca_peca_rg.innerText='$rg' ; frm_lanca_peca.produto_rg_item.value='$produto_rg_item' ; frm_lanca_peca.linha.value=$i ; frm_lanca_peca.serie.focus() \">\n";		echo "<td>";		echo pg_result ($res,$i,produto_rg);		echo "</td>";		echo "<td>";		echo pg_result ($res,$i,rg);		echo "</td>";		echo "<td nowrap>";		echo pg_result ($res,$i,referencia);		echo "</td>";		echo "<td nowrap>";		echo "<font size='-2'>";		echo pg_result ($res,$i,descricao);		echo "</font>";		echo "</td>";		echo "<td nowrap><span id='serie_$i'>";		echo pg_result ($res,$i,serie);		echo "</span></td>";		echo "<td><span id='defeito_reclamado_$i'>";		echo pg_result ($res,$i,defeito_reclamado);		echo "</span></td>";		echo "<td nowrap>";		echo pg_result ($res,$i,sua_os);		echo "</td>";		echo "<td nowrap>";		echo pg_result ($res,$i,os_pedido);		echo "</td>";		$sql = "SELECT tbl_peca.descricao FROM tbl_peca JOIN tbl_produto_rg_peca USING (peca) WHERE tbl_produto_rg_peca.produto_rg_item = $produto_rg_item ORDER BY tbl_produto_rg_peca.produto_rg_peca";		$resP = pg_exec ($con,$sql);		$pecas = "";		for ($p = 0 ; $p < pg_numrows ($resP) ; $p++) {			$pecas .= pg_result ($resP,$p,descricao) . "<br>";		}		echo "<td nowrap><span id='pecas_$i'>";		echo $pecas;		echo "</span></td>";		echo "</tr>";	}	echo "</table>";}?>	<!-- --------------------- DIV para Lançamento de Peças ------------------- --><script language='javascript'>function fn_alertar (texto) {	if (texto.length > 0){		if (texto.indexOf('<erro>') >= 0){			texto = texto.substring (texto.indexOf('>')+1,texto.length);			texto = texto.substring (0,texto.indexOf('</'));			alert (texto);		}	}}</script><script language='javascript'>function div_lanca_pecaLimpa() {	document.getElementById('produto_rg_item').value = "";	document.getElementById('linha').value = "";	document.getElementById('serie').value = "";	document.getElementById('defeito_reclamado').value = "";	document.getElementById('peca_1').value = "";	document.getElementById('peca_2').value = "";	document.getElementById('peca_3').value = "";	document.getElementById('peca_4').value = "";	document.getElementById('peca_5').value = "";	document.getElementById('peca_6').value = "";	document.getElementById('peca_7').value = "";	document.getElementById('peca_8').value = "";	document.getElementById('peca_9').value = "";	document.getElementById('peca_10').value = "";}function div_lanca_pecaFecha() {	div_lanca_pecaLimpa();	div_lanca_peca.style.display='none';}function div_lanca_pecaCarrega (produto_rg_item) {	requisicaoHTTP ('GET','div_lanca_peca_carrega_ajax.php?produto_rg_item=' + produto_rg_item , true , 'div_lanca_pecaCarregaCampos');}function div_lanca_pecaCarregaCampos (campos) {	campos = campos.substring (campos.indexOf('>')+1,campos.length);	campos = campos.substring (0,campos.indexOf('</'));	campos_array = campos.split("|");	document.getElementById('serie').value = campos_array[0] ;	document.getElementById('serie').defaultValue = campos_array[0] ;	document.getElementById('defeito_reclamado').value = campos_array[1] ;	document.getElementById('defeito_reclamado').defaultValue = campos_array[1] ;	document.getElementById('peca_1').value = campos_array[2] ;	document.getElementById('peca_1').defaultValue = campos_array[2] ;	document.getElementById('peca_2').value = campos_array[3] ;	document.getElementById('peca_2').defaultValue = campos_array[3] ;	document.getElementById('peca_3').value = campos_array[4] ;	document.getElementById('peca_3').defaultValue = campos_array[4] ;	document.getElementById('peca_4').value = campos_array[5] ;	document.getElementById('peca_4').defaultValue = campos_array[5] ;	document.getElementById('peca_5').value = campos_array[6] ;	document.getElementById('peca_5').defaultValue = campos_array[6] ;	document.getElementById('peca_6').value = campos_array[7] ;	document.getElementById('peca_6').defaultValue = campos_array[7] ;	document.getElementById('peca_7').value = campos_array[8] ;	document.getElementById('peca_7').defaultValue = campos_array[8] ;	document.getElementById('peca_8').value = campos_array[9] ;	document.getElementById('peca_8').defaultValue = campos_array[9] ;	document.getElementById('peca_9').value = campos_array[10] ;	document.getElementById('peca_9').defaultValue = campos_array[10] ;	document.getElementById('peca_10').value = campos_array[11] ;	document.getElementById('peca_10').defaultValue = campos_array[11] ;}</script><script language="JavaScript">function autocompletar(campo1,campo2, produto_rg_item) {	$('#'+campo1).autocomplete("pesquisa.php?tipo=lista-basica&produto_rg_item=" + produto_rg_item, {		minChars: 3,		delay: 150,		width: 350,		scroll: true,		scrollHeight: 500,		matchContains: false,		highlightItem: true,		formatItem: function (row)   {return row[4]},		formatResult: function(row)  {return row[2];}	});	$('#'+campo1).result(function(event, data, formatted) {		$('#'+campo2).val(data[0])    ;		$('#'+campo1).focus() ;	});}</script><script language='javascript'>function lanca_peca_retorna_form (texto) {	var div_ok = false ;	if (texto.length > 0){		if (texto.indexOf('<erro>') >= 0){			texto = texto.substring (texto.indexOf('>')+1,texto.length);			texto = texto.substring (0,texto.indexOf('</'));			alert (texto);		}else{			div_ok = true;		}	}else{		div_ok = true;	}	if (div_ok) {		var linha = frm_lanca_peca.linha.value ;		span_serie = 'serie_' + linha;		document.getElementById(span_serie).innerText = document.frm_lanca_peca.serie.value;		span_defeito_reclamado = 'defeito_reclamado_' + linha;		document.getElementById(span_defeito_reclamado).innerText = document.frm_lanca_peca.defeito_reclamado.value;		var pecas = "";		for (var i = 1 ; i < 20 ; i++) {			linha_peca = 'frm_lanca_peca.peca_' + i;			if (typeof (eval (linha_peca)) != "undefined") {				var descricao = eval (linha_peca).value ;				descricao = descricao.split(" - ");				descricao = descricao[1];				if (typeof (descricao) != "undefined"){					pecas = pecas + descricao + "<br>";				}			}		}		span_pecas = 'pecas_' + linha;		document.getElementById(span_pecas).innerHTML = pecas;		div_lanca_pecaFecha();	}}</script><div id="div_lanca_peca" style="display:none ; border:solid 1px #330099 ; width:400px ; height:350px ; background-color:#EEEEFF ; padding: 5px " onkeypress="if(event.keyCode==27){div_lanca_pecaFecha()}">	<div id="div_lanca_peca_fecha" style="float:right ; align:center ; width:20px ; background-color:#FFFFFF " onclick="div_lanca_pecaFecha()" onmouseover="this.style.cursor='pointer'"><center><b>X</b></center></div>	<div id="div_lanca_peca_titulo" style="width:270px ">		<font size='+1'>		Análise do RG <span id="div_lanca_peca_rg">&nbsp;</span>		</font>	</div>	<form name='frm_lanca_peca'>	<input type='hidden' name='produto_rg_item' id='produto_rg_item'>	<input type='hidden' name='linha' id='linha'>	<hr><br>	N. Série <input type="text" id='serie' name="serie" size="10" value="" onblur="requisicaoHTTP('GET','serie_cadastra_ajax.php?serie=' + this.value + '&produto_rg_item=' + frm_lanca_peca.produto_rg_item.value ,true,'fn_alertar')" >	<br> 	Defeito Reclamado <input type="text" name="defeito_reclamado" size="20" value="" onblur="requisicaoHTTP('GET','defeito_reclamado_grava_ajax.php?defeito_reclamado=' + this.value + '&produto_rg_item=' + frm_lanca_peca.produto_rg_item.value ,true,'fn_alertar')" >	<br> 	<!--	Defeito Constatado <input disabled type="text" name="defeito_constatado" size="20">	<br>	-->	Peça 1 <input type="text"   id="peca_1"    name="peca_1" size="35" onfocus="autocompletar('peca_1','id_peca_1',frm_lanca_peca.produto_rg_item.value)" >	       <input type="hidden" id="id_peca_1" name="id_peca_1">	<br> 	Peça 2 <input type="text"   id="peca_2"    name="peca_2" size="35" onfocus="autocompletar('peca_2','id_peca_2',frm_lanca_peca.produto_rg_item.value)" >	       <input type="hidden" id="id_peca_2" name="id_peca_2">	<br> 	Peça 3 <input type="text"   id="peca_3"    name="peca_3" size="35" onfocus="autocompletar('peca_3','id_peca_3',frm_lanca_peca.produto_rg_item.value)" >	       <input type="hidden" id="id_peca_3" name="id_peca_3">	<br> 	Peça 4 <input type="text"   id="peca_4"    name="peca_4" size="35" onfocus="autocompletar('peca_4','id_peca_4',frm_lanca_peca.produto_rg_item.value)" >	       <input type="hidden" id="id_peca_4" name="id_peca_4">	<br> 	Peça 5 <input type="text"   id="peca_5"    name="peca_5" size="35" onfocus="autocompletar('peca_5','id_peca_5',frm_lanca_peca.produto_rg_item.value)" >           <input type="hidden" id="id_peca_5" name="id_peca_5">	<br> 	Peça 6 <input type="text"   id="peca_6"    name="peca_6" size="35" onfocus="autocompletar('peca_6','id_peca_6',frm_lanca_peca.produto_rg_item.value)" >           <input type="hidden" id="id_peca_6" name="id_peca_6">	<br> 	Peça 7 <input type="text"   id="peca_7"    name="peca_7" size="35" onfocus="autocompletar('peca_7','id_peca_7',frm_lanca_peca.produto_rg_item.value)" >	       <input type="hidden" id="id_peca_7" name="id_peca_7">	<br> 	Peça 8 <input type="text"   id="peca_8"    name="peca_8" size="35" onfocus="autocompletar('peca_8','id_peca_8',frm_lanca_peca.produto_rg_item.value)" >	       <input type="hidden" id="id_peca_8" name="id_peca_8">	<br> 	Peça 9 <input type="text"   id="peca_9"    name="peca_9" size="35" onfocus="autocompletar('peca_9','id_peca_9',frm_lanca_peca.produto_rg_item.value)" >	       <input type="hidden" id="id_peca_9" name="id_peca_9">	<br> 	Peça 10 <input type="text"   id="peca_10"    name="peca_10" size="35" onfocus="autocompletar('peca_10','id_peca_10',frm_lanca_peca.produto_rg_item.value)" >	        <input type="hidden" id="id_peca_10" name="id_peca_10">	<br> 	<br>	<input type="button" id="btn_gravar" name="btn_gravar" value="Gravar" onclick="requisicaoHTTP('POST','div_lanca_peca_grava_ajax.php',true,'lanca_peca_retorna_form',false,document.frm_lanca_peca)">	</form></div><?include "rodape.php";?>