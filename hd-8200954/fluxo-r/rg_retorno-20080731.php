<?include "dbconfig.php";include "includes/dbconnect-inc.php";include "autentica_usuario.php";if($ajax=='rg'){	$sql = "SELECT PR.produto,PR.referencia,PR.descricao			FROM   tbl_produto_rg      RG			JOIN   tbl_produto_rg_item RI USING(produto_rg)			JOIN   tbl_produto         PR USING(produto)			JOIN   tbl_linha           LI USING(linha)			WHERE  RI.rg      = '$rg'			AND    LI.fabrica = 45			AND    RG.posto   = $login_posto";	$res2 = pg_exec($con,$sql);	if(pg_numrows($res2)>0){		$produto    = @pg_result($res2,0,produto);		$referencia = @pg_result($res2,0,referencia);		$descricao  = @pg_result($res2,0,descricao);		$resultado = "<table align='center'><tr><td style='font-size:60px;'>$descricao</td>";		if($codigo_barra=='7896843915051') $resultado .= "<td><img src='imagens/imagem_aspirador.bmp' align='middle' width='350'></td>";		else                               $resultado .= "<td><img src='imagens/produto_sem_foto.gif' align='middle'></td>";		$resultado .= "</table>";	}else $resultado = "<span style='font-size:70PX;color:#FF0000;text-align:center;'>NÃO ENCONTRADO</SPAN>";	echo "ok| $resultado";	exit;}if ($acao == "gravar" AND $ajax == "sim") {	$res = pg_exec ($con,"BEGIN TRANSACTION");	if (strlen($msg_erro) == 0) {		$qtde_item = 100;		for ($i = 0 ; $i < $qtde_item ; $i++) {			$rg = trim($_POST['rg_' . $i]);			if (strlen($rg)==0 ) continue;			$sql = "SELECT  RI.produto_rg_item,							RI.fabrica					FROM tbl_produto_rg      RG					JOIN tbl_produto_rg_item RI USING(produto_rg)					WHERE RG.posto = $login_posto					AND   RI.rg    = '$rg'					AND   RI.data_devolucao IS NULL";			$res1 = @pg_exec($con,$sql);			$msg_erro .= pg_errormessage($con);			if(@pg_numrows($res1)>1) $msg_erro .= "Existe mais de uma OS com o RG $rg<br>";			if(@pg_numrows($res1)==1 AND strlen($msg_erro)==0){				$fabrica         = pg_result($res1,0,fabrica);				$produto_rg_item = pg_result($res1,0,produto_rg_item);				$sql = "SELECT os ,sua_os						FROM tbl_os						WHERE fabrica    = $fabrica						AND   posto      = $login_posto						AND   rg_produto = '$rg' ; ";				$res2 = @pg_exec($con,$sql);				$msg_erro .= pg_errormessage($con);				if(pg_numrows($res2)>0) {					$os     = pg_result($res2,0,os);					$sua_os = pg_result($res2,0,sua_os);					$sql = "UPDATE tbl_produto_rg_item SET 								data_devolucao = now()							WHERE produto_rg_item = $produto_rg_item";					$res3 = @pg_exec($con,$sql);					$msg_erro .= pg_errormessage($con);					$sql = "UPDATE tbl_os							SET data_nf_saida     = current_date,								nota_fiscal_saida = nota_fiscal ,								data_fechamento   = current_date,								finalizada        = now()       ,								conferido_saida   = TRUE							WHERE os      = $os							AND   fabrica = $fabrica";					$res4 = @pg_exec ($con,$sql);					$msg_erro .= pg_errormessage($con) ;					$sql = "SELECT fn_finaliza_os($os, $fabrica)";					$res5 = @pg_exec ($con,$sql);					$msg_erro .= pg_errormessage($con) ;					$msg = "$sua_os<br>";				}else $msg_erro .= "Não foi encontrada a OS do RG $rg";			}else     $msg_erro .= "Não foi encontrado nos lotes o RG $rg";		}	}	if (strlen($msg_erro) == 0) {		$res = pg_exec($con,"COMMIT TRANSACTION");		echo "ok|Gravado com Sucesso<br>Foiram fechadas as seguintes OS:<br>$msg|$produto_rg";	}else{		$res = pg_exec($con,"ROLLBACK TRANSACTION");		echo "1|$msg_erro";	}	exit;}$aba=2;include "cabecalho.php";//include "admin/javascript_calendario.php";?><script>	function adicionaRG() {		var parar = 0;		$("input[@rel='rg']").each(function (){			if ($(this).val() == document.getElementById('rg').value){				parar++;			}		});		if (parar>0){			alert('RG '+document.getElementById('rg').value+' já inserido')			return false;		}		if(document.getElementById('rg').value==""){			alert('Digite o RG');			document.getElementById("rg").focus();			return false;		}		var tbl = document.getElementById('tbl_integridade');		var lastRow = tbl.rows.length;		var iteration = lastRow;		if (iteration>0){			document.getElementById('tbl_integridade').style.display = "inline";		}		var linha = document.createElement('tr');		linha.style.cssText = 'color: #000000; text-align: left; font-size:10px';		// COLUNA 1 - LINHA		var celula = criaCelula(document.getElementById('rg').value);		celula.style.cssText = 'text-align: left; color: #000000;font-size:10px';		var el = document.createElement('input');		el.setAttribute('type', 'hidden');		el.setAttribute('name', 'rg_' + iteration);		el.setAttribute('id', 'rg_' + iteration);		el.setAttribute('rel', 'rg');		el.setAttribute('value',document.getElementById('rg').value);		celula.appendChild(el);		linha.appendChild(celula);		var celula = document.createElement('td');		celula.style.cssText = 'text-align: right; color: #000000;font-size:10px';		var el = document.createElement('input');		el.setAttribute('type', 'button');		el.setAttribute('value','Excluir');		el.onclick=function(){removerIntegridade(this);};		celula.appendChild(el);		linha.appendChild(celula);		// finaliza linha da tabela		var tbody = document.createElement('TBODY');		tbody.appendChild(linha);		tbl.appendChild(tbody);		document.getElementById('rg').value='';		document.getElementById('rg').focus();	}	function removerIntegridade(iidd) {		var tbl = document.getElementById('tbl_integridade');		tbl.deleteRow(iidd.parentNode.parentNode.rowIndex);	}	function criaCelula(texto) {		var celula = document.createElement('td');		var textoNode = document.createTextNode(texto);		celula.appendChild(textoNode);		return celula;	}	function createRequestObject(){		var request_;		var browser = navigator.appName;		if(browser == "Microsoft Internet Explorer"){			 request_ = new ActiveXObject("Microsoft.XMLHTTP");		}else{			 request_ = new XMLHttpRequest();		}		return request_;	}var http_forn = new Array();function gravar(formulatio,redireciona,pagina,janela) {	var acao = 'gravar';	url = "<?=$PHP_SELF?>?ajax=sim&acao="+acao;	parametros = "";	for( var i = 0 ; i < formulatio.length; i++ ){		if (formulatio.elements[i].type !='button'){			//alert(formulatio.elements[i].name+' = '+formulatio.elements[i].value);			if(formulatio.elements[i].type=='radio' || formulatio.elements[i].type=='checkbox'){								if(formulatio.elements[i].checked == true){//					alert(formulatio.elements[i].value);					parametros = parametros+"&"+formulatio.elements[i].name+"="+escape(formulatio.elements[i].value);				}			}else{				parametros = parametros+"&"+formulatio.elements[i].name+"="+escape(formulatio.elements[i].value);			}		}	}	var com       = document.getElementById('erro');	var saida     = document.getElementById('saida');	com.innerHTML = "&nbsp;&nbsp;Aguarde...&nbsp;&nbsp;<br><img src='imagens/carregar2.gif' >";	saida.innerHTML = "&nbsp;&nbsp;Aguarde...&nbsp;&nbsp;<br><img src='imagens/carregar2.gif' >";	var curDateTime = new Date();	http_forn[curDateTime] = createRequestObject();	http_forn[curDateTime].open('POST',url,true);		http_forn[curDateTime].setRequestHeader("Content-type", "application/x-www-form-urlencoded");	http_forn[curDateTime].setRequestHeader("CharSet", "ISO-8859-1");	http_forn[curDateTime].setRequestHeader("Content-length", url.length);	http_forn[curDateTime].setRequestHeader("Connection", "close");	http_forn[curDateTime].onreadystatechange = function(){		if (http_forn[curDateTime].readyState == 4){			if (http_forn[curDateTime].status == 200 || http_forn[curDateTime].status == 304){			var response = http_forn[curDateTime].responseText.split("|");				//alert(http_forn[curDateTime].responseText);				if (response[0]=="debug"){					alert(http_forn[curDateTime].responseText);				}				if (response[0]=="ok"){					com.style.visibility = "hidden";					com.innerHTML = response[1];					saida.innerHTML = response[1];					if (document.getElementById('btn_continuar')){						document.getElementById('btn_continuar').style.display='inline';					}					formulatio.btn_acao.value='Gravar';					for( var i = 0 ; i < formulatio.length; i++ ){						if (formulatio.elements[i].type !='button'){							if(formulatio.elements[i].type=='radio' || formulatio.elements[i].type=='checkbox'){								if(formulatio.elements[i].checked == true){									formulatio.elements[i].checked=false;								}							}else{								formulatio.elements[i].value='';							}						}					}					//window.location="login_unico_rg_devolucao.php?ok";				}else{					formulatio.btn_acao.value='Gravar';				}				if (response[0]=="1"){					com.style.visibility = "visible";					saida.innerHTML = "<font color='#990000'>Ocorreu um erro, verifique!</font>";					alert('Erro: verifique as informações preenchidas!');					com.innerHTML = response[1];					formulatio.btn_acao.value='Gravar';				}			}		}	}	http_forn[curDateTime].send(parametros);}function verifica_codigo_barra() {	/*Verificacao para existencia de componente - HD 22891 */	if (document.getElementById('div_produto')){		var ref = document.getElementById('rg').value;		url = "<?=$PHP_SELF?>?ajax=rg&rg="+ref;		var curDateTime = new Date();		http_forn[curDateTime] = createRequestObject();		http_forn[curDateTime].open('GET',url,true);		http_forn[curDateTime].onreadystatechange = function(){			if (http_forn[curDateTime].readyState == 4) 			{				if (http_forn[curDateTime].status == 200 || http_forn[curDateTime].status == 304) 				{					var response = http_forn[curDateTime].responseText.split("|");					if (response[0]=="ok"){						document.getElementById('div_produto').style.visibility = "visible";						document.getElementById('div_produto').style.position = 'static';						document.getElementById('div_produto').innerHTML = response[1];					}else{						document.getElementById('div_produto').style.visibility = "hidden";						document.getElementById('div_produto').style.position = 'absolute';					}				}			}		}		http_forn[curDateTime].send(null);	}}</script><script language="javascript">function proximo() {	var tecla = event.keyCode;	if ((tecla == 13)) { 		document.getElementById("rg").focus();	}	return tecla;}function proximo2() {	var tecla = event.keyCode;	if ((tecla == 13)) { 		verifica_codigo_barra();		adicionaRG();	}	return tecla;}</script><?if(isset($ok)){	echo "OS fechada com sucesso";}?><div id="m_1" class="modbox">	<h2 class="modtitle">		<div id="m_1_h">			<a class="mtlink" id="m_1_url" href="#">			<span id="m_1_title" class="modtitle_text"><font color="#005f9d">Retorno de Lote de Produto</font></span>			</a>		</div>	</h2>	<div id="m_1_b" class="modboxin">		<div id="ftl_1_0" class="uftl" style='text-align:justify'>		<form name="frm_os" method="post"  onsubmit="return false">		<table align='center'>			<tr>				<th align='left'>RG</th>			</tr>			<tr>				<td>					<input type='text' name='rg' id='rg' value='' size='30' onKeyPress="return proximo2();">					<input type='button'  value='Adicionar RG' onfocus="javascript: verifica_codigo_barra();adicionaRG();" name='btn_adicionar'>				</td>			</tr>		</table>		<div id='div_produto' align='center'></div>		<table style=' border:#485989 1px solid; background-color: #e6eef7;font-size:12px;display:none' align='center' width='500' border='0' id='tbl_integridade' cellspacing='3' cellpadding='3'>			<thead>			<tr bgcolor='#596D9B' style='color:#FFFFFF;'>				<td align='center' ><b>RG</b></td>				<td align='center' ><b>Ações</b></td>			</tr>			</thead>		<tfoot>		<tr>			<td colspan='3'>			<?			echo "<table style=' border:#B63434 1px solid; background-color: #EED5D2' align='center' width='500' border='0' height='40'>\n";			echo "<tr>\n";			echo "<td valign='middle' align='LEFT' class='Label' ></td>\n";			echo "</tr>\n";			echo "<tr>\n";			echo "<td width='50' valign='middle'  align='LEFT' colspan='4'>";			echo "<input type='button' name='btn_acao'  value='Gravar' onClick=\"if (this.value!='Gravar'){ alert('Aguarde');}else {this.value='Gravando...'; gravar(this.form,'sim','$PHP_SELF','nao');}\" style=\"width: 150px;\">\n";			echo "</td>";			echo "<td width='300'><div id='saida' style='display:inline;'></div></td>\n";			echo "</tr>\n";			echo "</table>\n";			?>			</td>		</tr>		</tfoot>		</table>		</form><div id='erro' style='visibility:hidden;opacity:0.85' class='Erro'></div>		</div>	</div></div><?include "rodape.php";?>