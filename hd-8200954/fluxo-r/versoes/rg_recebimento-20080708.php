<?include "dbconfig.php";include "includes/dbconnect-inc.php";include "login_unico_autentica_usuario.php";if ($acao == "gravar" AND $ajax == "sim") {	$res = pg_exec ($con,"BEGIN TRANSACTION");	$sql =	"INSERT INTO tbl_produto_rg (				posto             			) VALUES (				$login_posto			)";	$res = @pg_exec ($con,$sql);	$msg_erro = pg_errormessage($con);	if (strlen($msg_erro) == 0 AND strlen($pedido) == 0) {		$res = @pg_exec($con,"SELECT CURRVAL ('seq_produto_rg')");		$produto_rg = pg_result($res,0,0);		$msg_erro .= pg_errormessage($con);	}	if (strlen($msg_erro) == 0) {		$qtde_item = 100;		for ($i = 0 ; $i < $qtde_item ; $i++) {			$rg = trim($_POST['rg_' . $i]);			if (strlen($rg)==0 ) continue;			$sql = "SELECT  RI.fabrica					FROM tbl_produto_rg      RG					JOIN tbl_produto_rg_item RI USING(produto_rg)					WHERE RG.posto = $login_posto					AND   RI.rg    = '$rg'					AND   RI.data_devolucao IS NULL";			$res1 = @pg_exec($con,$sql);			$msg_erro .= pg_errormessage($con);			if(@pg_numrows($res1)>0){				$fabrica         = pg_result($res1,0,fabrica);				$sql = "SELECT os,sua_os FROM tbl_os 						WHERE fabrica    = $fabrica						AND   posto      = $login_posto						AND   rg_produto = '$rg'";				$res2 = @pg_exec($con,$sql);				$msg_erro .= pg_errormessage($con);				$msg_erro .= "Existe uma OS aberta com o RG $rg<br>";				if(pg_numrows($res2)>0) {					$os     = pg_result($res2,0,os);					$sua_os = pg_result($res2,0,sua_os);					$msg_erro .= "OS <a href='login_unico.php?id=$fabrica&os=$os'>$sua_os</a>";				}			}			$sql =	"INSERT INTO tbl_produto_rg_item (						produto_rg ,						rg					) VALUES (						$produto_rg ,						'$rg'					)";			$res = @pg_exec($con,$sql);			$msg_erro .= pg_errormessage($con);					}	}	if (strlen($msg_erro) == 0) {		$res = pg_exec($con,"COMMIT TRANSACTION");		echo "ok|Gravado com Sucesso|$produto_rg";	}else{		$res = pg_exec($con,"ROLLBACK TRANSACTION");		echo "1|$msg_erro";	}	exit;}$aba=2;include "login_unico_cabecalho.php";include "admin/javascript_calendario.php";?><script>	function adicionaRG() {		var parar = 0;		$("input[@rel='rg']").each(function (){			if ($(this).val() == document.getElementById('rg').value){				parar++;			}		});		if (parar>0){			alert('RG '+document.getElementById('rg').value+' já inserido')			return false;		}		if(document.getElementById('rg').value==""){			alert('Digite o RG');			return false;		}		var tbl = document.getElementById('tbl_integridade');		var lastRow = tbl.rows.length;		var iteration = lastRow;		if (iteration>0){			document.getElementById('tbl_integridade').style.display = "inline";		}		var linha = document.createElement('tr');		linha.style.cssText = 'color: #000000; text-align: left; font-size:10px';		// COLUNA 1 - LINHA		var celula = criaCelula(document.getElementById('rg').value);		celula.style.cssText = 'text-align: left; color: #000000;font-size:10px';		var el = document.createElement('input');		el.setAttribute('type', 'hidden');		el.setAttribute('name', 'rg_' + iteration);		el.setAttribute('id', 'rg_' + iteration);		el.setAttribute('rel', 'rg');		el.setAttribute('value',document.getElementById('rg').value);		celula.appendChild(el);		linha.appendChild(celula);			var celula = document.createElement('td');		celula.style.cssText = 'text-align: right; color: #000000;font-size:10px';		var el = document.createElement('input');		el.setAttribute('type', 'button');		el.setAttribute('value','Excluir');		el.onclick=function(){removerIntegridade(this);};		celula.appendChild(el);		linha.appendChild(celula);		// finaliza linha da tabela		var tbody = document.createElement('TBODY');		tbody.appendChild(linha);		tbl.appendChild(tbody);		document.getElementById('rg').value='';		document.getElementById('rg').focus();	}	function removerIntegridade(iidd) {		var tbl = document.getElementById('tbl_integridade');		tbl.deleteRow(iidd.parentNode.parentNode.rowIndex);	}	function criaCelula(texto) {		var celula = document.createElement('td');		var textoNode = document.createTextNode(texto);		celula.appendChild(textoNode);		return celula;	}function createRequestObject(){	var request_;	var browser = navigator.appName;	if(browser == "Microsoft Internet Explorer"){		 request_ = new ActiveXObject("Microsoft.XMLHTTP");	}else{		 request_ = new XMLHttpRequest();	}	return request_;}var http_forn = new Array();function gravar(formulatio,redireciona,pagina,janela) {	var acao = 'gravar';	url = "<?=$PHP_SELF?>?ajax=sim&acao="+acao;	parametros = "";	for( var i = 0 ; i < formulatio.length; i++ ){		if (formulatio.elements[i].type !='button'){			//alert(formulatio.elements[i].name+' = '+formulatio.elements[i].value);			if(formulatio.elements[i].type=='radio' || formulatio.elements[i].type=='checkbox'){								if(formulatio.elements[i].checked == true){//					alert(formulatio.elements[i].value);					parametros = parametros+"&"+formulatio.elements[i].name+"="+escape(formulatio.elements[i].value);				}			}else{				parametros = parametros+"&"+formulatio.elements[i].name+"="+escape(formulatio.elements[i].value);			}		}	}	var com       = document.getElementById('erro');	var saida     = document.getElementById('saida');	com.innerHTML = "&nbsp;&nbsp;Aguarde...&nbsp;&nbsp;<br><img src='imagens/carregar2.gif' >";	saida.innerHTML = "&nbsp;&nbsp;Aguarde...&nbsp;&nbsp;<br><img src='imagens/carregar2.gif' >";	var curDateTime = new Date();	http_forn[curDateTime] = createRequestObject();	http_forn[curDateTime].open('POST',url,true);		http_forn[curDateTime].setRequestHeader("Content-type", "application/x-www-form-urlencoded");	http_forn[curDateTime].setRequestHeader("CharSet", "ISO-8859-1");	http_forn[curDateTime].setRequestHeader("Content-length", url.length);	http_forn[curDateTime].setRequestHeader("Connection", "close");	http_forn[curDateTime].onreadystatechange = function(){		if (http_forn[curDateTime].readyState == 4){			if (http_forn[curDateTime].status == 200 || http_forn[curDateTime].status == 304){			var response = http_forn[curDateTime].responseText.split("|");				if (response[0]=="debug"){					alert(http_forn[curDateTime].responseText);				}				if (response[0]=="ok"){					com.style.visibility = "hidden";					com.innerHTML = response[1];					saida.innerHTML = response[1];					if (document.getElementById('btn_continuar')){						document.getElementById('btn_continuar').style.display='inline';					}					formulatio.btn_acao.value='Gravar';					for( var i = 0 ; i < formulatio.length; i++ ){						if (formulatio.elements[i].type !='button'){							if(formulatio.elements[i].type=='radio' || formulatio.elements[i].type=='checkbox'){								if(formulatio.elements[i].checked == true){									formulatio.elements[i].checked=false;								}							}else{								formulatio.elements[i].value='';							}						}					}					window.location="login_unico_rg_conferencia.php?produto_rg="+response[2];				}else{					formulatio.btn_acao.value='Gravar';				}				if (response[0]=="1"){					com.style.visibility = "visible";					saida.innerHTML = "<font color='#990000'>Ocorreu um erro, verifique!</font>";					alert('Erro: verifique as informações preenchidas!');					com.innerHTML = response[1];					formulatio.btn_acao.value='Gravar';				}			}		}	}	http_forn[curDateTime].send(parametros);}</script><script language="javascript"><!--function dasabilitarenter() {var tecla = event.keyCode;if ((tecla == 13)) {     return false;}return tecla;}// --></script><h2><font color='#DDDDDD'><b><font color="#005f9d">1 Recebimento</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 Conferencia&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 Gerar Lote</font></b></h2><table width='98%' align='center'>	<tr><td align='center'><center><div id="m_1" class="modbox">	<h2 class="modtitle">		<div id="m_1_h">			<a class="mtlink" id="m_1_url" href="#">			<span id="m_1_title" class="modtitle_text"><font color="#005f9d">Recebimento de Lote de Produto</font></span>			</a>		</div>	</h2>	<div id="m_1_b" class="modboxin">		<div id="ftl_1_0" class="uftl" style='text-align:justify'>		<form name="frm_os" method="post" onKeyPress="return dasabilitarenter();" onsubmit="return false">		<table align='center'>			<tr>				<th>RG</th>				<td><input type='text' name='rg' id='rg' value='' size='30'><input type='button' onclick="javascript: adicionaRG()" value='Adicionar RG' onfocus="javascript: adicionaRG()" name='btn_adicionar'><br></td>			</tr>		</table>		<table style=' border:#485989 1px solid; background-color: #e6eef7;font-size:12px;display:none' align='center' width='500' border='0' id='tbl_integridade' cellspacing='3' cellpadding='3'>			<thead>			<tr bgcolor='#596D9B' style='color:#FFFFFF;'>				<td align='center' ><b>RG</b></td>				<td align='center' ><b>Ações</b></td>			</tr>			</thead>		<tfoot>		<tr>			<td colspan='2'>			<?			echo "<table style=' border:#B63434 1px solid; background-color: #EED5D2' align='center' width='500' border='0'height='40'>";			echo "<tr>";			echo "<td valign='middle' align='LEFT' class='Label' >";			echo "</td>";				echo "<tr><td width='50' valign='middle'  align='LEFT' colspan='4'><input type='button' name='btn_acao'  value='Gravar' onClick=\"if (this.value!='Gravar'){ alert('Aguarde');}else {this.value='Gravando...'; gravar(this.form,'sim','$PHP_SELF','nao');}\" style=\"width: 150px;\"></td>";			echo "<td width='300'><div id='saida' style='display:inline;'></div></td>";			echo "</tr>";			echo "</table>";			?>			</td>		</tr>		</tfoot>		</table>		</form><div id='erro' style='visibility:hidden;opacity:0.85' class='Erro'></div>		</div>	</div></div></td></tr></table><?include "login_unico_rodape.php";?>