<?php
$areaAdmin = preg_match('/\/admin\//',$_SERVER['PHP_SELF']) > 0 ? true : false;

include __DIR__.'/dbconfig.php';
include __DIR__.'/includes/dbconnect-inc.php';

if ($areaAdmin === true) {
    $admin_privilegios = "call_center"; 
    include __DIR__.'/admin/autentica_admin.php';
    include_once('../class/tdocs.class.php');
} else {
    include __DIR__.'/autentica_usuario.php';
    include_once('class/tdocs.class.php');
}    

include_once 'helpdesk/mlg_funciones.php';
include __DIR__.'/funcoes.php';
use Posvenda \TcMaps;
$oTcMaps = new TcMaps($login_fabrica, $con);

$arrayEstados = $array_estados();
$array_pais_estado = $array_pais_estado();

$app_ticket = $parametros_adicionais_posto['app_ticket']; 

include_once "class/aws/s3_config.php";
include_once S3CLASS;

if (!$areaAdmin && (in_array($login_fabrica, [160]) or $replica_einhell)) {
    include_once('anexaNF_inc.php');
}

if ($login_fabrica == 175){
    $sql = "SELECT tecnico FROM tbl_tecnico WHERE codigo_externo = '{$login_unico}' AND fabrica IS NULL AND posto = {$login_posto} ";
    $res = pg_query($con,$sql);
    if (pg_num_rows($res) > 0){
        $login_tecnico_id = pg_fetch_result($res,0,'tecnico');        
    }
}

if ((in_array($login_fabrica, [160])) && isset($_GET['os_id']) && $_GET['os_id'] != '' && !$areaAdmin) {
    $os_termo = $_GET['os_id'];

    if (data_corte_termo($os_termo)) {
        $sql_termo = "SELECT campos_adicionais
                      FROM tbl_os_campo_extra
                      WHERE os = {$os_termo}
                      AND fabrica = {$login_fabrica}";
        $res_termo = pg_query($con, $sql_termo);
        if (pg_num_rows($res_termo) == 0) {
            header("Location: termo_entrega.php?os=$os_termo");
        }else{
            $campos_adicionais = json_decode(pg_fetch_result($res_termo, 0, 'campos_adicionais'), true);

            if(!isset($campos_adicionais['termo_entrega_produto'])){
                header("Location: termo_entrega.php?os=$os_termo");
            }
        }
    }
}

if ($areaAdmin === true && empty($login_posto)) {
    $paisOs = getPaisDaFabrica($login_fabrica);
} else if (!empty($login_posto)) {
    $paisOs = getPaisDoPosto($login_posto);
}

if (isset($_POST["ajax_helpdesk_fora_garantia"])) {
    include "os_cadastro_unico/fabricas/os.php";

    $os             = $_POST["os"];

    $arrayCampos = [
        "data_compra"   => $_POST["data_compra"],
        "data_abertura" => $_POST["data_abertura"],
        "produto_id"    => $_POST["produto_id"]
    ];

    $dentroDaGarantia = valida_garantia(true, $arrayCampos);

    $retorno = [
        "exibe_modal" => false
    ];

    if (!$dentroDaGarantia && empty($os)) {

        $dataNf = formata_data($arrayCampos["data_compra"]);

        $sqlVencimentoGarantia = "SELECT ('{$dataNf}'::date + INTERVAL '1 MONTHS' * tbl_produto.garantia)::date as data_vencimento
                                  FROM tbl_produto
                                  WHERE produto = {$arrayCampos['produto_id']}";
        $resVencimentoGarantia = pg_query($con, $sqlVencimentoGarantia);

        $dataVencimento = mostra_data(pg_fetch_result($resVencimentoGarantia, 0, "data_vencimento"));

        $retorno = [
            "exibe_modal" => true,
            "data_vencimento" => $dataVencimento
        ];

    }

    exit(json_encode($retorno));
}

if (isset($_POST['ajax_defeitos_pecas_lancadas'])) {

    if (count($_POST['pecas_lancadas_os']) > 0 && !empty($_POST['defeitos_lancados'])) {

        $defeitos_lancados = explode(",",$_POST['defeitos_lancados']);
        $referencias_pecas = implode("','",array_values($_POST['pecas_lancadas_os']));

        foreach ($defeitos_lancados as $defeito_constatado) {

            $sql = "SELECT peca_defeito_constatado
                    FROM tbl_peca_defeito_constatado
                    WHERE fabrica = {$login_fabrica}
                    AND defeito_constatado = {$defeito_constatado}
                    AND peca IN (SELECT peca 
                                FROM tbl_peca 
                                WHERE referencia IN ('{$referencias_pecas}')
                                AND fabrica = {$login_fabrica})";
            $res = pg_query($con, $sql);

            if (pg_num_rows($res) == 0) {

                $sql_desc_defeito = "SELECT descricao FROM tbl_defeito_constatado WHERE defeito_constatado = {$defeito_constatado}";
                $res_desc_defeito = pg_query($con, $sql_desc_defeito);
                
                $erro = true;
                $retorno = ["erro" => true, 
                    "msg_erro" => utf8_encode(traduz("Por favor, insira as peças do defeito % antes de adicionar outro defeito constatado", null, null, [pg_fetch_result($res_desc_defeito, 0, 'descricao')]))];

            }

        }

    } else if (!empty(trim($_POST['defeitos_lancados']))) {

        $erro = true;
        $retorno = ["erro" => true, 
                    "msg_erro" => utf8_encode(traduz("Por favor, insira as peças antes de adicionar outro defeito constatado"))];

    }

    if (!$erro) {

        $retorno = ["erro" => false];

    }

    exit(json_encode($retorno));

}

if (isset($_POST['ajax_remove_pecas_defeito'])) {

    $defeitos = $_POST['defeito'];

    $remover_pecas = [];

    if (count($_POST['pecas_inseridas']) > 0) {
        foreach ($_POST['pecas_inseridas'] as $chave => $peca) {
            $sql = "SELECT peca
                    FROM tbl_peca 
                    WHERE referencia = '{$peca}'
                    AND fabrica = {$login_fabrica}";
            $res = pg_query($con, $sql);

            $peca_id = pg_fetch_result($res, 0, 'peca');

            $sql = "SELECT peca_defeito_constatado, peca
                    FROM tbl_peca_defeito_constatado
                    WHERE defeito_constatado IN ({$defeitos})
                    AND peca = {$peca_id}";
            $res = pg_query($con, $sql);

            if (pg_num_rows($res) == 0) {
                $remover_pecas[] = $peca_id;
            }

        }
    }

    exit(json_encode(["erro" => false, "pecas_remover" => $remover_pecas]));

}

$s3 = new AmazonTC("os", $login_fabrica);
$anexaS3 = new anexaS3('ve', (int) $login_fabrica);

$os_cortesia    = array(142,145,147,156,164,169,170,176,178);
$usa_km_revenda = array(152,156,163,180,181,182);

if(strlen($_GET['os_id']) > 0){
	$sql = "SELECT status_checkpoint FROM tbl_os WHERE os = {$_GET['os_id']}";
	$res = pg_query($con,$sql);

	$status = pg_fetch_result($res, 0, 'status_checkpoint');

	if($status == 28){
		header("Location: os_press.php?os={$_GET['os_id']}");
	}

}

if (strlen(trim($os)) > 0) {
    $sql = "SELECT status_os,observacao FROM tbl_os_status WHERE os = {$os} AND status_os IN (62,64,65) ORDER BY data DESC LIMIT 1;";
    $res = pg_query($con,$sql);

    if (pg_num_rows($res) > 0) {
        $status     = pg_fetch_result($res, 0, 'status_os');
        if($status == '65') {
            header("Location: os_press.php?os=$os");
        }
    }else{
	$sql = "SELECT status_checkpoint FROM tbl_os WHERE os = {$os}";
	$res = pg_query($con,$sql);

	$status = pg_fetch_result($res, 0, 'status_checkpoint');

	if($status == 28){
		header("Location: os_press.php?os=$os");
	}
    }
}else{
    if($login_credenciamento == 'EM DESCREDENCIAMENTO' and strlen($_GET['os_id']) == 0 and !$_REQUEST["ajax"]) {
			if($_REQUEST['ajax_anexo_upload'] !='t' ) {
				header("Location: menu_os.php");
			}
    }
}

$mensagem_anexo_obrigatorio = "";

if (in_array($login_fabrica, [152,180,181,182])) {
    $mensagem_anexo_obrigatorio = traduz('Anexos obrigatórios: Nota Fiscal, Foto e Formulário');
}

if(in_array($login_fabrica, array(158))){
    if($_POST["search_list_subitem"]){
        $produto = $_POST["produto"];
        $peca    = $_POST["peca"];

        $sql_subitem = "SELECT 
                tbl_peca_container.peca_container,
                tbl_peca_container.qtde,
                tbl_peca.referencia,
                tbl_peca.descricao,
                tbl_peca_container.peca_filha
            FROM tbl_peca_container
                JOIN tbl_peca ON tbl_peca.peca = tbl_peca_container.peca_filha
                    AND tbl_peca.fabrica = tbl_peca_container.fabrica
            WHERE tbl_peca_container.peca_mae = {$peca}
                AND tbl_peca_container.fabrica = {$login_fabrica}
                AND tbl_peca_container.produto = {$produto}";
        $res_subitem = pg_query($con,$sql_subitem);

        if(pg_num_rows($res_subitem) > 0){
            for($i = 0; $i < pg_num_rows($res_subitem); $i++){
                $peca_container  = pg_fetch_result($res_subitem, $i, peca_container);
                $peca_qtde       = pg_fetch_result($res_subitem, $i, qtde);
                $peca_referencia = pg_fetch_result($res_subitem, $i, referencia);
                $peca_descricao  = pg_fetch_result($res_subitem, $i, descricao);
                $peca_filha      = pg_fetch_result($res_subitem, $i, peca_filha);
                $peca_descricao  = mb_detect_encoding($peca_descricao, 'UTF-8', true) ? utf8_decode($peca_descricao) : $peca_descricao;

                $subitem[] = array(
                    "peca"       => $peca_filha,
                    "referencia" => $peca_referencia,
                    "descricao"  => $peca_descricao
                );
            }
            $result = array(
                "success" => true,
                "subitem" => $subitem
            );
        } else {
            $result = array(
                "success" => false
            );
        }
        echo json_encode($result);
        exit;
    }
}

if (in_array($login_fabrica, [177, 198])) {
    $tipo_posto_interno = 'f';
    $osId = $_GET['os_id'];
    $postoId = $login_posto;

    if (empty($login_posto)) {
        $qPostoId = "SELECT tos.posto
                     FROM tbl_os tos
                     JOIN tbl_fabrica tf ON tf.fabrica = tos.fabrica
                     JOIN tbl_posto_fabrica tpf ON tpf.fabrica = tf.fabrica AND tpf.posto = tos.posto
                     WHERE tos.os = {$osId}
                     AND tf.fabrica = {$login_fabrica}";
        $rPostoId = pg_query($con, $qPostoId);
        $postoId  = pg_fetch_result($rPostoId, 0, 'posto');
    }

    $qTipoPosto = "SELECT ttp.tipo_posto,
                          ttp.ativo,
                          ttp.posto_interno
                   FROM tbl_tipo_posto ttp
                   JOIN tbl_posto_fabrica tpf ON tpf.tipo_posto = ttp.tipo_posto
                   JOIN tbl_posto tp ON tp.posto = tpf.posto
                   WHERE tp.posto = {$postoId}
                   AND tpf.fabrica = {$login_fabrica}
                   AND ttp.posto_interno IS TRUE";
    $rTipoPosto = pg_query($con, $qTipoPosto);

    if (strlen(pg_last_error()) == 0 AND pg_num_rows($rTipoPosto) > 0)
        $tipo_posto_interno = 't';
}

if(file_exists("os_cadastro_unico/fabricas/{$login_fabrica}/ajax.php")){
    include_once "os_cadastro_unico/fabricas/{$login_fabrica}/ajax.php";
}

if (!empty($_REQUEST['ajax_recarrega_estados'])) {
	$paisOs = $_REQUEST['pais'];
	$resEstadosDoPais = getListaDeEstadosDoPais($paisOs);

	echo json_encode($resEstadosDoPais);
	exit;
}

if ($login_fabrica == 161 and !empty($_POST["verifica_familia_autoclave"])) {
    $referencia = $_POST["produto_referencia"];

    if (empty($referencia)) {
        header("HTTP/1.1 400 Bad Request");
        header("Content-Type: application/json");
        die('{"error": "Bad request"}');
    }

    $sql = "SELECT produto FROM tbl_produto
        JOIN tbl_familia USING(familia)
        WHERE referencia = '$referencia'
        AND fabrica = $login_fabrica
        AND UPPER(tbl_familia.descricao) LIKE ('%AUTOCLAVE%')";
    $qry = pg_query($con, $sql);

    if (pg_num_rows($qry) > 0) {
        header("Content-Type: application/json");
        die('{"message": "Ok"}');
    }

    header("HTTP/1.1 404 Not Found");
    header("Content-Type: application/json");
    die('{"error": "Not found"}');
}

if (isset($_POST['ajax_verifica_reincidencia'])) {

    $nota_fiscal    = $_POST['nota_fiscal'];
    $cnpj_revenda   = $_POST['cnpj_revenda'];
    $produto_id     = $_POST['produto_id'];
    $os             = $_POST['os'];

    if (!empty($os)) {
        $cond_os = "AND tbl_os.os < {$os}";
    }

    $sql = "SELECT tbl_os.sua_os, tbl_os.os
               FROM tbl_os
               INNER JOIN tbl_os_produto ON tbl_os_produto.os = tbl_os.os
               WHERE tbl_os.fabrica = {$login_fabrica}
               AND tbl_os.data_abertura > (CURRENT_DATE - INTERVAL '90 days')
               AND tbl_os.excluida IS NOT TRUE
               {$cond_os}
               AND tbl_os.nota_fiscal = '{$nota_fiscal}'
               AND tbl_os.revenda_cnpj = '".preg_replace("/[\.\-\/]/", "", $cnpj_revenda)."'
               AND tbl_os_produto.produto = {$produto_id}
               AND tbl_os.consumidor_revenda='C'
               ORDER BY tbl_os.data_abertura DESC
               LIMIT 1";
    $res = pg_query($con, $sql);

    if (pg_num_rows($res) > 0) {
        $retorno = ["reincidente" => true, "os_reincidente" => pg_fetch_result($res, 0, 'sua_os')];
    } else {
        $retorno = ["reincidente" => false];
    }

    exit(json_encode($retorno));

}

if ($login_fabrica == 175 AND $_POST["ajax"] == "sim" AND $_POST["acao"] == "valida_data_venda"){
    $produto        = $_POST["produto"];
    $serie          = $_POST["serie"];
    $data_abertura  = $_POST["data_abertura"];
    
    $sql = "
        SELECT  tbl_numero_serie.data_venda,
                tbl_produto.garantia
        FROM    tbl_numero_serie
        JOIN    tbl_produto USING(produto)
        WHERE   tbl_numero_serie.fabrica = {$login_fabrica}
        AND     tbl_numero_serie.serie = '{$serie}'
        AND     tbl_produto.fabrica_i = $login_fabrica
        AND     tbl_produto.produto = $produto";
    $res = pg_query($con, $sql);
    if (pg_num_rows($res) > 0){
        $data_venda = pg_fetch_result($res, 0, 'data_venda');
        $garantia = pg_fetch_result($res, 0, 'garantia');
        
        $fora_garantia_venda = (strtotime("$data_venda+{$garantia} months") < strtotime(formata_data($data_abertura))) ? true : false;
        
        if ($fora_garantia_venda === true){
            exit(json_encode(array("ok" => "fora_garantia", "data_venda" => $data_venda)));
        }else{
            exit(json_encode(array("ok" => "nao_valida", "data_venda" => $data_venda)));
        }
    }
    exit(json_encode(array("ok" => "erro_serie")));
}

if ($login_fabrica == 178){
    if ($_POST["ajax"] == "sim" AND $_POST["acao"] == "servico_realizado_estoque"){
        $peca = $_POST["peca"];
        $posto = $_POST['posto'];

        $sql = "SELECT qtde FROM tbl_estoque_posto WHERE fabrica = $login_fabrica AND posto = $posto AND peca = $peca";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0){
            $qtde = pg_fetch_result($res, 0, 'qtde');

            if ($qtde >= 1){
                exit(json_encode(array("ok" => "success")));
            }
        }
        exit(json_encode(array("ok" => "error")));
    }

    if ($_POST["ajax"] == "sim" AND $_POST["acao"] = "marcas_produto"){
        $marcas = $_POST["marcas"];
        $marcas = json_decode($marcas, true);

        $sqlMarcas = "
            SELECT marca, nome 
            FROM tbl_marca 
            WHERE fabrica = $login_fabrica
            AND marca IN (".$marcas['marcas'].")
        ";
        $resMarcas = pg_query($con, $sqlMarcas);

        if (pg_num_rows($resMarcas) > 0){
            $array_marcas = pg_fetch_all($resMarcas);
            exit(json_encode(array("ok" => "success", "result" => $array_marcas)));
        }else{
            exit(json_encode(array("ok" => "error")));
        }
        exit;
    }
}

$j_ajax_excluir_pecas = filter_input(INPUT_POST, 'ajax_excluir_pecas'); // HD - 6803754 - JP

if( $j_ajax_excluir_pecas == true AND $login_fabrica == 177 ){
    $j_os = filter_input(INPUT_POST, 'os_enviada');
    $responseJson = []; // array de resposta
  
    // SQL OS
    $stmt = $pdo->prepare("SELECT os_produto FROM tbl_os_produto WHERE os = :os");
    $stmt->bindValue(':os', $j_os);

    // Verifica se foi encontrado a OS
    if( !$stmt->execute() OR $stmt->rowCount() == 0 ){
        $responseJson["error"]   = true;
        $responseJson["message"] = "Nenhum resultado encontrado para OS = {$j_os}";
    }else{
        $j_os_produto = $stmt->fetch(PDO::FETCH_ASSOC);

        try{
            $pdo->beginTransaction();

            // Selciona o OS_ITEM
            $stmt = $pdo->prepare("SELECT os_item FROM tbl_os_item WHERE os_produto = :os_produto");
            $stmt->bindValue(":os_produto", $j_os_produto['os_produto']);
            $stmt->execute();
            $j_os_item = $stmt->fetch(PDO::FETCH_ASSOC);

            // Verifica se existe peça vinculada
            $stmt = $pdo->prepare('SELECT count(*) FROM tbl_os_item WHERE os_item = :os_item');
            $stmt->bindValue(':os_item', $j_os_item['os_item']);

            if( $stmt->execute() AND $stmt->rowCount() > 0 ){
                // Deleta do BI
                $stmt = $pdo->prepare("DELETE FROM bi_os_item WHERE os_item = :os_item");
                $stmt->bindValue(':os_item', $j_os_item['os_item']);
                $stmt->execute();

                // Deleta
                $stmt = $pdo->prepare("DELETE FROM tbl_os_item WHERE os_produto = :os_produto");
                $stmt->bindValue(':os_produto', $j_os_produto['os_produto']);
                $stmt->execute();
            }
            $pdo->commit();

            $responseJson["error"] = false;
            $responseJson["message"] = "Produto alterado com sucesso";
        }catch(PDOException $e){
            $pdo->rollback();

            $responseJson["error"] = true;
            $responseJson["message"] = "Erro ao alterar produto";  
        }
    }

    exit(json_encode($responseJson));
}

function getTecnicosTreinamentoProduto($produto, $posto) {
    global $con, $login_fabrica;
    
    $sql = "
        SELECT DISTINCT x.*
        FROM (
            SELECT 
                tecnico,
                nome,
                codigo_externo,
                ativo 
            FROM tbl_tecnico 
            WHERE posto = {$posto}
            AND ativo IS TRUE
            AND fabrica IS NULL
        ) x
        INNER JOIN tbl_treinamento t ON t.fabrica = {$login_fabrica}
        INNER JOIN tbl_treinamento_tipo tt ON tt.treinamento_tipo = t.treinamento_tipo
        INNER JOIN tbl_treinamento_produto tp ON tp.treinamento = t.treinamento
        INNER JOIN tbl_treinamento_posto a ON a.treinamento = t.treinamento AND a.tecnico = x.tecnico
        WHERE tp.produto = {$produto}
        AND (
            (
                LOWER(tt.nome) = 'online'
                AND a.aprovado IS TRUE
            )
            OR
            (
                LOWER(tt.nome) != 'online'
                AND a.aprovado IS TRUE
                AND a.validade_certificado >= CURRENT_DATE
            )
        )
        ORDER BY x.nome ASC
    ";
    return pg_query($con, $sql);
}

if (isset($_POST['ajax']) && $_POST['acao'] == 'tecnico_treinamento_produto') {
    $res = getTecnicosTreinamentoProduto($_POST['produto'], $_POST['posto']);
    $tecnicos = pg_fetch_all($res);
    $tecnicos = array_map(function($t) {
        $t['nome'] = utf8_encode($t['nome']);
        return $t;
    }, $tecnicos);
    
    exit(json_encode(array('tecnicos' => $tecnicos)));
}

if (isset($_POST['ajax']) && $_POST['ajax'] == 'sim' && $_POST['action'] == 'default_valores_adicionais') {
    $sql = "SELECT valores_adicionais FROM tbl_fabrica WHERE fabrica = {$login_fabrica} ";
    $resVA = pg_query($con,$sql);
    $valores_adicionais = pg_fetch_result($resVA, 0, 'valores_adicionais');
    $valores_adicionais = json_decode($valores_adicionais, true);

    exit(json_encode(array("ok" => count($valores_adicionais))));
}

// Tratamento de requisições AJAX... {{{
if (isset($_POST['ajax']) && $_POST['ajax'] == 'sim' && isset($_POST['serie_bloqueada'])) {
    $serie = $_POST['serie_bloqueada'];
    $produto = $_POST['produto'];

    $sql = "SELECT serie_controle FROM tbl_serie_controle WHERE fabrica = {$login_fabrica} AND produto = {$produto} AND serie = '{$serie}'";
    $res = pg_query($con, $sql);
    exit(json_encode(array("ok" => pg_num_rows($res))));
}

if ($_GET["ajax_rota"]) {
    $posto      = $_GET["posto"];
    $consumidor = $_GET["consumidor"];

    $rotaPC = googleMapsGeraRota($posto, $consumidor);
    $rotaCP = googleMapsGeraRota($posto, $consumidor);

    exit(json_encode(array("pc" => $rotaPC, "cp" => $rotaCP)));
}


if ($_POST['ajax_grava_motivo_duplica'] == true) {

    $dados = $_POST['dados'];

    $sql = "SELECT tbl_os_item.pedido, tbl_os_item.peca, tbl_os_item.os_item, tbl_os_item.parametros_adicionais
                FROM tbl_os_item
                JOIN tbl_os_produto ON tbl_os_produto.os_produto = tbl_os_item.os_produto
                JOIN tbl_os ON tbl_os.os = tbl_os_produto.os
                WHERE tbl_os.fabrica = {$login_fabrica} 
                AND tbl_os_item.os_item=".$dados["peca_duplicada_item"];
                
    $res = pg_query($con, $sql);

    if (pg_num_rows($res) > 0) {
        if (in_array($login_fabrica, [167, 203])) {
            $parametrosAdd = json_decode(pg_fetch_result($res, 0, 'parametros_adicionais'), 1);
            $parametrosAdd["tevePecaReenviada"] = true;

            $sqlUP = "UPDATE tbl_os_item 
                        SET parametros_adicionais='".json_encode($parametrosAdd)."'
                        WHERE os_item=".$dados["peca_duplicada_item"];
            $resUP = pg_query($con, $sqlUP);
            if (pg_last_error()) {
                exit(json_encode(array('erro' => true, "msg" => "Erro ao gravar o motivo")));
            }
            
            exit(json_encode($dados));
        } else {
            $parametrosAdd = json_decode(pg_fetch_result($res, 0, 'parametros_adicionais'), 1);
            $parametrosAdd["pecaReenviada"] = true;
            $condicao = "";
            if ($dados["peca_extraviada"] == true) {
                $condicao = " , peca_obrigatoria='f' ";
            }

            $sqlUP = "UPDATE tbl_os_item 
                         SET obs='".str_replace(["'", '"'], "", $dados["motivo_solicitacao"])."', parametros_adicionais='".json_encode($parametrosAdd)."'
                            {$condicao} 
                       WHERE os_item=".$dados["peca_duplicada_item"];
            $resUP = pg_query($con, $sqlUP);
            if (pg_last_error()) {
                exit(json_encode(array('erro' => true, "msg" => "Erro ao gravar o motivo")));
            }
            exit(json_encode(array('erro' => false, "msg" => "Motivo gravado com sucesso")));
        }
    } else {
        exit(json_encode(array('erro' => true, "msg" => "Erro ao gravar o motivo")));
    }
}

if ($_POST['ajax_duplica'] == true) {

    $dados = current($_POST['dados']);

    $sql = "SELECT tbl_os_item.pedido, tbl_os_item.peca, tbl_os_item.os_item
                FROM tbl_os_item
                JOIN tbl_os_produto ON tbl_os_produto.os_produto = tbl_os_item.os_produto
                JOIN tbl_os ON tbl_os.os = tbl_os_produto.os
                JOIN tbl_pedido ON tbl_pedido.pedido = tbl_os_item.pedido AND tbl_pedido.fabrica = {$login_fabrica} AND tbl_pedido.status_pedido IN (4,5)
                WHERE tbl_os.fabrica = {$login_fabrica} 
                AND tbl_os_item.peca=".$dados["peca"]."
                AND tbl_os.os=".$_GET["os_id"];
    $res = pg_query($con, $sql);

    if (pg_num_rows($res) > 0) {
        $xpedido = pg_fetch_result($res, 0, 'pedido');
        $xpeca = pg_fetch_result($res, 0, 'peca');
        $xositem = pg_fetch_result($res, 0, 'os_item');

        exit(json_encode(array('motivo' => true, "xpedido" => $xpedido, "xpeca" => $xpeca, "xositem" => $xositem, "peca" => $dados)));
    } else {
        exit(json_encode(array('motivo' => false, "peca" => $dados)));
    }
}

if ($_POST['ajax'] == 'sim' && $_POST['consulta'] == 'qtde_listabasica') {
    $peca    = $_POST['peca'];
    $produto = $_POST['produto'];
    $serie = $_POST['serie'];

    if (in_array($login_fabrica, array(169,170)) && !empty($serie)) {
        $sqlLbSerie = "
            SELECT
                nsp.qtde
            FROM tbl_numero_serie_peca nsp
            JOIN tbl_numero_serie ns ON ns.numero_serie = nsp.numero_serie AND ns.fabrica = {$login_fabrica}
            LEFT JOIN tbl_produto pd ON ns.produto = pd.produto AND pd.fabrica_i = {$login_fabrica}
            WHERE nsp.fabrica = {$login_fabrica}
            AND ns.serie = '{$serie}'
            AND pd.produto = {$produto}
            AND nsp.peca = {$peca};
        ";
        $resLbSerie = pg_query($con, $sqlLbSerie);

        if (pg_num_rows($resLbSerie) > 0) {
            $quantidade = pg_fetch_result($resLbSerie, 0, qtde);
            exit(json_encode(array('ok' => $quantidade)));
        }
    }
    
    if ($login_fabrica == 175) {
        $ordem_producao = substr($serie, 0, 6);
        
        $sql_producao = "
            SELECT xxx.* 
            FROM (
                SELECT DISTINCT ON(xx.ordem_producao) xx.ordem_producao::float, CASE WHEN xx.proxima_ordem IS NULL THEN float8'+infinity' ELSE xx.proxima_ordem - 1 END AS proxima_ordem
                FROM (
                    SELECT x.ordem_producao, lt.ordem_producao::integer AS proxima_ordem FROM(
                        SELECT DISTINCT ordem_producao::integer
                        FROM tbl_lista_basica
                        WHERE fabrica = {$login_fabrica}
                        AND produto = {$produto}
                        ORDER BY ordem_producao ASC
                    ) x
                    LEFT JOIN tbl_lista_basica lt ON lt.ordem_producao::integer > x.ordem_producao AND lt.fabrica = {$login_fabrica} AND lt.produto = {$produto}
                    ORDER BY x.ordem_producao ASC, proxima_ordem ASC
                ) xx
                ORDER BY xx.ordem_producao, xx.proxima_ordem ASC
            ) xxx
            WHERE '{$ordem_producao}'::float BETWEEN xxx.ordem_producao AND xxx.proxima_ordem
        ";
        $res_producao = pg_query($con, $sql_producao);
        
        if (pg_num_rows($res_producao) > 0){
            $op_pesquisa = pg_fetch_result($res_producao, 0, 'ordem_producao');
            
            if (preg_match("/^0{1,}/", $ordem_producao, $zero_op)) {
                $op_pesquisa = $zero_op[0].$op_pesquisa;
            }
            
            $whereOrdemProducao = "AND tbl_lista_basica.ordem_producao = '{$op_pesquisa}'";
        }
    }

    $sql = "
        SELECT qtde
        FROM tbl_lista_basica
        JOIN tbl_produto ON tbl_produto.produto = tbl_lista_basica.produto AND tbl_produto.fabrica_i = {$login_fabrica}
        WHERE tbl_lista_basica.fabrica = {$login_fabrica}
        AND tbl_lista_basica.peca = {$peca}
        AND tbl_produto.produto = '{$produto}'
        {$whereOrdemProducao}
    ";

    $res = pg_query($con, $sql);

    if (pg_num_rows($res) > 0) {
        $quantidade = pg_fetch_result($res, 0, 'qtde');
        exit(json_encode(array('ok' => $quantidade)));
    }

    exit(json_encode(array('erro' => '0')));
}

if ($_POST['ajax'] == 'sim' && $_POST['ja_anexou'] == 'verificar') {
    $id_os_termo = $_POST['os'];

    if (data_corte_termo($id_os_termo)) {
        $sql_ja_gerou = "SELECT JSON_FIELD('termo_entrega_produto', campos_adicionais) AS ja_gerou 
                         FROM tbl_os_campo_extra 
                         WHERE os = $id_os_termo 
                         AND fabrica = $login_fabrica";
        $res_ja_gerou = pg_query($con, $sql_ja_gerou);

        $ja_gerou = pg_fetch_result($res_ja_gerou, 0, 'ja_gerou');

        if (empty($ja_gerou)) {
            exit(json_encode(array('erro' => 'nao_gerou')));
        }

        $sql_ja_anexou = "SELECT JSON_FIELD('typeId', obs) AS termo_entrega 
                          FROM tbl_tdocs 
                          WHERE fabrica = $login_fabrica 
                          AND referencia_id = $id_os_termo
                          AND situacao = 'ativo'
                          AND JSON_FIELD('typeId', obs) = 'termo_entrega' ";
        $res_ja_anexou = pg_query($con, $sql_ja_anexou);
        $ja_anexou = pg_fetch_result($res_ja_anexou, 0, 'termo_entrega');
         
        if (empty($ja_anexou)) {
            exit(json_encode(array('erro' => 'nao_anexou')));
        } else {
            exit(json_encode(array('ok' => 'ok')));        
        }
    } else {
        exit(json_encode(array('ok' => 'ok')));
    }
}

if ($_POST['ajax'] == 'sim' && $_POST['consulta'] == 'retorna_peca_cancelada') {
    $peca    = $_POST['peca'];
    $produto = $_POST['produto'];
    $serie = $_POST['serie'];

    $sql = "
        SELECT qtde
        FROM tbl_lista_basica
        JOIN tbl_produto ON tbl_produto.produto = tbl_lista_basica.produto AND tbl_produto.fabrica_i = {$login_fabrica}
        WHERE tbl_lista_basica.fabrica = {$login_fabrica}
        AND tbl_lista_basica.peca = {$peca}
        AND tbl_produto.referencia = '{$produto}';
    ";

    $res = pg_query($con, $sql);

    if (pg_num_rows($res) > 0) {
        $quantidade = pg_fetch_result($res, 0, 'qtde');
        exit(json_encode(array('ok' => $quantidade)));
    }

    exit(json_encode(array('erro' => '0')));
}

if ($_POST["ajax_verifica_recall"]) {

    $produto_id = $_POST["produto_id"];
    $serie      = $_POST["serie"];
    $fabrica    = $_POST["fabrica"];

    $sql = "
        SELECT
            tbl_produto_recall.peca, tbl_peca.referencia, tbl_peca.descricao
        FROM tbl_produto_recall
        JOIN tbl_peca ON tbl_peca.peca = tbl_produto_recall.peca
        WHERE tbl_produto_recall.produto = {$produto_id}
        AND '{$serie}' BETWEEN serie_inicial AND serie_final
        AND tbl_produto_recall.fabrica = {$fabrica};
    ";

    $res = pg_query($con,$sql);

    if (pg_num_rows($res) > 0) {
        echo traduz("existe.um.recall.para.esse.produto.as.peças.informadas.abaixo.precisam.ser.trocadas.e.serão.inseridas.automaticamente.nesta.ordem.de.serviço").":";
        for ($i = 0; $i < pg_num_rows($res); $i++) {
            $referencia = pg_fetch_result($res, $i, 'referencia');
            $descricao = pg_fetch_result($res, $i, 'descricao');

            echo "\n $referencia - $descricao";
        }
    }

    exit;

}

if ($_POST['ajax'] == 'sim' && $_POST['action'] == 'verifica_certificado_tecnico'){
    $produto_id = $_POST['produto_id'];
    $linha_id   = $_POST['linha_id'];

    $sql_treinamento = "SELECT DISTINCT
                    tp.treinamento,
                    tp.aprovado
            FROM tbl_treinamento t
                INNER JOIN tbl_treinamento_tipo        ON tbl_treinamento_tipo.nome = $1 AND tbl_treinamento_tipo.fabrica = {$login_fabrica}
                INNER JOIN tbl_treinamento_produto tpd ON tpd.treinamento = t.treinamento 
                    AND tpd.fabrica  = {$login_fabrica} 
                    AND (tpd.produto = {$produto_id}   OR tpd.linha = {$linha_id})
                LEFT JOIN tbl_treinamento_posto tp     ON tp.treinamento = t.treinamento 
                    AND tp.tecnico   = {$login_tecnico_id}
            WHERE t.fabrica          = {$login_fabrica}
                AND tp.aprovado IS TRUE";
    $res_treinamento = pg_query_params($con,$sql_treinamento,array('Online'));

    // ONLINES
    if (pg_num_rows($res_treinamento) > 0){
        for ($i=0; $i<pg_num_rows($res_treinamento); $i++){
            $aprovado = pg_fetch_result($res_treinamento,$i,'aprovado');
        
            if ($aprovado == 't'){
                exit(json_encode(array("ok" => "true")));         
            }else{
                exit(json_encode(array("erro" => "true")));
            }
        }
    }else{
        // PRESENCIAIS 
        $sql_treinamento .= " AND tp.validade_certificado >= CURRENT_DATE; ";
        $res_treinamento  = pg_query_params($con,$sql_treinamento,array('Presencial'));

        if (pg_num_rows($res_treinamento) > 0){
            for ($i=0; $i<pg_num_rows($res_treinamento); $i++){
                $aprovado = pg_fetch_result($res_treinamento,$i,'aprovado');
            
                if ($aprovado == 't'){
                    exit(json_encode(array("ok" => "true")));
                }else{
                    exit(json_encode(array("erro" => "true")));
                }
            }
        }    
    }
exit;
}

if(in_array($login_fabrica,array(35)) && isset($_POST['limpa_movimento_estoque2']) && isset($_POST['os'])){

    $os         = $_POST['os'];
    $servico    = $_POST['servico'];
    $qtde       = $_POST['qtde'];
    $referencia = $_POST['referencia'];

    /*
        Verifica se o campo ressarcimento do servico realizao é true
        se for true estoque antigo se não estoque pulmão
    */
    if (strlen($servico)>0){
        $sql_tipo_estoque = "SELECT ressarcimento
                            FROM tbl_servico_realizado
                            WHERE fabrica = $login_fabrica AND servico_realizado = $servico";
        $res_tipo_estoque = pg_query($con, $sql_tipo_estoque);

        if(pg_num_rows($res_tipo_estoque) > 0){

            $ressarcimento = pg_fetch_result($res_tipo_estoque, 0, 'ressarcimento');
            $tipo_estoque = ($ressarcimento == 't') ? "estoque" : "pulmao";

        }
    }

    // Pega o id da peça
    $sql_peca = "SELECT peca FROM tbl_peca WHERE referencia = '$referencia'";
    $res_peca = pg_query($con, $sql_peca);

    if (pg_num_rows($res_peca) > 0) {
        $peca = pg_fetch_result($res_peca, 0, 'peca');

        if($tipo_estoque == "pulmao"){

            $sql_vm = "SELECT qtde_saida
                       FROM tbl_estoque_posto_movimento
                       WHERE os = $os
                       AND fabrica = $login_fabrica
                       AND posto = $login_posto
                       AND peca = $peca
                       AND tipo = 'estoque'";
            $res_vm = pg_query($con, $sql_vm);

            if(pg_num_rows($res_vm) > 0){

                $qtde_saida = pg_fetch_result($res_vm, 0, 'qtde_saida');

                $sql_update = "UPDATE tbl_estoque_posto
                               SET qtde = qtde + $qtde_saida
                               WHERE fabrica = $login_fabrica
                               AND posto = $login_posto
                               AND tipo = 'estoque'
                               AND peca = $peca";
                $res_update = pg_query($con, $sql_update);

                $sql_dm = "DELETE FROM tbl_estoque_posto_movimento
                            WHERE os = $os
                            AND fabrica = $login_fabrica
                            AND posto = $login_posto
                            AND peca = $peca
                            AND tipo = 'estoque'";
                $res_dm = pg_query($con, $sql_dm);
            }
        }else{

            $sql_vm = "SELECT qtde_saida
                       FROM tbl_estoque_posto_movimento
                       WHERE os = $os
                       AND fabrica = $login_fabrica
                       AND posto = $login_posto
                       AND peca = $peca
                       AND tipo = '$tipo_estoque'";
            $res_vm = pg_query($con, $sql_vm);

            if(pg_num_rows($res_vm) > 0){

                $qtde_saida = pg_fetch_result($res_vm, 0, 'qtde_saida');

                $sql_update = "UPDATE tbl_estoque_posto
                               SET qtde = qtde + $qtde_saida
                               WHERE fabrica = $login_fabrica
                               AND posto = $login_posto
                               AND tipo = '$tipo_estoque'
                               AND peca = $peca";
                $res_update = pg_query($con, $sql_update);

                $sql_dm = "DELETE FROM tbl_estoque_posto_movimento
                            WHERE os = $os
                            AND fabrica = $login_fabrica
                            AND posto = $login_posto
                            AND peca = $peca
                            AND tipo = '$tipo_estoque'";
                $res_dm = pg_query($con, $sql_dm);
            }
        }
    }

    exit;
}

if(isset($_POST["busca_revenda"])){

    $cnpj = trim($_POST["cnpj"]);

    $retorno["retorno"] = "false";

    if ($login_fabrica == 161) {
        $sql = "
            SELECT
                revenda,
                contato_razao_social AS nome,
                contato_endereco AS endereco,
                contato_numero AS numero,
                contato_complemento AS complemento,
                contato_bairro AS bairro,
                contato_cep AS cep,
                cidade,
                contato_fone AS fone
            FROM tbl_revenda_fabrica
            WHERE cnpj = '{$cnpj}'
            AND fabrica = {$login_fabrica}
            LIMIT 1;
        ";
    } else {
        $sql = "
            SELECT
                revenda,
                nome,
                endereco,
                numero,
                complemento,
                bairro,
                cep,
                cidade,
                fone
            FROM tbl_revenda
            WHERE cnpj = '{$cnpj}'
            AND ativo IS TRUE
            LIMIT 1;
        ";
    }

    $res = pg_query($con, $sql);

    if(pg_num_rows($res) > 0 ){

        $retorno["retorno"] = "true";

        $cidade = pg_fetch_result($res, 0, "cidade");

        if(strlen($cidade) > 0){

            $sql_estado = "SELECT nome AS cidade, estado FROM tbl_cidade WHERE cidade = {$cidade}";
            $res_estado = pg_query($con, $sql_estado);

            $cidade = (pg_num_rows($res_estado) > 0) ? pg_fetch_result($res_estado, 0, "cidade") : $cidade;
            $estado = (pg_num_rows($res_estado) > 0) ? pg_fetch_result($res_estado, 0, "estado") : "";

        }

        $retorno["revenda"]     = pg_fetch_result($res, 0, "revenda");
        $retorno["nome"]        = pg_fetch_result($res, 0, "nome");
        $retorno["endereco"]    = pg_fetch_result($res, 0, "endereco");
        $retorno["numero"]      = pg_fetch_result($res, 0, "numero");
        $retorno["complemento"] = pg_fetch_result($res, 0, "complemento");
        $retorno["bairro"]      = pg_fetch_result($res, 0, "bairro");
        $retorno["cep"]         = pg_fetch_result($res, 0, "cep");
        $retorno["cidade"]      = $cidade;
        $retorno["estado"]      = $estado;
        $retorno["fone"]        = pg_fetch_result($res, 0, "fone");

    }

    exit(json_encode($retorno));
}

if(isset($_POST["verifica_serie_peca"])){ //HD-3428297

    $id_peca = trim($_POST["id_peca"]);

    $retorno["retorno"] = "false";

    $sql = "SELECT
                tbl_peca.numero_serie_peca
            FROM tbl_peca
            WHERE tbl_peca.peca = '{$id_peca}'
                AND tbl_peca.numero_serie_peca IS TRUE";
    $res = pg_query($con, $sql);

    if(pg_num_rows($res) > 0 ){
        $numero_serie_peca = pg_fetch_result($res,0,"numero_serie_peca");
        $retorno["retorno"]     = "true";
        $retorno = array("retorno" => "true", "numero_serie_peca" => "$numero_serie_peca");
    }
    exit(json_encode($retorno));
}

if(isset($_POST["verifica_servico_peca"])){ //HD-3428297

    $retorno["retorno"] = "false";

    $sql = "SELECT
                servico_realizado
            FROM tbl_servico_realizado
            WHERE fabrica = {$login_fabrica}
            AND gera_pedido IS TRUE
            AND troca_de_peca IS TRUE
            AND ativo IS TRUE";
    $res = pg_query($con, $sql);

    if(pg_num_rows($res) > 0 ){
        $id_servico_realizado = pg_fetch_result($res,0,"servico_realizado");
        $retorno["retorno"]     = "true";
        $retorno = array("retorno" => "true", "id_servico_realizado" => "$id_servico_realizado");
    }
    exit(json_encode($retorno));
}

if (isset($_POST["ajax_pega_acessorios"])) {

    $produto_id    = (int)$_POST["produto_id"];
    $login_fabrica = (int)$_POST["login_fabrica"];

    $sql = "SELECT tbl_peca.descricao, tbl_peca.referencia, tbl_lista_basica.type
              FROM tbl_lista_basica
              JOIN tbl_peca ON tbl_lista_basica.peca = tbl_peca.peca
             WHERE tbl_lista_basica.produto = $produto_id
               AND tbl_lista_basica.fabrica = $login_fabrica
               AND tbl_lista_basica.type    = 'acessorio'";
    $res = pg_query($con, $sql);
    if(pg_num_rows($res)>0){
        echo "<table>";
        for($i=0; $i<pg_num_rows($res); $i++){

            $descricao  = pg_fetch_result($res, $i, 'descricao');
            $referencia = pg_fetch_result($res, $i, 'referencia');

            if($i == 0){
                echo " <tr class='$i'>";
            }elseif($i % 3 == 0){
                echo "</tr  class='$i'>";
                echo " <tr class='$i'>";
            }

            echo "<td>
                <input id='produto_acessorio' name='produto[acessorio][$descricao]' type='checkbox' value='$descricao' />
            ".substr($descricao, 0, 27). "&nbsp&nbsp&nbsp
            </td>";
        }
        echo "</table>";
    }

    exit;
}

if (isset($_POST["ajax_verifica_estoque"])) {

    $posto   = $_POST["posto"];
    $peca    = $_POST["peca"];
    $os      = $_POST["os"];
    $qtde    = $_POST["qtde"];
    $excluir = $_POST["excluir"];

    $sql = "SELECT qtde_saida
            FROM tbl_estoque_posto_movimento
            WHERE posto = $posto
            AND os = $os
            AND peca = $peca ";
    $res = pg_query($con, $sql);

    if(pg_num_rows($res)>0){
        $qtde_saida = pg_fetch_result($res, 0, "qtde_saida");

        if(($qtde != $qtde_saida) or($excluir == 1)){
            $sql_del = "DELETE FROM tbl_estoque_posto_movimento
                        WHERE posto = $posto
                        AND os = $os
                        AND peca = $peca ";
            $res_del = pg_query($con, $sql_del);

            $sql_upd = "UPDATE tbl_estoque_posto SET qtde = qtde + $qtde_saida where peca = $peca ";
            $res_upd = pg_query($con, $sql_upd);
        }
    }
    exit;
}

if (isset($_POST["verificaPreOs"])) {

    $cpf_consumidor = $_POST['cpf'];
    $posto          = $_POST["posto"];
    $fabrica        = $_POST['fabrica'];

    if($campos['os']['hd_chamado'] == ''){

        $retirar = array(".", '-');

        $cpf_consumidor = str_replace($retirar, "", $cpf_consumidor);

        $sql = "SELECT tbl_hd_chamado.hd_chamado, tbl_posto.nome, tbl_produto.descricao, tbl_produto.referencia
                FROM tbl_hd_chamado_extra
                INNER JOIN tbl_hd_chamado using(hd_chamado)
                INNER JOIN tbl_posto_fabrica on tbl_posto_fabrica.posto = tbl_hd_chamado_extra.posto and tbl_posto_fabrica.fabrica = $fabrica
                inner join tbl_posto on tbl_posto.posto = tbl_hd_chamado_extra.posto
                inner join tbl_produto on tbl_produto.produto = tbl_hd_chamado_extra.produto
                WHERE tbl_hd_chamado_extra.os is null and tbl_hd_chamado_extra.abre_os is true
                AND cpf = '$cpf_consumidor'
                AND tbl_hd_chamado_extra.posto = $posto
                AND tbl_hd_chamado.fabrica = $login_fabrica";
        $res = pg_query($con, $sql);
        if(pg_num_rows($res)>0){
            $descricao  = pg_fetch_result($res, 0, 'descricao');
            $referencia = pg_fetch_result($res, 0, 'referencia');
            $posto_nome = pg_fetch_result($res, 0, 'nome');
            $hd_chamado = pg_fetch_result($res, 0, 'hd_chamado');

            $dados = array("resposta" => "sim", "hd_chamado" => "$hd_chamado", "produto" => "$referencia - $descricao", "posto" => "$posto_nome");
            echo json_encode($dados);
        }
    }
    exit;
}

if (isset($_POST["verificaDeslocamentoProdutoPreOs"])) {
	$hd_chamado = $_POST['hd_chamado'];

	if(!empty($hd_chamado)){

		$sql = "SELECT tbl_linha.deslocamento
			FROM tbl_hd_chamado_extra
			JOIN tbl_produto USING(produto)
			JOIN tbl_linha USING(linha)
			WHERE tbl_hd_chamado_extra.hd_chamado = {$hd_chamado}";
		$res = pg_query($con,$sql);

		if(pg_num_rows($res)>0){
			$deslocamento  = pg_fetch_result($res, 0, 'deslocamento');

			$dados = array("resposta" => "sim", "deslocamento" => "$deslocamento");
			echo json_encode($dados);
		}
	}

	exit;
}

if (isset($_POST["dataCompraZeroHora"])) {

    $dataInformada = $_POST["data"];

    list($df, $mf, $yf) = explode("/", $dataInformada);
    $data = "$yf-$mf-$df";

    $data_atual = date('Y-m-d');
    //comparação de data
    $data1 = new DateTime("$data");
    // segunda data
    $data2 = new DateTime("$data_atual");

    $diferenca = $data1->diff($data2);

    $dia = $diferenca->days;

    echo $dia;
    exit;
}

if ($_POST["ajax_busca_mascaras_produto"]) {

    $produto = $_POST["produto"];
    $fabrica    = $_POST["fabrica"];
    $data = [];

    $sql = "SELECT mascara FROM tbl_produto_valida_serie WHERE fabrica = {$fabrica} AND produto = {$produto}";
    $res = pg_query($con,$sql);
    $data = pg_fetch_all($res);
   
    echo json_encode($data);
    exit;
}

function busca_comunicados_produto($produto) {
    global $con, $login_fabrica;

	$cond_familia = '';

	$sql = "SELECT familia FROM tbl_produto WHERE produto = $produto";
	$qry = pg_query($con, $sql);

	if (pg_num_rows($qry) > 0) {
		$familia = pg_fetch_result($qry, 0, 'familia');
		$cond_familia = ' OR tbl_comunicado.familia = ' . $familia;
	}

    $sql = "
        SELECT
            tbl_comunicado.comunicado,
            tbl_comunicado.descricao,
            tbl_comunicado.extensao,
            TO_CHAR(tbl_comunicado.data, 'DD/MM/YYYY HH24:MI') AS data_comunicado,
            tbl_comunicado.data,
            tbl_comunicado.tipo
        FROM tbl_comunicado
        WHERE tbl_comunicado.fabrica = {$login_fabrica}
        AND tbl_comunicado.obrigatorio_os_produto IS TRUE
        AND tbl_comunicado.ativo IS TRUE
        AND (tbl_comunicado.produto = {$produto} $cond_familia)
        UNION
        SELECT
            tbl_comunicado.comunicado,
            tbl_comunicado.descricao,
            tbl_comunicado.extensao,
            TO_CHAR(tbl_comunicado.data, 'DD/MM/YYYY HH24:MI') AS data_comunicado,
            tbl_comunicado.data,
            tbl_comunicado.tipo
        FROM tbl_comunicado
        INNER JOIN tbl_comunicado_produto ON tbl_comunicado_produto.comunicado = tbl_comunicado.comunicado
        INNER JOIN tbl_produto ON tbl_produto.produto = tbl_comunicado_produto.produto AND tbl_produto.fabrica_i = {$login_fabrica}
        WHERE tbl_comunicado.fabrica = {$login_fabrica}
        AND tbl_comunicado.obrigatorio_os_produto IS TRUE
        AND tbl_comunicado.ativo IS TRUE
        AND tbl_produto.produto = {$produto}
        ORDER BY data DESC
    ";
    $res = pg_query($con, $sql);

    return pg_fetch_all($res);
}

function busca_comunicado_anexo($comunicado, $extensao, $tipo) {
    global $login_fabrica;

    if (empty($extensao)) {
        return null;
    }

    $s3 = new anexaS3('ve', (int) $login_fabrica);
    $s3->set_tipo_anexoS3($tipo);

    $dir  = ($areaAdmin) ? "../comunicados/" : "comunicados/";

    $s3cp = $s3->temAnexos($comunicado);
    $link = ($s3->temAnexo) ? $s3->url : "{$dir}{$comunicado}.{$extensao}";

    if (!$s3->temAnexo && !is_file($link)) {
        $link = null;
    }

    return $link;
}

if ($_GET["ajax_busca_comunicados"]) {
    try {

        $produto = $_GET["produto"];

        if (empty($produto)) {
            throw new Exception(traduz("erro.ao.buscar.comunicados.produto.nao.informado"));
        }

        $res = busca_comunicados_produto($produto);

        if (empty($res)) {
            exit(json_encode(array("nao_encontrado" => true)));
        }

        $comunicados = array();

        foreach ($res as $comunicado) {
            $link = busca_comunicado_anexo($comunicado["comunicado"], $comunicado["extensao"], $comunicado["tipo"]);

            $comunicados[] = array(
                "id"       => $comunicado["comunicado"],
                "titulo"   => utf8_encode($comunicado["descricao"]),
                "extensao" => $comunicado["extensao"],
                "data"     => $comunicado["data_comunicado"],
                "tipo"     => utf8_encode($comunicado["tipo"]),
                "link"     => utf8_encode($link)
            );
        }

        exit(json_encode(array("comunicados" => $comunicados)));
    } catch(Exception $e) {
        exit(json_encode(array("erro" => utf8_encode($e->getMessage()))));
    }
}

if ($_POST["ajax_pecas"]) {
    $pecas = $_POST["pecas"];

    $pecasArray = array();

    foreach ($pecas as $key => $peca_id) {
        if (!in_array($peca_id, array_keys($pecasArray))) {
            $sql = "SELECT descricao || ' - ' || referencia AS peca FROM tbl_peca WHERE fabrica = {$login_fabrica} AND peca = {$peca_id}";
            $res = pg_query($con, $sql);

            if (pg_num_rows($res) > 0) {
                $pecasArray[$peca_id] = utf8_encode(pg_fetch_result($res, 0, "peca"));
            }
        }
    }

    exit(json_encode(array("pecas" => $pecasArray)));
}

/**
 * Ajax que retorna se existe subproduto para o produto
 */
if (isset($_GET["ajax_verifica_subproduto"])) {
    $produto_id = $_GET["produto_id"];

    if (!empty($produto_id)) {
        include "os_cadastro_unico/fabricas/os.php";

        if (verifica_subproduto($produto_id) == true) {
            echo "true";
        } else {
            echo "false";
        }
    }
    exit;
}

    
/**
* Ajax que retorna todos os dados do Posto
**/
if (isset($_POST['ajax_posto'])) {

    $posto = $_POST['ajax_posto'];

    $sql = "SELECT
            tbl_posto.nome,
            tbl_posto.cnpj,
            tbl_posto_fabrica.contato_cep,
            tbl_posto_fabrica.contato_estado,
            UPPER(fn_retira_especiais(tbl_posto_fabrica.contato_cidade)) AS contato_cidade,
            tbl_posto_fabrica.contato_bairro,
            tbl_posto_fabrica.contato_endereco,
            tbl_posto_fabrica.contato_numero,
            tbl_posto_fabrica.contato_complemento,
            tbl_posto_fabrica.contato_fone_comercial,
            tbl_posto_fabrica.contato_email
        FROM tbl_posto
        JOIN tbl_posto_fabrica ON tbl_posto_fabrica.posto = tbl_posto.posto AND tbl_posto_fabrica.fabrica = {$login_fabrica}
        WHERE tbl_posto_fabrica.posto = {$posto}
    ";
    $res = pg_query($con, $sql);

    $dados = "";

    $dados .= pg_fetch_result($res, 0, 'nome')."|";
    $dados .= pg_fetch_result($res, 0, 'cnpj')."|";
    $dados .= pg_fetch_result($res, 0, 'contato_cep')."|";
    $dados .= pg_fetch_result($res, 0, 'contato_estado')."|";
    $dados .= pg_fetch_result($res, 0, 'contato_cidade')."|";
    $dados .= pg_fetch_result($res, 0, 'contato_bairro')."|";
    $dados .= pg_fetch_result($res, 0, 'contato_endereco')."|";
    $dados .= pg_fetch_result($res, 0, 'contato_numero')."|";
    $dados .= pg_fetch_result($res, 0, 'contato_complemento')."|";
    $dados .= pg_fetch_result($res, 0, 'contato_fone_comercial')."|";
    $dados .= pg_fetch_result($res, 0, 'contato_email');

    echo $dados;

    exit;

}

if (isset($_POST['ajax_busca_tipo_posto'])) {

    $posto = $_POST['posto'];


    $sql = "SELECT tbl_tipo_posto.descricao
                 FROM tbl_posto_fabrica
           INNER JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto
                WHERE tbl_posto_fabrica.fabrica = {$login_fabrica}
                  AND tbl_tipo_posto.descricao = 'Autorizada MODELO'
                  AND tbl_posto_fabrica.posto = {$posto}";
    $res = pg_query($con, $sql);

    if (pg_num_rows($res) > 0) {
        $retorno = true;
    } else {
        $retorno = false;
    }

    exit($retorno);

}

if(isset($_POST['verifica_reincidencia'])){

    $produto        = $_POST['produto'];
    $referencia     = $_POST['referencia'];
    $serie          = $_POST['serie'];
    $posto          = $_POST['posto'];
    $nota_fiscal    = $_POST['nota_fiscal'];
    $cnpj_revenda   = $_POST['cnpj_revenda'];

        $select = "SELECT tbl_os.os
                FROM tbl_os
                INNER JOIN tbl_os_produto ON tbl_os_produto.os = tbl_os.os
                WHERE tbl_os.fabrica = {$login_fabrica}
                AND tbl_os.data_abertura > (CURRENT_DATE - INTERVAL '90 days')
                AND tbl_os.excluida IS NOT TRUE
                AND tbl_os.posto = $posto
                AND tbl_os.nota_fiscal = '$nota_fiscal'
                AND tbl_os.revenda_cnpj = '$cnpj_revenda'
                AND tbl_os_produto.produto = $produto
                AND tbl_os_produto.serie = '$serie'
                AND tbl_os.finalizada IS NULL
                ORDER BY tbl_os.data_abertura DESC
                LIMIT 1";
        $resSelect = pg_query($con, $select);
        //echo pg_num_rows($resSelect);
        //echo pg_last_error();
        if(pg_num_rows($resSelect)>0){
            $os_reincidente = pg_fetch_result($resSelect, 0, 'os');
            echo traduz("atencao.para.esse.produto.ja.existe.a.os") ." " . $os_reincidente . " " . traduz("em.aberto");
        }else{
            echo "ok";
        }
    exit;
}


/**
 * Ajax que retornar se o número de série possui no Banco de Dados
 */
if (isset($_POST['ajax_serie'])) {

    $produto    = $_POST['produto'];
    $referencia = $_POST['referencia'];
    $serie      = $_POST['serie'];

    if(empty($produto)){

        $sql = "SELECT produto FROM tbl_produto WHERE referencia = '{$referencia}' AND fabrica_i = {$login_fabrica}";
        $res = pg_query($con,$sql);

        if(pg_num_rows($res) > 0){
            $produto = pg_fetch_result($res, 0, 'produto');
        }else{
            $msg = traduz("produto.nao.encontrado");
        }

    }

    if(!empty($produto)){

        $sql = "SELECT serie
                FROM tbl_numero_serie
                WHERE fabrica = {$login_fabrica}
                AND produto = {$produto}
                AND serie = '{$serie}'";
        $res = pg_query($con,$sql);

        if(pg_num_rows($res) > 0){
            $msg = "ok";
        }else{
            $msg = traduz("numero.de.serie.invalido");
        }

    }

    echo $msg; exit;

}

/**
 * Ajax que retornar se o número de série possui no Banco de Dados
 */
if (isset($_POST['ajax_serie_mascara'])) {

    $produto    = $_POST['produto'];
    $serie      = str_replace("-", "", $_POST['serie']);

    if (!empty($produto)) {
        $versao = serie_produto_versao($produto, $serie);

        if (!is_null($versao)) {
            $msg["success"] = true;

            if (isset($usa_versao_produto)) {
                $msg["versao"] = $versao;
            }
        } else {
            $msg["error"] = utf8_encode(traduz("numero.de.serie.invalido")) ;
        }
    } else {
        $msg["error"] = utf8_encode(traduz("produto.nao.informado"));
    }

    echo json_encode($msg); exit;
}

/**
 * Ajax que retornar se o número de série possui no Banco de Dados
 */
if (isset($_POST['ajax_posto_revenda'])) {

    $posto = $_POST['posto'];

    if(!empty($posto)){

        $sql = "SELECT tbl_tipo_posto.tipo_posto ,
                UPPER(fn_retira_especiais(tbl_tipo_posto.descricao)) AS descricao
            FROM tbl_posto_fabrica
            INNER JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto AND tbl_tipo_posto.fabrica = {$login_fabrica}
            WHERE tbl_posto_fabrica.fabrica = {$login_fabrica}
            AND tbl_tipo_posto.tipo_revenda IS TRUE
            AND tbl_posto_fabrica.posto = {$posto}";
        $res = pg_query($con,$sql);

        if(pg_num_rows($res) > 0){
            echo 'true';
        }else{
            echo 'false';
        }

    }
    exit;
}

/**
 * Dados do Posto Revenda
 */
if (isset($_POST['ajax_posto_revenda_rheem'])) {

    $posto = $_POST['posto'];

    if(!empty($posto)){
        $sql = "SELECT tbl_posto.cnpj ,
                tbl_posto_fabrica.codigo_posto as nome,
                tbl_posto_fabrica.contato_cep as cep,
                tbl_posto_fabrica.contato_cidade as cidade,
                tbl_posto_fabrica.contato_complemento as complemento,
                tbl_posto_fabrica.contato_bairro as bairro,
                tbl_posto_fabrica.contato_endereco as endereco,
                tbl_posto_fabrica.contato_numero as numero,
                tbl_posto.fone
                  FROM tbl_posto_fabrica
            INNER JOIN tbl_posto ON tbl_posto.posto = tbl_posto_fabrica.posto AND tbl_posto_fabrica.fabrica = {$login_fabrica}
            INNER JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto AND tbl_tipo_posto.fabrica = {$login_fabrica}
             WHERE tbl_posto_fabrica.fabrica = {$login_fabrica}
               AND tbl_tipo_posto.tipo_revenda IS TRUE
               AND tbl_posto_fabrica.posto = {$posto}";
        $res = pg_query($con,$sql);

        if(pg_num_rows($res) > 0){
            $retorno = array(
                "posto_revenda" => true,
                "cnpj"          => pg_fetch_result($res,0,"cnpj"),
                "nome"          => pg_fetch_result($res,0,"nome"),
                "cep"           => pg_fetch_result($res,0,"cep"),
                "cidade"        => pg_fetch_result($res,0,"cidade"),
                "complemento"   => pg_fetch_result($res,0,"complemento"),
                "bairro"        => pg_fetch_result($res,0,"bairro"),
                "endereco"      => pg_fetch_result($res,0,"endereco"),
                "numero"        => pg_fetch_result($res,0,"numero"),
                "fone"          => pg_fetch_result($res,0,"fone")
            );
        }else{
            $retorno = array("posto_revenda" => false);
        }
    }
    exit(json_encode($retorno));
}

if ($_POST["ajax_peca_defeitos"] == true && !empty($_POST["peca_id"])) {

    $peca = strtoupper($_POST["peca_id"]);
    $defeitos_selecionados = $_POST['defeitos_selecionados'];

    if (!in_array($login_fabrica, array(157,169,170))) {
        $sql = "SELECT familia_peca FROM tbl_peca_familia WHERE fabrica = {$login_fabrica} AND peca = {$peca} ";
        $res = pg_query($con, $sql);

        if(pg_num_rows($res) == 1){
            $familia_peca = pg_fetch_result($res, 0,"familia_peca");
        }else{
            $retorno = array("error" => utf8_encode(traduz("familia.nao.encontrada.para.a.peca") . " : {$peca}"));
        }

        if (strlen($familia_peca) > 0) {
            if (strlen($peca) > 0) {
                $sql = "
                    SELECT
                        tbl_peca_defeito.defeito,
                        tbl_defeito.descricao AS defeito_descricao
                    FROM tbl_peca_defeito
                    JOIN tbl_familia_peca ON tbl_familia_peca.familia_peca = tbl_peca_defeito.familia_peca AND tbl_familia_peca.fabrica = {$login_fabrica} AND tbl_familia_peca.ativo IS TRUE
                    JOIN tbl_defeito ON tbl_defeito.defeito = tbl_peca_defeito.defeito AND tbl_defeito.fabrica = {$login_fabrica}
                    WHERE tbl_peca_defeito.familia_peca = {$familia_peca}
                    ORDER BY tbl_familia_peca.descricao, tbl_peca_defeito.defeito;
                ";
                $res = pg_query($con, $sql);

                if (pg_num_rows($res) > 0) {
                    $array_defeitos = array();

                    while ($result = pg_fetch_object($res)) {
                        $array_defeitos[$result->defeito] = utf8_encode($result->defeito_descricao);
                    }

                    $retorno = array($array_defeitos);
                } else {
                    $sql = "SELECT referencia FROM tbl_peca WHERE peca = $peca ";
                    $res = pg_query($con,$sql);
                    $referencia = pg_fetch_result($res, 0,"referencia");
                    $retorno = array("error" => utf8_encode(traduz("nenhum.defeito.foi.encontrado.para.a.peca") . " : {$referencia}"));
                }
            } else {
                   $retorno = array("error" => utf8_encode(traduz("peca.nao.informada")));
            }
        } else {
            $retorno = array("error" => utf8_encode(traduz("familia.da.peca.nao.encontrada")));
        }
    } else if (in_array($login_fabrica, [157])) {

        $sql = "
            SELECT
                tbl_peca_defeito.defeito,
                tbl_defeito.descricao AS defeito_descricao
            FROM tbl_peca_defeito
            JOIN tbl_defeito ON tbl_defeito.defeito = tbl_peca_defeito.defeito AND tbl_defeito.fabrica = {$login_fabrica}
            WHERE tbl_peca_defeito.peca = {$peca}
            AND tbl_peca_defeito.ativo IS TRUE
            ORDER BY tbl_peca_defeito.defeito;
        ";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0) {
            $array_defeitos = array();

            while ($result = pg_fetch_object($res)) {
                $array_defeitos[$result->defeito] = utf8_encode($result->defeito_descricao);
            }

            $retorno = array($array_defeitos);
        } else {
           $sql = "SELECT referencia FROM tbl_peca WHERE peca = $peca ";
            $res = pg_query($con,$sql);
            $referencia = pg_fetch_result($res, 0,"referencia");
            $retorno = array("error" => utf8_encode(traduz("nenhum.defeito.foi.encontrado.para.a.peca") . " : {$referencia}"));
        }

    } else {
        $sql = "SELECT referencia FROM tbl_peca WHERE peca = $peca ";
        $res = pg_query($con,$sql);
        $referencia = pg_fetch_result($res, 0, referencia);

        if (strlen($defeitos_selecionados) == 0) {
            $retorno = array("error" => utf8_encode(traduz("defeitos.nao.selecionados.para.buscar.defeitos.da.peca") . ": {$referencia}"));
        } else {
            $sql = "
                SELECT
                    tbl_defeito.defeito,
                    tbl_defeito.codigo_defeito,
                    tbl_defeito.descricao AS defeito_descricao
                FROM tbl_diagnostico
                JOIN tbl_defeito ON tbl_defeito.defeito = tbl_diagnostico.defeito AND tbl_defeito.fabrica = {$login_fabrica}
                WHERE tbl_diagnostico.fabrica = {$login_fabrica}
                AND tbl_diagnostico.defeito_constatado IN ({$defeitos_selecionados})
                ORDER BY tbl_defeito.descricao;
            ";

            $res = pg_query($con, $sql);

            if (pg_num_rows($res) > 0) {
                $array_defeitos = array();
                while ($result = pg_fetch_object($res)) {
                    $array_defeitos[$result->defeito] = utf8_encode($result->codigo_defeito.' - '.$result->defeito_descricao);
                }
                $retorno = array($array_defeitos);
            } else {
                $retorno = array("error" => utf8_encode(traduz("nenhum.defeito.foi.encontrado.para.a.peca") . " : {$referencia}"));
            }
        }
    }

    exit(json_encode($retorno));
}

if (isset($_REQUEST["ajax_produto_peca_defeito"])) {

    $defeitos_selecionados = $_REQUEST['defeitos_selecionados'];
    $CondicaoSemDefeito = "AND tbl_defeito_constatado.lista_garantia = 'sem_defeito'";

    if (in_array($login_fabrica, array(169, 170))) {
        
        $tipoAtendimento = $_REQUEST['tipo_atendimento'];

        if ($tipoAtendimento == "Triagem" || $tipoAtendimento == "RMA") {
            
            $CondicaoSemDefeito = "";   
        }
    }

    $sql = "
        SELECT
            tbl_defeito.defeito,
            tbl_defeito.codigo_defeito,
            tbl_defeito.descricao AS defeito_descricao
        FROM tbl_diagnostico
        JOIN tbl_defeito ON tbl_defeito.defeito = tbl_diagnostico.defeito AND tbl_defeito.fabrica = {$login_fabrica}
        JOIN tbl_defeito_constatado ON tbl_defeito_constatado.defeito_constatado = tbl_diagnostico.defeito_constatado AND tbl_defeito_constatado.fabrica = {$login_fabrica}
        WHERE tbl_diagnostico.fabrica = {$login_fabrica}
        AND tbl_diagnostico.defeito_constatado IN ({$defeitos_selecionados})
        {$CondicaoSemDefeito}
        ORDER BY tbl_defeito.descricao;
    ";
    $res = pg_query($con, $sql);

    if (pg_num_rows($res) > 0) {
        $array_defeitos = array();
        while ($result = pg_fetch_object($res)) {
            $array_defeitos[$result->defeito] = utf8_encode($result->codigo_defeito.' - '.$result->defeito_descricao);
        }
        $retorno = array($array_defeitos);
    } else {
        $retorno = array("error" => utf8_encode(traduz("nenhum.defeito.foi.encontrado.para.os.defeitos.constatados.selecionados")));
    }

    exit(json_encode($retorno));
}

if (isset($_POST['ajax_busca_cep']) && !empty($_POST['cep'])) {
    require_once __DIR__.'/classes/cep.php';

    $cep = $_POST['cep'];

    try {
        $retorno = CEP::consulta($cep);
        $retorno = array_map('utf8_encode', $retorno);
    } catch(Exception $e) {
        $retorno = array("error" => utf8_encode($e->getMessage()));
    }

    exit(json_encode($retorno));
}

if (isset($_POST["ajax_busca_defeito_constatado"]) && !empty($_POST["produto"])) {

    if($login_fabrica == 164) {
        global $con;

        $sql = "SELECT tbl_tipo_posto.posto_interno
                FROM tbl_posto_fabrica
                INNER JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto AND tbl_tipo_posto.fabrica = {$login_fabrica}
                WHERE tbl_posto_fabrica.fabrica = {$login_fabrica}
                AND tbl_posto_fabrica.posto = {$login_posto}";
        $res = pg_query($con, $sql);

        $postoInterno = pg_fetch_result($res, 0,"posto_interno");        

        if($postoInterno != 't' && $login_posto != 113070){                  
            $whereTipoAtendimento = " AND tbl_defeito_constatado.descricao NOT IN ('SEM DEFEITO')";
        }
    }
    $produto = $_POST["produto"];
    $fora_garantia = $_POST["fora_garantia"];
    $grupo_atendimento = $_POST["grupo_atendimento"];
    $tipo_atendimento_descricao = $_POST["tipo_atendimento_descricao"];
    $defeitos_constatados_selecionados = $_POST['defeitos_selecionados'];
    $tipo_atendimento = $_POST['tipo_atendimento'];
    $grupo = $_POST['grupo'];

    if ($login_fabrica == 158) {
        if (!empty($fora_garantia)) {
        $whereTipoAtendimento = "AND tbl_diagnostico.garantia ".(($fora_garantia == 't') ? 'IS NOT TRUE' : 'IS TRUE');
        }
        $whereTipoAtendimento .= ($tipo_atendimento == 272)
            ? " AND tbl_diagnostico.tipo_atendimento = 272"
            : " AND COALESCE(tbl_diagnostico.tipo_atendimento, -1) <> 272";

    } else if (in_array($login_fabrica, array(169,170))) {
        if ($grupo_atendimento == 'R' && in_array($tipo_atendimento_descricao, array('RMA','Triagem'))) {
           # $whereTipoAtendimento = "AND tbl_defeito_constatado.descricao = '{$tipo_atendimento_descricao}'";
        } else {
            $whereTipoAtendimento = "AND tbl_defeito_constatado.descricao NOT IN ('Triagem', 'RMA')";
        }
    }

    if (!empty($defeitos_constatados_selecionados)) {
        $whereSelecionados = "AND tbl_defeito_constatado.defeito_constatado NOT IN ($defeitos_constatados_selecionados)";
    }

    if (!in_array($login_fabrica, array(157))) {

        if ($usa_linha_defeito_constatado == 't'){
            $join_linha_familia_produto = " JOIN tbl_linha ON tbl_linha.linha = tbl_diagnostico.linha AND tbl_linha.fabrica = {$login_fabrica}
                       JOIN tbl_produto ON tbl_produto.linha = tbl_linha.linha AND tbl_produto.fabrica_i = {$login_fabrica} ";
        }else{
            $join_linha_familia_produto = " JOIN tbl_familia ON tbl_familia.familia = tbl_diagnostico.familia AND tbl_familia.fabrica = {$login_fabrica}
                       JOIN tbl_produto ON tbl_produto.familia = tbl_familia.familia AND tbl_produto.fabrica_i = {$login_fabrica} ";
        }
    }

    $join_diagnostico_produto = "";

    if (in_array($login_fabrica, array(157))) {
        $join_diagnostico_produto = "JOIN tbl_diagnostico_produto ON tbl_diagnostico_produto.diagnostico = tbl_diagnostico.diagnostico AND tbl_diagnostico_produto.fabrica = {$login_fabrica} 
        JOIN tbl_produto ON tbl_produto.produto = tbl_diagnostico_produto.produto AND tbl_produto.fabrica_i = {$login_fabrica} ";

    }
    $join_defeito_grupo   = "";
    $where_defeito_grupo  = "";
    if (strlen($grupo) > 0){
        $join_defeito_grupo   = " JOIN tbl_defeito_constatado_grupo ON tbl_defeito_constatado_grupo.defeito_constatado_grupo = tbl_defeito_constatado.defeito_constatado_grupo AND tbl_defeito_constatado_grupo.fabrica = {$login_fabrica}";
        $where_defeito_grupo  = " AND tbl_defeito_constatado_grupo.defeito_constatado_grupo = {$grupo}";
    }
    $sql = "
        SELECT DISTINCT
            tbl_defeito_constatado.defeito_constatado,
            tbl_defeito_constatado.codigo,
            tbl_defeito_constatado.descricao,
            tbl_defeito_constatado.lancar_peca,
            tbl_defeito_constatado.lista_garantia,
        tbl_defeito_constatado.defeito_constatado_grupo
        FROM tbl_diagnostico
        JOIN tbl_defeito_constatado ON tbl_defeito_constatado.defeito_constatado = tbl_diagnostico.defeito_constatado AND tbl_defeito_constatado.fabrica = {$login_fabrica}
        {$join_linha_familia_produto}
        {$join_diagnostico_produto}
        {$join_defeito_grupo}
        WHERE tbl_diagnostico.fabrica = {$login_fabrica}
        AND tbl_produto.produto = {$produto}
        AND tbl_diagnostico.ativo IS TRUE
        {$whereTipoAtendimento}
        {$whereSelecionados}
         {$where_defeito_grupo}
  ORDER BY      tbl_defeito_constatado.descricao ASC;
    ";

    $res = pg_query($con, $sql);
    if (pg_num_rows($res) > 0) {
        $defeito_constatado_array = array();

		while ($result = pg_fetch_object($res)) {

			if($cook_idioma <> 'pt-br') {
				$sqlIdiomaConstatado = "SELECT descricao 
										 FROM tbl_defeito_constatado_idioma 
										 WHERE defeito_constatado = {$result->defeito_constatado}
										 AND LOWER(idioma) = LOWER('$cook_idioma')";
				$resIdiomaConstatado = pg_query($con, $sqlIdiomaConstatado);

				if (pg_num_rows($resIdiomaConstatado) > 0) {
					$result->descricao = (pg_fetch_result($resIdiomaConstatado, 0, 'descricao'));
				}
			}
			$result->descricao = (mb_detect_encoding($result->descricao, 'UTF-8', true)) ? $result->descricao : utf8_encode($result->descricao);

            $defeito_constatado_array[] = array(
                "descricao" => ((in_array($login_fabrica, array(158,169,170))) ? $result->codigo." - " : "").trim($result->descricao),
                "lancar_pecas" => $result->lancar_peca,
                "defeito_constatado" => $result->defeito_constatado,
                "lista_garantia" => $result->lista_garantia,
                "defeito_constatado_grupo" => $result->defeito_constatado_grupo
            );
        }

        if (isset($fabrica_usa_subproduto)) {
            $sql = "SELECT CASE WHEN produto_pai = {$produto} THEN produto_filho ELSE produto_pai END AS subproduto FROM tbl_subproduto WHERE produto_pai = {$produto} OR produto_filho = {$produto}";
            $res = pg_query($con, $sql);

            if (pg_num_rows($res) > 0) {
                $subproduto = pg_fetch_result($res, 0, "subproduto");

                $sql = "SELECT distinct tbl_defeito_constatado.defeito_constatado, tbl_defeito_constatado.descricao
                        FROM tbl_diagnostico
                        INNER JOIN tbl_defeito_constatado ON tbl_defeito_constatado.defeito_constatado = tbl_diagnostico.defeito_constatado AND tbl_defeito_constatado.fabrica = {$login_fabrica}
                        INNER JOIN tbl_familia ON tbl_familia.familia = tbl_diagnostico.familia AND tbl_familia.fabrica = {$login_fabrica}
                        INNER JOIN tbl_produto ON tbl_produto.familia = tbl_familia.familia AND tbl_produto.fabrica_i = {$login_fabrica}
                        WHERE tbl_diagnostico.fabrica = {$login_fabrica}
                        AND tbl_produto.produto = {$subproduto}
                        AND tbl_diagnostico.ativo IS TRUE
                        ORDER BY tbl_defeito_constatado.descricao ASC";
                $res = pg_query($con, $sql);

                if (pg_num_rows($res) > 0) {
                    $subproduto_defeito_constatado_array = array();

		    while ($result = pg_fetch_object($res)) {
			    $result->descricao = (mb_detect_encoding($result->descricao, 'UTF-8', true)) ? $result->descricao : utf8_encode($result->descricao);
                        $subproduto_defeito_constatado_array[$result->defeito_constatado] = trim($result->descricao);
                    }
                }
            }
        }

        $retorno = array("defeitos_constatados" => $defeito_constatado_array);

        if (isset($subproduto_defeito_constatado_array)) {
            $retorno["subproduto_defeitos_constatados"] = $subproduto_defeito_constatado_array;
        }
    } else {
        $retorno = array("error" => utf8_encode(traduz("nenhum.defeito.constatado.encontrado.para.a.familia.do.produto")));
    }
    
    exit(json_encode($retorno));
}

if (isset($_POST['ajax_busca_solucao']) && !empty($_POST['produto'])) {
    $produto         = $_POST['produto'];
    $tipo_produto    = strtolower($_POST['tipo_produto']);
    $subconjunto     = strtolower($_POST['subconjunto']);
    $subproduto      = strtolower($_POST['subproduto']);
    $tipo_subproduto = strtolower($_POST['tipo_subproduto']);

    $tipo_produto    = ($tipo_produto == 'cond')    ? 'condicionador' : $tipo_produto;
    $tipo_subproduto = ($tipo_subproduto == 'cond') ? 'condicionador' : $tipo_subproduto;

    if(empty($tipo_produto) && !isset($usaSolucaoLinha) && !isset($usaSolucaoFamilia)){

        $sql = "SELECT tbl_solucao.solucao, tbl_solucao.descricao
                FROM tbl_diagnostico
                INNER JOIN tbl_solucao ON tbl_solucao.solucao = tbl_diagnostico.solucao AND tbl_solucao.fabrica = {$login_fabrica}
                INNER JOIN tbl_familia ON tbl_familia.familia = tbl_diagnostico.familia AND tbl_familia.fabrica = {$login_fabrica}
                INNER JOIN tbl_produto ON tbl_produto.familia = tbl_familia.familia AND tbl_produto.fabrica_i = {$login_fabrica}
                WHERE tbl_diagnostico.fabrica = {$login_fabrica}
                AND tbl_produto.produto = {$produto}
                AND tbl_diagnostico.ativo IS TRUE
                AND tbl_diagnostico.diagnostico NOT IN(SELECT diagnostico FROM tbl_diagnostico_produto)
                UNION
                SELECT tbl_solucao.solucao, tbl_solucao.descricao
                FROM tbl_diagnostico
                INNER JOIN tbl_solucao ON tbl_solucao.solucao = tbl_diagnostico.solucao AND tbl_solucao.fabrica = {$login_fabrica}
                INNER JOIN tbl_familia ON tbl_familia.familia = tbl_diagnostico.familia AND tbl_familia.fabrica = {$login_fabrica}
                INNER JOIN tbl_produto ON tbl_produto.familia = tbl_familia.familia AND tbl_produto.fabrica_i = {$login_fabrica} AND tbl_produto.familia = tbl_diagnostico.familia
                INNER JOIN tbl_diagnostico_produto ON tbl_diagnostico.diagnostico = tbl_diagnostico_produto.diagnostico AND tbl_diagnostico_produto.produto = tbl_produto.produto
                WHERE tbl_diagnostico.fabrica = {$login_fabrica}
                AND tbl_produto.produto = {$produto}
                AND tbl_diagnostico.ativo IS TRUE";
    }else{
        if($subconjunto == "true" && !isset($usaSolucaoLinha) && !isset($usaSolucaoFamilia)){
            $sql = "SELECT DISTINCT tbl_solucao.solucao, tbl_solucao.descricao
                FROM tbl_diagnostico
                INNER JOIN tbl_solucao ON tbl_solucao.solucao = tbl_diagnostico.solucao AND tbl_solucao.fabrica = {$login_fabrica}
                INNER JOIN tbl_familia ON tbl_familia.familia = tbl_diagnostico.familia AND tbl_familia.fabrica = {$login_fabrica}
                INNER JOIN tbl_produto ON tbl_produto.familia = tbl_familia.familia AND tbl_produto.fabrica_i = {$login_fabrica}
                WHERE tbl_diagnostico.fabrica = {$login_fabrica}
                AND tbl_produto.produto in($produto,$subproduto)
                AND tbl_diagnostico.ativo IS TRUE
                AND (
                    lower(tbl_solucao.descricao) like '%compressor%' OR
                    lower(tbl_solucao.descricao) like '%serpentina%' OR
                    lower(tbl_solucao.descricao) like '%$tipo_produto%' OR
                    lower(tbl_solucao.descricao) like '%$tipo_subproduto%'
                    )
                ORDER BY tbl_solucao.descricao ASC";
        }else{
            if (isset($usaSolucaoLinha)) {
                $joinSolucao = "
                    INNER JOIN tbl_linha ON tbl_linha.linha = tbl_diagnostico.linha AND tbl_linha.fabrica = {$login_fabrica}
                    INNER JOIN tbl_produto ON tbl_produto.linha = tbl_linha.linha AND tbl_produto.fabrica_i = {$login_fabrica}
                ";
            } else if ($usaSolucaoFamilia) {
                $joinSolucao = "
                    INNER JOIN tbl_familia ON tbl_familia.familia = tbl_diagnostico.familia AND tbl_familia.fabrica = {$login_fabrica}
                    INNER JOIN tbl_produto ON tbl_produto.familia = tbl_familia.familia AND tbl_produto.fabrica_i = {$login_fabrica}
                ";
            }

            $sql = "SELECT tbl_solucao.solucao, tbl_solucao.descricao
                FROM tbl_diagnostico
                INNER JOIN tbl_solucao ON tbl_solucao.solucao = tbl_diagnostico.solucao AND tbl_solucao.fabrica = {$login_fabrica}
                {$joinSolucao}
                WHERE tbl_diagnostico.fabrica = {$login_fabrica}
                AND tbl_produto.produto = {$produto}
                AND tbl_diagnostico.ativo IS TRUE
                ORDER BY tbl_solucao.descricao ASC";
        }
    }

    $res = pg_query($con, $sql);
    if (pg_num_rows($res) > 0) {
        $solucoes_array = array();

        while ($result = pg_fetch_object($res)) {
            $solucoes_array[$result->solucao] = utf8_encode($result->descricao);
        }

        $retorno = array("solucoes" => $solucoes_array);
    } else {
        $retorno = array("error" => utf8_encode(traduz("nenhuma.solucao.encontrada.para.o.produto")));
    }

    exit(json_encode($retorno));
}

if (isset($_POST['ajax_busca_solucao_defeito_constatado'])) {
    if (!empty($_POST['defeitos_constatados_selecionados'])) {
        $defeitos_constatados_selecionados = $_POST['defeitos_constatados_selecionados'];
        $defeitos_constatados_selecionados = implode(",", $defeitos_constatados_selecionados);
        $aux_fora_garantia = $_POST['fora_garantia'];
        $aux_garantia = ($aux_fora_garantia == 't') ? "f" : "t";

        $sqlSolucao = "SELECT DISTINCT
                    tbl_diagnostico.solucao,
                    tbl_solucao.descricao as descricao_solucao,
                    tbl_solucao.codigo as codigo_solucao
                FROM tbl_diagnostico
                JOIN tbl_solucao ON tbl_solucao.solucao = tbl_diagnostico.solucao AND tbl_solucao.ativo IS TRUE AND tbl_solucao.fabrica = {$login_fabrica}
                WHERE tbl_diagnostico.defeito_constatado in ({$defeitos_constatados_selecionados})
                AND tbl_diagnostico.ativo IS TRUE
                AND tbl_diagnostico.garantia = '{$aux_garantia}'
                AND tbl_diagnostico.fabrica = {$login_fabrica}
                ORDER BY descricao_solucao;";
        $resSolucao = pg_query($con, $sqlSolucao);

        if (strlen(pg_last_error()) > 0) {
            $retorno = array("erro" => utf8_encode(traduz("ocorreu.um.erro.na.busca.das.solucoes.para.esse.defeito")));
        } else {
            if(pg_num_rows($resSolucao) > 0){
                $solucoes_encontradas = pg_fetch_all($resSolucao);
                foreach ($solucoes_encontradas as $linha_solucao) {
                    $linha_solucao_solucao = $linha_solucao['solucao'];
                    $linha_solucao_descricao = $linha_solucao['descricao_solucao'];
                    $linha_solucao_codigo = $linha_solucao['codigo_solucao'];
                    $solucoes[$linha_solucao_solucao] = utf8_encode($linha_solucao_codigo." - ".$linha_solucao_descricao);
                }
                $retorno = array("solucoes" => $solucoes);
            } else {
                $retorno = array("erro" => utf8_encode(traduz("nenhuma.solucao.foi.encontrada.para.esses.defeitos.constatados")));
            }
        }

        echo json_encode($retorno);
    } else {
        echo json_encode(array("erro" => utf8_encode(traduz("nenhum.defeito.constatado.selecionado"))));
    }
    exit;
}

if (isset($_REQUEST['ajax_tipo_atendimento'])) {

    if (in_array($login_fabrica, array(169,170))) {

        $consumidor_revenda = $_REQUEST['consumidor_revenda'];
        $abre_os_dealer     = $_REQUEST['abre_os_dealer'];

        if ($areaAdmin === false) {
            $sql = "
                SELECT *
                FROM tbl_posto_fabrica
                JOIN tbl_posto_linha USING(posto)
                JOIN tbl_linha USING(linha,fabrica)
                WHERE posto = {$login_posto}
                AND fabrica = {$login_fabrica}
                AND digita_os IS TRUE
                AND deslocamento IS TRUE;
            ";
            $res = pg_query($con,$sql);

            if (pg_num_rows($res) == 0) {
                if ($consumidor_revenda == 'C') {
                    $balcao = "AND fora_garantia IS NOT TRUE AND km_google IS NOT TRUE";
                }
            }
        }

        if ($consumidor_revenda == 'R') {
            $whereGrupoAtendimento = "AND (grupo_atendimento NOT IN ('P','I','G') OR (fora_garantia IS TRUE AND grupo_atendimento IS NULL))";
        } else {
            $whereGrupoAtendimento = "AND ((grupo_atendimento NOT IN ('R','I','G') {$balcao}) OR (fora_garantia IS TRUE AND grupo_atendimento IS NULL))";
        }

        if ($abre_os_dealer == 't' AND $areaAdmin === false){
            $sql_linha = "
                SELECT tbl_linha.deslocamento
                FROM tbl_posto_fabrica
                JOIN tbl_posto_linha ON tbl_posto_linha.posto = tbl_posto_fabrica.posto
                JOIN tbl_linha ON tbl_linha.linha = tbl_posto_linha.linha AND tbl_linha.fabrica = {$login_fabrica}
                WHERE tbl_posto_fabrica.fabrica = {$login_fabrica}
                AND tbl_posto_fabrica.posto = {$login_posto}
                AND tbl_linha.deslocamento IS TRUE";
            $res = pg_query($con, $sql_linha);
            if (pg_num_rows($res) > 0){
                $whereGrupoAtendimento = "AND ((grupo_atendimento = 'P' AND km_google IS NOT TRUE) OR (grupo_atendimento = 'P' AND km_google IS TRUE AND descricao != 'Garantia - Contas Nacionais') OR (fora_garantia IS TRUE AND grupo_atendimento IS NULL))";
            }
        }
        $orderBy = "fora_garantia,";
    }

    $sql = "
        SELECT
            tipo_atendimento,
            descricao,
            fora_garantia,
            km_google,
            grupo_atendimento,
            entrega_tecnica AS visita_tecnica
        FROM tbl_tipo_atendimento
        WHERE fabrica = {$login_fabrica}
        AND ativo IS TRUE
        {$whereGrupoAtendimento}
        ORDER BY {$orderBy}descricao;
    ";
    $res = pg_query($con, $sql);

    $tipos_atendimento = pg_fetch_all($res);

    foreach($tipos_atendimento as $tipo_atendimento) {

        if ($areaAdmin === false AND $abre_os_dealer == 't'){
            if ($tipo_atendimento['km_google'] == 't' AND $tipo_atendimento['fora_garantia'] == 'f' AND $tipo_atendimento['visita_tecnica'] == 'f' AND $tipo_atendimento['grupo_atendimento'] == 'P'){
                $retorno[] = array(
                    "tipo_atendimento" => $tipo_atendimento['tipo_atendimento'],
                    "descricao" => utf8_encode($tipo_atendimento['descricao']),
                    "km_google" => $tipo_atendimento['km_google'],
                    "fora_garantia" => $tipo_atendimento['fora_garantia'],
                    "grupo_atendimento" => $tipo_atendimento['grupo_atendimento'],
                    "visita_tecnica" => $tipo_atendimento['visita_tecnica']
                );
            }else{
                $retorno[] = array(
                    "tipo_atendimento" => $tipo_atendimento['tipo_atendimento'],
                    "descricao" => utf8_encode($tipo_atendimento['descricao']),
                    "km_google" => $tipo_atendimento['km_google'],
                    "fora_garantia" => $tipo_atendimento['fora_garantia'],
                    "grupo_atendimento" => $tipo_atendimento['grupo_atendimento'],
                    "visita_tecnica" => $tipo_atendimento['visita_tecnica'],
                    "disabled" => "disabled"
                );
            }
        }else{
            $retorno[] = array(
                "tipo_atendimento" => $tipo_atendimento['tipo_atendimento'],
                "descricao" => utf8_encode($tipo_atendimento['descricao']),
                "km_google" => $tipo_atendimento['km_google'],
                "fora_garantia" => $tipo_atendimento['fora_garantia'],
                "grupo_atendimento" => $tipo_atendimento['grupo_atendimento'],
                "visita_tecnica" => $tipo_atendimento['visita_tecnica']
            );
        }
    }

    if (count($retorno) == 0) {
        $retorno = array("erro" => traduz("nenhum.tipo.de.atendimento.encontrado"));
    }

    echo json_encode($retorno);
    exit;
}

if (isset($_POST['ajax_busca_tipo_atendimento']) && !empty($_POST['produto'])) {

    $produto = $_POST['produto'];

    $sql_linha = "SELECT nome FROM tbl_produto JOIN tbl_linha USING(linha) WHERE produto = {$produto} AND fabrica_i = $login_fabrica";
    $res_linha = pg_query($con, $sql_linha);

    if(pg_num_rows($res_linha) > 0){
        $nome = pg_fetch_result($res_linha, 0, 'nome');

        echo (strtoupper($nome) == strtoupper("Leve")) ? "sem_km" : "com_km";
    }

    exit;
}

if (isset($_POST['ajax_busca_tipo_atendimento_posto_interno']) && !empty($_POST['posto'])) {
    include "os_cadastro_unico/fabricas/os.php";

    $xposto_id = $_POST['posto'];
    
    if ($login_fabrica == 173) {
        $sql = "
            SELECT tp.tipo_posto 
            FROM tbl_posto_fabrica pf 
            INNER JOIN tbl_tipo_posto tp ON tp.tipo_posto = pf.tipo_posto AND tp.fabrica = {$login_fabrica}
            WHERE pf.fabrica = {$login_fabrica}
            AND pf.posto = {$xposto_id}
            AND tp.posto_interno IS TRUE
        ";
        $res = pg_query($con, $sql);
        
        if (pg_num_rows($res) > 0) {
            $sql = "
                SELECT tipo_atendimento,
                    descricao,
                    fora_garantia,
                    km_google,
                    entrega_tecnica AS visita_tecnica
                FROM tbl_tipo_atendimento
                WHERE fabrica = {$login_fabrica}
                AND ativo IS TRUE
                ORDER BY descricao;
            ";
        } else {
            $sql = "
                SELECT tipo_atendimento,
                    descricao,
                    fora_garantia,
                    km_google,
                    entrega_tecnica AS visita_tecnica
                FROM tbl_tipo_atendimento
                WHERE fabrica = {$login_fabrica}
                AND ativo IS TRUE
                AND fora_garantia IS FALSE
                ORDER BY descricao;
            ";
        }
        
        $res = pg_query($con, $sql);
    } else {
        if (!in_array($login_fabrica, array(158,176,186))) {

            if (verifica_tipo_posto("posto_interno", "TRUE", $xposto_id)) {
                $sql_posto_interno = "AND grupo_atendimento = 'I'";
            } else {
                $sql_posto_interno = "AND grupo_atendimento = 'P'";
            }

            if (strlen($preos) > 0 || strlen($hd_chamado) > 0) {
                $whereKMGoogle = "AND km_google IS TRUE";
            }
            if(in_array($login_fabrica, [167, 203])){
                $sql = "SELECT tbl_tipo_posto.tipo_posto,
                            UPPER(fn_retira_especiais(tbl_tipo_posto.descricao)) AS descricao,
                            tbl_tipo_posto.posto_interno,
                            tbl_tipo_posto.desconto_5estrela
                        FROM tbl_posto_fabrica
                        INNER JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto AND tbl_tipo_posto.fabrica = {$login_fabrica}
                        WHERE tbl_posto_fabrica.fabrica = {$login_fabrica}
                        AND tbl_posto_fabrica.posto = {$xposto_id}";
                $res = pg_query($con, $sql);

                $desconto_5estrela = pg_fetch_result($res,0, desconto_5estrela); //HD-3428328
                $whereKMGoogle = "";
                $sql_posto_interno = "";
                if($desconto_5estrela == 1){
                    $whereForaGarantia = "AND (tbl_tipo_atendimento.fora_garantia IS NOT TRUE OR tbl_tipo_atendimento.km_google IS TRUE) ";
                }else{
                    $whereForaGarantia = "AND tbl_tipo_atendimento.fora_garantia IS NOT TRUE AND tbl_tipo_atendimento.km_google IS FALSE ";

                    if (verifica_tipo_posto("posto_interno", "TRUE", $xposto_id)) {
                        $whereForaGarantia = " AND tbl_tipo_atendimento.km_google IS FALSE ";
                    }
                }
            }
        } else {

            if (!empty($campos['os']['hd_chamado'])) {
                $whereForaGarantia = "AND tbl_tipo_atendimento.fora_garantia IS FALSE";
            }

            if (!empty($xposto_id)) {
                $sqlTpAtendCad = "SELECT tipo_atendimento FROM tbl_posto_tipo_atendimento WHERE posto = {$xposto_id} AND fabrica = {$login_fabrica};";
                $resTpAtendCad = pg_query($con, $sqlTpAtendCad);
                $tpAtendCad = pg_fetch_all($resTpAtendCad);

                $tpAtend = "";

                foreach ($tpAtendCad as $key => $av) {
                    if ($key == 0) {
                        $tpAtend = $av['tipo_atendimento'];
                    } else {
                        $tpAtend .= ",".$av['tipo_atendimento'];
                    }
                }

                if (strlen($tpAtend) > 0) {
                    $whereTpAtendPosto = "AND tbl_tipo_atendimento.tipo_atendimento IN (".$tpAtend.")";
                }
            }

        }
        
        $sql = "SELECT tipo_atendimento,
                descricao,
                fora_garantia,
                km_google,
                entrega_tecnica AS visita_tecnica
            FROM tbl_tipo_atendimento
            WHERE fabrica = {$login_fabrica}
            AND ativo IS TRUE
            {$whereKMGoogle}
            {$sql_posto_interno}
            {$whereForaGarantia}
            {$whereTpAtendPosto}
            ORDER BY descricao;";
        $res = pg_query($con, $sql);
    }
    
    $tipos_atendimento = pg_fetch_all($res);

    foreach($tipos_atendimento as $tipo_atendimento) {
        if ($login_fabrica == 176 && $tipo_atendimento['descricao'] != "Garantia") {
            continue;
        }

        $retorno[] = array(
            "tipo_atendimento" => $tipo_atendimento['tipo_atendimento'],
            "descricao" => utf8_encode($tipo_atendimento['descricao']),
            "km_google" => $tipo_atendimento['km_google'],
            "fora_garantia" => $tipo_atendimento['fora_garantia'],
            "visita_tecnica" => $tipo_atendimento['visita_tecnica'],
        );
    }
    echo json_encode($retorno);
    exit;
}

if (isset($_POST['ajax_busca_valor_adicional'])) {
    $produto = $_POST['produto'];

    if (isset($fabrica_usa_subproduto)) {
        $subproduto = $_POST["subproduto"];
    }

    if (strlen($produto) > 0) {
        $valores_adicionais_array = array();

        if (strlen($subproduto) > 0) {
            $where = "produto IN ({$produto}, {$subproduto})";
        } else {
            $where = "produto = {$produto}";
        }

        $sql_linha = "SELECT valores_adicionais FROM tbl_produto WHERE fabrica_i = $login_fabrica AND {$where}";
       
        $res_linha = pg_query($con, $sql_linha);

        if ($login_fabrica == 183){
            $valores_adicionais_array = array();
            $sql = "SELECT valores_adicionais FROM tbl_fabrica WHERE fabrica = {$login_fabrica} ";
            $resVA = pg_query($con,$sql);
            
            $valores_adicionais = pg_fetch_result($resVA, 0, 'valores_adicionais');
            $valores_adicionais = json_decode($valores_adicionais, true);

            foreach ($valores_adicionais as $key => $value) {
                $valores_adicionais_array[] = array(
                    "descricao" => utf8_encode($key),
                    "valor" => $value["valor"],
                    "editar" => $value["editar"]
                );
            }

            $valores_adicionais_p = pg_fetch_result($res_linha, 0, 'valores_adicionais');
            $valores_adicionais_p = json_decode($valores_adicionais_p, true);
            
            foreach ($valores_adicionais_p as $key_p => $value_p) {
                $valores_adicionais_array[] = array(
                    "descricao" => utf8_encode($key),
                    "valor" => $value_p,
                    "editar" => "f"
                );
            }

            if (count($valores_adicionais_array) > 0) {
                $retorno = array("ok" => true, "valores_adicionais" => $valores_adicionais_array);
            } else {
                $retorno = array("erro" => utf8_encode(traduz("nao.foi.encontrado.valores.adicionais.para.o.produto")));
            }

        }else{
            if(pg_num_rows($res_linha) > 0){
                while ($result = pg_fetch_object($res_linha)) {
                    $valores_adicionais = $result->valores_adicionais;
                    $valores_adicionais = utf8_encode($valores_adicionais);

                    if(strlen($valores_adicionais) > 0){
                        $valores_adicionais = json_decode($valores_adicionais,true);

                        foreach ($valores_adicionais as $descricao => $valor) {
                            $descricao = wordwrap($descricao, 20, "<br/>", true);
                            $valores_adicionais_array[] = array(
                                "descricao" => $descricao,
                                "valor" => $valor
                            );
                        }
                    }
                }

                if (count($valores_adicionais_array) > 0) {
                    $retorno = array("ok" => true, "valores_adicionais" => $valores_adicionais_array);
                } else {
                    $retorno = array("erro" => utf8_encode(traduz("nao.foi.encontrado.valores.adicionais.para.o.produto")));
                }
            } else {
                $retorno = array("erro" => utf8_encode(traduz("produto.nao.encontrado")));
            }
        }
    } else {
        $retorno = array("erro" => utf8_encode(traduz("produto.nao.informado")));
    }
    exit(json_encode($retorno));
}

if (isset($_POST['ajax_deleta_os_item']) && !empty($_POST['os_item'])) {
    $os_item = $_POST['os_item'];

    $sql = "SELECT tbl_os_item.peca, tbl_os_produto.os, tbl_os_produto.os_produto, tbl_posto_fabrica.controla_estoque
            FROM tbl_os_item
            INNER JOIN tbl_os_produto ON tbl_os_produto.os_produto = tbl_os_item.os_produto
            INNER JOIN tbl_os ON tbl_os.os = tbl_os_produto.os AND tbl_os.fabrica = {$login_fabrica}
            INNER JOIN tbl_posto_fabrica ON tbl_posto_fabrica.posto = tbl_os.posto AND tbl_posto_fabrica.fabrica = {$login_fabrica}
            WHERE tbl_os_item.os_item = {$os_item}";
    $res = pg_query($con, $sql);

    if (pg_num_rows($res) > 0) {
        pg_query($con, "BEGIN");

        $peca             = pg_fetch_result($res, 0, 'peca');
        $os               = pg_fetch_result($res, 0, 'os');
        $os_produto       = pg_fetch_result($res, 0, 'os_produto');
        $controla_estoque = pg_fetch_result($res, 0, "controla_estoque");

        $sql = "DELETE FROM bi_os_item  WHERE os_item = {$os_item} and fabrica = {$login_fabrica}";
        $res = pg_query($con, $sql);

        $sql = "DELETE FROM tbl_os_item WHERE os_item = {$os_item}";
        $res = pg_query($con, $sql);
        if($login_fabrica == 157){
            $sql_delete_auditoria = "DELETE FROM tbl_auditoria_os WHERE os = $os AND auditoria_status = 4 AND cancelada IS NULL";
            pg_query($con, $sql_delete_auditoria);
        }
        if (strlen(pg_last_error()) > 0) {
            $retorno = array('error' => utf8_encode(traduz('erro.ao.deletar.peca.de.ordem.de.servico')));
        } else {
            $retorno = array('ok' => true);
        }

        if ($login_fabrica == 156) {
            $sql = "SELECT auditoria_os
                FROM tbl_auditoria_os
                WHERE os = $os
                AND auditoria_status = 4
                AND liberada IS NULL
                ORDER BY data_input DESC";
            $qry = pg_query($con, $sql);

            if (pg_num_rows($qry) > 0) {
                $auditoria_os = pg_fetch_result($qry, 0, 'auditoria_os');

                $sql = "SELECT COUNT(os_item) AS pecas_os
                    FROM tbl_os_item
                    JOIN tbl_os_produto USING(os_produto)
                    WHERE os = $os";
                $qry = pg_query($con, $sql);

                $pecas_os = pg_fetch_result($qry, 0, 'pecas_os');

                if ($pecas_os == 0) {
                    $justificativa = utf8_encode(traduz("posto.removeu.as.pecas.da.os"));

                    $up = "UPDATE tbl_auditoria_os SET
                            liberada = CURRENT_TIMESTAMP,
                            justificativa = '$justificativa'
                        WHERE auditoria_os = $auditoria_os";
                    $qry = pg_query($con, $up);
                }
            }
        }

        if($controla_estoque == "t" && !$retorno["error"]){

            include "classes/Posvenda/Os.php";

            $classOs = new \Posvenda\Os($login_fabrica);
            $posto = $login_posto;

            if (empty($posto)) {
                $sql = "SELECT posto FROM tbl_os WHERE os = $os";
                $qry = pg_query($con, $sql);
                $posto = pg_fetch_result($qry, 0, "posto");
            }

            $classOs->excluiMovimentacaoEstoque($posto, $peca, $os, $os_item, $con);
        }

        if (!$retorno["error"] && isset($anexo_peca_os)) {
                    $s3_item = new AmazonTC('os_item', $login_fabrica);
                    $anexos = $s3_item->getObjectList("{$os}_{$os_produto}_{$os_item}"); // retirei o '.' para que possa excluir todas as imagens de cada peça
                        foreach ($anexos as $anexo) {
                            $anexo = basename($anexo);
                        $s3_item->deleteObject($anexo);
                    }
                    unset($s3_item);
        }

        if ($retorno["error"]) {
            pg_query($con, "ROLLBACK");
        } else {
            pg_query($con, "COMMIT");
        }
    } else {
        $retorno = array('error' => utf8_encode(traduz('item.nao.encontrado')));
    }

    exit(json_encode($retorno));
}

if(isset($_POST["deleta_anexo_sem_ns"])){

    $dados = $_POST["dados_anexo_sem_ns"];

    $s3_sem_ns = new AmazonTC('os_produto_serie', $login_fabrica);
    $anexos = $s3_sem_ns->getObjectList("{$dados}"); // retirei o '.' para que possa excluir todas as imagens de cada peça

    foreach ($anexos as $anexo) {
        $anexo = basename($anexo);
        $s3_sem_ns->deleteObject($anexo);
    }
    exit;
}

if ($_POST["ajax_remove_anexo"] == true) {

    $posicao    = $_POST["posicao"];
    $tdocs_id   = $_POST["tdocsid"];

    $sql_sua_os = "SELECT sua_os, consumidor_revenda FROM tbl_os WHERE os = $os AND fabrica = $login_fabrica";
    $res_sua_os = pg_query($con, $sql_sua_os);
    $xsua_os             = pg_fetch_result($res_sua_os, 0, 'sua_os');
    $xconsumidor_revenda = pg_fetch_result($res_sua_os, 0, 'consumidor_revenda'); 
    $recorte_sua_os = explode("-", $xsua_os);
    $xsua_os = $recorte_sua_os[0];
    
    if ($consumidor_revenda == 'R') {
        $context = 'revenda';
        $xid     = $xsua_os;
    } else {
        $context = 'os';
        $xid     = $os;
    }

    $tDocs->setContext("os",$context);
    $anexoID = $tDocs->deleteFileById($tdocs_id);

    if (!$anexoID) {
        $retorno = array('erro' => true, 'msg' => utf8_encode('Erro ao remover arquivo'),'posicao' => $posicao);
    }  else {

        $retorno = array('sucesso' => true, 'posicao' => $posicao);
    }

    exit(json_encode($retorno));

}

if ($login_fabrica == 153) {

    if(isset($_POST['remove_os_produto'])){
        $dados = $_POST['id_os'];
        $sql_os_produto = "SELECT os_produto, os, produto FROM tbl_os_produto WHERE os = $dados";
        $res_os_produto = pg_query($con, $sql_os_produto);
        if(pg_num_rows($res_os_produto) > 0){
            $os_produto = pg_fetch_result($res_os_produto, 0, 'os_produto');
            $sql_delete = "DELETE FROM tbl_os_produto WHERE os_produto = $os_produto";
            $res_detele = pg_query($con, $sql_delete);
            if (strlen(pg_last_error()) > 0) {
                $retorno = array("error" => utf8_encode(traduz('erro.ao.alterar.o.produto')));
            } else {
                $retorno = array("ok" => true);
            }
        }
        exit(json_encode($retorno));
    }

    if (!empty($_POST["verifica_pecas"])) {
        $os = $_POST["id_os"];
        $pedido = $_POST["pedido"];

        $cond_pedido = 'AND pedido IS NOT NULL';

        if ($pedido == "f") {
            $cond_pedido = '';
        }

        if (!empty($os)) {
            $qry_os = pg_query(
                $con,
                "SELECT os FROM tbl_os WHERE os = $os AND finalizada IS NOT NULL"
            );

            $qry_produto = pg_query(
                $con,
                "SELECT os_produto FROM tbl_os_produto WHERE os = $os"
            );

            if (pg_num_rows($qry_os) > 0 or pg_num_rows($qry_produto) == 0) {
                die('{"result": 1}');
            }

            $qry = pg_query(
                $con,
                "SELECT pedido
                FROM tbl_os_item
                JOIN tbl_os_produto USING(os_produto)
                WHERE os = $os
                $cond_pedido"
            );

            if (pg_num_rows($qry) > 0) {
                die('{"result": 1}');
            }
        }

        die('{"result": 0}');
    }

    if (!empty($_POST["remove_pecas"])) {
        $os = $_POST["id_os"];

        if (!empty($os)) {
            $sql_item = "SELECT os_item
                FROM tbl_os_item
                JOIN tbl_os_produto
                USING(os_produto)
                WHERE os = $os
                AND pedido IS NULL";

            $qry_item = pg_query($con, $sql_item);
            $qtde_item = pg_num_rows($qry_item);

            $begin = pg_query($con, "BEGIN");

            $qry = pg_query(
                $con,
                "DELETE FROM tbl_os_item WHERE os_item IN ($sql_item)"
            );

            if (pg_affected_rows($qry) <> $qtde_item) {
                $rollback = pg_query($con, "ROLLBACK");
                die('{"error": "'.traduz('erro.ao.excluir.pecas').'."}' );
            }

            $justif = utf8_encode(traduz('peca.removida.da.os'));

            $qry_auditoria = pg_query(
                $con,
                "DELETE FROM tbl_auditoria_os
                 WHERE os = $os
                 AND auditoria_status = 4
                 AND cancelada IS NULL"
            );

            if (pg_affected_rows($qry_auditoria) > 1) {
                $rollback = pg_query($con, "ROLLBACK");
                die('{"error": "'.traduz('erro.ao.excluir.pecas').'."}');
            }

            $commit = pg_query($con, "COMMIT");
        }

        die('{"result": "ok"}');
    }


    if (isset($_POST['ajax_anexo_sem_ns_upload'])) {
        $chave   = $_POST['anexo_chave'];

        $arquivo = $_FILES["anexo_sem_ns_upload"];

        $ext = strtolower(preg_replace("/.+\./", "", $arquivo["name"]));

        if ($ext == 'jpeg') {
            $ext = 'jpg';
        }

        $s3_sem_ns = new AmazonTC('os_produto_serie', $login_fabrica);

        if (strlen($arquivo['tmp_name']) > 0) {
            if (!in_array($ext, array('png', 'jpg', 'jpeg', 'bmp', 'pdf', 'doc', 'docx'))) {
                $retorno = array('error' => utf8_encode(traduz("arquivo.em.formato.invalido.sao.aceitos.os.seguintes.formatos")." : png, jpeg, bmp, pdf, doc, docx"));
            } else {
                $arquivo_nome = "{$chave}";

                $s3_sem_ns->tempUpload("{$arquivo_nome}", $arquivo);

                if($ext == 'pdf'){
                    $link = 'imagens/pdf_icone.png';
                } else if(in_array($ext, array('doc', 'docx'))) {
                    $link = 'imagens/docx_icone.png';
                } else {
                    $link = $s3_sem_ns->getLink("thumb_{$arquivo_nome}.{$ext}", true);
                }

                $href = $s3_sem_ns->getLink("{$arquivo_nome}.{$ext}", true);

                if (!strlen($link)) {
                    $retorno = array('error' => utf8_encode(traduz('erro.ao.anexar.arquivo')));
                } else {
                    $retorno = array('link' => $link, 'arquivo_nome' => "{$arquivo_nome}.{$ext}", 'href' => $href, 'ext' => $ext);
                }
            }
        } else {
            $retorno = array('error' => utf8_encode(traduz('erro.ao.anexar.arquivo')));
        }

        //$retorno['posicao'] = $posicao;

        exit(json_encode($retorno));
    }
}


if($login_fabrica == 161){
    if(strlen(trim($login_posto))>0){
        $busca_posto_cristofoli = true;
        $cond_posto = " AND tbl_posto_fabrica.posto = {$login_posto} ";
    }elseif(strlen(trim($_POST['posto']['id']))>0){
        $busca_posto_cristofoli = true;
        $cond_posto = " AND tbl_posto_fabrica.posto = ".$_POST['posto']['id'];
    }else{
        $busca_posto_cristofoli = false;
    }

    if($busca_posto_cristofoli == true && (strlen($login_posto) > 0 || strlen($_POST['posto']['id']) > 0)){
        $sql = "SELECT tbl_tipo_posto.posto_interno FROM tbl_posto_fabrica
                    INNER JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto
                    WHERE tbl_posto_fabrica.fabrica = {$login_fabrica} $cond_posto ";
        $res = pg_query($con, $sql);
        if(pg_num_rows($res)>0){
            $posto_interno = pg_fetch_result($res, 0, posto_interno);
        }
    }
}

if (isset($_POST['ajax_anexo_upload'])) { 
    $posicao = $_POST['anexo_posicao'];
    $chave   = $_POST['anexo_chave'];

    $arquivo = $_FILES["anexo_upload_{$posicao}"];

    $ext = strtolower(preg_replace("/.+\./", "", $arquivo["name"]));
    $extx = $ext;

    if ($ext == 'jpeg') {
        $ext = 'jpg';
    }

    if (strlen($arquivo['tmp_name']) > 0) {
        if (!in_array($ext, array('png', 'jpg', 'jpeg', 'bmp', 'pdf', 'doc', 'docx'))) {
            $retorno = array('error' => utf8_encode(traduz("arquivo.em.formato.invalido.sao.aceitos.os.seguintes.formatos")." png, jpeg, bmp, pdf, doc, docx"));
        } else {
                $arquivo_nome = "{$chave}_{$posicao}";

                $s3->tempUpload("{$arquivo_nome}", $arquivo);

                if($ext == 'pdf'){
                    $link = 'imagens/pdf_icone.png';
                } else if(in_array($ext, array('doc', 'docx'))) {
                    $link = 'imagens/docx_icone.png';
                } else {
                    $link = $s3->getLink("thumb_{$arquivo_nome}.{$ext}", true);
                    if(strlen($link) == 0 ) {
                        $link = $s3->getLink("thumb_{$arquivo_nome}.{$extx}", true);
                        $ext = $extx;
                    }
                }

                $href = $s3->getLink("{$arquivo_nome}.{$ext}", true);
                if(strlen($href) == 0) {
                    $href = $s3->getLink("{$arquivo_nome}.{$extx}", true);
                    $ext = $extx;
                }
                if (!strlen($link)) {
                    $retorno = array('error' => utf8_encode(traduz('erro.ao.anexar.arquivo')));
                } else {
                    $retorno = array('link' => $link, 'arquivo_nome' => "{$arquivo_nome}.{$ext}", 'href' => $href, 'ext' => $ext);
                }
            
        }
    } else {
        $retorno = array('error' => utf8_encode(traduz('erro.ao.anexar.arquivo')));
    }

    $retorno['posicao'] = $posicao;

    exit(json_encode($retorno));
}

if (isset($_POST['ajax_anexo_upload_termo'])) {
    
    $xos = $_POST['os_termo_anexo'];
    $posicao = $_POST['anexo_posicao_termo'];

    $sql_tem_termo = "SELECT obs FROM tbl_tdocs WHERE referencia_id = $xos AND fabrica = $login_fabrica AND situacao = 'ativo'";
    $res_tem_termo = pg_query($con, $sql_tem_termo);
    if (pg_num_rows($res_tem_termo) > 0) {
        for ($q=0; $q < pg_num_rows($res_tem_termo); $q++) { 
            $xobs = json_decode(pg_fetch_result($res_tem_termo, $q, 'obs'), true);
            if (isset($xobs[$q]['termo_entrega']) && $xobs[$q]['termo_entrega'] == 'ok') {
                $retorno = array('error' => utf8_encode(traduz('arquivo.ja.esta.anexado')));
                $retorno['posicao'] = $posicao;
                exit(json_encode($retorno));
            }
        }
    }
    
    $chave   = $_POST['anexo_chave_termo'];
    $arquivo_nome = "{$chave}_{$posicao}";    
    unset($dados_img);

    $arquivo_termo = $_FILES["anexoUploadTermo_{$posicao}"];

    $ext = strtolower(preg_replace("/.+\./", "", $arquivo_termo["name"]));
    $extx = $ext;

    if ($ext == 'jpeg') {
        $ext = 'jpg';
    }

    if (strlen($arquivo_termo['tmp_name']) > 0) {
        if (!in_array($ext, array('png', 'jpg', 'jpeg', 'bmp', 'pdf', 'doc', 'docx'))) {
            $retorno = array('error' => utf8_encode(traduz("arquivo.em.formato.invalido.sao.aceitos.os.seguintes.formatos")." png, jpeg, bmp, pdf, doc, docx"));
        } else {
            $dados_anexo_termo['name']      = $_FILES["anexoUploadTermo_{$posicao}"]['name'];
            $dados_anexo_termo['type']      = $_FILES["anexoUploadTermo_{$posicao}"]['type'];
            $dados_anexo_termo['tmp_name']  = $_FILES["anexoUploadTermo_{$posicao}"]['tmp_name'];
            $dados_anexo_termo['error']     = $_FILES["anexoUploadTermo_{$posicao}"]['error'];
            $dados_anexo_termo['size']      = $_FILES["anexoUploadTermo_{$posicao}"]['size'];
            $dados_anexo_termo['termo_entrega']     = 'ok';
            
            $anexou = anexaNF($xos, $dados_anexo_termo);
            
            if ($anexou == 0) {
                $sql_anexo = "SELECT tdocs_id, obs FROM tbl_tdocs WHERE referencia_id = {$xos} AND fabrica = {$login_fabrica} AND situacao = 'ativo' ORDER BY data_input DESC";
                $res_anexo = pg_query($con, $sql_anexo);
                $obs_termo = json_decode(pg_fetch_result($res_anexo, 0, 'obs'), true);
                if ($obs_termo[0]['termo_entrega'] == 'ok') {
                    $dados_img['hash'] = pg_fetch_result($res_anexo, 0, 'tdocs_id');
                    $dados_img['posicao_tela'] = $posicao;
                }
                
                if (isset($dados_img)) {
                    $link = '//api2.telecontrol.com.br/tdocs/document/id/'.$dados_img['hash'];
                    $href = '//api2.telecontrol.com.br/tdocs/document/id/'.$dados_img['hash'];
                    $tdocs_id = $dados_img['hash'];
                }
            }            

            if (!strlen($link)) {
                $retorno = array('error' => utf8_encode(traduz('erro.ao.anexar.arquivo')));
            } else {
                $retorno = array('link' => $link, 'arquivo_nome' => "{$arquivo_nome}.{$ext}", 'href' => $href, 'ext' => $ext);
            }
        }
    } else {
        $retorno = array('error' => utf8_encode(traduz('erro.ao.anexar.arquivo')));
    }

    $retorno['posicao'] = $posicao;

    exit(json_encode($retorno));
}

if (isset($_POST['ajax_anexo_peca_upload'])) {
    $s3 = new AmazonTC('os_item', $login_fabrica);

    $chave   = $_POST['anexo_chave'];
    $produto = $_POST['anexo_produto'];
    $peca    = $_POST['anexo_peca'];
    $posicao = $_POST['anexo_posicao'];

    if (isset($_POST['anexo_posicao']) and $posicao === '')
        $posicao = '0';


    if (!is_numeric($produto) or !is_numeric($peca) or (isset($_POST['anexo_posicao']) and !is_numeric($posicao)))
        die(json_encode(array('error'=>utf8_encode(traduz("erro.de.integridade.da.informacoes")),'produto'=>$produto, 'peca'=>$peca, 'pos'=>$posicao)));

    $file_key = implode('_', array_filter(array('anexo_peca_upload', $produto, $peca, $posicao)));

    $arquivo = $_FILES[$file_key];

    $ext = strtolower(preg_replace('/.+\./', '', $arquivo['name']));

   // if ($ext == 'jpeg') {
   //     $ext = 'jpg';
   // }

    if (strlen($arquivo['tmp_name']) > 0) {
        if (!in_array($ext, array('png', 'jpg', 'jpeg', 'bmp', 'pdf', 'doc', 'docx'))) {
            $retorno = array('error' => utf8_encode(traduz("arquivo.em.formato.invalido.sao.aceitos.os.seguintes.formatos")." : png, jpeg, bmp, pdf, doc, docx"));
        } else {

            $arquivo_nome = implode('_', array_filter(array($chave, $produto, $peca, $posicao)));
            $arquivo_nome_ext = $arquivo_nome . ".$ext";

            $s3->tempUpload($arquivo_nome, $arquivo);

            if ($ext == 'pdf') {
                $link = 'imagens/pdf_icone.png';
            } else if(in_array($ext, array('doc', 'docx'))) {
                $link = 'imagens/docx_icone.png';
            } else {
                $link = $s3->getLink("thumb_{$arquivo_nome_ext}", true);
            }

            $href = $s3->getLink($arquivo_nome_ext, true);

            if (!strlen($link)) {
                $retorno = array('error' => utf8_encode(traduz('erro.ao.anexar.arquivo')));
            } else {
                $retorno = array(
                    'link'         => $link,
                    'arquivo_nome' => $arquivo_nome_ext,
                    'produto'      => $produto,
                    'peca'         => $peca,
                    'href'         => $href,
                    'ext'          => $ext
                );
                if (isset($_POST['anexo_posicao']))
                    $retorno['posicao'] = $posicao;
            }
        }
    } else {
        $retorno = array("error" => utf8_encode(traduz('erro.ao.anexar.arquivo')));
    }
    exit(json_encode($retorno));
}

if ($_GET["ajax_busca_vista_explodida"] == true) {

    $produto = preg_replace('/\D/', '', $_GET["produto"]);

    if(in_array($login_fabrica, array(169,170))){
        $nserie = $_GET['nserie'];

        if(strlen(trim($nserie)) > 0){
            $cond_serie = " AND tbl_comunicado.serie = '$nserie' ";
            $cond_s_serie = " AND tbl_comunicado.serie IS NULL ";
        }else{
            $cond_serie = " AND tbl_comunicado.serie IS NULL ";
            $cond_s_serie = " AND tbl_comunicado.serie IS NULL ";
        }
    }

    if ($login_fabrica == 175){
        $produto_serie = $_GET['nserie'];
        if (!empty($produto_serie)){
            $ordem_producao = substr($produto_serie, 0, 6);
            
            $sql_producao = "
                SELECT xxx.* 
                FROM (
                    SELECT DISTINCT ON(xx.versao) xx.versao::float, CASE WHEN xx.proxima_versao IS NULL THEN float8'+infinity' ELSE xx.proxima_versao END AS proxima_versao
                    FROM (
                        SELECT x.versao, c.versao::integer AS proxima_versao FROM(
                            SELECT DISTINCT versao::integer
                            FROM tbl_comunicado
                            WHERE fabrica = {$login_fabrica}
                            AND produto = {$produto}
                            AND ativo IS TRUE
                            ORDER BY versao ASC
                        ) x
                        LEFT JOIN tbl_comunicado c ON x.versao < c.versao::integer AND c.fabrica = {$login_fabrica} AND c.produto = {$produto}
                        ORDER BY x.versao ASC, proxima_versao ASC
                    ) xx
                    ORDER BY xx.versao, xx.proxima_versao ASC
                ) xxx
                WHERE ( xxx.versao IS NULL OR '{$ordem_producao}'::float BETWEEN xxx.versao AND xxx.proxima_versao )
            ";

            $res_producao = pg_query($con, $sql_producao);

            if (pg_num_rows($res_producao) > 0){
                $op_pesquisa = pg_fetch_result($res_producao, 0, 'versao');
                
                if (preg_match("/^0{1,}/", $ordem_producao, $zero_op)) {
                    $op_pesquisa = $zero_op[0].$op_pesquisa;
                }
                
                $tipo_versao = " AND (versao = '$op_pesquisa' OR versao IS NULL) ";
            } else {
                unset($produto);
            }
        }else{
            unset($produto);
        }
    }

    if (isset($usa_versao_produto)) {
        $versao = preg_replace('/[^0-9a-z]/i', '', $_GET["produto_versao"]);
        if ($versao)
            $tipo_versao = " AND versao ilike '%$versao%' ORDER BY comunicado DESC LIMIT 1";
    }

    if (empty($produto)) {
        $retorno = array("error" => utf8_encode(traduz('produto.nao.informado')));
    } else {
        $sem_ve = false;
        $sql = "SELECT comunicado, extensao, tipo FROM tbl_comunicado WHERE fabrica = $login_fabrica AND tipo = 'Vista Explodida' AND produto = $produto $cond_serie AND ativo IS TRUE $tipo_versao ORDER BY comunicado DESC LIMIT 1";
        $res = pg_query($con, $sql);

        if (!pg_num_rows($res)) {
            $sql = "SELECT comunicado, extensao, tipo FROM tbl_comunicado WHERE fabrica = $login_fabrica AND tipo = 'Vista Explodida' AND produto = $produto $cond_s_serie AND ativo IS TRUE AND versao = '000'";
            $res = pg_query($con, $sql);
        }

        if (!pg_num_rows($res)) {
			$sql = "SELECT tbl_comunicado.comunicado, tbl_comunicado.extensao, tbl_comunicado.tipo
				FROM tbl_comunicado
				INNER JOIN tbl_comunicado_produto ON tbl_comunicado_produto.comunicado = tbl_comunicado.comunicado
				INNER JOIN tbl_produto ON tbl_produto.produto = tbl_comunicado_produto.produto AND tbl_produto.fabrica_i = $login_fabrica
				WHERE fabrica = $login_fabrica
				AND tbl_comunicado.tipo = 'Vista Explodida'
				AND tbl_comunicado_produto.produto = $produto
				$cond_serie AND tbl_comunicado.ativo IS TRUE";
            $res = pg_query($con, $sql);
		}

        if (!pg_num_rows($res)) {
            $retorno = array("error" => utf8_encode(traduz("vista.explodida.nao.cadastrada")));
            $sem_ve = true;
        } else {
            $comunicado = pg_fetch_result($res, 0, "comunicado");
            $extensaos3 = pg_fetch_result($res, 0, "extensao");
            $tipos3 = pg_fetch_result($res, 0, "tipo");

            $link = busca_comunicado_anexo($comunicado,$extensaos3,$tipos3);
            if (!is_null($link)) {
                $retorno = array("link" => $link);
            }else{
                $anexaS3 = new anexaS3("ve", (int) $login_fabrica);

                if ($anexaS3->temAnexos($comunicado)) {
                    $link = $anexaS3->url;
                    $retorno = array("link" => $link);
                } else {
                    $retorno = array("error" => utf8_encode(traduz("vista.explodida.nao.encontrada")));
                    $sem_ve = true;
                }
            }

        }

        if ($login_fabrica == 151 && $sem_ve == true) {
            $sql = "SELECT comunicado FROM tbl_comunicado WHERE fabrica = $login_fabrica AND tipo = 'Vista Explodida' AND produto = $produto AND (versao IS NULL OR LENGTH(versao) = 0)";
            $res = pg_query($con, $sql);

            if (!pg_num_rows($res)) {
                $retorno = array("error" => utf8_encode(traduz("vista.explodida.nao.cadastrada")));
            } else {
                $comunicado = pg_fetch_result($res, 0, "comunicado");

                $anexaS3 = new anexaS3("ve", (int) $login_fabrica);

                if ($anexaS3->temAnexos($comunicado)) {
                    $link = $anexaS3->url;
                    $retorno = array("link" => $link);
                } else {
                    $retorno = array("error" => utf8_encode(traduz("vista.explodida.nao.encontrada")));
                }
            }
        }
    }
    exit(json_encode($retorno));
}

if (isset($_POST["verifica_visita_tecnica"]) && $_POST["verifica_visita_tecnica"] == "ok") {

    $produto = $_POST["produto"];

    $sql = "SELECT entrega_tecnica, valores_adicionais FROM tbl_produto WHERE produto = {$produto} AND fabrica_i = {$login_fabrica}";
    $res = pg_query($con, $sql);

    if(pg_num_rows($res) > 0){

        $visita_tecnica = pg_fetch_result($res, 0, "entrega_tecnica");
        $valores_adicionais = pg_fetch_result($res, 0, "valores_adicionais");

        if(!empty($valores_adicionais) or !empty($visita_tecnica)){

            $valores_adicionais = json_decode($valores_adicionais);

            foreach ($valores_adicionais as $key => $value) {
                $$key = $value;
            }

            if($deslocamento_km == "t"){
                echo "true";
            }else{
                echo "false";
            }

        }else{
            echo "false";
        }

    }else{
        echo "false";
    }

    exit;

}

if ($_GET["ajax_verifica_tipo_posto_produto_linha"] == true) {
    $posto            = $_GET["posto"];
    $produto          = $_GET["produto"];
    $tipo_atendimento = $_GET["tipo_atendimento"];

    if (!empty($posto) && !empty($produto) && !empty($tipo_atendimento)) {
        $retorno = array();

        $sql = "SELECT tipo_atendimento FROM tbl_tipo_atendimento WHERE fabrica = {$login_fabrica} AND tipo_atendimento = {$tipo_atendimento} AND km_google IS TRUE";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0) {
            $sql = "SELECT tbl_posto_fabrica.posto
                    FROM tbl_posto_fabrica
                    INNER JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto
                    WHERE tbl_posto_fabrica.posto = {$posto}
                    AND tbl_posto_fabrica.fabrica = {$login_fabrica}
                    AND tbl_tipo_posto.tipo_revenda IS TRUE";
            $res = pg_query($con, $sql);

            if (pg_num_rows($res) > 0) {
                $retorno["posto"] = true;
            } else {
                $retorno["posto"] = false;
            }

            $sql = "SELECT tbl_produto.produto
                    FROM tbl_produto
                    INNER JOIN tbl_linha ON tbl_linha.linha = tbl_produto.linha
                    WHERE tbl_produto.fabrica_i = {$login_fabrica}
                    AND tbl_produto.produto = {$produto}
                    AND tbl_linha.deslocamento IS TRUE";
            $res = pg_query($con, $sql);

            if (pg_num_rows($res) > 0) {
                $retorno["produto"] = true;
            } else {
                $retorno["produto"] = false;
            }

            if ($retorno["posto"] == true && $retorno["produto"] == true) {
                $retorno = array("km" => true);
            }
        }
    }

    exit(json_encode($retorno));

}

if ($_POST["ajax_deleta_defeito_constatado_multiplo_os"] == true) {
    $os                 = $_POST["os"];
    $defeito_constatado = $_POST["defeito_constatado"];

    if (empty($os)) {
        $retorno = array("error" => utf8_encode(traduz("ordem.de.servico.nao.informada")));
    } else if (empty($defeito_constatado)) {
        $retorno = array("error" => utf8_encode(traduz("defeito.constatado.nao.informado")));
    } else {
        $sql = "SELECT defeito_constatado_reclamado FROM tbl_os_defeito_reclamado_constatado WHERE os = {$os} AND defeito_constatado = {$defeito_constatado}";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0) {
            $defeito_constatado_reclamado = pg_fetch_result($res, 0, "defeito_constatado_reclamado");

            $sql = "DELETE FROM tbl_os_defeito_reclamado_constatado USING tbl_os WHERE defeito_constatado_reclamado = {$defeito_constatado_reclamado} and tbl_os.os = tbl_os_defeito_reclamado_constatado.os and tbl_os.finalizada isnull";
            $res = pg_query($con, $sql);

            if (strlen(pg_last_error()) > 0) {
                $retorno = array("error" => utf8_encode(traduz("erro.ao.deletar.defeito.constatado")));
            } else {
                $retorno = array("ok" => true);
            }
        } else {
            $retorno = array("ok" => utf8_encode(traduz("defeito.constatado.nao.lancado.na.ordem.de.servico")));
        }
    }

    exit(json_encode($retorno));
}


function get_servico_realizado($posto = null, $peca = null, $tipo_atendimento = false, $produtoId = null) {
//function get_servico_realizado($posto, $tipo_atendimento = false) {
    global $con, $login_fabrica, $login_posto, $login_pede_peca_garantia, $areaAdmin, $usaEstoquePosto, $tipo_posto_interno, $os, $moduloTraducao;
    /*
    *           $login_pede_peca_garantia == t
    * Se o Posto estiver com "Pedido em Garantia (Manual)" marcado
    * Indica que o posto não pode gerar pedido automático na OS.
    */

    if (in_array($login_fabrica, [161])) {

        if (!empty($produtoId)) {

            $sqlLinhaInternacional = "SELECT produto
                                      FROM tbl_produto
                                      JOIN tbl_familia ON tbl_familia.familia = tbl_produto.familia
                                      JOIN tbl_linha ON tbl_linha.linha = tbl_produto.linha
                                      WHERE tbl_produto.produto = {$produtoId}
                                      AND TRIM(UPPER(tbl_linha.codigo_linha)) = '03'";
            $resLinhaInternacional = pg_query($con, $sqlLinhaInternacional);

            if (pg_num_rows($resLinhaInternacional) > 0) {
                $where_ajuste = "AND UPPER(TRIM(tbl_servico_realizado.descricao)) = 'AJUSTE'";
            }

        }

    }

    if($login_pede_peca_garantia == 't' AND !in_array($login_fabrica, array(52,148))) {
        #$where_sr = " AND gera_pedido is not true ";
    }

    if (in_array($login_fabrica, [146,177]) && $areaAdmin != true) {
        $where_pedido = " AND tbl_servico_realizado.gera_pedido IS FALSE";
    }

    if ($login_fabrica == 143) {
        $where_sr_troca_peca = " AND gera_pedido IS TRUE AND troca_de_peca IS TRUE AND peca_estoque IS NOT TRUE ";
    } else {
        $union_sr = "UNION SELECT null AS servico_realizado, ' ' AS descricao, false AS troca_de_peca, false AS gera_pedido, false AS peca_estoque";
    }

    if (empty($posto)) {
        $posto = ($areaAdmin === true) ? getValue("posto[id]") : $login_posto;
    }

    if ($usaEstoquePosto && ($areaAdmin === false || ($areaAdmin === true && strlen($posto) > 0))) {

        $sql = "SELECT
                    pf.controla_estoque,
                    tp.posto_interno
                FROM tbl_posto_fabrica pf
                LEFT JOIN tbl_tipo_posto tp USING(tipo_posto,fabrica)
                WHERE pf.fabrica = {$login_fabrica}
                AND pf.posto = {$posto}";
        $res = pg_query($con, $sql);

        $posto_controla_estoque = pg_fetch_result($res, 0, "controla_estoque");
        $posto_interno = pg_fetch_result($res, 0, "posto_interno");

        if ($posto_controla_estoque != "t") {
            if ($login_fabrica != 161) {
                $whereControleEstoque = "AND peca_estoque IS NOT TRUE";
            } else {
                $whereControleEstoque = " AND (descricao NOT ILIKE '%Usando Estoque%' OR peca_estoque IS NOT TRUE) ";
            }
        } else if ($login_fabrica == 153) {
            $whereControleEstoque = "OR peca_estoque IS TRUE";
        } else if ($login_fabrica == 158) {
            $whereControleEstoque = "OR peca_estoque IS TRUE";
        }

        if ($login_fabrica == 158 && $posto_interno == "t") {
            $where_sr_troca_peca = "AND troca_de_peca IS TRUE";
        }

    }

    // Verifica se o posto é Distribuidor
    if($login_fabrica == 160 or $replica_einhell){

        $sql = "SELECT tbl_tipo_posto.descricao FROM tbl_posto_fabrica
                INNER JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto
                WHERE tbl_posto_fabrica.posto = $posto AND tbl_posto_fabrica.fabrica = $login_fabrica";
        $res = pg_query($con, $sql);
        if(pg_num_rows($res)>0){
            $descricao_tp = trim(pg_fetch_result($res, 0, 'descricao'));
        }

        if($descricao_tp != "Distribuidor"){
            $where_posto_distribuidor = " and tbl_servico_realizado.peca_estoque is not true";
        }

    }

    // Verifica se o Posto não é Interno ou Revenda
    if ($login_fabrica == 163 AND !empty($posto)) {

        $sql = "SELECT tbl_tipo_posto.descricao
                FROM tbl_posto_fabrica
                    INNER JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto
                WHERE tbl_posto_fabrica.posto = $posto
                AND tbl_posto_fabrica.fabrica = $login_fabrica
                AND tbl_tipo_posto.posto_interno IS NOT TRUE
                AND tbl_tipo_posto.tipo_revenda IS NOT TRUE;";

        $res = pg_query($con, $sql);
        if(pg_num_rows($res)>0 AND $login_pede_peca_garantia != 't' ){
            $where_not_gera_pedido_troca_peca = " AND gera_pedido IS NOT TRUE  ";
        }
    }

    $where_tipo_atendimento = "";

    if ($login_fabrica == 148 && $tipo_atendimento) {
        $where_tipo_atendimento = " AND tbl_servico_realizado.peca_estoque = 't'";
    }

    if($login_fabrica == 158 && $tipo_atendimento){
	    $sql = "SELECT tipo_atendimento 
		    FROM tbl_tipo_atendimento 
		    WHERE fabrica = {$login_fabrica} 
		    AND tipo_atendimento = {$tipo_atendimento} 
		    AND codigo = '40'";
	    $res = pg_query($con, $sql);

	    if(pg_num_rows($res) > 0){
		$where_tipo_atendimento = " AND tbl_servico_realizado.gera_pedido = 'f' ";
	    }
    }

    if (in_array($login_fabrica, array(174,175,176,178)) && !empty($tipo_atendimento)) {
        $sql = "SELECT fora_garantia FROM tbl_tipo_atendimento WHERE fabrica = {$login_fabrica} AND tipo_atendimento = {$tipo_atendimento} AND fora_garantia IS TRUE";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0) {
            if ($login_fabrica == 178){
                $sql_cortesia = "SELECT os FROM tbl_os WHERE os = $os AND cortesia = 't' AND fabrica = $login_fabrica";
                $res_cortesia = pg_query($con, $sql_cortesia);

                if (pg_num_rows($res_cortesia) == 0){
                    $where_tipo_atendimento = "AND gera_pedido = 'f'";
                }
                unset($whereControleEstoque);
            }else{
                $where_tipo_atendimento = "AND tbl_servico_realizado.peca_estoque IS TRUE";

                if ($login_fabrica == 175){
                    $where_tipo_atendimento = "AND (tbl_servico_realizado.peca_estoque IS TRUE
                            OR tbl_servico_realizado.peca_estoque IS NOT TRUE 
                                AND tbl_servico_realizado.troca_de_peca IS NOT TRUE
                        )";
                }
                unset($whereControleEstoque);
            }
        }
    }
    
    if (in_array($login_fabrica, array(174))) {
        $order_by = 'descricao DESC';
    } else {
        $order_by = 'descricao';
    }

    $campo_add_tipo     = '';
    if (in_array($login_fabrica, [193])) {
        $campo_add_tipo = ', codigo_servico';
        $union_sr      .= ', null AS codigo_servico';
    }

    $paisPosto = '';
    if (!empty($login_posto)) {
    	$sqlPaisPosto = "SELECT contato_pais FROM tbl_posto_fabrica WHERE fabrica = {$login_fabrica} AND posto = {$login_posto};";
    	$resPaisPosto = pg_query($con, $sqlPaisPosto);
    	if (pg_num_rows($resPaisPosto) > 0) {
    	    $paisPosto = pg_fetch_result($resPaisPosto, 0, 'contato_pais');
    	}
    }

    if(count($moduloTraducao) > 0 && !empty($paisPosto) && $paisPosto !== 'BR') {
    	$join = " JOIN tbl_servico_realizado_idioma ON tbl_servico_realizado.servico_realizado = tbl_servico_realizado_idioma.servico_realizado ";
    	$campo = " tbl_servico_realizado_idioma.descricao ,"	;
    }else{
	   $campo = " tbl_servico_realizado.descricao ,"	;
    }

    $sql_sr = "
        SELECT
            tbl_servico_realizado.servico_realizado,
            $campo
            (CASE WHEN troca_de_peca IS TRUE THEN TRUE ELSE FALSE END) AS troca_de_peca,
            (CASE WHEN gera_pedido   IS TRUE THEN TRUE ELSE FALSE END) AS gera_pedido,
            (CASE WHEN peca_estoque  IS TRUE THEN TRUE ELSE FALSE END) AS peca_estoque
            {$campo_add_tipo}
        		FROM tbl_servico_realizado
        		$join
        WHERE fabrica = $login_fabrica
        AND (ativo IS TRUE
        {$where_posto_distribuidor}
        {$whereControleEstoque})
        {$where_sr}
        {$where_ajuste}
        {$where_pedido}
        {$where_sr_troca_peca}
        {$where_not_gera_pedido_troca_peca}
        {$where_tipo_atendimento}
        $whereUso
        {$union_sr}
        ORDER BY {$order_by};
    ";
    $whereControleEstoque = "";

    if($login_fabrica == 35 AND $usaEstoquePosto == true){
        $sql_sr = "SELECT
            servico_realizado,
            descricao,
            (CASE WHEN troca_de_peca IS TRUE THEN TRUE ELSE FALSE END) AS troca_de_peca,
            (CASE WHEN gera_pedido   IS TRUE THEN TRUE ELSE FALSE END) AS gera_pedido,
            (CASE WHEN peca_estoque  IS TRUE THEN TRUE ELSE FALSE END) AS peca_estoque
        FROM tbl_servico_realizado
        WHERE fabrica = $login_fabrica
        AND tbl_servico_realizado.troca_de_peca IS TRUE
        AND  tbl_servico_realizado.peca_estoque IS TRUE
        ORDER BY descricao";
    }

    if ($login_fabrica == 165) {

        if ($posto_controla_estoque != "t") {
            $whereControleEstoque = " AND peca_estoque IS NOT TRUE";
        }

        $sql_sr = "
            SELECT
                tbl_servico_realizado.servico_realizado,
                    tbl_servico_realizado.descricao,
                    (CASE WHEN tbl_servico_realizado.troca_de_peca IS TRUE THEN TRUE ELSE FALSE END) AS troca_de_peca,
                    (CASE WHEN tbl_servico_realizado.gera_pedido   IS TRUE THEN TRUE ELSE FALSE END) AS gera_pedido,
                    (CASE WHEN tbl_servico_realizado.peca_estoque  IS TRUE THEN TRUE ELSE FALSE END) AS peca_estoque
                FROM tbl_servico_realizado
                JOIN tbl_peca_servico USING(servico_realizado)
                WHERE tbl_peca_servico.peca = {$peca}
            {$whereControleEstoque}
                AND tbl_servico_realizado.fabrica = {$login_fabrica}
                AND tbl_servico_realizado.ativo IS TRUE;
            ";
    }

    return pg_query($con,$sql_sr);
}

if (isset($_POST["ajax_servico_realizado"])) {
    $posto = $_POST["posto"];
    $peca =  $_POST["peca"];
    $tipo_atendimento = $_POST["tipo_atendimento"];
    $produtoId = $_POST['produto_id'];

    $res_sr = get_servico_realizado($posto,$peca,$tipo_atendimento,$produtoId);

    $res_sr = array_map(function($r) {
        $r["descricao"] = utf8_encode($r["descricao"]);
        return $r;
    }, pg_fetch_all($res_sr));

    exit(json_encode($res_sr));
}

if (isset($_REQUEST['ajax_verifica_troca_peca'])) {
    $solucao_selecionada = $_REQUEST['solucao'];
    $solucao_totas       = $_REQUEST['solucao'];

    $solucao_lancada = explode(",", $_REQUEST["solucao_lancada"]);

    if ($login_fabrica == 158 && (count($solucao_lancada) < count($solucao_selecionada))) {
        foreach ($solucao_selecionada as $key => $value) {
            foreach ($solucao_lancada as $k => $v) {
                if ($value == $v) {
                    unset($solucao_selecionada[$key]);
                }
            }
        }
    }

    $solucao_selecionada = implode(', ', $solucao_selecionada);

    $sql = "SELECT troca_peca FROM tbl_solucao WHERE fabrica = {$login_fabrica} AND solucao IN ({$solucao_selecionada})";
    $res = pg_query($con, $sql);

    if (strlen(pg_last_error()) > 0) {
        $retorno = array("erro" => utf8_encode(traduz("ocorreu.um.erro.na.validacao.da.solucao")));
    } else {
        if ($login_fabrica == 158) {
            $troca_peca = pg_fetch_result($res, 0, 'troca_peca');
            $solucao_totas = implode(", ", $solucao_totas);

            $sqlPdv = "SELECT solucao FROM tbl_solucao WHERE fabrica = {$login_fabrica} AND solucao IN ({$solucao_totas}) AND parametros_adicionais->>'programacao_pdv' = 'true' ";
            $resPdv = pg_query($con, $sqlPdv);
            if (pg_num_rows($resPdv) > 0) {
                    if ($troca_peca != 't') {
                        $troca_peca = 'f';
                        $retorno = array("sucesso" => utf8_encode(traduz("para.esta.solucao.nao.e.necessario.lancar.pecas")), "troca_peca" => $troca_peca, "pdv"=> true);
                    } else {
                        $retorno = array("sucesso" => utf8_encode(traduz("esta.solucao.exige.o.lancamento.de.pecas")), "troca_peca" => $troca_peca, "pdv"=> true);
                    }
            } else {
                if ($troca_peca != 't') {
                    $troca_peca = 'f';
                    $retorno = array("sucesso" => utf8_encode(traduz("para.esta.solucao.nao.e.necessario.lancar.pecas")), "troca_peca" => $troca_peca);
                } else {
                    $retorno = array("sucesso" => utf8_encode(traduz("esta.solucao.exige.o.lancamento.de.pecas")), "troca_peca" => $troca_peca);
                }
            }
        } else {
            $troca_peca = pg_fetch_result($res, 0, troca_peca);
            if ($troca_peca != 't') {
                $troca_peca = 'f';
                $retorno = array("sucesso" => utf8_encode(traduz("para.esta.solucao.nao.e.necessario.lancar.pecas")), "troca_peca" => $troca_peca);
            } else {
                $retorno = array("sucesso" => utf8_encode(traduz("esta.solucao.exige.o.lancamento.de.pecas")), "troca_peca" => $troca_peca);
            }
        }
    }

    echo json_encode($retorno);
    exit;
}

if (isset($_POST['ajax_busca_tecnico'])) {

    $posto = $_POST['posto'];

    if (strlen($posto) > 0) {
        $sqlTec = "SELECT tecnico, nome
                FROM tbl_tecnico
                WHERE fabrica = {$login_fabrica}
                AND posto = {$posto}
                AND ativo IS TRUE
                ORDER BY nome;";
        $resTec = pg_query($con, $sqlTec);

        $tecnicos = pg_fetch_all($resTec);

        foreach ($tecnicos as $tecnico) {
            $retorno[$tecnico['tecnico']] = utf8_encode($tecnico['nome']);
        }
    }

    echo json_encode($retorno);
    exit;

}

if (isset($_POST['ajax_busca_unidade_negocio'])) {

    $posto = $_POST['posto'];

    if (!empty($posto)) {
        $sql = "
            SELECT DISTINCT
                tbl_distribuidor_sla.unidade_negocio,
                tbl_distribuidor_sla.distribuidor_sla,
                tbl_unidade_negocio.nome
            FROM tbl_distribuidor_sla_posto
            JOIN tbl_distribuidor_sla USING(distribuidor_sla, fabrica)
            JOIN tbl_unidade_negocio ON tbl_unidade_negocio.codigo = tbl_distribuidor_sla.unidade_negocio
            WHERE tbl_distribuidor_sla_posto.fabrica = {$login_fabrica}
            AND tbl_distribuidor_sla_posto.posto = {$posto}";
        
        $res = pg_query($con, $sql);

        $unidades_negocio = pg_fetch_all($res);
        if (count($unidades_negocio) > 0) {
            foreach ($unidades_negocio as $xunidade_negocio) {
                $nomeUnidade = $xunidade_negocio['nome'];
                $retorno[$xunidade_negocio['unidade_negocio']] = strtoupper($nomeUnidade);
            }
        } else {
            $retorno['erro'] = utf8_encode(traduz("nenhuma.unidade.de.negocio.encontrada"));
        }
    } else {
        $retorno['erro'] = utf8_encode(traduz("posto.nao.selecionado.para.buscar.unidade.de.negocio"));
    }

    echo json_encode($retorno);
    exit;
}

if (filter_input(INPUT_POST,"defeito_reclamado",FILTER_VALIDATE_BOOLEAN)) {
    $produto            = filter_input(INPUT_POST,"produto");
    $fora_garantia      = filter_input(INPUT_POST,"fora_garantia");
    $tipo_atendimento   = filter_input(INPUT_POST,"tipo_atendimento");

    $joinFamilia = "
        INNER JOIN tbl_familia ON tbl_familia.familia = tbl_diagnostico.familia AND tbl_familia.fabrica = {$login_fabrica}
        INNER JOIN tbl_produto ON tbl_produto.familia = tbl_familia.familia AND tbl_produto.fabrica_i = {$login_fabrica}
    ";

    /* 
    * ISSO RESOLVE O ERRO QUE: PERDE A INFORMAÇÃO QUANDO DA ERRO NA ABERTURA DA OS
    */
    if (in_array($login_fabrica, [191,203])) {
        $whereProduto = " AND tbl_produto.produto = {$produto} ";
    }

    if ($login_fabrica == 158) {
        if ($fora_garantia == 't') {
            $aux_garantia_dig = ($fora_garantia == 't') ? 'f' : 't';
            $whereTipoAtendimento = "AND tbl_diagnostico.garantia = '{$aux_garantia_dig}'";
            $whereTipoAtendimento .= ($tipo_atendimento == 272)
                ? " AND tbl_diagnostico.tipo_atendimento = 272"
                : " AND COALESCE(tbl_diagnostico.tipo_atendimento, -1) <> 272";
            if ($tipo_atendimento == 272) {
                $joinFamilia = "";
                $whereProduto = "";
            }
        }
    }

    if (in_array($login_fabrica, [169,170]) && $tipo_atendimento == 304) {
        $joinFamilia = "";
        $whereProduto = "";
        $whereTipoAtendimento = "AND tbl_diagnostico.tipo_atendimento = {$tipo_atendimento}";
    }

    if ($login_fabrica == 175){
	$joinFamilia = "";
        $joinLinhaFamilia = " 
            INNER JOIN tbl_linha ON tbl_linha.linha = tbl_diagnostico.linha AND tbl_linha.fabrica = {$login_fabrica} 
            INNER JOIN tbl_produto ON tbl_produto.linha = tbl_linha.linha AND tbl_produto.fabrica_i = {$login_fabrica}
        ";
    }
    $sql = "SELECT
            DISTINCT tbl_defeito_reclamado.defeito_reclamado,
            tbl_defeito_reclamado.codigo,
            tbl_defeito_reclamado.descricao
        FROM tbl_diagnostico
        INNER JOIN tbl_defeito_reclamado ON tbl_defeito_reclamado.defeito_reclamado = tbl_diagnostico.defeito_reclamado AND tbl_defeito_reclamado.fabrica = {$login_fabrica} AND tbl_defeito_reclamado.ativo IS TRUE
        {$joinLinhaFamilia}
        $joinFamilia
        WHERE tbl_diagnostico.fabrica = {$login_fabrica}
        $whereProduto
        AND tbl_diagnostico.ativo IS TRUE
        {$whereTipoAtendimento}
        ORDER BY tbl_defeito_reclamado.codigo ASC, tbl_defeito_reclamado.descricao ASC";
    $res = pg_query($con, $sql);

    $defeitos_reclamados = array();
    if(pg_num_rows($res) > 0){
        for($i = 0; $i < pg_num_rows($res); $i++){
            $defeito_reclamado = pg_fetch_result($res, $i, "defeito_reclamado");
            $descricao         = pg_fetch_result($res, $i, "descricao");
            $codigo            = pg_fetch_result($res, $i, "codigo");

			if($cook_idioma <> 'pt-br') {
				$sqlIdiomaReclamado = "SELECT descricao 
					FROM tbl_defeito_reclamado_idioma 
					WHERE defeito_reclamado = {$defeito_reclamado}
					AND LOWER(idioma) = LOWER('$cook_idioma')";
				$resIdiomaReclamado = pg_query($con, $sqlIdiomaReclamado);

				if (pg_num_rows($resIdiomaReclamado) > 0) {
					$descricao = pg_fetch_result($resIdiomaReclamado, 0, 'descricao');
				}
			}
            if (in_array($login_fabrica, array(158,169,170))) {
                $descricao = $codigo . " - " . $descricao;
	    }

	    if(strlen($descricao) == 0) continue;

            $defeitos_reclamados[] = array("defeito_reclamado" => utf8_encode($defeito_reclamado), "descricao" => utf8_encode($descricao));
        }
    }else{
        $defeitos_reclamados[] = array("defeito_reclamado" => "", "descricao" => "");
    }
    $defeitos_reclamados = array_filter($defeitos_reclamados);
    exit(json_encode(array("retorno" => $defeitos_reclamados)));
}

if (isset($_REQUEST['ajax_verifica_valores_adicionais'])){

    $tipoAtd = $_REQUEST['tipo_atendimento'];
    $os = $_REQUEST['os'];
    $produto_id = $_REQUEST['produto'];
    $mostra_va = true;

    if (in_array($login_fabrica, array(169,170)) && !empty($os)) {
        $sql = "
            SELECT
                tipo_revenda
            FROM tbl_posto_fabrica pf
            JOIN tbl_tipo_posto tp ON tp.tipo_posto = pf.tipo_posto AND tp.fabrica = {$login_fabrica}
            JOIN tbl_os o ON o.posto = pf.posto AND o.fabrica = {$login_fabrica}
            WHERE pf.fabrica = {$login_fabrica}
            AND o.os = {$os}
            AND tp.tipo_revenda IS TRUE;
        ";

        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0) {
            $mostra_va = false;
        }

    }

    $sql = "SELECT case when tbl_produto.valores_adicionais notnull then tbl_produto.valores_adicionais::jsonb else tbl_familia.valores_adicionais end as valores_adicionais
            FROM tbl_produto 
			JOIn tbl_familia using(familia)
            WHERE tbl_produto.fabrica_i = {$login_fabrica} 
            AND tbl_produto.produto = {$produto_id}";
    $resVAPROD = pg_query($con,$sql);

    if (!empty($tipoAtd)) {
        $sql = "SELECT valores_adicionais FROM tbl_fabrica WHERE fabrica = {$login_fabrica} AND JSON_FIELD('tipo_atendimento', valores_adicionais)::INT = {$tipoAtd};";
        $resVA = pg_query($con, $sql);
    }

    if (!empty($tipoAtd) && $login_fabrica == 195) {
        $sqlTA = "SELECT * FROM tbl_tipo_atendimento WHERE fabrica = {$login_fabrica} AND tipo_atendimento = {$tipoAtd};";
        $resTA = pg_query($con, $sqlTA);
        $km_google = pg_fetch_result($resTA ,0, "km_google");
 
        $sql = "SELECT valores_adicionais FROM tbl_fabrica WHERE fabrica = {$login_fabrica}";
        $resVA = pg_query($con, $sql);
    }

    $valfab = pg_fetch_result($resVA ,0, "valores_adicionais");
    $valos = pg_fetch_result($resVAOS ,0, "valores_adicionais");
    $valprod = pg_fetch_result($resVAPROD ,0, "valores_adicionais");

    if (($valprod == null && $valos  == null && $valfab == null) || $mostra_va == false) {
        $return = array("retorno" => false);
    }else{
        $valfab = ($valfab != null) ? json_decode($valfab,true) : array();
        $valos  = ($valos != null) ? json_decode($valos,true) : array();
        $valprod = ($valprod != null) ? json_decode($valprod,true) : array();
        $valores = array_merge($valprod,$valos,$valfab);

        if (is_array($valores)) {
            foreach ($valores as $key => $value) {
                if ($login_fabrica == 195 && $key != "SEGUNDA VISITA" && $km_google == 't') {
                    continue;
                } 
                if ($login_fabrica == 195 &&  $key == "SEGUNDA VISITA" && $km_google == 'f') {
                    continue;
                }
                
                $valor_adicional_selecionado_valor[$key] = $value;
            }

            $return = array("retorno" => $valor_adicional_selecionado_valor);
        }

    }

    echo json_encode($return);
    exit;

}

if (isset($_GET['ajax_marcas_produto'])) {

    $produto = $_GET['produto'];

    if (strlen($produto) > 0) {
        $sqlProd = "SELECT parametros_adicionais::jsonb->'marcas' AS marca
                FROM tbl_produto
                WHERE fabrica_i = {$login_fabrica}
                AND produto = {$produto};";
        $resProd = pg_query($con, $sqlProd);

        $marcas = pg_fetch_result($resProd,0,"marca");
        
    	if(strlen($marcas) > 0){
    		
    		$marcas = str_replace('"','',$marcas);

    		$sqlMarcas = "SELECT marca,nome
    				FROM tbl_marca
    				WHERE fabrica = {$login_fabrica}
    				AND marca IN(".$marcas.");
    		";
            $resMarcas = pg_query($con,$sqlMarcas);
    		$marcas = pg_fetch_all($resMarcas);
    	}
        
        foreach ($marcas as $marca) {
            $retorno[$marca['marca']] = utf8_encode($marca['nome']);
        }
    }
    echo json_encode($retorno);
    exit;
}

if (isset($_POST['ajax_produto_troca'])) {
    $marca      = $_POST['marca_produto'];
    $produto_os = $_POST["produto_os"];

    if (strlen($marca) > 0 AND !empty($produto_os)) {
        $sql = "SELECT preco, familia FROM tbl_produto WHERE produto = $produto_os AND fabrica_i = $login_fabrica";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0){
            $preco_produto_os   = pg_fetch_result($res, 0, "preco");
            $familia            = pg_fetch_result($res, 0, "familia");
            $preco_base         = $preco_produto_os + ($preco_produto_os/100 *20);
            
            if (!empty($familia)){
                $sqlProd = "
                    SELECT produto, referencia, descricao, preco
                    FROM tbl_produto
                    WHERE fabrica_i = {$login_fabrica}
		    AND parametros_adicionais::jsonb->>'marcas' = '$marca'
		    AND (UPPER(parametros_adicionais::jsonb->>'fora_linha') != 'T' OR parametros_adicionais::jsonb->>'fora_linha' IS NULL)
		    AND lista_troca = 't'
                    AND familia = $familia
                    ORDER BY descricao ASC;
		";
                $resProd = pg_query($con, $sqlProd);
                if (pg_num_rows($resProd) > 0){
                    $produtos = array();

                    for ($i=0; $i < pg_num_rows($resProd); $i++) { 
                        $preco_produto_troca = pg_fetch_result($resProd, $i, "preco");
                        
                        if ($preco_produto_troca >= $preco_produto_os AND $preco_produto_troca < $preco_base){
                            $produtos[$i] = array(
                                "produto" => pg_fetch_result($resProd, $i, "produto"),
                                "referencia" => utf8_encode(pg_fetch_result($resProd, $i, "referencia")),
                                "descricao" => utf8_encode(pg_fetch_result($resProd, $i, "descricao"))
                            );
                        }
                    }
		    if (count($produtos) > 0) {
                    	$retorno = $produtos;
		    } else {
			$retorno = array("erro" => utf8_encode("Nenhum produto com preço aproximado"));
		    }
                } else {
		    $retorno = array("erro" => utf8_encode("Nenhum produto encontrado"));
		}
            }
        }
    }
    echo json_encode($retorno);
    exit;
}


// }}} FIM das respostas AJAX

if ((!isset($_GET["os_id"]) || strlen($_GET["os_id"]) == 0) && $login_fabrica == 183 AND $areaAdmin === false) {
    header('Location: menu_inicial.php');
}

if (!empty($os) && empty($_REQUEST["os_id"]) && empty($_REQUEST["chave_os_conjunto"])) {
    unset($os);
}

if (strlen($os) == 0 && strlen($_REQUEST['preos']) == 0 && strlen($_REQUEST['os_id']) == 0 && $areaAdmin === false && empty($_REQUEST["chave_os_conjunto"])) {
    $sql = "SELECT digita_os FROM tbl_posto_fabrica WHERE posto = {$login_posto} AND fabrica = {$login_fabrica};";
    $res = @pg_query($con,$sql);
    $digita_os = pg_fetch_result ($res,0,0);

    if ($digita_os == 'f' ) {
        include __DIR__.'/cabecalho_new.php'; ?>
        <br />
        <br />
        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th><?php echo traduz("sem.permissao.para.cadastrar.ordem.de.servico");?></th>
                </tr>
            </thead>

        </table>
        <br />
        <br />
        <?
        include "rodape.php";
        exit;
    }
}

#Arquivo com o array para montar o formulário
#include __DIR__."/os_cadastro_unico/fabricas/{$login_fabrica}/form.php";

#Arquivo que processa o post
# Regras gerais e de fabricas

if (in_array($login_fabrica, [131])) {
	$os_admin = false;

	if (!empty($_REQUEST['os_id'])) {
		$sql_os_admin = 'SELECT admin FROM tbl_os WHERE admin IS NULL AND os = ' . (int) $_REQUEST['os_id'] ;
		$res_os_admin = pg_query($con, $sql_os_admin);

		if (pg_num_rows($res_os_admin) > 0) {
			$os_admin = true;
		}
	}
}

include "os_cadastro_unico/fabricas/os.php";

if ($login_pais != "BR" && !$areaAdmin) {
    $arrayEstados = $array_estados($login_pais);
} else if ($areaAdmin && getValue("posto[pais]") != "BR" && !empty(getValue("posto[pais]"))) {
    $arrayEstados = $array_estados(getValue("posto[pais]"));
}

if (isset($_POST["ajax_busca_cidade"]) && !empty($_POST["estado"])) {
    $estado = strtoupper($_POST["estado"]);
    
    if (!$areaAdmin) {
        $pais = $login_pais;
    } else if (!empty($_POST['pais'])) {
        $pais = $_POST['pais'];
    } else {
        $pais = "BR";
    }

    if ($pais != "BR") {
        
        $sql = "SELECT UPPER(fn_retira_especiais(nome)) AS cidade 
                FROM tbl_cidade 
                WHERE UPPER(estado_exterior) = UPPER('{$estado}')
                AND UPPER(pais) = UPPER('{$pais}')
                ";
        $res = pg_query($con, $sql);

        if (pg_num_rows($res) > 0) {
            $array_cidades = array();

            while ($result = pg_fetch_object($res)) {
                $array_cidades[] = $result->cidade;
            }

            $retorno = array("cidades" => $array_cidades);
        } else {
            $retorno = array("error" => traduz("Nenhuma cidade encontrada para o estado: %", null, null, [$estado]));
        }

    } else {
        
        if (array_key_exists($estado, $arrayEstados)) {
            $sql = "SELECT DISTINCT * FROM (
                        SELECT UPPER(fn_retira_especiais(nome)) AS cidade FROM tbl_cidade WHERE UPPER(estado) = UPPER('{$estado}') AND pais = UPPER('{$pais}') AND cod_distrito IS NULL
                        UNION (
                            SELECT UPPER(fn_retira_especiais(cidade)) AS cidade FROM tbl_ibge WHERE UPPER(estado) = UPPER('{$estado}')
                        )
                    ) AS cidade
                    ORDER BY cidade ASC";
            $res = pg_query($con, $sql);
            if (pg_num_rows($res) > 0) {
                $array_cidades = array();

                while ($result = pg_fetch_object($res)) {
                    $array_cidades[] = $result->cidade;
                }

                $retorno = array("cidades" => $array_cidades);
            } else {
                $retorno = array("error" => utf8_encode(traduz("nenhuma.cidade.encontrada.para.o.estado") . ": {$estado}"));
            }
        } else {
            $retorno = array("error" => utf8_encode(traduz("estado.nao.encontrado")));
        }

    }

    exit(json_encode($retorno));
}

if ($areaAdmin == true && strlen(getValue('posto[id]')) > 0) {
    $postoInterno = verifica_tipo_posto("posto_interno", "TRUE", getValue("posto[id]"));
    $tecnicoProprio = verifica_tipo_posto("tecnico_proprio", "TRUE", getValue("posto[id]"));
} else if ($areaAdmin == false) {
    $postoInterno = verifica_tipo_posto("posto_interno", "TRUE", $login_posto);
    $tecnicoProprio = verifica_tipo_posto("tecnico_proprio", "TRUE", $login_posto);

    if ($login_fabrica == 163 AND ($postoInterno == true OR verifica_tipo_posto("tipo_revenda", "TRUE", $login_posto) == true )) {
        regras_tipo_posto_interno_revenda();
    }
}

if ($login_fabrica == 157) {
    $anexo_obrigatorio = true;
} else if (in_array($login_fabrica, [158,165])) {
    if ($postoInterno === true || $tecnicoProprio === true) {
        $anexo_obrigatorio = false;
    } else {
        $anexo_obrigatorio = true;
    }
} else {
    $anexo_obrigatorio = false;
}

if (in_array($login_fabrica, array(157,161,165))) {
    if($postoInterno == true){
        unset($valida_anexo);
    }
}

// if ($login_fabrica == 164) {
//     if (isset($valida_anexo)) {
//         $msg_erro = ""
//     }
// }


if ($fabricaFileUploadOS) {
    if (!empty($os)) {
        $tempUniqueId = $os;
        $anexoNoHash = null;
    } else if(!empty($preos) AND $login_fabrica == 191){
    	$tempUniqueId = $preos;
	    $anexoNoHash = null;
    } else if (strlen(getValue("anexo_chave")) > 0) {
        $tempUniqueId = getValue("anexo_chave");
        $anexoNoHash = true;
    } else {
        if ($areaAdmin === true) {
            $tempUniqueId = $login_fabrica.$login_admin.date("dmYHis");
        } else {
            $tempUniqueId = $login_fabrica.$login_posto.date("dmYHis");
        }

        $anexoNoHash = true;
    }
}

if (strlen($os) > 0 && in_array($login_fabrica, array(152,180,181,182))) {
    $sql = "SELECT tbl_tipo_atendimento.tipo_atendimento
              FROM tbl_tipo_atendimento
              JOIN tbl_os ON tbl_os.tipo_atendimento = tbl_tipo_atendimento.tipo_atendimento
             WHERE tbl_tipo_atendimento.fabrica = {$login_fabrica}
               AND tbl_os.os = {$os}
               AND tbl_tipo_atendimento.entrega_tecnica IS TRUE";
    $res = pg_query($con,$sql);

    if(pg_num_rows($res) > 0){
        header("Location: cadastro_os_entrega_tecnica.php?os_id={$os}");
    }
}

/*HD - 4300021*/
if (!empty($_POST["verificarColetaDeProduto"])) {
    $tipo_atendimento = $_POST["tipo_atendimento"];

    $aux_sql = "SELECT grupo_atendimento FROM tbl_tipo_atendimento WHERE tipo_atendimento = $tipo_atendimento LIMIT 1";
    $aux_res = pg_query($con, $aux_sql);

    if (pg_num_rows($aux_res) <= 0)  {
        echo "KO";
    } else {
        $grupo_atendimento = pg_fetch_result($aux_res, 0, 'grupo_atendimento');
        echo $grupo_atendimento;
    }

    exit;
}

$layout_menu = ($areaAdmin) ? 'callcenter' : 'os';
if($login_fabrica == 180){
    $title = strtoupper(traduz("registro.de.orden.servicio"));
} else {
    $title = strtoupper(traduz("cadastro.de.ordem.de.serviÇo"));    
}

if ($areaAdmin === true) {
    include __DIR__.'/admin/cabecalho_new.php';
} else {
    include __DIR__.'/cabecalho_new.php';

    if (strlen($os) > 0 && in_array($login_fabrica, array(156)) AND !empty($login_unico) AND $login_unico_master != "t") {
        $sql = "SELECT os FROM tbl_os WHERE os = {$os} AND tecnico = {$login_unico_tecnico}";
        $res = pg_query($con,$sql);

        if(pg_num_rows($res) == 0){

            echo "<br> <div class='alert alert-info' >
                    <b>".strtoupper(traduz("esta.ordem.de.servico.pertence.a.outro.tecnico"))."</b>
                </div>";

            include __DIR__.'/rodape.php';
            exit;
        }
    }
}
// 'nome' único de arquivo para trabalhar com anexos
if ($login_fabrica != 35) {
    if (!strlen(getValue("anexo_chave"))) {
        $anexo_chave = sha1(date("Ymdhi")."{$login_fabrica}".(($areaAdmin === true) ? $login_admin : $login_posto));
    } else {
        $anexo_chave = getValue("anexo_chave");
}
}
// Valida de é uma OSKof para a Imbera
if ($login_fabrica == 158) {
    if (!empty($hd_chamado)) {
        $sqlClienteAdmin = "SELECT tbl_cliente_admin.codigo FROM tbl_hd_chamado JOIN tbl_cliente_admin USING(cliente_admin,fabrica) WHERE tbl_hd_chamado.hd_chamado = {$hd_chamado} AND tbl_hd_chamado.fabrica = {$login_fabrica};";
        $resClienteAdmin = pg_query($con, $sqlClienteAdmin);

        $codigoKof = pg_fetch_result($resClienteAdmin, 0, codigo);

    }

}

if($login_fabrica == 52) {
	$consumidor_pais = getValue('consumidor[pais]');
}

$plugins = array(
   "datepicker",
   "shadowbox",
   "maskedinput",
   "alphanumeric",
   "ajaxform",
   "fancyzoom",
   "price_format",
   "tooltip",
   "select2",
   "leaflet",
   "font_awesome",
   "autocomplete"
);

include __DIR__.'/admin/plugin_loader.php';

/**
 * Função para contar a quantidade de peças caso dê algum erro na tela ou já tenha peças gravadas
 */
function verifica_quantidade_pecas($array, $tipo_atendimento) {

    $qtde       = (int) count($array);
    $qtde_usada = 0;

    if(!empty($tipo_atendimento)){
        if(in_array($tipo_atendimento, array(227))){
            foreach ($array as $key => $value) {
                if(is_numeric($value["id"])){
                    $qtde_usada++;
                }
            }
            return ($qtde_usada == 0) ? 3 : $qtde_usada;
        }
    }

    foreach ($array as $key => $value) {
        if (strlen($value["id"]) > 0) {
            $qtde_usada++;
        }
    }

    $qtde = $qtde_usada + 1;

    return $qtde;
}
/*

function verifica_tipo_posto($posto, $param) {
    global $con, $login_fabrica;

    $sql = "SELECT tbl_tipo_posto.{$param}
            FROM tbl_posto_fabrica
            INNER JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto AND tbl_tipo_posto.fabrica = {$login_fabrica}
            WHERE tbl_posto_fabrica.fabrica = {$login_fabrica}
            AND tbl_posto_fabrica.posto = {$posto}";
    $res = pg_query($con, $sql);

    if (pg_num_rows($res) > 0) {
        return (pg_fetch_result($res, 0, 0) == "t") ? true : false;
    } else {
        return false;
    }
}
*/
function verifica_pecas_lancadas($os){ //hd_chamado=2813100
    global $con, $login_fabrica;

    $res_finalizada = pg_query($con, "SELECT os FROM tbl_os WHERE os = $os AND finalizada IS NOT NULL");

    if (pg_num_rows($res_finalizada) > 0) {
        return false;
    }

    if ($login_fabrica == 178){
        $sql = "SELECT tbl_produto.troca_obrigatoria 
                FROM tbl_os JOIN tbl_produto ON tbl_produto.produto = tbl_os.produto
                AND tbl_os.os = {$os} AND tbl_produto.fabrica_i = {$login_fabrica}";
        $res = pg_query($con, $sql);

        $troca_obrigatoria = pg_fetch_result($res, 0, 'troca_obrigatoria');

        if ($troca_obrigatoria == "t"){
            return false;
        }
    }

    $sql = "SELECT COUNT(*) AS qtde
            FROM tbl_os_item
            INNER JOIN tbl_os_produto ON tbl_os_produto.os_produto = tbl_os_item.os_produto
            WHERE tbl_os_produto.os = $os";
    $res = pg_query($con, $sql);

    $qtde_pecas = (int) pg_fetch_result($res, 0, "qtde");

    if ($qtde_pecas > 0) {
        return false;
    } else {
        return true;
    }
}

function verifica_pedido_gerado($os) {
    global $con, $login_fabrica;

    $sql = "SELECT tbl_os_item.pedido_item
            FROM tbl_os_item
            JOIN tbl_os_produto ON tbl_os_produto.os_produto = tbl_os_item.os_produto
            AND tbl_os_produto.os = {$os}
            WHERE tbl_os_produto.os = {$os}
            AND tbl_os_item.fabrica_i = {$login_fabrica}
            AND tbl_os_item.pedido_item IS NOT NULL";
    $res = pg_query($con, $sql);

    if (pg_num_rows($res) > 0) {
        return true;
    } else {
        return false;
    }

}

function verifica_defeito_lancado($os){
    global $con, $login_fabrica, $defeitoConstatadoMultiplo;

    if ($defeitoConstatadoMultiplo){
        $res_defeito_constatado = pg_query($con, "SELECT defeito_constatado FROM tbl_os_defeito_reclamado_constatado WHERE os = $os AND defeito_constatado IS NOT NULL");
    }else{
        $res_defeito_constatado = pg_query($con, "SELECT defeito_constatado FROM tbl_os_produto WHERE os = $os AND defeito_constatado IS NOT NULL");
    }

    if (pg_num_rows($res_defeito_constatado) > 0) {
        return true;
    }else{
        return false;
    }
}

function verifica_os_item($os_item) {

    global $con, $login_fabrica;

    if(strlen(trim($os_item)) > 0){ //HD-3554595
        $sql = "SELECT tbl_os_item.os_item
                FROM tbl_os_item
                INNER JOIN tbl_servico_realizado ON tbl_servico_realizado.servico_realizado = tbl_os_item.servico_realizado AND tbl_servico_realizado.fabrica = {$login_fabrica}
                WHERE tbl_os_item.os_item = {$os_item}
                AND tbl_os_item.pedido IS NULL
                AND UPPER(tbl_servico_realizado.descricao) NOT IN('CANCELADO', 'TROCA PRODUTO')";
        $res = pg_query($con, $sql);
        if (pg_num_rows($res) > 0) {
            return false;
        } else {
            return true;
        }
    }else{
        return true;
    }

    // $sql = "SELECT tbl_os_item.os_item
    //         FROM tbl_os_item
    //         INNER JOIN tbl_servico_realizado ON tbl_servico_realizado.servico_realizado = tbl_os_item.servico_realizado AND tbl_servico_realizado.fabrica = {$login_fabrica}
    //         WHERE tbl_os_item.os_item = {$os_item}
    //         AND tbl_os_item.pedido IS NULL
    //         AND UPPER(tbl_servico_realizado.descricao) NOT IN('CANCELADO', 'TROCA PRODUTO')";
    // $res = pg_query($con, $sql);
    // if (pg_num_rows($res) > 0) {
    //     return false;
    // } else {
    //     return true;
    // }
}


if (!in_array($login_fabrica, array(35,165))) {
    if (in_array($login_fabrica, [158, 174])) {
        $res_sr = get_servico_realizado(null, null, getValue("os[tipo_atendimento]"));
    } else if (in_array($login_fabrica, [161])) {
        $res_sr = get_servico_realizado(null, null, null, getValue("produto[id]"));
    } else {
        $res_sr = get_servico_realizado();
    }
}

if ($login_fabrica == 163) {
    $servico_troca_peca_estoque = '';
    foreach (pg_fetch_all($res_sr) as $valor_tp_at) {
        if($valor_tp_at["peca_estoque"] == 't'){
            $servico_troca_peca_estoque = $valor_tp_at["servico_realizado"];
        }
    }
}
//186

if (in_array($login_fabrica,array(161,167,177,186,190,191,195,203))) {

    if((strlen(trim($_RESULT["os"]["tipo_atendimento"])) > 0 AND strlen(trim($os)) > 0)) {

        $sqlAt = "SELECT tipo_atendimento FROM tbl_tipo_atendimento WHERE fabrica = {$login_fabrica} AND descricao ILIKE 'Orçamento'";
        $resAt = pg_query($con, $sqlAt);

        if (pg_num_rows($resAt) > 0) {
            $id_orcamento = pg_fetch_result($resAt, 0, 'tipo_atendimento');

        } else {
            $id_orcamento = 0;
        }
    }
}

if (in_array($login_fabrica,array(190)) && strlen(trim($os)) > 0) {
	$xxproduto = getValue("produto[id]");

        $sqlAt = "SELECT bosch_cfa FROM tbl_produto JOIN tbl_familia ON tbl_familia.familia = tbl_produto.familia AND tbl_familia.fabrica = $login_fabrica WHERE fabrica_i = {$login_fabrica} AND produto=".$xxproduto;
        $resAt = pg_query($con, $sqlAt);
        $limite_horas_trabalhadas = false;
        if (pg_num_rows($resAt) > 0) {
            $camposAdd = json_decode(pg_fetch_result($resAt, 0, 'bosch_cfa'),1);
	   if (isset($camposAdd['limite_horas_trabalhadas']) && $camposAdd['limite_horas_trabalhadas'] == true) {
		$limite_horas_trabalhadas = true;
	   }
        }

}

if ($login_fabrica == 143) {
    $servico_realizado = pg_fetch_result($res_sr, 0, "servico_realizado");
}

if ($login_fabrica == 35) {//hd-3919692
    $servico_realizado = 571;
}

if ($login_fabrica == 151) {

    if (strlen(getValue("posto[id]")) > 0) {

        $posto_id = getValue("posto[id]");

        $sql_controla_estoque = "SELECT controla_estoque FROM tbl_posto_fabrica WHERE fabrica = {$login_fabrica} AND posto = {$posto_id}";
        $res_controla_estoque = pg_query($con, $sql_controla_estoque);

        $posto_controla_estoque = (pg_fetch_result($res_controla_estoque, 0, "controla_estoque") == "t") ? true : false;

    }

    if(pg_num_rows($res_sr) > 0){

        $servicos_usa_estoque = array();
        $servicos_sem_estoque = array();

        for ($i = 0; $i < pg_num_rows($res_sr); $i++) {

            $servico       = pg_fetch_result($res_sr, $i, "servico_realizado");
            $descricao     = pg_fetch_result($res_sr, $i, "descricao");
            $peca_estoque  = pg_fetch_result($res_sr, $i, "peca_estoque");
            $troca_de_peca = pg_fetch_result($res_sr, $i, "troca_de_peca");
            $gera_pedido   = pg_fetch_result($res_sr, $i, "gera_pedido");

            $dados_servico = array(
                "servico"       => $servico,
                "descricao"     => $descricao,
                "gera_pedido"   => $gera_pedido,
                "peca_estoque"  => $peca_estoque,
                "troca_de_peca" => $troca_de_peca
            );

            $servicos_usa_estoque[] = $dados_servico;

            if($peca_estoque != "t"){
                $servicos_sem_estoque[] = $dados_servico;
            }
        }
    }
}

$height_km = "390px";

if ($login_fabrica == 143) {
    $height_km = "auto";
}

if (in_array($login_fabrica, array(152,180,181,182))) {
    $height_km = "450px";
}

if ($login_fabrica == 52) {
    $regras["produto|serie"]["obrigatorio"] = true;
    
    if (count($_POST) > 0 && strlen($_POST["produto[serie"]) == 0) {
        $msg_erro['campos'][] = "produto[serie]";
    } else {
        unset($msg_erro['campos']["produto[serie]"]);
    }
}

///////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////

function renderizarHtml($fabrica, $os) {
    $pais = getPaisDaFabrica($fabrica);
    $estadoConsumidor = getEstadoDoConsumidor($os);
    $listaDeEstadosDoPais = getListaDeEstadosDoPais($pais);

    $tmpHtml = "<option value=''>  </option>";
    foreach( $listaDeEstadosDoPais as $estado ){
        $tmpHtml .= "<option value='{$estado['sigla']}'> {$estado['descricao']} </option>";
    }

    if( $pais != 'BR' ){
        $html = "<optgroup label='Provincias'> {{options}} </optgroup>";
    }else{
        $html = "<optgroup label='Estados'> {{options}} </optgroup>";
    }
    
    return str_replace('{{options}}', $tmpHtml, $html);
}
function getPaisDoPosto($paisposto) {
    global $con;    

    $pgResource = pg_query($con, "SELECT pais FROM tbl_posto WHERE posto = {$paisposto}");    
	return pg_fetch_assoc($pgResource)['pais'] ?? 'BR';
}

?>

<style type="text/css">

    .div_valor_adicional:nth-child(4n + 1) {
        margin-left: 0px !important;
    }

    #div_trocar_posto, #div_trocar_produto, #div_trocar_subproduto {
        display: none;
        height: 40px;
    }

    .div_env{
        display: block !important;
        width: 100% !important;
    }

    #div_informacoes_subproduto, #modelo_peca, #modelo_subproduto_peca, #div_subproduto_pecas, #div_os_garantia, #div_peca_anexo, #div_peca_anexo_subproduto, #div_visita, #div_produto_retirado, #consumidor_qtd_andar {
        display: none;
    }

    #div_informacoes_deslocamento > div.tc_formulario {
        height: <?=$height_km?>;
    }

    #google_maps {
        width: 90%;
        float: left;
        z-index: 1;
    }

    /*#google_maps_direction {
        width: 39%;
        float: left;
        overflow: auto;
        background-color: #FFF;
        padding-bottom: 9px;
    }*/

    #google_maps/*, #google_maps_direction*/ {
        height: 400px;
    }

    #google_maps img {
        max-width: none;
    }

    a.mapa-rota-google {
        display: inline-block;
        margin: 0 auto;
        text-align: center;
        padding-top: 15px;
        padding-bottom: 10px;
    }

    #div_informacoes_deslocamento > div.tc_formulario {
        height: auto;
    }

    .div_env{
        width: 100% !important;
        display: block !important;
        float: left !important;
        width: 100% !important;
        min-height: 30px !important;
        margin-left: 6.12766% !important;
        -webkit-box-sizing: border-box !important;
        -moz-box-sizing: border-box !important;
        box-sizing: border-box !important;
    }

    <?php if ($login_fabrica == 148 or $login_fabrica == 161) { ?>
        .tc_formulario, input[type=submit], div.div_regra_revisao, #os_form_submit {
            display: none;
        }

        #div_informacoes_produto_venda, #div_informacoes_posto {
            display: block;
        }
    <?php } ?>

    <?php
    if ($login_fabrica == 163) {
    ?>
        button.laudo-tecnico {
            display: none;
        }
    <?php
    }

    if ($login_fabrica == 161) {
    ?>
    #venda_numero_serie {
        text-transform: uppercase;
    }
    <?php
    }

    if ($login_fabrica == 173) {
    ?>
        #div_observacoes_pecas {
            display: none;
        }
    <?php
    }
    if (in_array($login_fabrica, [167, 203])) { ?>
        #produto_serie {
            text-transform: uppercase;
        }
    <?php
    }
    ?>
</style>

<!-- <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&async=2&language=pt-br&key=AIzaSyC5AsH3NU-IwraXqLAa1qbXxyjklSVP-cQ"></script>
<script src="plugins/markermanager.js" ></script> -->
<script type="text/javascript">

/** 
 * Ordena json pelo valor 
 */
 
function sortByValue(jsObj) {
    
    var sortedArray = [];

    for(var i in jsObj) {

        sortedArray.push([jsObj[i], i]);
    }

    return sortedArray.sort();
}

    <?php if($login_fabrica == 35) {?>
        /*
        * Função para Limpar Movimentação Estoque Cadence
        *
        */
        function limpaMovimentacaoEstoque(n){
            var os                      = '<?=$os?>';
            var servico                 = $('#servicos_peca_'+n).val();
            var limpa_movimento_estoque2 = "ok";
            var qtde                    = $('#qtde_'+n).val();
            var referencia              = $('#codigo_referencia_'+n).val();
            var os_item                 = $('#peca_os_item_'+n).val();

            $.ajax({
                url: '<?php echo $_SERVER[PHP_SELF]; ?>',
                type: 'POST',
                data: {
                    limpa_movimento_estoque2 : limpa_movimento_estoque2,
                    os                      : os,
                    servico                 : servico,
                    qtde                    : qtde,
                    referencia              : referencia,
                    os_item                 : os_item
                },
                complete: function(data){
                   //alert('Quantidade alterada, necessário gravar O.S');
                }
            });
        }
    <?php }

if($login_fabrica == 165) {?>
/*inicio funções da fabrica 165*/
function troca_obrigatorio()
{
    var  os_consumidor_revenda = $("#os_consumidor_revenda").val();
    if(os_consumidor_revenda == 'C'){
        $("#consumidor_nome, #consumidor_cpf, #consumidor_cep, #consumidor_estado, #consumidor_cidade, #consumidor_bairro, #consumidor_endereco, #consumidor_numero, #consumidor_celular, #consumidor_email").attr('data-obrigatorio', 1);
        obrigatorio_consumidor();
    }
}

function obrigatorio_revenda(){
    var tipo_posto = $("#tipo_posto").val();
    if(tipo_posto == 'false' || tipo_posto=='f'){
        $("#div_anexo_produto_nf").show();
        $("#div_informacoes_consumidor input, #div_informacoes_consumidor select").each(function() {
            $(this).prevAll("h5").remove();
            $("#div_informacoes_consumidor .control-group").removeClass('error');
        });
        $("#div_informacoes_revenda input, #div_informacoes_revenda select").each(function() {
            if ($(this).data("obrigatorio") == 1) {
                if ($(this).prevAll("h5").length == 0) {
                    $(this).before("<h5 class='asteristico'>*</h5>");
                }
            }
        });
    }
}

function obrigatorio_consumidor(){
    var tipo_posto = $("#tipo_posto").val();
    if(tipo_posto == 'false' || tipo_posto=='f'){
        $("#consumidor_nome, #consumidor_cpf, #consumidor_cep, #consumidor_estado, #consumidor_cidade, #consumidor_bairro, #consumidor_endereco, #consumidor_numero, #consumidor_celular, #consumidor_email").attr('data-obrigatorio', 1);

        $("#div_anexo_produto_nf").hide();
        $("#div_informacoes_consumidor input, #div_informacoes_consumidor select").each(function() {
            if ($(this).data("obrigatorio") == 1) {
                if ($(this).prevAll("h5").length == 0) {
                    $(this).before("<h5 class='asteristico'>*</h5>");
                }
            }
        });

        $("#div_informacoes_revenda input, #div_informacoes_revenda select").each(function() {
            if ($(this).data("consumidor-obrigatorio") != 1) {
                $(this).prevAll("h5").remove();
                $("#div_informacoes_revenda .control-group").removeClass('error');
            }
        });
    }

}

/*fim funções da fabrica 165*/
<?php
}
?>

function verificaEstoqueRoca(){

    let referencia = $("#produto_referencia").val();
    let posto = $("#posto_id").val();
    
    $.ajax({
        url: "cadastro_os.php",
        type: "POST",
        dataType:"JSON",
        data: {ajax_estoque_roca: true, referencia: referencia, posto: posto}
    }).done(function(data){
        if(data.qtde > 0){
            alert("Identificamos que existe uma unidade do produto "+referencia+" em seu estoque. Solicitamos que aguarde a análise da fábrica.");
        }
    });
}

function verifica_estoque(i, excluir) {

    var posto   = $("#posto_id").val();
    var qtde    =  $("input[name='produto_pecas["+i+"][qtde]']").val();
    var peca    =  $("input[name='produto_pecas["+i+"][id]").val();
    var os      = '<?=$_REQUEST["os_id"]?>';
    var excluir = excluir;

    $.ajax({
        async: false,
        url: "cadastro_os.php",
        type: "post",
        data: { ajax: true, ajax_verifica_estoque: true, peca: peca, posto: posto, qtde:qtde, os:os, excluir: excluir }
    });
}

function informaNumeroSerieAceitos(id_produto, login_fabrica){

     $.ajax({
        type: "POST",
        url: "cadastro_os.php",
        cache:false,
        dataType:"JSON",
        data: {ajax_busca_mascaras_produto:true, produto: id_produto, fabrica:login_fabrica},
        success: function(response){

            if(response){
                var info = $("#info_po");
                var currentTitle = info.attr('title');
                var title = currentTitle + "\nPara o produto selecionado, segue abaixo os padrões de Número de Série que são aceitos:\n";
                var mascaras = "";

                $.each(response, function (key, item) {
                    mascaras += item.mascara + "\n";
                });

               info.attr("title", title + mascaras);
            }
            
        },
        error: function (xhr, ajaxOptions, thrownError) {
            console.log(xhr.status);
            console.log(thrownError);
        }
    });
}
 <?php if($login_fabrica == 35) :?>

 $(document).ready(function() {
    var produto = $('#produto_id').val();
    if(produto != ''){
        informaNumeroSerieAceitos(produto, 35);
    }
})
 <?php endif; ?>


function carregaDadosNumeroSerie(numero_serie,produto_referencia){

    if ((!numero_serie) || (!produto_referencia)) {
        return false;
    }

    $.ajax({
        url: '<?= $_SERVER["PHP_SELF"]; ?>',
        type: "POST",
        dataType:"JSON",
        data: {
            ajax: true,
            dados_numero_serie: true,
            numero_serie : numero_serie,
            produto_referencia : produto_referencia
        },
        beforeSend: function(){
            $('.loading').html("<br /><img src='imagens/loading_img.gif' style='height: 27px; margin-top: 2px;' />");
        }
    }).done(function(data) {
        $('.loading').html("");
        if (data.status == true) {
            $("#data_fabricacao").val(data.data_fabricacao).prop({"readonly":true});
            $("#data_venda").val(data.data_venda).prop({"readonly":true});
        } else {
            alert(data.msg_erro);
        }
    });

}
<?php
/**
 * Variável usada para fazer as regras das revisões
 */
if ($login_fabrica == 148) {
?>
    var revisoes;
    var servicos_ajax = {};
    var pecas_ajax = {};
    var confirm_alterar_posto = false;

    function buscaPecasAjax(pecasArray) {
        if (pecasArray.length > 0) {
            $.ajax({
                async: false,
                url: "cadastro_os.php",
                type: "post",
                dataType: "JSON",
                data: { ajax: true, ajax_pecas: true, pecas: pecasArray }
            })
            .done(function(data) {
                if (typeof data.pecas != "undefined") {
                    $.each(data.pecas, function(id, descricao) {
                        pecas_ajax[id] = descricao;
                    });
                }
            });
        }
    }
<?php
    while ($servico_realizado_ajax = pg_fetch_object($res_sr)) {
?>
        servicos_ajax["<?=$servico_realizado_ajax->servico_realizado?>"] = "<?=$servico_realizado_ajax->descricao?>";
<?php
    }

    pg_result_seek($res_sr, 0);

    $produto_revisao = getValue("produto[id]");

    if (strlen($produto_revisao) > 0) {
        $sqlRevisao = "SELECT valores_adicionais FROM tbl_produto WHERE fabrica_i = {$login_fabrica} AND produto = {$produto_revisao}";
        $resRevisao = pg_query($con, $sqlRevisao);

        $valores_adicionais = pg_fetch_result($resRevisao, 0, "valores_adicionais");
?>
        var json_revisoes = '<?=$valores_adicionais?>';

        if (json_revisoes.length > 0) {
            revisoes = JSON.parse('<?=$valores_adicionais?>');
            revisoes = revisoes.revisao;

            var pecasArray = [];

            if (typeof revisoes.primeira.pecas != "undefined") {
                pecasArray = pecasArray.concat(revisoes.primeira.pecas);
            }

            if (typeof revisoes.intervalo.pecas != "undefined") {
                pecasArray = pecasArray.concat(revisoes.intervalo.pecas);
            }

            if (typeof revisoes.excecao != "undefined") {
                $.each(revisoes.excecao, function(horas, excecao_object) {
                    if (excecao_object.pecas.length > 0) {
                        pecasArray = pecasArray.concat(excecao_object.pecas);
                    }
                });
            }

            buscaPecasAjax(pecasArray);
        }
<?php
    }
}

if ($defeito_constatado_obriga_lancar_peca == true || in_array($login_fabrica, array(162))) {
?>

    function peca_obrigatoria_defeito_constatado(hide_none) {
        <? if (!isset($defeitoConstatadoMultiplo)) { ?>
            if (hide_none == true) {
                $("#lancar_peca_obrigatorio").show();
            } else {
                $("#lancar_peca_obrigatorio").hide();
            }
        <? } else { ?>
            var linhas_defeitos = $(".box-defeitos > tbody").find('tr');
            var obriga_peca = 'f';

            $(linhas_defeitos).each(function() {
                if ($(this).attr("lancarpeca") == 't') {
                    obriga_peca = 't';
                }
            });

            if (obriga_peca == 't') {
                $("#lancar_peca_obrigatorio").show();
            } else {
                $("#lancar_peca_obrigatorio").hide();
            }

        <? } ?>
    }

<? } ?>

/**
 * Variavel global usada para armazenar os defeitos constatados do produto
 */
var defeito_constatado_json = [];
var defeitos_selecionados = [];

/**
 * Variaveis do google maps
 */
var lista_enderecos;
var geocoder;

<?php if($login_fabrica == 156 or in_array($login_fabrica, [167, 203])){ //HD-3041214 ?>
    function calc_totalxx (){
        var count = 0;
        $("div[name^=peca_]").each(function(){
            var cont = count++;
            var campo_qtde = $("input[name='produto_pecas["+cont+"][qtde]']");
            campo_qtde.each(function(){
                if(campo_qtde.val().length > 0){
                    $(this).blur();
                }
            });
        });
    }
<?php
}
if($login_fabrica == 35 AND strlen($_GET['preos']) > 0){
?>
    function verificaDeslocamentoProdutoPreOS(){
    	var hd_chamado = "<?=$_GET['preos']?>";

	$.ajax({
                url : "<?php echo $_SERVER['PHP_SELF']; ?>",
                type: "POST",
                dataType : "application/json",
                data: { ajax: true, verificaDeslocamentoProdutoPreOs : 1, hd_chamado:hd_chamado },
                complete: function(retorno){
		    retorno = JSON.parse(retorno.responseText);
                    if(retorno.resposta == "sim" && retorno.deslocamento == "t"){
                            $(".grupo_tipo_atendimento").show();
                    }
                }
            });
    }
<?php
}

if ($login_fabrica == 163) {
?>
    var servico_troca_peca_estoque = '<?=$servico_troca_peca_estoque?>';
<?php
}
?>

$(function() {
    var pLat;
    var pLng;

    var cLat;
    var cLng;

    var geometry;
    <? if (!in_array($login_fabrica, array(143))) { ?>
    if (typeof Map !== "object") {
        Map      = new Map("google_maps");
        Markers  = new Markers(Map);
        Router   = new Router(Map);
        Geocoder = new Geocoder();
    }

    <?php if (in_array($login_fabrica, array(169,170)) AND $abre_os_dealer == 't' AND $areaAdmin === false){ ?>
        $("#div_informacoes_deslocamento").show();
    <?php }else{ ?>
        $("#div_informacoes_deslocamento").hide();
    <?php } ?>

    $("#google_maps").hide();

    $("#ver-mapa").on("click", function() {
        if ($(this).is(":checked")) {
            $("#google_maps").show();
            if ($("#google_maps").html() == '') {
                mostraMapa();
            }
        } else {
            $("#google_maps").hide();
        }
    });
    <?php } 

    if (in_array($login_fabrica, [177])) { ?>

        if ($("#produto_lote_hidden").val()) {

        }

    <?php
    }
    ?>
    //Vefificar se possui anexo, para liberar lançamento de peças
    <?php if (in_array($login_fabrica, [160])) { ?>
            var id_tem_os = '<?=$os?>';

            if (id_tem_os == "" || id_tem_os == undefined) {
                $("#produto_pecas").hide();
                $("#div_mensagem_termo").show();
            } else {
                ja_anexou(id_tem_os);
            }

    <?php } ?>

    <?php if (in_array($login_fabrica, array(169,170)) AND $abre_os_dealer == 't' AND empty($os) AND !$areaAdmin){ ?>
        var login_nome                  = '<?=$login_nome?>';
        var login_cnpj                  = '<?=$login_cnpj?>';
        var login_cep                   = '<?=$login_cep?>';
        var login_contato_estado        = '<?=$login_contato_estado?>';
        var login_contato_cidade        = '<?=$login_contato_cidade?>';
        var login_contato_bairro        = '<?=$login_contato_bairro?>';
        var login_contato_endereco      = '<?=$login_contato_endereco?>';
        var login_contato_numero        = '<?=$login_contato_numero?>';
        var login_contato_complemento   = '<?=$login_contato_complemento?>';
        var login_telefone              = '<?=$login_telefone?>';

        $("#revenda_nome").val(login_nome);
        $("#revenda_cnpj").val(login_cnpj);
        $("#revenda_cep").val(login_cep);
        $("#revenda_estado").val(login_contato_estado);
        setTimeout(function(){
            $('#revenda_estado').trigger('change');
            $("#revenda_cidade").val(login_contato_cidade);
        },100);
        $("#revenda_bairro").val(login_contato_bairro);
        $("#revenda_endereco").val(login_contato_endereco);
        $("#revenda_numero").val(login_contato_numero);
        $("#revenda_complemento").val(login_contato_complemento);
        $("#revenda_telefone").val(login_telefone);
    <?php } ?>


    <?php
    if(in_array($login_fabrica, [35,167,203])){?>
        
        $(document).on("click", ".btn-cancela-motivo", function(){
            var posicao = $("#posicao_solicitacao").val();
            $("#codigo_referencia_"+posicao).val("");
            $("#qtde_"+posicao).val("");
            $(".produto_peca_descricao_"+posicao).val("");
            $("#peca_duplicada").val("");
            $("#peca_duplicada_item").val("");
            $("#motivo_solicitacao").val("");
            $("#peca_extraviada").removeAttr('checked');
            $("#posicao_solicitacao").val("");
            $("#msg_motivo").html('');
            $("#msg_motivo").removeClass('alert');
            $("#msg_motivo").removeClass('alert-danger');
            $("#msg_motivo").removeClass('alert-success');

        });
        
        $(document).on("click", ".btn-grava-motivo-solicitacao-peca", function(){
           
            $("#msg_motivo").html('');
            $("#msg_motivo").removeClass('alert');
            $("#msg_motivo").removeClass('alert-danger');
            $("#msg_motivo").removeClass('alert-success');

            var posicao = $("#posicao_solicitacao").val();
            var peca_duplicada = $("#peca_duplicada").val();
            var peca_duplicada_item = $("#peca_duplicada_item").val();
            var motivo_solicitacao = $("#motivo_solicitacao").val();
            var peca_extraviada = $("#peca_extraviada").is(':checked');
            
            if (motivo_solicitacao == '') {
                alert("Digite o motivo da solicitação");
                $("#motivo_solicitacao").focus();
                return false;
            } else {
                $.ajax({
                    url: window.location,
                    method: 'POST',
                    dataType:"JSON",
                    data: {
                        ajax_grava_motivo_duplica: true,
                        dados: {
                                posicao:posicao, 
                                peca_duplicada:peca_duplicada, 
                                peca_duplicada_item:peca_duplicada_item,
                                motivo_solicitacao:motivo_solicitacao, 
                                peca_extraviada: (peca_extraviada) ? true : false
                            }
                    }
                }).fail(function(){
                    
                }).done(function(data){

                   if (data.erro) {
                        $("#msg_motivo").addClass('alert');
                        $("#msg_motivo").addClass('alert-danger');
                        $("#msg_motivo").html(data.msg);
                    } else {

                        if (data.peca_duplicada) {
                            $("#motivo_segunda_peca_"+posicao).val(data.peca_duplicada);
                            $("#motivo_segunda_motivo_"+posicao).val(data.motivo_solicitacao);
                            $("#motivo_segunda_extraviada_"+posicao).val(data.peca_extraviada);
                        }

                        $("#msg_motivo").addClass('alert');
                        $("#msg_motivo").addClass('alert-success');
                        $("#msg_motivo").html(data.msg);

                        $(".modal-motivo-peca-duplicada").modal('hide');
                        $("#motivo_solicitacao").val("");
                        $("#peca_extraviada").removeAttr('checked');
                        $("#posicao_solicitacao").val("");
                        $("#msg_motivo").html('');
                        $("#msg_motivo").removeClass('alert');
                        $("#msg_motivo").removeClass('alert-danger');
                        $("#msg_motivo").removeClass('alert-success');


                    }

                });
            }

        });

        if ($('#consumidor_cpf').val() == '') {
           <?php 
            if (!in_array($login_fabrica,[180, 181, 182])) {
	   ?>
		$("#consumidor_cpf").mask("999.999.999-99");
	   <?php
	    }
	   ?>
        }

        $(".po_pecas").mask("99999-999");
    <?php
    } ?>

    <?php
        if ($login_fabrica == 176){
            if (empty($_REQUEST["os_id"]) AND count($msg_erro["msg"]) == 0){
    ?>
                $("#tipo_atendimento").val( $('option:contains("Garantia")').val() );
    <?php
            }
    ?>
            var tipo_atendimento = $("#tipo_atendimento > option:selected").text();
            if (tipo_atendimento == "Garantia") {
                $("#anexo_obrig").text('<?php echo traduz("anexar.uma.copia.da.nf.e.da.etiqueta.do.produto");?>');
            }
    <?php
        }
    ?>

    <?php if ($login_fabrica == 175){ ?>
        validaPecaAtendimento();

        $("#produto_serie").blur(function(){
            var tipo_atendimento_t = $('#tipo_atendimento option:selected').text();

            if (tipo_atendimento_t == 'Fora de Garantia'){
                return false;
            }

            var produto = $("#produto_id").val();
            var serie = $(this).val();
            var data_abertura = $("#data_abertura").val();
            var tem_pecas = "";

            if (tipo_atendimento_t == '' || tipo_atendimento_t == undefined){
                alert("Selecione o tipo de atendimento para continuar");
                $("#produto_serie").val("");
                return false;
            }

            if (data_abertura == '' || data_abertura == undefined){
                alert("Preencha a data de abertura para continuar");
                $("#produto_serie").val("");
                return false;
            }

            if (produto != '' && produto != undefined && serie != '' && serie != undefined && data_abertura != '' && data_abertura != undefined){
                $.ajax({
                    url: window.location.href,
                    type: "post",
                    data: {
                        ajax: "sim",
                        acao: "valida_data_venda",
                        produto: produto,
                        serie: serie,
                        data_abertura: data_abertura
                    }
                }).done(function(data){
                    data = JSON.parse(data);
                    if (data.ok != "" && data.ok != undefined && data.ok == "fora_garantia"){
                        $("#produto_serie").data('serie-venda', data.data_venda);
                        verifica_garantia_produto();
                        alert("Produto fora da garantia, informe a nota fiscal, data da nota fiscal e anexe uma foto da nota fiscal");
                        
                        if ($("#nota_fiscal, #data_compra").prevAll("h5").length == 0) {
                            $("#nota_fiscal, #data_compra").attr("data-obrigatorio", 1);
                            $("#nota_fiscal, #data_compra").before("<h5 class='asteristico'>*</h5>");
                            $("#anexo_obrig").show();
                        }
                    }else if (data.ok != "" && data.ok != undefined && data.ok == "erro_serie"){
                        $("#produto_serie").data('serie-venda', '');
                        verifica_garantia_produto();
                        alert("Número de série não cadastrado para o produto");
                        $("#produto_serie").val("");
                    }
                });
            }

            if (produto != '' && produto != undefined && serie != '' && serie != undefined){
                busca_vista_explodida(produto, false, serie);
            }
        });
    <?php } ?>
    <? if ($login_fabrica == 171) { ?>

        $("#os_qtde_visita").numeric();

        function obrigatorio_qtde_visitas(){
            if ($("#os_qtde_visita").data("obrigatorio") == 1) {
                $("#os_qtde_visita").attr("data-obrigatorio","");
                if ($("#os_qtde_visita").prevAll("h5").length == 0) {
                    $("#os_qtde_visita").before("<h5 class='asteristico'>*</h5>");
                }
            } else {
                $("#os_qtde_visita").attr("data-obrigatorio",1);
                if ($("#os_qtde_visita").prevAll("h5").length == 0) {
                    $("#os_qtde_visita").before("<h5 class='asteristico'>*</h5>");
                }
            }
        }

        function tipo_atendimento(tipoatendimento){
            if (tipoatendimento == 'Fora de Garantia') {
                $("#data_compra").prev().hide();
            } else if (tipoatendimento == 'Garantia com Deslocamento'){
                obrigatorio_qtde_visitas()
                $("#data_compra").prev().show();
            } else {
                $("#data_compra").prev().show();
            }
        }

        function consumidor_edificio(){
            var check_edificio = $('#consumidor_edificio').is(':checked');

            if(check_edificio){
                $('#consumidor_qtd_andar').show();
            }else{
                $('#consumidor_qtd_andar').hide();
            }
        }

        tipo_atendimento($('#tipo_atendimento option:selected').text());

        $('#tipo_atendimento').change(function(){
            tipo_atendimento($('#tipo_atendimento option:selected').text());
        });
        
        consumidor_edificio($('#consumidor_edificio').is(':checked'));
        $('#consumidor_edificio').change(function(){
            consumidor_edificio();
        });

    <? } ?>

    <?php if ($login_fabrica == 161 and ($areaAdmin == true or strlen(getValue('produto[serie]'))> 0)): ?>
    $("#produto_sem_serie").hide();
    <?php endif ?>
    <?php
    if($login_fabrica == 173){
    ?>
        verificaDcPosicaoPeca();
    <?php
    }
    ?>
    <? if ($login_fabrica == 148) { 

    ?>
        function tipo_atendimento_yanmar_outro(){
            if($("input[name=outros]").is(':checked')){
                $('.tc_formulario[id!=div_peca_anexo]').show();
                $('input[type="submit"]').show();
                $("#os_form_submit").show();
                $(".cidade_exterior").hide();
                $(".estado_ex").hide();
                $(".tc_formulario input").each(function(){
                    $(this).prop({"readonly" : false});
                });

                $("#div_defeito_reclamado .asteristico").hide();
                $(".data_compra .asteristico").hide();
                $(".nota_fiscal .asteristico").hide();


                $("#produto_voltagem").prop({"readonly" : true});
                //$("#tipo_atendimento").find('option').remove().end().append("<option value='76977'>Outros</option>").val(76977);
                $("#tipo_atendimento").find('option').attr('disabled','disabled');
                $("#tipo_atendimento").append("<option value='76977'>Outros</option>").val(76977);
            } else {
                $(".alterar_produto_venda").trigger('click');
                $("#tipo_atendimento option[value='76977']").remove();
                $("#tipo_atendimento").find('option').prop( "disabled", false );
            }       
        }

		//$("input[name=outros]").attr("disabled",true);
        $('input[name=lib_peca_reposicao]').click(function(){
            if ($('input[name=lib_peca_reposicao]').is(':checked')) {
                $('input[name=peca_reposicao_disabled]').hide();
                $('select[name=peca_reposicao]').show();
                $('button[name=lista_basica]').show();
				$('.cidade_exterior').hide();
            }else{
                $('.alterar_produto_venda').trigger('click');
                if ($('select[name=peca_reposicao]').val() !== '') {
                    return false;
                }else{
                    $('input[name=peca_reposicao_disabled]').show();
                    $('select[name=peca_reposicao]').hide();
                    $('button[name=lista_basica]').hide();
                }
            }
        });

        var tipo_atendimento = <?=( !empty(getValue("os[tipo_atendimento]"))? getValue("os[tipo_atendimento]"): 'null' );?>;
        if(tipo_atendimento == 76977){
            tipo_atendimento_yanmar_outro();
        }	
		$('input[name=outros]').click(function(){
            tipo_atendimento_yanmar_outro()	
		});

        $('#tipo_atendimento').change(function(){
            var posto_id = $('#posto_id').val();
            if ($('#tipo_atendimento option:selected').text() == 'Revisão') {
                $.ajax({
                    url: "cadastro_os.php",
                    type: "post",
                    dataType:"JSON",
                    data: {
                        ajax: true,
                        ajax_servico_realizado: true,
                        posto: posto_id,
                        tipo_atendimento: true
                    }
                })
                .done(function(data) {

                    if (data.length > 0) {
                        $("#modelo_peca, #pecas_produto").find("select[name*=servico_realizado]").html("");

                        $.each(data, function(key, servico_realizado) {
                            $("#modelo_peca, #pecas_produto").find("select[name*=servico_realizado]").append("\
                                <option value='"+servico_realizado.servico_realizado+"' troca_de_peca='"+servico_realizado.troca_de_peca+"' gera_pedido='"+servico_realizado.gera_pedido+"' peca_estoque='"+servico_realizado.peca_estoque+"' >"+servico_realizado.descricao+"</option>\
                            ");
                        });
                    }
                });
            } else if(<?= $login_fabrica == 148 ?>){
                if($('#tipo_atendimento option:selected').text() == 'Garantia'){
                    $("#acessorios").before("<h5 id='acessorio_148' class='asteristico'>*</h5>");
                }else{
                    $("#acessorio_148").css("display", "none");
                }
            } else {
                verifica_servico_posto(posto_id);
            }
        });
    <?php
    }
    if($login_fabrica == 161 AND $posto_interno == 'f'){
?>
        $("#consumidor_email").before("<h5 class='asteristico'>*</h5>");
<?php
    }
    if ($login_fabrica == 163) {
?>
        if ($(this).find("option:selected").attr("fora_garantia") == "t") {
            $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                $(this).show();

            });

            $("div[id^=div_servicos_peca_]").each(function() {
                $(this).find('select').val(servico_troca_peca_estoque);
                $(this).hide();
            });

            $(".div_valor_total_pecas").show();
            calcula_valor_total_pecas(null, 'calcula_total');
        } else {
            $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                $(this).hide();
            });
            $("div[id^=div_servicos_peca_]").each(function() {
                $(this).show();

            });
            $(".div_valor_total_pecas").hide();
        }
<?php
    }

    if (in_array($login_fabrica, array(156,161,162,163,165))) {
?>

        if ($("#reparoNaFabrica").length == 0) {
            $("#produto_mostra_trocar").attr("style", $("#prod_s_ns").attr("style"));
        }

        $('#sem_ns').change(function () {

            if ($(this).is(':checked')) {

<?php
        if (in_array($login_fabrica,array(161))) {//fputti
?>
            bloqueia_revenda();

            $("#produto_referencia").attr("disabled", false);
            $("#produto_referencia").attr("readonly", false);
            $("#produto_referencia").next("span[rel=lupa_produto]").show();

            $("#produto_descricao").attr("disabled", false);
            $("#produto_descricao").attr("readonly", false);
            $("#produto_descricao").next("span[rel=lupa_produto]").show();
<?php
        }
        if (in_array($login_fabrica,array(156,161,165))) {
?>
            $("#produto_serie").attr("readonly", true);
            $("#produto_serie").val("");

<?php
            if ($login_fabrica == 165) {
?>
            $("#msg_fora_garantia").show();
<?php
            }
        } else if ($login_fabrica == 162) {
?>
            $("#partnumber").show();
<?php
        }
?>
            } else {
<?php
        if (in_array($login_fabrica,array(161))) {//fputti
?>
                bloqueia_revenda();
                $("#produto_referencia").val("");
                $("#produto_referencia").attr("readonly", true);
                $("#produto_referencia").next("span[rel=lupa_produto]").hide();

                $("#produto_descricao").val("");
                $("#produto_voltagem").val("");
                $("#produto_id").val("");
                $("#produto_descricao").attr("readonly", true);
                $("#produto_descricao").next("span[rel=lupa_produto]").hide();
<?php
        }

        if (in_array($login_fabrica,array(156,161,165))) {
?>
                $("#produto_serie").attr("readonly", false);
                $("#produto_serie").val("");

<?php
            if ($login_fabrica == 165) {
?>
                $("#msg_fora_garantia").hide();
<?php
            }
        } else if ($login_fabrica == 162) {
?>
                $("#partnumber_campo").val('');
                $("#partnumber").hide();
<?php
        }
?>
            }
        });

<?php
        if (in_array($login_fabrica, array(156,163))) {
?>
        calcula_valor_total_pecas(null, 'calcula_total');
            //hd_chamado=3041214
        if($('.alert-error > h4').html()){

            var count = 0;
            $("div[name^=peca_]").each(function(){
                var cont = count++;
                var campo_qtde = $("input[name='produto_pecas["+cont+"][qtde]']");
                campo_qtde.each(function(){
                    if(campo_qtde.val().length > 0){
                        $(this).blur();
                    }
                });
            });
        }
            //fim hd_chamado=3041214
<?php
        }

        if ($login_fabrica == 165) {
?>
        $("#cpf_cnpj").on("change",function(){
            $(".label-cpf").css("display","block");
        });

        $("#cnpj_cpf").on("change",function(){
            $(".label-cpf").css("display","none");
        });

<?php
        }
    }

    if($login_fabrica == 158){
?>
        $("#solucao").select2();
        $("#defeito_reclamado").select2();
<?php
    }

    if(in_array($login_fabrica, array(161,167,177,186,190,191,195,203)) && ($areaAdmin == true || $postoInterno == true)) {

?>
        calcula_valor_total_pecas(null, 'calcula_total');
<?php
    }

    if (in_array($login_fabrica, array(157))) {
        if (isset($_POST["os"]["tipo_atendimento"])) {
            $sql = "SELECT tipo_atendimento FROM tbl_tipo_atendimento WHERE fabrica = {$login_fabrica} AND tipo_atendimento = ".$_POST["os"]["tipo_atendimento"]." AND entrega_tecnica IS TRUE";
            $res = pg_query($con,$sql);

            if (pg_num_rows($res) > 0) {
?>
        $("input[name='os[defeito_reclamado]']").val("").attr("readOnly", true);
        $("#produto_defeito_constatado").val("").selectreadonly(true);
        $("#produto_pecas").hide();

        $("button[name=remove_peca]").click();
<?php
            }
        }
    }

    if (!in_array($login_fabrica, [35,151])) {
?>

        $("#os_form_submit").on("click", function(e) {
            e.preventDefault();

            var submit = $(this).data("submit");
            if (submit.length == 0) {
                $(this).data({ submit: true });
                $("input[name=gravar]").val('Gravar');
                $(this).parents("form").submit();
            } else {
                alert("<?php echo traduz("nao.clique.no.botao.voltar.do.navegador.utilize.somente.os.botoes.da.tela");?>");
            }
        });

<?php
    } else if (in_array($login_fabrica, [35])) { ?>

            $("#os_form_submit").on("click", function(e) {

                e.preventDefault();

                let numero_nf       = $("#nota_fiscal").val();
                let revenda_cnpj    = $("#revenda_cnpj").val();
                let produto_id      = $("#produto_id").val();
                let opcao           = $("#formulario_reincidencia_opcao").val();
                let justificativa   = $("#formulario_reincidencia_justificativa").val();

                if (opcao == "" && justificativa == "") {

                    $.ajax({
                        url: window.location,
                        method: 'POST',
                        dataType:"JSON",
                        data: {
                            ajax_verifica_reincidencia: true,
                            nota_fiscal: numero_nf,
                            cnpj_revenda: revenda_cnpj,
                            produto_id: produto_id,
                            os: '<?= $os ?>'
                        }
                    }).fail(function(){
                        
                        submit_form_os();

                    }).done(function(data){

                        if (data.reincidente) {

                            Shadowbox.open({
                                content: "formulario_reincidencia.php?os="+data.os_reincidente,
                                player: "iframe",
                                title: "OS Reincidente",
                                height: 1000,
                                width: 1300
                            });

                        } else {

                            submit_form_os();

                        }

                    });

                } else {

                    submit_form_os();

                }

            });

        $("#nota_fiscal, #revenda_cnpj, #produto_id").change(function(){

            $("#formulario_reincidencia_opcao").val("");
            $("#formulario_reincidencia_justificativa").val("");

        });
    <?php
    } else if (in_array($login_fabrica, [151])) { ?>

        $("#os_form_submit").on("click", function(e) {

            e.preventDefault();

            let data_compra       = $("#data_compra").val();
            let data_abertura     = $("#data_abertura").val();
            let produto_id        = $("#produto_id").val();

            if (data_compra.length > 0) {

                $.ajax({
                    url: window.location,
                    method: 'POST',
                    dataType:"JSON",
                    data: {
                        ajax_helpdesk_fora_garantia: true,
                        data_compra: data_compra,
                        data_abertura: data_abertura,
                        produto_id: produto_id,
                        os: '<?= $os ?>'
                    }
                }).fail(function(){

                    submit_form_os();

                }).done(function(data){

                    if (data.exibe_modal) {

                        Shadowbox.open({
                            content: '<div style="width: 100%;height: 100%; padding: 20px;background-color: #D9E2EF;"> \
                                        <h4><span style="color: red;font-weight: bolder;">O produto está fora de garantia, vencida na data de '+data.data_vencimento+'</span><br /><br />Deseja prosseguir com a abertura da ordem de serviço fora de garantia? Caso sim, será aberto um Helpdesk para aprovação do fabricante. \
                                        </h4> <br /> \
                                        <br /> \
                                        <center><button class="btn btn-large btn-danger" onClick="Shadowbox.close()">Não</button> \
                                        &nbsp; &nbsp; &nbsp; &nbsp; <button class="btn btn-large btn-success" onClick="submit_form_os()">Sim</butt3on></center> \
                                    </div>',
                            player: "html",
                            title: "Confirmação OS fora de garantia",
                            width: 600,
                            height: 350
                        });

                    } else {

                        submit_form_os();

                    }

                });

            } else {

                submit_form_os();

            }

        });

    <?php
    }

    if($login_fabrica == 156 and ($areaAdmin == false || empty($os))) {
?>

        $("#tipo_atendimento").change(function(){
            if($(this).val() == "262"){
                $('#produto_reparo_fabrica').check();
                $("#linha_nf_envio").show();
            }else{
                $('#produto_reparo_fabrica').uncheck();
                $("#linha_nf_envio").hide();
            }

        });
<?php
    }
    if ($login_fabrica == 153) {
?>
        $('#consumidor_cpf').blur(function(){
            var cpf = $('#consumidor_cpf').val();
            var fabrica = <?=$login_fabrica?>;
            var posto = $("#posto_id").val();

            $.ajax({
                url : "<?php echo $_SERVER['PHP_SELF']; ?>",
                type: "POST",
                dataType : "application/json",
                data: { ajax: true, verificaPreOs : 1, cpf : cpf, fabrica:fabrica, posto:posto },
                complete: function(retorno){
                    retorno = JSON.parse(retorno.responseText);
                    if(retorno.resposta == "sim"){
                            var r = confirm("<?php echo traduz('ja.existe.uma.pre.os.aberta.para.esse.cpf.produto');?>:"+retorno.produto+" e posto:" +retorno.posto +". <?php echo traduz("deseja.continuar.esse.atendimento");?>?");
                        if (r == true) {
                            window.location.href = 'cadastro_os.php?preos='+retorno.hd_chamado;
                        }
                    }
                }
            });
        });

        var nserie = $("input[name='produto[serie]']").val();
        if(nserie.length >0 ){
            $("#prod_s_ns").hide();
        }

        if ($('.anexo_thumb_sem_ns[rel="imagem_semns"]').length) {
            $("#campo_anexo_sem_ns").show();
            $("#sem_ns").prop("checked",true);
        } else {
            $("#campo_anexo_sem_ns").hide();
        }
        $('#sem_ns').change(function () {
            if ($(this).is(':checked')) {
                $("#campo_anexo_sem_ns").show();
            } else {
                $("#campo_anexo_sem_ns").hide();
            }
        });

        $("#produto_defeito_constatado").change(function(){
            var descricao_produto_defeito_constatado = $("#produto_defeito_constatado option:selected").text();
            var descricao_tipo_atendimento = $("#tipo_atendimento option:selected").text();

            if(descricao_produto_defeito_constatado == "Mau Uso"){
                $("#produto_pecas").hide();
                $("#mau_uso").show();
            }else{
                $("#produto_pecas").show();
                $("#mau_uso").hide();
            }

            if(descricao_tipo_atendimento == 'Laudo Zero Hora'){

                $("input[rel='peca_id']").val("");
                var count = 0;
                $("div[name^=peca_]").each(function(){
                    var cont = count++;
                    $("input[name='produto_pecas["+cont+"][os_item]']").val("");
                    $("input[name='produto_pecas["+cont+"][id]']").val("");
                    $("input[name='produto_pecas["+cont+"][referencia]']").val("").removeAttr("readonly");
                    $("input[name='produto_pecas["+cont+"][descricao]']").val("").removeAttr("readonly");
                    $("input[name='produto_pecas["+cont+"][qtde]']").val("");
                    $("select[name='produto_pecas["+cont+"][servico_realizado]']").val("");
                    $("select[name='produto_pecas["+cont+"][defeito_peca]']").val("");

                    $("span[rel=lupa_peca]").show();

                    $("button[name='remove_peca']").remove();
                    $("#dev_obrig_"+cont).remove();

                });

                $("#acessorios").hide();
                $("#aparencia_produto").hide();
                $("#acessorios_zero_hora").show();
                $("#aparencia_produto_zero_hora").show();
                $("#produto_pecas").hide();
                $(".codigo_lacre").show();
                $("#produto_pecas").hide();
            }else{
                $("#acessorios").show();
                $("#aparencia_produto").show();
                $("#acessorios_zero_hora").hide();
                $("#aparencia_produto_zero_hora").hide();
                $("#produto_pecas").show();
                $(".codigo_lacre").hide();
                $("#produto_pecas").show();
            }
        });

        $("#tipo_atendimento").change(function(){
            var descricao_tipo_atendimento = $("#tipo_atendimento option:selected").text();

            if(descricao_tipo_atendimento == 'Laudo Zero Hora'){
                $("#acessorios").hide();
                $("#aparencia_produto").hide();
                $("#acessorios_zero_hora").show();
                $("#aparencia_produto_zero_hora").show();
                $("#produto_pecas").hide();
                $(".codigo_lacre").show();
                $("#produto_pecas").hide();
            }else{
                $("#acessorios").show();
                $("#aparencia_produto").show();
                $("#acessorios_zero_hora").hide();
                $("#aparencia_produto_zero_hora").hide();
                $("#produto_pecas").show();
                $(".codigo_lacre").hide();
                $("#produto_pecas").show();
            }
        });

        $("#data_compra").change(function(){
            var data = $("#data_compra").val();
            $.ajax({
                url : "<?= $_SERVER['PHP_SELF']; ?>",
                type: "POST",
                dataType : "json",
                data: { ajax: true, dataCompraZeroHora : 1, data : data },
                complete: function(retorno){
                    if(retorno.responseText > 90){
                        var descricao_tipo_atendimento = $("#tipo_atendimento option:selected").text();
                        if(descricao_tipo_atendimento == 'Laudo Zero Hora'){
                            alert("<?php echo traduz("a.data.da.compra.nao.pode.ser.maior.que.90.dias");?>");
                            $("#data_compra").val("");
                        }
                    }
                }
            });
        });
    <? }

    if(in_array($login_fabrica, [167, 203])){ ?>

        var descricao_tipo_atendimento = $("#tipo_atendimento option:selected").text();
        if(descricao_tipo_atendimento == 'Garantia Recusada'){
            $("#produto_pecas").hide();
        }else{
            if($("#valida_suprimento").val() != 't'){
                $("#produto_pecas").show();
            }
        }

        $(".valor_peca").priceFormat({
            prefix: '',
            thousandsSeparator: '.',
            centsSeparator: ',',
            centsLimit: 2
        });

        $(".valor_peca").on("blur", function(e) {
            var posicao_valor = $(this).attr("posicao");
            calcula_valor_total_pecas(posicao_valor);
        });

        $("#tipo_atendimento").change(function(){

            var descricao_tipo_atendimento = $("#tipo_atendimento option:selected").text();

            if(descricao_tipo_atendimento == 'Garantia Recusada'){
                $("#produto_pecas").hide();
                $(".produto_referencia").val("");
                $(".produto_referencia").prop('readonly',false);
                $(".produto_peca_descricao").val("");
                $(".produto_peca_descricao").prop('readonly',false);
                $("input[id^='qtde_'").val('');
                $(".serie_peca").val("");
                $("button[name^='remove_peca']").remove();
                $("div[id^='serie_peca_'").hide();
            }else{
				if($("#valida_suprimento").val() != 't'){
					$("#produto_pecas").show();
				}
                //$(".serie_peca").val("");
                $("span[rel='lupa_peca']").show();
            }

            if(descricao_tipo_atendimento == "Orçamento"){
                $("#status_orcamento").show();
                $("input[name='os[valida_atendimento]']").val(descricao_tipo_atendimento);
                $("input[name='os[valor_adicional_mo][]'] ").prop('checked',false);
                $("#div_valores_adicionais").hide();
                $("div[id^='div_servicos_peca_'").hide();
                $("div[id^='serie_peca_'").hide();

                if ($("#nota_fiscal, #data_compra").prevAll("h5").length > 0) {
                    $("#nota_fiscal, #data_compra").prevAll("h5").remove();
                    $("#anexo_obrig").hide();
                }

                $("#div_informacoes_revenda input, #div_informacoes_revenda select").each(function(){
                    if ($(this).prevAll("h5").length > 0) {
                        $(this).prevAll("h5").remove();
                    }
                });
            }else{
                $("#status_orcamento").hide();
                $("#div_valores_adicionais").show();
                $("input[name='os[status_orcamento]']").val("");
                $("input[name='os[valida_atendimento]']").val("");
                $("div[id^='div_servicos_peca_'").show();

                if ($("#nota_fiscal, #data_compra").prevAll("h5").length == 0) {
                    $("#nota_fiscal, #data_compra").before("<h5 class='asteristico'>*</h5>");
                    $("#anexo_obrig").show();
                }

                $("#div_informacoes_revenda input, #div_informacoes_revenda select").each(function(){
                    if ($(this).prevAll("h5").length == 0) {
                        $(this).before("<h5 class='asteristico'>*</h5>");
                    }
                });
            }


        });

        $("#tipo_atendimento").change();

        $(".valor_peca").each(function(){
            if ($(this).val() != "") {
                $(this).blur();
            }
        });
    <? }
    if($login_fabrica == 160 or $replica_einhell){ ?>
        //$("#comunicado_laudo").hide();

        $('#fora_garantia').change(function () {
            if($(this).is(':checked')){
                $("#produto_pecas").hide();
                $("#comunicado_laudo").show();
            }else{
                $("#produto_pecas").show();
                $("#comunicado_laudo").hide();
            }
        });

<? }

    if($login_fabrica == 191){ ?>
	$(".valor_peca").on("blur", function(e) {
              var posicao_valor = $(this).attr("posicao");
              calcula_valor_total_pecas(posicao_valor); 
        });
<?php } 

    if ($login_fabrica == 148) {
    ?>

        $("#venda_numero_serie").on({
          keydown: function(e) {
            if (e.which === 32)
              return false;
          },
          change: function() {
            this.value = this.value.replace(/\s/g, "");
          }
        });

    <?php
    }

    // verifica posto interno
    if (in_array($login_fabrica, [193])) {
        $isPostoInterno = false;

        if (!empty($login_posto)) {
            $sql = "SELECT tbl_posto_fabrica.tipo_posto from tbl_tipo_posto
                    JOIN tbl_posto_fabrica on tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto
                    WHERE tbl_posto_fabrica.posto   = {$login_posto}
                    AND   tbl_posto_fabrica.fabrica = {$login_fabrica}
                    AND   tbl_tipo_posto.posto_interno IS TRUE";
            $res            = pg_query($con, $sql);
            $isPostoInterno = (pg_num_rows($res) > 0) ? true : false;
        }
    }

    /**
     * Carrega o datepicker já com as mascara para os campos
     */

    if($login_fabrica == 35 or $replica_einhell){ ?>
        $("#data_abertura").datepicker({ maxDate: 0, minDate: "-5d", dateFormat: "dd/mm/yy" }).mask("99/99/9999");
<?php
    }else if($login_fabrica == 131){ ?>
        $("#data_abertura").datepicker({ maxDate: 0, minDate: "0", dateFormat: "dd/mm/yy" }).mask("99/99/9999");
        $("#data_fabricacao").datepicker({ maxDate: 0, dateFormat: "dd/mm/yy" }).mask("99/99/9999");
        $("#data_entrega").datepicker({ maxDate: "", minDate: "", dateFormat: "dd/mm/yy" }).mask("99/99/9999");
<?php }elseif ($login_fabrica == 147) {
?>
        $("#data_abertura").datepicker({ maxDate: 0, minDate: "-30d", dateFormat: "dd/mm/yy" }).mask("99/99/9999");
    <?php } else if ($login_fabrica == 158) { ?>
        $("#data_abertura").datepicker({ maxDate: 0, minDate: "-60d", dateFormat: "dd/mm/yy" }).mask("99/99/9999");
        $(".pdv_mask").on("change",function(){
           $(this).val(parseFloat($(this).val()).toFixed(1));
           let vl = $(this).val().replace('-', '');
           if (vl > 30.0) {
                $(this).val('');
           }
        });
    <?php } else if ($login_fabrica == 151) { ?>
        $("#data_abertura").datepicker({ maxDate: 0, minDate: "-180d", dateFormat: "dd/mm/yy" }).mask("99/99/9999");
    <?php } else if ($login_fabrica == 160 && $areaAdmin == false) { ?>
        $("#data_abertura").datepicker({ maxDate: 0, minDate: "-3d", dateFormat: "dd/mm/yy" }).mask("99/99/9999");
    <?php } else if ($login_fabrica == 161 && $postoInterno == false && $areaAdmin == false) { ?>
        $("#data_abertura").datepicker({ maxDate: 0, minDate: "-1d", dateFormat: "dd/mm/yy" }).mask("99/99/9999");
    <?php } else if ($login_fabrica == 162 && $areaAdmin === true) { ?>
        $("#data_saida").datepicker({ maxDate: 0, minDate: "-360d", dateFormat: "dd/mm/yy" }).mask("99/99/9999");
        $("#rastreio").mask("aa999999999aa",{placeholder:""});
    <?php } else if($login_fabrica == 164){ ?>
        $("#data_abertura").mask("99/99/9999");
        $("#cor_indicativa_carcaca").alpha({ allow: " " });
        $("#data_entrada").datepicker({ maxDate: $("#data_abertura").val() });
    <?php } else if ($login_fabrica == 165) { ?>
        var data = new Date();
        $("#data_abertura").attr("readonly",true);
        $("#data_fabricacao").mask("99/99/9999");
    <?php } else if ($login_fabrica == 173 AND $postoInterno != true){?>
        $("#data_abertura").datepicker({ maxDate: 0, minDate: "-3d", dateFormat: "dd/mm/yy" }).mask("99/99/9999");
    <?php } else if ($login_fabrica == 173 AND $postoInterno === true) { ?>
        $("#data_abertura").datepicker({ maxDate: 0, minDate: "-6d", dateFormat: "dd/mm/yy" }).mask("99/99/9999");
    <?php } else if ($login_fabrica == 163) { ?>
        $("#data_abertura").datepicker({ maxDate: 0, minDate: "-90d", dateFormat: "dd/mm/yy" }).mask("99/99/9999");
    <?php } else if ($login_fabrica == 193) { ?>
        <?php if ($isPostoInterno === true) { ?> 
        $("#data_abertura").datepicker({ dateFormat: "dd/mm/yy" }).mask("99/99/9999");
        <?php } else { ?>
        $("#data_abertura").attr("readonly",true);
        $("#data_abertura").datepicker({ maxDate: 0, minDate: "-2d", dateFormat: "dd/mm/yy"}).mask("99/99/9999");
        <?php if (empty(getValue('os[data_abertura]'))){ ?>    
            $("#data_abertura").datepicker("setDate", new Date());
        <?php } ?>
        <?php } ?>  
    <?php } else if ($login_fabrica == 194) { ?>
        $("#data_abertura").attr("readonly",true);
        $("#data_abertura").datepicker({ maxDate: 0, minDate: "-6d", dateFormat: "dd/mm/yy"}).mask("99/99/9999");
        $("#data_abertura").datepicker("setDate", new Date());
    <?php } else if ($login_fabrica != 174) { ?>
        $("#data_abertura").datepicker({ maxDate: 0, minDate: "-6d", dateFormat: "dd/mm/yy" }).mask("99/99/9999");
    <?php }
    if ($login_fabrica == 158) { ?>
        $("#data_fabricacao").datepicker({ maxDate: 0, dateFormat: "dd/mm/yy" }).mask("99/99/9999");
        $("#data_venda").datepicker({ maxDate: 0, dateFormat: "dd/mm/yy" }).mask("99/99/9999");
    <? }
    if (in_array($login_fabrica, array(156))) { ?>
        $('#data_nf_envio, #os_data_nota_fiscal_mo, #os_data_nota_fiscal_peca').datepicker({ maxDate: 0, dateFormat: "dd/mm/yy" }).mask("99/99/9999");
        $("#os_valor_nota_fiscal_mo, #os_valor_nota_fiscal_peca, #os_valor_nf_envio").priceFormat({
            prefix: '',
            thousandsSeparator: '',
            centsSeparator: '.',
            centsLimit: 2
        });
    <? } ?>
    
    <?php if ($login_fabrica == 178 || $login_fabrica == 195){ ?>
        $('#btnPopover').popover();
        $("#data_agendamento").datepicker({ minDate: 0, dateFormat: "dd/mm/yy" }).mask("99/99/9999");
        $("#data_visita_realizada").datepicker({ minDate: -5, dateFormat: "dd/mm/yy" }).mask("99/99/9999");
    <?php } ?>
      
    <?php if ($login_fabrica == 195){ ?>
         $("#data_fabricacao").datepicker({ maxDate: 0, dateFormat: "dd/mm/yy" }).mask("99/99/9999");
    <?php } ?>
    <?php 

    if (in_array($login_fabrica, [148])) { ?>

        $("#data_falha").datepicker({dateFormat: "dd/mm/yy"}).mask("99/99/9999");

    <?php
    } ?>
    
    $("#data_compra").datepicker({ maxDate: 0, dateFormat: "dd/mm/yy" }).mask("99/99/9999");

    <? if($login_fabrica == 143){ ?>
        $("#produto_rg_produto").mask("999999");
    <? }

    if(in_array($login_fabrica, array(161,163,167,177,190,195,203))){ ?>
        $("#valor_adicional, #desconto, .valor_peca").priceFormat({
            prefix: '',
            thousandsSeparator: '.',
            centsSeparator: ',',
            centsLimit: 2
        });

        <?php if ($login_fabrica == 203) { ?>
            $("#consumidor_nascimento").datepicker({dateFormat: "dd/mm/yy" }).mask("99/99/9999");
        <?php } ?>
    <? } ?>

    <? if ($login_fabrica == 177 AND empty(getValue('os[data_abertura]'))) { ?>
        $("#data_abertura").datepicker("setDate", new Date());
    <? } ?>

    <? if ($data_abertura_fixa) { ?>
        $("#data_abertura").datepicker("destroy");
    <? } ?>
    

    /**
     * Inicia o shadowbox, obrigatório para a lupa funcionar
     */
    Shadowbox.init();

    /**
     * Configurações do Alphanumeric
     */
    $(".numeric").numeric();
    $("#consumidor_telefone, #revenda_telefone, #consumidor_celular").numeric({ allow: "()- " });
<?php if (in_array($login_fabrica,[148,171,158,200])) { ?>      
        $("#consumidor_telefone").mask("(99) 9999-9999?9",{placeholder:""});
        $("#revenda_telefone").mask("(99) 9999-9999",{placeholder:""});
        $("#os_observacoes_telefone_contato")
        .mask("(99) 9999-9999?9",{placeholder:""})
        .focusout(function (event) {  
            var target, phone, element;  
            target = (event.currentTarget) ? event.currentTarget : event.srcElement;  
            phone = target.value.replace(/\D/g, '');
            element = $(target);  
            element.unmask();  
            if(phone.length > 10) {  
                element.mask("(99) 99999-999?9");  
            } else {  
                element.mask("(99) 9999-9999?9");  
            }
        });     
    <?php } else {
        if ($cook_idioma == "pt-br" && !in_array($login_fabrica, [180,181,182])) { ?>
            $("#consumidor_telefone, #revenda_telefone").mask("(99) 9999-9999",{placeholder:""});      
	<?php }
    }
    
    if (in_array($login_fabrica, [167,203])) { ?>
        $("#produto_serie").alphanumeric();
    <?php
    }

    if (!in_array($login_fabrica, [180,181,182])) { ?>
        $("#consumidor_celular").mask("(99) 99999-9999",{placeholder:""});
    <?php }

    if (in_array($login_fabrica, [175])) { ?>
        $("input[id^=qtde_").numeric({allow:". ,"});

        $("input[id^=qtde_").on('blur', function(){
            let val = $(this).val().replace(',', '.');
            $(this).val(val);
        });
    <?php } else { ?>
        $("input[id^=qtde_").numeric({allow:"."});
    <?php } ?>

    $("#qtde_km").priceFormat({
        prefix: '',
        thousandsSeparator: '',
        centsSeparator: '.',
        centsLimit: 2
    });

    <? if (in_array($login_fabrica, array(156))) { ?>
        $("#valor_nf_recebimento").priceFormat({
            prefix: '',
            thousandsSeparator: '',
            centsSeparator: '.',
            centsLimit: 2
        });
    <? }
    if ($login_fabrica == 158) { ?>
        $("#produto_amperagem").priceFormat({
            prefix: '',
            thousandsSeparator: '',
            centsSeparator: '.',
            centsLimit: 2
        });
    <?php
    }
    ?>

    $(".valor_adicional_valor").priceFormat({
        prefix: '',
        thousandsSeparator: '',
        centsSeparator: '.',
        centsLimit: 2
    });

    <? if($login_fabrica == 52){ ?>
        $("#pedagio").priceFormat({
            prefix: '',
            thousandsSeparator: '',
            centsSeparator: '.',
            centsLimit: 2
        });
    <? }
    if ($login_fabrica == 154) { ?>
        verifica_revenda_posto_rheem($("#posto_id").val());
    <? } ?>
    /**
     * Evento que chama a função de lupa para a lupa clicada
     */
    $("span[rel=lupa]").click(function() {
        $.lupa($(this));
    });

    <?php if($login_fabrica == 35){?>
        $("#consumidor_celular").blur(function(){
            var consumidor_celular = $("#consumidor_celular").val();
            if(consumidor_celular.length == 0){
                alert("<?php echo traduz('numero.de.celular.invalido');?>.");
            }
        });
    <?php } ?>
    <? if (in_array($login_fabrica, array(148, 151))) { ?>
            $(window).load(function () {
            $("div > [id^=pecas_descricao_]").each(function(){
                $(this).hide();
            });

            $("span[rel=lupa_peca]").each(function() {
                $(this).next().attr({ referencia_descricao: true });
            });
        });

        $("#consumidor_celular").numeric();
    <? } ?>

    /**
     * Evento que chama a lupa do produto
     */
    $("span[rel=lupa_produto]").click(function() {
        var parametros_lupa_produto = ["posto", "ativo"];

        <? if (isset($fabrica_usa_subproduto)) { ?>
            parametros_lupa_produto.push("subproduto");
        <? }

        if (in_array($login_fabrica, array(158,169,170))) { ?>
            if ($("#tipo_atendimento").val() == '') {
                alert("<?php echo traduz('para.buscar.um.produto.e.necessario.selecionar.o.tipo.de.atendimento');?>");
                return false;
            }
        <? }
        if ($usaProdutoGenerico) { ?>
            parametros_lupa_produto.push("produto-generico");
        <? }
        if (in_array($login_fabrica, array(169,170))) { ?>
            parametros_lupa_produto.push("mascara");
            $(this).next("input[name=lupa_config]").attr("grupo-atendimento", $("#tipo_atendimento").find("option:selected").attr("grupo_atendimento"));
            parametros_lupa_produto.push("grupo-atendimento");
            $(this).next("input[name=lupa_config]").attr("fora-garantia", $("#tipo_atendimento").find("option:selected").attr("fora_garantia"));
            parametros_lupa_produto.push("fora-garantia");
            $(this).next("input[name=lupa_config]").attr("km-google", $("#tipo_atendimento").find("option:selected").attr("km_google"));
            parametros_lupa_produto.push("km-google");
            parametros_lupa_produto.push("tela_cadastro_os");
        <? }
        if (in_array($login_fabrica, array(142))) { ?>
            parametros_lupa_produto.push("entrega-tecnica");
        <? }

        if (in_array($login_fabrica, array(153))) { //hd_chamado=2717074 ?>
            parametros_lupa_produto.push("tela_cadastro_os");
        <? }
        if (in_array($login_fabrica, array(152,180,181,182))) { ?>
            $.lupa($(this), parametros_lupa_produto,"","",0);
        <? } else { ?>
            $.lupa($(this), parametros_lupa_produto);
        <? } ?>
    });

    <? if($login_fabrica == 160 or $replica_einhell) { ?>
        $("#div_informacoes_revenda input, #div_informacoes_revenda select").each(function() {
            if ($(this).data("obrigatorio") == 1) {
                if ($(this).prevAll("h5").length == 0) {
                    $(this).before("<h5 class='asteristico'>*</h5>");
                }
            }
        });
    <? } ?>

    <?php if ($login_fabrica == 175){ ?>
        if ($("#os_consumidor_revenda").val() == 'C'){
            $("#div_informacoes_revenda input, #div_informacoes_revenda select").each(function() {
               $(this).prevAll("h5").remove();
            });
        }
    <?php } ?>

    <?php if ($login_fabrica == 178 AND !empty($os)){ ?>
        if ($("#os_consumidor_revenda").val() == 'R' || $("#os_consumidor_revenda").val() == 'S'){
            $("#div_informacoes_consumidor input, #div_informacoes_consumidor select").each(function() {
               $(this).prevAll("h5").remove();
            });
        }
    <?php } ?>

    $("#os_consumidor_revenda").change(function() {
        var tipo_posto = $("#tipo_posto").val();
        if (tipo_posto == 'false' || tipo_posto == 'f') {
	    if ($(this).val() == "R") {

                $("#revenda_nome, #revenda_cnpj, #revenda_cep, #revenda_estado, #revenda_cidade, #revenda_bairro, #revenda_endereco, #revenda_numero, #revenda_telefone").attr('data-obrigatorio', 1);
                obrigatorio_revenda();
            } else {
                obrigatorio_consumidor();
            }
	}

	<?php if (in_array($login_fabrica, array(169,170))) { ?>
		ocultaDadosConsumidor($(this).val());
	<?php } ?>

        <? if($login_fabrica != 165) { ?>
            if ($(this).val() == "R") {
                $("#div_anexo_produto_nf").show();
                $("#div_informacoes_consumidor input, #div_informacoes_consumidor select").each(function() {
                    $(this).prevAll("h5").remove();
                });
                $("#div_informacoes_revenda input, #div_informacoes_revenda select").each(function() {
                    if ($(this).data("obrigatorio") == 1) {
                        if ($(this).prevAll("h5").length == 0) {
                            $(this).before("<h5 class='asteristico'>*</h5>");
                        }
                    }
                });
            } else {
                $("#div_anexo_produto_nf").hide();
                $("#div_informacoes_consumidor input[name!=lupa_config], #div_informacoes_consumidor select").each(function() {
                    if ($(this).data("obrigatorio") == 1) {
                        if ($(this).prevAll("h5").length == 0) {
                            $(this).before("<h5 class='asteristico'>*</h5>");
                        }
                    }
                });
                <? if($login_fabrica != 160) { ?>
                    $("#div_informacoes_revenda").find("input[name!=lupa_config], select").each(function() {
                        if ($(this).data("consumidor-obrigatorio") != 1) {
                            $(this).prevAll("h5").remove();
                        }
                    });
                <? } ?>
            }
        <? }

        if (in_array($login_fabrica, array(169,170)) && empty($os) && empty($preos)) { ?>
            busca_tipo_atendimento();
        <? } 

	    if (in_array($login_fabrica, array(178)) && empty($os)) { ?>
            verificaComboEnviarPara();
        <? } ?>

        $("#tipo_atendimento").change();

    });

    <? if (isset($fabrica_usa_subproduto)) { ?>
        /**
         * Evento que chama a lupa do subproduto
         */
        $("span[rel=lupa_subproduto]").click(function() {
            var parametros_lupa_subproduto = ["posto", "ativo"];

            <? if (isset($fabrica_usa_subproduto)) { ?>
                parametros_lupa_subproduto.push("produto");
                $(this).next("input[name=lupa_config]").attr({ produto: $("#produto_id").val() });
            <? } ?>

            $.lupa($(this), parametros_lupa_subproduto);
        });
    <? } ?>

<?php
    if(in_array($login_fabrica, array(151))){
        if(!empty($os) && strlen(getValue('produto[id]')) > 0){
?>
            var serie = "<?=getValue('produto[serie]')?>";
            if (serie !== '') {
                $.ajax({
                    url : "<?php echo $_SERVER['PHP_SELF']; ?>",
                    type: "POST",
                    data: { ajax: true, ajax_serie_mascara : 1, produto : <?=getValue('produto[id]')?>, serie : serie },
                    complete: function(data){
                        data = $.parseJSON(data.responseText);
                        if(data.error){
                            alert(data.error);

                            $("#produto_versao").val("");
                            $("#produto_pecas").hide();

                        }else{

                            $("#produto_versao").val(data.versao);
                            $("#produto_pecas").show();
                        }
                    }

                });
            }
<?php
        }
    }
?>



    /**
     * Evento que chama a lupa de peça
     */
    $(document).on("click", "span[rel=lupa_peca]", function() {
        var parametros_lupa_peca = ["produto", "posicao", "garantia"];

<?php
    if (!in_array($login_fabrica, array(143,152,180,181,182)) && !isset($defeitoConstatadoMultiplo)) {
?>
        var defeito_constatado = $("#produto_defeito_constatado").val();
<?php
    } else {
?>
        var defeito_constatado = $("#defeitos_constatados_multiplos").val();
<?php
    }
?>

 <?php if ($login_fabrica == 177 AND $areaAdmin === false){ ?>
    var defeito_constatado = $("#produto_causa_defeito").val();
<?php } ?>

<?php
    if (!isset($fabrica_usa_subproduto)) {
        if (!in_array($login_fabrica, array(148,131))) {
?>
        var grupo_atendimento  = $("#tipo_atendimento").find("option:selected").attr("grupo_atendimento");
        if (defeito_constatado.length == 0 && grupo_atendimento != "R") {
            alert("<?php echo traduz('informe.o.defeito.constatado.para.lancar.pecas');?>");
            return false;
        }
<?php
            if ($login_fabrica == 175){
?>
                if ($("#produto_serie").val() == "" || $("#produto_serie").val() == undefined){
                    alert("Informe o número de série do produto para acessar a lista básica");
                    return false;
                }
<?php                
            }

            if ($login_fabrica == 161 && $posto_interno == TRUE) {
?>
        if ($("#tipo_atendimento").val() == <?=$id_orcamento?> && $("#tabela").val() == "") {
            alert("<?php echo traduz('seleciona.a.tabela.de.precos.para.calculo.das.pecas.para.orcamento');?>");
            return false;
        }
<?php
            }
        }
    } else {
?>
        var subproduto_defeito_constatado = $("#subproduto_defeito_constatado").val();
        var subproduto = $(this).next().attr("subproduto");

        if (typeof subproduto != "undefined" && subproduto == "t") {
            if (subproduto_defeito_constatado.length == 0) {
                alert("<?php echo traduz('informe.o.defeito.constatado.do.subconjunto.para.lancar.pecas');?>");
                return false;
            }
        } else {
            if (defeito_constatado.length == 0) {
                alert("<?php echo traduz('informe.o.defeito.constatado.para.lancar.pecas');?>");
                return false;
            }
        }
<?php
    }

    if (in_array($login_fabrica, array(145,156))) {
?>
        if ($("#tipo_atendimento").val().length == 0) {
            alert("<?php echo traduz('para.lancar.pecas.escolha.um.tipo.de.atendimento');?>");
            return false;
        }

        if ($("#tipo_atendimento").val() == 201 && $("#status_troca_produto").val().length > 0) {
            alert("<?php echo traduz('para.solicitacao.de.troca.de.produto.nao.pode.ser.lancado.peca.na.ordem.de.servico');?>");
            return false;
        }
<?php
    }
    if ($login_fabrica == 158) {
?>
        var solucao;
        solucao = $('#solucao').val();
        if (typeof solucao == "undefined" || solucao == "" || solucao == " ") {
            alert("<?php echo traduz('por.favor.inserir.uma.solucao.para.buscar.pecas');?>");
            return false;
        }
<?php
    }
?>
        var posto_codigo = $("#posto_codigo").val();
        var posto_nome   = $("#posto_nome").val();
        $(this).next().attr("posto_codigo", posto_codigo);
        $(this).next().attr("posto_nome", posto_nome);

        if ($('input[name=lib_peca_reposicao]').is(':checked')) {
            $(this).next().attr("reposicao", true);
            parametros_lupa_peca.push("reposicao");
        }

        parametros_lupa_peca.push("posto_nome");
        parametros_lupa_peca.push("posto_codigo");

<?php
    if (isset($fabrica_usa_subproduto)) {
?>
        parametros_lupa_peca.push("subproduto");
<?php
    }


    if (in_array($login_fabrica, array(156,161,163,167,177,186,190,191,195,203))) {
        if (in_array($login_fabrica, array(161,167,177,186,190,191,195,203))) {
            if (in_array($login_fabrica, array(177,186))) { ?>
                parametros_lupa_peca.push("preco_peca");
                parametros_lupa_peca.push("cadastro_os");
        <?php } ?>
        if ($("#tipo_atendimento").val() == '<?=$id_orcamento?>' || $("#tipo_atendimento option:selected").text() == 'Orçamento') {

            parametros_lupa_peca.push("orcamento");

            <?php if ($login_fabrica == 161 && $posto_interno == TRUE) {?>
                parametros_lupa_peca.push("tabela");
                $("span[rel=lupa_peca]").next("input[name=lupa_config]").attr({tabela:$("#tabela").val()});
	       <?php }?>


    	    <?php if (in_array($login_fabrica, array(190,191,195))) {?>

        		parametros_lupa_peca.push("preco_peca");
                $("span[rel=lupa_peca]").next("input[name=lupa_config]").attr({preco_peca:true});

    	    <?php } ?>
        }
<?php
        } else {
?>
        parametros_lupa_peca.push("preco_peca");
<?php
        }
    }

    if (in_array($login_fabrica, array(169,170))) {
?>
        parametros_lupa_peca.push("produto_serie");
        $("span[rel=lupa_peca]").next("input[name=lupa_config]").attr({ produto_serie: $("#produto_serie").val() });
<?php
    }?>
        <?php if (in_array($login_fabrica, array(190))) {?>
//            if ($("#tipo_atendimento option:selected").text() == 'Garantia' || $("#tipo_atendimento option:selected").text() == '') {
                parametros_lupa_peca.push("xxos");
                $("span[rel=lupa_peca]").next("input[name=lupa_config]").attr({xxos: $("#os_id").val()});
  //          }
        <?php }?>



<?php     

    if (in_array($login_fabrica, array(52,151,169,170))) {
?>
        parametros_lupa_peca.push("defeito_constatado");
        parametros_lupa_peca.push("garantia");

        $("span[rel=lupa_peca]").next("input[name=lupa_config]").attr({defeito_constatado: defeito_constatado, garantia: true, parametro: "referencia_descricao" });

        parametros_lupa_peca.push("referencia_descricao");
        var attrManual ;
        var pasta ;
        versao = $("#produto_versao").val();

        $(this).next().attr("defeito_constatado", defeito_constatado);

<?php
        if (isset($usa_versao_produto)) {
?>
        if ((typeof versao == "undefined" || versao.length == 0) && $("#produto_serie").val() == "") {
            alert("<?php echo traduz('por.favor.informar.o.numero.de.serie.do.produto');?>");
            return false;
        } else {
            attrManual = "versao="+versao;
        }
<?php
        }
?>
        var produto = $("#produto_id").val();
        if (produto.length > 0) {
            $(this).next().attr({ produto: produto});
            $(this).next().attr({ garantia: true});

            $.lupa($(this), parametros_lupa_peca, pasta, attrManual);
            $("select[name^=produto_pecas], select[name^=subproduto_pecas]").css({ visibility: "visible" });
        } else {
            alert("<?php echo traduz('selecione.um.produto.para.pesquisar.a.peca');?>");
        }

<?php
    } else {
        if ($login_fabrica == 148) {
?>
        parametros_lupa_peca.push("referencia_descricao");
        parametros_lupa_peca.push("posto");
        $(this).next().attr({posto: $("#posto_id").val()});
<?php
        }

        if (in_array($login_fabrica, array(157,158,165))) {
?>
        parametros_lupa_peca.push("defeito_constatado");
        $("span[rel=lupa_peca]").next("input[name=lupa_config]").attr({defeito_constatado: defeito_constatado });

<?php
        if ($login_fabrica == 158) {
?>
        parametros_lupa_peca.push("posto");
        $(this).next().attr({posto: $("#posto_id").val()});
<?php
            }
        }

        if ($login_fabrica == 175){
?>
            parametros_lupa_peca.push("produto_serie");
            $(this).next().attr({produto_serie: $("#produto_serie").val()});
<?php 
        }
?>
        if ($(this).next().attr("subproduto") == "t") {
            var produto = $("#subproduto_id").val();
        } else {
            var produto = $("#produto_id").val();
        }

        if (produto.length > 0) {
            $(this).next().attr({ produto: produto});
            $(this).next().attr({ garantia: true});
            $(this).next().attr({ orcamento: true});

            $.lupa($(this), parametros_lupa_peca);
        } else {
            alert("<?php echo traduz('selecione.um.produto.para.pesquisar.a.peca');?>");
        }
<?php
    }
?>




    });

    /**
     * Evento que abre a lupa de lista básica ao clicar no botão de lista básica
     */
    $("button[name=lista_basica]").click(function() {

        var usa_versao = false;
        <?php if ($login_fabrica == 195) {?>
            if ($("#data_fabricacao").val() == '') {
                alert("<?php echo traduz('Informe a Data de Fabricação para Lançar Peças');?>");
                $("#data_fabricacao").focus();
                return false;
            }
        <?php }?>

        <?php if (!in_array($login_fabrica, array(143,152,180,181,182)) && !isset($defeitoConstatadoMultiplo)) { ?>
            var defeito_constatado = $("#produto_defeito_constatado").val();
        <?php } else if (in_array($login_fabrica, [157]) && !$areaAdmin) { ?>
            
                    var defeitos_selecionados = $("#defeitos_constatados_multiplos").val();
                    var defeitos_separados    = defeitos_selecionados.split(",");
                    var defeito_constatado    = defeitos_separados[defeitos_separados.length - 1];

        <?php
        } else { ?>
            var defeito_constatado = $("#defeitos_constatados_multiplos").val();
        <? } ?>
        <?php if ($login_fabrica == 177 AND $areaAdmin === false){ ?>
            var defeito_constatado = $("#produto_causa_defeito").val();
        <?php } ?>
        <?php if (!isset($fabrica_usa_subproduto)) { ?>
            if (defeito_constatado.length == 0) {
                <? if ($login_fabrica == 52) {
                    if ($areaAdmin !== true) { ?>
                        alert("<?php echo traduz('informe.o.defeito.constatado.para.lancar.pecas');?>");
                        return false;
                    <? }
                } else {
                    if ($login_fabrica == 148) { ?>
                        if (!$('input[name=lib_peca_reposicao]').is(':checked')) {
                            var grupo_atendimento  = $("#tipo_atendimento").find("option:selected").attr("grupo_atendimento");
                            if (defeito_constatado.length == 0 && grupo_atendimento != "R") {
                                alert("<?php echo traduz('informe.o.defeito.constatado.para.lancar.pecas');?>");
                                return false;
                            }
                        }
                    <? } else { 
                        if ($login_fabrica == 177){
                    ?>
                            alert("<?php echo traduz('informe.a.causa.do.defeito.para.lancar.pecas');?>");
                    <?php
                        }else{
                    ?>
                            alert("<?php echo traduz('informe.o.defeito.constatado.para.lancar.pecas');?>");     
                    <?php  
                        }
                    ?>
                        return false;
                    <? }
                } ?>
            }
            <?php if ($login_fabrica == 175){ ?>
                if ($("#produto_serie").val() == "" || $("#produto_serie").val() == undefined){
                    alert("Informe o número de série do produto para acessar a lista básica");
                    return false;
                }
            <?php } ?>
        <? } else { ?>
            var subproduto_defeito_constatado = $("#subproduto_defeito_constatado").val();
            var subproduto = $(this).attr("subproduto");

            if (typeof subproduto != "undefined" && subproduto == "t") {
                if (subproduto_defeito_constatado.length == 0) {
                    alert("<?php echo traduz('informe.o.defeito.constatado.do.subconjunto.para.lancar.pecas');?>");
                    return false;
                }
            } else {
                <? if (!in_array($login_fabrica, array(148))) { ?>
                    if (defeito_constatado.length == 0) {
                        alert("<?php echo traduz('informe.o.defeito.constatado.para.lancar.pecas');?>");
                        return false;
                    }
                <? }else{ ?>
                    var grupo_atendimento  = $("#tipo_atendimento").find("option:selected").attr("grupo_atendimento");
                    if (defeito_constatado.length == 0 && grupo_atendimento != "R") {
                        alert("<?php echo traduz('informe.o.defeito.constatado.para.lancar.pecas');?>");
                        return false;
                    }
                <? } ?>
            }
        <? }
        if ($login_fabrica == 143) { ?>
            var url = "http://products.wackerneuson.com/SpareParts28/wacker_direct.jsp?command=machinesearch&extRegId=w5&extlangId=en&urlAccess=true";
            window.open(url, "_blank");
        <? } else {
            if (in_array($login_fabrica, array(145,156))) { ?>
                if ($("#tipo_atendimento").val().length == 0) {
                    alert("<?php echo traduz('para.lancar.pecas.escolha.um.tipo.de.atendimento');?>");
                    return false;
                }

                if ($("#tipo_atendimento").val() == 201 && $("#status_troca_produto").val().length > 0) {
                    alert("<?php echo traduz('para.solicitacao.de.troca.de.produto.nao.pode.ser.lancado.peca.na.ordem.de.servico');?>");
                    return false;
                }
            <? }
            if ($login_fabrica == 151) { ?>
                var versao ;
                usa_versao = true ;
                versao = $("#produto_versao").val();

                if((typeof versao == "undefined" || versao.length == 0) && $("#produto_serie").val() == ""){
                    alert("<?php echo traduz('por.favor.inserir.numero.de.serie.do.produto');?>");
                    return false;
                }
            <? }
            if ($login_fabrica == 158) { ?>
                var solucao = $('#solucao').val();
                if (typeof solucao == "undefined" || !solucao) {
                    alert("<?php echo traduz('por.favor.inserir.uma.solucao.para.buscar.pecas');?>");
                    return false;
                }
            <? } ?>
            if ($(this).attr("subproduto") == "t") {
                var produto = $("#subproduto_id").val();
                var url = "lista_basica_lupa_new.php?produto="+produto+"&subproduto=t&garantia=true";
            } else if (usa_versao==true && typeof versao != "undefined" && versao.length > 0) {
                var produto = $("#produto_id").val();
                var url = "lista_basica_lupa_new.php?produto="+produto+"&garantia=true&versao="+versao+"&posto_codigo="+$("#posto_codigo").val()+"&posto_nome="+$("#posto_nome").val();
            } else {
                <? if ($login_fabrica == 148) {?>
                var produto = $("select[name=peca_reposicao]").val();
                <? }else{ ?>
                var produto = $("#produto_id").val();
                <? } ?>
                var url = "lista_basica_lupa_new.php?produto="+produto+"&garantia=true"+"&posto_codigo="+$("#posto_codigo").val()+"&posto_nome="+$("#posto_nome").val()+"&tipo_atendimento_desc="+$("#tipo_atendimento option:selected").text();
                if ($('input[name=lib_peca_reposicao]').is(':checked')) {
                    url += "&reposicao=true";
                }
            }

            <?php
            if (!empty($os)) { ?>

                url += "&os_id=<?= $os ?>";

            <?php
            }
            ?>

            <? if (in_array($login_fabrica, array(151,157,158,165,169,170))) { ?>
                url += "&defeito_constatado="+defeito_constatado;
            <? }

            if (in_array($login_fabrica, array(148,158))) { ?> 
                url += "&posto="+$("#posto_id").val();
            <?  }

            if (in_array($login_fabrica, array(156))) { ?>
                if ($("#tipo_atendimento").val() == 247) {
                    url += "&preco_peca=t";
                }
            <?
            }

            if (in_array($login_fabrica, array(163))) { ?>
                if ($("#tipo_atendimento").find("option:selected").attr("fora_garantia") == "t") {
                    url += "&preco_peca=t";
                }

            <?
            }
            if (in_array($login_fabrica, array(195))) { ?>
                if ($("#data_fabricacao").val() != "") {
                    url += "&data_fabricacao="+$("#data_fabricacao").val();
                }

            <?
            }

            if (in_array($login_fabrica, array(177,186,190,195))) {?>

                url += "&preco_peca=true&cadastro_os=true";
            <?php } 

            if (in_array($login_fabrica, array(161,167,186,190,191,195,203)) && ($areaAdmin == true || $postoInterno == true)) { ?>
                if ($("#tipo_atendimento").val() == '<?=$id_orcamento?>') {

                    url += "&preco_peca=t&orcamento=t";
                }

                <? if ($areaAdmin == true) { ?>

                    var posto_id = $("#posto_id").val();

                    if ($("#tipo_atendimento").val() == '<?=$id_orcamento?>' && posto_id == "") {
                        alert("<?php echo traduz('por.favor.insira.o.posto.Autorizado');?>");
                        $("#posto_nome").focus();
                        return;
                    } else {
                        url += "&posto="+posto_id;
                    }

<?php
                }
            }

            if ($login_fabrica == 161 && $posto_interno == TRUE) {
?>

            url += "&tabela="+$("#tabela").val();
<?php
            }

            if (in_array($login_fabrica, array(169,170))) { ?>
                var produto_serie = $("#produto_serie").val();
                url += "&vista_explodida=t";

                if (produto_serie.length > 0) {
                    url += "&produto_serie="+produto_serie;
                }

            <? } ?>

            <?php if ($login_fabrica == 175){ ?>
                var produto_serie = $("#produto_serie").val();
                if (produto_serie != "" && produto_serie != undefined) {
                    url += "&produto_serie="+produto_serie;
                }
            <?php } ?>
            if (typeof produto != "undefined" && produto.length > 0) {
                Shadowbox.open({
                    content: url,
                    player: "iframe",
                    height: 600,
                    width: 800,
                    options: {
                        onClose: function() {
                            $("select[name^=produto_pecas], select[name^=subproduto_pecas]").css({ visibility: "visible" });
                        }
                    }
                });
            } else {
                alert("<?php echo traduz('selecione.um.produto.para.pesquisar.sua.lista.basica');?>");
            }
        <? } ?>
    });

    /**
     * Mascaras
     */
    <?php if (($cook_idioma == 'pt-br' || $areaAdmin) && !in_array($login_fabrica, [180,181,182])) { ?>
        $("#consumidor_cep").mask("99999-999",{placeholder:""});
        $("#revenda_cep").mask("99999-999",{placeholder:""});
    <?php }
        $cpfConsumidor = getValue("consumidor");
        $cpfConsumidor = preg_replace("/[\.\-\/]/", "", $cpfConsumidor["cpf"]);
        if(strlen($cpfConsumidor) > 0 && $cook_idioma == 'pt-br'){
            if(strlen($cpfConsumidor) > 11){
		if (!in_array($login_fabrica, [153,180,181,182])) { ?>
                    $("#consumidor_cpf").mask("99.999.999/9999-99",{placeholder:""});
                <?php }
            }else{
            	if (!in_array($login_fabrica, [180,181,182])) { ?>
                    $("#consumidor_cpf").mask("999.999.999-99",{placeholder:""});
            	<?php }
            }
        }
    
    if (!in_array($login_fabrica, [180,181,182])) {
        $cnpfRev = getValue("revenda");
        $cnpfRev = preg_replace("/[\.\-\/]/", "", $cnpfRev["cnpj"]);
        if(strlen($cnpfRev) > 0 && $cook_idioma == 'pt-br'){
            if(strlen($cnpfRev) > 11) { ?>
                $("#revenda_cnpj").mask("99.999.999/9999-99",{placeholder:""});
<?php       }else{ ?>
                $("#revenda_cnpj").mask("999.999.999-99",{placeholder:""});
<?php       }
        }
    } ?>

    /**
     * Evento de keypress do campo consumidor_cpf
     * Irá verificar o tamanho do campo, se o tamanho já for 14(CPF) irá alterar a máscara para CNPJ e alterar o Label
     */
    $("input[name='consumidor[cnpjCpf]']").change(function(){
        var tipo = $(this).val();
        $("#consumidor_cpf").unmask();
        if(tipo == 'cnpj'){
            <?php if (!in_array($login_fabrica, [180,181,182])) { ?>
                $("#consumidor_cpf").mask("99.999.999/9999-99",{placeholder:""});
            <?php } ?>
        }else{
            <?php if (!in_array($login_fabrica, [180,181,182])) { ?>
                $("#consumidor_cpf").mask("999.999.999-99",{placeholder:""});
            <?php } ?>
        }
    });

    <?php

    if(in_array($login_fabrica, array(175,177))){ ?>
        $(document).on("blur", "#consumidor_telefone", function() {    
            if($(this).val().length > 5){
                $(".asteristico_celular").hide();
            }else if ($("#consumidor_celular").val().length == 0) {
                $("#consumidor_telefone").parent().prepend('<h5 class="asteristico asteristico_telefone" style="display: block;">*</h5>');
                $("#consumidor_celular").parent().prepend('<h5 class="asteristico asteristico_celular" style="display: block;">*</h5>');
            }
        });

        $(document).on("blur", "#consumidor_celular", function() {
            if($(this).val().length > 5){
                $(".asteristico_telefone").hide();
            }else if ($("#consumidor_telefone").val().length == 0) {
                $("#consumidor_telefone").parent().prepend('<h5 class="asteristico asteristico_telefone" style="display: block;">*</h5>');
                $("#consumidor_celular").parent().prepend('<h5 class="asteristico asteristico_celular" style="display: block;">*</h5>');
            }
        });
    <?php } ?>

    <?php if(in_array($login_fabrica, array(167, 169, 170, 203))){ ?>
        if($("#consumidor_telefone").val()){
            $(".asteristico_celular").hide();
        }

        if($("#consumidor_celular").val()){
            $(".asteristico_telefone").hide();
        }

        $("#consumidor_telefone").change(function(){
            if($(this).val().length > 0){
                $(".asteristico_celular").hide();
            }else if ($("#consumidor_celular").val().length == 0) {
                $(".asteristico_telefone").show();
                $("#consumidor_celular").trigger("change");
            }
        });

        $("#consumidor_celular").change(function(){
            if($(this).val().length > 0){
                $(".asteristico_telefone").hide();
            }else if ($("#consumidor_telefone").val().length == 0) {
                $(".asteristico_celular").show();
                $("#consumidor_telefone").trigger("change");
            }
        });
    <?php } ?>

    /**
     * Evento de click do botão trocar_posto
     * Irá remover o readonly dos campos código e nome e dar um show nas lupas
     */
    $("#trocar_posto").click(function() {
        var alterar_produto = false;
        confirm_alterar_posto = false;

        if($(".alterar_produto_venda").is(":visible")){
            $(".alterar_produto_venda").click();
            alterar_produto = true;
        }

        if((alterar_produto == true && confirm_alterar_posto == true) || alterar_produto == false){
            $("#div_informacoes_posto").find("input").val("");
            $("#div_informacoes_posto").find("input[readonly=readonly]").removeAttr("readonly");
            $("#div_informacoes_posto").find("span[rel=lupa]").show();
            $("#div_trocar_posto").hide();

            <? if ($areaAdmin === true) { ?>
                $("input[name=lupa_config][tipo=produto]").attr({ posto: "" });

            <?php if ($login_fabrica == 161): ?>
            /*$("#produto_sem_serie").hide();
            $("#sem_serie").prop({ checked: false });
            $("#sem_ns").prop({ checked: false });*/
            $('.tc_formulario[id!=div_informacoes_produto_venda]').hide();
            $("#div_informacoes_posto").show();
            $('#os_form_submit').hide();
            <?php endif ?>

                <?php if (in_array($login_fabrica, array(164)) && $areaAdmin === true) { ?>
                    $("#produto_pecas").show();
                <?php }?>

                $("#consumidor_nome").val("");
                $("#consumidor_cnpj").val("");
                $("#consumidor_cep").val("");
                $("#consumidor_estado").val("");
                $("#consumidor_cidade").val("");
                $("#consumidor_bairro").val("");
                $("#consumidor_endereco").val("");
                $("#consumidor_numero").val("");
                $("#consumidor_complemento").val("");
                $("#consumidor_telefone").val("");
                $("#consumidor_celular").val("");
                $("#consumidor_email").val("");

            <? } ?>
        }
        <? if (in_array($login_fabrica, array(158,165,167,203)) && $areaAdmin === true) { ?>
            $("#id_tecnico").empty().append('<option></option>');
            $("#unidade_negocio").empty().append('<option></option>');
            $("#tipo_atendimento").empty().append('<option></option>');
        <? }
        if (in_array($login_fabrica, array(156))) { ?>
            $("div.div_posto_interno").hide();
            $("div.div_posto_interno input, div.div_posto_interno select").val("");
            $("#reparoNaFabrica").show();
            $("#reparoNaFabrica input").prop({ checked: false });
        <? } ?>

        $(".box_destinacao").hide();

    });

    /*
    * Função para deletar
    *
    */
    function fnc_deleta_anexo_sem_ns(){

        var dados_anexo_sem_ns = $("#anexo_sem_ns").val();
        var img_clone = $("img.anexo_thumb_sem_ns").clone();
        $(img_clone).attr('src', 'imagens/imagem_upload.png');
        $("#div_anexo_sem_ns > a").after(img_clone);
        $("#div_anexo_sem_ns > a").remove();
        $(".anexo_thumb_sem_ns").attr('src', 'imagens/imagem_upload.png');

        $.ajax({
            url : "<?php echo $_SERVER['PHP_SELF']; ?>",
            type: "POST",
            data: { ajax: true, deleta_anexo_sem_ns : true, dados_anexo_sem_ns:dados_anexo_sem_ns  },
            complete: function(data){
            }
        });
    }

    <?php
        if($login_fabrica == 153){
    ?>
        function remove_os_produto() {
            var os = '<?=$_REQUEST["os_id"]?>';
            $.ajax({
                url : "<?php echo $_SERVER['PHP_SELF']; ?>",
                type: "POST",
                data: { ajax: true, remove_os_produto : true, id_os:os  },
            }).always(function(data) {
                data = $.parseJSON(data);
                if (data.error) {
                    alert(data.error);
                }
            });
        }

        <?php if (true === $areaAdmin): ?>
        function verificaPecas(pedido)
        {
            var os = '<?=$_REQUEST["os_id"]?>';
            if (!pedido) {
                pedido = 't';
            }
            var ret = false;

            $.ajax({
                url : "<?php echo $_SERVER['PHP_SELF']; ?>",
                type: "POST",
                async: false,
                data: {
                    ajax: true,
                    verifica_pecas: true,
                    id_os: os,
                    pedido: pedido
                },
            }).done(function(data) {
                data = $.parseJSON(data);
                if (data.result) {
                    if (data.result == 1) {
                        ret = true;
                    }
                }
            });

            return ret;
        }

        function removePecasOs()
        {
            var os = '<?=$_REQUEST["os_id"]?>';

            $.ajax({
                url : "<?php echo $_SERVER['PHP_SELF']; ?>",
                type: "POST",
                async: false,
                data: {
                    ajax: true,
                    remove_pecas: true,
                    id_os: os
                },
            }).done(function(data) {
                data = $.parseJSON(data);
                if (data.error) {
                    alert(data.error);

                    return false;
                }
            });

            return true;
        }
        <?php endif ?>

    <?php
        }
    ?>
    /**
     * Evento de click do botão trocar_produto
     * Irá remover o readonly dos campos referência e descrição e dar show nas lupas
     */
    $("#trocar_produto").click(function() {

        var id_tem_os = '<?=$os?>';
        var fab = '<?=$login_fabrica?>';

        <?php 
        if (in_array($login_fabrica, [177])) { ?>

            $.ajax({
                url: window.document.location,
                dataType: 'JSON',
                method: 'POST',
                data: {
                    ajax_excluir_pecas: true,
                    os_enviada: id_tem_os
                },
                success: function(res){
                    if( res.error == true ){
                        alert(res.message);
                    }else{
                        
                    }
                }
            });
            
            $("#lote").hide().find("input#produto_lote").val("");

        <?php
        }

        if ($defeitoConstatadoMultiplo) { ?>
            if ($.trim($("#tipo_atendimento > option:selected").text()) != "Triagem") { 
                $(".box_defeito_constatado").show();
            }
        <?php
        }

        if($login_fabrica == 35){ ?>
            $(".grupo_tipo_atendimento").hide();
            $("#produto_pecas").show();
            $("#produto_pecas_mensagem").hide();
            $('#produto_critico').val('');
            $("#tipo_atendimento").removeAttr("readonly");
        <?php } ?>

        <? if ($login_fabrica == 153) {
            if (true === $areaAdmin) { ?>
                if (verificaPecas('f')) {
                    if (!confirm('<?php echo traduz('ao.alterar.o.produto.as.pecas.lancadas.na.os.serao.excluidas.desejar.prosseguir');?>?')) {
                        return false;
                    }

                    if (!removePecasOs()) {
                        return false;
                    }
                }
            <? } ?>
            fnc_deleta_anexo_sem_ns();
            remove_os_produto();
            $("#positron_acessorio").html(''); //hd_chamado=2813100
            $(".linha_prod_s_ns").show();
            $("#prod_s_ns").show(); //hd_chamado=2813100
        <? }
        
        if ($login_fabrica == 175) {
        ?>
            $('#tecnico').find('option').first().nextAll().remove();
        <?php
        }

        if ($login_fabrica == 162) { ?>
            $("#prod_s_ns").hide();
            $(".linha_prod_s_ns").hide();
            $("#sem_ns").val('');
            $(".campo_imei").hide();
            $("#imei").val('');
	<? } ?>

        $("button.comunicados-produto").prop({ disabled: false }).html("<i class='icon-info-sign icon-white' ></i> Comunicados");

        $("#div_foto").hide();
        <? if (isset($anexo_peca_os)) { ?>
            var produto_id = $("#produto_id").val();
        <? }
        if (in_array($login_fabrica, [167, 203])) { //HD-3428328 ?>
            $("#produto_pecas").show();
            $("#comunicado_suprimento").hide();
            $("#contador").hide();
            $("input[name='os[contador]']").val("");
        <? }
        if ($login_fabrica == 156) { ?>
            $("#produto_referencia").val("");
            $("#produto_descricao").val("");
            $("#produto_voltagem").val("");
            $("#produto_serie").val("");
        <? } else if (in_array($login_fabrica, array(169,170))) { ?>
            $("#produto_referencia").val("");
            $("#produto_descricao").val("");
            $("#produto_voltagem").val("");
            $("#produto_serie").val("");
            $(this).find("select").val("").find("option").nextAll().remove();
        <? } else { ?>
            $("#div_informacoes_produto").find("input, select").val("");
        <? }

        if (in_array($login_fabrica, array(169,170))) { ?>
            $("#div_informacoes_produto").find("input[readonly=readonly][id!=defeito_reclamado_descricao]").removeAttr("readonly");
            <?php if (isset($_GET['os_id']) || isset($_GET['preos'])) { ?>
            $('input[name="os[defeito_reclamado]"]').attr('readonly', true);
            <?php } ?>
        <? } else if (!in_array($login_fabrica, array(152,180,181,182))) { ?>
            $("#div_informacoes_produto").find("input[readonly=readonly][id!=produto_voltagem]").removeAttr("readonly");
        <? } ?>	

        <?php if ($login_fabrica == 176) { ?>
            $("#div_os_indice").hide();
        <?php } ?>

        $("#div_informacoes_produto").find("span[rel=lupa_produto]").show();
        $("#produto_defeito_constatado > option").first().nextAll().remove();

        <?php if(!in_array($login_fabrica, array(35,183))){?>
            $("#solucao > option").first().nextAll().remove();
        <?php } ?>
        <? if ($login_fabrica == 158) { ?>
            $("#solucao").select2();
        <? }

        if (!in_array($login_fabrica, array(169,170))) { ?>
            $("#produto_serie").prev("h5.asteristico").remove();
        <? } ?>

        defeito_constatado_json = [];
        defeitos_selecionados = [];

        $("#pecas_produto > div.row-fluid[name^=peca_]").each(function() {
            <? if (isset($anexo_peca_os)) { ?>
                var peca_id  = $(this).find("input[rel=peca_id]").val();
                var produto_peca_id = produto_id+'_'+peca_id;

                if ($("#div_peca_anexo").find("[id^=peca_anexo_"+produto_peca_id+']').length > 0) {
                    $("[id^=peca_anexo_"+produto_peca_id+']').remove(); // exclui todos...
                    $("input[name^=anexo_peca_upload_"+produto_peca_id+"]").each(function() {
                        $(this).parent('form').remove();
                    });
                }
            <? }
            if ($login_fabrica == 145) { ?>
                if ($("#tipo_atendimento").val() == 201) {
                    $(this).find("input[type!=checkbox]").val("").removeAttr("readonly");
                } else {
                    $(this).find("input").val("").removeAttr("readonly");
                }
            <? } else { ?>
                $(this).find("input").val("").removeAttr("readonly");
            <? }
            if (in_array($login_fabrica, array(169,170))) { ?>
                $(this).find("select").val("").find("option").nextAll().remove();
            <? } ?>

            $(this).find("button[name=remove_peca]").hide();
            $(this).find("span[rel=lupa_peca]").show();
        });

        <? if (isset($anexo_peca_os)) { ?>
            $("#div_peca_anexo").hide();
        <? } ?>

        $($("#pecas_produto > div.row-fluid[name^=peca_]")[2]).nextAll("div.row-fluid[name^=peca_]").remove();

        <? if (!in_array($login_fabrica, array(143))) { ?>
            $("#vista_explodida").removeAttr("href").hide();
        <? } ?>

        $("#div_trocar_produto").hide();

        <? if (isset($fabrica_usa_subproduto)) {
            if (isset($anexo_peca_os)) { ?>
                var produto_id = $("#subproduto_id").val();
            <? } ?>
            $("#div_informacoes_subproduto").find("input, select").val("");
            $("#div_informacoes_subproduto").find("input[readonly=readonly][id!=subproduto_voltagem]").removeAttr("readonly");
            $("#div_informacoes_subproduto").find("span[rel=lupa_subproduto]").show();
            $("#subproduto_defeito_constatado > option").first().nextAll().remove();
            $("#div_informacoes_subproduto").hide();

            $("#subproduto_serie").prev("h5.asteristico").remove();

            $("#pecas_subproduto > div.row-fluid[name^=subproduto_peca_]").each(function() {
                <? if (isset($anexo_peca_os)) { ?>
                    var peca_id = $(this).find("input[rel=subproduto_peca_id]").val();

                    if ($("#div_peca_anexo_subproduto").find("#peca_anexo_"+produto_id+"_"+peca_id).length > 0) {
                        $("#peca_anexo_"+produto_id+"_"+peca_id).remove();
                        $("input[name=anexo_peca_upload_"+produto_id+"_"+peca_id+"]").parent("form").remove();
                    }
                <? } ?>

                $(this).find("input").val("").removeAttr("readonly");
                $(this).find("button[name=remove_peca]").hide();
                $(this).find("span[rel=lupa_peca]").show();
            });

            $($("#pecas_subproduto > div.row-fluid[name^=subproduto_peca_]")[2]).nextAll("div.row-fluid[name^=subproduto_peca_]").remove();

            $("#vista_explodida_subproduto").removeAttr("href").hide();

            $("#div_trocar_subproduto").hide();
            $("#div_subproduto_pecas").hide();
        <? }

        if (in_array($login_fabrica, array(143,152,180,181,182)) || isset($defeitoConstatadoMultiplo)) {
            if (in_array($login_fabrica, array(152,180,181,182))) { ?>
                colspan_defeito = 3;
            <? } else { ?>
                colspan_defeito = 2;
            <? } ?>
            if ($.trim($("#tipo_atendimento > option:selected").text()) != "Triagem") { 
                $("#defeitos_constatados_multiplos").val("");
                $("table.box-defeitos > tbody > tr").remove();
                $("table.box-defeitos > tbody").append("<tr class='sem_defeito_selecionado error' ><td class='tac' colspan="+colspan_defeito+" ><?=traduz('Selecione os Defeitos Constatados')?></td></tr>");
            }
        <? }
        if (isset($fabrica_usa_valor_adicional)) {
        ?>
            valores_adicionais_array = [];
        <?php if (in_array($login_fabrica, array(169,170,195))) { ?>
            $.ajax({
                url: window.location.href,
                type: 'POST',
                data: { ajax: 'sim', action: 'default_valores_adicionais' },
                timeout: 8000
            }).fail(function(){
            }).done(function(data){
                data = JSON.parse(data);
            
                var contador = 0;
                $("#valores_adicionais div").each(function(){
                    if (data.ok == contador) {
                        $(this).text('');
                    }
                    ++contador;
                });
            });
        <?php }else{
        ?>
            $("#valores_adicionais").html("");
        <?php
            }
        } ?>

        if(typeof $("#produto_troca_obrigatoria") != false){
            if(!$("#produto_pecas").is(":visible")){
                $("#produto_pecas").show();
            }
            $("#produto_troca_obrigatoria").val("");
        }

        <?php if($login_fabrica == 161 && $postoInterno == false && count($msg_erro["msg"]) == 0){ ?>

            limpa_revenda_produto(true);

        <?php }else{ ?>

            $("#valor_adicional").val("");
            $("#desconto").val("");
            $("#valor_total_pecas").val(0);
            $(".preco-total-pecas").text("0.00");

        <?php }

        if (($defeito_constatado_obriga_lancar_peca == true && !$defeitoConstatadoMultiplo) || in_array($login_fabrica, array(162))) { ?>

            peca_obrigatoria_defeito_constatado(false);

        <?php
        }

        if($login_fabrica == 164){ ?>

            $(".box_numero_serie_calefator").hide();
            $(".box_cor_indicativa_carcaca").hide();
            $(".box_numero_serie_interno_placa_motor").hide();


            $("#numero_serie_calefator").val("");
            $("#cor_indicativa_carcaca").val("");
            $("#numero_serie_interno_placa_motor").val("");

        <?php }

	if ($login_fabrica == 178) {
	?>
		$("#produto_descricao").attr({readonly:"readonly"});
		$("#produto_descricao").next("span[rel=lupa_produto]").hide();
	<?
	}
	
        if ($login_fabrica == 153){ ?>
            $("#sem_ns").val('t');
        <?php
        } ?>

        <?php
        if (in_array($login_fabrica, array(164))) {
        ?>
            if ($("#xtipo_posto").val() == "Autorizada MODELO") {
                $("#produto_pecas").hide();
            } else {
                $("#produto_pecas").show();
            }
        <?php
        }

        if (in_array($login_fabrica,array(169,170))) {
        ?>
            $("#produto-serie-mascaras").hide();
            $("ul.mascaras > li").remove();
            $("#produto_serie").trigger("change");
        <?php
        }
        ?>

        <?php if ($login_fabrica == 175){ ?>
            $("#div_qtde_disparos").hide();
            $("#quantidade_disparos").val("");
            $("#div_tecnico_show").hide();
        <?php } ?>

        <?php if ($login_fabrica == 176){ ?>
        // indice
        $("#indice_alerta").hide();

        var descricao_tipo_atendimento =  $("#tipo_atendimento option:selected").text();

        if (descricao_tipo_atendimento == "Instalação"){
            setTimeout(function(){
                $("#produto_pecas").hide();
            },200);
        }else{
            setTimeout(function(){
                $("#produto_pecas").show();
            },200);
        }
        <?php } ?>

        if (fab == 160 || fab == 188) {
            ja_anexou(id_tem_os);
        }
    });

<?php
	if($login_fabrica == 35 AND strlen($_GET['preos']) > 0){
?>
		verificaDeslocamentoProdutoPreOS();
<?php
	}

    if (isset($fabrica_usa_subproduto)) {
    ?>
        /**
         * Evento de click do botão trocar_subproduto
         * Irá remover o readonly dos campos referência e descrição e dar show nas lupas
         */
        $("#trocar_subproduto").click(function() {
            <?php if (isset($anexo_peca_os)) { ?>
                var produto_id = $("#subproduto_id").val();
            <?php } ?>

            $("#div_informacoes_subproduto").find("input, select").val("");
            $("#div_informacoes_subproduto").find("input[readonly=readonly][id!=subproduto_voltagem]").removeAttr("readonly");
            $("#div_informacoes_subproduto").find("span[rel=lupa_subproduto]").show();
            $("#subproduto_defeito_constatado > option").first().nextAll().remove();
            $("#solucao > option").first().nextAll().remove();

            $("#subproduto_serie").prev("h5.asteristico").remove();

            $("#pecas_subproduto > div.row-fluid[name^=peca_]").each(function() {
                <?php if (isset($anexo_peca_os)) { ?>
                    var peca_id = $(this).find("input[rel=subproduto_peca_id]").val();

                    if ($("#div_peca_anexo_subproduto").find("#peca_anexo_"+produto_id+"_"+peca_id).length > 0) {
                        $("#peca_anexo_"+produto_id+"_"+peca_id).remove();
                        $("input[name=anexo_peca_upload_"+produto_id+"_"+peca_id+"]").parent("form").remove();
                    }
                <?php } ?>

                $(this).find("input").val("").removeAttr("readonly");
                $(this).find("button[name=remove_peca]").hide();
                $(this).find("span[rel=lupa_peca]").show();
            });

            $($("#pecas_subproduto > div.row-fluid[name^=peca_]")[2]).nextAll("div.row-fluid[name^=peca_]").remove();

            $("#vista_explodida_subproduto").removeAttr("href").hide();

            $("#div_trocar_subproduto").hide();

            <?php
            if (isset($fabrica_usa_valor_adicional)) {
            ?>
                busca_valor_adicional();
            <?php
            }
            ?>
        });
    <?php
    }
    ?>

    <?php
    if($login_fabrica == 52){
    ?>

    $("#data_abertura").change(function(){

        $.ajax({
            url: "<?php echo $_SERVER['PHP_SELF']; ?>",
            type: "post",
            data: {
                ajax: true,
                data_abertura : $(this).val(),
                valida_data : true
            }
        }).always(function(data){

            data = JSON.parse(data);

            var intervalo = data.retorno;
            $("#motivo_atraso").val("");

            if(parseInt(intervalo) > 3){

                $("#div_motivo_atraso").show();

            }else{

                $("#div_motivo_atraso").hide();

            }

        });

    });

    <?php
        if(strlen($os) == 0 || strlen($hd_chamado) > 0 || strlen($os) > 0 ){
    ?>

        $("#produto_grupo_defeito_constatado").change(function(){

            var familia_produto          = $("#produto_familia").val();
            var defeito_constatado_grupo = $(this).val();
            var posto                    = $("#posto_id").val();

            if(posto == ""){
                alert("Por favor insira o Posto Autorizado");
                $(this).val("");
                $("#posto_codigo").focus();
                return;
            }

            if(familia_produto != ""){

                $.ajax({
                    url: "<?php echo $_SERVER['PHP_SELF']; ?>",
                    type: "post",
                    data: {
                        ajax: true,
                        defeito_constatado_grupo : defeito_constatado_grupo,
                        familia : familia_produto,
                        posto : posto
                    },
                    beforeSend: function(){
                        $("#produto_defeito_constatado").html("<option value=''>aguarde...</option>");
                    }
                }).always(function(data){

                    data = JSON.parse(data);

                    $("#produto_defeito_constatado").html("<option value=''></option>");

                    $.each(data.retorno, function(key, value){
                        
                        var option = "<option value='"+value.defeito_constatado+"'>"+value.descricao+"</option>";

                        $("#produto_defeito_constatado").append(option);

                    });
                });

            }else{
                $(this).val("");
                alert("<?php echo traduz('selecione.um.produto');?>!");
                $("#produto_referencia").focus();
                return;
            }

        });

        $("#produto_defeito_constatado").change(function(){

            var defeito_constatado = $(this).val();

            $.ajax({
                url: "<?php echo $_SERVER['PHP_SELF']; ?>",
                type: "post",
                data: {
                    ajax: true,
                    defeito_constatado : defeito_constatado,
                    busca_defeito_constatado : true
                },
                beforeSend: function(){
                    $("#solucao").html("<option value=''>aguarde...</option>");
                }
            }).always(function(data){

                data = JSON.parse(data);

                $("#solucao").html("<option value=''></option>");

                $.each(data.retorno, function(key, value){

                    var option = "<option value='"+value.solucao+"'>"+value.descricao+"</option>";

                    $("#solucao").append(option);

                });
            });

        });

    <?php
        }
    }
    ?>

    /**
     * Evento de change do campo data abertura para não deixar o campo data compra ser maior
     */
    $("#data_abertura").change(function() {
        $("#data_compra").datepicker("destroy");
        $("#data_compra").datepicker({ maxDate: $("#data_abertura").datepicker("getDate") });
        $("#data_compra").datepicker("refresh");
    });

    // HD 6936556
    $("#data_abertura").change(function() {
        $("#data_entrada").datepicker("destroy");
        $("#data_entrada").datepicker({ maxDate: $("#data_abertura").datepicker("getDate") });
        $("#data_entrada").datepicker("refresh");
    });

    if ($("#data_abertura").val().length > 0 ) {
        $("#data_entrada").datepicker({ maxDate: $("#data_abertura").val() });
    };

    <?php
    if(in_array($login_fabrica, array(161))){

        if(count($msg_erro["msg"]) > 0 && strlen(getValue("os[data_compra]")) > 0){
            ?>
            $("#data_compra").datepicker();
            <?php
        }

    ?>
        $("#data_compra").keyup(function(){

            if($("#data_abertura").val() == ""){
                alert("<?php echo traduz('por.favor.insira.a.data.de.abertura');?>");
                $("#data_abertura").focus();
                $("#data_compra").val("");
            }

        });

        $("#data_compra").change(function(){

            if($("#data_abertura").val() == ""){
                alert("<?php echo traduz('por.favor.insira.a.data.de.abertura');?>");
                $("#data_abertura").focus();
                $("#data_compra").val("");
            }

        });
    <?php
    }
    
    if ($login_fabrica == 175) {
    ?>
        $('#data_compra').on('change', function() {
            verifica_garantia_produto();
        });
    <?php
    }
    ?>

    <?php if($login_fabrica == 35 and getValue('produto[deslocamento_km]') != 't' ) { ?>
        $(".grupo_tipo_atendimento").hide();
    <?php } ?>

    /**
     * Evento para verificar se o tipo de atendimento possui deslocamento
     * Se o atendimento possuir deslocamento mostra a div para calcular a distância do consumidor para o posto
     */
    var tipoAtendimentoOld = $("#tipo_atendimento").val();

    $("#tipo_atendimento").change(function() {
        
        var option = $(this).find("option:selected");

        <? if (in_array($login_fabrica, array(169,170))) {
        ?>
            if ($(option).text() == "Instalação" && verifica_peca_os()) {
                $(this).val(tipoAtendimentoOld);
                alert("<?php echo traduz('para.selecionar.este.tipo.de.atendimento.nao.pode.haver.pecas.lancadas.na.ordem.de.servico');?>");
                return false;
            } else {
                tipoAtendimentoOld = $(this).val();
            }

            if ($.trim($(option).text()) == 'Triagem') {
                
                $("#produto_pecas").hide();

                $("#tipo_atendimento option:not(:selected)").prop("disabled", true);

                $("#os_consumidor_revenda option[value=R]").prop("selected", true);
                $("#os_consumidor_revenda option[value=C]").prop("disabled", true);

                $("#div_produto_defeito_peca").show();

            } else if ($.trim($(option).text()) == 'Reoperação') {

                var optionReclamado = $("<option></option>", {
                    text: 'Reoperação',
                    value: '<?= get_reclamado_id('REOP') ?>',
                    selected: "selected"
                });

                var optionConstatado = $("<option></option>", {
                    text: 'Reoperação',
                    value: '<?= get_constatado_id('REOP') ?>',
                    selected: "selected"
                });

                $("#defeito_reclamado").html(optionReclamado);

                $("#tipo_atendimento option:not(:selected)").prop("disabled", true);

                $("#os_consumidor_revenda option[value=R]").prop("selected", true);
                $("#os_consumidor_revenda option[value=C]").prop("disabled", true);


            }

        <? }
        if ($login_fabrica == 163) { ?>
            var fora_garantia = $(option).attr("fora_garantia");
            var lupaPP = $("#pecas_produto").find("input[rel=peca_id]");
            var alertaPeca = false;

            if (fora_garantia == "t") {
                if (tipoAtendimentoOld !== $(this).val()) {
                    lupaPP.each(function(){
                        if ( ($(this).val() !== "" || $(this).val() !== "undefined" ) &&  $(this).val() > 0 ) {
                            alertaPeca = true;
                        }
                    });

                    if (alertaPeca) {
                        alert("<?php echo traduz('para.realizar.a.troca.do.tipo.de.atendomento.e.necessario.excluir.todas.as.pecas.lancadas');?>!");
                        $(this).val(tipoAtendimentoOld);
                        return false;
                    }
                }

                $("#nota_fiscal, #data_compra").prev("h5").hide();
            } else {
                $("#nota_fiscal, #data_compra").prev("h5").show();
            }

            tipoAtendimentoOld = $(this).val();

        <? }

        if (in_array($login_fabrica, [193])) { ?>

            var fora_garantia = $(option).attr("fora_garantia");

            if (fora_garantia == "t") {
                
                if ($("#nota_fiscal, #data_compra").prevAll("h5").length > 0) {
                    $("#nota_fiscal, #data_compra").attr("data-obrigatorio", 0);
                    $("#anexo_obrig").hide();   
                    $("#nota_obrigatoria").hide();
                    $("#nota_fiscal, #data_compra, #fabricante_motor, #revenda_nome, #revenda_cnpj, #revenda_estado, #revenda_cidade").prevAll("h5").hide();
                }

                $("div[id^=div_servicos_peca_]").each(function(idx){
                    $(this).find('option').hide();
                    /*$(this).find("option[codigo_servico=troca_peca_estoque]").show().prop("selected", true); */
                });

                
                $("select option[codigo_servico=troca_peca_estoque]").show().prop("selected", true);                        
                

            } else {
                $("#nota_fiscal, #data_compra").attr("data-obrigatorio", 0);
                $("#anexo_obrig").show();
                $("#nota_obrigatoria").show();
                $("#nota_fiscal, #data_compra, #fabricante_motor, #revenda_nome, #revenda_cnpj, #revenda_estado, #revenda_cidade").prevAll("h5").show();
            }
        <?php }

        if (in_array($login_fabrica, array(169,170))) { ?>
            var descricao = option.text();
            var grupo_atendimento = option.attr("grupo_atendimento");

            verifica_valores_adicionais();

            setTimeout(function(){
                busca_valor_adicional();
            },500);

            if (descricao == 'Triagem') {
                $("#check_reoperacao").show();
                if ($("#defeito_reclamado").val() == "") {
                    busca_defeito_reclamado();
                }
            } else {
                $("#os_reoperacao").prop("checked", false);
                $("#check_reoperacao").hide();
            }

            $("#produto_serie").trigger("change");

            if ($(option).attr("km_google") == 't') {
                $("#div_produto_retirado").show();
            }

            if ($(option).attr("fora_garantia") == "t") {
                $("#nota_fiscal").prev().hide();
                $("#nota_obrigatoria").hide();
                $("#data_compra").prev().hide();
                $("#anexo_obrig").hide();
            } else {
                if ($("#nota_fiscal").prev("h5").length > 0) {
                    $("#nota_fiscal").prev().show();
                } else {
                    $("#nota_fiscal").before("<h5 class='asteristico'>*</h5>");
                }

                if ($("#data_compra").prev("h5").length > 0) {
                    $("#data_compra").prev().show();
                } else {
                    $("#data_compra").before("<h5 class='asteristico'>*</h5>");
                }

                if ($("#nota_obrigatoria").length > 0) {
                    $("#nota_obrigatoria").show();
                } else {
                    $("#nota_fiscal").parents("div.control-group").find("label").after("<strong style='color:#B94A48' id='nota_obrigatoria'>(<?=traduz('Anexo Obrigatório')?>)</strong>");
                }

                if ($("#anexo_obrig").length > 0) {
                    $("#anexo_obrig").show();
                } else {
                    $("#anexo_nf_produto_obrig").before("<label class='label label-important' id='anexo_obrig'><?=traduz('Anexo(s) obrigatórios')?></label>");
                }
            }

            var produto_deslocamento_km = $("#produto_deslocamento_km").val();

            if ($(option).attr("fora_garantia") != "t") {
                if ($(option).attr("km_google") == 't' && produto_deslocamento_km == 'f' && $.inArray(grupo_atendimento, ['R','G']) == -1) {
                    alert("<?php echo traduz('para.o.produto.selecionado.nao.esta.habilitado.a.opcao.de.deslocamento');?>");
                    if (tipoAtendimentoOld !== $(this).val()) {
                        $(this).val(tipoAtendimentoOld);
                    }
                    return false;
                }

                if ($(option).attr("km_google") == 'f' && produto_deslocamento_km == 't' && $.inArray(grupo_atendimento, ['R','G']) == -1) {
                    alert("<?php echo traduz('para.o.produto.selecionado.nao.esta.habilitado.a.opcao.de.balcao');?>");
                    if (tipoAtendimentoOld !== $(this).val()) {
                        $(this).val(tipoAtendimentoOld);
                    }
                    return false;
                }
            }

            tipoAtendimentoOld = $(this).val();

            limitarTipoServicosParaAtendimentoForaGarantia();
        <? }

        if (in_array($login_fabrica, array(142))) { ?>
            var km_google               = $('#tipo_atendimento option:selected').attr("km_google");
            var produto_entrega_tecnica = $("#produto_entrega_tecnica").val();
            var produto_deslocamento_km = $("#produto_deslocamento_km").val();
            var produto_id              = $("#produto_id").val();

            if (km_google == "t" && produto_id.length > 0 && (produto_entrega_tecnica != "t" || produto_deslocamento_km != "t")) {
                alert("<?php echo traduz('o.tipo.de.atendimento.com.deslocamento.nao.esta.habilitado.para.o.produto.selecionado');?>");
                var tipo_balcao = $("#tipo_atendimento > option[km_google=f]").val();
                $("#tipo_atendimento").val(tipo_balcao);
                return false;
            }

        <? } else if (in_array($login_fabrica, array(157))) { ?>
            var km_google               = $('#tipo_atendimento option:selected').attr("km_google");
            var produto_deslocamento_km = $("#produto_deslocamento_km").val();
            var produto_id              = $("#produto_id").val();

            if (km_google == "t" && produto_id.length > 0 &&  produto_deslocamento_km != "t") {
                alert("<?php echo traduz('o.deslocamento.nao.esta.habilitado.para.o.produto.selecionado.o.tipo.de.atendimento.sera.alterado.para.balcao');?>");
                var tipo_balcao = $("#tipo_atendimento > option[km_google=f]").val();
                $("#tipo_atendimento").val(tipo_balcao);
                return false;
            }

            var visita_tecnica = $(this).find("option:selected").attr("visita_tecnica");

            if (typeof visita_tecnica != "undefined" && visita_tecnica == "t") {
                //$("input[name='os[defeito_reclamado]']").val("").attr("readOnly", true); HD-7648499
                $("input[name='os[defeito_reclamado]']").attr("readOnly", true);
                $("#produto_defeito_constatado").val("").selectreadonly(true);
                $("#produto_pecas").hide();

                $("button[name=remove_peca]").click();
            }else{
                //$("input[name='os[defeito_reclamado]']").val("").attr("readOnly", false); HD-7648499
                $("input[name='os[defeito_reclamado]']").attr("readOnly", false);
                $("#produto_defeito_constatado").val("").selectreadonly(false);
                $("#produto_pecas").show();
            }

        <? } else if ($login_fabrica == 158) { ?>
            var div_consumidor = $("#div_informacoes_consumidor");

            if ($(option).text().match(/Piso/gi)) {
                $(div_consumidor).find("h5.asteristico").remove();
                $("#produto_amperagem").prev("h5").remove();
            } else {
                $(div_consumidor).find("input,select").each(function() {
                    var obrigatorio = $(this).data("obrigatorio");

                    if (obrigatorio == true && $(this).prev("h5").length == 0) {
                        $(this).before("<h5 class='asteristico'>*</h5>");
                    }
                });

                if ($("#produto_amperagem").prev("h5").length == 0) {
                    $("#produto_amperagem").before("<h5 class='asteristico'>*</h5>");
                }
            }
        <? }

        if ($login_fabrica == 52) { ?>
            if ($(option).attr("km_google") == "t") {
                $("#div_informacoes_deslocamento").show();
                calcula_km(false);
            }
        <? } else { ?>
            if ($(option).attr("km_google") == "t" && $("#os_consumidor_revenda").val() == "C") {
                <?
                    if (in_array($login_fabrica, array(142,156,169,170))) {
                        if (in_array($login_fabrica, array(169,170)) AND $abre_os_dealer == 't'){
                ?>
                            $("#div_visita").hide();
                <?php
                        }else{
                ?>
                            $("#div_visita").show();
                <?php
                        }
                ?>
                <? }
                if (!in_array($login_fabrica, array(143,158,178))) { ?>
                    $("#div_informacoes_deslocamento").show();
                    try{
                        if(typeof $("#qtde_km").val() != "undefined" &&  $("#qtde_km").val().length > 0 ){
                            calcula_km(true);
                        }else{
                            calcula_km(false);
                        }
                    }catch(e){
                        //alert(e);
                    }
                <? } else if ($login_fabrica == 143) { ?>
                    verifica_tipo_posto_produto_linha();
                <? } ?>
            }
        <? }

        if (in_array($login_fabrica, $usa_km_revenda)) { ?>
            else if ($(option).attr("km_google") == "t" && $("#os_consumidor_revenda").val() == "R") {

                var revenda_nome = $("#revenda_nome").val();
                var revenda_cnpj = $("#revenda_cnpj").val();

                if(revenda_nome != "" && revenda_cnpj != ""){

                    $("#div_informacoes_deslocamento").show();

                    if(typeof $("#qtde_km").val() != "undefined" ||  $("#qtde_km").val().length > 0 ){
                      <? if ($login_fabrica == 156) { ?>
                          if ($("#qtde_km").val() == 0) {
                            try{
                                calcula_km(true);
                            }catch(e){
                                alert(e);
                            }
                          }
                      <? } ?>
                    }else{
                        try{
                            calcula_km(false);
                        }catch(e){
                            alert(e);
                        }
                    }
                }else{
                    $("#revenda_nome").focus();
                }
            }
        <? } ?>

        else {
            $("#div_informacoes_deslocamento").hide();

            <? if (in_array($login_fabrica, array(169,170))) { ?>
                if ($('#os_consumidor_revenda').val() != 'R') {
                    $("#qtde_km").val(0);
                    $("#qtde_km_hidden").val(0);
                }
            <? } else { ?>
                $("#qtde_km").val(0);
                $("#qtde_km_hidden").val(0);
            <? }

            if (in_array($login_fabrica, array(152,180,181,182))) { ?>
                $("#os_tempo_deslocamento").val(0);
            <? }

            if (in_array($login_fabrica, array(142,156,169,170))) { ?>
                $("#div_visita").hide()
                $("input[name='os[qtde_visita]']").val("");
            <? } ?>
        }

        <? if (in_array($login_fabrica, array(138))) { ?>
            var visita_tecnica = $(this).find("option:selected").attr("visita_tecnica");

            if (typeof visita_tecnica != "undefined" && visita_tecnica == "t") {
                $("#div_os_garantia").show();
                $("input[name='os[garantia]']").removeAttr("checked");
            } else {
                $("#div_os_garantia").hide();
                $("#div_subproduto_pecas").show();
            }

        <? }

        if (in_array($login_fabrica, array(152,180,181,182))) { ?>
            var visita_tecnica = $(this).find("option:selected").attr("visita_tecnica");

            if (typeof visita_tecnica != "undefined" && visita_tecnica == "t") {
                $("#div_defeito_reclamado").hide();
                $("#defeito_reclamado").attr({disabled:'disabled'});
            } else {
                $("#div_defeito_reclamado").show();
                $("#defeito_reclamado").removeAttr("disabled");
            }

        <? }

        if ($login_fabrica == 145) { ?>
            if ($(this).find("option:selected").val() == 201) {
                $('#troca_produto').show();

                $("div[name^=peca_]").each(function() {
                    $(this).find("select[name$='[servico_realizado]'] > option[troca_de_peca=t][gera_pedido=t][peca_estoque=f]").prop({ selected: "selected" });
                    $(this).find("select[name$='[servico_realizado]']").selectreadonly(true);
                });
                $("input[name='produto[troca_produto]']").checkreadonly(false);
            } else {
                $("#troca_produto").hide();
                $("input[name='produto[troca_produto]']").uncheck();
                $('#status_troca_produto').val("");

                $("div[name^=peca_]").each(function() {
                    $(this).find("select[name$='[servico_realizado]']").selectreadonly(false);
                });
            }

            if ($(this).find("option:selected").attr("fora_garantia") == "t" || $(this).find("option:selected").val() == 198) {
                $("#produto_pecas").hide();
            } else {
                $("#produto_pecas").show();
            }
        <? }

        if ($login_fabrica == 147) { ?>
            if ($(this).find("option:selected").val() == 215) {
                <? if(empty($os) and empty($preos)) { ?>
                    $("input[name=lupa_config][tipo=produto]").attr({ acessorio: 't' });
                <? } ?>
            }else {
                $("input[name=lupa_config][tipo=produto]").attr({ acessorio: 't' });
            }
            $("#produto_pecas").show();
        <? }

        if(in_array($login_fabrica, array(148))){ ?>
            /* Entrega Técnica */

            if ($(this).find("option:selected").attr("visita_tecnica") == "t") {

                if ($("#solucoes_multiplos").val().length > 0) {
                    alert("<?php echo traduz('remova.as.solucoes.para.selecionar.o.tipo.atendimento.entrega.tecnica');?>");
                    $("#tipo_atendimento").val("");
                    return false;
                }


                $("#defeito_reclamado").val("").prop({ "readonly": true }).prev("h5").hide();
                $("#produto_defeito_constatado").val("").selectreadonly(true);
                $("div.box_defeito_constatado").hide();
                $("#div_informacoes_solucao").hide();
                $("#solucao").val("");
                $("#produto_pecas").hide();
                $("div.box-solucoes").html("Selecione as Soluções");
                $("#solucoes_multiplos").val("");
                $(".box_intervalo_revisao").hide();
                $('#produto_intervalo_revisao').val("");

                <? if (isset($anexo_peca_os)) { ?>
                    var produto_id = $("#produto_id").val();
                <? } ?>

                $("#pecas_produto > div.row-fluid[name^=peca_]").each(function() {
                    <? if (isset($anexo_peca_os)) { ?>
                        if (typeof produto_id != "undefined" && produto_id.length > 0) {
                            var peca_id  = $(this).find("input[rel=peca_id]").val();
                            var produto_peca_id = produto_id+'_'+peca_id;

                            if ($("#div_peca_anexo").find("[id^=peca_anexo_"+produto_peca_id+']').length > 0) {
                                $("[id^=peca_anexo_"+produto_peca_id+']').remove(); // exclui todos...
                                $("input[name^=anexo_peca_upload_"+produto_peca_id+"]").each(function() {
                                    $(this).parent('form').remove();
                                });
                            }
                        }
                    <? } ?>

                    $(this).find("input").val("").removeAttr("readonly");
                    $(this).find("button[name=remove_peca]").hide();
                    $(this).find("span[rel=lupa_peca]").show();
                });

                <? if (isset($anexo_peca_os)) { ?>
                    $("#div_peca_anexo").hide();
                <? } ?>

                $($("#pecas_produto > div.row-fluid[name^=peca_]")[2]).nextAll("div.row-fluid[name^=peca_]").remove();
            } else {
                if ($(this).find("option:selected").attr("grupo_atendimento") == "R") {
                    $("#defeito_reclamado").val("").prop({ "readonly": true }).prev("h5").hide();
                    $(".box_intervalo_revisao").show();

                } else {
                    $("#defeito_reclamado").prop({ "readonly": false }).prev("h5").show();
                    $(".box_intervalo_revisao").hide();
                    $('#produto_intervalo_revisao').val("");
                }

                $("div.box_defeito_constatado").show();
                $("#produto_defeito_constatado").selectreadonly(false).show();
                $("#div_informacoes_solucao").show();
                $("#produto_pecas").show();
            }
        <? }

        if (in_array($login_fabrica, array(52)) && $areaAdmin == false) { ?>
            $("#qtde_km").attr("readonly", true);
        <? }

        if (in_array($login_fabrica, array(156))) { ?>

            if ($(this).find("option:selected").attr("fora_garantia") == "t") {
                $("#produto_pecas").hide();
                $("#fora_garantia").val("17");
            } else {
                $("#produto_pecas").show();
                $("#fora_garantia").val("");
            }

            if ($(this).val() == 247) {
                $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                    $(this).show();

                });
                $("div[id^=pecas_referencia_]").each(function() {
                    $(this).attr("class", "span2");
                });
                $("div[id^=pecas_descricao_]").each(function() {
                    $(this).attr("class", "span3");
                });
                $(".div_valor_total_pecas").attr("style", "display:block;");
            } else {
                $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                    $(this).hide();
                });
                $("div[id^=pecas_referencia_]").each(function() {
                    $(this).attr("class", "span2");
                });
                $("div[id^=pecas_descricao_]").each(function() {
                    $(this).attr("class", "span3");
                });
                $(".div_valor_total_pecas").attr("style", "display:none;");
            }
        <? }

        if ($login_fabrica == 158) { ?>
            if (option.attr("fora_garantia") == "t") {
                $("#patrimonio").before("<h5 class='asteristico'>*</h5>");
            } else {
                $("#patrimonio").prev("h5").remove();
            }
        <? }

        if ($login_fabrica == 163) { ?>
            //var lupaPP = $("#pecas_produto").find("input[name=lupa_config]");
            if ($(this).find("option:selected").attr("fora_garantia") == "t") {

                lupaPP.each(function(){
                    $(this).attr('preco_peca', true);
                });

                $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                    $(this).show();

                });
                $("div[id^=div_servicos_peca_]").each(function() {
                    $(this).find('select').val(servico_troca_peca_estoque);
                    $(this).hide();

                });
                // $("div[id^=pecas_referencia_]").each(function() {
                //  $(this).attr("class", "span2");
                // });
                // $("div[id^=pecas_descricao_]").each(function() {
                //  $(this).attr("class", "span3");
                // });
                $(".div_valor_total_pecas").show();

                calcula_valor_total_pecas(null, 'calcula_total');
            } else {
                lupaPP.each(function(){
                    $(this).removeAttr('preco_peca');
                });

                $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                    $(this).hide();
                });
                $("div[id^=div_servicos_peca_]").each(function() {
                    $(this).show();

                });
                $(".div_valor_total_pecas").hide();
            }
        <? }


        if (in_array($login_fabrica, array(161,167,177,186,190,191,195,203)) && ($areaAdmin == true || $postoInterno == true)) { ?>

            if($(this).val() != ""){

                if ($(this).val() == '<?=$id_orcamento; ?>') {
                    $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                        $(this).show();

                    });
                    $("div[id^=pecas_referencia_]").each(function() {
                        $(this).attr("class", "span2");
                    });
                    $("div[id^=pecas_descricao_]").each(function() {
                        $(this).attr("class", "span3");
                    });
                    $(".div_valor_total_pecas").show();

                    calcula_valor_total_pecas(null, 'calcula_total');

                } else {
                    $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                        $(this).hide();
                    });
                    $("div[id^=pecas_referencia_]").each(function() {
                        $(this).attr("class", "span3");
                    });
                    $("div[id^=pecas_descricao_]").each(function() {
                        $(this).attr("class", "span4");
                    });
                    $(".div_valor_total_pecas").hide();
                }

            }

        <? }

        if(in_array($login_fabrica, array(161))) { ?>
            if($(this).val() != ""){
                if ($(this).val() == <?=$id_orcamento?>) {
                    $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                        $(this).show();

                    });
                    $("div[id^=pecas_referencia_]").each(function() {
                        $(this).attr("class", "span2");
                    });
                    $("div[id^=pecas_descricao_]").each(function() {
                        $(this).attr("class", "span3");
                    });
                    $(".div_valor_total_pecas").show();

                    calcula_valor_total_pecas(null, 'calcula_total');

                } else {
                    $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                        $(this).hide();
                    });
                    $("div[id^=pecas_referencia_]").each(function() {
                        $(this).attr("class", "span3");
                    });
                    $("div[id^=pecas_descricao_]").each(function() {
                        $(this).attr("class", "span4");
                    });
                    $(".div_valor_total_pecas").hide();
                }

            }
        <? }

        if (in_array($login_fabrica, array(174,175)) ) { ?>
            var posto = $("#posto_id").val();    
            if (typeof posto != "undefined" || posto.length != 0) {
                verifica_servico_posto(posto);
            }
        <? } ?>

        <?php if ($login_fabrica == 178){ ?>
            if (option.attr("fora_garantia") == "t") {
                $("#div_solicita_troca_produto").hide();
                $("#div_enviar_para").hide();
                $("#div_marca_produto_troca").hide();
                $("#solicita_troca").prop('checked',false);
            }else{
                $("#div_solicita_troca_produto").show();
            }
        <?php } ?>

        <?php if ($login_fabrica == 175){ ?>
            if (option.attr("fora_garantia") == "f") {
                $("#aparencia_produto").before("<h5 class='asteristico'>*</h5>");
                $("#acessorios").before("<h5 class='asteristico'>*</h5>");
            } else {
                $("#aparencia_produto").prev("h5").remove();
                $("#acessorios").prev("h5").remove();
            }
        <?php } ?>

        <?php if (in_array($login_fabrica, [193])) { ?> 
        $("#div_tempo_conserto").hide();
        <?php } ?>

        <?php if ($login_fabrica == 148) { ?>
                if (option.html().toLowerCase() == "garantia") {
                    $(".div_produto_em_estoque").show();
                } else {
                    $(".div_produto_em_estoque").hide();
                }
        <?php } ?>
    });
<?php
if (in_array($login_fabrica, array(169,170))) { ?>

    $("#tipo_atendimento").change();

<?php
} ?>

    $("#tipo_atendimento").change();

    <? if ($login_fabrica == 163) { ?>
        var fora_garantia = $("#tipo_atendimento > option:selected").attr("fora_garantia");

        $("button.laudo-tecnico").on("click", function() {
            var btn = $(this);

            $(btn).prop({ disabled: true }).text("<?php echo traduz('processando');?>...");

            $.ajax({
                url: "verifica_s3_comunicado.php",
                type: "get",
                data: {
                    ajax: true,
                    fabrica: <?=$login_fabrica?>,
                    tipo: "Laudo Tecnico"
                },
                timeout: 60000
            }).fail(function(res) {
                alert("<?php echo traduz('erro.ao.buscar.audo.tecnico.tempo.limite.esgotado');?>");
                $(btn).prop({ disabled: false }).text("Laudo Técnico");
            }).done(function(url) {
                if (url.length > 0) {
                    window.open(url, "_blank");
                } else {
                    alert("<?php echo traduz('laudo.tecnico.nao.encontrado');?>");
                }

                $(btn).prop({ disabled: false }).text("Laudo Técnico");
            });
        });
    <? }


    if ($login_fabrica == 156) { ?>
        if ($("#tipo_atendimento").val() == 247) {
            $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                $(this).show();
            });
            $("div[id^=pecas_referencia_]").each(function() {
                $(this).attr("class", "span2");
            });
            $("div[id^=pecas_descricao_]").each(function() {
                $(this).attr("class", "span3");
            });
            $(".div_valor_total_pecas").attr("style", "display:block;");
        } else {
            $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                $(this).hide();
            });
            $("div[id^=pecas_referencia_]").each(function() {
                $(this).attr("class", "span2");
            });
            $("div[id^=pecas_descricao_]").each(function() {
                $(this).attr("class", "span3");
            });

            $(".div_valor_total_pecas").attr("style", "display:none;");
        }

        $("#produto_reparo_fabrica").click(function(){

            if($(this).is(":checked")){
                $("#linha_nf_envio").show();
                $("#produto_pecas").hide();
            } else {
                $("#linha_nf_envio").hide();
                $("#produto_pecas").show();
            }

        });
    <? }

    if (in_array($login_fabrica, array(161,167,177,203)) && ($areaAdmin == true || $postoInterno == true)) { ?>
        if($("#tipo_atendimento").val() != ""){
            if ($("#tipo_atendimento").val() == '<?=$id_orcamento?>') {
                $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                    $(this).show();
                });
                $("div[id^=pecas_referencia_]").each(function() {
                        $(this).attr("class", "span2");
                });
                $("div[id^=pecas_descricao_]").each(function() {
                        $(this).attr("class", "span3");
                });
                $(".div_valor_total_pecas").attr("style", "display:block;");
            } else {
                $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                        $(this).hide();
                });
                $("div[id^=pecas_referencia_]").each(function() {
                        $(this).attr("class", "span3");
                });
                $("div[id^=pecas_descricao_]").each(function() {
                        $(this).attr("class", "span4");
                });

                $(".div_valor_total_pecas").attr("style", "display:none;");
            }
        }
    <? }

    if (in_array($login_fabrica, array(145,164,165))) { ?>
        $("input[name='produto[troca_produto]']").change(function() {
            if ($(this).is(":checked")) {
                $('#status_troca_produto').val("proibido_trocar_peca");

                <? if (in_array($login_fabrica, array(164,165))) { ?>
                    $("#produto_pecas").hide();
                    $("#produto_defeito_constatado").selectreadonly(true);
                <? } else { ?>
                    $("button[name=adicionar_linha]").hide();

                    $("#pecas_produto > div.row-fluid[name^=peca_]").each(function() {
                        $(this).find("input[type!=checkbox]").val("").removeAttr("readonly");
                        $(this).find("button[name=remove_peca]").hide();
                        $(this).find("span[rel=lupa_peca]").show();
                    });
                <? } ?>

            } else {
                $('#status_troca_produto').val("");

                <? if (in_array($login_fabrica, array(164,165))) { ?>
                    $("#produto_pecas").show();
                    $("#produto_defeito_constatado").selectreadonly(false);
                <? } else { ?>
                    $("button[name=adicionar_linha]").show();
                <? } ?>
            }
        });
    <?php
    }

    if($login_fabrica == 148){
    ?>
        calcula_valor_total_pecas(null, "calcula_total");

        $("#produto_horimetro").change(function() {
            valida_tolerancia_horimetro_revisao($(this).val(), $("#produto_intervalo_revisao").val(), revisoes.tolerancia);
        });

        $(document).on("click", "button.carrega_revisoes", function() {
            var intervalo_revisoes = parseInt(revisoes.intervalo.horas);
            var ul                 = $("ul.selecionar_revisoes_ul");
            var ultima_revisao     = parseInt($(ul).find("li").last().data("revisao"));

            var max = ultima_revisao + (intervalo_revisoes * 25);

            var revisao = ultima_revisao + intervalo_revisoes;

            while(revisao <= max){
                $(ul).append("<li data-revisao='"+revisao+"' ><a href='#' >"+revisao+" horas</a></li>");

                revisao  += intervalo_revisoes
            }
        });

        $(document).on("click", "ul.selecionar_revisoes_ul a", function(e) {
            var revisao   = $(this).parent().data("revisao");
            var horimetro = $("#produto_horimetro").val();

            $("#produto_intervalo_revisao").val(revisao);

            Shadowbox.close();

            valida_tolerancia_horimetro_revisao(horimetro, revisao, revisoes.tolerancia);

            carregaRegrasRevisao();

            e.preventDefault();
        });

        $("label.selecionar_revisoes").click(function() {
            var primeira_revisao   = revisoes.primeira.horas;
            var intervalo_revisoes = parseInt(revisoes.intervalo.horas);

            var div = $("<div></div>", {
                class: "selecionar_revisoes_div"
            });

            var ul = $("<ul class='nav nav-list selecionar_revisoes_ul' style='overflow-y: scroll; overflow-x: hidden; height: 210px;'></ul>");

            $(ul).append("<li data-revisao='"+primeira_revisao+"' ><a href='#' >"+primeira_revisao+" horas</a></li>");

            var max = intervalo_revisoes * 25;

            var revisao = intervalo_revisoes;

            while(revisao <= max){
                $(ul).append("<li data-revisao='"+revisao+"' ><a href='#' >"+revisao+" horas</a></li>");

                revisao  += intervalo_revisoes
            }

            var button = $("<button />", { class: "btn btn-small btn-info btn-block carrega_revisoes", text: "Mostrar mais revisões" });

            $(div).append(ul).append(button);

            Shadowbox.open({
                content: "<fieldset><legend>Revisões</legend>"+$(div).html()+"</fieldset>",
                player: "html",
                width: 300,
                height: 300
            });
        });

        $("span.regra_revisao").click(function() {
            var acao    = $(this).data("revisao-acao");
            var revisao = $("#produto_intervalo_revisao").val();
            var horimetro = $("#produto_horimetro").val();

            if (!isNaN(revisao)) {
                revisao = parseInt(revisao);
            }

            switch(acao){
                case "-":
                    if (!isNaN(revisao) && revisao > 0) {
                        if (revisao == revisoes.primeira.horas) {
                            return false;
                        } else {
                            var nova_revisao = revisao - parseInt(revisoes.intervalo.horas);

                            $("#produto_intervalo_revisao").val(nova_revisao);
                            valida_tolerancia_horimetro_revisao(horimetro, nova_revisao, revisoes.tolerancia);
                        }
                    }
                    break;

                case "+":
                    if (!isNaN(revisao) && revisao > 0) {

                        var nova_revisao = revisao + parseInt(revisoes.intervalo.horas);

                        $("#produto_intervalo_revisao").val(nova_revisao);
                        valida_tolerancia_horimetro_revisao(horimetro, nova_revisao, revisoes.tolerancia);

                    } else {
                        $("#produto_intervalo_revisao").val(revisoes.primeira.horas);
                        valida_tolerancia_horimetro_revisao(horimetro, revisoes.primeira.horas, revisoes.tolerancia);
                    }
                    break;
            }

            carregaRegrasRevisao();
        });

    <?php
    }
    ?>

    /**
     * Evento para quando alterar o estado carregar as cidades do estado
     */
    $("select[id$=_estado]").change(function() {
        busca_cidade($(this).val(), ($(this).attr("id") == "revenda_estado") ? "revenda" : "consumidor");
    });

    /**
     * Evento para buscar o endereço do cep digitado
     */
    <?php if (($cook_idioma == 'pt-br' || $areaAdmin) && !in_array($login_fabrica, [180,181,182])) { ?>
        $("input[id$=_cep]").blur(function() {
            if ($(this).attr("readonly") == undefined) {
                busca_cep($(this).val(), ($(this).attr("id") == "revenda_cep") ? "revenda" : "consumidor");
            }
        });
    <?php } ?>

    /**
     * Evento para calcular o KM
     */
    $("#calcular_km").click(function() {
        try {

            <? if(in_array($login_fabrica, $usa_km_revenda)) { ?>
                if ($("#os_consumidor_revenda").val() == "R") {
                    calcula_km_revenda();
                } else {
                    calcula_km();
                }
            <? } else { ?>
                calcula_km();
            <? } ?>

        } catch(e) {
            alert(e.message);
        }
    });

    /**
     * Evento que adiciona uma nova linha de peça
     */
    $("button[name=adicionar_linha]").click(function() {
        if ($(this).attr("subproduto") == "t") {
            var nova_linha = $("#modelo_subproduto_peca").clone();

            var posicao = $("div.row-fluid[name^=subproduto_peca_][name!=subproduto_peca___modelo__]").length;

            $("#pecas_subproduto").append($(nova_linha).html().replace(/__modelo__/g, posicao).replace(/disabled\=['"]disabled['"]/g, ""));

            $("div.row-fluid[name=subproduto_peca_"+posicao+"]").find(".numeric").numeric();
        } else {
            var nova_linha = $("#modelo_peca").clone();
            var posicao = $("div.row-fluid[name^=peca_][name!=peca___modelo__]").length;

            $("#pecas_produto").append($(nova_linha).html().replace(/__modelo__/g, posicao).replace(/disabled\=['"]disabled['"]/g, ""));

            $("div.row-fluid[name=peca_"+posicao+"]").find(".numeric").numeric();

            <? if($login_fabrica == 153){ ?>
                var nova_linha_dev_obrig = $("#dev_obrig_modelo").clone();
                $("#pecas_produto").append($(nova_linha_dev_obrig).html().replace(/__modelo__/g, posicao).replace(/disabled\=['"]disabled['"]/g, ""));
            <? }
            if ($login_fabrica == 145) { ?>
                if ($("#tipo_atendimento").val() == 201) {
                    $("div[name=peca_"+posicao+"]").find("select[name$='[servico_realizado]']").selectreadonly(true);
                }
            <? }
            if ($login_fabrica == 163) { ?>
                if ($("#tipo_atendimento").find("option:selected").attr("fora_garantia") == "t") {
                    $("div[name=peca_"+posicao+"]").find("select[name$='[servico_realizado]']").val(servico_troca_peca_estoque);
                }
            <? }
            if ($login_fabrica == 156) { ?>
                if ($("#tipo_atendimento").val() != 247) {
                    $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                        $(this).hide();
                    });
                }
            <? } ?>
            <? if (in_array($login_fabrica,array(186,190,191,195))) { ?>

                if ($("#tipo_atendimento option:selected").text() != "Orçamento") {
                    $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                        $(this).hide();
                    });
                } else {
                    $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function(indi, valu) {
                        $(this).show();
                        <? if (in_array($login_fabrica,array(190)) && $areaAdmin == false) { ?>
                            $(".txt_valor_add").hide()
                            $("#valor_adicional").hide()
                            $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                                $(this).hide();
                            });
                        <? } ?>
                        $(".valor_peca").priceFormat({
                            prefix: '',
                            thousandsSeparator: '.',
                            centsSeparator: ',',
                            centsLimit: 2
                        });
                        $(".valor_total_peca").priceFormat({
                            prefix: '',
                            thousandsSeparator: '.',
                            centsSeparator: ',',
                            centsLimit: 2
                        });
                    });
                }
            <? } ?>
            
            <?php if ($login_fabrica == 177){ ?>
                if ($("#tipo_atendimento option:selected").text() == "Orçamento"){
                    $("#div_servicos_peca_"+posicao).hide();
                }
            <?php } ?>

            <?php if (in_array($login_fabrica, array(161,167,177,203)) && ($areaAdmin == true || $postoInterno == true)) { ?>
                var tipo_at = $("#tipo_atendimento").val();
                if(tipo_at.trim().length){
                    if (tipo_at != <?=$id_orcamento?>) {
                        $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                            $(this).hide();
                        });
                        $("div[id^=pecas_referencia_]").each(function() {
                            $(this).attr("class", "span3");
                        });
                        $("div[id^=pecas_descricao_]").each(function() {
                            $(this).attr("class", "span4");
                        });
                        $(".div_valor_total_pecas").attr("style", "display:none;");
                    } else {
                        $(".valor_peca").priceFormat({
                            prefix: '',
                            thousandsSeparator: '.',
                            centsSeparator: ',',
                            centsLimit: 2
                        });
                    }
                }
            <? }
            if ($login_fabrica == 148) { ?>
                    $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                        $(this).hide();
                    });
                    $(".input-append").removeClass("span10");
                    $(".input-append").addClass("span11");
            <? } ?>

            <?php if (in_array($login_fabrica, array(175,177))){ ?>
                $("div.row-fluid[name=peca_"+posicao+"]").after("<br/>");
            <?php  } ?>
        }
        <?php if($login_fabrica == 35){?>
            $(".po_pecas").mask("99999-999");
        <?php } ?>
    });

    <? if ($defeito_constatado_obriga_lancar_peca == true OR in_array($login_fabrica, array(162))) {
        if ($defeitoConstatadoMultiplo == false) { ?>

        /**
        * Evento que mostra a msg de peça obrigatoria conforme o Defeito Constatado.
        **/
        $("#produto_defeito_constatado").change(function() {
            <?php
            if ($defeitoConstatadoMultiplo) {
            ?>
                return false;
            <?php
            }
            ?>
            var lancar_peca_obrigatorio = $(this).find("option:selected").data("lancar-pecas");
            if ( lancar_peca_obrigatorio == "t") {
                peca_obrigatoria_defeito_constatado(true);
            } else {
                peca_obrigatoria_defeito_constatado(false);
            }
        });
    <?php
        }
    }
    ?>


    /**
     * Evento que limpa uma linha de peça
     */
    $(document).on("click", "button[name=remove_peca]", function() {
        var posicao = $(this).attr("rel");

        if ($(this).attr("subproduto") == "t") {
            var os_item = $("input[name='subproduto_pecas["+posicao+"][os_item]']").val();
        } else {
            var os_item = $("input[name='produto_pecas["+posicao+"][os_item]']").val();
        }

        if (os_item != undefined && os_item.length > 0) {
            var erro = false;

            $.ajax({
                async: false,
                url: "cadastro_os.php",
                type: "POST",
                data: { ajax: true, ajax_deleta_os_item: true, os_item: os_item },
                complete: function(data) {
                    data = $.parseJSON(data.responseText);

                    if (data.error) {
                        alert(data.error);
                        erro = true;
                    }
                }
            });

            if (erro === true) {
                return false;
            }
        }

        if ($(this).attr("subproduto") == "t") {
            <?php
            if (isset($anexo_peca_os)) {
            ?>
                var produto_id = $("#subproduto_id").val();
                var peca_id    = $("input[name='subproduto_pecas["+posicao+"][id]']").val();

                if ($("#div_peca_anexo_subproduto").find("#peca_anexo_"+produto_id+"_"+peca_id).length > 0) {
                    $("#peca_anexo_"+produto_id+"_"+peca_id).remove();
                    $("input[name=anexo_peca_upload_"+produto_id+"_"+peca_id+"]").parent("form").remove();

                    if ($("#div_peca_anexo_subproduto").find("li").length == 0) {
                        $("#div_peca_anexo_subproduto").hide();
                    }
                }
            <?php
            }
            ?>

            $("input[name='subproduto_pecas["+posicao+"][os_item]']").val("");
            $("input[name='subproduto_pecas["+posicao+"][id]']").val("");
            $("input[name='subproduto_pecas["+posicao+"][referencia]']").val("").removeAttr("readonly");
            $("input[name='subproduto_pecas["+posicao+"][descricao]']").val("").removeAttr("readonly");
            $("input[name='subproduto_pecas["+posicao+"][qtde]']").val("");
            $("select[name='subproduto_pecas["+posicao+"][servico_realizado]']").val("");

            $("div[name=subproduto_peca_"+posicao+"]").find("span[rel=lupa_peca]").show();
        } else {
            <?php
            if (isset($anexo_peca_os)) {
            ?>
                var produto_id = $("#produto_id").val();
                var peca_id    = $("input[name='produto_pecas["+posicao+"][id]']").val();

                if ($("#div_peca_anexo").find("#peca_anexo_"+produto_id+"_"+peca_id).length > 0) {
                    $("li[id^=peca_anexo_"+produto_id+"_"+peca_id+']').remove();
                    $("input[name^=anexo_peca_upload_"+produto_id+"_"+peca_id+"]").parent("form").remove();

                    if ($("#div_peca_anexo").find("li").length == 1) {
                        $("#div_peca_anexo").hide();
                    }
                }
            <?php
            }
            ?>

            $("input[name='produto_pecas["+posicao+"][os_item]']").val("");
            $("input[name='produto_pecas["+posicao+"][id]']").val("");
            $("input[name='produto_pecas["+posicao+"][referencia]']").val("").removeAttr("readonly");
            $("input[name='produto_pecas["+posicao+"][descricao]']").val("").removeAttr("readonly");
            $("input[name='produto_pecas["+posicao+"][qtde]']").val("").removeAttr("readonly");

            <?php if (in_array($login_fabrica, array(169,170))) { ?>
                $("select[name='produto_pecas["+posicao+"][servico_realizado]']").find('option').remove().end().append('<option value=""></option>').removeAttr("readonly");
                $("select[name='produto_pecas["+posicao+"][defeito_peca]']").find('option').remove().end().append('<option value=""></option>').removeAttr("readonly");
            <?php } else { ?>
                $("select[name='produto_pecas["+posicao+"][servico_realizado]']").val("");
                $("select[name='produto_pecas["+posicao+"][defeito_peca]']").val("");
            <?php } ?>

            // $("select[name='produto_pecas["+posicao+"][servico_realizado]']").find('option').remove().end().append('<option value=""></option>').removeAttr("readonly");
            // $("select[name='produto_pecas["+posicao+"][defeito_peca]']").find('option').remove().end().append('<option value=""></option>').removeAttr("readonly");

            // $("select[name='produto_pecas["+posicao+"][servico_realizado]']").val("").selectreadonly(false);
            // $("select[name='produto_pecas["+posicao+"][defeito_peca]']").val("").selectreadonly(false);

            $("div[name=peca_"+posicao+"]").find("span[rel=lupa_peca]").show();

            <? if(in_array($login_fabrica, [167, 203])){ //HD-3428297 ?>
                $("input[name='produto_pecas["+posicao+"][serie_peca]']").val("");
                $("input[name='produto_pecas["+posicao+"][valida_serie_peca]']").val("");
                $("#serie_peca_"+posicao).hide();
            <? } ?>

        }
        <?php if ($login_fabrica == 177){ ?>
            $("input[name='produto_pecas["+posicao+"][lote]']").val("");
            $("input[name='produto_pecas["+posicao+"][peca_lote]']").val("");
            //$("input[name='produto_pecas["+posicao+"][lote_nova]']").val("").removeAttr("readonly");
            $(".peca_lote"+posicao).hide();
        <?php } ?>
        <?php if ($login_fabrica == 175){ ?>
            $("input[name='produto_pecas["+posicao+"][quantidade_disparos]']").val("");
            $("input[name='produto_pecas["+posicao+"][numero_serie]']").val("");
            $("input[name='produto_pecas["+posicao+"][componente_raiz]']").val("");
            $("#div_numero_serie_peca"+posicao).hide();
            $("#div_qtde_disparos_peca"+posicao).hide();
            
            validaPecaAtendimento();

            var semPecas = true;
            $("#produto_pecas").find("input[rel=peca_id]").each(function(){
                var peca = $(this).val();
                if(peca.length > 0){
                    semPecas = false;
                }
            });

            if (semPecas) {
                $("#produto_serie").prop("readonly", false);
                $(".tooltip_serie").hide();
            }
        <?php } ?>

        <?php if ($login_fabrica == 178){ ?>
            $("select[name='produto_pecas["+posicao+"][servico_realizado]']").find("option").show();
        <?php } ?>

        $(this).parents("div.row-fluid").css({ "background-color": "transparent" });
        $(this).hide();

        <? if (in_array($login_fabrica, array(156,163)) || (in_array($login_fabrica, array(161,167,177,186,190,191,195,203)) && ($areaAdmin == true || $postoInterno == true))) { ?>

            calcula_valor_total_pecas(posicao, "remove");
        <? }
        if (in_array($login_fabrica, array(165,169,170))) { ?>
            var semPecas = true;
            $("#produto_pecas").find("input[rel=peca_id]").each(function(){
                var peca = $(this).val();
                if(peca.length > 0){
                    semPecas = false;
                }
            });

            if (semPecas) {
                $("#produto_defeito_constatado").selectreadonly(false);
                $(".box-defeitos").find(".removerDefeito").removeAttr("disabled");
            }
        <? } ?>
    
        <?php if ($login_fabrica == 183){ ?>
            $("select[name='produto_pecas["+posicao+"][codigo_utilizacao]']").val("");
        <?php } ?>
    });

    /**
     * Evento que clica no botão calcular km quando der blur no campo número
     */
    $("#consumidor_numero").blur(function() {
        <? if (in_array($login_fabrica, array(169,170)) && strlen(getValue("os[os_numero]")) > 0) { ?>
            return false;
        <? } ?>
        if ($("#div_informacoes_deslocamento").is(":visible")) {
            <? if (!($login_fabrica == 158 && !empty($os) && (verifica_tipo_posto("tecnico_proprio", "TRUE", getValue("posto[id]")) == true && (int) getValue('os[qtde_km]') > 0))) { ?>
                $("#calcular_km").click();
            <? } ?>
        }
    });

    /**
     * Bloqueia campo tipo atendimento Cadence em outra posição
    */
    <?php if($login_fabrica == 35){ ?>

        $("#tipo_atendimento").change(function(){
            if ($("#tipo_atendimento option:selected").attr("km_google") == "t") {
                $("#div_informacoes_deslocamento").show();
                calcula_km();
            }
        });

        if ($("#tipo_atendimento option:selected").val().length > 0) {
            $("#tipo_atendimento").attr({ readonly: "readonly" });
            if ($("#tipo_atendimento option:selected").attr("km_google") == "t") {
                $("#div_informacoes_deslocamento").show();
            }
        }

    <?php } ?>

    <?php if ($login_fabrica == 191 && strlen($os) > 0 && ($areaAdmin === true || $postoInterno == true)) { ?>



$("#div_informacoes_os input, #div_informacoes_consumidor input, #div_informacoes_revenda input, #div_informacoes_produto input, #div_informacoes_subproduto input").each(function() {
                nao_bloquear = ["consumidor[nome]","consumidor[cpf]","consumidor[cep]","consumidor[bairro]","consumidor[endereco]","consumidor[numero]","consumidor[complemento]","consumidor[celular]","consumidor[telefone]","consumidor[email]","os[data_abertura]","os[nota_fiscal]","revenda[nome]","revenda[cnpj]","revenda[cep]","revenda[bairro]","revenda[endereco]","revenda[numero]","revenda[telefone]","os[nota_fiscal]","os[pressao_agua]","os[data_compra]"];

            if ($(this).prev("h5").length > 0) {
                var bloqueia_campos = true;

                
                <?php if ($usaProdutoGenerico) { ?>
                    if ($.inArray($(this).attr("id"), ["produto_referencia", "produto_descricao", "produto_serie"]) != -1 && $(this).val().length == 0) {
                        bloqueia_campos = false;
                    }
                <? }?> 
                
           
                    if($(this).attr("type") == "radio" || $(this).attr("type") == "checkbox"){
                        var name = $(this).attr("name");
                        if($("input[name="+name+"]:checked").length == 0){
                            bloqueia_campos = false;
                        }
                    }

                

                if (bloqueia_campos == true) {
                    $(this).attr({ readonly: "readonly" });
                    $(this).unmask();

                    if ($(this).attr("id") == "data_abertura" || $(this).attr("id") == "data_compra") {
                        $(this).datepicker("destroy");
                    }

                    if ($(this).next("span[rel=lupa]").length > 0) {
                        $(this).next("span[rel=lupa]").hide();
                    }
                    

                    if ($(this).attr("type") == "checkbox") {
                        $(this).checkreadonly(true);
                    }

                    if ($(this).attr("type") == "radio") {
                        $(this).radioreadonly(true);
                    }

                    if ($(this).attr("id") == "consumidor_cpf") {
                        $(this).parents("div.control-group").find("input[type=radio]").remove();
                    }
                }
            } else if ($(this).val().length > 0) {
                
                var bloqueia_campos = true;

            
                if($(this).attr("id") == "envia_orcamento_email" && $("#tipo_atendimento > option:selected").text() == 'Orçamento') {
                    bloqueia_campos = false;
                }
           
                if($("#tipo_atendimento > option:selected").text() == 'Orçamento') {
                    bloqueia_campos = false;
                }
            
            
                if(bloqueia_campos == true){
                    $(this).attr({ readonly: "readonly" })
                    $(this).unmask();

                    if ($(this).attr("id") == "data_abertura" || $(this).attr("id") == "data_compra") {
                        $(this).datepicker("destroy");
                    }

                    if ($(this).next("span[rel=lupa]").length > 0) {
                        $(this).next("span[rel=lupa]").hide();
                    }

                    if ($(this).attr("type") == "checkbox") {
                        $(this).checkreadonly(true);
                    }

                    if ($(this).attr("type") == "radio") {
                        $(this).radioreadonly(true);
                    }

                    if ($(this).attr("id") == "consumidor_cpf") {
                        $(this).parents("div.control-group").find("input[type=radio]").remove();
                    }
                }
            }

        });

        $("#div_informacoes_os select, #div_informacoes_consumidor select, #div_informacoes_revenda select").each(function() {
            var option_remove = false;

            <?php if ($login_fabrica == 183) { ?>
                nao_bloquear = ["revenda[estado]","revenda[cidade]"];
                if ($.inArray($(this).attr("name"), nao_bloquear) != -1) {
                    return;
                }
            <?php } ?>

            <?php if (in_array($login_fabrica, array(165))) {?>
                if($(this).attr("name") == "os[id_tecnico]") {
                    return;
                }
            <? }

            if (in_array($login_fabrica, array(156))) { ?>
                if ($(this).attr("name") == "os[os_elgin_status]") {
                    return;
                }

                if ($(this).attr("name") == "os[tipo_atendimento]" && $(this).val().length == 0) {
                    return;
                }
            <? }

            if (in_array($login_fabrica, array(169,170))) {
                if (in_array("Número de Série inválido", $msg_erro["msg"])) {
                ?>
                    if ($(this).attr("id") == "produto_serie") {
                        return;
                    }
                <?php
                }
                ?>
                if ($(this).attr("name") == "os[tipo_atendimento]") {
                    return;
                }
            <?
            }

            if (in_array($login_fabrica, [171]) && verifica_pecas_lancadas($os)) { ?>

                nao_bloquear = ["consumidor[cidade]","consumidor[estado]","os[consumidor_revenda]","revenda[cidade]","revenda[estado]","os[tipo_atendimento]"];

                if ($.inArray($(this).attr("name"), nao_bloquear) != -1) {
                    return;
                }

            <? }

            if (in_array($login_fabrica, [184,200]) && verifica_pecas_lancadas($os)) { ?>
                    return;
            <?php
            } ?>

            if ($(this).prev("h5").length > 0) {
                <? if ($login_fabrica == 158) { ?>
                    if ($(this).val().length == 0) {
                        return;
                    }
                <? } ?>

                $(this).attr({ readonly: "readonly" });
                option_remove = true;
            } else if ($(this).val().length > 0) {
                $(this).attr({ readonly: "readonly" });
                option_remove = true;
            }
            <?php if (in_array($login_fabrica, [176]) && verifica_defeito_lancado($os) == false) { ?>
                option_remove = false;
                $(this).removeAttr("readonly");
            <? } ?>

            <?php
            if (in_array($login_fabrica, [175]) && !verifica_pedido_gerado($os)) { ?>
                option_remove = false;
                $(this).removeAttr("readonly");
            <?php
            }
            ?>
            <?php 
                if ($login_fabrica == 178){
                    if (verifica_defeito_lancado($os) == false OR verifica_pecas_lancadas($os)){
            ?>
                        var nao_bloquear = ["os[tipo_atendimento]"];
                        if ($.inArray($(this).attr("name"), nao_bloquear) != -1) {
                            option_remove = false;
                            $(this).removeAttr("readonly");
                        }
            <?php            
                    }
            ?>
                    if ($.inArray($(this).attr("id"), ["revenda_estado", "revenda_cidade"]) != -1 && $(this).val().length == 0) {
                        option_remove = false;
                        $(this).removeAttr("readonly");
                    }

                    if ($(this).attr("id") == "instalacao_publica") {
                        $(this).removeAttr("readonly");
                        option_remove = false;
                    }

            <?php
                } 
            ?>

            <?php if (in_array($login_fabrica, [148]) && verifica_defeito_lancado($os) == false) { ?>
                    campos_bloquear = ["revenda[estado]","revenda[cidade]"];
                    if ($.inArray($(this).attr("name"), campos_bloquear) != -1) {
                        $(this).attr({ readonly: "readonly" });
                    } else {
                         option_remove = false;
                        $(this).removeAttr("readonly");
                    }
                
            <? } ?>

            <? if (in_array($login_fabrica, array(145,158))) { ?>
                if ($(this).attr("id") == "tipo_atendimento" && $(this).val().length == 0) {
                    option_remove = false;
                }
            <? }

            if ($login_fabrica == 52 && strlen(getValue("os[tipo_atendimento]")) == 0) { ?>
                if($(this).attr("id") == "tipo_atendimento"){
                    option_remove = false;
                }
            <? }

            if (in_array($login_fabrica, [167,186,190,191,195,203])) { ?>

                var name = $(this).attr("name");
                if( name == "os[status_orcamento]"){
                    option_remove = false;
                }
            <? } ?>

            if (option_remove == true) {
                $(this).find("option").each(function() {
                    if (!$(this).is(":selected")) {
                        $(this).remove();
                    }
                });
            }

        });

    <?php } ?>

    /**
     * Bloqueia campos na area do posto
     */
    <? if ((strlen($os) > 0 && $areaAdmin === false && ($os_revenda !== true && ($login_unico == "" || ($login_fabrica == 175 && $login_unico != "")))) || $os_conjunto) { ?>
        $("#div_informacoes_os input, #div_informacoes_consumidor input, #div_informacoes_revenda input, #div_informacoes_produto input, #div_informacoes_subproduto input").each(function() {
            <?php if (in_array($login_fabrica, array(171))) { ?>
                nao_bloquear = ["consumidor[nome]","consumidor[cpf]","consumidor[cep]","consumidor[bairro]","consumidor[endereco]","consumidor[numero]","consumidor[complemento]","consumidor[celular]","consumidor[telefone]","consumidor[email]","os[data_abertura]","os[nota_fiscal]","revenda[nome]","revenda[cnpj]","revenda[cep]","revenda[bairro]","revenda[endereco]","revenda[numero]","revenda[telefone]","os[nota_fiscal]","os[pressao_agua]","os[data_compra]"];
            <?php } 

            if($login_fabrica == 164){?>
                nao_bloquear = ["consumidor[celular]","produto[numero_serie_calefator]","produto[cor_indicativa_carcaca]","produto[numero_serie_interno_placa_motor]"];

                if ($.inArray($(this).attr("name"), nao_bloquear) != -1) {
                    return;
                }
            <?php }

            if (in_array($login_fabrica, [203])) { ?>
                nao_bloquear = ["produto[recebido_via_correios]"];
            <?php } ?>

            if ($(this).prev("h5").length > 0) {
                var bloqueia_campos = true;

                <?php
                if ($login_fabrica == 144) { ?>
                    if ($(this).attr("id") == 'os_os_posto') {
                        bloqueia_campos = false;
                    }
                <?php
                } 

                if (in_array($login_fabrica, [186,190])) { ?>
                    if ($(this).attr("id") == "produto_serie" && $.trim($(this).val()) == "")  {
                        bloqueia_campos = false;
                    }
                <?php
                }

                if ($login_fabrica == 138) { ?>
                    if( ($(this).attr("id") == "subproduto_referencia" || $(this).attr("id") == "subproduto_descricao") && $(this).val() == "" ){
                        bloqueia_campos = false;
                    }
                <? }

                if (in_array($login_fabrica, [171]) && verifica_pecas_lancadas($os)) { ?>

                    if ($.inArray($(this).attr("name"), nao_bloquear) != -1) {
                        return;
                    }

                <? }

                if (in_array($login_fabrica, [203])) { ?>
                    if ($.inArray($(this).attr("name"), nao_bloquear) != -1) {
                        return;
                    }
                <?    
                }

                if (in_array($login_fabrica, [184,200]) && verifica_pecas_lancadas($os)) { ?>
                    return;
                <?php
                }

                 if ($login_fabrica == 178) { ?>
                    if ($.inArray($(this).attr("id"), ["defeito_reclamado", "produto_referencia", "produto_descricao", "revenda_nome", "revenda_cnpj", "produto_serie", "nota_fiscal", "data_compra", "revenda_cep"]) != -1 && $(this).val().length == 0) {
                        bloqueia_campos = false;
                    }
                <?php } ?>
          
                <?php if ($login_fabrica == 190){ ?>
                    if ($.inArray($(this).attr("id"), ["nota_fiscal", "data_compra", "defeito_reclamado"]) != -1 && $(this).val().length == 0) {
                        bloqueia_campos = false;
                    }
                <?php } ?>
          
                <?php if ($login_fabrica == 195){ ?>
                    if ($.inArray($(this).attr("id"), ["data_fabricacao"]) != -1 && $(this).val().length == 0) {
                        bloqueia_campos = false;
                    }
                <?php } ?>

                <?php if ($login_fabrica == 183){ ?>
                    if ($.inArray($(this).attr("id"), ["produto_serie"]) != -1 && $(this).val().length == 0) {
                        bloqueia_campos = false;
                    }
                    nao_bloquear = ["revenda[nome]","revenda[cnpj]","revenda[cep]","revenda[bairro]","revenda[endereco]","revenda[numero]","revenda[telefone]"];
                    if ($.inArray($(this).attr("name"), nao_bloquear) != -1) {
                        return;
                    }
                <?php } ?>
                
                <?php if ($usaProdutoGenerico) { ?>
                    if ($.inArray($(this).attr("id"), ["produto_referencia", "produto_descricao", "produto_serie"]) != -1 && $(this).val().length == 0) {
                        bloqueia_campos = false;
                    }
                <? }
                if (in_array($login_fabrica, array(156,158,180,181,182))) { ?>
                    if ($(this).val().length == 0) {
                        return;
                    }

                    if ($(this).attr("id") == "produto_amperagem" && $(this).val().length == 0) {
                        return;
                    }
                <? }
                if ($login_fabrica == 158) { ?>
                    if ($(this).attr("id") == "produto_amperagem") {
                        return;
                    }
                <? }
                if ($login_fabrica == 156) { ?>
                    if (
                        $(this).attr("id") == "os_data_nota_fiscal_mo"
                        || $(this).attr("id") == "os_data_nota_fiscal_peca"
                        || $(this).attr("id") == "data_nf_envio"
                    ) {
                        $(this).datepicker("destroy");
                    }
                <? }
                if (in_array($login_fabrica, array(169,170))) {
                    if (in_array("Número de Série inválido", $msg_erro["msg"])) { ?>
                        if ($(this).attr("id") == "produto_serie") {
                            return;
                        }
                    <? } ?>
                    if ($(this).val().length == 0) {
                        return;
                    }

                    var nao_bloqueia = ["produto_retirado_oficina", "produto_emprestimo"];
                    <?php if (isset($_GET['chave_os_conjunto'])) { ?>
                        nao_bloqueia.push('produto_serie');
                        nao_bloqueia.push('produto_referencia');
                        nao_bloqueia.push('produto_descricao');
                    <?php }
                    if (isset($_GET['os_id'])) {
                        $sql_defeitos_multiplos = "SELECT defeito_constatado, tempo_reparo FROM tbl_os_defeito_reclamado_constatado WHERE os = ".$_GET['os_id']." AND defeito_constatado IS NOT NULL";
                        $res_defeitos_multiplos = pg_query($con, $sql_defeitos_multiplos);
                        if (pg_num_rows($res_defeitos_multiplos) == 0 && empty(getValue('produto[serie]'))) {
                        ?>
                            nao_bloqueia.push('produto_serie');
                        <?php
                        }
            ?>
                    nao_bloqueia.push('nota_fiscal');
                    nao_bloqueia.push('data_compra');
            <?php
                    }
                    if(in_array("produto[serie]", $msg_erro['campos'])){
                    ?>
                        nao_bloqueia.push('produto_serie');
                    <?php
                    }
                    ?>

                    if ($.inArray($(this).attr("id"), nao_bloqueia) != -1) {
                        bloqueia_campos = false;
                    }
            <?  }

                if($postoInterno == true) { ?>
                    if($(this).attr("type") == "radio" || $(this).attr("type") == "checkbox"){
                        var name = $(this).attr("name");
                        if($("input[name="+name+"]:checked").length == 0){
                            bloqueia_campos = false;
                        }
                    }
                <? } ?>

                <?php if (in_array($login_fabrica, [148,176]) && verifica_defeito_lancado($os) == false) { ?>
                    bloqueia_campos = false;
                <? }
                if (in_array($login_fabrica, [175]) && !verifica_pedido_gerado($os)) { ?>
                    bloqueia_campos = false;
                <?php } ?>

                if (bloqueia_campos == true) {
                    $(this).attr({ readonly: "readonly" });
                    $(this).unmask();

                    if ($(this).attr("id") == "data_abertura" || $(this).attr("id") == "data_compra") {
                        $(this).datepicker("destroy");
                    }

                    if ($(this).next("span[rel=lupa]").length > 0) {
                        $(this).next("span[rel=lupa]").hide();
                    }
                    <?php if (in_array($login_fabrica, array(169,170))) { ?>
                    if ($(this).next("span[rel=lupa_produto]").length > 0) {
                        $(this).next("span[rel=lupa_produto]").hide();
                    }
                    <?php } ?>

                    if ($(this).attr("type") == "checkbox") {
                        $(this).checkreadonly(true);
                    }

                    if ($(this).attr("type") == "radio") {
                        $(this).radioreadonly(true);
                    }

                    if ($(this).attr("id") == "consumidor_cpf") {
                        $(this).parents("div.control-group").find("input[type=radio]").remove();
                    }
                }
            } else if ($(this).val().length > 0) {
                <?php
                if (in_array($login_fabrica, [171]) && verifica_pecas_lancadas($os)) { ?>

                    if ($.inArray($(this).attr("name"), nao_bloquear) != -1) {
                        return;
                    }

                    if ($(this).attr("id") == "data_compra" && $(this).val() != "") {
                         bloqueia_campos = false;
                    }

                <? }

                if (in_array($login_fabrica, [203])) { ?>
                    if ($.inArray($(this).attr("name"), nao_bloquear) != -1) {
                        return;
                    }
                <?    
                } 

                if (in_array($login_fabrica, [184,200]) && verifica_pecas_lancadas($os)) { ?>
                    return;
                <?php
                }

                if (in_array($login_fabrica, array(142,156,169,170))) { ?>
                    if ($(this).attr("name") == "os[qtde_visita]") {
                        return;
                    }
                <? }
                if (in_array($login_fabrica, array(152,180,181,182))) { ?>
                    if ($(this).parents("table.box-defeitos").length > 0) {
                        bloqueia_campos = false;
                    }
                <? }

                if ($login_fabrica == 151) { ?>
                    if ($(this).attr("id") == "produto_serie") {
                        if( $(this).val().length == 0 ) {
                            return;
                        }
                    }
                <? }
                if (in_array($login_fabrica, array(164,165))) {  ?>
                    if ($(this).attr("name") == "produto[troca_produto]") {
                        return;
                    }
                <? } ?>

                var bloqueia_campos = true;
                  <?
                 if ($login_fabrica == 171) { ?>
                    if ($(this).attr("id") == "consumidor_edificio") {
                         bloqueia_campos = false;
                    }

                    if ($(this).attr("id") == "tempo_uso") {
                         bloqueia_campos = false;
                    }

                <? }

                 if ($login_fabrica == 138) { ?>
                    if( ($(this).attr("id") == "subproduto_referencia" || $(this).attr("id") == "subproduto_descricao") && $(this).val() == "" ){
                        bloqueia_campos = false;
                    }
                <? }

                if ($login_fabrica == 193){ ?>
                    if( $(this).attr("id") == "check_troca_produto" && !$('#cpf_cnpj').is(":checked")){
                        bloqueia_campos = false;
                    }
                <?php }

                if ($login_fabrica == 156) { ?>
                    if (
                        $(this).attr("id") == "os_data_nota_fiscal_mo"
                        || $(this).attr("id") == "os_data_nota_fiscal_peca"
                        || $(this).attr("id") == "data_nf_envio"
                    ) {
                        $(this).datepicker("destroy");
                    }
                <? }
                if (in_array($login_fabrica, array(169,170))) { ?>
                    if ($.inArray($(this).attr("id"), ["produto_retirado_oficina", "produto_emprestimo"]) != -1) {
                        bloqueia_campos = false;
                    }
                <? } ?>

                <?php if ($login_fabrica == 178){ ?>
                    if ($.inArray($(this).attr("id"), ["solicita_troca"]) != -1) {
                        bloqueia_campos = false;
                    }
                <?php } ?>
                <?php if (in_array($login_fabrica, [148,176]) && verifica_defeito_lancado($os) == false) { ?>
                    bloqueia_campos = false;
				<? } ?>

                <?php
                if (in_array($login_fabrica, [175]) && !verifica_pedido_gerado($os)) { ?>
                    bloqueia_campos = false;
                <?php
                }
                ?>

				<?php if ($login_fabrica == 148 && strpos($msg_erro['msg'],'metro menor') !== false) { ?>
					var nao_bloqueia = ["produto_horimetro"];
					if ($.inArray($(this).attr("id"), nao_bloqueia) != -1) {
                        bloqueia_campos = false;
                    }

                <? }
                if (in_array($login_fabrica, [186,190,191,195])) { ?>

                    if($(this).attr("id") == "envia_orcamento_email" && $("#tipo_atendimento > option:selected").text() == 'Orçamento') {
                        bloqueia_campos = false;
                    }
                <? } 

                 if (in_array($login_fabrica,[191])) { ?>
                    if($("#tipo_atendimento > option:selected").text() == 'Orçamento') {
                        bloqueia_campos = false;
                    }
                <? } ?>
                
                if(bloqueia_campos == true){
                    $(this).attr({ readonly: "readonly" })
                    $(this).unmask();

                    if ($(this).attr("id") == "data_abertura" || $(this).attr("id") == "data_compra") {
                        $(this).datepicker("destroy");
                    }

                    if ($(this).next("span[rel=lupa]").length > 0) {
                        $(this).next("span[rel=lupa]").hide();
                    }

                    if ($(this).attr("type") == "checkbox") {
                       $(this).checkreadonly(true);
                    }

                    if ($(this).attr("type") == "radio") {
                        $(this).radioreadonly(true);
                    }

                    if ($(this).attr("id") == "consumidor_cpf") {
                        $(this).parents("div.control-group").find("input[type=radio]").remove();
                    }
                }
            }

        });

        $("#div_informacoes_os select, #div_informacoes_consumidor select, #div_informacoes_revenda select").each(function() {
            var option_remove = false;

            <?php if ($login_fabrica == 183) { ?>
                nao_bloquear = ["revenda[estado]","revenda[cidade]"];
                if ($.inArray($(this).attr("name"), nao_bloquear) != -1) {
                    return;
                }
            <?php } ?>

            <?php if (in_array($login_fabrica, array(165))) {?>
                if($(this).attr("name") == "os[id_tecnico]") {
                    return;
                }
            <? }

            if (in_array($login_fabrica, array(156))) { ?>
                if ($(this).attr("name") == "os[os_elgin_status]") {
                    return;
                }

                if ($(this).attr("name") == "os[tipo_atendimento]" && $(this).val().length == 0) {
                    return;
                }
            <? }

            if (in_array($login_fabrica, array(169,170))) {
                if (in_array("Número de Série inválido", $msg_erro["msg"])) {
                ?>
                    if ($(this).attr("id") == "produto_serie") {
                        return;
                    }
                <?php
                }
                ?>
                if ($(this).attr("name") == "os[tipo_atendimento]") {
                    return;
                }
            <?
            }

            if (in_array($login_fabrica, [171]) && verifica_pecas_lancadas($os)) { ?>

                nao_bloquear = ["consumidor[cidade]","consumidor[estado]","os[consumidor_revenda]","revenda[cidade]","revenda[estado]","os[tipo_atendimento]"];

                if ($.inArray($(this).attr("name"), nao_bloquear) != -1) {
                    return;
                }

            <? }

            if (in_array($login_fabrica, [184,200]) && verifica_pecas_lancadas($os)) { ?>
                    return;
            <?php
            } 
	    if (in_array($login_fabrica, [180,181,182])) { ?>
		if ($(this).val().length == 0) {
                    return;
                }
	    <?php } ?>

            if ($(this).prev("h5").length > 0) {
                <? if ($login_fabrica == 158) { ?>
                    if ($(this).val().length == 0) {
                        return;
                    }
                <? } ?>

                $(this).attr({ readonly: "readonly" });
                option_remove = true;
            } else if ($(this).val().length > 0) {
                $(this).attr({ readonly: "readonly" });
                option_remove = true;
            }
            <?php if (in_array($login_fabrica, [176]) && verifica_defeito_lancado($os) == false) { ?>
                option_remove = false;
                $(this).removeAttr("readonly");
            <? } ?>

            <?php
            if (in_array($login_fabrica, [175]) && !verifica_pedido_gerado($os)) { ?>
                option_remove = false;
                $(this).removeAttr("readonly");
            <?php
            }
            ?>
            <?php 
                if ($login_fabrica == 178){
                    if (verifica_defeito_lancado($os) == false OR verifica_pecas_lancadas($os)){
            ?>
                        var nao_bloquear = ["os[tipo_atendimento]"];
                        if ($.inArray($(this).attr("name"), nao_bloquear) != -1) {
                            option_remove = false;
                            $(this).removeAttr("readonly");
                        }
            <?php            
                    }
            ?>
                    if ($.inArray($(this).attr("id"), ["revenda_estado", "revenda_cidade"]) != -1 && $(this).val().length == 0) {
                        option_remove = false;
                        $(this).removeAttr("readonly");
                    }

                    if ($(this).attr("id") == "instalacao_publica") {
                        $(this).removeAttr("readonly");
                        option_remove = false;
                    }

                    <?php if (verifica_pedido_gerado($os) == false) { ?>
                        $(this).removeAttr("readonly");
                        option_remove = false;
                    <?php } ?>

            <?php
                } 
            ?>

            <?php if (in_array($login_fabrica, [148]) && verifica_defeito_lancado($os) == false) { ?>
                    campos_bloquear = ["revenda[estado]","revenda[cidade]"];
                    if ($.inArray($(this).attr("name"), campos_bloquear) != -1) {
                        $(this).attr({ readonly: "readonly" });
                    } else {
                         option_remove = false;
                        $(this).removeAttr("readonly");
                    }
                
            <? } ?>

            <? if (in_array($login_fabrica, array(145,158))) { ?>
                if ($(this).attr("id") == "tipo_atendimento" && $(this).val().length == 0) {
                    option_remove = false;
                }
            <? }

            if ($login_fabrica == 52 && strlen(getValue("os[tipo_atendimento]")) == 0) { ?>
                if($(this).attr("id") == "tipo_atendimento"){
                    option_remove = false;
                }
            <? }

            if (in_array($login_fabrica, [167,186,190,191,195,203])) { ?>

                var name = $(this).attr("name");
                if( name == "os[status_orcamento]"){
                    option_remove = false;
                }
            <? } ?>

            if (option_remove == true) {
                $(this).find("option").each(function() {
                    if (!$(this).is(":selected")) {
                        $(this).remove();
                    }
                });
            }

        });

    <? if (in_array($login_fabrica, [167,186,190,191,195,203])) { ?>

        if($("#tipo_atendimento option:selected").text() == 'Orçamento'){
            $("select[name='os[status_orcamento]']").attr('readonly',false);
            $("div[id^='div_servicos_peca_'").hide();
        }
    <? }
    }

    if ($login_fabrica == 158 && !empty($hd_chamado) && !empty($os) && $areaAdmin == true) { ?>
        $("#tipo_atendimento").selectreadonly(true);
        $("#unidade_negocio").attr({"readonly":true});
    <? }

    if (strlen($os) > 0 && $areaAdmin === false && $os_revenda == true) { ?>
        $("#div_informacoes_os input, #div_informacoes_revenda input, #div_informacoes_produto input, #div_informacoes_subproduto input, #div_informacoes_deslocamento input, #div_observacoes textarea").each(function() {
		if ($.trim($(this).val()).length > 0 && $(this).prev("h5").length > 0) {

		<? if(in_array($login_fabrica,[186,190])){ ?>
		nao_bloquear = ["consumidor[nome]","consumidor[cpf]","consumidor[cep]","consumidor[bairro]","consumidor[endereco]","consumidor[numero]","consumidor[complemento]","consumidor[celular]","consumidor[telefone]","consumidor[email]"];	
		<? } ?>

                <? if ($login_fabrica == 151) { ?>
                    if ($(this).attr("id") == "produto_serie") {
                        return;
                    }
                <? }
                if ($login_fabrica == 158) { ?>
                    if ($(this).attr("id") == "produto_amperagem") {
                        return;
                    }
                <? } ?>

                var bloqueia_campos = true;

                <? if ($login_fabrica == 138) { ?>
                    if( ($(this).attr("id") == "subproduto_referencia" || $(this).attr("id") == "subproduto_descricao") && $(this).val() == "" ){
                        bloqueia_campos = false;
                    }
                <? }

                if (in_array($login_fabrica, array(169,170))) {
                    if (in_array("Número de Série inválido", $msg_erro["msg"])) { ?>
                        if ($(this).attr("id") == "produto_serie") {
                            return;
                        }
                    <?php } ?>

                    if ($(this).attr("name") == "desc_defeito_reclamado" && $(this).val() == "") {
                        return;
                    }
                <?php }
                if ($login_fabrica == 156) { ?>
                    if (
                        $(this).attr("id") == "os_data_nota_fiscal_mo"
                        || $(this).attr("id") == "os_data_nota_fiscal_peca"
                        || $(this).attr("id") == "data_nf_envio"
                    ) {
                        $(this).datepicker("destroy");
                    }
                <? } ?>

                if($(this).attr("type") == "radio" || $(this).attr("type") == "checkbox"){
                    var name = $(this).attr("name");

                    if($("input[name="+name+"]:checked").length == 0){
                        bloqueia_campos = false;
                    }
                }

                <?php if (in_array($login_fabrica, [186,190,191,195])) { ?>

                    if($(this).attr("id") == "envia_orcamento_email" && $("#tipo_atendimento > option:selected").text() == 'Orçamento'){
                        bloqueia_campos = false;
                    }
                <?php } ?>

                 <?php if (in_array($login_fabrica,[191])) { ?>
                    if($("#tipo_atendimento > option:selected").text() == 'Orçamento'){
                        bloqueia_campos = false;
                    }
                <?php } ?>

                if(bloqueia_campos == true){
                    $(this).attr({ readonly: "readonly" });

                    if ($(this).attr("id") == "data_abertura" || $(this).attr("id") == "data_compra") {
                        $(this).datepicker("destroy");
                    }

                    if ($(this).next("span[rel=lupa]").length > 0) {
                        $(this).next("span[rel=lupa]").hide();
                    }

                    if ($(this).attr("type") == "checkbox") {
                        $(this).checkreadonly(true);
                    }

                    if ($(this).attr("type") == "radio") {
                        $(this).radioreadonly(true);
                    }
                }

            }
        });

        $("#div_informacoes_os select, #div_informacoes_revenda select").each(function() {

            <? if (in_array($login_fabrica, array(156))) { ?>

                if($(this).attr("name") == "os[os_elgin_status]") {
                    return;
                }

                if ($(this).attr("name") == "os[tipo_atendimento]" && $(this).val().length == 0) {
                    return;
                }

            <? }
            if (in_array($login_fabrica, array(169,170))) { ?>
                if ($(this).attr("name") == "os[tipo_atendimento]") {
                    return;
                }
            <? }
            if (!in_array($login_fabrica, array(156,165,178)) && !$postoInterno) { ?>
                var option_remove = false;

                if ($.trim($(this).val()).length > 0 && $(this).prev("h5").length > 0) {
                    $(this).attr({ readonly: "readonly" });
                    option_remove = true;
                }
                if (option_remove == true) {
                    $(this).find("option").each(function() {
                        if (!$(this).is(":selected")) {
                            $(this).remove();
                        }
                    });
                }
            <? } ?>

            // HD-7688476
            <?php if (in_array($login_fabrica, [178])) { ?> 
                var nao_bloquear = ["os[tipo_atendimento]"];
                if ($.inArray($(this).attr("name"), nao_bloquear) != -1) {
                    option_remove = false;
                    $(this).removeAttr("readonly");
                }
            <?php } ?>
        });
    <?php
    }

    if (in_array($login_fabrica, [186])) {
    ?> 
        if ($("#revenda_cnpj").attr("readonly") == "readonly") {
            $("#cpf_cnpj_revenda").closest("label").html("CPF/CNPJ");
        }

        $("input[name='revenda[cnpjCpf]']").click(function(){
            var tipo = $(this).val();

            $("#revenda_cnpj").unmask();
            if(tipo == 'cnpj'){
                $("#revenda_cnpj").mask("99.999.999/9999-99",{placeholder:""});
            }else{
                $("#revenda_cnpj").mask("999.999.999-99",{placeholder:""});
            }
        });

        $("input[name='revenda[cnpjCpf]']:checked").click();

    <?php
    } else if ($cook_idioma == "pt-br") { ?>
        $("#revenda_cnpj").mask("99.999.999/9999-99",{placeholder:""});
    <?php
    }

    if (strlen($os) > 0) {
        if($login_fabrica == 151){
        ?>
            if($("#produto_serie").val().length > 0) {
                $("#produto_serie").prop({"readonly" : true});
            }

            $("#div_trocar_produto").show();
            $("#div_trocar_subproduto").show();

            $(".produto_referencia").each(function(){
                var pecas = $(this).val();

                if(pecas.length > 0){
                    $("#div_trocar_produto").hide();
                    $("#div_trocar_subproduto").hide();
                }
            });
        <?php
        } else {
            if($login_fabrica == 153){ //hd_chamado=2813100
            ?>
                <?php if (true === $areaAdmin): ?>
                if (!verificaPecas()) {
                    $("#div_trocar_produto").show();
                    $(".linha_prod_s_ns").hide();
                }
                <?php endif ?>
                $("#div_trocar_subproduto").hide();
            <?php
            }elseif(!in_array($login_fabrica, array(156,158)) && strlen($j_os_produto = getValue("produto[os_produto]")) > 0){
                $j_defeito_constatado = getValue("produto[defeito_constatado]"); // HD - 6803754 - JP
                $j_causa_defeito = getValue("produto[causa_defeito]");

                if( $login_fabrica == 177 ){
                    if( empty($j_causa_defeito) AND !empty($login_posto) ){
                        echo "$(\"#div_trocar_produto\").show();";
                    }elseif( empty($j_defeito_constatado) AND empty($login_posto) ){
                        echo "$(\"#div_trocar_produto\").show();";
                    }
                } else if (!in_array($login_fabrica, [184,195,200]) || (in_array($login_fabrica, [184,195,200]) && !verifica_pecas_lancadas($os))) {
                    echo "$(\"#div_trocar_produto\").hide();";
                    echo "$(\"#div_trocar_subproduto\").hide();";
                } 
            }
        }
    }

    if(in_array($login_fabrica, array(169,170)) AND strlen($os) > 0){

    ?>
        if($("#produto_serie").val() == ""){
            $("#div_trocar_produto").show();
        }
        if($("#defeitos_constatados_multiplos").val() == ""){
            $("#div_trocar_produto").show();
        }

        $("#div_trocar_produto, #trocar_produto").show();

    <?php
    }

    if (in_array($login_fabrica, [148,176,186]) && verifica_defeito_lancado($os) == false){
    ?>
        $("#div_trocar_produto").show();
    <?php
    }

    if (in_array($login_fabrica, [131,175]) && !verifica_pedido_gerado($os)) { ?>
        $("#div_trocar_produto").show();
    <?php
    }

    if(in_array($login_fabrica, array(161))){
    ?>

        function limpa_revenda_produto(load_estados){

            $("#div_informacoes_revenda input").each(function(){

                $(this).attr({ readonly: "readonly" });
                $(this).unmask();
                $(this).val("");

                if ($(this).next("span[rel=lupa]").length > 0) {
                    $(this).next("span[rel=lupa]").hide();
                }

            });

            $("#div_informacoes_revenda select").each(function(){

                if($(this).attr("id") == "revenda_cidade"){
                    $(this).html("<option value=''></option>");
                }

                $(this).attr({ readonly: "readonly" });
                $(this).selectreadonly(true);
            });

            if(load_estados == true){
                $("#revenda_estado").html("");
                recarrega_estados($("#revenda_estado"));
            }

        }

        function bloqueia_revenda(){
            var os = '<?=$_REQUEST["os_id"]?>';
            if ($('#sem_ns').is(':checked')) {

                $("#div_informacoes_revenda input").each(function(){

                    $(this).removeAttr("readonly");

                    if ($(this).next("span[rel=lupa]").length > 0) {
                        $(this).next("span[rel=lupa]").show();
                    }

                });
                $("#revenda_cnpj").mask("99.999.999/9999-99",{placeholder:""});
                $("#revenda_cep").mask("99999-999",{placeholder:""});

                $("#div_informacoes_revenda select").each(function(){
                    $(this).removeAttr("readonly");
                    $(this).selectreadonly(false);
                });

                if (os != "" && os != undefined) {
                    $("#produto_referencia").attr("readonly", true);
                    $("#produto_referencia").next("span[rel=lupa_produto]").hide();

                    $("#produto_descricao").attr("readonly", true);
                    $("#produto_descricao").next("span[rel=lupa_produto]").hide();
                } else {
                    $("#produto_referencia").removeAttr("readonly");
                    $("#produto_referencia").next("span[rel=lupa_produto]").show();

                    $("#produto_descricao").removeAttr("readonly");
                    $("#produto_descricao").next("span[rel=lupa_produto]").show();
                }
            } else {
                <?php if (!empty($_REQUEST["os_id"])): ?>
                $("#div_informacoes_revenda input").each(function(){

                    $(this).attr({ readonly: "readonly" });
                    $(this).unmask();

                    if ($(this).next("span[rel=lupa]").length > 0) {
                        $(this).next("span[rel=lupa]").hide();
                    }

                });

                $("#div_informacoes_revenda select").each(function(){
                    $(this).attr({ readonly: "readonly" });
                    $(this).selectreadonly(true);
                });
                $("#produto_referencia").attr({ readonly: "readonly" });
                $("#produto_referencia").next("span[rel=lupa_produto]").hide();

                $("#produto_descricao").attr({ readonly: "readonly" });
                $("#produto_descricao").next("span[rel=lupa_produto]").hide();
                <?php endif ?>
            }
        }

        <?php
        if($postoInterno == false){
            if(strlen(getValue("revenda[id]")) == 0 && count($msg_erro["msg"]) == 0){
                if(!isset($_GET["preos"])){
                    echo "limpa_revenda_produto();";
                }else{
                    echo "bloqueia_revenda();";
                }
            }else{
                echo "bloqueia_revenda();";
            }
        }else{
            echo '$("#produto_serie").prev("h5.asteristico").remove();';
        }
    }

?>
    <?php 

    if (in_array($login_fabrica,[190, 191,195] ) && strlen($os) > 0 && ($areaAdmin === true || $postoInterno == true)) { ?>

        $("#div_informacoes_os input, #div_informacoes_consumidor input, #div_informacoes_revenda input, #div_informacoes_produto input, #div_informacoes_subproduto input").each(function() {
            var nao_bloquear = ["os[nota_fiscal]","os[numero_nf_remessa]","consumidor[nome]","consumidor[cpf]","consumidor[cep]","consumidor[bairro]","consumidor[endereco]","consumidor[numero]","consumidor[complemento]","consumidor[celular]","consumidor[telefone]","consumidor[email]","os[data_abertura]","os[nota_fiscal]","revenda[nome]","revenda[cnpj]","revenda[cep]","revenda[bairro]","revenda[endereco]","revenda[numero]","revenda[telefone]","os[nota_fiscal]","os[pressao_agua]","os[data_compra]","produto[data_fabricacao]"];

            if ($.inArray($(this).attr("name"), nao_bloquear) != -1) {
                $(this).removeAttr("readonly");
            }

        });

        $("#div_informacoes_os select, #div_informacoes_consumidor select, #div_informacoes_revenda select").each(function() {
            var nao_bloquear = ["os[tipo_atendimento]","os[tecnico]","os[consumidor_revenda]"];

            if ($.inArray($(this).attr("name"), nao_bloquear) != -1) {

                $(this).removeAttr("readonly");
            }

        });
    <?php } ?>


<?php
   /**
    * Não bloquear os campos de acessórios da positron
    */
    if($login_fabrica == 153){ ?>
        if($("#produto_acessorio")) {
            bloqueia_campos = false;
        }
    <?php
    }
    ?>
   /**
    * Eventos para anexar imagem
    */
    $("form[name=form_anexo]").ajaxForm({
        complete: function(data) {
            data = $.parseJSON(data.responseText);

            if (data.error) {
                alert(data.error);
            } else {
                var imagem = $("#div_anexo_"+data.posicao).find("img.anexo_thumb").clone();
                $(imagem).attr({ src: data.link });

                $("#div_anexo_"+data.posicao).find("img.anexo_thumb").remove();

                var link = $("<a></a>", {
                    href: data.href,
                    target: "_blank"
                });

                $(link).html(imagem);

                $("#div_anexo_"+data.posicao).prepend(link);

                if ($.inArray(data.ext, ["doc", "pdf", "docx"]) == -1) {
                    setupZoom();
                }

                $("#div_anexo_"+data.posicao).find("input[rel=anexo]").val(data.arquivo_nome);
            }

            $("#div_anexo_"+data.posicao).find("img.anexo_loading").hide();
            $("#div_anexo_"+data.posicao).find("button[name=anexar]").hide();
            $("#div_anexo_"+data.posicao).find(".btn-remover-anexo").show();
            $("#div_anexo_"+data.posicao).find(".btn-remover-anexo").data("tdocsid", data.tdocs_id);
            if (data.ext == "pdf") {
                $("#div_anexo_"+data.posicao).find("img.anexo_thumb").attr("src", "imagens/pdf_icone.png");
            } else if (data.ext == "doc" || data.ext == "docx") {
                $("#div_anexo_"+data.posicao).find("img.anexo_thumb").attr("src", "imagens/docx_icone.png");
            }
            $("#div_anexo_"+data.posicao).find("img.anexo_thumb").show();
        }
    });

    $("button[name=anexar]").click(function() {
        var posicao = $(this).attr("rel");
        $("input[name=anexo_upload_"+posicao+"]").click();
    });

    <?php if($login_fabrica == 153){?>

             $("form[name=form_anexo_sem_ns]").ajaxForm({
                complete: function(data) {
                    data = $.parseJSON(data.responseText);

                    if (data.error) {
                        alert(data.error);
                    } else {
                        var imagem = $("#div_anexo_sem_ns").find("img.anexo_thumb_sem_ns").clone();
                        $(imagem).attr({ src: data.link });

                        $("#div_anexo_sem_ns").find("img.anexo_thumb_sem_ns").remove();

                        var link = $("<a></a>", {
                            href: data.href,
                            target: "_blank"
                        });

                        $(link).html(imagem);

                        $("#div_anexo_sem_ns").prepend(link);

                        if ($.inArray(data.ext, ["doc", "pdf", "docx"]) == -1) {
                            setupZoom();
                        }

                        $("#div_anexo_sem_ns").find("input[rel=anexo_sem_ns]").val(data.arquivo_nome);
                    }

                    $("#div_anexo_sem_ns").find("img.anexo_loading").hide();
                    $("#div_anexo_sem_ns").find("button").show();
                    $("#div_anexo_sem_ns").find("img.anexo_thumb").show();
                }
            });

            $("button[name=anexar_sem_ns]").click(function() {

                $("form[name=form_anexo_sem_ns] > input[name=anexo_sem_ns_upload]").click();
            });

            $("input[name^=anexo_sem_ns_upload]").change(function() {

                $("#div_anexo_sem_ns").find("button").hide();
                $("#div_anexo_sem_ns").find("img.anexo_thumb").hide();
                $("#div_anexo_sem_ns").find("img.anexo_loading").show();

                $(this).parent("form").submit();
            });

    <?php } ?>

    <?php if ((in_array($login_fabrica, [160]))) { ?>
            $("form[name=form_anexo_termo]").ajaxForm({
                complete: function(data) {
                    data = $.parseJSON(data.responseText);

                    var oss = '<?=$os?>';

                    if (data.error) {
                        alert(data.error);
                    } else {
                        var imagem = $("#div_anexo_termo_"+data.posicao).find("img.anexo_thumb").clone();
                        $(imagem).attr({ src: data.link });

                        $("#div_anexo_termo_"+data.posicao).find("img.anexo_thumb").remove();

                        var link = $("<a></a>", {
                            href: data.href,
                            target: "_blank"
                        });

                        $(link).html(imagem);

                        $("#div_anexo_termo_"+data.posicao).prepend(link);

                        if ($.inArray(data.ext, ["doc", "pdf", "docx"]) == -1) {
                            setupZoom();
                        }

                        $("#div_anexo_termo_"+data.posicao).find("input[rel=anexo_termo]").val(data.arquivo_nome);

                        ja_anexou(oss);
                    }

                    $("#div_anexo_termo_"+data.posicao).find("img.anexo_loading").hide();
                    $("#div_anexo_termo_"+data.posicao).find("button[name=anexar_termo]").hide();
                    $("#div_anexo_termo_"+data.posicao).find(".btn-remover-anexo-termo").show();
                    $("#div_anexo_termo_"+data.posicao).find(".btn-remover-anexo-termo").data("tdocsid", data.tdocs_id);
                    if (data.ext == "pdf") {
                        $("#div_anexo_termo_"+data.posicao).find("img.anexo_thumb").attr("src", "imagens/pdf_icone.png");
                    } else if (data.ext == "doc" || data.ext == "docx") {
                        $("#div_anexo_termo_"+data.posicao).find("img.anexo_thumb").attr("src", "imagens/docx_icone.png");
                    }
                    $("#div_anexo_termo_"+data.posicao).find("img.anexo_thumb").show();
                }
            });
            
            $("button[name=anexar_termo]").click(function() {
                var posicao = $(this).attr("rel");
                $("input[name=anexoUploadTermo_"+posicao+"]").click();
            })
            
            $("input[name^=anexoUploadTermo_]").change(function() {
                var i = $(this).parent("form").find("input[name=anexo_posicao_termo]").val();

                $("#div_anexo_termo_"+i).find("button[name=anexar_termo]").hide();
                $("#div_anexo_termo_"+i).find("img.anexo_thumb").hide();
                $("#div_anexo_termo_"+i).find("img.anexo_loading").show();

                $(this).parent("form").submit();
            })

    <?php } ?>


    $("input[name^=anexo_upload_]").change(function() {
        var i = $(this).parent("form").find("input[name=anexo_posicao]").val();

        $("#div_anexo_"+i).find("button[name=anexar]").hide();
        $("#div_anexo_"+i).find("img.anexo_thumb").hide();
        $("#div_anexo_"+i).find("img.anexo_loading").show();

        $(this).parent("form").submit();
    });

    /**
    * Eventos para anexar imagem da peça
    */
    $(document).on("click", "button[name=anexar_peca]", function() {
        var peca    = $(this).attr("peca");
        var produto = $(this).attr("produto");
        var posicao = $(this).attr("data-imgid") || '0';

        var input_name = ['anexo_peca_upload',produto,peca].join('_');
        if (posicao != "0")
            input_name += '_'+posicao;
        $("input[name="+input_name+"]").click();
    });

    $(document).on("change", "input[name^=anexo_peca_upload_]", function() {
        var form = $(this).parent("form");

        var posicao = $(form).find("input[name=anexo_posicao]").val();
        var produto = $(form).find("input[name=anexo_produto]").val();
        var peca    = $(form).find("input[name=anexo_peca]").val();
        var liID    = ['#peca_anexo',produto,peca].join('_');
        if (posicao > 0)
            liID += '_'+posicao;
        var li      = $(liID);

        li.find("button").hide();
        li.find("img.anexo_thumb").hide();
        li.find("img.anexo_loading").show();

        $(form).submit();
    });

    /**
     * Função para verificar se o número de série existe na base de dados
     */
    <?php
    if(in_array($login_fabrica, array(138,158))){
        if ($login_fabrica == 138) { ?>
            function verifica_reincidencia(tipo, serie, produto_id, produto_ref){
                var nota_fiscal = $("#nota_fiscal").val();
                var cnpj_revenda = $("#revenda_cnpj").val();
                var posto = $("#posto_id").val();

                if (serie.length > 0) {
                    $.ajax({
                        url : "<?php echo $_SERVER['PHP_SELF']; ?>",
                        type: "POST",
                        data: { ajax: true, verifica_reincidencia : 1, produto : produto_id, referencia : produto_ref, serie : serie, posto : posto, cnpj_revenda: cnpj_revenda, nota_fiscal : nota_fiscal },
                        complete: function(data){

                            if(data.responseText != "ok"){
                                alert(data.responseText);
                            }

                        }

                    });
                }
            }
        <? } ?>

        $("#produto_serie,#subproduto_serie").blur(function(){
            var tipo = $(this).attr("id");
            var serie = $(this).val();

            if(tipo == "produto_serie"){
                var produto_id = $("#produto_id").val();
                var produto_ref = $("#produto_referencia").val();
            }else{
                var produto_id = $("#subproduto_id").val();
                var produto_ref = $("#subproduto_referencia").val();
            }

            <? if ($login_fabrica == 138) { ?>
                verifica_reincidencia(tipo, serie, produto_id, produto_ref);
                if (serie.length > 0) {
                    $.ajax({
                        url : "<?= $_SERVER['PHP_SELF']; ?>",
                        type: "POST",
                        data: { ajax: true, ajax_serie : 1, produto : produto_id, referencia : produto_ref, serie : serie },
                        complete: function(data){

                            if(data.responseText != "ok"){
                                alert(data.responseText);
                            }
                        }
                    });
                }
            <? } else if ($login_fabrica == 158) { ?>
                carregaDadosNumeroSerie(serie,produto_ref);
            <? } ?>

        });
    <?php
    }

    if(in_array($login_fabrica, [151,198])){
    ?>
        var serie = $("#produto_serie").val();

        if (serie.length > 0) {
            valida_serie_bloqueada(serie, $("#produto_id").val());
            valida_serie(serie);
        }

        var pd_valor_anterior = "";
        var ps_valor_anterior = "";

        $("#produto_defeito_constatado").change(function(){

            var defeito_constatado = $(this).find("option:selected").val();
            var lancar_peca        = $(this).find("option:selected").data("lancar-pecas");
            var serie              = $("#produto_serie").val();
            var produto_referencia = $("#produto_referencia").val();

            if(pd_valor_anterior == ""){
                pd_valor_anterior = defeito_constatado;
            }

            var status = limpa_pecas("#produto_defeito_constatado", pd_valor_anterior);
            if(status == true){
                return;
            }

            <?php if (in_array($login_fabrica, [198])) { ?> 
                if ($("#produto_serie").closest("div").find("h5").length) {
                    alert("<?php echo traduz('por.favor.insira.o.numero.de.serie');?>");
                    $("#produto_serie").focus();
                    return;
                }
            <?php } else {?> 
            if(typeof serie != "undefined" && serie == "" && typeof produto_referencia != "undefined" && produto_referencia != ""){
                alert("<?php echo traduz('por.favor.insira.o.numero.de.serie');?>");
                $("#produto_serie").focus();
                return;
            }
            <?php } ?> 

            if(defeito_constatado.length > 0 && typeof defeito_constatado != "undefined"){
                if (lancar_peca == 't') {

                    var produto_id  = $("#produto_id").val();

                    valida_serie(serie);

                    pd_valor_anterior = defeito_constatado;

                }else{
                    $("#produto_pecas").hide();
                }
            }else{
                $("#produto_pecas").hide();
            }
            valida_serie_bloqueada(serie, $("#produto_id").val());
        });

        $("#produto_serie").focusout(function(){
            if($(this).val() == ""){
                $(this).change();
            }
        });

        <?php
        if (count($msg_erro["msg"]) > 0 || !empty($os)) {
        ?>
            pd_valor_anterior = $("#produto_defeito_constatado").val();
            ps_valor_anterior = $("#produto_serie").val();
        <?php
        }
        ?>

        $("#produto_serie").change(function(){

            var tipo  = $(this).attr("id");
            var serie = $(this).val();

            if(ps_valor_anterior == ""){
                ps_valor_anterior = serie;
            }

            var status = limpa_pecas("#produto_serie", ps_valor_anterior);

            if(status == true){
                return;
            }

            // $("#produto_pecas").hide();

            var produto_id  = $("#produto_id").val();

            if (typeof serie != "undefined" && serie.length > 0) {

                valida_serie_bloqueada(serie, $("#produto_id").val(), true);
                valida_serie(serie);

                ps_valor_anterior = serie;

            }

        });
    <?php
    }

    if (in_array($login_fabrica, array(138))) {
    ?>
        $("input[name='os[garantia]']").change(function() {
            var garantia = $("input[name='os[garantia]']:checked").val();

            if (garantia == "f") {
                $("#produto_pecas, #div_subproduto_pecas").hide();
            } else {
                $("#produto_pecas").show();

                if ($("#produto_id").val().length > 0) {
                    var verifica_subproduto = false;

                    $.ajax({
                        async: false,
                        url: "cadastro_os.php",
                        type: "get",
                        data: { ajax: true, ajax_verifica_subproduto: true, produto_id: $("#produto_id").val() }
                    }).always(function(data) {
                        if (data == "true") {
                            verifica_subproduto = true;
                        }
                    });

                    if (verifica_subproduto == true) {
                        $("#div_subproduto_pecas").show();
                    }
                }
            }
        });
    <?php
    }

    if (isset($anexo_peca_os)) {
    ?>
        if ($("form[name=form_anexo_peca]").length > 1) {
            $("form[name=form_anexo_peca]").ajaxForm({
                complete: function(data) {
                    data = $.parseJSON(data.responseText);

                    if (data.error != undefined) {
                        alert(data.error);
                    } else {
                        var id_produto_peca_pos = ["#peca_anexo",data.produto,data.peca].join('_');
                        if (data.posicao != '0') {
                            id_produto_peca_pos += '_'+data.posicao;
                        }
                        var imagem = $(id_produto_peca_pos).find("img.anexo_thumb").clone();
                        $(imagem).attr({ src: data.link });

                        $(id_produto_peca_pos).find("img.anexo_thumb").remove();

                        var link = $("<a></a>", {
                            href: data.href,
                            target: "_blank"
                        });

                        $(link).html(imagem);

                        $(id_produto_peca_pos+" > label").after(link);

                        if ($.inArray(data.ext, ["doc", "pdf", "docx"]) == -1) {
                            setupZoom();
                        }

                        $(id_produto_peca_pos).find("input[rel=anexo]").val(data.arquivo_nome);

                        $(id_produto_peca_pos).find("img.anexo_loading").hide();
                        $(id_produto_peca_pos).find("button").show();
                        $(id_produto_peca_pos).find("img.anexo_thumb").show();
                    }
                }
            });
        }
    <?php
    }

    if ($login_fabrica == 145) {
    ?>
        $("#os_construtora").change(function() {
            if ($(this).is(":checked")) {
                //nota fiscal esconde <h5 class='asteristico' >*</h5>
                $("#nota_fiscal").prev().hide();
                //data compra esconde <h5 class='asteristico' >*</h5>
                $("#data_compra").prev().hide();
            } else {
                //nota fiscal mostra <h5 class='asteristico' >*</h5>
                $("#nota_fiscal").prev().show();
                //data compra mostra <h5 class='asteristico' >*</h5>
                $("#data_compra").prev().show();
            }
        });

        if ($("#os_construtora").is(":checked")) {
            //nota fiscal esconde <h5 class='asteristico' >*</h5>
            $("#nota_fiscal").prev().hide();
            //data compra esconde <h5 class='asteristico' >*</h5>
            $("#data_compra").prev().hide();
        } else {
            //nota fiscal mostra <h5 class='asteristico' >*</h5>
            $("#nota_fiscal").prev().show();
            //data compra mostra <h5 class='asteristico' >*</h5>
            $("#data_compra").prev().show();
        }
    <?php
    }
    ?>
    <?php
    if(in_array($login_fabrica, [167, 203])){
?>
    $("#produto_defeito_constatado").change(function(){
                  if($(this).val() != ""){
                          $(".contador").show();
                  }else{
                          $(".contador").hide();
                  }
         });
<?php
    }

    if($login_fabrica == 173){
?>
    $("#produto_defeito_constatado").change(function(){
        verificaDcPosicaoPeca();
    });
<?php
    }
    
    if ($login_fabrica == 175) {
    ?>
        $('#produto_defeito_constatado').on('change', function() {
            let tecnico = $('#tecnico').val();
            
            if (tecnico.length == 0) {
                $(this).val('');
                alert('É necessário selecionar um técnico para lançar defeito constatado');
            }
        });
    <?php
    }

    // removendo *, obrigátorio
    if ($login_fabrica == 174)
    {
?>
        // verificando lenglength
            var fora_garantia = $("#tipo_atendimento > option:selected").attr("fora_garantia");
            if ($("#nota_fiscal").prev(".asteristico").length == 0) {
                if (fora_garantia == "" || fora_garantia == "undefined")
                {
                    $("#nota_fiscal").before("<h5 class='asteristico'>*</h5>");
                }
            }
            if ($("#data_compra").prev(".asteristico").length == 0) {
                if (fora_garantia == "" || fora_garantia == "undefined")
                {
                    $("#data_compra").before("<h5 class='asteristico'>*</h5>");
                }
            }
            if ($("#telefone").prev(".asteristico").length == 0) {
                $("#telefone").before("<h5 class='asteristico'>*</h5>");
            }
            if ($("#consumidor_email").prev(".asteristico").length == 0) {
                $("#consumidor_email").before("<h5 class='asteristico'>*</h5>");
            }
            if ($("#anexo_obrig").prev(".asteristico").length == 0) {
                $("#anexo_nf_produto_obrig").before("<label class='label label-important' id='anexo_obrig'>Anexo(s) obrigatórios</label>");
            }
            if ($("#revenda_nome").prev(".asteristico").length == 0) {
                $("#revenda_nome").before("<h5 class='asteristico'>*</h5>");
            }
            if ($("#revenda_cnpj").prev(".asteristico").length == 0) {
                $("#revenda_cnpj").before("<h5 class='asteristico'>*</h5>");
            }


        var fora_garantia = "";
        $("#tipo_atendimento").change(function()
        {
            var fora_garantia = $("#tipo_atendimento > option:selected").attr("fora_garantia");
            if (fora_garantia == "t") {
                //nota fiscal esconde <h5 class='asteristico' >*</h5>
                    $("#nota_fiscal").prev().hide();
                    $("#nota_obrigatoria").hide();
                    $("#data_compra").prev().hide();
                    $("#telefone").prev().hide();
                    $("#consumidor_email").prev().hide();
                    $("#anexo_obrig").hide();

                //
                    $("#os_consumidor_revenda").change(function()
                    {
                        if (tipo_os_campo == "C")
                        {
                            $("#revenda_nome").prev().hide();
                            $("#revenda_cnpj").prev().hide();
                        }else
                        {
                            $("#revenda_nome").prev().show();
                            $("#revenda_cnpj").prev().show();
                        }
                    });

            } else {

                //nota fiscal mostra <h5 class='asteristico' >*</h5>
                    $("#nota_fiscal").prev().show();
                    $("#nota_obrigatoria").show();
                    $("#data_compra").prev().show();
                    $("#telefone").prev().show();
                    $("#consumidor_email").prev().show();
                    $("#revenda_nome").prev().show();
                    $("#revenda_cnpj").prev().show();
                    $("#anexo_obrig").show();
                    $("#anexo_obrig").prev().show();
            }
        });

        var tipo_os_campo = "";
        $("#os_consumidor_revenda").change(function()
        {
            var tipo_os_campo = $("#os_consumidor_revenda").val();
            if (tipo_os_campo == "C" && fora_garantia == "")
            {
                $("#revenda_nome").prev().hide();
                $("#revenda_cnpj").prev().hide();
            }else
            {
                $("#revenda_nome").prev().show();
                $("#revenda_cnpj").prev().show();
            }
        });
<?php
    }

    if(in_array($login_fabrica, array(151))){
        ?>
            $("#revenda_nome").next("span[rel=lupa]").hide();
        <?php
        }
    ?>
    <?php
    if(in_array($login_fabrica, array(148, 161))){
        if (count($msg_erro["msg"]) > 0 || strlen($os) > 0) {
        ?>
            $('.tc_formulario[id!=div_peca_anexo]').show();
            $("#os_form_submit").show();

            // OS
            if ($("#tipo_atendimento option:selected").attr("grupo_atendimento") == "R") {
                $(".box_intervalo_revisao").show();
                valida_tolerancia_horimetro_revisao();
            } else {
                $(".box_intervalo_revisao").hide();
            }

            $("#div_trocar_produto").hide();
            <?php if ($login_fabrica == 148): ?>
            // Revenda
            if(tipo_atendimento == 76977){
                $("#data_compra").prop({"readonly" : false});
                $("#nota_fiscal").prop({"readonly" : false});
                $(".data_compra .asteristico").hide();
                $(".nota_fiscal .asteristico").hide();
                $("#div_defeito_reclamado .asteristico").hide();
            }else{
                $("#data_compra").prop({"readonly" : true});
                $("#nota_fiscal").prop({"readonly" : true});
            }
            $("#revenda_nome").prop({"readonly" : true});
            $("#revenda_cnpj").prop({"readonly" : true});
            $("#revenda_cep").prop({"readonly" : true});

            $("#revenda_cidade > option:not(:selected)").remove();

            $("#revenda_estado").prop({"readonly" : true});
            $("#revenda_estado > option:not(:selected)").remove();
            $("#revenda_bairro").prop({"readonly" : true});
            $("#revenda_endereco").prop({"readonly" : true});
            $("#revenda_numero").prop({"readonly" : true});
            $("#revenda_complemento").prop({"readonly" : true});
            $("#revenda_telefone").prop({"readonly" : true});
            $("#div_informacoes_revenda span[rel=lupa]").hide();

            // Produto
            $("#div_informacoes_produto").find("span[rel=lupa_produto]").hide();
            $("#produto_referencia").prop({"readonly" : true});
            $("#produto_descricao").prop({"readonly" : true});
            $("#produto_voltagem").prop({"readonly" : true});
            $("#produto_serie").prop({"readonly" : true});
            $("#produto_serie_motor").prop({"readonly" : true});

            if (typeof revisoes != "undefined") {
                $("#produto_horimetro").change();
            }

            $("#div_informacoes_produto_venda div.alert-produto-pesquisa").hide();

            if (typeof revisoes != "undefined" && $("#produto_intervalo_revisao").val() > 0) {
                carregaRegrasRevisao();
            }
            <?php endif ?>

            <?php if ($login_fabrica == 161): ?>

            <?php
            if ($cook_idioma == 'pt-br'  || $areaAdmin) {
            ?>
                $("#consumidor_cep").mask("99999-999");
            <?php
            }
            ?>

            if ($("#pais_posto").val() == "" || $("#pais_posto").val() == "BR") {
                $("#consumidor_estado > option:not(:selected)").remove();
                $("#consumidor_cidade > option:not(:selected)").remove();
            }

            var consumidor_campos = [
                'nome',
                'cpf',
                'cep',
                'bairro',
                'endereco',
                'numero',
                'complemento',
                'telefone',
                'celular',
                'email'
            ];

            if ($("#consumidor_cpf").val()) {
                $("#cpf_cnpj").prop({"readonly" : true});
                $("#cnpj_cpf").prop({"readonly" : true});
            }

            var len = consumidor_campos.length;

            for (var i = 0; i < len; i++) {
                if ($("#consumidor_" + consumidor_campos[i]).val()) {

                    $("#consumidor_" + consumidor_campos[i]).prop({"readonly": true});
                }
            }
            <?php endif ?>

            <?php if ($login_fabrica == 148): ?>
            $(".url_historico").show();
            var serie = $("#produto_serie").val();
            $(".url_link").html("<a href=\"javascript: historico_produto('"+serie+"')\"><strong>Histórico do Produto</strong></a>")
            <?php endif ?>

            <?php
            if (strlen(getValue("produto[serie_transmissao]")) > 0) {
            ?>
                $("#produto_serie_transmissao").prop({"readonly" : true});
            <?php
            }
        }
    ?>

        <?php if ($login_fabrica == 161): ?>
        $("#sem_serie").click(function() {
            $("#div_trocar_produto").hide();

            if ($("#sem_serie").is(":checked")) {
                $('.tc_formulario[id!=div_peca_anexo]').show();
                $("#div_valores_adicionais").hide();
                $('#os_form_submit').show();
                $("#venda_numero_serie").val('').prop({"readonly": true});

                busca_valor_adicional();

                $("#div_informacoes_revenda input").each(function(){

                    $(this).removeAttr("readonly");

                    if ($(this).next("span[rel=lupa]").length > 0) {
                        $(this).next("span[rel=lupa]").show();
                    }

                });
                $("#revenda_cnpj").mask("99.999.999/9999-99",{placeholder:""});
                $("#revenda_cep").mask("99999-999",{placeholder:""});

                $("#div_informacoes_revenda select").each(function(){
                    $(this).removeAttr("readonly");
                    $(this).selectreadonly(false);
                });
            } else {
                $("#venda_numero_serie").val('').prop({"readonly": false});
                $('.tc_formulario[id!=div_informacoes_produto_venda]').hide();
                <?php if ($areaAdmin == true): ?>
                $("#div_informacoes_posto").show();
                <?php endif ?>
                $('#os_form_submit').hide();
            }
        });
        <?php endif ?>

        $('select[name=peca_reposicao]').click(function(){
            if ($(this).val() !== '') {
                if($("#posto_id").val().length == 0){
                    alert("Por favor informe o posto");
                    $(this).val('');
                    return;
                }

                $.ajax({
                    url: '<?php echo $_SERVER["PHP_SELF"]; ?>',
                    type: "post",
                    dataType:"JSON",
                    data: {
                        ajax: true,
                        pecasreposicao: true,
                        produto_pecareposicao : $(this).val()
                    },
                    beforeSend: function(){
                       //loading('show'); /*HD-3849281 27/10/2017*/
                    }
                }).done(function(data){
                    //loading('hide'); /*HD-3849281 27/10/2017*/

                    if(data.status == true){
                        $('.tc_formulario[id!=div_peca_anexo]').show();
                        $('input[type="submit"]').show();
                        $("#div_informacoes_produto").find("span[rel=lupa_produto]").hide();
                        $("#produto_id").val(data.produto);
                        $("#produto_referencia").val(data.referencia_produto).prop({"readonly" : true});
                        $("#produto_descricao").val(data.descricao_produto).prop({"readonly" : true});
                        $("#produto_voltagem").val(data.voltagem).prop({"readonly" : true});
                        $("#produto_serie_motor").val(data.serie_motor).prop({"readonly" : true});
                        $("#div_trocar_produto").hide();
                        $("#os_form_submit").show();

                        busca_solucao(data.produto,data.tipo_produto,false,null,null);
                        busca_defeito_constatado(data.produto);
                        busca_comunicados(data.produto, false);
                        $('button[name=lista_basica]').hide();
                    }
                });
            }else{
                if ($("#produto_id").val() !== '') {
                    $('.alterar_produto_venda').trigger('click');
                }
            }
        });

        $(".verifica_serie_venda").click(function(){

            var serie_venda = $("#venda_numero_serie").val();
            var posto_id = $("#posto_id").val();


            if(serie_venda == ""){
                alert("Por favor informe o número de série do produto");
                $("#venda_numero_serie").focus();
                return;
            }

	    if($("input[name=outros]")) {
		$("input[name=outros]").attr("disabled",false);
	    }

            if($("#posto_id").val().length == 0){
                alert("Por favor informe o posto");
                return;
            }

            $.ajax({
                url: '<?php echo $_SERVER["PHP_SELF"]; ?>',
                type: "post",
                dataType:"JSON",
                data: {
                    ajax: true,
                    verifica_serie_venda: true,
                    serie_venda : serie_venda,
                    posto_id: posto_id
                },
                beforeSend: function(){
                    $('.loading').html("<br /> <img src='imagens/loading_img.gif' style='height: 27px; margin-top: 2px;' />");
                }
            }).done(function(data){

                $('.loading').html("");

                if(data.status == true){

                    $('.tc_formulario[id!=div_peca_anexo]').show();
                    $('input[type="submit"]').show();

                    // OS
                    $("#venda_id").val(data.venda);
                    <? if($login_fabrica == 148) { ?>
                    $("#data_compra").val(data.data_compra).prop({"readonly" : true});
                    $("#nota_fiscal").val(data.nota_fiscal).prop({"readonly" : true});
                    <? } ?>

                    <?php if ($login_fabrica == 161 and $postoInterno == false): ?>
                    $("#div_informacoes_revenda input").each(function(){

                    $(this).removeAttr("readonly");

                    if ($(this).next("span[rel=lupa]").length > 0) {
                        $(this).next("span[rel=lupa]").show();
                    }

                    });
                    $("#revenda_cnpj").mask("99.999.999/9999-99",{placeholder:""});
                    $("#revenda_cep").mask("99999-999",{placeholder:""});

                    $("#div_informacoes_revenda select").each(function(){
                        $(this).removeAttr("readonly");
                        $(this).selectreadonly(false);
                    });
                    <?php endif ?>

            <?php if ($login_fabrica <> 161){ ?>
                    // Revenda
                    if (data.nome_posto) {
                        $("#revenda_nome").val(data.nome_posto).prop({"readonly" : true});
                    }

                    if (data.cnpj_posto) {
                        $("#revenda_cnpj").val(data.cnpj_posto).prop({"readonly" : true});
                        $("#revenda_cnpj").blur();
                    }

                    if (data.cep_posto) {
                        $("#revenda_cep").val(data.cep_posto).prop({"readonly" : true});
                    }
                    <?php
                    if ($login_pais != "BR" && !$areaAdmin && empty(getValue("consumidor[estado]"))) {
                    ?>
                        if (data.estado_posto) {
                            busca_cidade(data.estado_posto, "revenda");
                        }

                        if (data.cidade_posto) {
                            $("#revenda_cidade").val(retiraAcentos(data.cidade_posto).toUpperCase());
                            $("#revenda_cidade > option:not(:selected)").remove();
                        }

                        if (data.estado_posto) {
                            $("#revenda_estado").val(data.estado_posto).prop({"readonly" : true});
                            $("#revenda_estado > option:not(:selected)").remove();
                        }
                    <?php
                    } else if ($areaAdmin && empty(getValue("consumidor[estado]"))) { ?>

                        if ($("#pais_posto").val() != "" && $("#pais_posto").val() != "BR") {

                            if (data.estado_posto) {
                                busca_cidade(data.estado_posto, "revenda");
                            }

                            if (data.cidade_posto) {
                                $("#revenda_cidade").val(retiraAcentos(data.cidade_posto).toUpperCase());
                                $("#revenda_cidade > option:not(:selected)").remove();
                            }

                            if (data.estado_posto) {
                                $("#revenda_estado").val(data.estado_posto).prop({"readonly" : true});
                                $("#revenda_estado > option:not(:selected)").remove();
                            }

                        }

                    <?php
                    } ?>
                    if (data.bairro_posto) {
                        $("#revenda_bairro").val(data.bairro_posto).prop({"readonly" : true});
                    }

                    if (data.endereco_posto) {
                        $("#revenda_endereco").val(data.endereco_posto).prop({"readonly" : true});
                    }

                    if (data.numero_posto) {
                        $("#revenda_numero").val(data.numero_posto).prop({"readonly" : true});
                    }

                    if (data.complemento_posto) {
                        $("#revenda_complemento").val(data.complemento_posto).prop({"readonly" : true});
                    }

                    if (data.telefone_posto) {
                        $("#revenda_telefone").val(data.telefone_posto).prop({"readonly" : true});
                    }

                    if (data.nome_posto && data.cnpj_posto) {
                        $("#div_informacoes_revenda span[rel=lupa]").hide();
	    }
	    <?php }else{ 
			if(count($msg_erro) == 0){
	    ?>
			    pega_servico_realizado(null, data.produto);
	    	  <?php } ?>

            if (data.nome_posto) {
             $("#revenda_nome").val(data.nome_posto);
            }

            if (data.cnpj_posto) {
             $("#revenda_cnpj").val(data.cnpj_posto);
             $("#revenda_cnpj").blur();
            }

            if (data.cep_posto) {
             $("#revenda_cep").val(data.cep_posto);
            }
            <?php if ($login_pais != "BR" && !$areaAdmin && empty(getValue("consumidor[estado]"))) { ?>
                if (data.estado_posto) {
                 busca_cidade(data.estado_posto, "revenda");
                }

                if (data.cidade_posto) {
                 $("#revenda_cidade").val(retiraAcentos(data.cidade_posto).toUpperCase());
                 //$("#revenda_cidade > option:not(:selected)").remove();
                }

                if (data.estado_posto) {
                 $("#revenda_estado").val(data.estado_posto);
                 //$("#revenda_estado > option:not(:selected)").remove();
                }
            <?php } else if ($areaAdmin && empty(getValue("consumidor[estado]"))) { ?>

                if ($("#pais_posto").val() != "" && $("#pais_posto").val() != "BR") {

                    if (data.estado_posto) {
                        busca_cidade(data.estado_posto, "revenda");
                    }

                    if (data.cidade_posto) {
                        $("#revenda_cidade").val(retiraAcentos(data.cidade_posto).toUpperCase());
                        $("#revenda_cidade > option:not(:selected)").remove();
                    }

                    if (data.estado_posto) {
                        $("#revenda_estado").val(data.estado_posto).prop({"readonly" : true});
                        $("#revenda_estado > option:not(:selected)").remove();
                    }

                }

            <?php
            }
            ?>
            if (data.bairro_posto) {
             $("#revenda_bairro").val(data.bairro_posto);
            }

            if (data.endereco_posto) {
             $("#revenda_endereco").val(data.endereco_posto);
            }

            if (data.numero_posto) {
             $("#revenda_numero").val(data.numero_posto);
            }

            if (data.complemento_posto) {
             $("#revenda_complemento").val(data.complemento_posto);
            }

            if (data.telefone_posto) {
             $("#revenda_telefone").val(data.telefone_posto);
            }

            if (data.nome_posto && data.cnpj_posto) {
             $("#div_informacoes_revenda span[rel=lupa]").hide();
            }
           <?php } ?>

                    <?php if ($login_fabrica !== 161): ?>
                    if (data.posto == $("#posto_id").val()) {
                    <?php endif ?>
                        $("#consumidor_nome").val(data.consumidor_nome);

                        if((data.consumidor_cpf.replace(/\D/g, "")).length == 11){
                            $("#cpf_cnpj").attr("checked",true);
                        }else{
                            $("#cnpj_cpf").attr("checked",true);
                        }

                        $("#consumidor_cpf").val(data.consumidor_cpf);
                        $("#consumidor_cep").val(data.consumidor_cep);
                        $("#consumidor_cep").blur();

                        if (data.consumidor_estado != "EX") {

                            $(".cidade_exterior").hide();
                            $(".cidade_nacional").show();
                            <?php
                            if ($login_pais != "BR" && !$areaAdmin && empty(getValue("consumidor[estado]"))) {
                            ?>
                                if (data.consumidor_estado && data.consumidor_cidade_nome) {
                                    busca_cidade(data.consumidor_estado, "consumidor");
                                    //$("#consumidor_cidade").val(retiraAcentos(data.consumidor_cidade).toUpperCase());
                                    $("#consumidor_cidade").val(retiraAcentos(data.consumidor_cidade_nome).toUpperCase());
                                    $("#consumidor_cidade > option:not(:selected)").remove();

                                    $("#consumidor_estado").val(data.consumidor_estado);
                                    $("#consumidor_estado > option:not(:selected)").remove();
                                } else {
                                    recarrega_estados($("#consumidor_estado"));
                                }
                            <?php
                            } else if ($areaAdmin && empty(getValue("consumidor[estado]"))) { ?>

                                if ($("#pais_posto").val() != "" && $("#pais_posto").val() != "BR") {

                                     if (data.consumidor_estado && data.consumidor_cidade_nome) {
                                        busca_cidade(data.consumidor_estado, "consumidor");
                                        //$("#consumidor_cidade").val(retiraAcentos(data.consumidor_cidade).toUpperCase());
                                        $("#consumidor_cidade").val(retiraAcentos(data.consumidor_cidade_nome).toUpperCase());
                                        $("#consumidor_cidade > option:not(:selected)").remove();

                                        $("#consumidor_estado").val(data.consumidor_estado);
                                        $("#consumidor_estado > option:not(:selected)").remove();
                                    } else {
                                        recarrega_estados($("#consumidor_estado"));
                                    }

                                }

                            <?php
                            }
                            ?>

                        } else {

                            $(".cidade_exterior").show();
                            $(".cidade_nacional").hide();
                            
                            $("#consumidor_estado_exterior").val(data.consumidor_estado);
                            $("#consumidor_cidade_exterior").val(data.consumidor_cidade_nome);

                        }

                        <?php
                        if ($login_pais != "BR" && !$areaAdmin && empty(getValue("consumidor[estado]"))) {
                        ?>
                            $("#consumidor_estado option[value="+data.consumidor_estado+"]").prop("selected", true);
                            busca_cidade(data.consumidor_estado, "consumidor");
                            $("#consumidor_cidade option[value='"+data.consumidor_cidade+"']").prop("selected", true);

                            $("#revenda_estado option[value="+data.estado_posto+"]").prop("selected", true);
                            busca_cidade(data.consumidor_estado, "revenda");
                            $("#revenda_cidade option[value='"+data.cidade_posto+"']").prop("selected", true);

                        <?php
                        } else if ($areaAdmin && empty(getValue("consumidor[estado]"))) { ?>

                            if ($("#pais_posto").val() != "" && $("#pais_posto").val() != "BR") {

                                $("#consumidor_estado option[value="+data.consumidor_estado+"]").prop("selected", true);
                                busca_cidade(data.consumidor_estado, "consumidor");
                                $("#consumidor_cidade option[value='"+data.consumidor_cidade+"']").prop("selected", true);

                                $("#revenda_estado option[value="+data.estado_posto+"]").prop("selected", true);
                                busca_cidade(data.consumidor_estado, "revenda");
                                $("#revenda_cidade option[value='"+data.cidade_posto+"']").prop("selected", true);

                            }

                        <?php
                        }
                        ?>

                        $("#consumidor_bairro").val(data.consumidor_bairro);
                        $("#consumidor_endereco").val(data.consumidor_endereco);
                        $("#consumidor_numero").val(data.consumidor_numero);

                        $("#consumidor_complemento").val(data.consumidor_complemento);
                        $("#consumidor_telefone").val(data.consumidor_fone);
                        $("#consumidor_celular").val(data.consumidor_celular);
                        $("#consumidor_email").val(data.consumidor_email);

			<?php if ($login_fabrica == 161): ?>

			<?php if(count($msg_erro['msg']) == 0){ ?>
				busca_defeito_reclamado(data.produto);
			<?php } ?>

                        <?php
                        if ($cook_idioma == "pt-br") {
                        ?>
                            $("#consumidor_cep").mask("99999-999");
                        <?php
                        }
                        ?>
                        var consumidor_campos = [
                            'nome',
                            'cpf',
                            'cep',
                            'bairro',
                            'endereco',
                            'numero',
                            'complemento',
                            'telefone',
                            'celular',
                            'email'
                        ];

                        if ($("#consumidor_cpf").val()) {
                            $("#cpf_cnpj").prop({"readonly" : true});
                            $("#cnpj_cpf").prop({"readonly" : true});
                        }

                        var len = consumidor_campos.length;

                        for (var i = 0; i < len; i++) {
                            if ($("#consumidor_" + consumidor_campos[i]).val()) {
                                //$("#consumidor_" + consumidor_campos[i]).prop({"readonly": true});
                            }
                        }
                        <?php endif ?>
                    <?php if ($login_fabrica !== 161): ?>
                    } else {
                        $(".cidade_exterior").hide();
                    }
                    <?php endif ?>

                    // Produto
                    busca_solucao(data.produto,data.tipo_produto,false,null,null);

                    $("#div_informacoes_produto").find("span[rel=lupa_produto]").hide();
                    $("#produto_id").val(data.produto);
                    $("#produto_referencia").val(data.referencia_produto).prop({"readonly" : true});
                    $("#produto_descricao").val(data.descricao_produto).prop({"readonly" : true});
                    $("#produto_referencia_disabled").val(data.referencia_produto);
                    $("#produto_descricao_disabled").val(data.descricao_produto);
                    $("#produto_voltagem").val(data.voltagem).prop({"readonly" : true});
                    $("#produto_serie").val(serie_venda).prop({"readonly" : true});
                    $("#produto_serie_motor").val(data.serie_motor).prop({"readonly" : true});
                    $("#div_trocar_produto").hide();

                    <?php if ($login_fabrica == 161 and ($areaAdmin == true or $postoInterno == true)): ?>
                    $("#prod_s_ns").hide();
                    $("#sem_ns").prop({"checked": false});
                    <?php endif ?>

                    if (data.serie_transmissao.length > 0) {
                        $("#produto_serie_transmissao").val(data.serie_transmissao).prop({"readonly" : true});
                    }

		    <?php if ($login_fabrica == 161 and count($msg_erro['msg']) == 0){ ?>
		    	busca_defeito_reclamado(data.produto);
		    <?php } ?>

                    busca_defeito_constatado(data.produto);
                    busca_comunicados(data.produto, false);

                    

                    revisoes = data.revisao;

                    var pecasArray = [];

                    if (revisoes != null) {
                        if (typeof revisoes.primeira.pecas != "undefined") {
                            pecasArray = pecasArray.concat(revisoes.primeira.pecas);
                        }

                        if (typeof revisoes.intervalo.pecas != "undefined") {
                            pecasArray = pecasArray.concat(revisoes.intervalo.pecas);
                        }

                        if (typeof revisoes.excecao != "undefined") {
                            $.each(revisoes.excecao, function(horas, excecao_object) {
                                if (excecao_object.pecas.length > 0) {
                                    pecasArray = pecasArray.concat(excecao_object.pecas);
                                }
                            });
                        }
                    }

                    <?php if ($login_fabrica == 148): ?>
                    buscaPecasAjax(pecasArray);

                    $(".url_historico").show();
                    $(".url_link").html("<a href='javascript: historico_produto(\""+serie_venda+"\")'><strong><?php echo traduz('historico.do.produto');?></strong></a>")
                    <?php endif ?>
                    $(".verifica_serie_venda").hide();
                    $(".alterar_produto_venda").show();
                    $("#os_form_submit").show();
                    $("#div_informacoes_produto_venda div.alert-produto-pesquisa").hide();
                    <?php if ($login_fabrica == 161 and $postoInterno == true): ?>
                    $("#div_valores_adicionais").hide();
                    busca_valor_adicional();
                    //$("#produto_sem_serie").hide();
                    <?php endif ?>

                }else{
                    alert(data.msg);
                    $("#venda_numero_serie").focus();
                }
            });

        });

        $(".alterar_produto_venda").click(function(){
            if (confirm("<?php echo traduz('deseja.realmente.alterar.o.produto.essa.acao.ira.limpar.o.formulario');?>")) {
                confirm_alterar_posto = true;

                <? if ($login_fabrica == 148) { ?>
					$('select[name=peca_reposicao]').val('');
					// if($("input[name=outros]")) {
					// 	$("input[name=outros]").attr("disabled",true);
					// 	$("input[name=outros]").prop({"checked": false});
					// }

                <? } ?>

                $('.tc_formulario[id!=div_informacoes_produto_venda][id!=div_informacoes_posto]').hide();
                $('input[type="submit"]').hide();

                <?php //if ($login_fabrica == 161 and $postoInterno == true): ?>
                // $("#produto_sem_serie").show();
                //$("#sem_serie").prop({"checked": false});
                <?php //endif ?>

                <?php //if ($login_fabrica == 161 and $areaAdmin == true): ?>
                //$("#sem_serie").prop({"checked": false});
                <?php //endif ?>

                // OS
                $("#venda_id").val("");
                $("#data_compra").val("").prop({"readonly": false});
                $("#nota_fiscal").val("").prop({"readonly": false});

                // Consumidor
                $("#consumidor_nome").val("");
                $("#consumidor_cpf").val("");
                $("#consumidor_cep").val("");
                $("#consumidor_estado").val("");
                $("#consumidor_estado option").remove();
                $("#consumidor_cidade option").remove();
                $("#consumidor_bairro").val("");
                $("#consumidor_endereco").val("");
                $("#consumidor_numero").val("");
                $("#consumidor_complemento").val("");
                $("#consumidor_telefone").val("");
                $("#consumidor_celular").val("");
                $("#consumidor_email").val("");

                <?php if ($login_fabrica == 161 and count($msg_erro) == 0 ) { ?>
                $("#venda_numero_serie").val("");
                $("#consumidor_nome").prop({"readonly": false});
                $("#consumidor_cpf").prop({"readonly": false});
                $("#consumidor_cep").prop({"readonly": false});
                $("#consumidor_estado").prop({"readonly": false});
                $("#consumidor_bairro").prop({"readonly": false});
                $("#consumidor_endereco").prop({"readonly": false});
                $("#consumidor_numero").prop({"readonly": false});
                $("#consumidor_complemento").prop({"readonly": false});
                $("#consumidor_telefone").prop({"readonly": false});
                $("#consumidor_celular").prop({"readonly": false});
                $("#consumidor_email").prop({"readonly": false});

                recarrega_estados($("#consumidor_estado"));
                <?php
                } ?>

                // Revenda
                $("#revenda_nome").val("").prop({"readonly": false});
                $("#revenda_cnpj").val("").prop({"readonly": false});
                $("#revenda_cep").val("").prop({"readonly": false});

                $("#revenda_cidade option").remove();
                $("#revenda_estado option").remove();

                recarrega_estados($("#revenda_estado"));

                $("#revenda_bairro").val("").prop({"readonly": false});
                $("#revenda_endereco").val("").prop({"readonly": false});
                $("#revenda_numero").val("").prop({"readonly": false});
                $("#revenda_complemento").val("").prop({"readonly": false});
                $("#revenda_telefone").val("").prop({"readonly": false});
                $("#div_informacoes_revenda span[rel=lupa]").show();

                // Produto
                <?php if (isset($anexo_peca_os)) { ?>
                    var produto_id = $("#produto_id").val();
                <?php } ?>

                $("#solucao option:first").nextAll().remove();
                $("#div_informacoes_produto").find("span[rel=lupa_produto]").show();
                $("#produto_id").val("");
                $("#produto_referencia").val("").prop({"readonly": false});
                $("#produto_descricao").val("").prop({"readonly": false});
                $("#produto_voltagem").val("");
                $("#produto_serie").val("").prop({"readonly": false});
                $("#produto_serie_motor").val("").prop({"readonly": false});
                $("#produto_serie_transmissao").val("").prop({"readonly": false});
                $("#produto_defeito_constatado option:first").nextAll().remove();
                $("div.box-solucoes").html("Selecione as Soluções");
                $("#solucoes_multiplos").val("");

                $("#pecas_produto > div.row-fluid[name^=peca_]").each(function() {
                    <?php if (isset($anexo_peca_os)) { ?>
                        var peca_id  = $(this).find("input[rel=peca_id]").val();
                        var produto_peca_id = produto_id+'_'+peca_id;

                        if ($("#div_peca_anexo").find("[id^=peca_anexo_"+produto_peca_id+']').length > 0) {
                            $("[id^=peca_anexo_"+produto_peca_id+']').remove(); // exclui todos...
                            $("input[name^=anexo_peca_upload_"+produto_peca_id+"]").each(function() {
                                $(this).parent('form').remove();
                            });
                        }
                    <?php } ?>

                    $(this).find("input").val("").removeAttr("readonly");
                    $(this).find("button[name=remove_peca]").hide();
                    $(this).find("span[rel=lupa_peca]").show();
                });

                <?php if (isset($anexo_peca_os)) { ?>
                    $("#div_peca_anexo").hide();
                <?php } ?>

                $($("#pecas_produto > div.row-fluid[name^=peca_]")[2]).nextAll("div.row-fluid[name^=peca_]").remove();

                $(".url_historico").hide();
                $(".url_link").html("");

                $(".alterar_produto_venda").hide();
                $(".verifica_serie_venda").show();
                $("#div_informacoes_produto_venda div.alert-produto-pesquisa").show();
                $("#os_form_submit").hide();
            }
        });
    <?
    }

    if (getValue("produto[produto_troca_obrigatoria]") == "true") { ?>
        $("#produto_pecas").hide();
    <? } ?>

    $("button.comunicados-produto").on("click", function() {
        if ($("#produto_id").val().length > 0) {
            $("div.modal-comunicados").modal("show");
        }
    });

    $("button.comunicados-subproduto").on("click", function() {
        if ($("#subproduto_id").val().length > 0) {
            $("div.modal-comunicados-subproduto").modal("show");
        }
    });

    <?php
    if ($login_fabrica == 164) {
        if ($postoInterno == true) {
        ?>
            $("#produto_serie").prev(".asteristico").remove();
            $("#revenda_cnpj").prev(".asteristico").remove();
            $("#revenda_nome").prev(".asteristico").remove();
            $("#revenda_estado").prev(".asteristico").remove();
            $("#revenda_cidade").prev(".asteristico").remove();
            $("#nota_obrigatoria").remove();
            $("#anexo_obrig").hide();
        <?php
        } else {
        ?>
            if ($("#produto_serie").prev(".asteristico").length == 0) {
                $("#produto_serie").before("<h5 class='asteristico'>*</h5>");
            }

            if ($("#revenda_cnpj").prev(".asteristico").length == 0) {
                $("#revenda_cnpj").before("<h5 class='asteristico'>*</h5>");
            }

            if ($("#revenda_nome").prev(".asteristico").length == 0) {
                $("#revenda_nome").before("<h5 class='asteristico'>*</h5>");
            }

            if ($("#revenda_estado").prev(".asteristico").length == 0) {
                $("#revenda_estado").before("<h5 class='asteristico'>*</h5>");
            }

            if ($("#revenda_cidade").prev(".asteristico").length == 0) {
                $("#revenda_cidade").before("<h5 class='asteristico'>*</h5>");
            }

            if ($("#nota_obrigatoria").length == 0) {
                $("#nota_fiscal").parent().parent().parent().find("label").after("<strong style='color:#B94A48' id='nota_obrigatoria'>(<?php echo traduz('anexo.obrigatorio');?>)</strong >");
            }

            $("#anexo_obrig").show();
        <?php
        }
    }
    ?>

    <?php
    if (in_array($login_fabrica, array(169,170))) {
    ?>
        $("#produto_serie").on("change", function() {
            <?php
            if (!$areaAdmin) {
            ?>
                var codigo_posto = "<?=$login_codigo_posto?>";
            <?php
            } else {
            ?>
                var codigo_posto = $("#posto_codigo").val();
            <?php
            }
            ?>

            var serie            = $.trim($(this).val());
            var fora_garantia    = $("#tipo_atendimento > option:selected").attr("fora_garantia");
            var km_google        = $("#tipo_atendimento > option:selected").attr("km_google");
            var os_fora_garantia = $("table.box-defeitos").find("span.defeito-fora-garantia").length;

            if ((serie.length > 0 && codigo_posto.length > 0) && serie == codigo_posto && fora_garantia != "t" && km_google != "t" && os_fora_garantia == 0) {
                $("#anexo_nf_produto_obrig").show();
            } else {
                $("#anexo_nf_produto_obrig").hide();
            }
        });

        $("#produto_serie").trigger("change");
    <?php
    }?>
    <?php if (in_array($login_fabrica, [139,184,191,200])) { ?>

        $("#consumidor_celular").keydown(function(){

            $(".asteristico_telefone").filter(function(){
                return $("#consumidor_telefone").val() == "";
            }).hide();

            $(".asteristico_celular").show(function(){
                return $("#consumidor_telefone").val() == "";
            }).show();

        });

        $("#consumidor_telefone").keydown(function(){

            $(".asteristico_celular").filter(function(){
                return $("#consumidor_celular").val() == "";
            }).hide();

            $(".asteristico_telefone").filter(function(){
                return $("#consumidor_celular").val() == "";
            }).show();

        });

        $("#tipo_atendimento").change(function(){
            let valida_serv = false;
            let option_text = $("#tipo_atendimento > option:selected").text();

            if (option_text == "Fora de Garantia") {
                $("#orcamento_status, .div_valor_total_pecas").show();
                $("#revenda_nome").prev(".asteristico").hide();
                $("#revenda_cnpj").prev(".asteristico").hide();
                $("#revenda_estado").prev(".asteristico").hide();
                $("#revenda_cidade").prev(".asteristico").hide();
                $("#aparencia_produto").prev(".asteristico").hide();
                $("#data_compra").prev(".asteristico").hide();
                $("#nota_fiscal").prev(".asteristico").hide();

                

                $("div[id^=div_servicos_peca_]").each(function(idx){
                    $(this).show();
                    $("#servicos_peca_"+idx).val('');

                    $(this).find("select option[gera_pedido=t]").hide().prop("selected", false);
                });


                $(".div_valor_total_pecas").attr("style", "display:none;");
                $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                    $(this).hide();
                });

            } else {

                $("#orcamento_status, .div_valor_total_pecas").hide();
                $(".txt_nf").text("Nota Fiscal");
                $("#revenda_nome").prev(".asteristico").show();
                $("#revenda_cnpj").prev(".asteristico").show();
                $("#revenda_estado").prev(".asteristico").show();
                $("#revenda_cidade").prev(".asteristico").show();
                $("#aparencia_produto").prev(".asteristico").show();
                $("#data_compra").prev(".asteristico").show();
                $("#nota_fiscal").prev(".asteristico").show();
                $("div[id^=div_servicos_peca_]").each(function(idx){
                    $(this).show();
                });

                $("div[id^=div_servicos_peca_]").each(function(idx){
                    $(this).show();

                    $(this).find("select option[gera_pedido=t]").show();

                });

                $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                    $(this).hide();
                });
                $("div[id^=pecas_referencia_]").each(function() {
                    $(this).attr("class", "span2");
                });
                $("div[id^=pecas_descricao_]").each(function() {
                    $(this).attr("class", "span3");
                });

                $(".div_valor_total_pecas").attr("style", "display:none;");

            }

        });

        $("#tipo_atendimento").change();

        <?php }?>
    <?php if (in_array($login_fabrica, [186,190,191])) { ?>

        $("#tipo_atendimento").change(function(){
            
            let option_text = $("#tipo_atendimento > option:selected").text();
            var lupaPP = $("#pecas_produto").find("input[name=lupa_config]");

            if (option_text == "Garantia Certificado") {
                $("#status_orcamento, .div_valor_total_pecas").hide();
                $(".mostra_envia_email").hide();
                $(".txt_nf").text("Nº Certificado");
                $("#nota_obrigatoria").text("");
                $("#revenda_nome").prev(".asteristico").hide();
                $("#revenda_cnpj").prev(".asteristico").hide();
                $("#revenda_estado").prev(".asteristico").hide();
                $("#revenda_cidade").prev(".asteristico").hide();
                $("#aparencia_produto").prev(".asteristico").hide();
                $("#data_compra").prev(".asteristico").hide();
                $("#nota_fiscal").prev(".asteristico").hide();

                $("div[id^=div_servicos_peca_]").each(function(idx){
                    $(this).show();
                  /* $("#servicos_peca_"+idx).val('');*/
                });
                $(".div_valor_total_pecas").attr("style", "display:none;");
                $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                    $(this).hide();
                });
                lupaPP.each(function(){
                    $(this).removeAttr('preco_peca');
                });

            } else if (option_text == "Garantia de Selo") {
                $("#status_orcamento, .div_valor_total_pecas").hide();
                $("#nota_obrigatoria").text("");
                 $(".txt_nf").text("Nota Fiscal");
             
                $("#aparencia_produto").prev(".asteristico").hide();
                $("#data_compra").prev(".asteristico").hide();
                $("#nota_fiscal").prev(".asteristico").hide();
                lupaPP.each(function(){
                    $(this).removeAttr('preco_peca');
                });

            } else if (option_text == "Orçamento") {
                $("#status_orcamento, .div_valor_total_pecas").show();
                $(".mostra_envia_email").show();

                if ($("#os_id").val() == '') {
                    $("#envia_orcamento_email").prop("disabled", true);
                }
                lupaPP.each(function(){
                    $(this).attr('preco_peca', true);
                });
                $(".txt_nf").text("Nota Fiscal");
                $("#nota_obrigatoria").text("");
                $("#revenda_nome").prev(".asteristico").hide();
                $("#revenda_cnpj").prev(".asteristico").hide();
                $("#revenda_estado").prev(".asteristico").hide();
                $("#revenda_cidade").prev(".asteristico").hide();
                $("#aparencia_produto").prev(".asteristico").hide();
                $("#data_compra").prev(".asteristico").hide();
                $("#nota_fiscal").prev(".asteristico").hide();
                $("#produto_serie").prev(".asteristico").hide();

                $("div[id^=div_servicos_peca_]").each(function(idx){
                    $(this).hide();
                    $("#servicos_peca_"+idx).val('');
                });

                $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                    $(this).show();
                });
                $("div[id^=pecas_referencia_]").each(function() {
                    $(this).attr("class", "span2");
                });
                $("div[id^=pecas_descricao_]").each(function() {
                    $(this).attr("class", "span3");
                });
                $(".div_valor_total_pecas").attr("style", "display:block;");
                <? if (in_array($login_fabrica,array(190)) && $areaAdmin == false) { ?>
                    $(".txt_valor_add").hide()
                    $("#valor_adicional").hide()
                    $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                        $(this).hide();
                    });
                <? } ?>
            } else {
                $(".mostra_envia_email").hide();
                $("#status_orcamento, .div_valor_total_pecas").hide();
                $(".txt_nf").text("Nota Fiscal");
                $("#nota_obrigatoria").text("(Anexo Obrigatório)");
                $("#revenda_nome").prev(".asteristico").show();
                $("#revenda_cnpj").prev(".asteristico").show();
                $("#revenda_estado").prev(".asteristico").show();
                $("#revenda_cidade").prev(".asteristico").show();
                $("#aparencia_produto").prev(".asteristico").show();
                $("#data_compra").prev(".asteristico").show();
                $("#nota_fiscal").prev(".asteristico").show();
                $("div[id^=div_servicos_peca_]").each(function(idx){
                    $(this).show();
                });
                lupaPP.each(function(){
                    $(this).removeAttr('preco_peca');
                });
                $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                    $(this).hide();
                });
                $("div[id^=pecas_referencia_]").each(function() {
                    $(this).attr("class", "span2");
                });
                $("div[id^=pecas_descricao_]").each(function() {
                    $(this).attr("class", "span3");
                });

                $(".div_valor_total_pecas").attr("style", "display:none;");

            }

        });
    <?php }?>    
    <?php if (in_array($login_fabrica, [195])) { ?>

        $("#tipo_atendimento").change(function(){
            
            let option_text = $("#tipo_atendimento > option:selected").text();
            var lupaPP = $("#pecas_produto").find("input[name=lupa_config]");
            $("#div_valores_adicionais").show();

            if (option_text == "Cortesia com deslocamento" || option_text == "Garantia com deslocamento") {

                $("#informacoes_agendamento").show();
                $("#produto_referencia").prev(".asteristico").hide();
                $("#produto_descricao").prev(".asteristico").hide();
                $("#produto_defeito_constatado").prev(".asteristico").hide();


            }  else if (option_text == "Orçamento") {
                $("#status_orcamento, .div_valor_total_pecas").show();
                $(".mostra_envia_email").show();

                if ($("#os_id").val() == '') {
                    $("#envia_orcamento_email").prop("disabled", true);
                }
                lupaPP.each(function(){
                    $(this).attr('preco_peca', true);
                });
                $(".txt_nf").text("Nota Fiscal");
                $("#nota_obrigatoria").text("");
                $("#revenda_nome").prev(".asteristico").hide();
                $("#revenda_cnpj").prev(".asteristico").hide();
                $("#revenda_estado").prev(".asteristico").hide();
                $("#revenda_cidade").prev(".asteristico").hide();
                $("#aparencia_produto").prev(".asteristico").hide();
                $("#data_compra").prev(".asteristico").hide();
                $("#nota_fiscal").prev(".asteristico").hide();
                $("#produto_serie").prev(".asteristico").hide();

                $("div[id^=div_servicos_peca_]").each(function(idx){
                    $(this).hide();
                    $("#servicos_peca_"+idx).val('');
                });

                $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                    $(this).show();
                });
                $("div[id^=pecas_referencia_]").each(function() {
                    $(this).attr("class", "span2");
                });
                $("div[id^=pecas_descricao_]").each(function() {
                    $(this).attr("class", "span3");
                });
                $(".div_valor_total_pecas").attr("style", "display:block;");
                <? if (in_array($login_fabrica,array(190)) && $areaAdmin == false) { ?>
                    $(".txt_valor_add").hide()
                    $("#valor_adicional").hide()
                    $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                        $(this).hide();
                    });
                <? } ?>
                $("#informacoes_agendamento").hide();

            } else {
                $("#produto_referencia").prev(".asteristico").show();
                $("#produto_descricao").prev(".asteristico").show();
                $("#produto_defeito_constatado").prev(".asteristico").show();
                $(".mostra_envia_email").hide();
                $("#status_orcamento, .div_valor_total_pecas").hide();
                $(".txt_nf").text("Nota Fiscal");
                $("#nota_obrigatoria").text("(Anexo Obrigatório)");
                $("#revenda_nome").prev(".asteristico").show();
                $("#revenda_cnpj").prev(".asteristico").show();
                $("#revenda_estado").prev(".asteristico").show();
                $("#revenda_cidade").prev(".asteristico").show();
                $("#aparencia_produto").prev(".asteristico").show();
                $("#data_compra").prev(".asteristico").show();
                $("#nota_fiscal").prev(".asteristico").show();
                $("div[id^=div_servicos_peca_]").each(function(idx){
                    $(this).show();
                });
                lupaPP.each(function(){
                    $(this).removeAttr('preco_peca');
                });
                $("div[id^=pecas_valor_total_], div[id^=pecas_valor_]").each(function() {
                    $(this).hide();
                });
                $("div[id^=pecas_referencia_]").each(function() {
                    $(this).attr("class", "span2");
                });
                $("div[id^=pecas_descricao_]").each(function() {
                    $(this).attr("class", "span3");
                });

                $(".div_valor_total_pecas").attr("style", "display:none;");
                $("#informacoes_agendamento").hide();

            }

            if (option_text == "Orçamento") {
                $("#div_solicita_troca_produto_orcamento_195").show();
                $("#div_solicita_troca_produto_195").hide();
            } else {
                $("#div_solicita_troca_produto_orcamento_195").hide();
                $("#div_solicita_troca_produto_195").show();
            }

            verifica_valores_adicionais();

        });
    <?php }?>
    <?php if (in_array($login_fabrica, [177])) { ?>

            $(".qtde_peca_item").filter(function(){
                return $(this).val() != "";
            }).each(function(){

                let posicao = $(this).attr("posicao");

                calcula_valor_total_pecas(posicao);

            });

            $(".valor_peca").each(function(){
                if ($(this).val() != "") {
                    $(this).blur();
                }
            });

            $(document).on("blur", ".valor_peca", function () {
                var posicao_valor = $(this).attr("posicao");
                calcula_valor_total_pecas(posicao_valor);
            });
    
        $("#tipo_atendimento").change(function(){
            
            let option_text = $("#tipo_atendimento > option:selected").text();

            if (option_text == "Orçamento") {
                $("#orcamento_status, .div_valor_total_pecas").show();

                $("#revenda_nome").prev(".asteristico").hide();
                $("#revenda_cnpj").prev(".asteristico").hide();
                $("#revenda_estado").prev(".asteristico").hide();
                $("#revenda_cidade").prev(".asteristico").hide();
                $("#aparencia_produto").prev(".asteristico").hide();
                $("#data_compra").prev(".asteristico").hide();
                $("#nota_fiscal").prev(".asteristico").hide();

                $("div[id^=div_servicos_peca_]").each(function(idx){
                    $(this).hide();
                    $("#servicos_peca_"+idx).val('');
                });
            } else {
                $("#orcamento_status, .div_valor_total_pecas").hide();

                $("#revenda_nome").prev(".asteristico").show();
                $("#revenda_cnpj").prev(".asteristico").show();
                $("#revenda_estado").prev(".asteristico").show();
                $("#revenda_cidade").prev(".asteristico").show();
                $("#aparencia_produto").prev(".asteristico").show();
                $("#data_compra").prev(".asteristico").show();
                $("#nota_fiscal").prev(".asteristico").show();
                $("div[id^=div_servicos_peca_]").each(function(idx){
                    $(this).show();
                });
            }

        });

        $("#tipo_atendimento").change();
    <?php
    }

    if($login_fabrica == 131){
    ?>

        $("#produto_causa_defeito").focus(function(){
            let defeitos = $("#defeitos_constatados_multiplos").val();

            $.ajax({
                url: "<?=$SERVER["PHP_SELF"]?>",
                type: "POST",
                data: {ajax_causa_defeito: true,"defeitos":defeitos},
                complete: function(data){

                    let causas = JSON.parse(data.responseText);
			if(causas.erro) {
                    $('#produto_causa_defeito').html("<option value=''>Adicione o defeito_constatado</option>");
}else{
                    $('#produto_causa_defeito').html("<option value=''>Selecione</option>");

                    $.each(causas, function(i,item) {
                        $('#produto_causa_defeito').append("<option value='"+item.codigo+"'>"+item.descricao+"</option>");
                    });
}
                }
            });
        });


        $(document).on("focus","select[name^=produto_pecas]",function(){

            let obj = $(this);
            let defeitos = $("#defeitos_constatados_multiplos").val();

            $.ajax({
                url: "<?=$SERVER["PHP_SELF"]?>",
                type: "POST",
                data: {ajax_servico_defeito: true,"defeitos":defeitos},
                complete: function(data){

                    let servicos = JSON.parse(data.responseText);

                    $(obj).html("<option value=''>Selecione</option>");

                    $.each(servicos, function(i,item) {
                        $(obj).append("<option value='"+item.codigo+"'>"+item.descricao+"</option>");
                    });
                }
            });
        });

    <?php
    }
    ?>

    $("#adicionar_valor_adicional").click(function(){

        let div_valor_adicional = $(".div_valor_adicional:first").clone().hide();
        $(div_valor_adicional).css({
            "margin-left": "15px"
        });

        let input = $("<input>", {
                        class: "label-valor-adicional form-control",
                        placeholder: "Descrição",
                        type: "text",
                        css: {
                            width: "82.5%",
                            "font-size": "11.844px"
                        },
                        keyup: function(){

                            let label = $(this).val();
                            let valor = $(this).closest(".div_valor_adicional").find(".valor_adicional_valor").val();

                            $(this).closest(".div_valor_adicional").find("input[type=checkbox]").val(label+"|"+valor);

                        }
                    });

        let btn_remover = $("<button></button>", {
                                class: "btn-remover-adicional btn btn-danger btn-small",
                                type: "button",
                                text: "x",
                                css: {
                                    width: "17.5%",
                                    height: "35%",
                                },
                                click: function() {
                                    $(this).closest(".div_valor_adicional").remove();
                                }
                          });

        $(div_valor_adicional).find(".valor_adicional_valor").attr("name", "os[valor_adicional_valor]").val("")
        .css({
            "font-size": "11.844px"
        }).bind("change", function() {

            let label = $(this).closest(".div_valor_adicional").find(".label-valor-adicional").val();
            let valor = $(this).val();
            
            $(this).closest(".div_valor_adicional").find("input[type=checkbox]").val(label+"|"+valor);

        });

        $(div_valor_adicional).find("input[type=checkbox], text").hide().val("").prop("checked", true);

        $(div_valor_adicional).find(".valor_adicional_valor").priceFormat({
            prefix: '',
            thousandsSeparator: '',
            centsSeparator: ',',
            centsLimit: 2
        });

        $(div_valor_adicional).prepend(input);
        $(div_valor_adicional).find(".label-valor-adicional").after(btn_remover);

        <?php if (in_array($login_fabrica,[131,139,191])) { ?>
                $(div_valor_adicional).appendTo("#valores_adicionais").find('.valor_adicional_valor').removeAttr('readonly');
        <?php } ?>

        $(div_valor_adicional).appendTo("#valores_adicionais").show("slow");

    });

    <?php
    if (in_array($login_fabrica, [131])) { ?>

        if (!$('#cpf_cnpj').is(":checked") && !$('#cnpj_cpf').is(":checked")) {

            $('#cpf_cnpj').prop("checked", true).change();

        }

    <?php
    }
    ?>

   <?php
	if($login_fabrica == 178){
   ?>
		$("#solicita_troca").click(function(){
            if ($("#os_id").val() != "" && $("#os_id").val() != undefined && $("#marca_troca_selecionada").val() != "" && $("#marca_troca_selecionada").val() != undefined){
                return false;
            }else{
                if( $(this).is(':checked') ){

                    verificaEstoqueRoca();
                    
                    $("#div_marca_produto_troca").show();
                    $("#div_enviar_para").show();
                    $("#produto_pecas").hide();
                    
                    carregaMarcasProdutoTroca();
                    verificaComboEnviarPara();
                    $("#produto_troca").val(null).trigger("change");
                    if ($("#produto_fora_linha").val() == "true"){
                        alert("Produto fora de linha.\nSelecione uma Marca e Produto para solicitar a troca.");
                        $("#div_produto_troca").show();
                    }
                }else{
                    $("#div_marca_produto_troca").hide();
                    $("#div_enviar_para").hide();
                    $("#produto_pecas").show();
                    $("#div_produto_troca").hide();
                }
            }
		});

        $("#produto_troca").select2();

        $("#marca_produto_troca").change(function(){
            $("#produto_troca").val(null).trigger("change"); 
            carregaProdutoTroca();
        });

		if($("#produto_id").val() != ""){
			carregaMarcasProdutoTroca();
			verificaComboEnviarPara();
		}

        if ($("#tipo_atendimento > option:selected").attr("fora_garantia") == 't'){
            $("#div_solicita_troca_produto").hide();
            $("#solicita_troca").prop('checked',false);
        }
   <?php
	}

    if (in_array($login_fabrica, [157])) { ?>
        <?php
        if ($areaAdmin === false) { ?>
            if ($(".box-defeitos tbody > tr").length >= 2) {

                $(".box_defeito_constatado").hide();

            }
        <?php
        } ?>

        $("input[rel=peca_id]").filter(function(){
            return $(this).val() != "";
        }).each(function(){

            let selecionada_antes = $("select[name='produto_pecas["+$(this).attr("posicao")+"][defeito_peca]'] > option:selected").val();

            retorna_defeito_peca($(this).val(), $(this).attr("posicao"), selecionada_antes);


        });

        $("#adicionar_defeito_constatado").click(function(){

            <?php
            if ($areaAdmin === true) { ?>
                addDefeitos();
                return;
            <?php
            }
            ?>

            if ($("#produto_defeito_constatado").val() == "") {
                alert("Selecione um defeito constatado");
                return;
            }

            if ($(".box-defeitos tbody > tr").length > 0) {

                let pecas_lancadas = $(".produto_referencia").filter(function(){
                    return $(this).val() != "";
                }).map(function(){ 
                    return $(this).val();
                }).get();

                let defeitos_lancados = $("#defeitos_constatados_multiplos").val();

                $.ajax({
                    async: false,
                    url: window.location,
                    type: "POST",
                    data: {
                        ajax_defeitos_pecas_lancadas: true,
                        defeitos_lancados: defeitos_lancados,
                        pecas_lancadas_os: pecas_lancadas
                    },
                    dataType: "json",
                }).done(function(data) {
                    
                    if (data.erro) {

                        $(".msg_erro_defeitos").show().find("h5").text(data.msg_erro);

                    } else {

                        $(".msg_erro_defeitos").hide();

                        addDefeitos();

                        <?php
                        if ($areaAdmin === false) { ?>

                            if ($(".box-defeitos tbody > tr").length >= 2) {

                                $(".box_defeito_constatado").hide();

                            }
                        <?php
                        }
                        ?>

                    }

                });
               
            }
        });

    <?php
    }

    if (in_array($login_fabrica, [161]) && empty($os)) { ?>

        $("#div_informacoes_consumidor input").prop("readonly", false);

    <?php
    }

    if (in_array($login_fabrica, [157])) { ?>
        if ($("#produto_id").val() != "") {

            busca_defeito_constatado($("#produto_id").val());

        }
    <?php
    }

    if (in_array($login_fabrica, [148])) { ?>

        $("#tipo_atendimento").change(function(){

            if ($.trim($(this).find("option:selected").text()) == "Garantia") {

                $(".div-data-falha").show();

            } else {

                $(".div-data-falha").hide();

                $("#data_falha").val("");

            }

        });

        $(".servico_peca_realizado:visible").each(function(){

            if ( $(this).find("option:selected").length > 0 ) {

                verifica_servico_estoque_fabrica($(this));

            }

        });

        $(document).on("change", ".servicos_peca_realizado", function(){

            verifica_servico_estoque_fabrica($(this));

        });

    <?php
    } ?>

});

    function verifica_servico_estoque_fabrica (that) {

        let gera_pedido   = $( that ).find("option:selected").attr("gera_pedido");
        let troca_de_peca = $( that ).find("option:selected").attr("troca_de_peca");


        if ( gera_pedido == "t" && troca_de_peca == "t" ) {

            $( that ).closest(".div-linha-peca").find(".div_nf_estoque_fabrica").show();

        } else {

            $( that ).closest(".div-linha-peca").find(".div_nf_estoque_fabrica").hide();

        }

    }
    
    function verifica_sem_serie() {
        if ($("#sem_serie").is(":checked")) {
            $('.tc_formulario[id!=div_peca_anexo]').show();
            $("#div_valores_adicionais").hide();
            $('#os_form_submit').show();
            $("#venda_numero_serie").val('').prop({"readonly": true});

            busca_valor_adicional();

            $("#div_informacoes_revenda input").each(function(){

                $(this).removeAttr("readonly");

                if ($(this).next("span[rel=lupa]").length > 0) {
                    $(this).next("span[rel=lupa]").show();
                }

            });
            $("#revenda_cnpj").mask("99.999.999/9999-99",{placeholder:""});
            $("#revenda_cep").mask("99999-999",{placeholder:""});

            $("#div_informacoes_revenda select").each(function(){
                $(this).removeAttr("readonly");
                $(this).selectreadonly(false);
            });
        } else {

			<? if(empty($os) and count($msg_erro) == 0) { ?>
            $("#venda_numero_serie").val('').prop({"readonly": false});
            $('.tc_formulario[id!=div_informacoes_produto_venda]').hide();
            <?php if ($areaAdmin == true): ?>
            $("#div_informacoes_posto").show();
            <?php endif ?>
			$('#os_form_submit').hide();
			<? }elseif(count($msg_erro) > 0){ ?>
				$('.verifica_serie_venda').click();
			<? } ?>
        }
    }
    
    function submit_form_os() {

        let submit = $("#os_form_submit").data("submit");

        if (submit.length == 0) {
            $("#os_form_submit").data({ submit: true });
            $("input[name=gravar]").val('Gravar');
            $("#os_form_submit").parents("form").submit();
        } else {
            alert("<?php echo traduz("nao.clique.no.botao.voltar.do.navegador.utilize.somente.os.botoes.da.tela");?>");
        }

    }

     /* REMOVE DE FOTOS */
    $(document).on("click", ".btn-remover-anexo", function () {
        var tdocsid = $(this).data("tdocsid");
        var posicao = $(this).data("posicao");

        if (tdocsid != '' && tdocsid != null && tdocsid != undefined) {

            $.ajax({
                url: 'cadastro_os.php',
                type: "POST",
                dataType:"JSON",
                data: { 
                    ajax_remove_anexo: true,
                    tdocsid: tdocsid,
                    posicao: posicao
                }
            }).done(function(data) {
                if (data.erro == true) {
                    alert(data.msg);
                    return false;
                } else {
                    alert("Removido com sucesso.");
                    $("#div_anexo_"+data.posicao).find("img.anexo_loading").hide();
                    $("#div_anexo_"+data.posicao).find("button[name=anexar]").show();
                    $("#div_anexo_"+data.posicao).find(".btn-remover-anexo").hide();
                    $("#div_anexo_"+data.posicao).find(".btn-remover-anexo").data("tdocsid", "");
                    $("#div_anexo_"+data.posicao).find("input[rel=anexo]").val("");
                    $("#div_anexo_"+data.posicao).find("img.anexo_thumb").attr("src", "imagens/imagem_upload.png");
                }
            });

        }

    });

<? if(in_array($login_fabrica, [151,198])) { ?>
    function limpa_pecas(id, valor_anterior) {

        var e = $(id).val();
        var semPecas = true;

        $("#produto_pecas").find("input[rel=peca_id]").each(function() {
            var peca = $(this).val();
            if (peca.length > 0) {
                semPecas = false;
            }
        });

        if (semPecas == false) {
            var conf = confirm("<?php echo traduz('deseja.alterar.o.numero.de.serie.defeito.constatado.caso.confirme.ira.remover.as.pecas.ja.lancadas');?>");
            if (conf == true) {
                $("#produto_pecas").find("button[name=remove_peca]").each(function() {
                    $(this).click();
                });

                $("#produto_pecas").hide();
            } else {
                if (valor_anterior != "") {
                    $(id).val(valor_anterior);
                    return true;
                }
            }
        }

        return false;

    }

    function valida_serie(serie){

        var serie_valida = false;
        var versao_valida = "";
        serie = serie.replace(/\-/, '');

        $.each(mascaras_versoes, function(index, value){
            var mascara_prod = value.mascara;
            var versao_prod  = value.versao;
            var mascara = mascara_prod.replace(/L/g, "[A-Za-z]").replace(/N/g, "[0-9]");

            //var reg = new RegExp(mascara);
            var reg = new RegExp("^"+mascara+"$");
            if(serie.match(reg)){
                serie_valida = true;
                if (versao_prod.match(/\,/g)) {
                    var intervalo = versao_prod.split(",");
                    intervalo.forEach(function(posicao, index){
                        versao_valida += serie[--posicao];
                    });
                } else if (versao_prod.match(/\-/g)) {
                    var intervalo = versao_prod.split("-");
                    versao_valida = serie.slice(--intervalo[0], intervalo[1]);
                } else {
                    versao_valida = serie[--versao_prod];
                }
                return;
            }

        });

        if(serie_valida == false){
            alert("Número de Série Inválido");
            $("#produto_serie").focus();
            <? if($usa_versao_produto){ ?>
                $("#produto_versao").val("");
            <? } ?>
            $("#produto_pecas").hide();

        } else if ($("#produto_defeito_constatado").val().length > 0) {
            var lancar_peca = $("#produto_defeito_constatado").find("option:selected").data("lancar-pecas");
            if (lancar_peca == 't' && (serie.length > 0 && serie != "undefined" )) {
                $("#produto_pecas").show();
            } else {
                $("#produto_pecas").hide();
            }
            $("button[name='lista_basica']").prop("disabled", false);
        } else {
            $("#produto_pecas").show();
            $("button[name='lista_basica']").prop("disabled", false);
        }

        <? if($usa_versao_produto){ ?>
            $("#produto_versao").val(versao_valida);
                busca_vista_explodida($("#produto_id").val());
        <? }

            if (in_array($login_fabrica, array(151))) {
        ?>
                //valida_serie_bloqueada(serie, $("#produto_id").val());
        <?
            }
        ?>
    }

<? } ?>

/**
* Função verifica se o número de série informado esta bloqueado
*/
function valida_serie_bloqueada(serie, produto, msg = false){
    $.ajax({
        url: window.open.href,
        async: false,
        type: "POST",
        data: { 'ajax': 'sim', 'serie_bloqueada': serie, 'produto': produto },
        timeout: 8000
    }).fail(function(){
        $("#produto_pecas").hide();
        $("button[name='lista_basica']").prop("disabled", false);
        if (msg) {
            alert('<?php echo traduz('ocorreu.um.erro.ao.tentar.verificar.o.bloqueio.do.numero.de.serie.tente.novamente.mais.tarde');?>');
        }
    }).done(function(data){
        data = JSON.parse(data);
        if (data.ok) {
            $("#produto_pecas").hide();
            $("button[name='lista_basica']").prop("disabled", false);
            if (msg) {
                alert('<?php echo traduz('numero.de.serie.bloqueada.nao.sera.possivel.lancar.pecas');?>');
            }
        }
    });
}

/**
 * Função para retirar a acentuação
 */
function verifica_revenda_posto(posto){

    $.ajax({
        url : "<?php echo $_SERVER['PHP_SELF']; ?>",
        type: "POST",
        data: { ajax: true, ajax_posto_revenda : true, posto: posto },
        complete: function(data){
            var dados = data.responseText;
            if(dados == "true"){
                $("#tipo_atendimento").find("option").each(function (){
                    if($(this).text() == "Revenda"){
                        $(this).show();
                    }
                })
            }else{
                $("#tipo_atendimento").find("option").each(function (){
                    if($(this).text() == "Revenda"){
                        $(this).hide();
                    }
                })
            }
        }
    });
}


function verifica_revenda_posto_rheem(posto){

    $.ajax({
        url : "<?php echo $_SERVER['PHP_SELF']; ?>",
        type: "POST",
        data: { ajax: true, ajax_posto_revenda_rheem : true, posto: posto },
        complete: function(data){
            var dados = JSON.parse(data.responseText);

            if(dados.posto_revenda == true){
                $("#div_informacoes_revenda").find("span[rel=lupa]").hide();
                $("#revenda_nome").val(dados.nome).prop({"readonly":true});
                $("#revenda_cnpj").val(dados.cnpj).prop({"readonly":true});

                if (dados.cep.length > 0) {
                    $("#revenda_cep").val(dados.cep).prop({"readonly":true});

                     busca_cep(dados.cep, "revenda");

                    if ($("#revenda_bairro").val().length == 0) {
                        $("#revenda_bairro").val(dados.bairro).prop({"readonly":true});
                    }

                    if ($("#revenda_endereco").val().length == 0) {
                        $("#revenda_endereco").val(dados.endereco).prop({"readonly":true});
                    }
                } else {
                    $("#revenda_estado").val(dados.estado).prop({"readonly":true});

                    // busca_cidade(dados.estado, "revenda");

                    $("#revenda_cidade").val(retiraAcentos(dados.cidade_nome).toUpperCase()).prop({"readonly":true});
                    $("#revenda_bairro").val(dados.bairro).prop({"readonly":true});
                    $("#revenda_endereco").val(dados.endereco).prop({"readonly":true});
                }

                $("#revenda_numero").val(dados.numero).prop({"readonly":true});
                $("#revenda_complemento").val(dados.complemento).prop({"readonly":true});
                $("#revenda_telefone").val(dados.fone).prop({"readonly":true});

            }
        }
    });
}

<?php if(in_array($login_fabrica, array(169,170))) { ?>
    function limitarTipoServicosParaAtendimentoForaGarantia(){
        let opcoesServico = $('div[id^=div_servicos_peca_] option[value=11291]');
        // remove as opções de Troca de peças(gera pedido)
        if($("#tipo_atendimento").find("option:selected").attr("fora_garantia")=="t" && $("#tipo_atendimento option:selected").text() != "RECALL DOMICÍLIO"){
            opcoesServico.map( (i,e) => $(e).init().hide());
            // limpar
            $("div[id^=div_servicos_peca_]").each(function() {
                let select = $(this).find('select');
                if(select.val()=='11291')
                    select.val('');
            });
        }else{
            opcoesServico.map((i,e) => $(e).init().show());
        }
    }
    $(function(){
        limitarTipoServicosParaAtendimentoForaGarantia();
    });
<? } ?>

function verificaServicoPeca(peca,posicao)
{
    var posto = $('#posto_id').val();

    $.ajax({
        url:"cadastro_os.php",
        type:"POST",
        dataType:"JSON",
        data:{
            ajax: true,
            ajax_servico_realizado:true,
            posto:posto,
            peca:peca
        }
    })
    .done(function(data){
        $("#servicos_peca_"+posicao).html("");
        $.each(data, function(key, servico_realizado) {
            $("#servicos_peca_"+posicao).append("\
                <option value='"+servico_realizado.servico_realizado+"' troca_de_peca='"+servico_realizado.troca_de_peca+"' gera_pedido='"+servico_realizado.gera_pedido+"' peca_estoque='"+servico_realizado.peca_estoque+"' >"+servico_realizado.descricao+"</option>\
            ");
        });
        <? if (in_array($login_fabrica, array(169,170))) { ?>
           limitarTipoServicosParaAtendimentoForaGarantia();
        <? } ?>
    });
}

function verifica_servico_posto(posto) {

    if (typeof posto == "undefined" || posto.length == 0) {
        return;
    }

    var dataAjax = {
    ajax: true,
    ajax_servico_realizado: true,
    posto: posto
    };

    let qtdePecas = $("#pecas_produto").find(".row-fluid[name^=peca_]").length;

    <? if (in_array($login_fabrica, array(158,174,175))) { ?>
        var tipo_atendimento = $('#tipo_atendimento').val();
        dataAjax.tipo_atendimento = tipo_atendimento;
    <? } ?>

    $.ajax({
        url: "cadastro_os.php",
        type: "POST",
        dataType:"JSON",
    data: dataAjax
    })
    .done(function(data) {
        if (data.length > 0) {
            for (let i = 0; i < qtdePecas; i++) {
                let optionSelected = '';
                let selectedOp = '';
                optionSelected = $("select[name='produto_pecas["+i+"][servico_realizado]']").val();

                $("select[name='produto_pecas["+i+"][servico_realizado]']").html("");
                
                $.each(data, function(key, servico_realizado) {
                    selectedOp = '';
                    if (optionSelected == servico_realizado.servico_realizado) {
                        selectedOp = "SELECTED";
                    }

                    let servR = servico_realizado.servico_realizado;
                    
                    if (typeof servico_realizado.servico_realizado == 'object' || servico_realizado.servico_realizado == null || servico_realizado.servico_realizado == 'null') {
                        servR = '';
                    }

                    $("select[name='produto_pecas["+i+"][servico_realizado]']").append("\
                        <option value='"+servR+"' troca_de_peca='"+servico_realizado.troca_de_peca+"' gera_pedido='"+servico_realizado.gera_pedido+"' peca_estoque='"+servico_realizado.peca_estoque+"'"+selectedOp+" >"+servico_realizado.descricao+"</option>\
                    ");
                });
            }
        }
    });
}

function recarrega_estados(select_estado) {
    var paisOs = $("#pais_posto").val();

    if (paisOs.length == 0) {
	paisOs = '<?=$paisOs;?>';
    }

    $.ajax({
        url: "<?= $_SERVER['PHP_SELF']; ?>",
        type: "POST",
	data: {ajax_recarrega_estados:true,pais:paisOs},
	complete: function(data){
	    var dados = JSON.parse(data.responseText);

            if (dados.length > 0) {
            	select_estado.html("");
		select_estado.append("<option value=''></option>");

            	$.each(dados, function(key, estados) {
                    select_estado.append("\
                        <option value='"+estados.sigla+"'>"+estados.descricao+"</option>\
                    ");
            	});
            } else {
		$(this).hide();
		$(this).after().find("input[id^=t_]").show();
	    }
	}
    });

}

<?php if($login_fabrica == 148){ ?>
function historico_produto(serie){

    Shadowbox.open({
        content: "historico_produto.php?serie="+serie,
        player: "iframe",
        height: 600
    });

}
	<?php if(count($msg_erro["msg"]) > 0){ ?>
        $(function() {
			$('.verifica_serie_venda').click();
		});
<?php
	}
		 } ?>

/**
 * Função para retirar a acentuação
 */
function retiraAcentos(palavra){
    if (!palavra) {
        return "";
    }

    var com_acento = 'áàãâäéèêëíìîïóòõôöúùûüçÁÀÃÂÄÉÈÊËÍÌÎÏÓÒÕÖÔÚÙÛÜÇ';
    var sem_acento = 'aaaaaeeeeiiiiooooouuuucAAAAAEEEEIIIIOOOOOUUUUC';
    var newPalavra = "";

    for(i = 0; i < palavra.length; i++) {
        if (com_acento.search(palavra.substr(i, 1)) >= 0) {
            newPalavra += sem_acento.substr(com_acento.search(palavra.substr(i, 1)), 1);
        } else {
            newPalavra += palavra.substr(i, 1);
        }
    }

    return newPalavra.toUpperCase();
}

/**
* Função de retorna todos os dados do Posto
*/
function busca_dados_posto(posto){

    $.ajax({
        url : "<?php echo $_SERVER['PHP_SELF']; ?>",
        type: "POST",
        data: { ajax: true, ajax_posto : posto },
        complete: function(data){
            var arr_posto = new Array();
            var dados = data.responseText;

            arr_posto = dados.split("|");

            $("#consumidor_nome").val(arr_posto[0]);
            $("#consumidor_cnpj").val(arr_posto[1]);
            $("#consumidor_cep").val(arr_posto[2]);
            $("#consumidor_estado").val(arr_posto[3]);
            $("#consumidor_cidade").val(arr_posto[4]);
            $("#consumidor_bairro").val(arr_posto[5]);
            $("#consumidor_endereco").val(arr_posto[6]);
            $("#consumidor_numero").val(arr_posto[7]);
            $("#consumidor_complemento").val(arr_posto[8]);
            $("#consumidor_telefone").val(arr_posto[9]);
            $("#consumidor_email").val(arr_posto[10]);

        }
    });

}

<? if ($login_fabrica == 143) { ?>
        verifica_tipo_posto_produto_linha();
<? }

if ($areaAdmin === true) { 
    if(in_array($login_fabrica, array(151,180,181,182))) { ?>
        $(function() {
            let paisposto_x = $("#posto_pais").val();
            let paises = ["AR", "BR", "CO", "PE"];               

            if($.inArray(paisposto_x, paises) != '-2' || paisposto_x == ''){                
                $("#consumidor_estado").show();
                $("#consumidor_estado").prop("disabled", false);
                $("#consumidor_cidade").show();
                $("#consumidor_cidade").prop("disabled", false);
                $("#revenda_estado").show();
                $("#revenda_estado").prop("disabled", false);
                $("#revenda_cidade").show();
                $("#revenda_cidade").prop("disabled", false);
                $("#t_consumidor_estado").hide();
                $("#t_consumidor_estado").prop("disabled", true);               
                $("#t_consumidor_cidade").hide();
                $("#t_consumidor_cidade").prop("disabled", true);
                $("#t_revenda_estado").hide();
                $("#t_revenda_estado").prop("disabled", true);
                $("#t_revenda_cidade").hide();
                $("#t_revenda_cidade").prop("disabled", true);                
            } else {
                $("#consumidor_estado").hide();
                $("#consumidor_estado").prop("disabled", true);
                $("#consumidor_cidade").hide();
                $("#consumidor_cidade").prop("disabled", true);
                $("#revenda_estado").hide();
                $("#revenda_estado").prop("disabled", true);
                $("#revenda_cidade").hide();
                $("#revenda_cidade").prop("disabled", true);
                $("#t_consumidor_estado").show();
                $("#t_consumidor_estado").prop("disabled", false);
                $("#t_consumidor_cidade").show();
                $("#t_consumidor_cidade").prop("disabled", false);
                $("#t_revenda_estado").show();
                $("#t_revenda_estado").prop("disabled", false);
                $("#t_revenda_cidade").show();
                $("#t_revenda_cidade").prop("disabled", false);
            }
        });
    <? } ?>

/**
 * Função de retorno da lupa do posto
 */
    function retorna_posto(retorno) {
        /**
         * A função define os campos código e nome como readonly e esconde o botão
         * O posto somente pode ser alterado quando clicar no botão trocar_posto
         * O evento do botão trocar_posto remove o readonly dos campos e dá um show nas lupas
         */
        $("#pais_posto").val(retorno.pais);

        recarrega_estados($("#consumidor_estado"));
	recarrega_estados($("#revenda_estado"));

        $("#posto_id").val(retorno.posto);
        $("#posto_codigo").val(retorno.codigo).attr({ readonly: "readonly" });
        $("#posto_nome").val(retorno.nome).attr({ readonly: "readonly" });
        $("#div_trocar_posto").show();
        $("#div_informacoes_posto").find("span[rel=lupa]").hide();

        <? if(in_array($login_fabrica, array(152,180,181,182))) { ?>                        
            let paises = ["AR", "BR", "CO", "PE"];               
            if($.inArray(retorno.pais, paises) != '-1'){                
                $("#consumidor_estado").show();
                $("#consumidor_estado").prop("disabled", false);
                $("#consumidor_cidade").show();
                $("#consumidor_cidade").prop("disabled", false);
                $("#revenda_estado").show();
                $("#revenda_estado").prop("disabled", false);
                $("#revenda_cidade").show();
                $("#revenda_cidade").prop("disabled", false);
                $("#t_consumidor_estado").hide();
                $("#t_consumidor_estado").prop("disabled", true);               
                $("#t_consumidor_cidade").hide();
                $("#t_consumidor_cidade").prop("disabled", true);
                $("#t_revenda_estado").hide();
                $("#t_revenda_estado").prop("disabled", true);
                $("#t_revenda_cidade").hide();
                $("#t_revenda_cidade").prop("disabled", true);                
            } else {                              
                $("#consumidor_estado").hide();
                $("#consumidor_estado").prop("disabled", true);
                $("#consumidor_cidade").hide();
                $("#consumidor_cidade").prop("disabled", true);
                $("#revenda_estado").hide();
                $("#revenda_estado").prop("disabled", true);
                $("#revenda_cidade").hide();
                $("#revenda_cidade").prop("disabled", true);
                $("#t_consumidor_estado").show();
                $("#t_consumidor_estado").prop("disabled", false);
                $("#t_consumidor_cidade").show();
                $("#t_consumidor_cidade").prop("disabled", false);
                $("#t_revenda_estado").show();
                $("#t_revenda_estado").prop("disabled", false);
                $("#t_revenda_cidade").show();
                $("#t_revenda_cidade").prop("disabled", false);
            }        
        <? } ?> 

        <? if (in_array($login_fabrica, [177])) { ?>
            let selectDOM = $("#pecas_produto").find(".row-fluid[name^=peca_]");
            $.each(selectDOM, function (index, element) {
                let optionDOM = $(element).find('select').find('option');
                $.each(optionDOM, function (idx, elem) {
                    if (retorno.tipos_postos[0].posto_interno == true && $(elem).attr('gera_pedido') == 'f' && idx > 0) {
                        $(elem).hide();
                    } else {
                        $(elem).show();
                    }
                });
            });
        <? } ?>

        <?
        if ($login_fabrica == 143) {
        ?>
            busca_dados_posto(retorno.posto);
        <?
        }

        if ($login_fabrica == 148) {
        ?>
            classifica_tipo_atendimento(retorno.tipos_postos);
        <?
        }

        if (in_array($login_fabrica, array(151,158,163))) {
            if ($login_fabrica == 151) { ?>
                verifica_revenda_posto(retorno.posto);
            <? } ?>
            verifica_servico_posto(retorno.posto);
        <?
        }

        if (in_array($login_fabrica, array(156,158,167,173,176,186,190,195,203))) {
        ?>
            busca_tipo_atendimento(retorno.posto);
        <?
        }

        if (in_array($login_fabrica, array(157,163))) { ?>
            obrigatoriedade_de_anexo(retorno.posto_interno);
            <?php
            if ($login_fabrica == 163) { ?>
                obrigatoriedade_de_consumidor(retorno.posto_interno);
            <?php
            }
        }

        if (in_array($login_fabrica, array(158))) { ?>
            buscaTecnico(retorno.posto);
            buscaUnidadeNegocio(retorno.posto);
            if (retorno.tipos_postos[0].posto_interno == true || retorno.tipos_postos[0].tecnico_proprio == true) {
                obrigatoriedade_de_anexo(true);
            } else {
                obrigatoriedade_de_anexo(false);
            }
        <? }
        if (in_array($login_fabrica, array(165))) { ?>
            buscaTecnico(retorno.posto);
        <? }
        if (in_array($login_fabrica, array(174))) { ?>
            if (retorno.posto_interno == true) {
                $("#div_tecnico").show();
                $("#anexo_obrig").hide();
                buscaTecnico(retorno.posto);
            } else {
                $("#anexo_obrig").show();
            }
        <? }
        
        if ($login_fabrica == 173) {
        ?>
            if (retorno.posto_interno == true) {
                $("#anexo_obrig").hide();
            } else {
                $("#anexo_obrig").show();
            }
        <?php
        }
        
        if ($tipo_posto_multiplo && !in_array($login_fabrica, array(148))) { ?>
            busca_tipo_atendimento(retorno.posto);
        <? }
        if($login_fabrica == 161){ ?>

            var posto_interno = false;
            /*$("#produto_sem_serie").hide();
            $("#prod_s_ns").hide();*/

            retorno.tipos_postos.forEach(function(tipo_posto, i) {
                if (tipo_posto.posto_interno == true) {
                    $("#consumidor_email").before("<h5 class='asteristico'>*</h5>");
                    posto_interno = true;
                    return false;
                }
            });

            //if (posto_interno == true) {
                $("#produto_sem_serie").show();
                $("#prod_s_ns").show();
            //}

        <?php }

        if ($login_fabrica == 164) {
        ?>
            var posto_interno = false;

            $(".box_destinacao").hide();

            retorno.tipos_postos.forEach(function(tipo_posto, i) {
                if (tipo_posto.posto_interno == true) {
                    posto_interno = true;
                    return false;
                }
            });

            if(posto_interno == true){
                $(".box_destinacao").show();
            }

            if (posto_interno == true) {
                $("#produto_serie").prev(".asteristico").remove();
                $("#revenda_cnpj").prev(".asteristico").remove();
                $("#revenda_nome").prev(".asteristico").remove();
                $("#revenda_estado").prev(".asteristico").remove();
                $("#revenda_cidade").prev(".asteristico").remove();
                $("#nota_obrigatoria").remove();
                $("#anexo_obrig").hide();
            } else {
                $("#produto_serie").before("<h5 class='asteristico'>*</h5>");
                $("#revenda_cnpj").before("<h5 class='asteristico'>*</h5>");
                $("#revenda_nome").before("<h5 class='asteristico'>*</h5>");
                $("#revenda_estado").before("<h5 class='asteristico'>*</h5>");
                $("#revenda_cidade").before("<h5 class='asteristico'>*</h5>");
                $("#nota_fiscal").parent().parent().parent().find("label").after("<strong style='color:#B94A48' id='nota_obrigatoria'>(<?php echo traduz('anexo.obrigatorio');?>)</strong >");
                $("#anexo_obrig").show();
            }
        <? }

        if ($login_fabrica == 156) { ?>
            var posto_interno = false;

            retorno.tipos_postos.forEach(function(tipo_posto, i) {
                if (tipo_posto.posto_interno == true) {
                    posto_interno = true;
                    return false;
                }
            });

            var labels = $("#linha_nf_envio label");

            if (posto_interno == true) {
                $("div.div_posto_interno").show();
                $("#reparoNaFabrica").hide();
                $("#reparoNaFabrica input").prop({ checked: false });

                $(labels[0]).text("<?php echo traduz('nf.de.recebimento');?>");
                $(labels[1]).text("<?php echo traduz('data.nf.de.recebimento');?>");
                $(labels[2]).text("<?php echo traduz('valor.nf.de.recebimento');?>");
            } else {
                $("div.div_posto_interno").hide();
                $("#reparoNaFabrica").show();

                $(labels[0]).text("<?php echo traduz('nf.de.envio');?>");
                $(labels[1]).text("<?php echo traduz('data.nf.de.envio');?>");
                $(labels[2]).text("<?php echo traduz('valor.nf.de.envio');?>");
            }
        <? }

        if ($login_fabrica == 164) { ?>
            if (retorno.tipos_postos[0].descricao == "Autorizada MODELO") {
                $("#xtipo_posto").val(retorno.tipos_postos[0].descricao);
                $("#produto_pecas").hide();
            } else {
                $("#produto_pecas").show();
            }
        <? } ?>

        $("#posto_latitude").val(retorno.latitude);
        $("#posto_longitude").val(retorno.longitude);
        $("input[name=lupa_config][tipo=produto]").attr({ posto: retorno.posto });
        $("input[name=lupa_config][tipo=subproduto]").attr({ posto: retorno.posto });

        <? if($login_fabrica == 165) { ?>
            $("#tipo_posto").val(retorno.tipos_postos[0].posto_interno);
            validar_posto(retorno.tipos_postos[0].posto_interno);
        <? }

        if (in_array($login_fabrica, array(169,170))) { ?>
            $("#produto_serie").trigger("change");
        <? } ?>
    }

    /*HD 3572461*/
    <? if($login_fabrica == 165) { ?>
        function validar_posto(tipo_posto)
        {
            if(tipo_posto == false) {
                <?php
                atribuir_obrigatorio();
                validar_posto_externo();
                ?>
                troca_obrigatorio();
            }
        }
    <? } ?>

    function obrigatoriedade_de_anexo(obrigatorio) {

        if (obrigatorio == true) {
            $("#anexo_obrig").hide();
            $("#nota_obrigatoria").hide();
        } else {
            $("#anexo_obrig").show();
            $("#nota_obrigatoria").show();
        }
    }

    function obrigatoriedade_de_consumidor(obrigatorio) {
        if (obrigatorio == true) {
            $("#div_informacoes_consumidor input, #div_informacoes_consumidor select").each(function() {
                $(this).prevAll("h5").remove();
            });
        } else {
            $("#div_informacoes_consumidor input, #div_informacoes_consumidor select").each(function() {
                if ($(this).data("obrigatorio") == 1) {
                    if ($(this).prevAll("h5").length == 0) {
                        $(this).before("<h5 class='asteristico'>*</h5>");
                    }
                }
            });
        }
    }
<? }else{
    if ($login_fabrica == 165) { ?>
        $(window).load(function(){
            troca_obrigatorio();
        });
    <? }
}
 if ($login_fabrica == 164 && $areaAdmin === false) { ?>
    if ($("#xtipo_posto").val() == "Autorizada MODELO") {
        $("#produto_pecas").hide();
    } else {
        $("#produto_pecas").show();
    }
<? } ?>

/**
 * Função de retorno da lupa de revenda
 */
function retorna_revenda(retorno) {
    $("input[name='revenda[id]']").val(retorno.revenda_fabrica);
    $("#revenda_nome").val(retorno.razao);
    $("#revenda_cnpj").val(retorno.cnpj);

    if (retorno.cep.length > 0) {
        $("#revenda_cep").val(retorno.cep);

        <?php if (!in_array($login_fabrica, [180,181,182])) { ?>
            busca_cep(retorno.cep, "revenda");
        <?php } ?>

        if ($("#revenda_bairro").val().length == 0) {
            $("#revenda_bairro").val(retorno.bairro);
        }

        if ($("#revenda_endereco").val().length == 0) {
            $("#revenda_endereco").val(retorno.endereco);
        }
    } else {
        $("#revenda_estado").val(retorno.estado);

        busca_cidade(retorno.estado, "revenda");

        $("#revenda_cidade").val(retiraAcentos(retorno.cidade_nome).toUpperCase());
        $("#revenda_bairro").val(retorno.bairro);
        $("#revenda_endereco").val(retorno.endereco);
    }

    $("#revenda_numero").val(retorno.numero);
    $("#revenda_complemento").val(retorno.complemento);
    $("#revenda_telefone").val(retorno.fone);
}

/**
 * Função de retorno da lupa de produto ela já retorna as inforamções do subproduto caso tenha
 */

<?php
if (in_array($login_fabrica, [151,198])) {
?>
    var mascaras_versoes = {};
<?php

    if(count($msg_erro["msg"]) > 0 || !empty($os) || !empty($_GET['preos'])){
        $sql_mascara = "SELECT mascara, posicao_versao FROM tbl_produto_valida_serie WHERE fabrica = {$login_fabrica} AND produto = ".getValue("produto[id]");
        $res_mascara = pg_query($con, $sql_mascara);

        if(pg_num_rows($res_mascara) > 0){
            for ($i = 0; $i < pg_num_rows($res_mascara); $i++) {
                $mascara            = pg_fetch_result($res_mascara, $i, "mascara");
                $versao             = pg_fetch_result($res_mascara, $i, "posicao_versao");
                $mascaras_versoes[] = array("mascara" => $mascara, "versao" => $versao);
            }

            $mascaras_versoes = json_encode($mascaras_versoes);
            ?>
            mascaras_versoes = <?=$mascaras_versoes?>;
        <?php
        }
    }
}

if ($login_fabrica == 175) {
?>
    function getTecnicosTreinamentoProduto(produto, posto) {
        if (
            typeof produto != 'undefined' && produto != null
            && typeof posto != 'undefined' && posto != null
        ) {
            $.ajax({
               url: window.location,
               async: true,
               timeout: 60000,
               type: 'post',
               data: {
                   ajax: true,
                   acao: 'tecnico_treinamento_produto',
                   produto: produto,
                   posto: posto
               } 
            }).fail(function(res) {
                alert('Erro ao carregar os técnicos, por favor remova o produto e adicione novamente');
            }).done(function(res, req) {
                if (req == 'success') {
                    res = JSON.parse(res);
                    
                    if (res.tecnicos == null || res.tecnicos.length == 0) {
                        alert('Não foram encontrados técnicos com treinamento para efetuar o reparo do produto');
                    } else {
                        res.tecnicos.forEach(function(tecnico, k) {
                            var option = $('<option></option>', {
                               value: tecnico.tecnico,
                               text: tecnico.nome 
                            });
                            $('#tecnico').append(option);
                        });
                    }
                } else {
                    alert('Erro ao carregar os técnicos, por favor remova o produto e adicione novamente');
                }
            });
        }
    }
<?php
}

if ($login_fabrica == 175) {
?>
    function verifica_garantia_produto() {
        let produto = $('#produto_id').val();
        
        $('#produto_garantia').val('');
        
        if (produto.length > 0) {
            let data_venda = $('#produto_serie').data('serie-venda');
            let garantia = $('#produto_serie').data('garantia');
            let data_compra = $('#data_compra').val();
            let hoje = (new Date()).normalizeDate();
            
            if (data_venda.length > 0) {
                [ano, mes, dia] = data_venda.split('-');
                ano = parseInt(ano);
                mes = parseInt(mes);
                mes -= 1;
                dia = parseInt(dia);
                
                data_venda = new Date(ano, mes, dia);
                
                let data_garantia = data_venda.addMonth(parseInt(garantia));
                
                if (data_garantia >= hoje || data_compra.length == 0) {
                    $('#produto_garantia').val(data_garantia.dateToString('/'));
                    return true;
                }
            }
            
            if (data_compra.length > 0) {
                [dia, mes, ano] = data_compra.split('/');
                ano = parseInt(ano);
                mes = parseInt(mes);
                mes -= 1;
                dia = parseInt(dia);
                
                data_compra = new Date(ano, mes, dia);
                
                let data_garantia = data_compra.addMonth(parseInt(garantia));
                
                if (data_garantia >= hoje) {
                    $('#produto_garantia').val(data_garantia.dateToString('/'));
                    return true;
                }
            }
        }
        
        return false;
    }
<?php
}
?>
// setando marca_indice
    if (typeof marca_indice == "undefined")
    {
        marca_indice = '';
    }

function retorna_produto(retorno) {
    <?php
    if (in_array($login_fabrica, [177])) { 
    ?>
        if (retorno.lote == 't') {
            $("#lote, .h5_lote").show();
            $("#produto_lote_hidden").val(retorno.lote);
        }
    <?php
    }
    ?>

    var km_google = $('#tipo_atendimento option:selected').attr("km_google");
    var login_fabrica = '<?= $login_fabrica; ?>';
    var abre_os_dealer = '<?=$abre_os_dealer?>';

    <? if (in_array($login_fabrica, array(142,157))) {
        if ($login_fabrica == 142) { ?>
            if (km_google == "t" && (retorno.entrega_tecnica != "t" || retorno.deslocamento_km != "t")) {
                alert("<?php echo traduz('a.opcao.de.atendimento.com.deslocamento.nao.esta.habilitada.para.o.produto.escolhido');?>");
                return false;
            } else {
                $("#produto_entrega_tecnica").val(retorno.entrega_tecnica);
                $("#produto_deslocamento_km").val(retorno.deslocamento_km);
            }
        <? } else { ?>
            if (km_google == "t" &&  retorno.deslocamento_km != "t") {
                alert("<?php echo traduz('o.deslocamento.nao.esta.habilitado.para.o.produto.selecionado.seleciona.tipo.de.atendimento.balcao');?>");
                return false;
            } else {
                $("#produto_deslocamento_km").val(retorno.deslocamento_km);
            }
        <? }
    }

    if($login_fabrica == 35){ ?>
        $("#produto_deslocamento_km").val(retorno.deslocamento_km);
        if(retorno.deslocamento_km == 't'){
            $(".grupo_tipo_atendimento").show();

        }else{
            $(".grupo_tipo_atendimento").hide();
        }
    <?php }
    //fputti
    
    if ($login_fabrica == 175) {
    ?>
        getTecnicosTreinamentoProduto(retorno.produto, $('#posto_id').val());
    <?php
    }

    // Validações para lançamento do produto na ordem de serviço Midea/Carrier
    if (in_array($login_fabrica, array(169,170))) { ?>
        var fora_garantia = $('#tipo_atendimento option:selected').attr("fora_garantia");
        var grupo_atendimento = $('#tipo_atendimento option:selected').attr("grupo_atendimento");
        var deslocamento_km = retorno.deslocamento_km;

        if (fora_garantia != "t") {
            <?php
            if (empty($os_conjunto) && empty($os) && !$areaAdmin) {
            ?>

            if (fora_garantia == 'f' && deslocamento_km == 't' && abre_os_dealer != 't') {
                alert("<?= traduz('Não é possível abrir OS de garantia para o produto selecionado') ?>");
                return false;
            }
            <?php
            }
            ?>

            if (km_google == 't' && deslocamento_km == 'f' && $.inArray(grupo_atendimento, ['R','G']) == -1) {
                alert("<?php echo traduz('para.o.produto.selecionado.nao.esta.habilitado.a.opcao.de.deslocamento');?>");
                return false;
            }

            if (km_google == 'f' && deslocamento_km == 't' && $.inArray(grupo_atendimento, ['R','G']) == -1) {
                alert("<?php echo traduz('para.o.produto.selecionado.nao.esta.habilitado.a.opcao.de.balcao');?>");
                return false;
            }
        }
    <? } ?>

    <?php if ($login_fabrica == 178){ ?>
        comboMarcaProduto(retorno.marcas_produto);
	$("#produto_descricao").attr({ readonly: "readonly" });
    <?php } ?>

    if (login_fabrica == 161 && $('#sem_ns').is(':checked')) {
        $("#produto_id").val(retorno.produto);
        $("#tipo_produto").val(retorno.tipo_produto);
        $("#produto_referencia").val(retorno.referencia);
        $("#produto_descricao").val(retorno.descricao);
        $("#produto_referencia_disabled").val(retorno.referencia);
        $("#produto_descricao_disabled").val(retorno.descricao);
        $("#produto_voltagem").val(retorno.voltagem);
        $("#div_trocar_produto").show();
    } else {
        $("#produto_id").val(retorno.produto);
        $("#tipo_produto").val(retorno.tipo_produto);
        <?php if ($login_fabrica == 161): ?>
        $("#produto_referencia").val(retorno.referencia);
        $("#produto_descricao").val(retorno.descricao);
        $("#produto_referencia_disabled").val(retorno.referencia);
        $("#produto_descricao_disabled").val(retorno.descricao);

		if(retorno.numero_serie_obrigatorio =='t') {
			$("#produto_sem_serie").hide();
		}
		if (retorno.linha == '1439' && retorno.familia == '5989') {
			$("#produto_sem_serie").show();
		}

        <?php else: ?>
        $("#produto_referencia").val(retorno.referencia).attr({ readonly: "readonly" });
        $("#produto_descricao").val(retorno.descricao).attr({ readonly: "readonly" });
        <?php endif ?>
        $("#produto_voltagem").val(retorno.voltagem);
        if (login_fabrica == 171 || login_fabrica == 178 || login_fabrica == 183) {
            $(".div_p").show();
        } else {
            $("#div_trocar_produto").show();
        }
        $("#div_informacoes_produto").find("span[rel=lupa_produto]").hide();

        if(login_fabrica == 35){
            informaNumeroSerieAceitos(retorno.produto, login_fabrica);
        }
    }

    if (retorno) {
    <? if ($login_fabrica == 161 and isset($_POST)) {
            $sqlLinha = "SELECT linha FROM tbl_linha WHERE linha = " . $_POST['retorno']['linha'] . ";"; 
            $resLinha = pg_query($con, $sqlLinha);

            if (pg_fetch_result($resLinha, 0, linha) == '1439') {
                $sqlFamilia = "SELECT familia FROM tbl_familia WHERE familia = " . $_POST['retorno']['familia'] . ";"; 
                $resFamilia = pg_query($con, $sqlFamilia);
                if (pg_fetch_result($resFamilia, 0, familia) == '5989') { ?>
                    $("#produto_sem_serie").show();
                <? } 
            }

        } ?>
    }

    <? if (in_array($login_fabrica,array(158,165))) { ?>
        if (typeof retorno.data_venda != "undefined") {
            $("#data_venda").val(retorno.data_venda);
        } else {
            $("#data_venda").val("");
        }

        if (typeof retorno.data_fabricacao != "undefined") {
            $("#data_fabricacao").val(retorno.data_fabricacao);
        } else {
            $("#data_fabricacao").val("");
        }
    <? }

    if ($login_fabrica == 165) { ?>
        $("#produto_serie").val(retorno.serie_produto);
    <? }

    if (in_array($login_fabrica, array(169,170))) { ?>
        if (retorno.mascaras != null && retorno.mascaras.length > 0) {
            $("ul.mascaras > li").remove();

            (retorno.mascaras.split(";")).forEach(function(mascara, k) {
                $("ul.mascaras").append("<li>"+mascara+"</li>");
            });

            $("#produto-serie-mascaras").show();
        } else {
            $("ul.mascaras > li").remove();
        }

        $("#produto_serie").trigger("change");

        if (typeof retorno.serie_produto != "undefined") {
            $("#produto_serie").val(retorno.serie_produto).attr({ readonly: "readonly" });
            $("#produto-serie-mascaras").hide();
        } else {
            $("#produto-serie-mascaras").show();
        }

        $("#produto_deslocamento_km").val(deslocamento_km);
        $("#fricon").find("span[rel=lupa_produto]").hide();
    <? } ?>

    busca_comunicados(retorno.produto, false);

    <? if ($login_fabrica == 162) { ?>
        if(retorno.informatica == 'f'){
            $(".campo_imei").show();
        }else if(retorno.informatica == 't'){
            $(".linha_prod_s_ns").show();
            $("#prod_s_ns").show();
        }

        $("#linha_informatica").val(retorno.informatica);
    <? }

    if (!in_array($login_fabrica, array(158,169,170))) { ?>
        $("#fricon").find("span[rel=lupa_produto]").show();
    <? } ?>

    <? if ($login_fabrica == 153) { ?>
        pega_acessorios(retorno.produto);
    <? }

    if (isset($fabrica_usa_subproduto)) { ?>
        $("#subproduto_id").val("");
        $("#subproduto_referencia").val("");
        $("#subproduto_descricao").val("");
        $("#subproduto_voltagem").val("");

        if (retorno.subproduto == true) {
            $("#div_informacoes_subproduto").show();

            <? if (in_array($login_fabrica, array(138))) { ?>
                if (!($("#tipo_atendimento").find("option:selected").attr("visita_tecnica") == "t" && $("input[name='os[garantia]']:checked").val() == "f")) {
                    $("#div_subproduto_pecas").show();
                }
            <? } else { ?>
                $("#div_subproduto_pecas").show();
            <? } ?>
        } else {
            $("#div_informacoes_subproduto").hide();
            $("#div_subproduto_pecas").hide();
        }
    <? }

    if($login_fabrica == 52){ ?>
        busca_defeito_reclamado(retorno.produto);
    <? } else { ?>
        busca_defeito_constatado(retorno.produto);
    <? }

    if (isset($usaDefeitoReclamadoCadastro)) { ?>
        busca_defeito_reclamado(retorno.produto);
        $("#produto_familia").val(retorno.familia);
    <? }

    if (isset($defeitoReclamadoCadastroDefeitoReclamadoCliente)){ ?>
        busca_defeito_reclamado(retorno.produto);
        $("#produto_familia").val(retorno.familia);
    <?php }

    if (in_array($login_fabrica, array(138)) || isset($usaSolucao) && !in_array($login_fabrica, array(52,158))) {
        if ($login_fabrica != 138) { ?>
            retorno.tipo_produto = null;
        <? }

        if ($login_fabrica != 158) { ?>
            busca_solucao(retorno.produto,retorno.tipo_produto,false,null,null);
        <? }
    }
    if(!in_array($login_fabrica, array(143,175,195))){
        if (in_array($login_fabrica, array(169,170))){
        ?>
            busca_vista_explodida(retorno.produto,false,retorno.serie_produto);
        <?php
        }else{
        ?>
            busca_vista_explodida(retorno.produto);
        <?php
        }
    } else { 
        if ($login_fabrica != 175 && $login_fabrica != 195){
    ?>
        verifica_tipo_posto_produto_linha();
    <? 
        }
    }

    if ($fabrica_usa_valor_adicional) {
        if (!in_array($login_fabrica,array(158,169,170,195))) { ?>
            busca_valor_adicional();
<? }else if(in_array($login_fabrica,array(169,170)) && !empty($os)){
    ?>
        verifica_valores_adicionais();
    <?
        }else{
            if (!in_array($login_fabrica,array(195))) {
    ?>
        busca_valor_adicional();
    <?
        }
        }
    }
    if(!in_array($login_fabrica, array(145,164,169,170))){ ?>
        if (retorno.numero_serie_obrigatorio == "t"){

            <? if($login_fabrica == 161 && $postoInterno == true){ ?>
                $("#produto_serie").prev("h5.asteristico").remove();
            <? } else if($login_fabrica == 162){ ?>
                if(retorno.informatica == 'f'){
                    $("#produto_serie").prev("h5.asteristico").remove();
                }
            <? } else { ?>
                if ($("#produto_serie").prev("h5.asteristico").length == 0) {
                    $("#produto_serie").before("<h5 class='asteristico'>*</h5>");
                }
            <? } ?>
        } else {
            <? if($login_fabrica != 160 and !$replica_einhell) { ?>
                $("#produto_serie").prev("h5.asteristico").remove();
            <? } ?>
        }
    <? } ?>

    <?php if ($login_fabrica == 176){ ?>
        var descricao_tipo_atendimento =  $("#tipo_atendimento option:selected").text();

        if (descricao_tipo_atendimento == "Instalação"){
            setTimeout(function(){
                $("#produto_pecas").hide();
            },200);
        }else{
            setTimeout(function(){
                $("#produto_pecas").show();
            },200);
        }
    <?php } ?>

    <?php if (in_array($login_fabrica, array(145))) { ?>
        if ($("#tipo_atendimento").find("option:selected").val() != "198" ) {
            verifica_produto_troca(retorno.troca_obrigatoria);
        }
    <? } else if(in_array($login_fabrica, array(157))){ ?>
        var visita_tecnica = $("#tipo_atendimento").find("option:selected").attr("visita_tecnica");

        if (typeof visita_tecnica != "undefined" && visita_tecnica == "t") {
            $("#produto_pecas").hide();
            $("button[name=remove_peca]").click();
        }else{
            verifica_produto_troca(retorno.troca_obrigatoria);
        }
    <? }else if ($login_fabrica != 139) { ?>
        verifica_produto_troca(retorno.troca_obrigatoria);
    <? }

    if($login_fabrica == 145){ ?>
        pega_foto_produto(retorno.produto, login_fabrica);
    <? }

    if(in_array($login_fabrica, [151,198])){ ?>
        mascaras_versoes = retorno.mascaras_versoes;
    <? }

    if($login_fabrica == 52){ ?>
        $("#produto_familia").val(retorno.familia);
    <? }

    if($login_fabrica == 153){ ?>
        $("#produto_serie").blur(function(){
            var serie      = $("#produto_serie").val();
            var produto_id = $("#produto_id").val();
            var fabrica    = <?=$login_fabrica?>;

            $.ajax({
                type: "POST",
                url: "cadastro_os.php",
                cache:false,
                data: { ajax: true, ajax_verifica_recall:true, serie:serie, produto_id:produto_id, fabrica:fabrica },
                success: function(resposta){
                    if(resposta.length > 0){
                        alert(resposta);
                    }
                }
            });
        });

        var descricao_tipo_atendimento = $("#tipo_atendimento option:selected").text();

        if(descricao_tipo_atendimento == 'Laudo Zero Hora'){
            $("#produto_pecas").hide();
        }

    <?php } ?>

    <?php if($login_fabrica == 161){ ?>

        var cnpj_revenda = retorno.cnpj_revenda;
        if(cnpj_revenda != ""){
            busca_revenda(cnpj_revenda);
        }

    <?php } ?>

    <?php if($login_fabrica == 164){ ?>

        $("input[name='produto[origem_produto]']").val(retorno.origem);

        $("#numero_serie_calefator").val("");
        $("#cor_indicativa_carcaca").val("");
        $("#numero_serie_interno_placa_motor").val("");

        if(retorno.origem == "NAC"){

            $(".box_numero_serie_calefator").show();
            $(".box_cor_indicativa_carcaca").show();
            $(".box_numero_serie_interno_placa_motor").show();

        }else{

            $(".box_numero_serie_calefator").hide();
            $(".box_cor_indicativa_carcaca").hide();
            $(".box_numero_serie_interno_placa_motor").hide();

        }
        if ($("#xtipo_posto").val() == "Autorizada MODELO") {
            $("#produto_pecas").hide();
        }
    <?php } ?>

    <?php if(in_array($login_fabrica, [167, 203])){ //HD-3428328 ?>

        if(retorno.suprimento == 't'){
            $("#produto_pecas").hide();
            $("#comunicado_suprimento").show();
            $("#valida_suprimento").val(retorno.suprimento);
        }else{
            $("#produto_pecas").show();
            $("#comunicado_suprimento").hide();
            $("#valida_suprimento").val("");
        }

        if(retorno.descricao_familia.indexOf("Impressora") != -1 || retorno.descricao_familia.indexOf("Multifunciona") != -1){
            $("#contador").show();
            $("#valida_contador").val(retorno.descricao_familia);
        }else{
            $("#contador").hide();
            $("#valida_contador").val("");
        }

        <?php if (in_array($login_fabrica, [203])) { ?>
            if (retorno.codigo_linha == '01' || retorno.codigo_linha == '02') {
                $("#contador").show();

                if (retorno.codigo_linha != '02') {
                    $("#contador").find("h5").hide();
                } else {
                    $("#contador").find("h5").show();
                }
            }
        <?php } ?>

        var descricao_tipo_atendimento = $("#tipo_atendimento option:selected").text();

        if(descricao_tipo_atendimento == 'Garantia Recusada'){
            $("#produto_pecas").hide();
        }else{
            if(retorno.suprimento != 't'){
                $("#produto_pecas").show();
            }
    }

    <?php } ?>


    // índice Lofra
    <?php
        if ($login_fabrica == 176) { ?>
            marca_indice = retorno.marca_indice;
            if (marca_indice == 't' || marca_indice == 'true')
            {
                <?php if ($areaAdmin === true){ ?>
                    setTimeout(function(){
                        $("#os_indice").before("<h5 class='asteristico'>*</h5>");
                        $("#os_indice").attr('data-obrigatorio', 1);
                        $("#mostrar_indice_aux").val('f');
                        $("#div_os_indice").show();
                        $("#produto_pecas").show();
                    },200);
                <?php }else if ($areaAdmin === false){  ?>
                    setTimeout(function(){
                        $("#mostrar_indice_aux").val('t');
                        $("#os_indice").before("<h5 class='asteristico'>*</h5>");
                        $("#os_indice").attr('data-obrigatorio', 1);
                        $("#div_os_indice").show();
                        $("#produto_pecas").hide();
                        $("#indice_alerta").show();
                        $("#mostra_indice_alerta").val('t');
                    },200);
                <?php } ?>
            }else
            {
                <?php if ($areaAdmin === true){ ?>
                    setTimeout(function(){
                            $("#div_os_indice").hide();
                            $("#mostra_indice_alerta").val('f');
                        },200);
            <?php }else if ($areaAdmin === false){  ?>
                        setTimeout(function(){
                            $("#produto_pecas").show();
                            $("#div_os_indice").hide();
                            $("#mostra_indice_alerta").val('f');
                        },200);
            <?php } ?>
            }
    <?php } ?>
 
    if (login_fabrica == 175){
        if (retorno.capacidade > 0){
            $("#div_qtde_disparos").show();
            $("#produto_disparos").val("true");
        }else{
            $("#div_qtde_disparos").hide();
            $("#quantidade_disparos").val("");
        }
    }

    <?php if ($login_fabrica == 161): ?>
    $("#sem_serie").prop("checked", false);
    $('.tc_formulario[id!=div_informacoes_produto_venda]').hide();
    <?php if ($areaAdmin == true): ?>
    $("#div_informacoes_posto").show();
    <?php endif ?>
    $("#produto_pecas").hide();
    $('#os_form_submit').hide();

    <?php if ($postoInterno == false): ?>
    $.ajax({
        url: "<?php echo $_SERVER['PHP_SELF']; ?>",
        type: "POST",
        async: false,
        data: {
            ajax: true,
            verifica_familia_autoclave: true,
            produto_referencia: $("#produto_km_googlereferencia").val()
        },
        complete: function(data) {
            json = JSON.parse(data.responseText);

            if (json.error) {
                $("#venda_numero_serie").prev().remove();
                $("#produto_sem_serie").show();
            }

            if (json.message && json.message == "Ok") {
                $("#venda_numero_serie").before("<h5 class='asteristico'>*</h5>");
                if(retorno.linha != 1126){
                    if (retorno.numero_serie_obrigatorio == "t") {
                        $("#produto_sem_serie").hide();
                    }
                }
                
            }
        },
    });
    <?php endif ?>

    <?php endif ?>

    <?php if ($login_fabrica <> 200){ ?>
        pega_servico_realizado(retorno.linha, retorno.produto);
    <?php } ?>
    
    if(login_fabrica == 161 && retorno.linha == 1126){
        $('#produto_sem_serie').show();
        $("#linhaproduto").val(retorno.linha);
        $("#acessorios").attr("readonly", true);
        $(".tipodeos").hide();
        $(".divacessorios").hide();
    }else if(login_fabrica == 161 && retorno.linha != 1126){

        if (retorno.numero_serie_obrigatorio == "t") {
            $('#produto_sem_serie').hide();
        }

        $("#acessorios").attr("readonly", false);
        $("#linhaproduto").val(retorno.linha);
        $(".divacessorios").show();
        $(".tipodeos").show();
    }

    <?php
    if ($login_fabrica == 161) { ?>

        if (retorno.codigo_familia == '271' && retorno.codigo_linha == '03') {

            $("#produto_sem_serie").show();

        }

    <?php
    } ?>

     <?php if($login_fabrica == 35){?>
        if(retorno.produto_critico == "t"){
            $("#produto_pecas").hide();
            $("#produto_pecas_mensagem").show();
            $('#produto_critico').val('t');
        }
    <?php 
    }
    
    if (in_array($login_fabrica, array(175))){
    ?>  
        var produto_id = retorno.produto;
        var linha_id   = retorno.linha;
        verifica_certificado_tecnico(produto_id,linha_id);
        $("#produto_serie").data('serie-venda', '');
        $("#produto_serie").data('garantia', retorno.garantia);
        
        if (typeof retorno.serie_produto != 'undefined' && retorno.serie_produto.length > 0) {
            $("#produto_serie").attr({ readonly: "readonly" });
            $(".lupa_serie").hide();
            
            if (retorno.serie_data_venda.length > 0) {
                $("#produto_serie").data('serie-venda', retorno.serie_data_venda);
            }
        }
        
        verifica_garantia_produto();
    <?php 
    } 
?>
    if (login_fabrica == 177){
        if (retorno.lote == 't'){
            $(".h5_lote").show();
        }else{
            $(".h5_lote").hide();
        }
    }

    <?php if ($login_fabrica == 52) { /*HD - 6201206*/?>
        if (retorno.marca != "" && retorno.marca != undefined) {
            $("#produto_marca").val(retorno.marca);
        }
    <?php } ?>

    <?php if ($login_fabrica == 178) { /*HD - 6306841*/?>
            var ta_fora_garantia = $('#tipo_atendimento option:selected').attr("fora_garantia");
            if (ta_fora_garantia == 't'){
                $("#div_solicita_troca_produto").hide();
                $("#solicita_troca").prop('checked',false);
            }else{
                $("#div_solicita_troca_produto").show();
            }
    <?php } ?>

    <?php if (in_array($login_fabrica, [174]) && empty($os)) { ?>
        $("#produto_pecas").hide();
    <?php } ?>

    <?php if (in_array($login_fabrica, [186,190,195])) { ?>
        var descricao_tipo_atendimento = $("#tipo_atendimento option:selected").text();

        if(descricao_tipo_atendimento == 'Orçamento'){
            $("#produto_serie").prev("h5.asteristico").remove();
        }
    <?php } ?>

    <?php
    if (in_array($login_fabrica, [169,170])) { ?>

        if ($("#tipo_atendimento option:selected").text() == "Triagem") {

            $("#produto_pecas").hide();

        }

    <?php
    }
    ?>
    <?php if (in_array($login_fabrica, [191])) { ?>
	var produto_id = $("#produto_id").val();
        var tipo_produto = $("#tipo_produto").val();

        busca_defeito_reclamado(retorno.produto);
        busca_solucao(retorno.produto);
    <?php } ?>

    <?php if (in_array($login_fabrica, [193])) { ?>
    var hora_tecnica     = retorno.hora_tecnica;
    var lancamento       = retorno.lancamento;  
    var tipo_atendimento = $('#tipo_atendimento option:selected').attr('km_google');

    if (hora_tecnica != "" && hora_tecnica > 0 && tipo_atendimento == 't') {
        $("#div_tempo_conserto").show(); 
        $("#show_tempo_conserto").val('t');
    } else {
        $("#div_tempo_conserto").hide(); 
        $("#show_tempo_conserto").val('f');
    }
    <?php } ?>
    <?php if (in_array($login_fabrica, [190])) { ?>
       var descricao_tipo_atendimento = $("#tipo_atendimento option:selected").text();
        if(descricao_tipo_atendimento == 'Preventiva'){
            if (retorno.limite_horas_trabalhadas == 'true') {
                $(".mostra_horimetro").show();                
                $("#limite_horas_trabalhadas").val(true);                
            } else {
                $(".mostra_horimetro").hide();                
                $("#limite_horas_trabalhadas").val('');                
            }
        }
    <?php } ?>

}

function pega_servico_realizado(linha, produto = null){
    var dataAjax = {
        ajax: true,
        ajax_servico_realizado: true,
        produto_id: produto
    };

    <? if (in_array($login_fabrica, array(158))) { ?>
         var tipo_atendimento = $('#tipo_atendimento').val();
         dataAjax.tipo_atendimento = tipo_atendimento;
    <? } ?>


    $.ajax({
        url: "cadastro_os.php",
        type: "POST",
        dataType:"JSON",
    data: dataAjax
    })
    .done(function(data) {
        if (data.length > 0) {
            $("#modelo_peca, #pecas_produto").find("select[name*=servico_realizado]").html("");

                $.each(data, function(key, servico_realizado) {
                    if(linha == 1126 ){
                        $("#modelo_peca, #pecas_produto").find("select[name*=servico_realizado]").append("\
                        <option value='"+servico_realizado.servico_realizado+"' troca_de_peca='"+servico_realizado.troca_de_peca+"' gera_pedido='"+servico_realizado.gera_pedido+"' peca_estoque='"+servico_realizado.peca_estoque+"' >"+servico_realizado.descricao+"</option>\
                    ");    
                    }else if(linha != 1126 && servico_realizado.descricao != "Registro"){
                        $("#modelo_peca, #pecas_produto").find("select[name*=servico_realizado]").append("\
                        <option value='"+servico_realizado.servico_realizado+"' troca_de_peca='"+servico_realizado.troca_de_peca+"' gera_pedido='"+servico_realizado.gera_pedido+"' peca_estoque='"+servico_realizado.peca_estoque+"' >"+servico_realizado.descricao+"</option>\
                    "); 
                    }                    
                });
        }
    });
}

function verifica_certificado_tecnico(produto_id,linha_id){
    $.ajax({
        type: "POST",
        dataType:"JSON",
        url: "cadastro_os.php",
        data: { ajax: 'sim', action: 'verifica_certificado_tecnico', produto_id: produto_id, linha_id: linha_id },
    }).done(function(response) {
        if (response.ok !== undefined){
            $("#div_tecnico_show").show();
        }else{
            $("#div_tecnico_show").hide();
        }
    });
}

<?php 
    if ($login_fabrica == 175 AND isset($_GET['os_id']) AND $_GET['os_id'] != ''){
        $get_produto_id = $_RESULT["produto"]['id'];
        $get_linha_id = $_RESULT["produto"]['produto_linha'];
?>
        var produto_id = '<?=$get_produto_id?>';
        var linha_id   = '<?=$get_linha_id?>';
        verifica_certificado_tecnico(produto_id,linha_id);
<?php
    }
?>

// #LOFRA, alteração OS, mostra índice
<?php
    if ($login_fabrica == 176)
    {
        if (isset($_GET['os_id']) && $_GET['os_id'] != '')
        {

            if ($areaAdmin === true)
            {
                $indice               = getValue("os[indice]");
                $visivel              = getValue("produto[marca_indice]");
                if ($visivel == 't' || $visivel == 'true') {
?>
                     setTimeout(function(){
                        $("#os_indice").before("<h5 class='asteristico'>*</h5>");
                        $("#os_indice").attr('data-obrigatorio', 1);
                        $("#os_indice").val('<?php echo $indice; ?>');
                        $("#div_os_indice").show();
                        $("#produto_pecas").show();
                    },200);
<?php
                }
            }else if ($areaAdmin === false)
            {
                if ($visivel == 't' || $visivel == 'true') {
?>
                    setTimeout(function(){
                        $("#mostrar_indice_aux").val('t');
                        $("#os_indice").before("<h5 class='asteristico'>*</h5>");
                        $("#os_indice").attr('data-obrigatorio', 1);
                        $("#div_os_indice").show();
                        $("#produto_pecas").hide();
                        $("#indice_alerta").show();
                        $("#mostra_indice_alerta").val('t');
                    },200);
<?php           }else
                { ?>
                    setTimeout(function(){
                        $("#mostrar_indice_aux").val('t');
                        $("#os_indice").attr('data-obrigatorio', 1);
                        $("#div_os_indice").show();
                        $("#produto_pecas").show();
                        $("#mostra_indice_alerta").val('f');
                    },200);
<?php
                }
            }
        }
    }
?>
<?php if($login_fabrica == 161){ ?>

function busca_revenda(cnpj_revenda){

    $.ajax({
        url: "<?php echo $_SERVER['PHP_SELF']; ?>",
        type: "POST",
        data: {
            ajax: true,
            busca_revenda: true,
            cnpj: cnpj_revenda
        },
        complete: function(data){
            data = JSON.parse(data.responseText);

            if(data.retorno == "true"){

                $("#revenda_cidade").selectreadonly(false);
                $("#revenda_estado").selectreadonly(false);

                $("input[name='revenda[id]']").val(data.revenda);
                $("#revenda_nome").val(data.nome);
                $("#revenda_cnpj").val(cnpj_revenda);
                $("#revenda_cep").val(data.cep);
                $("#revenda_bairro").val(data.bairro);
                $("#revenda_endereco").val(data.endereco);
                $("#revenda_numero").val(data.numero);
                $("#revenda_complemento").val(data.complemento);
                $("#revenda_telefone").val(data.fone);

                busca_cidade(data.estado, "revenda", data.cidade);

                setTimeout(function(){

                    $("#revenda_cidade").val(data.cidade);
                    $("#revenda_estado").val(data.estado);

                    setTimeout(function(){

                        $("#revenda_cidade").attr({ readonly: "readonly" });
                        $("#revenda_cidade").selectreadonly(true);

                        $("#revenda_estado").attr({ readonly: "readonly" });
                        $("#revenda_estado").selectreadonly(true);

                        $("#revenda_cidade").find("option").each(function() {
                            if (!$(this).is(":selected")) {
                                $(this).remove();
                            }
                        });

                        $("#revenda_estado").find("option").each(function() {
                            if (!$(this).is(":selected")) {
                                $(this).remove();
                            }
                        });

                    }, 1000);

                }, 1000);

            }else{
                alert("<?php echo traduz('revenda.nao.encontrada.para.esse.numero.de.serie');?>.");
            }
        }
    });

}

<?php } ?>

<?php if(in_array($login_fabrica, [167, 203])){ //HD-3428297 ?>

function verifica_serie_peca(id_peca, posicao){
    var descricao_tipo_atendimento = $("#tipo_atendimento option:selected").text();
    $.ajax({
        url: "<?php echo $_SERVER['PHP_SELF']; ?>",
        type: "POST",
        data: {
            ajax: true,
            verifica_serie_peca: true,
            id_peca: id_peca
        },
        complete: function(data){
            data = JSON.parse(data.responseText);
            if(data.retorno == "true"){
                if(descricao_tipo_atendimento == "Orçamento"){
                    $("#serie_peca_"+posicao).hide();
                }else{
                    $("#serie_peca_"+posicao).show();
                }

                $("input[name='produto_pecas["+posicao+"][valida_serie_peca]']").val(data.numero_serie_peca);
            }else{
                $("#serie_peca_"+posicao).hide();
                $("input[name='produto_pecas["+posicao+"][serie_peca]']").val("");
                $("input[name='produto_pecas["+posicao+"][valida_serie_peca]']").val("");
            }
        }
    });

}

function verifica_servico_peca(id_peca, posicao){
    var descricao_tipo_atendimento = $("#tipo_atendimento option:selected").text();

    if(descricao_tipo_atendimento == "Orçamento"){
        $("#serie_peca_"+posicao).hide();

        $.ajax({
            url: "<?php echo $_SERVER['PHP_SELF']; ?>",
            type: "POST",
            data: {
                ajax: true,
                verifica_servico_peca: true,
                id_peca: id_peca,
                descricao_atendimento: descricao_tipo_atendimento
            },
            complete: function(data){
                data = JSON.parse(data.responseText);

                if(data.retorno == "true"){
                    $("#servicos_peca_"+posicao).val(data.id_servico_realizado);
                }else{
                    $("#servicos_peca_"+posicao).val("");
                }
            }
        });
    }
}

<?php } ?>

function pega_acessorios(produto_id){

    var produto_id    = produto_id;
    var login_fabrica = <?=$login_fabrica?>;

    $.ajax({
        type: "POST",
        url: "cadastro_os.php",
        cache:false,
        data: { ajax: true, ajax_pega_acessorios:true, produto_id:produto_id, login_fabrica: login_fabrica },
        success: function(resposta){
            $("#acessorio_positron").html(resposta);
            if(resposta.length > 0){
                var descricao_tipo_atendimento = $("#tipo_atendimento option:selected").text();
                if(descricao_tipo_atendimento != 'Laudo Zero Hora'){
                    $("#positron_acessorio").show();
                }


            }
        }
    });
}

function pega_foto_produto(produto_id, login_fabrica){
    var produto_id    = produto_id;
    var login_fabrica = login_fabrica;

    $.ajax({
        type: "POST",
        url: "buscaFotoProduto.php",
        data: { ajax: true, pegaFotoProduto: true, produto_id: produto_id, login_fabrica: login_fabrica },
        success: function(resposta){
            if (typeof resposta != "undefined" && resposta.length > 0) {
                $("#foto_Produto").html(resposta);
                setupZoom();
                $("#div_foto").show();
            } else {
                $("#foto_Produto").html("");
                $("#div_foto").hide();
            }
        }
    });
}

function busca_defeito_reclamado(produto = null) {

    var fora_garantia       = $('#tipo_atendimento option:selected').attr("fora_garantia");
    var tipo_atendimento    = $('#tipo_atendimento option:selected').val();
    var defeito_reclamado_anterior  = $("#defeito_reclamado option:selected").val();

    <?php
    if (in_array($login_fabrica, [169,170])) { ?>
        if ($("#tipo_atendimento option:selected").text() == "Reoperação") {
            return;
        }
    <?php
    }
    ?>

    <?php
    if ($login_fabrica == 158) {
    ?>
        if ($("#os_garantia").val() == 1) {
            fora_garantia = "t";
        }
    <?php
    }
    ?>

    $.ajax({
        url: "<?= $_SERVER['PHP_SELF']; ?>",
        type: "POST",
        data: {
            ajax: true,
            defeito_reclamado : true,
            produto : produto,
            tipo_atendimento : tipo_atendimento,
            fora_garantia : fora_garantia
        }
    }).always(function(data){

        data = JSON.parse(data);
        $("#defeito_reclamado").html("<option value=''></option>");

        $.each(data.retorno, function(key, value){

            var option = "<option value='"+value.defeito_reclamado+"'>"+value.descricao+"</option>";

            $("#defeito_reclamado").append(option);

        });

        <?php
        if ($login_fabrica == 161) { ?>
         //   $("#defeito_reclamado option[value="+defeito_reclamado_anterior+"]").prop("selected", true);
        <?php
        } ?>

    });
}

<?php
if (isset($fabrica_usa_subproduto)) {
?>
    /**
     * Função de retorno da lupa de subproduto
     */
    function retorna_subproduto(retorno) {
        $("#subproduto_id").val(retorno.produto);
        $("#subproduto_referencia").val(retorno.referencia).attr({ readonly: "readonly" });
        $("#subproduto_descricao").val(retorno.descricao).attr({ readonly: "readonly" });
        $("#subproduto_voltagem").val(retorno.voltagem);
        $("#div_trocar_subproduto").show();
        $("#div_informacoes_subproduto").find("span[rel=lupa_subproduto]").hide();
        var produto_id = $("#produto_id").val();
        var tipo_produto = $("#tipo_produto").val();

        busca_solucao(produto_id,tipo_produto,true,retorno.produto,retorno.tipo_produto);
        busca_defeito_constatado(retorno.produto, true);
        busca_vista_explodida(retorno.produto, true);
        <?php
        if($login_fabrica != 145){
        ?>
            if (retorno.numero_serie_obrigatorio == "t" ){
                if ($("#subproduto_serie").prev("h5.asteristico").length == 0) {
                    $("#subproduto_serie").before("<h5 class='asteristico'>*</h5>");
                }
            } else {
                $("#subproduto_serie").prev("h5.asteristico").remove();
            }


        <?php
        }
        ?>

        <?php
        if($fabrica_usa_valor_adicional){
        ?>
            busca_valor_adicional();
        <?php
        }
        ?>

        busca_comunicados(retorno.produto, true);
    }
<?php
}
?>

    $("div[id^=div_anexo_]").each(function(i) {
        var tdocs_id = $("#div_anexo_"+i).find(".btn-remover-anexo").data("tdocsid");
        if (tdocs_id != '' && tdocs_id != null && tdocs_id != undefined) {
            $("#div_anexo_"+i).find("button[name=anexar]").hide();
            $("#div_anexo_"+i).find(".btn-remover-anexo").show();
        } else {
            $("#div_anexo_"+i).find(".btn-remover-anexo").hide();
        }
    });


/**
 *Retorna os defeitos das pe<ças
 name="produto_pecas[3][defeito_peca]"
**/
function retorna_defeito_peca(peca,posicao,selecionada = null){

    var defeitos_selecionados = $("#defeitos_constatados_multiplos").val();

    $.ajax({
        url : "<?= $_SERVER['PHP_SELF']; ?>",
        type: "POST",
        data: { ajax: true, ajax_peca_defeitos: true, peca_id: peca, defeitos_selecionados: defeitos_selecionados },
        complete: function(data){
            data = $.parseJSON(data.responseText);
            if (data.error) {
                <? if($login_fabrica != 151){ ?>
                    alert(data.error);
                <? } ?>
            } else {
                $("select[name='produto_pecas["+posicao+"][defeito_peca]']").find("option").first().nextAll().remove();
                $.each(data, function(key, value) {
                    $.each(value, function(chave, valor) {
                        var option = $("<option></option>", { value: chave, text: valor});
                        $("select[name='produto_pecas["+posicao+"][defeito_peca]']").append(option);
                    });
                });

                if (selecionada != null) {
                    $("select[name='produto_pecas["+posicao+"][defeito_peca]'] > option[value="+selecionada+"]").prop("selected", true);
                }
            }
        }
    });
}

<? if (in_array($login_fabrica, array(169,170))) { ?>
    function retorna_produto_defeito_peca(){

        var defeitos_selecionados = $("#defeitos_constatados_multiplos").val();
        var tipoAtendimento = $("#tipo_atendimento option:selected").text();
        
        $.ajax({
            url : "<?= $_SERVER['PHP_SELF']; ?>",
            type: "POST",
            data: { ajax: true, ajax_produto_peca_defeito: true, defeitos_selecionados: defeitos_selecionados, tipo_atendimento: tipoAtendimento },
            complete: function(data){
                console.log(data.responseText);
                data = $.parseJSON(data.responseText);
                if (data.error) {
                    alert(data.error);
                } else {

                    let valorAnterior = "<?= getValue('produto[defeito_peca]') ?>";

                    $("select[name='produto[defeito_peca]']").find("option").first().nextAll().remove();
                    $.each(data, function(key, value) {
                        $.each(value, function(chave, valor) {

                            let selected = (valorAnterior == chave) ? true : false;

                            var option = $("<option></option>", { value: chave, text: valor, selected: selected});
                            $("select[name='produto[defeito_peca]']").append(option);
                        });
                    });
                }
            }
        });
    }
<? } ?>

/**
 * Função de retorno da lupa de peças
 */
function retorna_peca(retorno) {
    var subproduto = ((retorno.subproduto != undefined) ? retorno.subproduto : false);
    var quantidade_peca_lista_basica = retorna_quantidade_peca_lista_basica(retorno.peca);
    var quantidade_peca_lista_basica = parseFloat(quantidade_peca_lista_basica);
    var pecasExcedenteLB = '<?= $pecasExcedenteLB; ?>';
    var quantidade_cancelada = 0;
    var quantidade_faturada = 0;
    var quantidade_peca_atual = 0;
    var lancar_mesma_peca = false;

    <?php if (in_array($login_fabrica, [175])) { ?>
            let tipoUnidade = ['c', 'm', 'mm', 'cm', 'dm', 'mt', 'dam', 'hm', 'km'];

            if ($.inArray(retorno.unidade, tipoUnidade) === -1 ) {            
                $("input[id^=qtde_").numeric();
                $("input[id^=qtde_").on('blur', function(){
                    let val = $(this).val().replace(',', '.');
                    val = val.replace('.', '');
                    $(this).val(val);
                });
            }
    <?php }?>

    <?php if(in_array($login_fabrica, array(158))){ ?>
    if(retorno.lbm_parametros_adicionais != undefined){
        var lista_subitem = lista_basica_subitem(retorno.peca, retorno.produto, retorno.posicao);
    }
    <?php } ?>

    if (subproduto) {
        var peca_lancada = verifica_peca_os(retorno.peca, true);
    } else {
        var peca_lancada = verifica_peca_os(retorno.peca);
    }

    if (peca_lancada) {
        if (subproduto === false) {
            $("#pecas_produto").find("input[rel=peca_id]").each(function() {
                if (retorno.peca == $(this).val()) {
                    quantidade_cancelada += isNaN(parseFloat($(this).parents("div.row-fluid").find("input[id^=peca_cancelada_]").val())) ? 0 : parseFloat($(this).parents("div.row-fluid").find("input[id^=peca_cancelada_]").val());
                    quantidade_faturada += isNaN(parseFloat($(this).parents("div.row-fluid").find("input[id^=peca_faturada_]").val())) ? 0 : parseFloat($(this).parents("div.row-fluid").find("input[id^=peca_faturada_]").val());
                    quantidade_peca_atual += isNaN(parseFloat($(this).parents("div.row-fluid").find("input[id^=qtde_]").val())) ? 0 : parseFloat($(this).parents("div.row-fluid").find("input[id^=qtde_]").val());
                }
            });
        }
    }

    if (subproduto) {
        if (peca_lancada === false || (pecasExcedenteLB == 't' && peca_lancada === true)) {
            $("input[name='subproduto_pecas["+retorno.posicao+"][id]']").val(retorno.peca);
            $("input[name='subproduto_pecas["+retorno.posicao+"][referencia]']").val(retorno.referencia).attr({ readonly: "readonly" });
            $("input[name='subproduto_pecas["+retorno.posicao+"][descricao]']").val(retorno.descricao).attr({ readonly: "readonly" });
            $("div[name=subproduto_peca_"+retorno.posicao+"]").find("span[rel=lupa_peca]").hide();
            $("div[name=subproduto_peca_"+retorno.posicao+"]").find("button[name=remove_peca]").show();
        } else {
            alert("Peça "+retorno.referencia+" - "+retorno.descricao+" com a quantidade máxima já lançada na Ordem de Serviço");
            return;
        }
    } else {

        <?php if (in_array($login_fabrica, [167, 203])) { ?>
                if (peca_lancada === true && quantidade_peca_atual == quantidade_faturada + quantidade_cancelada) {
                    lancar_mesma_peca = true;
                }
        <?php } ?>

        if (peca_lancada === false || (peca_lancada === true && (quantidade_peca_lista_basica > quantidade_peca_atual - quantidade_cancelada)) || (pecasExcedenteLB == 't' && peca_lancada === true && quantidade_peca_atual == quantidade_faturada + quantidade_cancelada) || lancar_mesma_peca == true) {
            
            if (peca_lancada === true && (quantidade_peca_lista_basica <= quantidade_peca_atual - quantidade_cancelada)) {
                $("#div_peca_excedente_"+retorno.posicao).show();
                $("input[name='produto_pecas["+retorno.posicao+"][tem_obs]").val('t');
            }

            $("input[name='produto_pecas["+retorno.posicao+"][id]']").val(retorno.peca);
            <? if (in_array($login_fabrica, array(148,151,169,170))) { ?>
                $("input[name='produto_pecas["+retorno.posicao+"][referencia]']").val(retorno.referencia + " - " + retorno.descricao).attr({ readonly: "readonly" });
            <? } elseif (in_array($login_fabrica, array(171))) {?>
                $("input[name='produto_pecas["+retorno.posicao+"][referencia]']").val(retorno.referencia+" / "+retorno.referencia_fabrica).attr({ readonly: "readonly" });
                $("input[name='produto_pecas["+retorno.posicao+"][descricao]']").val(retorno.descricao).attr({ readonly: "readonly" });
            <? } else { ?>
                $("input[name='produto_pecas["+retorno.posicao+"][referencia]']").val(retorno.referencia).attr({ readonly: "readonly" });
                $("input[name='produto_pecas["+retorno.posicao+"][descricao]']").val(retorno.descricao).attr({ readonly: "readonly" });
            <? }
            if ($login_fabrica == 145) { ?>
                if ($("#tipo_atendimento").val() == 201) {
                    var optionValue = $("select[name='produto_pecas["+retorno.posicao+"][servico_realizado]'] > option[peca_estoque=f][gera_pedido=t]").val();
                    $("select[name='produto_pecas["+retorno.posicao+"][servico_realizado]']").val(optionValue).selectreadonly(true);
                }
            <? }
            if (in_array($login_fabrica, array(151,157,169,170))) { ?>
                retorna_defeito_peca(retorno.peca,retorno.posicao);
		<?php if (in_array($login_fabrica, array(169,170))) { ?>
                    $(".removerDefeito").attr("disabled", true);
                <?php }
            } ?>

            $("div[name=peca_"+retorno.posicao+"]").find("span[rel=lupa_peca]").hide();
            $("div[name=peca_"+retorno.posicao+"]").find("button[name=remove_peca]").show();

            <? if(in_array($login_fabrica, [167, 203])){ //HD-3428297 ?>
                verifica_serie_peca(retorno.peca, retorno.posicao);
                verifica_servico_peca(retorno.peca, retorno.posicao);
            <? }
            if ($login_fabrica == 153) { ?>
                if (retorno.devolucao_obrigatoria == 't') 
{                    $("#dev_obrig_"+retorno.posicao).show();
                }
            <? }
            if (in_array($login_fabrica, array(165,169,170))) { ?>
                verificaServicoPeca(retorno.peca,retorno.posicao);
                <? if ($login_fabrica == 165) { ?>
                    $("#produto_defeito_constatado").selectreadonly(true);
                <? }
            } ?>

            <?php if (in_array($login_fabrica, array(35))) { ?>
                    if(retorno.promocao_site == 't'){
                        $("#po_pecas_"+retorno.posicao).show();
                        $("#hidden_po_pecas_"+retorno.posicao).val(retorno.promocao_site);
                    }
            <?php } ?>
        } else {
	    alert("Peça "+retorno.referencia+" - "+retorno.descricao+" com a quantidade máxima já lançada na Ordem de Serviço");
        }
    }

    <?php
    if (in_array($login_fabrica, array(169,170))) { ?>
        $(".removerDefeito").attr("disabled", true);

    <?php }
    if (in_array($login_fabrica, array(151,157,169,170))) { ?>
           retorna_defeito_peca(retorno.peca,retorno.posicao);
    <?php }
    if (in_array($login_fabrica, array(165))) { ?>
        verificaServicoPeca(retorno.peca,retorno.posicao);
        $("#produto_defeito_constatado").selectreadonly(true);
    <?php }

    if (isset($anexo_peca_os) AND $login_fabrica != 157) { ?>

        if (typeof retorno.anexo_os != "undefined" && retorno.anexo_os == "t") {
            var li_peca_anexo = $("#peca_anexo_model").clone();

            $(li_peca_anexo).attr({ id: "peca_anexo_"+retorno.produto+"_"+retorno.peca }).css({ display: "inline-block" });
            $(li_peca_anexo).find("label").text(retorno.referencia);
            $(li_peca_anexo).find("input[type=hidden][name='anexo_peca[__model__]']").attr({ name: "anexo_peca["+retorno.produto+"]["+retorno.peca+"][0]" });
            $(li_peca_anexo).find("input[type=hidden][name='anexo_peca_s3[__model__]']").attr({ name: "anexo_peca_s3["+retorno.produto+"]["+retorno.peca+"][0]" });
            $(li_peca_anexo).find("button").attr({ produto: retorno.produto, peca: retorno.peca });

            if (subproduto) {
                $("#div_peca_anexo_subproduto > ul").append(li_peca_anexo);

                if ($("#div_peca_anexo_subproduto").not(":visible")) {
                    $("#div_peca_anexo_subproduto").show();
                }
            } else {
                var lista = $("#div_peca_anexo > ul");
                li_peca_anexo.appendTo(lista);
                if (retorno.qtde_anexos !== undefined && retorno.qtde_anexos > 1) {
                    for (var liID='', it=1; it < retorno.qtde_anexos; it++) {
                        liID = ['peca_anexo', retorno.produto, retorno.peca, it].join('_');
                        attrAnexo   = 'anexo_peca['+retorno.produto+']['+retorno.peca+']['+it+']';
                        attrAnexoS3 = attrAnexo.replace('peca', 'peca_s3');
                        $(li_peca_anexo).clone()
                            .attr('id', liID)
                            .find('button')
                                .attr('data-imgid', it)
                            .end()
                            .find('[type=hidden]')
                                .first()
                                    .attr('name', attrAnexo)
                                .end()
                                .next()
                                    .attr('name', attrAnexoS3)
                                .end()
                            .end()
                            .appendTo(lista);
                    }

                    // separa visualmente cada grupo de anexo de peças
                    if (retorno.qtde_anexos > 3) {
                        lista.after('<hr rel= color="white" />');
                    }
                }

                if ($("#div_peca_anexo").not(":visible")) {
                    $("#div_peca_anexo").show();
                }
            }

            var form = $("#model_form_anexo_peca").clone();
            // usar uma variável comum para repassar o número do ID da imagem da peça, se for > 0
            $(form).removeAttr("id");
            $(form).find("input[type=file]").attr({ name: "anexo_peca_upload_"+retorno.produto+"_"+retorno.peca });
            $(form).find("input[name=anexo_produto]").val(retorno.produto);
            $(form).find("input[name=anexo_peca]").val(retorno.peca);

            if (retorno.posicao !== undefined) {
                $(form).find("input[name=anexo_posicao]").val('0');
            }
            $("body").append(form);

            if (retorno.qtde_anexos !== undefined && retorno.qtde_anexos > 1) {
                $(form).append('<input type="hidden" name="anexo_posicao" />').val("0");
                for (var liID='', it=1; it < retorno.qtde_anexos; it++) {
                    fileID      = ['anexo_peca_upload', retorno.produto, retorno.peca, it].join('_');
                    $(form).clone()
                        .find('[type=file]')
                            .attr('name', fileID)
                        .end()
                        .find('[name=anexo_posicao]')
                            .val(it)
                        .end()
                    .appendTo('body');
               }
            }

            $('form[name=form_anexo_peca]').ajaxForm({
                complete: function(data) {
                    data = $.parseJSON(data.responseText);
                    var li_anexo_id = ['#peca_anexo', data.produto, data.peca].join('_');
                    if (data.posicao !== undefined && data.posicao > 0)
                        li_anexo_id += '_' + data.posicao;

                    var LI = $(li_anexo_id);

                    if (data.error) {
                        alert(data.error);
                    } else {

                        var imagem = LI.find("img.anexo_thumb").clone();
                        $(imagem).attr({ src: data.link });

                        LI.find("img.anexo_thumb").remove();

                        var link = $("<a></a>", {
                            href: data.href,
                            target: "_blank"
                        });

                        $(link).html(imagem);

                        $(li_anexo_id+" > label").after(link);

                        if ($.inArray(data.ext, ["doc", "pdf", "docx"]) == -1) {
                            setupZoom();
                        }

                        LI.find("input[rel=anexo]").val(data.arquivo_nome);
                    }
                    LI.find("img.anexo_loading")
                    .hide()
                    .end()
                    .find("button").show()
                    .end()
                    .find("img.anexo_thumb").show();
                    }
            });
        }
    <?php }
    if ($login_fabrica == 175){ ?>
        if (retorno.reducao > 0){
           $("#div_qtde_disparos_peca"+retorno.posicao).show(); 
           $("#pecas_disparos"+retorno.posicao).val("true");
        }else{
            $("#div_qtde_disparos_peca"+retorno.posicao).hide(); 
            $("#pecas_disparos"+retorno.posicao).val("");
        }


        if (retorno.numero_serie_peca == "t"){
            $("#div_numero_serie_peca"+retorno.posicao).show();
            $("#valida_serie_peca"+retorno.posicao).val("true");
        }else{
            $("#div_numero_serie_peca"+retorno.posicao).hide();
            $("#valida_serie_peca"+retorno.posicao).val("");
        }

        $("#produto_serie").prop("readonly", true);
        $(".tooltip_serie").show();
        validaPecaAtendimento();

    <?php }
    if ($login_fabrica == 177){ ?>
        if (retorno.lote == 't'){
            $(".h5_lote"+retorno.posicao+", .peca_lote"+retorno.posicao+", input_lote"+retorno.posicao).show();
            $("#peca_lote"+retorno.posicao).val(retorno.lote);
        }else{
            $(".h5_lote"+retorno.posicao+", .peca_lote"+retorno.posicao+", input_lote"+retorno.posicao).hide();
            $("#peca_lote"+retorno.posicao).val('');
        }

    <?php }

    if (in_array($login_fabrica, array(148,156,163,177,186,190,191,195)) || (in_array($login_fabrica, array(161,167,203)) && ($areaAdmin == true || $postoInterno == true))) { ?>

        var qtde       = retorno.qtde;
        var preco_peca = retorno.preco;
        <?php
        if (in_array($login_fabrica, array(163))) { ?>
            var qtde = 1;
        <?php
        }?>

        $("input[name='produto_pecas["+retorno.posicao+"][qtde]']").val(qtde);
        $("input[name='produto_pecas["+retorno.posicao+"][valor]']").val(preco_peca);

        if (qtde != "" && parseFloat(qtde) > 0) {
            var valor_total_pecas = 0;
            valor_total_pecas     = parseFloat(qtde) * parseFloat(preco_peca);
            $("input[name='produto_pecas["+retorno.posicao+"][valor_total]']").val(valor_total_pecas.toFixed(2));
            <? if (in_array($login_fabrica, array(156,161,163,167,177,186,190,191,195,203))) { ?>
            calcula_valor_total_pecas(retorno.posicao);
            <? } ?>
        }
    <? } ?>

    <?php if ($login_fabrica == 178){ ?>
        servicoRealizadoEstoque(retorno.peca, retorno.posicao);
    <?php } ?>
}

function lista_basica_subitem(peca, produto, posicao){
    if (peca != "" && produto != ""){
        $.ajax({
            url: window.location,
            method: 'POST',
            data: {
                search_list_subitem: true,
                produto:             produto,
                peca:                peca
            },
        }).fail(function(){
            return false;
        }).done(function(data){
            data = $.parseJSON(data);

            if(data.success){

                $.each(data.subitem, function(key, subitem){
                    if($("#pecas_produto").find("input[rel=peca_id][value='']").length == 0){
                        $("#produto_pecas > button[name=adicionar_linha]").click();
                    }
                    posicao++;
                    // if (peca_lancada === true && (quantidade_peca_lista_basica <= quantidade_peca_atual - quantidade_cancelada)) {
                    //     $("#div_peca_excedente_" + posicao).show();
                    //     $("input[name='produto_pecas[" + posicao + "][tem_obs]").val('t');
                    // }
                    $("input[name='produto_pecas[" + posicao + "][id]']").val(subitem.peca);
                    $("input[name='produto_pecas[" + posicao + "][subitem]']").val(peca);
                    $("input[name='produto_pecas[" + posicao + "][referencia]']").val(subitem.referencia).attr({ readonly: "readonly" });
                    $("input[name='produto_pecas[" + posicao + "][descricao]']").val(subitem.descricao).attr({ readonly: "readonly" }); 

                    $("div[name=peca_"+posicao+"]").find("span[rel=lupa_peca]").hide();
                    $("div[name=peca_"+posicao+"]").find("button[name=remove_peca]").show();
                });
                return data;
            } else {
                return false;
            }
        });
    }
}

<?php if ($login_fabrica == 175){ ?>
    function validaPecaAtendimento (){
        var tipoAt = $("#tipo_atendimento").val();
        var temPecas = "";
        if (tipoAt != "" || tipoAt != undefined){
            $("#tipo_atendimento > option").each(function(idx, element){
                if ($(element).val() != tipoAt){
                    $(element).prop("disabled", true);
                }
            });
        }
        $('.produto_peca_descricao').each(function(idx, element){
            if ($(element).val() != '' && $(element).val() != undefined){
                temPecas = "true";
                return;
            }
        });

        if (temPecas != "true"){
            $("#tipo_atendimento > option").each(function(idx, element){
                if ($(element).val() != tipoAt){
                    $(element).prop("disabled", false);
                }
            });
        }
    }
<?php } ?>


<? if (in_array($login_fabrica, array(148,156,158,161,163,167,173,176,177,186,190,191,195,203))) {


    if ($login_fabrica == 148) {
        $sql = "SELECT tipo_atendimento, descricao, grupo_atendimento, entrega_tecnica, fora_garantia, km_google FROM tbl_tipo_atendimento WHERE fabrica = {$login_fabrica} AND ativo IS TRUE";
        $res = pg_query($con, $sql);

        $tipos_atendimentos = array();

        for ($i = 0; $i < pg_num_rows($res); $i++) {
            $tipos_atendimentos[] = array(
                "tipo_atendimento"  => pg_fetch_result($res, $i, "tipo_atendimento"),
                "descricao"         => utf8_encode(pg_fetch_result($res, $i, "descricao")),
                "grupo_atendimento" => (strlen(pg_fetch_result($res, $i, "grupo_atendimento")) == 0) ? "" : pg_fetch_result($res, $i, "grupo_atendimento"),
                "entrega_tecnica"   => (pg_fetch_result($res, $i, "entrega_tecnica") == "t") ? "t" : "f",
                "fora_garantia"     => (pg_fetch_result($res, $i, "fora_garantia") == "t") ? "t" : "f",
                "km_google"         => (pg_fetch_result($res, $i, "km_google") == "t") ? "t" : "f"
            );
        }

        $tipos_atendimentos = json_encode($tipos_atendimentos); ?>

        var tipos_atendimentos = JSON.parse('<?= $tipos_atendimentos; ?>');

        function classifica_tipo_atendimento(tipos_postos){
            var whereTiposAtendimentos = [{ grupo_atendimento: "R" }];

            tipos_postos.forEach(function(tipo_posto, key) {
                if (!tipo_posto.locadora && !tipo_posto.tipo_revenda && !tipo_posto.montadora && !tipo_posto.posto_interno) {
                    whereTiposAtendimentos.push({ grupo_atendimento: "A" });
                }

                if (tipo_posto.tipo_revenda || tipo_posto.locadora) {
                    whereTiposAtendimentos.push({ entrega_tecnica: true });
                }
            });

            $("#tipo_atendimento").html("<option value=''></option>");

            var tipo_atendimento_existentes = [];

            tipos_atendimentos.forEach(function(tipo_atendimento, key) {
                $.each(whereTiposAtendimentos, function(key_regra, regra) {
                    var keys = Object.keys(regra);

                    if (in_array("grupo_atendimento", keys) >= 0) {
                        if (tipo_atendimento.grupo_atendimento == regra.grupo_atendimento) {
                            tipo_atendimento_existentes.push(tipo_atendimento);
                            return false;
                        }
                    } else if (in_array("entrega_tecnica", keys) >= 0) {
                        if (regra.entrega_tecnica === true && tipo_atendimento.entrega_tecnica == "t") {
                            tipo_atendimento_existentes.push(tipo_atendimento);
                            return false;
                        }
                    }
                });
            });

            tipo_atendimento_existentes.forEach(function(tipo_value){
                $("#tipo_atendimento").append("<option value='"+tipo_value.tipo_atendimento+"' km_google='"+tipo_value.km_google+"' visita_tecnica='"+tipo_value.entrega_tecnica+"' fora_garantia='"+tipo_value.fora_garantia+"' grupo_atendimento='"+tipo_value.grupo_atendimento+"' >"+tipo_value.descricao+"</option>");
            });

        }

        function valida_tolerancia_horimetro_revisao(horimetro, revisao, tolerancia) {
            if ($("#tipo_atendimento option:selected").attr("grupo_atendimento") == "R") {
                revisao = parseInt(revisao);
                tolerancia = parseInt(tolerancia);
                var tolerancia_1p  = revisao * (tolerancia / 100);
                var tolerancia_max = revisao + tolerancia_1p;
                var tolerancia_min = revisao - tolerancia_1p;

                if (horimetro < tolerancia_min || horimetro > tolerancia_max) {
                    $("div.alert-tolerancia").show();
                } else {
                    $("div.alert-tolerancia").hide();
                }
            }
        }

        function carregaRegrasRevisao() {
            var revisao = $("#produto_intervalo_revisao").val();
            var div     = $("div.div_regra_revisao");
            var revisao_regra_pecas;
            var revisao_regra_servicos;
            var horas_excecao = 0;
            var i = 0;

            if (revisoes.primeira.horas == revisao) {
                revisao_regra_pecas    = revisoes.primeira.pecas;
                revisao_regra_servicos = revisoes.primeira.servicos;
            } else {
                if (typeof revisoes.excecao != "undefined") {
                    $.each(revisoes.excecao, function(horas, array) {
                        if (revisao % horas == 0) {
                            var x = revisao / horas;

                            if (i == 0 || x < i) {
                                horas_excecao = horas;
                            }
                        }
                    });
                }

                if (horas_excecao > 0) {
                    revisao_regra_pecas    = revisoes.excecao[horas_excecao].pecas;
                    revisao_regra_servicos = revisoes.excecao[horas_excecao].servicos;
                } else {
                    if (typeof revisoes.intervalo.pecas != "undefined") {
                        revisao_regra_pecas    = revisoes.intervalo.pecas;
                        revisao_regra_servicos = revisoes.intervalo.servicos;
                    }
                }
            }

            if (typeof revisao_regra_pecas == "undefined") {
                $("div.div_regra_revisao").hide();
                $("div.div_regra_revisao > table > tbody > tr").remove();
            } else {
                $("div.div_regra_revisao > table > tbody").html("");
                $.each(revisao_regra_pecas, function(key, peca) {
                    var servico = revisao_regra_servicos[key];

                    $("div.div_regra_revisao > table > tbody").append("\
                        <tr>\
                            <td style='color: #000;' >"+pecas_ajax[peca]+"</td>\
                            <td style='color: #000;' >"+servicos_ajax[servico]+"</td>\
                        </tr>\
                    ");
                    $("div.div_regra_revisao strong.regra_revisao").text(revisao);
                    $("div.div_regra_revisao").show();
                });
            }
        }


    <? } else if (in_array($login_fabrica, array(156,158,167,173,176,186,190,195,203))) { ?>
        function busca_tipo_atendimento(posto) {
            if (posto.length > 0) {
                $.ajax({
                    url: "cadastro_os.php",
                    type: "POST",
                    data: { ajax: true, ajax_busca_tipo_atendimento_posto_interno: true, posto: posto },
                    complete: function(data) {

                        data = $.parseJSON(data.responseText);

                        if (data.erro) {
                            alert(data.erro);
                        } else {
                            // MLG - evita misturar elementos ao alterar o Posto
                            $("#tipo_atendimento").html("<option></option>");

                            $.each(data, function(key) {
                                
                                var option = $("<option></option>",{
                                    value: data[key].tipo_atendimento,
                                    text: data[key].descricao,
                                    km_google: data[key].km_google,
                                    fora_garantia: data[key].fora_garantia,
                                    visita_tecnica: data[key].visita_tecnica,
                                    selected: (data.length == 1)? true : false
                                });
                                $("#tipo_atendimento").append(option);
                            });
                        }
                    }
                });
            }
        }

<?php
    }

    if (!in_array($login_fabrica, array(158))) {

        if (in_array($login_fabrica, array(161,163,167,177,186,190,191,195,203))) {

?>

            $(function(){

                $("#valor_adicional").blur(function(){
                    calcula_adicional_desconto();
                });

                $("#desconto").blur(function(){
                    calcula_adicional_desconto();
                });

<?php       
            if ($login_fabrica == 203) { 
?>
                $("#produto_recebido_via_correios").on('click', function(){
                    var recebido = $('#produto_recebido_via_correios').is(':checked');

                    if (recebido){
                        $("#produto_recebido_via_correios").val('t');
                    }else
                    {
                        $("#produto_recebido_via_correios").val('f');
                    }
                });
<?php 
            }

            if ($login_fabrica == 161 && $posto_interno == TRUE) {
?>
                $("#tipo_atendimento").change(function(){
                    if ($(this).val() == 271) {
                        $("#tabela").css("display","block");
                        if ($("#tabela").val() == "") {
                            $("button[name=lista_basica]").prop("disabled",true);
                        }
                    } else {
                        $("#tabela").css("display","none");
                        $("#tabela").val("");
                        $("button[name=lista_basica]").prop("disabled",false);
                    }
                });

                $("#tabela").change(function(){
                    if ($(this).val() != "") {
                        $("button[name=lista_basica]").prop("disabled",false);
                    } else {
                        $("button[name=lista_basica]").prop("disabled",true);
                    }
                });
<?php
            }
?>
            });

            function calcula_adicional_desconto() {

                var valor_total = 0;
                $("input.valor_total_peca").each(function(){
                    var v = $(this).val();
                    if (v.length > 0) {
                        v = v.replace(/\./g, '').replace(/\,/g, '.');
                        valor_total += parseFloat(v);
                    }
                });

                var valor_adicional = $("#valor_adicional").val();
                var valor_desconto  = $("#desconto").val();

                if(valor_total == ""){
                    valor_total = 0;
                }

                if(valor_adicional == "" || valor_adicional === undefined){
                    valor_adicional = 0;
                } else {
                    valor_adicional = valor_adicional.replace('.', '');
                    valor_adicional = valor_adicional.replace(',', '.');
                }

                if(valor_desconto == "" || valor_desconto === undefined){
                    valor_desconto = 0;
                } else {
                    valor_desconto = valor_desconto.replace('.', '');
                    valor_desconto = valor_desconto.replace(',', '.');
                }
                var valor_total_pecas = (parseFloat(valor_total) + parseFloat(valor_adicional)) - parseFloat(valor_desconto);
                $(".preco-total-pecas").text( number_format(valor_total_pecas,2,",","."));

            }

        <? } ?>

        function calcula_valor_total_pecas(posicao, opt_remove) {
            <?php
            if (in_array($login_fabrica, array(167,203))) {
            ?>
            var tipo_atendimento = $("#tipo_atendimento").find("option:selected").attr("fora_garantia");

            if (tipo_atendimento == null || tipo_atendimento.length == 0 || tipo_atendimento != "t") {
                return false;
            }
            <?php
            }
            ?>

            var valor_total_pecas_final = 0;
            var texto_valor_total_pecas_final;

            if (posicao == null && opt_remove == "calcula_total") {
                var valor_total = 0;

                $('.valor_total_peca').each(function(){
                    valor_total = $(this).val();
                    if(!isNaN(valor_total) && valor_total > 0){
                        valor_total_pecas_final = parseFloat(valor_total) + parseFloat(valor_total_pecas_final);
                    }else{
                        valor_total_pecas_final = parseFloat(valor_total_pecas_final) + 0;
                    }
                });

                texto_valor_total_pecas_final = number_format(valor_total_pecas_final,2,",",".");
                $("#valor_total_pecas").val(valor_total_pecas_final);
                $(".preco-total-pecas").text(texto_valor_total_pecas_final);
            } else {
                var qtde       = $("input[name='produto_pecas["+posicao+"][qtde]']").val();
                var preco_peca = $("input[name='produto_pecas["+posicao+"][valor]']").val();
                var valor_total_pecas = 0;



                // O valor no input está com ',' o que está dando problema na validação isNaN()
                // Alterado em: 14/04/2016 (Implantação Elgin Automação)
                if(preco_peca == ""){
                    preco_peca = 0;
                } else {
                    preco_peca = preco_peca.replace('.', '');
                    preco_peca = preco_peca.replace(',', '.');
                }

                if (isNaN(preco_peca)) {
                    return false;
                }

                if (qtde > 0) {
                    valor_total_pecas = parseFloat(qtde) * parseFloat(preco_peca);

                    $("input[name='produto_pecas["+posicao+"][valor_total]']").val(number_format(valor_total_pecas,2,",","."));

                    $('.valor_total_peca').each(function(){
                        var valor_total = $(this).val();
                        valor_total = valor_total.replace('.', '');
                        valor_total = valor_total.replace(',', '.');

                        if(!isNaN(valor_total) && valor_total > 0){
                            valor_total_pecas_final = parseFloat(valor_total) + parseFloat(valor_total_pecas_final);
                        }
                  });

                    $("#valor_total_pecas").val(valor_total_pecas_final);
                    $(".preco-total-pecas").text( number_format(valor_total_pecas_final,2,",","."));
                } else if(opt_remove == "remove") {
                    valor_total_pecas = parseFloat(qtde) * parseFloat(preco_peca);

                    $("input[name='produto_pecas["+posicao+"][valor]']").val("");
                    $("input[name='produto_pecas["+posicao+"][valor_total]']").val("");

                    $('.valor_total_peca').each(function(){
                        var valor_total = $(this).val();

                        valor_total = valor_total.replace(/\./g, '').replace(/\,/g, '.');

                        if (valor_total.length > 0) {
                            valor_total = parseFloat(valor_total);

                            if(!isNaN(valor_total) && valor_total > 0){
                                valor_total_pecas_final = valor_total + parseFloat(valor_total_pecas_final);
                            }
                        }
                    });
                    $("#valor_total_pecas").val(valor_total_pecas_final);
                    $(".preco-total-pecas").text( number_format(valor_total_pecas_final,2,",","."));
                } else {
                    alert("Por favor insira a quantidade para calcular o valor total das peças");
                    $("input[name='produto_pecas["+posicao+"][qtde]']").focus();
                }
            }

            <? if(in_array($login_fabrica, array(161,163,167,177,186,190,191,195,203))){ ?>
                calcula_adicional_desconto();
            <? } ?>
        }
    <? }
}

if (in_array($login_fabrica, array(169,170))) { ?>

    function ocultaDadosConsumidor(tipo){
	if(tipo == 'R'){
		$("#div_informacoes_consumidor").hide();
	}else{
		$("#div_informacoes_consumidor").show();
	}
    }

    function busca_tipo_atendimento() {

        consumidor_revenda = $("#os_consumidor_revenda").val();
        var abre_os_dealer = '<?=$abre_os_dealer?>';
        $.ajax({
            url: "cadastro_os.php",
            type: "POST",
            data: { ajax: true, ajax_tipo_atendimento: true, consumidor_revenda: consumidor_revenda, abre_os_dealer: abre_os_dealer },
            complete: function(data) {
                data = $.parseJSON(data.responseText);
                if (data.erro) {
                    alert(data.erro);
                } else {
                    $("#tipo_atendimento").html("<option></option>");

                    $.each(data, function(key) {
                        var option = $("<option></option>",{
                            value: data[key].tipo_atendimento,
                            text: data[key].descricao,
                            km_google: data[key].km_google,
                            fora_garantia: data[key].fora_garantia,
                            grupo_atendimento: data[key].grupo_atendimento,
                            visita_tecnica: data[key].visita_tecnica,
                            disabled: data[key].disabled
                        });

                        $("#tipo_atendimento").append(option);
                    });
                }
            }
        });

        <?php
            if (strlen($_REQUEST['os']['tipo_atendimento'])){
        ?>
            setTimeout(function(){
                $("#tipo_atendimento").val('<?=$_REQUEST['os']['tipo_atendimento']?>');
            }, 1000);
        <?php
            }
        ?>

    }

<? } ?>


/**
* Função que retorna se o posto já anexou o termo
*/
function ja_anexou(os) {
     $.ajax({
        url: window.location,
        method: 'POST',
        data: {
            ajax: 'sim',
            ja_anexou: 'verificar',
            os: os
        },
        timeout: 8000,
        async: false
    }).fail(function(){
        return false;
    }).done(function(data){
        data = $.parseJSON(data);
        if (data.erro == "nao_gerou") {
            $("#produto_pecas").hide();
            alert("O Termo de Entrega Precisa Ser Gerado");
            $("#div_mensagem_termo").show();
        } else if (data.erro == "nao_anexou") {
            $("#produto_pecas").hide();
            alert("O Termo de Entrega Precisa Ser Anexado");
            $("#div_mensagem_termo").show();
        } else {
            $("#produto_pecas").show();
            $("#div_mensagem_termo").hide();
        }
    });   
}

function duplicaPeca(retorno) {
    $("#posicao_solicitacao").val(retorno[0].posicao);
    $.ajax({
        url: window.location,
        method: 'POST',
        dataType:"JSON",
        data: {
            ajax_duplica: true,
            dados: retorno
        }
    }).fail(function(){
        
    }).done(function(data){

        if (data.motivo) {
            $("#peca_duplicada").val(data.xpeca);
            $("#peca_duplicada_item").val(data.xositem);
            $(".modal-motivo-peca-duplicada").modal("show");
        } else {
            $("#peca_duplicada").val('');
            $("#peca_duplicada_item").val('');
            $("#msg_motivo").html('');
            $("#msg_motivo").removeClass('alert');
            $("#msg_motivo").removeClass('alert-danger');
            $("#msg_motivo").removeClass('alert-success');
        }

    });

}
/**
 * Função de retorno da lista básica
 */
function retorna_pecas(retorno) {
    if (retorno.length > 0) {
        var erro = [];
        <?php if ((in_array($login_fabrica, array(35)) && $areaAdmin == true) || in_array($login_fabrica, [167, 203])) { ?>
            duplicaPeca(retorno);
        <?php }?>
        var erro_qtde = [];

        $.each(retorno, function(key, peca) {
            var quantidade_peca_lista_basica = retorna_quantidade_peca_lista_basica(peca.peca);
            var subproduto = ((peca.subproduto != undefined) ? peca.subproduto : false);
            var peca_cancelada = $("input[id='peca_cancelada_"+peca.peca+"']").val();
            
            if (quantidade_peca_lista_basica == 0) {
                erro_qtde.push(peca.descricao);
	    } else if (verifica_peca_os(peca.peca, subproduto) == true && quantidade_peca_lista_basica <= 0 && peca_cancelada != 0) {
                erro.push(peca.descricao);
            } else {
                if (subproduto) {
                    if ($("#pecas_subproduto").find("input[rel=subproduto_peca_id][value='']").length == 0) {
                        $("#div_subproduto_pecas > button[name=adicionar_linha]").click();
                    }

                    peca.posicao = $("#pecas_subproduto").find("input[rel=subproduto_peca_id][value='']").first().parents("div.row-fluid").attr("name").replace(/\D/g, "");

                } else {
                    if ($("#pecas_produto").find("input[rel=peca_id][value='']").length == 0) {
                        $("#produto_pecas > button[name=adicionar_linha]").click();
                    }

                    peca.posicao = $("#pecas_produto").find("input[rel=peca_id][value='']").first().parents("div.row-fluid").attr("name").replace(/\D/g, "");
                }

                retorna_peca(peca);
            }
        });

        if (erro.length > 0) {
            alert("<?php echo traduz('as.seguintes.pecas.ja.foram.lancadas.na.ordem.de.servico');?>: "+erro.join(", "));
        }

        
        if (erro_qtde.length > 0) {
            alert("<?=traduz('As seguintes peças não estão disponível para lançamento')?>: "+erro_qtde.join(", ")+". <?=traduz('Favor entrar em contato com a fábrica')?>");
        }
    }
}

/**
* Função que retorna a quantidade de peças na lista basica
*/
function retorna_quantidade_peca_lista_basica(peca) {
    var quantidade_peca = 0;

    <? if (in_array($login_fabrica, array(169,170,175))) { ?>
        var serie = $('#produto_serie').val();
    <? } else { ?>
        var serie = null;
    <? } ?>
    
    $.ajax({
        url: window.location,
        method: 'POST',
        data: {ajax: 'sim', consulta: 'qtde_listabasica', peca: peca, produto: $('#produto_id').val(), serie: serie},
        timeout: 8000,
        async: false
    }).fail(function(){
        quantidade_peca = 0
    }).done(function(data){
        data = JSON.parse(data);
        if (data.error == undefined) {
            quantidade_peca = data.ok;
        }
    });
    return quantidade_peca;
}

function verifica_peca_os(peca, elemento, subproduto = false) {
    var retorno = false;
    var elemento = (subproduto != undefined && subproduto === true) ? "input[rel=subproduto_peca_id][id!='subproduto_pecas[modelo][id]']" : "input[rel=peca_id][name!='produto_pecas[modelo][id]']";

    $(elemento).each(function(){
        if (peca != undefined && peca != null) {
            if ($(this).val().length > 0 && $(this).val() == peca) {
                retorno = true;
            }
        } else {
            if ($(this).val().length > 0) {
                retorno = true;
            }
        }
    });

    return retorno;
}

/**
 * Função que busca as cidades do estado e popula o select cidade
 */
function busca_cidade(estado, consumidor_revenda, cidade) {
    $("#"+consumidor_revenda+"_cidade").find("option").first().nextAll().remove();

    var paisPosto = $("#pais_posto").val();

    if (estado.length > 0) {
        $.ajax({
            async: false,
            url: "cadastro_os.php",
            type: "POST",
            data: { ajax: true, ajax_busca_cidade: true, estado: estado, pais: paisPosto },
            beforeSend: function() {
                if ($("#"+consumidor_revenda+"_cidade").next("img").length == 0) {
                    $("#"+consumidor_revenda+"_cidade").hide().after($("<img />", { src: "imagens/loading_img.gif", css: { width: "30px", height: "30px" } }));
                }
            },
            complete: function(data) {
                data = $.parseJSON(data.responseText);

                if (data.error) {
                    alert(data.error);
		    $("#t_"+consumidor_revenda+"_cidade").prop('disabled', false);
                } else {
                    $.each(data.cidades, function(key, value) {
                        var option = $("<option></option>", { value: value, text: value });
                        $("#"+consumidor_revenda+"_cidade").append(option);
                    });
		    $("#t_"+consumidor_revenda+"_cidade").hide();
                }
                $("#"+consumidor_revenda+"_cidade").show().next().remove();
            }
        });
    }

    if(typeof cidade != "undefined" && cidade.length > 0){
        $("#consumidor_cidade option[value='"+cidade+"']").attr('selected','selected');
    }

}

/**
 * Função que faz um ajax para buscar o cep nos correios
 */
function busca_cep(cep, consumidor_revenda, method) {

    <?php
    if ($login_pais != "BR" && !$areaAdmin) {
        echo "return;";
    } else if ($areaAdmin) { ?>

        if ($("#pais_posto").val() != "" && $("#pais_posto").val() != "BR") {
            return;
        }

    <?php
    }
    ?>

    if (cep.length > 0) {
        var img = $("<img />", { src: "imagens/loading_img.gif", css: { width: "30px", height: "30px" } });

        if (typeof method == "undefined" || method.length == 0) {
            method = "webservice";

            $.ajaxSetup({
                timeout: 3000
            });
        } else {
            $.ajaxSetup({
                timeout: 5000
            });
        }

        $.ajax({
            async: true,
            url: "ajax_cep.php",
            type: "GET",
            data: { ajax: true, cep: cep, method: method },
            beforeSend: function() {
                $("#"+consumidor_revenda+"_estado").next("img").remove();
                $("#"+consumidor_revenda+"_cidade").next("img").remove();
                $("#"+consumidor_revenda+"_bairro").next("img").remove();
                $("#"+consumidor_revenda+"_endereco").next("img").remove();

                $("#"+consumidor_revenda+"_estado").hide().after(img.clone());
                $("#"+consumidor_revenda+"_cidade").hide().after(img.clone());
                $("#"+consumidor_revenda+"_bairro").hide().after(img.clone());
                $("#"+consumidor_revenda+"_endereco").hide().after(img.clone());
            },
            error: function(xhr, status, error) {
                busca_cep(cep, consumidor_revenda, "database");
            },
            success: function(data) {
                results = data.split(";");

                if (results[0] != "ok") {
                    alert(results[0]);
                    $("#"+consumidor_revenda+"_cidade").show().next().remove();
                } else {
                    $("#"+consumidor_revenda+"_estado").val(results[4]);

                    busca_cidade(results[4], consumidor_revenda);
                    results[3] = results[3].replace(/[()]/g, '');

                    $("#"+consumidor_revenda+"_cidade").val(retiraAcentos(results[3]).toUpperCase());

                    if (results[2].length > 0) {
                        $("#"+consumidor_revenda+"_bairro").val(results[2]);
                    }

                    if (results[1].length > 0) {
                        $("#"+consumidor_revenda+"_endereco").val(results[1]);
                    }
                }

                $("#"+consumidor_revenda+"_estado").show().next().remove();
                $("#"+consumidor_revenda+"_bairro").show().next().remove();
                $("#"+consumidor_revenda+"_endereco").show().next().remove();

                if ($("#"+consumidor_revenda+"_bairro").val().length == 0) {
                    $("#"+consumidor_revenda+"_bairro").focus();
                } else if ($("#"+consumidor_revenda+"_endereco").val().length == 0) {
                    $("#"+consumidor_revenda+"_endereco").focus();
                } else if ($("#"+consumidor_revenda+"_numero").val().length == 0) {
                    $("#"+consumidor_revenda+"_numero").focus();
                }

                $.ajaxSetup({
                    timeout: 0
                });
            }
        });
    }
}

/**
 * Função que busca os defeitos constatados da família do produto
 */
function busca_defeito_constatado(produto, subproduto) {

    if (subproduto == undefined) {
        var subproduto = false;
    }

    var fora_garantia = $("#tipo_atendimento option:selected").attr("fora_garantia");
    var grupo_atendimento = $("#tipo_atendimento option:selected").attr("grupo_atendimento");
    var tipo_atendimento_descricao = $("#tipo_atendimento option:selected").text();
    var tipo_atendimento = $("#tipo_atendimento option:selected").val()
    var defeitos_selecionados = $("#defeitos_constatados_multiplos").val();
    var tipo_atendimento = "";
    var defeito_constatado_anterior = $("#produto_defeito_constatado option:selected").val();

    <? if ($login_fabrica == 158) { ?>
        tipo_atendimento = $("#tipo_atendimento").val();
        if ($("#os_garantia").val() == 1) {
            fora_garantia = "t";
        }
    <? } ?>

    $.ajax({
        url: "cadastro_os.php",
        type: "POST",
        dataType:"JSON",
        data: {
            ajax: true,
            ajax_busca_defeito_constatado: true,
            produto: produto,
            fora_garantia: fora_garantia,
            defeitos_selecionados: defeitos_selecionados,
            grupo_atendimento: grupo_atendimento,
            tipo_atendimento_descricao: tipo_atendimento_descricao,
            tipo_atendimento: tipo_atendimento
        },
        beforeSend: function() {
            if (subproduto === false) {
                $("#produto_defeito_constatado").hide().after($("<img />", { src: "imagens/loading_img.gif", css: { width: "30px", height: "30px" } }));
            } else {
                $("#subproduto_defeito_constatado").hide().after($("<img />", { src: "imagens/loading_img.gif", css: { width: "30px", height: "30px" } }));
            }
        }
    })
    .done(function(data) {
        if (subproduto === false) {
            if (data.defeitos_constatados) {
                $("#produto_defeito_constatado > option").first().nextAll().remove();

                defeito_constatado_json = [];

                $.each(data.defeitos_constatados, function(key, value) {
                    var descricao = value.descricao;

                    var option = $("<option></option>");
                    $(option).val(value.defeito_constatado);
                    $(option).text(descricao);
                    $(option).data({ "lancar-pecas": value.lancar_pecas, "lista-garantia": value.lista_garantia, "defeito-grupo": value.defeito_constatado_grupo });

                    $("#produto_defeito_constatado").append(option);

                    defeito_constatado_json.push({ defeito_constatado: value.defeito_constatado, descricao: descricao , lancar_pecas: value.lancar_pecas, lista_garantia: value.lista_garantia, defeito_constatado_grupo: value.defeito_constatado_grupo });
                });
            }

            $("#produto_defeito_constatado").show().next().remove();

            <?php
            if ($login_fabrica == 161) { ?>

                $("#produto_defeito_constatado option[value="+defeito_constatado_anterior+"]").prop("selected", true);

            <?php
            }
            ?>

        } else {
            if (data.subproduto_defeitos_constatados) {
                $("#subproduto_defeito_constatado > option").first().nextAll().remove();

                $.each(data.subproduto_defeitos_constatados, function(key, value) {
                    var option = $("<option></option>", { value: key, text: value });
                    $("#subproduto_defeito_constatado").append(option);
                });
            }

            $("#subproduto_defeito_constatado").show().next().remove();
        }
    });
}

/**
 * Função que busca as soluções da família do produto
 */
function busca_solucao(produto, tipo_produto, subconjunto, subproduto, tipo_subproduto) {
    $.ajax({
        url: "cadastro_os.php",
        type: "POST",
        data: { ajax: true, ajax_busca_solucao: true,
                produto: produto,
                tipo_produto: tipo_produto,
                subconjunto: subconjunto,
                subproduto: subproduto,
                tipo_subproduto: tipo_subproduto },
        beforeSend: function() {
            $("#solucao").hide().after($("<img />", { src: "imagens/loading_img.gif", css: { width: "30px", height: "30px" } }));
        },
        complete: function(data) {
            data = $.parseJSON(data.responseText);

            if (data.solucoes) {
                $("#solucao > option").first().nextAll().remove();

                $.each(data.solucoes, function(key, value) {
                    var option = $("<option></option>", { value: key, text: value });
                    $("#solucao").append(option);
                });
            }

            $("#solucao").show().next().remove();
        }
    });
}

/**
 * Função que busca as soluções por defeitos constatados selecionados
 */
function busca_solucao_defeito_constatado(defeitos_constatados_selecionados) {
    var solucao = $("#solucao").val();
    var fora_garantia = $("#tipo_atendimento option:selected").attr("fora_garantia");

    <?php
    if ($login_fabrica == 158) {
    ?>
        if ($("#os_garantia").val() == 1) {
            fora_garantia = "t";
        }
    <?php
    }
    ?>

    $.ajax({
        url: "cadastro_os.php",
        type: "POST",
        data: { ajax: true, ajax_busca_solucao_defeito_constatado: true,
            defeitos_constatados_selecionados: defeitos_constatados_selecionados,
            fora_garantia: fora_garantia },
        beforeSend: function() {
            $("#solucao").hide().after($("<img />", { src: "imagens/loading_img.gif", css: { width: "30px", height: "30px" } }));
        },
        complete: function(data) {
            data = $.parseJSON(data.responseText);

            if (data.solucoes) {
                $("#solucao > option").first().nextAll().remove();

                $.each(data.solucoes, function(key, value) {
                    var solucao_disponivel = false;

                    if (typeof solucao == "object") {
                        if ($.inArray(key, solucao) != -1) {
                            solucao_disponivel = true;
                        }
                    } else {
                        if (solucao == key) {
                            solucao_disponivel = true;
                        }
                    }

                    var option = $("<option></option>", { value: key, text: value });

                    if (solucao_disponivel == true) {
                        $(option).prop({ selected: true });
                    }

                    $("#solucao").append(option);
                });
            } else {
                alert(data.erro);
            }

            $("#solucao").show().next().remove();

            <?php
            if ($login_fabrica == 158) {
            ?>
                $("#solucao").select2();
            <?php
            }
            ?>
        }
    });
}

/**
* Função de busca a Linha do Produto
**/
function busca_valor_adicional(){
    var id_fabrica = <?=$login_fabrica?>;

    var data = { ajax: true, ajax_busca_valor_adicional: true };

    var produto = $("#produto_id").val();

    if (typeof produto != "undefined" && produto.length > 0) {
        data.produto = produto;
    }

    <?php
    if (isset($fabrica_usa_subproduto)) {
    ?>
        var subproduto = $("#subproduto_id").val();

        if (typeof subproduto != "undefined" && subproduto.length > 0) {
            data.subproduto = subproduto;
        }
    <?php
    }
    ?>

    if (typeof data.produto != "undefined") {
        $.ajax({
            url: "cadastro_os.php",
            type: "POST",
            data: data,
            beforeSend: function() {
                if (id_fabrica != 169 && id_fabrica != 170){
                    $("#valores_adicionais").find("div.valor_adicional_produto").remove();
                }
            }
        }).always(function(data) {
            data = JSON.parse(data);

            if (data.valores_adicionais) {
                $.each(data.valores_adicionais, function(key, valor_adicional) {

                    var div = $("<div></div>", {
                        class: "span3 label label-default valor_adicional_produto",
                        css: {
                            "min-height": "50px",
                            "margin-top": "10px"
                        }
                    });

                    var input_checkbox = $("<input />", {
                        type: "checkbox",
                        name: "os[valor_adicional][]",
                        value: valor_adicional.descricao+"|"+valor_adicional.valor
                    });

                    if (id_fabrica == 183){
                        if (valor_adicional.editar == 't'){
                            var input_text = $("<input />", {
                                type: "text",
                                class: "span12 valor_adicional_valor",
                                name: "os[valor_adicional_valor]["+valor_adicional.descricao+"]",
                                value: valor_adicional.valor
                            });
                        }else{
                            var input_text = $("<input />", {
                                type: "text",
                                class: "span12 valor_adicional_valor",
                                readonly: "readonly",
                                name: "os[valor_adicional_valor]["+valor_adicional.descricao+"]",
                                value: valor_adicional.valor
                            });
                        }
                    }else{
                        var input_text = $("<input />", {
                            type: "text",
                            class: "span12 valor_adicional_valor",
                            readonly: "readonly",
                            name: "os[valor_adicional_valor]["+valor_adicional.descricao+"]",
                            value: valor_adicional.valor
                        });
                    }
                    
                    $(div).append(input_checkbox).append(" "+valor_adicional.descricao+"<br />").append(input_text);

                    if ($("#valores_adicionais").find("div.label-default").length % 4 == 0) {
                        $(div).css({
                            "margin-left": "0px"
                        });
                    }

                    $("#valores_adicionais").append(div);

                    $(".valor_adicional_valor").priceFormat({
                        prefix: '',
                        thousandsSeparator: '',
                        centsSeparator: ',',
                        centsLimit: 2
                    });

                });

                $("#div_valores_adicionais").show();
            }
        });
    }
}

/**
 * Função que trata os dados do consumidor para pesquisar a latitude e longitude
 */

function calcula_km(km_rota) {
    if (typeof km_rota == "undefined") {
        var km_rota = false;
    }

    var abre_os_dealer = '<?=$abre_os_dealer?>';

    <? if (in_array($login_fabrica, array(169, 170)) && strlen(getValue("os[os_numero]")) > 0) { ?>
        var km_rota = true;
    <? } ?>

    try {

        if ($("#consumidor_cep").val() == "" && $("#consumidor_endereco").val() == "" && $("#consumidor_cidade").val() == "" && $("#consumidor_estado").val() == "") {
            if (abre_os_dealer == '' || abre_os_dealer != 't'){
                throw new Error("<?php echo traduz('digite.as.informacoes.do.consumidor.para.calcular.o.km');?>");
            }
        }

        if ($("#posto_latitude").val() == "" && $("#posto_longitude").val() == "") {
            throw new Error("<?php echo traduz('nao.foi.possivel.determinar.a.localizacao.do.posto');?>");
        }

        <? if (in_array($login_fabrica, array(152,180,181,182)) && strlen($os) == 0) { /*HD-4120344*/ ?>
            $("#os_tempo_deslocamento").val(0);
        <? } ?>

        var Pais = "Brasil";


        Geocoder.setEndereco({
            endereco: $("#consumidor_endereco").val(),
            numero: $("#consumidor_numero").val(),
            bairro: $("#consumidor_bairro").val(),
            cidade: $("#consumidor_cidade > option:selected").text(),
            estado: $("#consumidor_estado").val(),
            cep: $("#consumidor_cep").val(),
            pais: Pais
        });

        request = Geocoder.getLatLon();

        request.then(
            function(resposta) {

                pLat = $("#posto_latitude").val();
                pLng = $("#posto_longitude").val();
                var pLatLng = $("#posto_latitude").val()+","+$("#posto_longitude").val();

                cLat  = resposta.latitude;
                cLng  = resposta.longitude;
                var cLatLng = cLat+","+cLng;

                $.ajax({
                    url: "controllers/TcMaps.php",
                    type: "POST",
                    data: {ajax: "route", origem: pLatLng, destino: cLatLng, ida_volta: "sim"},
                    timeout: 60000
                }).done(function(data){
                    data = JSON.parse(data);

                    <? if ($login_fabrica == 171) { ?>
                        $("input[name='os[qtde_km_ida]']").val(data.km_ida);
                        $("input[name='os[qtde_km_volta]']").val(data.km_volta);
                        $('#qtde_km').attr('readonly', true);
                    <? } ?>

                    if (data.error) {

                        if (abre_os_dealer == '' || abre_os_dealer != 't'){
                            alert("<?php echo traduz('erro.ao.calcular.rota.por.favor.revise.o.endereco.informado.ou.entre.em.contato.com.a.telecontrol');?>");
                        }
                        
                    } else {
                        geometry = data.rota.routes[0].geometry;
                        var kmtotal = parseFloat(data.total_km).toFixed(2);

                        if ($("#ver-mapa").is(":checked")) {
                            mostraMapa();
                        }

                        if (km_rota == false) {
                            $('#qtde_km').val(kmtotal);
                            <?php if($login_fabrica == 35){ ?>
                                $("#qtde_km_hidden").val(kmtotal);
                            <?php } ?>

                            var qtde_km_hidden = $("#qtde_km_hidden").val();

                            <?php if (in_array($login_fabrica, array(195,198,200))) { ?> 
                                if (typeof qtde_km_hidden == "undefined" || qtde_km_hidden == null || qtde_km_hidden.length == 0 || qtde_km_hidden == 0) {
                                    $("#qtde_km_hidden").val(kmtotal);
                                }
                            <?php } else { ?>
                                if (typeof qtde_km_hidden == "undefined" || qtde_km_hidden == null || qtde_km_hidden.length == 0) {
                                    $("#qtde_km_hidden").val(kmtotal);
                                }
                            <?php } ?>
                        }
                    }

                    $('#loading-map').hide();
                }).fail(function(){
                    $('#loading-map').hide();
                    alert('<?php echo traduz('erro.ao.tentar.calcular.a.rota');?>!');
                });
            },
            function(erro) {
                $('#loading-map').hide();
                alert(erro);
            }
        );
    } catch(e) {
        $('#loading-map').hide();
        alert(e.message);
    }
}

function mostraMapa () {

    if (cLat.length == 0 || cLng.length == 0 || pLat.length == 0 || pLng.length == 0 || geometry.length ==0) {
        throw new Error("<?php echo traduz('execute.o.calculo.do.km.para.mostrar.o.mapa');?>");
    }

    Map.load();

    /* Marcar pontos no mapa */
    Markers.remove();
    Markers.clear();
    Markers.add(cLat, cLng, "blue", "Cliente");
    Markers.add(pLat, pLng, "red", "Posto");
    Markers.render();
    Markers.focus();

    Router.remove();
    Router.clear();
    Router.add(Polyline.decode(geometry));
    Router.render();

}

function calcula_km_revenda (km_rota) {

    if (typeof km_rota == "undefined") {
        var km_rota = false;
    }

    <? if ($login_fabrica == 156) { ?>
        return calcula_km(km_rota);
    <? } ?>

    try {

        if ($("#posto_id").val().length == 0) {
            throw new Error("<?php echo traduz('selecione.um.posto.autorizado');?>");
        }

        if ($("#posto_latitude").val().length == 0 && $("#posto_longitude").val().length == 0) {
            throw new Error("<?php echo traduz('posto.autorizado.sem.latitude.e.longitude');?>");
        }

        if ($("#revenda_endereco").val() == "" && $("#revenda_cidade").val() == "" && $("#revenda_estado").val() == "") {
            throw new Error("<?php echo traduz('digite.as.informacoes.da.revenda.para.calcular.o.km');?>");
        }

        <? if (in_array($login_fabrica, array(152,180,181,182))) { ?>
            $("#os_tempo_deslocamento").val(0);
        <? } ?>

        var Pais = "Brasil";

        Geocoder.setEndereco({
            endereco: $("#revenda_endereco").val(),
            numero: $("#revenda_numero").val(),
            bairro: $("#revenda_bairro").val(),
            cidade: $("#revenda_cidade > option:selected").text(),
            estado: $("#revenda_estado").val(),
            pais: Pais
        });

        request = Geocoder.getLatLon();

        request.then(
            function(resposta) {

                pLat = $("#posto_latitude").val();
                pLng = $("#posto_longitude").val();
                var pLatLng = $("#posto_latitude").val()+","+$("#posto_longitude").val();

                cLat  = resposta.latitude;
                cLng  = resposta.longitude;
                var cLatLng = cLat+","+cLng;

                $.ajax({
                    url: "controllers/TcMaps.php",
                    type: "POST",
                    data: {ajax: "route", origem: pLatLng, destino: cLatLng, ida_volta: "sim"},
                    timeout: 60000
                }).done(function(data){
                    data = JSON.parse(data);

                    geometry = data.rota.routes[0].geometry;
                    var kmtotal = parseFloat(data.total_km).toFixed(2);

                    if ($("#ver-mapa").is(":checked")) {
                        mostraMapa();
                    }

                    if (km_rota == false) {
                        $('#qtde_km').val(kmtotal);
                    }
                    $('#loading-map').hide();
                }).fail(function(){
                    $('#loading-map').hide();
                    alert('<?php echo traduz('erro.ao.tentar.calcular.a.rota');?>!');
                });
            },
            function(erro) {
                $('#loading-map').hide();
                alert(erro);
            }
        );
    } catch(e) {
        $('#loading-map').hide();
        alert(e.message);
    }

}

function busca_comunicados(produto, subproduto) {
    if (typeof produto != "undefined" && produto.length > 0) {
        if (subproduto == true) {
            var btn = "button.comunicados-subproduto";
            var div = "div.modal-comunicados-subproduto";
        } else {
            var btn = "button.comunicados-produto";
            var div = "div.modal-comunicados";
        }

        $.ajax({
            async: true,
            url: "cadastro_os.php",
            type: "get",
            data: { ajax: true, ajax_busca_comunicados: true, produto: produto },
            beforeSend: function() {
                $(btn).prop({ disabled: true }).html("<i class='icon-info-sign icon-white' ></i> <?php echo traduz('buscando.comunicados');?>...");
                $(div+" > div.modal-body > table > tbody > tr").remove();
            }
        }).fail(function(res) {

        }).done(function(res) {
            res = JSON.parse(res);

            if (res.erro) {
                alert(res.erro);
            } else if (res.nao_encontrado) {
                $(btn).prop({ disabled: true }).html("<i class='icon-info-sign icon-white' ></i> <?php echo traduz('nao.ha.comunicados.para.o.produto');?>");
            } else if (res.comunicados && res.comunicados.length > 0) {
                var url = "<?=($areaAdmin) ? 'comunicado_produto.php' : 'comunicado_mostra.php'?>";

                $.each(res.comunicados, function(i, comunicado) {
                    if (comunicado.link) {
                        var anexo_link = "\
                            <a href='"+comunicado.link+"' target='_blank' title='<?php echo traduz('visualizar.anexo.do.comunicado');?> >\
                                <button type='button' class='btn btn-info btn-mini' >\
                                    <i class='icon-file icon-white' ></i>\
                                </button>\
                            </a>\
                        ";
                    } else {
                        var anexo_link = "";
                    }

                    $(div+" > div.modal-body > table > tbody").append("\
                        <tr>\
                            <td>"+comunicado.titulo+"</td>\
                            <td>"+comunicado.tipo+"</td>\
                            <td class='tac' >"+comunicado.data+"</td>\
                            <td class='tac' >\
                                "+anexo_link+"\
                                <a href='"+url+"?comunicado="+comunicado.id+"' target='_blank' >\
                                    <button type='button' class='btn btn-info btn-mini' title='<?php echo traduz('visualizar.comunicado');?>' >\
                                        <i class='icon-search icon-white' ></i>\
                                    </button>\
                                </a>\
                            </td>\
                        </tr>\
                    ");
                });

                $(btn).prop({ disabled: false }).html("<i class='icon-info-sign icon-white' ></i> <?php echo traduz('comunicados');?>");
            }
        });
    }
}

/**
 * Função que busca o link da vista explodida do produto
 */
function busca_vista_explodida(produto, subproduto, nserie) {
    if (typeof subproduto == "undefined") {
        subproduto = false;
    }
    var versao = '';
    var fab = '<?=$login_fabrica?>';
    var id_tem_os = '<?=$os?>';

    if (typeof nserie == "undefined") {
        nserie = '';
    }

    <?php  if (isset($usa_versao_produto)) {  ?>
        versao = $("#produto_versao").val();
    <?php } ?>

    if (typeof produto != "undefined" && produto.length > 0) {
        $.ajax({
            url: "cadastro_os.php",
            type: "get",
            data: { ajax: true, ajax_busca_vista_explodida: true, produto: produto , produto_versao: versao, nserie: nserie},
            beforeSend: function() {
                if (subproduto === false) {
                    $("#vista_explodida").removeAttr("href").hide();
                } else {
                    $("#vista_explodida_subproduto").removeAttr("href").hide();
                }
            }
        }).always(function(data) {
            data = $.parseJSON(data);

            if (data.link) {
                if (subproduto === false) {
                    if (fab == 160 || fab == 188) {
                        if (ja_anexou(id_tem_os)) {
                            $("#vista_explodida").attr("href", data.link).show();
                        }
                    } else {
                        $("#vista_explodida").attr("href", data.link).show();
                    }
                } else {
                    if (fab == 160 || fab == 188) {
                        if (ja_anexou(id_tem_os)) {
                            $("#vista_explodida").attr("href", data.link).show();
                        }
                    } else {
                        $("#vista_explodida_subproduto").attr("href", data.link).show();
                    }
                }
            }
        });
    }
}

<? if (in_array($login_fabrica, array(143))) { ?>
    /**
     * Função que verifica se o posto autorizado é do tipo revenda para definir se irá mostrar informações de deslocamento
     */
    function verifica_tipo_posto_produto_linha() {
        var posto            = $("#posto_id").val();
        var produto          = $("#produto_id").val();
        var tipo_atendimento = $("#tipo_atendimento").val();

        if ((typeof posto != "undefined" && posto.length > 0) && (typeof produto != "undefined" && produto.length > 0) && (typeof tipo_atendimento != "undefined" && tipo_atendimento.length > 0)) {
            $.ajax({
                url: "cadastro_os.php",
                type: "get",
                data: { ajax: true, ajax_verifica_tipo_posto_produto_linha: true, posto: posto, produto: produto, tipo_atendimento: tipo_atendimento }
            }).always(function(data) {
                data = $.parseJSON(data);

                if (data.km == true) {
                    $("#div_informacoes_deslocamento").show();
                } else {
                    if (data.posto == true && data.produto == false) {
                        alert("<?php echo traduz('produto.selecionado.nao.pode.ter.o.tipo.de.atendimento.com.deslocamento');?>.");
                    }

                    $('#tipo_atendimento > option').each(function() {
                        if ($(this).text().toUpperCase() == "ATENDIMENTO BALCÃO") {
                            $("#tipo_atendimento").val($(this).val());
                            $("#tipo_atendimento > option:selected").focus();
                        }
                    });

                    $("#div_informacoes_deslocamento").hide();
                }

                $("#qtde_km").val(0);
                $("#qtde_km_hidden").val(0);

                <?php
                if (in_array($login_fabrica, array(152,180,181,182))) {
                ?>
                    $("#os_tempo_deslocamento").val(0);
                <?php
                }
                ?>
            });
        }
    }
<?php
}
?>

/**
* Função que verifica se o o produto é de troca obrigatoria.
*/

function verifica_produto_troca(status) {

    if (status == true) {
        $("#produto_pecas").hide();
        alert("<?php echo traduz('o.produto.selecionado.e.de.troca.obrigatoria.e.entrara.em.auditoria');?>.");
    } else {
        <?php if ($login_fabrica == 151) {?>
            var tipo_atendimento = $("#tipo_atendimento").val();
	    if (tipo_atendimento != '') {
		verificarColetaDeProduto(tipo_atendimento);
	    }
        <?php } ?>

        $("#produto_pecas").show();
        <?php if ($areaAdmin === false AND $login_unico_tecnico_posto != "t" AND $login_fabrica == 175){ ?>
            $("#produto_pecas").hide();
        <?php } ?>
    }
    $("#produto_troca_obrigatoria").val(status);
}

<?
if (in_array($login_fabrica, array(158,165,174))) {
?>
    function buscaTecnico(id_posto) {
        $.ajax({
            url: "cadastro_os.php",
            type: "POST",
            data: {ajax: true, ajax_busca_tecnico : true, posto : id_posto},
            complete: function(data) {
                data = $.parseJSON(data.responseText);
                $.each(data, function (key, value) {
                    var option = $("<option></option>", { value : key, text : value });
                    $("#id_tecnico").append(option);
                })
            },
        })
    }
<?php
}

if (in_array($login_fabrica, array(158))) {
?>
    function buscaUnidadeNegocio(id_posto) {
        $.ajax({
            url: "cadastro_os.php",
            type: "POST",
            data: {ajax: true, ajax_busca_unidade_negocio : true, posto : id_posto},
            complete: function(data) {
                data = $.parseJSON(data.responseText);
                $.each(data, function (key, value) {
                    var option = $("<option></option>", { value : key, text : value });
                    if (Object.keys(data).length == 1) {
                        $("#unidade_negocio").append(option).val(key);
                    } else {
                        $("#unidade_negocio").append(option);
                    }
                })
            },
        })
    }
    $(function () {
        var valor_anterior;
        var pecas_lancadas;

        $("#defeito_reclamado").on('focus', function () {
            valor_anterior = $(this).val();
        }).change(function() {
            var that = $(this);
            var lista_pecas = $("#pecas_produto :input[rel=peca_id]");
            $.each(lista_pecas, function () {
                if ($(this).val() != "") {
                    alert("<?php echo traduz('existe.pecas.lancadas.nao.e.possivel.alterar.o.defeito.reclamado');?>!");
                    that.val(valor_anterior);
                    pecas_lancadas = true;
                    return false;
                }
            });

            if (pecas_lancadas) {
                return false;
            }

            var fora_garantia = $("#tipo_atendimento option:selected").attr("fora_garantia");

        });
        // Bloqueia a Alteração da Solução por parte do posto se solução já gravada na OS
        <? if ($areaAdmin === false && strlen($os) > 0 && strlen(getValue("produto[solucao]")) > 0) { ?>
            $("#solucao").selectreadonly(true);
        <? } ?>

        $("#solucao").change(function() {            
            var that = $(this);
            var solucao = $(this).val();
            let solucao_lancada = '';

            <?php if ($login_fabrica == 158) { ?>
                    solucao_lancada = $("#solucao_lancada").val();
            <?php } ?>

            if (solucao != null && solucao.length > 0) {
                $.ajax({
                    url: "<?= $PHP_SELF; ?>",
                    type: "POST",
                    data: { ajax: true, ajax_verifica_troca_peca: true, solucao : solucao, solucao_lancada: solucao_lancada },
                    beforeSend: function () {
                        if (that.next("img").length == 0) {
                            that.after($("<img />", { src: "imagens/loading_img.gif", css: { width: "30px", height: "30px" } }));
                        }
                    },
                    complete: function(data) {
                        data = JSON.parse(data.responseText);

                        if (data.erro) {
                            alert(data.erro);
                        } else {
                            if (data.troca_peca != "t") {
                                // Efetua o click no botão de remoção das peças selecionadas
                                $("#pecas_produto").find("button[name=remove_peca]:visible").each(function() {
                                    $(this).click();
                                });
                                $("#produto_pecas").hide();
                                alert(data.sucesso);
                            } else {
                                $("#produto_pecas").show();
                            }

                            <?php if ($login_fabrica == 158) { ?>
                                $("#solucao_lancada").val(solucao);
                                if (data.pdv) {
                                    <?php if ($areaAdmin != true) { ?>
                                            $("#div_trocar_produto").show();
                                            $("#trocar_produto").hide();
                                    <?php } ?>
                                    $("#div_pdv").show("slow");
                                } else {
                                    <?php if ($areaAdmin != true) { ?>
                                            $("#div_trocar_produto").hide();
                                            $("#trocar_produto").hide();
                                    <?php } ?>
                                    $(".pdv_mask").val('');
                                    $("#div_pdv").hide("slow");
                                }
                            <?php } ?>
                        }

                        if (that.next("img").length > 0) {
                            that.next("img").remove();
                        }
                    }
                });
            } else {
            <?php if ($login_fabrica == 158) { ?>
                    $(".pdv_mask").val('');
                    $("#div_pdv").hide("slow");
                    <?php if ($areaAdmin != true) { ?>
                            $("#div_trocar_produto").hide();
                            $("#trocar_produto").hide();
                    <?php } ?>
            <?php } ?>
            }
        });

    });
<?php
}

if (in_array($login_fabrica, array(158,157,175))){
?>
function retorna_consumidor_os(retorno) {
    $("#consumidor_nome").val(retorno.nome);
    $("#consumidor_cep").val(retorno.cep);
    $("#consumidor_estado").val(retorno.estado);
    busca_cidade(retorno.estado, "consumidor", retorno.cidade);
    $("#consumidor_bairro").val(retorno.bairro);
    $("#consumidor_endereco").val(retorno.endereco);
    $("#consumidor_numero").val(retorno.numero);
    $("#consumidor_complemento").val(retorno.complemento);
    $("#consumidor_telefone").val(retorno.fone);
    $("#consumidor_celular").val(retorno.celular);
    $("#consumidor_email").val(retorno.email);
    
    <?php if (in_array($login_fabrica, [157,175])) { ?>
        $("#consumidor_cpf").val(retorno.cpf);

        if (retorno.cpf.length == 11){
            $("#cpf_cnpj").trigger("change");
            $("#cpf_cnpj").prop("checked", true);
        }else if (retorno.cpf.length == 14){
            $("#cnpj_cpf").trigger("change");
            $("#cnpj_cpf").prop("checked", true);
        }

        if (retorno.cep.length == 8){
            $("#consumidor_cep").blur();
        }
    <?php } ?>
}
<?php    
}

if(in_array($login_fabrica, array(165)) && $areaAdmin != true && $postoInterno != true) {
?>
    $(function () {
        $(".lupa_serie").on("click", function() {

            if ($("#produto_serie").val() != "") {
                $("#produto_serie").val("")
            }
        });
    });
<?php

}
if($login_fabrica == 156 OR in_array($login_fabrica, [167, 203])){//HD-3041214
?>
    $(function() {
        calc_totalxx();
    });
<?php
}

if(in_array($login_fabrica,[169,170]) AND !empty($os)){
?>
	$(function(){
		ocultaDadosConsumidor($("#os_consumidor_revenda").val());
	});
<?php
}

if ($login_fabrica == 164 && strlen($msg_erro["msg"]) > 0) {
?>
    if ($("#xtipo_posto").val() == "Autorizada MODELO") {
        $("#produto_pecas").hide();
    }
<?php
}
?>

function verifica_valores_adicionais() {
    var tipo_atendimento = $("#tipo_atendimento").val();
    var os = $("#os_id").val();
    var produto = $("#produto_id").val();
    $.ajax({
        url: "<?= $PHP_SELF; ?>",
        type: "POST",
        dataType:"JSON",
        data: { ajax: true, ajax_verifica_valores_adicionais: true, tipo_atendimento : tipo_atendimento, os : os, produto : produto }
    }).done(function(data) {
        if (data.retorno != false) {
            $("#div_valores_adicionais").show();
            $("#div_valores_adicionais").find("#valores_adicionais").html("");

            $.each(data.retorno, function(key,value) {
console.log(key)
console.log(value)
                if (os == ''){

                    if (value.editar != "t") {
                        var block = "readonly='readonly'";
                    } else {
                        var block = "";
                    }

                    <?php if ($login_fabrica == 195){?>
                        $("#div_valores_adicionais").find("#valores_adicionais").append("\
                            <div class='span3 label label-default valor_adicional_produto' style='min-height: 50px; margin-top: 10px;' >\
                                <input type='checkbox' name='os[valor_adicional][]' value='"+key+"|"+value.valor+"'> "+key+"<br />\
                                <input type='text' class='span12 valor_adicional_valor' "+block+" name='os[valor_adicional_valor]["+key+"]' value='"+value.valor+"'>\
                            </div>\
                        ");
                    <?php } else {?>
                    $("#div_valores_adicionais").find("#valores_adicionais").append("\
                        <div class='span3 label label-default valor_adicional_produto' style='min-height: 50px; margin-top: 10px;' >\
                            <input type='checkbox' name='os[valor_adicional][]' value='"+key+"|"+value+"'> "+key+"<br />\
                            <input type='text' class='span12 valor_adicional_valor' "+block+" name='os[valor_adicional_valor]["+key+"]' value='"+value+"'>\
                        </div>\
                    ");
                    <?php }?>

                } else {

                    if (value.editar != "t") {
                        var block = "readonly=readonly";
                    } else {
                        var block = "";
                    }
                    <?php if ($login_fabrica == 195){?>
                        $("#div_valores_adicionais").find("#valores_adicionais").append("\
                        <div class='span3 label label-default valor_adicional_produto' style='min-height: 50px; margin-top: 10px;' >\
                            <input type='checkbox' name='os[valor_adicional][]' value='"+key+"|"+value.valor+"'> "+key+"<br />\
                            <input type='text' class='span12 valor_adicional_valor' "+block+" name='os[valor_adicional_valor]["+key+"]' value='"+value.valor+"'>\
                        </div>\
                    ");
                    <?php } else {?>
                    $("#div_valores_adicionais").find("#valores_adicionais").append("\
                        <div class='span3 label label-default valor_adicional_produto' style='min-height: 50px; margin-top: 10px;' >\
                            <input type='checkbox' name='os[valor_adicional][]' value='"+key+"|"+value+"'> "+key+"<br />\
                            <input type='text' class='span12 valor_adicional_valor' "+block+" name='os[valor_adicional_valor]["+key+"]' value='"+value+"'>\
                        </div>\
                    ");
                    <?php } ?>
                }

                $(".valor_adicional_valor").priceFormat({
                    prefix: '',
                    thousandsSeparator: '',
                    centsSeparator: '.',
                    centsLimit: 2
                });

            });
        } else {
            $("#div_valores_adicionais").hide();
            $("#div_valores_adicionais").find("#valores_adicionais").html("");
        }

    });
}


<?php
    if($login_fabrica == 173){
?>
        function verificaDcPosicaoPeca(){
             var defeito_grupo = $("#produto_defeito_constatado > option:selected").data("defeito-grupo");
            if(defeito_grupo != "" && defeito_grupo != undefined){
                $("#div_observacoes_pecas").show();
            }else{
                $("#div_observacoes_pecas").hide();
            }

        }

<?php
    }

    /*HD - 4300021*/
    if ($login_fabrica == 151) { ?>
        function verificarColetaDeProduto(tipo_atendimento) {
            $.ajax({
                url: "<?=$PHP_SELF;?>",
                type: "POST",
                data: { verificarColetaDeProduto: true, tipo_atendimento : tipo_atendimento}
            }).done(function(data) {
                if (data == "S") {
                    $("#produto_pecas").css("display", "none");
                } else {
                    $("#produto_pecas").css("display", "block");
                }
            });
        }
        $(function() {
            var aux_tipo_atendimento = $("#tipo_atendimento").val();

	    if (aux_tipo_atendimento != '') {
		verificarColetaDeProduto(aux_tipo_atendimento);
	    }

            $("#tipo_atendimento").change( function() {
		if ($(this).val() != '') {
            	    verificarColetaDeProduto($(this).val());
		}
            });
        });
    <?php }
    
    if ($login_fabrica == 174) { ?>
        var mask = {
            money: function() {
                var el = this
                ,exec = function(v) {
                v = v.replace(/\D/g,"");
                v = new String(Number(v));
                var len = v.length;
                if (1== len)
                v = v.replace(/(\d)/,"0.0$1");
                else if (2 == len)
                v = v.replace(/(\d)/,"0.$1");
                else if (len > 2) {
                v = v.replace(/(\d{2})$/,'.$1');
                }
                return v;
                };

                setTimeout(function(){
                el.value = "R$ " + exec(el.value);
                },1);
            }
        }
        
        $(document).ready(function(){
            $('#valor_nf').bind('keypress',mask.money);
        });
    <?php } 
	
	if($login_fabrica == 178){ ?>
        function comboMarcaProduto (marcas){
            if (marcas != '' && marcas != undefined){
                $.ajax({
                    url: window.location.href,
                    type: "post",
                    data: {
                        ajax: "sim",
                        acao: "marcas_produto",
                        marcas: marcas
                    }
                }).fail(function(){
                }).done(function(data){
                    data = JSON.parse(data);
                    
                    if (data.ok == "success"){
                        if ($(data.result).length > 1){
                            var option = "<option value=''>Escolha a Marca</option>";
                        }
                        $.each(data.result, function (key, value) {
                            option += "<option value='"+value.marca+"'>"+value.nome+"</option>";
                        });
                    }else{
                        var option = "<option value=''>Escolha a Marca</option>";
                    }

                    $('#marca_produto').html(option);
                    
                });
            }
        }

		function carregaMarcasProdutoTroca(){
            var produto = $("#produto_id").val();
			var marcaProduto = $("#marca_troca_selecionada").val();
            var idOS = $("#os_id").val();
            var fora_linha = $("#produto_fora_linha").val();

            $("#marca_produto_troca").find("option").remove();
            if (produto != "" && produto != undefined){
                $.ajax({
    				url: "<?= $PHP_SELF; ?>",
    				type: "GET",
    				data: {"ajax":true,"ajax_marcas_produto":true,"produto":produto},
    				complete: function(data) {
                        data = $.parseJSON(data.responseText);
                        
                        $("#marca_produto_troca").append("<option value=''></option>");
                        
                        var arr = Object.values(data);
                        if (data != "" || data != undefined){
                            $.each(data, function (key, value) {
                                if (arr.length > 1){
                                    var option = $("<option></option>", { value : key, text : value });
                                }else{
                                    var option = $("<option></option>", { value : key, text : value, selected: 'selected' });
                                }
                                $("#marca_produto_troca").append(option);

                                if (idOS != "" && idOS != undefined && marcaProduto != "" && marcaProduto != undefined && marcaProduto != key){
                                    $("#marca_produto_troca option[value='']").remove();
                                    $("#marca_produto_troca option[value='"+key+"']").remove();
                                }
                            });

                            if(marcaProduto != ""){
                                $("#marca_produto_troca option[value='"+marcaProduto+"']").attr('selected','selected');
                            }
                        }
                        
                        if (arr.length > 0 && fora_linha == "true" && $("#solicita_troca").is(":checked") == true){
                            carregaProdutoTroca();
                        }
                    }
    			});
            }
		}

        function carregaProdutoTroca(){
            let produto_os                = $("#produto_id").val();
            let marca_produto             = $("#marca_produto_troca").val();
            let fora_linha                = $("#produto_fora_linha").val();
            let produto_troca_selecionado = $("#produto_troca_selecionado").val();

            $("#produto_troca").find("option").remove();
            if (marca_produto != "" && marca_produto != undefined && fora_linha == "true"){
                $.ajax({
                    url: "<?= $PHP_SELF; ?>",
                    type: "POST",
                    data: {"ajax":true,"ajax_produto_troca":true,"marca_produto":marca_produto, "produto_os":produto_os },
                    complete: function(data) {
                        data = $.parseJSON(data.responseText);

			if (data.erro != undefined && data.erro.length > 0) {
			    alert(data.erro);
			} else {
                            $("#produto_troca").append("<option value=''></option>");
                        
                            $.each(data, function (key, value) {
                                let option = $("<option></option>", { value : value.produto, text : value.referencia+" - "+value.descricao });
                                $("#produto_troca").append(option);
                            });

                            if(produto_troca_selecionado != ""){
                                $("#produto_troca").val(produto_troca_selecionado).trigger('change');
                            }
			}
                    }
                });
            }
        }

		function verificaComboEnviarPara(){
			var tipo_os = $("#os_consumidor_revenda").val();
			var enviar_para = $("#troca_envia_para").val();
            var idOS = $("#os_id");

			$('#enviar_para').find('option').filter(function(){ if ($(this).val() == 'C') { return true; } return false; }).remove();

			if(tipo_os == "C" || tipo_os == "S"){
				$("#enviar_para").prepend("<option value='C'>Cliente</option>");	
			}

			if(enviar_para != ""){
				$("#enviar_para option[value='"+enviar_para+"']").attr('selected','selected');
			}
 
            if (idOS != "" && idOS != undefined && enviar_para != "" && enviar_para != undefined){
                $("#enviar_para > option").each(function(idx, value){
                    if (enviar_para != $(value).val()){
                        $("#enviar_para option[value='"+$(value).val()+"']").remove();
                    }
                });
            }
        }

        function servicoRealizadoEstoque (peca, posicao){
            let posto = $("#posto_id").val();

            if (peca != '' && peca != undefined && posto != '' && posto != undefined){
                $.ajax({
                    url: "<?= $PHP_SELF; ?>",
                    type: "post",
                    data: {
                        ajax: "sim",
                        acao: "servico_realizado_estoque",
                        peca: peca,
                        posto: posto
                    }
                }).done(function(data){
                    data = JSON.parse(data);
                    
                    if (data.ok == "success"){
                        // $("#servicos_peca_"+posicao).find("option[peca_estoque='f']").prop("disabled", true);
                        // $("#servicos_peca_"+posicao).find("option[peca_estoque='t']").prop("disabled", false);
                        $("#servicos_peca_"+posicao).find("option[peca_estoque='f']").hide();
                        $("#servicos_peca_"+posicao).find("option[peca_estoque='t']").show();
                    }else{
                        $("#servicos_peca_"+posicao).find("option[peca_estoque='t']").hide();
                        $("#servicos_peca_"+posicao).find("option[peca_estoque='f']").show();
                        // $("#servicos_peca_"+posicao).find("option[peca_estoque='t']").prop("disabled", true);
                        // $("#servicos_peca_"+posicao).find("option[peca_estoque='f']").prop("disabled", false);
                    }
                });
            }
        }    
    <? } ?>

     var map = {"â":"a","Â":"A","à":"a","À":"A","á":"a","Á":"A","ã":"a","Ã":"A","ê":"e","Ê":"E","è":"e","È":"E","é":"e","É":"E","î":"i","Î":"I","ì":"i","Ì":"I","í":"i","Í":"I","õ":"o","Õ":"O","ô":"o","Ô":"O","ò":"o","Ò":"O","ó":"o","Ó":"O","ü":"u","Ü":"U","û":"u","Û":"U","ú":"u","Ú":"U","ù":"u","Ù":"U","ç":"c","Ç":"C","ñ":"n"};

    function removerAcentos(string) { 
        return string.replace(/[\W\[\] ]/g,function(a) {
            return map[a]||a}) 
    };

    <?php if($login_fabrica == 191){ ?>
            function habilitaMapa(){
                
                if($("#solicita_km").is(":checked")){
                   
                    $("#div_informacoes_deslocamento").show();

                    if($("#consumidor_cep").val() != "" && $("#qtde_km").val() == 0){
                        $("#calcular_km").click();
                    }
                }else{
                    $("#div_informacoes_deslocamento").hide();
                    $("#qtde_km").val("");
                    $("#qtde_km_hidden").val("");
                }
            }
            $(window).load(function(){
                habilitaMapa();
            });
    <? } ?>
</script>

<? if (count($msg_erro["msg"]) > 0) { ?>
    <br />
    <div class="alert alert-error"><h4><?=implode("<br />", array_unique($msg_erro["msg"]))?></h4></div>
    <? if ($erro_carrega_os) {        
        include "rodape.php";
        exit;
    }
} else {
    echo "<br />";
}

if ($login_fabrica == 153 AND $areaAdmin != true) { ?>
    <br />
    <div class="alert alert-warning">
<?php echo traduz('para.abertura.de.todas.as.os.s.de.revendas.sera.necessario');?><br>
<?php echo traduz('i.anexo.da.imagem.da.etiqueta.com.o.numero.de.serie');?><br>
<?php echo traduz('ii.anexo.da.nota.fiscal.de.compra.com.o.distribuidor.em.caso.de.aparelho.de.estoque.da.revenda');?><br>
<?php echo traduz('e.anexo.da.nota.fiscal.de.remessa.para.conserto');?><br><br>
<?php echo traduz('nos.casos.de.abertura.de.os.s.de.aparelhos.para.conserto.do.cliente.final');?><br>
<?php echo traduz('i.anexo.da.imagem.da.etiqueta.com.o.numero.de.serie');?><br>
<?php echo traduz('ii.anexo.da.imagem.da.nota.fiscal.em.nome.do.cliente.final');?><br><br>
<?php echo traduz('nao.sera.mais.permitido.apenas.o.anexo.da.nota.fiscal.de.remessa.para.conserto');?><br>
<?php echo traduz('caso.nao.seja.anexado.estes.arquivos.a.garantia.sera.negada.e.o.pagamento.de.mao.de.obra.nao.sera.pago.ao.posto.autorizado');?><br><br>
<?php echo traduz('em.caso.de.duvidas.favor.nos.retornar.0800.718.7825');?><br><br>
<?php echo traduz('agradecemos.a.compreensao');?>

    </div>
<? } ?>
<form name="frm_os" id="frm_os" method="POST" class="form-search form-inline" enctype="multipart/form-data" >
    <?php if (in_array($login_fabrica, array(35,167,203))) {?>
        <div class="modal hide fade modal-motivo-peca-duplicada" data-backdrop="static">
            <div class="modal-header">
                <h3> <?php echo traduz('Motivo da Solicitação');?></h3>
            </div>
            <div class="modal-body">
                <div id="msg_motivo"></div>
                <input type="hidden" id="posicao_solicitacao" name="posicao_solicitacao">
                <input type="hidden" id="peca_duplicada" name="peca_duplicada">
                <input type="hidden" id="peca_duplicada_item" name="peca_duplicada_item">

                <div class="row-fluid">
                    <div class="span12">
                        <textarea name="motivo_solicitacao" placeholder="Digite o motivo da solicitação" class="span12" id="motivo_solicitacao" cols="60" rows="10"></textarea><br> 
                        <input type="checkbox" id="peca_extraviada" name="peca_extraviada" value="true"> Peça extraviada
                        
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-cancela-motivo" data-dismiss="modal" aria-hidden="true">Cancelar</a>
                <a href="#" class="btn btn-primary btn-grava-motivo-solicitacao-peca">Gravar</a>
            </div>
        </div>
        <input type="hidden" name="os[formulario_reincidencia_opcao]" id="formulario_reincidencia_opcao" value="<?= getValue("os[formulario_reincidencia_opcao]") ?>" />
        <input type="hidden" name="os[formulario_reincidencia_justificativa]" id="formulario_reincidencia_justificativa" value="<?= getValue("os[formulario_reincidencia_justificativa]") ?>" />
    <?php } ?>
    <input type="hidden" name="posto[pais]" id="pais_posto" value="<?= getValue("posto[pais]") ?>" />
    <input type="hidden" name="fabrica_id" id="fabrica_id" value="<?=$login_fabrica?>">
    <?php
    if(in_array($login_fabrica, array(164,169,170,178,190))){
    ?>
    <input type="hidden" id="os_id" name="os[os_id]" value="<?php echo $_GET['os_id']; ?>" />
    <?php
    }

    if(in_array($login_fabrica, array(191))){ ?>
        <input type="hidden" name="os[cliente_admin]" id="cliente_admin" value="<?=getValue('os[cliente_admin]')?>" />
    <? }

    if(in_array($login_fabrica, array(171))){
    ?>
    <input type="hidden" name="os[contrato]" id="contrato" value="<?= getValue("os[contrato]") ?>" />
    <?php
    }

    if(in_array($login_fabrica, array(178))){
        $marca_troca_selecionada = getValue("produto[marca_produto_troca]");
        if (empty($marca_troca_selecionada) AND !empty($os)){
            $marca_troca_selecionada = getValue("os[marca]");
        }
        $troca_envia_para = getValue("produto[enviar_para]");
        if (empty($troca_envia_para) AND !empty($os)){
            $troca_envia_para = getValue("os[enviar_para]");
        }

        $produto_troca_selecionado = getValue("produto[produto_troca]");
        if (empty($produto_troca_selecionado) AND !empty($os)){
            $produto_troca_selecionado = getValue("os[produto_troca]");
        }

    ?>
        <input type="hidden" name="os[marca]" id="marca_troca_selecionada" value="<?=$marca_troca_selecionada?>" />
        <input type="hidden" name="os[enviar_para]" id="troca_envia_para" value="<?=$troca_envia_para?>" />
        <input type="hidden" name="produto[produto_troca_selecionado]" id="produto_troca_selecionado" value="<?=$produto_troca_selecionado?>" />
    <?php
    }

    if(in_array($login_fabrica, array(169,170))){
    ?>
    <input type="hidden" name="os[sua_os]" id="sua_os" value="<?= getValue("os[sua_os]") ?>" />
    <?php
    }

    $oculta_peca = "";
    if ($areaAdmin === true) {

        if ((count($msg_erro["msg"]) > 0 && strlen(getValue("posto[id]")) > 0) && (!strlen($os) && !$os_conjunto)) {
            $posto_readonly     = "readonly='readonly'";
            $posto_esconde_lupa = "style='display: none;'";
            $posto_mostra_troca = "style='display: block;'";
        }

        if ((strlen($os) > 0 && strlen(getValue("posto[id]")) > 0) || $os_conjunto) {
            $posto_readonly     = "readonly='readonly'";
            $posto_esconde_lupa = "style='display: none;'";
        }

        if (in_array($login_fabrica, array(164))) {
            if (count($msg_erro["msg"]) > 0) {
                $xtipo_posto = $campos["posto"]["xtipo_posto"];
                // $oculta_peca = "display:none !important;";
            }

            echo '<input type="hidden" id="xtipo_posto" value="'.$xtipo_posto.'" name="posto[xtipo_posto]" />';
        }

        if (in_array($login_fabrica, [152,180,181,182]) AND empty($_REQUEST['os_id'])) {
            $pais_posto_valida = getValue('posto[pais]');            
        } else {
            $pais_posto_valida = getPaisDoPosto(getValue('posto[id]'));            
        }

    ?>
        <div id="div_informacoes_posto" class="tc_formulario">
            <div class="titulo_tabela"><?=traduz('Informações do Posto Autorizado');?></div>

            <br />

            <input type="hidden" id="posto_id" name="posto[id]" value="<?=getValue('posto[id]')?>" />
            <input type="hidden" id="posto_pais" name="posto[pais]" value="<?=$pais_posto_valida ?>" />

            <div class="row-fluid">
                <div class="span2"></div>

                <div class="span3">
                    <div class='control-group <?=(in_array('posto[id]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="posto_codigo"><?php echo traduz('codigo');?></label>
                        <div class="controls controls-row">
                            <div class="span10 input-append">
                                <h5 class="asteristico">*</h5>
                                <input id="posto_codigo" name="posto[codigo]" class="span12" type="text" value="<?=getValue('posto[codigo]')?>" <?=$posto_readonly?> />
                                <span class="add-on" rel="lupa" <?=$posto_esconde_lupa?> >
                                    <i class="icon-search"></i>
                                </span>
                                <input type="hidden" name="lupa_config" tipo="posto" parametro="codigo" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span5">
                    <div class='control-group <?=(in_array('posto[id]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="posto_nome"><?php echo traduz('nome');?></label>
                        <div class="controls controls-row">
                            <div class="span11 input-append">
                                <h5 class="asteristico">*</h5>
                                <input id="posto_nome" name="posto[nome]" class="span12" type="text" value="<?=getValue('posto[nome]')?>" <?=$posto_readonly?> />
                                <span class="add-on" rel="lupa" <?=$posto_esconde_lupa?> >
                                    <i class="icon-search"></i>
                                </span>
                                <input type="hidden" name="lupa_config" tipo="posto" parametro="nome" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span2"></div>
            </div>

            <div id="div_trocar_posto" class="row-fluid" <?=$posto_mostra_troca?> >
                <div class="span2"></div>
                <div class="span10">
                    <button type="button" id="trocar_posto" class="btn btn-danger" ><?php echo traduz('Alterar Posto Autorizado');?></button>
                </div>
            </div>
        </div>
        <br />
    <? } else {
        echo "<input type='hidden' id='posto_id' name='posto[id]' value='{$login_posto}' />";

        if (in_array($login_fabrica, array(164))) {
            $sql = "SELECT tbl_tipo_posto.descricao
                     FROM tbl_posto_fabrica
               INNER JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto
                    WHERE tbl_posto_fabrica.fabrica = {$login_fabrica}
                      AND tbl_tipo_posto.descricao = 'Autorizada MODELO'
                      AND tbl_posto_fabrica.posto = {$login_posto}";
            $res = pg_query($con, $sql);

            if (pg_num_rows($res) > 0) {
                $xtipo_posto =  pg_fetch_result($res, 0, "descricao");
                $oculta_peca = "display:none !important;";
                echo $oculta_peca;

            }

            if (count($msg_erro["msg"]) > 0) {
                $xtipo_posto = $campos["posto"]["xtipo_posto"];
                // $oculta_peca = "display:none !important;";
            }

            echo '<input type="hidden" id="xtipo_posto" value="'.$xtipo_posto.'" name="posto[xtipo_posto]" />';
        }

    }

    if (strlen(getValue("os[hd_chamado]")) > 0) {
        echo "<input type='hidden' name='os[hd_chamado]' value='".getValue("os[hd_chamado]")."' />";
    }

    if (in_array($login_fabrica, array(158, 169, 170))) { ?>
        <input type="hidden" name="os[os_numero]" value="<?=getValue('os[os_numero]')?>" />
    <? }

    if (in_array($login_fabrica, array(169, 170))) { ?>
        <input type="hidden" name="produto[familia_deslocamento]" value="<?=getValue('produto[familia_deslocamento]')?>" />
    <? }

    if ($areaAdmin === true) {
        if (strlen(getValue("posto[id]")) > 0) {
            $sql = "SELECT latitude, longitude FROM tbl_posto_fabrica WHERE fabrica = {$login_fabrica} AND posto = ".getValue("posto[id]");
            $res = pg_query($con, $sql);
        }
    } else {
        if($login_fabrica == 165){
            $campoTipoPosto = " , tbl_tipo_posto.posto_interno";
            $inner = " INNER JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto ";
        }

        $sql = "SELECT latitude, longitude $campoTipoPosto FROM tbl_posto_fabrica $inner WHERE tbl_posto_fabrica.fabrica = {$login_fabrica} AND tbl_posto_fabrica.posto = {$login_posto}";
        $res = pg_query($con, $sql);

    }


    if (pg_num_rows($res) > 0) {
        $posto_latitude  = pg_fetch_result($res, 0, "latitude");
        $posto_longitude = pg_fetch_result($res, 0, "longitude");
        if($login_fabrica == 165){
           $posto_interno = pg_fetch_result($res, 0, "posto_interno");
        }
    }

    echo "<input type='hidden' id='posto_latitude' value='{$posto_latitude}' disabled='disabled' />";
    echo "<input type='hidden' id='posto_longitude' value='{$posto_longitude}' disabled='disabled' />";

    if (in_array($login_fabrica, array(158)) && strlen($hd_chamado) > 0) {
        $sqlInteg = "SELECT *
                    FROM tbl_hd_chamado_cockpit
                    LEFT JOIN tbl_routine_schedule_log USING(routine_schedule_log)
                    WHERE fabrica = {$login_fabrica}
                    AND hd_chamado = {$hd_chamado};";
        $resInteg = pg_query($con, $sqlInteg);
        $dadosIntegracao = pg_fetch_all($resInteg);
        if (pg_num_rows($resInteg) > 0) {
            $dadosJSON = json_decode($dadosIntegracao[0]['dados'], true);

            if (getValue("os[garantia]") == "f") {
                $os_fora_garantia = true;
            } else {
                $os_fora_garantia = false;
            }
            ?>
            <div id="div_informacoes_os" class="tc_formulario">
                <input type="hidden" id="os_garantia" name="os[garantia]" value="<?=$os_fora_garantia?>" />
                <div class="titulo_tabela"><?php echo traduz('informacoes.da.integracao');?></div>
                <br />
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span4">
                        <strong><?php echo traduz('arquivo');?>: </strong><?= $dadosIntegracao[0]['file_name']; ?>
                    </div>
                    <div class="span3">
                        <strong><?php echo traduz('os.cliente');?>: </strong><?= $dadosJSON['osKof']; ?>
                    </div>
                    <div class="span3">
                        <strong><?php echo traduz('centro.distribuidor');?>: </strong><?= $dadosJSON['centroDistribuidor']; ?>
                    </div>
                    <div class="span1"></div>
                </div>
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span4">
                        <strong><?php echo traduz('data.processamento');?>: </strong><?= date("d/m/Y H:i:s", strtotime($dadosIntegracao[0]['create_at'])); ?>
                    </div>
                    <div class="span4">
                        <strong><?php echo traduz('data.abertura.cliente');?>: </strong><?= $dadosJSON['dataAbertura']." ".$dadosJSON['horaAbertura']; ?>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
            <br />
        <? }
    } ?>
    <?php if (in_array($login_fabrica, array(176))) {
        if ($campos["os"]["msg_instalacao"] == "true"){
            $display_mensagem_posto_lofra = "style='display: block'";
        }else{
            $display_mensagem_posto_lofra = "style='display: none'";
        }
    ?>
        <input type='hidden' name="os[msg_instalacao]" id='msg_instalacao' value="<?=getValue('os[msg_instalacao]')?>">
        <div class="alert alert-warning" id="mensagem_posto_lofra" <?=$display_mensagem_posto_lofra?> > <h4><?php echo traduz('mensagem.para.regras.de.instalacao');?></h4> </div>
    <?php }?>

    <div class="row"> <b class="obrigatorio pull-right">  *  <?php echo traduz('campos.obrigatorios');?></b> </div>

    <? if (in_array($login_fabrica, array(148,161))) {
        if (!empty($os)) {
            $produto_revisao_readonly = "readonly='readonly'";
            $outro_disabled = " disabled='true' ";
        } ?>

        <div id="div_informacoes_produto_venda" class="tc_formulario">
            <div class="titulo_tabela"><?php echo traduz('produto');?></div>

            <br />

            <?php if ($login_fabrica == 161){ ?>
            <div class="row-fluid">
                <div class="span1"></div>

                <div class="span3">
                    <div class='control-group <?=(in_array('produto[id]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="produto_referencia"><?php echo traduz('referencia');?></label>
                        <div class="controls controls-row">
                            <div class="span10 input-append">
                                <?php
                                    if ($regras["produto|id"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    }
                                ?>
                                <input id="produto_referencia" name="produto[referencia]" class="span12" type="text" value="<?=getValue('produto[referencia]')?>" />
                                <span class="add-on" rel="lupa_produto" >
                                    <i class="icon-search"></i>
                                </span>
                                <input type="hidden" name="lupa_config" tipo="produto" parametro="referencia" posto="<?=$login_posto?>" ativo="t" <? if (isset($fabrica_usa_subproduto)) echo "subproduto='true'"; ?> <?=(in_array($login_fabrica, array(142))) ? "entrega-tecnica='t'" : ""?> <?=(in_array($login_fabrica, array(153))) ? "tela_cadastro_os='t'" : ""?> <?=(in_array($login_fabrica, array(169,170))) ? "mascara='true' grupo-atendimento='' fora-garantia='' km-google=''" : ""?> <?=($usaProdutoGenerico) ? "produto-generico='true'" : ""?> />
                                <input type="hidden" id="valida_suprimento" name="produto[valida_suprimento]" value="<?=$valida_suprimento?>">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span5" >
                    <div class='control-group <?=(in_array('produto[id]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="produto_descricao"><?php echo traduz('descricao');?></label>
                        <div class="controls controls-row">
                            <div class="span10 input-append">
                                <?php
                                    if ($regras["produto|id"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    }
                                ?>
                                <input id="produto_descricao" name="produto[descricao]" class="span12" type="text" value="<?=getValue('produto[descricao]')?>" />
                                <span class="add-on" rel="lupa_produto" >
                                    <i class="icon-search"></i>
                                </span>
                                <input type="hidden" name="lupa_config" tipo="produto" parametro="descricao" posto="<?=$login_posto?>" ativo="t" <? if (isset($fabrica_usa_subproduto)) echo "subproduto='true'"; ?> <?=(in_array($login_fabrica, array(142))) ? "entrega-tecnica='t'" : ""?> <?=(in_array($login_fabrica, array(153))) ? "tela_cadastro_os='t'" : ""?> <?=(in_array($login_fabrica, array(169,170))) ? "mascara='true' grupo-atendimento='' fora-garantia='' km-google=''" : ""?> <?=($usaProdutoGenerico) ? "produto-generico='true'" : ""?> />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <?php } ?>

            <div class="row-fluid">
                <div class="span1"></div>

                <div class="span3">
                    <div class='control-group'>
                        <label class="control-label" for="venda_numero_serie"><?php echo traduz('numero.de.serie.do.produto');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?php if ($login_fabrica <> 161): ?>
                                <h5 class='asteristico'>*</h5>
                                <?php endif ?>
                                <input id="venda_numero_serie" name="produto[serie]" class="span12" type="text" <?=$produto_revisao_readonly?> value="<?=getValue('produto[serie]')?>" />
                            </div>
						</div>
						<?php if($login_fabrica == 148 and in_array($login_posto, [6359,390306])) {
                            if(getValue("os[tipo_atendimento]") == 76977){
                                $checked = " checked ";
                            }else{
                                $checked = " ";
                            }
                        ?>
						<div class="controls controls-row">
						   <div class="span12">
								<input type="checkbox" <?= $outro_disabled ?> name="outros" <?php echo $checked ?> > <?php echo traduz('outros');?>
							</div>
						 </div>
						<?php } ?>
                    </div>
                </div>

                <? if (empty($os)) { ?>
                    <div class="span3">
                        <div class="control-group">
                            <br />
                            <button type="button" class="btn span12 verifica_serie_venda" style="display: <?=(strlen(getValue('venda_numero_serie')) > 0) ? 'none' : 'inline'?>"><?php echo traduz('pesquisar.produto');?></button>
                            <button type="button" class="btn btn-danger span12 alterar_produto_venda" style="display: <?=(strlen(getValue('venda_numero_serie')) > 0) ? 'inline' : 'none'?>"><?php echo traduz('alterar.produto');?></button>
                        </div>
                    </div>
                <? }
                if ($login_fabrica == 148) { ?>
                    <div class="span3">
                        <div class='control-group'>
                            <label class="control-label" for="venda_numero_serie"><?php echo traduz('produtos');?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <input type="text" name="peca_reposicao_disabled" disabled>
                                    <select name="peca_reposicao" style="display: none;">
                                        <option value=""></option>
                                        <?php
                                        $sql_PR = " SELECT produto, descricao
                                                    FROM tbl_produto
                                                    WHERE JSON_FIELD('pecas_reposicao', parametros_adicionais) = 't'";
                                        $res_PR = pg_query($con, $sql_PR);
                                        $num_rows = pg_num_rows($res_PR);
                                        if ($num_rows > 0) {
                                            for ($i=0; $i < $num_rows; $i++) {
                                                $produto = pg_fetch_result($res_PR, $i, produto);
                                                $descricao = pg_fetch_result($res_PR, $i, descricao);
                                                $selected = ($produto == $_POST['peca_reposicao']) ? 'selected' : '';

                                                echo "<option value='$produto' $selected>$descricao</option>";
                                            }
                                        }
                                        ?>
                                    </select>
                                </div>
                            </div>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <input type="checkbox" name="lib_peca_reposicao"> <?php echo traduz('peca.de.reposicao');?>
                                </div>
                            </div>
                        </div>
                    </div>
                <? } ?>

                <?php if ($login_fabrica == 161): ?>
                <?php
                $sem_serie_display = '';
                $sem_serie_checked = '';
                $sem_serie_ro = '';

                /*if (empty($_POST)) {
                    $sem_serie_display = 'style="display: none"';
                }*/

                if (!empty($_POST["produto"]["sem_serie"])) {
                    $sem_serie_checked = 'checked="checked"';
                }

                if (!empty($_REQUEST["os_id"])) {
                    $sem_serie_display = '';

                    $req_os_id = (int) $_REQUEST["os_id"];
                    $qry_serie_os = pg_query($con, "SELECT serie FROM tbl_os WHERE os = $req_os_id");
                    $serie_os = pg_fetch_result($qry_serie_os, 0, 'serie');

                    if (empty($serie_os)) {
                        $sem_serie_checked = 'checked="checked"';
                    }

                    $sem_serie_ro = 'readonly="readonly"';
                }

                if (!empty(getValue("produto[id]"))) {

                    $sqlLinhaInternacional = "SELECT produto
                                              FROM tbl_produto
                                              JOIN tbl_familia ON tbl_familia.familia = tbl_produto.familia
                                              JOIN tbl_linha ON tbl_linha.linha = tbl_produto.linha
                                              WHERE tbl_produto.produto = ".getValue("produto[id]")."
                                              AND TRIM(UPPER(tbl_familia.codigo_familia)) = '271'";
                    $resLinhaInternacional = pg_query($con, $sqlLinhaInternacional);

                    if (pg_num_rows($resLinhaInternacional) > 0) {
                        $sem_serie_display = 'style="display: none;"';
                    }

                }


                if ($postoInterno == true) {
                    $sem_serie_display = '';
                }
                ?>
                <div class="span3" id="produto_sem_serie" <?=$sem_serie_display?>>
                    <div class='control-group'>
                        <label class="control-label" for="sem_serie"><?php echo traduz('sem.numero.de.serie');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <input id="sem_serie" name="produto[sem_serie]" type="checkbox" value='t' <?=$sem_serie_checked?> <?=$sem_serie_ro?> />
                            </div>
                        </div>
                    </div>
                </div>
                <?php endif ?>

                <div class="span1 loading"></div>
                <div class="span1"></div>
            </div>

            <div class="row-fluid alert-produto-pesquisa">
                <div class="span1"></div>
                <div class="span10">

                    <div class="alert alert-warning">
                        <h5 style="margin: 0px;"><?php echo traduz('para.dar.continuidade.a.ordem.de.servico.e.necessario.pesquisar.o.produto');?>.</h5>
                    </div>

                </div>
                <div class="span1"></div>
            </div>

            <div class="row-fluid url_historico" style="display: none;">
                <div class="span1"></div>
                <div class="span10">
                    <div class="alert alert-info" >
                        <div class="tac url_link"></div>
                    </div>
                </div>
                <div class="span1"></div>
            </div>

        </div>

        <br />
    <? } ?>
    <div id="div_informacoes_os" class="tc_formulario">
        <div class="titulo_tabela"> <?php echo traduz('informacoes.da.os');?> <?= (in_array($login_fabrica, [178,186])) ? $_RESULT["os"]["sua_os"] : $os ?></div>
        <br />
        <? if(in_array($login_fabrica, array(148))){ ?>
            <input type="hidden" name="os[venda]" id="venda_id" value="<?=getValue('os[venda]')?>" />
        <? }

        if(in_array($login_fabrica, array(52,151,186)) && isset($preos)){ ?>
            <input type="hidden" name="os[hd_chamado_item]" value="<?=getValue('os[hd_chamado_item]')?>" />
        <? }

        if(in_array($login_fabrica, array(156))){
            $os_fora_garantia = getValue("os[fora_garantia]");
        ?>
            <input type="hidden" name="os[fora_garantia]" id="fora_garantia" value="<?=getValue('os[fora_garantia]')?>" />
        <? } ?>
        <div class="row-fluid">
            <div class="span1"></div>
            <? if (in_array($login_fabrica, array(169,170))) { ?>
                <div class="span3">
                    <div class="control-group <?=(in_array('os[tipo_atendimento]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="tipo_atendimento"><?php echo traduz('tipo.de.atendimento');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?php
                                if ($regras["os|tipo_atendimento"]["obrigatorio"] == true) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                }

                                $os_numero = getValue('os[os_numero]');

                                if (!empty($os_numero)) {
                                    $sql = "
                                        SELECT
                                            tbl_os.hd_chamado,
                                            tbl_tipo_atendimento.fora_garantia,
                                            tbl_tipo_atendimento.grupo_atendimento,
                                            tbl_tipo_atendimento.km_google,
                                            tbl_tipo_atendimento.descricao
                                        FROM tbl_os
                                        JOIN tbl_tipo_atendimento USING(tipo_atendimento,fabrica)
                                        WHERE fabrica = {$login_fabrica}
                                        AND os = {$os_numero};
                                    ";

                                    $res = pg_query($con, $sql);

                                    if (pg_num_rows($res) > 0) {
                                        $ordemOrigemHdChamado = pg_fetch_result($res, 0, hd_chamado);
                                        $ordemOrigemKmGoogle = pg_fetch_result($res, 0, km_google);
                                        $ordemOrigemTipoAtendimentoDescricao = pg_fetch_result($res, 0, descricao);
                                        $ordemOrigemGrupoAtendimento = pg_fetch_result($res, 0, grupo_atendimento);
                                    }
                                } else if (!empty($os)) {
                                    $sql = "
                                        SELECT
                                            tbl_os.hd_chamado,
                                            tbl_tipo_atendimento.fora_garantia,
                                            tbl_tipo_atendimento.grupo_atendimento,
                                            tbl_tipo_atendimento.km_google,
                                            tbl_tipo_atendimento.descricao
                                        FROM tbl_os
                                        JOIN tbl_tipo_atendimento USING(tipo_atendimento,fabrica)
                                        WHERE fabrica = {$login_fabrica}
                                        AND os = {$os};
                                    ";

                                    $res = pg_query($con, $sql);

                                    if (pg_num_rows($res) > 0) {
                                        $ordemOrigemHdChamado = pg_fetch_result($res, 0, hd_chamado);
                                        $ordemOrigemKmGoogle = pg_fetch_result($res, 0, km_google);
                                        $ordemOrigemTipoAtendimentoDescricao = pg_fetch_result($res, 0, descricao);
                                        $ordemOrigemGrupoAtendimento = pg_fetch_result($res, 0, grupo_atendimento);
                                    }
				                }

                                ?>
                                <select id="tipo_atendimento" name="os[tipo_atendimento]" class="span12">
                                    <? if (!empty(getValue('os[sua_os]') && strpos(getValue('os[sua_os]'), "-") !== false) || $ordemOrigemTipoAtendimentoDescricao == "Triagem" || $ordemOrigemTipoAtendimentoDescricao == "Reoperação") {
                                        if (strpos(strtolower($tipo_atendimento_descricao), "triagem") !== false) {
                                            $whereTipoAtendimento = "AND (LOWER(descricao) = 'triagem' OR descricao = 'RMA')";
                                        } else if (strpos(strtolower($tipo_atendimento_descricao), "reopera") !== false) {
                                            $whereTipoAtendimento = "AND (LOWER(descricao) ~ 'reopera' OR descricao = 'RMA')";
                                        } else {
                                            $whereTipoAtendimento = "AND descricao = 'RMA'";
                                        }
                                    } else {
                                        if (!empty($preos)) {
                                            $whereTipoAtendimento = "AND ((fora_garantia IS NOT TRUE AND grupo_atendimento = 'P' AND km_google IS NOT TRUE) OR (fora_garantia IS TRUE AND grupo_atendimento IS NULL))";
                                        } else if (!empty($hd_chamado) || (!empty($os_numero) && !empty($ordemOrigemHdChamado))) {
                                            if (strpos(strtolower($ordemOrigemTipoAtendimentoDescricao), "contas nacionais")) {
                                                $whereTipoAtendimento = "AND (LOWER(descricao) ~ 'contas nacionais' OR (fora_garantia IS TRUE AND grupo_atendimento IS NULL))";
                                            } else if ($ordemOrigemGrupoAtendimento == "I") {
                                                $whereTipoAtendimento = "AND grupo_atendimento = 'I'";
                                            } else if ($ordemOrigemKmGoogle == "t") {
                                                $whereTipoAtendimento = "AND ((grupo_atendimento = 'P' AND km_google IS TRUE AND LOWER(descricao) !~ 'contas nacionais') OR (fora_garantia IS TRUE AND grupo_atendimento IS NULL))";
                                            } else {
                                                $whereTipoAtendimento = "AND ((grupo_atendimento = 'P' AND km_google IS NOT TRUE) OR (fora_garantia IS TRUE AND grupo_atendimento IS NULL))";
                                            }
                                        } else if ($areaAdmin === false) {
                                            if (!empty($os_numero) && $ordemOrigemKmGoogle == "t") {
                                                if (strpos(strtolower($ordemOrigemTipoAtendimentoDescricao), 'contas nacionais')) {
                                                    $whereTipoAtendimento = "AND (LOWER(descricao) ~ 'contas nacionais' OR (fora_garantia IS TRUE AND grupo_atendimento IS NULL))";
                                                } else {
                                                    $whereTipoAtendimento = "AND ((grupo_atendimento = 'P' AND km_google IS TRUE AND LOWER(descricao) !~ 'contas nacionais') OR (fora_garantia IS TRUE AND grupo_atendimento IS NULL))";

                                                }
                                            } else {
                                                if (empty($os)) {
                                                    if ($abre_os_dealer == 't'){
                                                        $sql_linha = "
                                                            SELECT tbl_linha.deslocamento
                                                            FROM tbl_posto_fabrica
                                                            JOIN tbl_posto_linha ON tbl_posto_linha.posto = tbl_posto_fabrica.posto
                                                            JOIN tbl_linha ON tbl_linha.linha = tbl_posto_linha.linha AND tbl_linha.fabrica = {$login_fabrica}
                                                            WHERE tbl_posto_fabrica.fabrica = {$login_fabrica}
                                                            AND tbl_posto_fabrica.posto = {$login_posto}
                                                            AND tbl_linha.deslocamento IS TRUE";
                                                        $res = pg_query($con, $sql_linha);
                                                        if (pg_num_rows($res) > 0){
                                                            $whereTipoAtendimento = "AND ((grupo_atendimento = 'P' AND km_google IS NOT TRUE) OR (grupo_atendimento = 'P' AND km_google IS TRUE AND descricao != 'Garantia - Contas Nacionais') OR (fora_garantia IS TRUE AND grupo_atendimento IS NULL))";
                                                        }else{
                                                            $whereTipoAtendimento = "AND ((grupo_atendimento = 'P' AND km_google IS NOT TRUE) OR (fora_garantia IS TRUE AND grupo_atendimento IS NULL))";
                                                        }
                                                    }else{
                                                        $whereTipoAtendimento = "AND ((grupo_atendimento = 'P' AND km_google IS NOT TRUE) OR (fora_garantia IS TRUE AND grupo_atendimento IS NULL))";
                                                    }
                                                } else {
                                                        $whereTipoAtendimento = "AND tipo_atendimento = ".getValue("os[tipo_atendimento]");
                                                }
                                            }
                                        }
                                    }

                                    if (!empty(getValue("os[tipo_atendimento]")) && !$areaAdmin) {

                                        $sqlVerificaRecall = "SELECT tipo_atendimento
                                                              FROM tbl_tipo_atendimento
                                                              WHERE fabrica = {$login_fabrica}
                                                              AND descricao = 'RECALL DOMICÍLIO'
                                                              AND tipo_atendimento = ".getValue("os[tipo_atendimento]")."
                                                              ";
                                        $resVerificaRecall = pg_query($con, $sqlVerificaRecall);

                                        if (pg_num_rows($resVerificaRecall) > 0) {

                                            $tipoAtId = pg_fetch_result($resVerificaRecall, 0, 'tipo_atendimento');

                                            $whereTipoAtendimento = "AND tipo_atendimento = {$tipoAtId}";

                                        }

                                    } else if (!$areaAdmin) {

                                        $whereTipoAtendimento .= "AND tbl_tipo_atendimento.descricao != 'RECALL DOMICÍLIO'";

                                    }

                                    $sql = "
                                        SELECT
                                            tipo_atendimento,
                                            descricao,
                                            fora_garantia,
                                            km_google,
                                            entrega_tecnica AS visita_tecnica,
                                            grupo_atendimento
                                        FROM tbl_tipo_atendimento
                                        WHERE fabrica = {$login_fabrica}
                                        {$whereTipoAtendimento}
                                        AND ativo IS TRUE
                                        ORDER BY fora_garantia, descricao;
                                    ";
                                    $res = pg_query($con, $sql);

                                    while ($result = pg_fetch_object($res)) {
                                        $selected = ($result->tipo_atendimento == getValue("os[tipo_atendimento]")) ? "selected" : "";

                                        if ($areaAdmin === false AND $abre_os_dealer == 't'){
                                            if ($result->km_google == 't' AND $result->fora_garantia == 'f' AND $result->visita_tecnica == 'f' AND $result->grupo_atendimento == 'P'){
                                                $disabled_at = "";
                                            }else{
                                                $disabled_at = "disabled";
                                            }
                                        }else{
                                            $disabled_at = "";
                                        }

                                        if ($areaAdmin === true && in_array($login_fabrica, array(169,170)) && $result->descricao == "Fora de Garantia" && strlen($os) == 0) {
                                            continue;
                                        }

                                        if ($selected == "selected" && $result->km_google == "t" ) { ?>
                                            <script>
                                                $(function() {
                                                    $("#div_informacoes_deslocamento").show();
                                                    $("#div_visita").show();
                                                    try {
                                                        var qtde_km = $("#qtde_km").val();

                                                        if (qtde_km == null || qtde_km.length == 0) {
                                                            calcula_km(false);
                                                        } else {
                                                            calcula_km(true);
                                                        }
                                                    } catch (e) {
                                                        alert(e);
                                                    }
                                                });
                                            </script>
                                        <? } ?>
                                        <option value="<?= $result->tipo_atendimento; ?>" <?=$disabled_at?> km_google="<?= $result->km_google; ?>" fora_garantia="<?= $result->fora_garantia; ?>" visita_tecnica="<?= $result->visita_tecnica; ?>" grupo_atendimento="<?= $result->grupo_atendimento; ?>" <?= $selected; ?> ><?= $result->descricao; ?></option>
                                    <? } ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            <? } ?>
            <div class="span2">
                <div class='control-group <?=(in_array('os[data_abertura]', $msg_erro['campos'])) ? "error" : "" ?>' >
                    <?php 
                        if($login_fabrica == 157){
                            $fontLabel = "style='font-size:11px'";
                        }
                    ?>

                    <label <?=$fontLabel?> class="control-label" for="data_abertura">
                        <?php
                            if (in_array($login_fabrica, array(176)))
                            {
                                $data_texto = traduz('data.visita');
                            }else if($login_fabrica == 157){
                                $data_texto = traduz('Data.Entrada.Prod.Assist');    
                            } else {
                                $data_texto = traduz('data.abertura');                            
                            }
                            echo $data_texto;
                        ?>
                    </label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <? if ($regras["os|data_abertura"]["obrigatorio"] == true) {
                                echo "<h5 class='asteristico'>*</h5>";
                            }

                            if ($data_abertura_fixa === true) {
                                $data_readonly = "readonly='readonly'";

                                if (empty($os)) {
                                    $_RESULT["os"]["data_abertura"] = date("d/m/Y");
                                }
                            }
                            if(in_array($login_fabrica, array(167,171,176,203))) {
                                if (empty($os)) {
                                    $_RESULT["os"]["data_abertura"] = date("d/m/Y");
                                }
                            }

                            if (in_array($login_fabrica,array(169,170)) && !empty($_REQUEST["chave_os_conjunto"])) {
                                $sqlData = "
                                    SELECT  TO_CHAR(tbl_os.data_abertura,'DD/MM/YYYY') AS data_abertura
                                    FROM    tbl_os
                                    WHERE   os = ".filter_input(INPUT_GET,'os');
                                $resData = pg_query($con,$sqlData);

                                $_RESULT['os']['data_abertura'] = pg_fetch_result($resData,0,data_abertura);
                            }

                            ?>
                            <input id="data_abertura" name="os[data_abertura]" class="span12" type="text" autocomplete="off" value="<?=getValue('os[data_abertura]')?>" <?=$data_readonly?> />
                        </div>
                    </div>
                </div>
            </div>
	    <?php
	    if (in_array($login_fabrica, array(164))) { ?>
            <div class="span2">
                <div class='control-group <?=(in_array('os[data_entrada]', $msg_erro['campos'])) ? "error" : "" ?>' >
                    <label class="control-label" for="data_entrada">
                        <?= traduz('data.entrada'); ?>
                    </label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <?php if ($regras["os|data_entrada"]["obrigatorio"] == true) {
                                echo "<h5 class='asteristico'>*</h5>";
                            } ?>
                            <input id="data_entrada" name="os[data_entrada]" class="span12" type="text" autocomplete="off" value="<?=getValue('os[data_entrada]')?>" />
                        </div>
                    </div>
                </div>
	        </div>
	    <?php
	    }
	    ?>
            <? if ($usa_campo_atendimento == true && !in_array($login_fabrica, array(35,139,169,170))) { ?>
                <div class="span3 ">
                    <div class="control-group <?=(in_array('os[tipo_atendimento]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="tipo_atendimento"><?php echo traduz('tipo.de.atendimento');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if ($regras["os|tipo_atendimento"]["obrigatorio"] == true) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                }

                                ?>
                                <select id="tipo_atendimento" name="os[tipo_atendimento]" class="span12">
                                    <?php
                                    if ($login_fabrica == 175 AND count($_RESULT["produto_pecas"]) > 0){
                                        $selected_disabled = "disabled";
                                    }

                                    if (!($login_fabrica == 158 && $grupo_atendimento == "S")) {
                                        echo (in_array($login_fabrica, array(164,165,184,200)) && $areaAdmin == false) ? "" : "<option $selected_disabled></option>";
                                    }

                                    if (
                                        in_array($login_fabrica, array(143,151,165,167,203))
                                        && ((strlen(getValue("posto[id]")) > 0) || strlen($login_posto > 0))
                                    ) {
                                        if(strlen(getValue("posto[id]")) > 0){
                                            $login_posto = getValue("posto[id]");
                                        }

                                        $sql = "SELECT tbl_tipo_posto.tipo_posto,
                                                    UPPER(fn_retira_especiais(tbl_tipo_posto.descricao)) AS descricao,
                                                    tbl_tipo_posto.posto_interno,
                                                    tbl_tipo_posto.desconto_5estrela
                                                FROM tbl_posto_fabrica
                                                INNER JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto AND tbl_tipo_posto.fabrica = {$login_fabrica}
                                                WHERE tbl_posto_fabrica.fabrica = {$login_fabrica}
                                                AND tbl_posto_fabrica.posto = {$login_posto}";
                                        $res = pg_query($con, $sql);
                                        $tipo_posto_descricao = pg_fetch_result($res, 0, descricao);
                                        $posto_interno = pg_fetch_result($res, 0, posto_interno);

                                        $desconto_5estrela = pg_fetch_result($res,0, desconto_5estrela); //HD-3428328
                                        if ($login_fabrica == 143) {
                                            if ($tipo_posto_descricao == 'LOCADORA' || $tipo_posto_descricao == 'CONSTRUTORACLIENTE FINAL') {
                                                $sql_descricao = "AND UPPER(fn_retira_especiais(descricao)) ~ 'BALCAO' ";
                                            }
                                        }

                                        if ($login_fabrica == 151) {
                                            if (strtoupper($tipo_posto_descricao) == 'REVENDA') {
                                                $tipo_posto_revenda = true;
                                            }

                                            if ($tipo_posto_revenda == false) {
                                                $sql_descricao =" AND UPPER(fn_retira_especiais(descricao)) NOT LIKE '%REVENDA%' ";
                                            }
                                        }
                                    }

                                    if (in_array($login_fabrica, array(156))) {
                                        if ($postoInterno == true) {
                                            $sql_posto_interno = " AND grupo_atendimento IN('I','P') AND fora_garantia IS NULL";
                                        } else {
                                            $sql_posto_interno = "AND grupo_atendimento = 'P'";
                                        }
                                    }

                                    if(in_array($login_fabrica, array(148))){
                                        $whereTiposAtendimentos = array("grupo_atendimento = 'R'");

                                        if(empty($os)){
                                            if($areaAdmin == true) {
                                                $cond = "AND tbl_posto_tipo_posto.posto = ".getValue('posto[id]');
                                            }else{
                                                $cond = "AND tbl_posto_tipo_posto.posto = $login_posto";
                                            }
                                            $sql_tipo_posto = "SELECT
                                                        tbl_tipo_posto.tipo_posto,
                                                        tbl_tipo_posto.descricao,
                                                        tbl_tipo_posto.locadora,
                                                        tbl_tipo_posto.tipo_revenda,
                                                        tbl_tipo_posto.montadora,
                                                        tbl_tipo_posto.posto_interno
                                                    FROM tbl_posto_tipo_posto
                                                    JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_tipo_posto.tipo_posto AND tbl_tipo_posto.fabrica = {$login_fabrica}
                                                    WHERE tbl_posto_tipo_posto.fabrica = {$login_fabrica}
                                                    $cond ";
                                            $res_tipo_posto = pg_query($con, $sql_tipo_posto);

                                            if(pg_num_rows($res_tipo_posto) > 0){

                                                $tipos_postos = array();

                                                for ($x = 0; $x < pg_num_rows($res_tipo_posto); $x++) {
                                                    $tipos_postos[] = array(
                                                            "tipo_posto"    => pg_fetch_result($res_tipo_posto, $x, "tipo_posto"),
                                                            "descricao"     => pg_fetch_result($res_tipo_posto, $x, "descricao"),
                                                            "locadora"      => pg_fetch_result($res_tipo_posto, $x, "locadora"),
                                                            "tipo_revenda"  => pg_fetch_result($res_tipo_posto, $x, "tipo_revenda"),
                                                            "montadora"     => pg_fetch_result($res_tipo_posto, $x, "montadora"),
                                                            "posto_interno" => pg_fetch_result($res_tipo_posto, $x, "posto_interno")
                                                        );
                                                }
                                            }
                                        }

                                        foreach ($tipos_postos as $key => $tipo_posto_arr) {
                                            if ($tipo_posto_arr["locadora"] == "f" && $tipo_posto_arr["tipo_revenda"] == "f" && $tipo_posto_arr["montadora"] == "f" && $tipo_posto_arr["posto_interno"] == "f") {
                                                $whereTiposAtendimentos[] = "grupo_atendimento = 'A'";
                                            }

                                            if ($tipo_posto_arr["tipo_revenda"] == "t" || $tipo_posto_arr["locadora"] == "t") {
                                                $whereTiposAtendimentos[] = "entrega_tecnica is true";
                                            }
                                        }

                                        if (!empty($os)) {
                                            $whereTiposAtendimentos[] = "tipo_atendimento = ".getValue("os[tipo_atendimento]");
                                        }

                                        $sql = "SELECT tipo_atendimento,
                                                descricao,
                                                fora_garantia,
                                                km_google, entrega_tecnica AS visita_tecnica,
                                                grupo_atendimento
                                            FROM tbl_tipo_atendimento
                                            WHERE fabrica = {$login_fabrica}
                                            AND ativo IS TRUE
                                            AND (".implode(" OR ", $whereTiposAtendimentos).")
                                            ORDER BY descricao";

                                    } else if (in_array($login_fabrica, array(156))) {
                                        if (strlen($preos) > 0 || strlen($hd_chamado) > 0) {
                                            $whereKMGoogle = "";
                                        }else{
                                            $whereKMGoogle = "AND UPPER(descricao) NOT LIKE UPPER('Com Deslocamento')";
                                        }

                                        if (strlen($sql_posto_interno) == 0) {
                                            $sql_posto_interno = "AND grupo_atendimento IS NULL";
                                        }

                                        $sql = "SELECT tipo_atendimento,
                                                descricao,
                                                fora_garantia,
                                                km_google, entrega_tecnica AS visita_tecnica
                                            FROM tbl_tipo_atendimento
                                            WHERE fabrica = {$login_fabrica}
                                            AND ativo IS TRUE
                                            {$whereKMGoogle}
                                            {$sql_posto_interno}
                                            ORDER BY descricao";

                                    } else {

                                        if ($login_fabrica == 171 && getValue("os[contrato]") == "t") {
                                            $whereForaGarantia = " AND tbl_tipo_atendimento.fora_garantia IS NOT TRUE ";
                                        }

                                        if (in_array($login_fabrica, array(152,180,181,182))) {
                                            $whereEntregaTecnica = "AND entrega_tecnica IS NOT TRUE";
                                        }
                                        if (!$login_fabrica == 156) {
                                            $whereGrupoAtendimento = "AND grupo_atendimento IS NULL";
                                        }
                                        if ($login_fabrica == 158) {
                                            if ($grupo_atendimento == "S") {
                                                $whereGrupoAtendimento = "AND tipo_atendimento = ".getValue("os[tipo_atendimento]");
                                            } else {
                                                if (!empty($hd_chamado) && empty($codigoKof)) {
                                                    $whereForaGarantia = "AND tbl_tipo_atendimento.fora_garantia IS FALSE";
                                                }

                                                if (!empty($login_posto)) {
                                                    $sqlTpAtendCad = "SELECT tipo_atendimento FROM tbl_posto_tipo_atendimento WHERE posto = {$login_posto} AND fabrica = {$login_fabrica};";
                                                    $resTpAtendCad = pg_query($con, $sqlTpAtendCad);
                                                    $tpAtendCad = pg_fetch_all($resTpAtendCad);

                                                    $tpAtend = "";

                                                    foreach ($tpAtendCad as $key => $av) {
                                                        if ($key == 0) {
                                                            $tpAtend = $av['tipo_atendimento'];
                                                        } else {
                                                            $tpAtend .= ",".$av['tipo_atendimento'];
                                                        }
                                                    }

                                                    if (strlen($tpAtend) > 0) {
                                                        $whereTpAtendPosto = "AND tbl_tipo_atendimento.tipo_atendimento IN (".$tpAtend.")";
                                                    }
                                                }
                                            }
                                        }

                                        if($login_fabrica == 161){

                                            if($areaAdmin == false){

                                                if($postoInterno == true){
                                                    $sql_descricao .= " AND UPPER(descricao) IN (UPPER('Orçamento'), UPPER('Balcão')) ";
                                                }else{
                                                    $sql_descricao .= " AND UPPER(descricao) = UPPER('Balcão') ";
                                                }

                                            }

                                        }

                                        if($login_fabrica == 164){

                                            if($areaAdmin == false){

                                                $sql_descricao .= " AND UPPER(descricao) = UPPER('Balcão') ";

                                            }

                                        }

                                        if (in_array($login_fabrica, array(184,200))) {

                                            $sqlAtendeDeslocamento = "SELECT parametros_adicionais::jsonb->>'garantia_com_deslocamento' as atende_deslocamento
                                                                      FROM tbl_posto_fabrica
                                                                      WHERE posto = {$login_posto}
                                                                      AND fabrica = {$login_fabrica}";
                                            $resAtendeDeslocamento = pg_query($con, $sqlAtendeDeslocamento);

                                            $atende_deslocamento = pg_fetch_result($resAtendeDeslocamento, 0, 'atende_deslocamento');

                                            if ($atende_deslocamento != "t") {

                                                $whereAtendeDeslocamento = "AND tbl_tipo_atendimento.km_google IS NOT TRUE";

                                            }


                                        }

                                        if (in_array($login_fabrica, [177]) && !$postoInterno ) {
                                            $whereOrcamento = "AND UPPER(descricao) NOT IN (UPPER('Orçamento'),UPPER('Fora da Garantia'))";
                                        }

                                        if (in_array($login_fabrica, [195]) && $postoInterno ) {
                                            $whereTpAtendPosto =  "AND UPPER(descricao) NOT IN (UPPER('Garantia com Deslocamento'))";
                                        }

                                        if (in_array($login_fabrica, [186,191]) && !$postoInterno && $areaAdmin == false) {

                                            $whereOrcamento = "AND UPPER(descricao) NOT IN (UPPER('Orçamento'))";
                                            $valida_atendimento = getValue("produto[valida_atendimento]");
                                        }


                                        if (in_array($login_fabrica, [186,190,191,195]) ) {

                                            $valida_atendimento = getValue("produto[valida_atendimento]");
                                            if($valida_atendimento == "Orçamento"){
                                                $display_orcamento = "";
                                                $display_servico_peca = "style='display:none;'";
                                            }else{
                                                $display_orcamento = "style='display:none;'";
                                                $display_servico_peca = "";
                                            }
                                        }

                                        $ta_orderby = (in_array($login_fabrica, array(163,171))) ? "tipo_atendimento" : "descricao ";

                                        if(in_array($login_fabrica, [167, 203])){ //HD-3428328
                                            $suprimento = getValue("produto[suprimento]");
                                            $contador = getValue("produto[contador]");

                                            $valida_atendimento = getValue("produto[valida_atendimento]");
                                            $valida_suprimento = getValue("produto[valida_suprimento]");
                                            $valida_contador = getValue("produto[valida_contador]");

                                            if (strlen(getValue("produto[id]")) > 0) {
                                                $sql = "SELECT tbl_familia.familia
                                                    FROM tbl_produto
                                                    JOIN tbl_familia USING(familia)
                                                    WHERE fabrica = {$login_fabrica}
                                                    AND(tbl_familia.descricao ~* 'Impressora' OR tbl_familia.descricao ~* 'Multifunciona')
                                                    AND tbl_produto.produto = ".getValue("produto[id]");
                                                $resFam = pg_query($con,$sql);

                                                if(pg_num_rows($resFam) == 0){
                                                    $display_contador = "style='display:none;'";
                                                }
                                            } else {
                                                $display_contador = "style='display:none;'";
                                            }

                                            if (in_array($login_fabrica, [203])) {
                                                $sqlLinha = "SELECT tbl_linha.codigo_linha
                                                              FROM tbl_produto
                                                              JOIN tbl_familia ON tbl_familia.familia = tbl_produto.familia
                                                              JOIN tbl_linha ON tbl_linha.linha = tbl_produto.linha
                                                              WHERE tbl_produto.produto = ".getValue("produto[id]");
                                                $resLinha = pg_query($con, $sqlLinha);

                                                if (pg_num_rows($resLinha) > 0) {
                                                    $xCodigoLinha        = pg_fetch_result($resLinha, 0, 'codigo_linha');
                                                    $display_asteristico = (in_array($xCodigoLinha, ['2','02'])) ? "" : "style='display:none;'";

                                                    if (in_array($xCodigoLinha, ['1','2','01','02'])) {
                                                        $display_contador = "";
                                                    }
                                                }
                                            }

                                            if($suprimento == 't' OR $valida_suprimento == 't'){

                                                if(strlen(trim($_RESULT['produto_pecas'][0]['os_item'])) > 0){
                                                    $mostra_produto_pecas = '';
                                                }else{
                                                    $mostra_produto_pecas = "display: none; color: red;";
                                                }
                                                $valida_suprimento = 't';
                                            }else{
                                                $comunicado_suprimento = "style='display: none;'";
                                            }

                                            if($desconto_5estrela == 1){
                                                $whereForaGarantia = "AND (tbl_tipo_atendimento.fora_garantia IS NOT TRUE OR tbl_tipo_atendimento.km_google IS TRUE) ";
                                            }else{
                                                $whereForaGarantia = "AND tbl_tipo_atendimento.fora_garantia IS NOT TRUE AND tbl_tipo_atendimento.km_google IS FALSE ";
                                                if($postoInterno){
                                                    $whereForaGarantia = " AND tbl_tipo_atendimento.km_google IS FALSE ";
                                                }
                                            }

                                            if($valida_atendimento == "Orçamento"){
                                                $display_orcamento = "";
                                                $display_servico_peca = "style='display:none;'";
                                            }else{
                                                $display_orcamento = "style='display:none;'";
                                                $display_servico_peca = "";
                                            }
                                            $display_desconto = "style='display:none;'";
                                        }else{
                                            $display_desconto = "";
                                        }

                                        if ($login_fabrica == 171) {

                                            $sql = "SELECT tbl_hd_chamado_extra.tipo_atendimento
                                                    FROM tbl_hd_chamado_extra
                                                    JOIN tbl_os ON tbl_os.hd_chamado = tbl_hd_chamado_extra.hd_chamado
                                                    WHERE tbl_os.os = ".$_GET["os_id"];
                                            $res =  pg_query($con, $sql);

                                            if (pg_num_rows($res) > 0) {
                                                $tipo_atendimento_callcenter = pg_fetch_result($res, 0, "tipo_atendimento");
                                            }
                                        }

                                        if ($login_fabrica == 177 AND empty(getValue("os[sua_os]"))){
                                            $whereGrupoAtendimento = " AND (tbl_tipo_atendimento.grupo_atendimento NOT IN ('A') OR tbl_tipo_atendimento.grupo_atendimento IS NULL)";
                                        }

                                        if ($login_fabrica == 144 && !$postoInterno) {
                                            $whereDeslocamento = "AND km_google IS NOT TRUE";
                                        }

                                        $cod_externo     = '';

                                        if (in_array($login_fabrica, [193,194])) {
                                            $cod_externo = ", codigo_externo";
                                            $ta_orderby  = "descricao DESC";
                                        }

                                        $sql = "SELECT tipo_atendimento,
                                                    descricao,
                                                    fora_garantia,
                                                    km_google,
                                                    entrega_tecnica AS visita_tecnica,
                                                    grupo_atendimento
                                                    {$cod_externo}
                                                FROM tbl_tipo_atendimento
                                                WHERE fabrica = {$login_fabrica}
                                                AND ativo IS TRUE
                                                {$whereGrupoAtendimento}
                                                {$whereEntregaTecnica}
                                                {$sql_descricao}
                                                {$whereForaGarantia}
                                                {$whereTpAtendPosto}
                                                {$whereOrcamento}
                                                {$whereGarantiaComDeslocamento}
                                                {$whereDeslocamento}
                                                ORDER BY {$ta_orderby}";
                                    }
                                    $res = pg_query($con, $sql);

                                    if(in_array($login_fabrica, [167, 203])){
                                        $res_at = pg_fetch_all($res);
                                    }
                                    
                                    while ($result = pg_fetch_object($res)) {
                                        if ($login_fabrica == 176 && $postoInterno && $result->descricao != "Garantia"){
                                            continue;
                                        }
                                        $tipo_atendimento_callcenter = ($login_fabrica == 171 && !empty($tipo_atendimento_callcenter)) ? $tipo_atendimento_callcenter : getValue("os[tipo_atendimento]");
                                        if ($result->tipo_atendimento == $tipo_atendimento_callcenter) {

                                            $desc_tipo_atendimento = $result->descricao;
                                            $selected = "selected";
                                            $aux_garantia_dig = ($result->fora_garantia == 't') ? 'f' : 't';

                                            if(in_array($login_fabrica, [167, 203])){
                                                if($result->descricao == 'Orçamento'){
                                                    $display_orcamento = "";
                                                }
                                            }
                                        } else {
                                            if(count($res_at) == 1 AND in_array($login_fabrica, [167, 203])){
                                               $selected = "selected";
                                            }else{
                                                $selected = "";
                                            }

                                            if ($login_fabrica == 175 AND count($_RESULT["produto_pecas"]) > 0){
                                                $selected = "disabled";
                                            }
                                            
                                            if (in_array($login_fabrica, [177,184,200]) AND empty(getValue("os[tipo_atendimento]")) AND $result->descricao == "Garantia"){
                                                $selected = "selected";
                                            }
                                        }

                                        if ($selected == "selected" && $result->km_google == "t") {
                                            if (in_array($login_fabrica, $usa_km_revenda) && getValue("os[consumidor_revenda]") == 'R') { ?>
                                                <script>
                                                    $(function() {
                                                        $("#div_informacoes_deslocamento").show();
                                                        <?
                                                            if (in_array($login_fabrica, array(142,156,169,170))) {
                                                                if (in_array($login_fabrica, array(169,170)) AND $abre_os_dealer == 't'){
                                                        ?>
                                                                    $("#div_visita").hide();
                                                        <?php
                                                                }else{
                                                        ?>
                                                                    $("#div_visita").show();
                                                        <?php
                                                                }
                                                            }
                                                        ?>
                                                        try {
                                                            calcula_km_revenda(true);
                                                        } catch (e) {
                                                            alert(e);
                                                        }
                                                    });
                                                </script>

                                                <?php

                                            }else{
                                                if (!in_array($login_fabrica, array(143)) && $os_revenda != true) { 
                                                    if ($login_fabrica == 178){
                                                        $sua_os_numero = $_RESULT["os"]["sua_os"];
                                                        $pos = strpos($sua_os_numero, "-");
                                                        if ($pos === false){
                                            ?>  
                                                            <script>
                                                                $(function() {
                                                                    $("#div_informacoes_deslocamento").show();
                                                                    <? if (in_array($login_fabrica, array(142,156,169,170))) { ?>
                                                                        $("#div_visita").show();
                                                                    <? } ?>
                                                                    try {
                                                                        calcula_km(true);
                                                                    } catch (e) {
                                                                        alert(e);
                                                                    }
                                                                });
                                                            </script>
                                            <?php       
                                                        }     
                                                    }else{
                                            ?>
                                                        <script>
                                                            $(function() {
                                                                $("#div_informacoes_deslocamento").show();
                                                                <? if (in_array($login_fabrica, array(142,156,169,170))) { ?>
                                                                    $("#div_visita").show();
                                                                <? } ?>
                                                                try {
                                                                    calcula_km(true);
                                                                } catch (e) {
                                                                    alert(e);
                                                                }
                                                            });
                                                        </script>
                                            <?php            
                                                    }
                                            ?>
                                                <?php
                                                } else if (in_array($login_fabrica, array(143)) && $tipo_posto_revenda === true) { ?>
                                                    <script>
                                                        $(function() {
                                                            $("#div_informacoes_deslocamento").show();
                                                        });
                                                    </script>
                                                <? }

                                            }

                                        }

                                        if (isset($moduloTraducao)) {
                                            $sqlIdiomaAtendimento = "SELECT descricao 
                                                                     FROM tbl_tipo_atendimento_idioma 
                                                                     WHERE tipo_atendimento = {$result->tipo_atendimento}
                                                                     AND LOWER(idioma) = LOWER('$cook_idioma')";
                                            $resIdiomaAtendimento = pg_query($con, $sqlIdiomaAtendimento);

                                            if (pg_num_rows($resIdiomaAtendimento) > 0) {
                                                $result->descricao = utf8_decode(pg_fetch_result($resIdiomaAtendimento, 0, 'descricao'));
                                            }

                                        }

                                        if (in_array($login_fabrica, array(138))) {
                                            /**
                                             * O campos visita_tecnica é utilizado para mostrar se é uma os de garantia ou não
                                             * se a os for uma os de visita técnica e não for de garantia é travado o lançamento de itens e a os é finalizada assim que gravar
                                             */

                                            if ($selected == "selected" && $result->visita_tecnica == "t") {
                                                $mostra_os_garantia = "style='display: block;'";
                                            }

                                            echo "<option value='{$result->tipo_atendimento}' km_google='{$result->km_google}'  visita_tecnica='{$result->visita_tecnica}' {$selected} >{$result->descricao}</option>";
                                        } else {
                                            if ($login_fabrica == 145 && $selected == "selected" && ($result->fora_garantia == "t" || $result->tipo_atendimento == 198)) {
                                                $mostra_produto_pecas = "display: none;";
                                            }

                                            if ($login_fabrica == 173 AND $postoInterno != true AND empty($result->fora_garantia)){
                                                continue;
                                            }

                                            if ($login_fabrica == 178){
                                                if (!empty(getValue("os[hd_chamado]"))){
                                                    $tipo_atendimento_desc = retira_acentos($result->descricao);
                                                    $tipo_atendimento_desc = strtolower($tipo_atendimento_desc);
                                                    if ($tipo_atendimento_desc == "atendimento balcao"){
                                                        continue;
                                                    }
                                                    
                                                    if (empty($tipo_atendimento_callcenter) AND $tipo_atendimento_desc == "garantia domicilio"){
                                                        $selected_callcenter = "SELECTED";
                                                    }else{
                                                        $selected_callcenter = "";
                                                    }
                                                }else{
                                                    $selected_callcenter = "";
                                                }
                                            }

                                            if ($login_fabrica == 148) {
                                                echo "<option value='{$result->tipo_atendimento}' km_google='{$result->km_google}' fora_garantia='{$result->fora_garantia}' visita_tecnica='{$result->visita_tecnica}' grupo_atendimento='{$result->grupo_atendimento}' {$selected} >{$result->descricao}</option>";
                                            } else if ($login_fabrica == 153) {
                                                echo "<option value='{$result->tipo_atendimento}' km_google='{$result->km_google}' fora_garantia='{$result->fora_garantia}' visita_tecnica='{$result->visita_tecnica}' {$selected} >{$result->descricao}</option>";
                                            } else if ($login_fabrica == 176)
                                            {
                                                 // desativando tipo de pagamento "Instalação"
                                                    if ($result->tipo_atendimento != 327)
                                                    {
                                                        echo "<option value='{$result->tipo_atendimento}' km_google='{$result->km_google}' fora_garantia='{$result->fora_garantia}' visita_tecnica='{$result->visita_tecnica}' {$selected} >{$result->descricao}</option>";
                                                    }
                                            } else if (in_array($login_fabrica, [193,194])) {
                                                echo "<option value='{$result->tipo_atendimento}' codigo='{$result->codigo_externo}' km_google='{$result->km_google}' fora_garantia='{$result->fora_garantia}' visita_tecnica='{$result->visita_tecnica}' {$selected} {$selected_callcenter} >".utf8_decode($result->descricao)."</option>";
                                            }else {
                                                echo "<option value='{$result->tipo_atendimento}' km_google='{$result->km_google}' fora_garantia='{$result->fora_garantia}' visita_tecnica='{$result->visita_tecnica}' {$selected} {$selected_callcenter} >{$result->descricao}</option>";
                                            }
                                        }
                                    }
?>
                                </select>
                                <?php
                                if ($login_fabrica == 171) { ?>
                                    <input type="hidden" value="<?= $_POST["garantia_grohe"] ?>" name="garantia_grohe" />
                                <?php }

                                if(in_array($login_fabrica, [167, 203])){
                                ?>
                                    <input type="hidden" id="valida_atendimento" name="os[valida_atendimento]" value="<?=$valida_atendimento?>">
                                <?php
                                }
                                if (in_array($login_fabrica, array(148,156,158,186,190,191,195)) && strlen(getValue("os[tipo_atendimento]")) > 0) {
                                    $change_tipo_atendimento = true;

                                    if ($login_fabrica == 156 and $areaAdmin == true and !empty($os)) {
                                        $change_tipo_atendimento = false;
                                    }
                                    if ($change_tipo_atendimento === true) {
                                    ?>
                                        <script>
                                            $(function() {
                                                $("#tipo_atendimento").change();
                                            });
                                        </script>
                                    <?php
                                    }
                                }
                                ?>
                            </div>
                        </div>
                    </div>
                </div>
            <? }
            if($login_fabrica != 158){ 
                $label_NF = traduz('Nota Fiscal');
                $txt_anexo_obs = "(".traduz('anexo.obrigatorio').")";
                if($login_fabrica == 186){

                    $sqlTipo = "SELECT * FROM tbl_tipo_atendimento WHERE fabrica={$login_fabrica} AND tipo_atendimento=".$_POST["os"]["tipo_atendimento"];
                    $resTipo = pg_query($con, $sqlTipo);
                    if (pg_num_rows($resTipo) > 0) {

                        $tipo_atendimento_descr = pg_fetch_result($resTipo, 0, 'descricao');

                        if ($tipo_atendimento_descr == "Garantia Certificado") {
                            $label_NF = traduz("Nº Certificado");
                        }
                        if ($tipo_atendimento_descr == "Orçamento") {
                            $txt_anexo_obs = "";
                        }
                    }
                        $size = "font-size:11px;";
                }
            ?>
                <div class="span3">
                    <div class='control-group nota_fiscal <?=(in_array('os[nota_fiscal]', $msg_erro['campos'])) ? "error" : "" ?>'>
                        <label class="control-label txt_nf" for="nota_fiscal"><?= $label_NF ?></label>
                        <?php
                            if((isset($valida_anexo) && !in_array($login_fabrica, array(52))) || $anexo_obrigatorio){
                                if (!in_array($login_fabrica, array(35, 171, 143)) || ($login_fabrica == 171 && getValue('os[contrato]') == "t")) {
                                ?>
                                    <strong  style="color:#B94A48;<?php echo $size;?>" id="nota_obrigatoria"><?php echo $txt_anexo_obs?></strong >
                                <?php
                                }
                            }
                        ?>

                        <div class="controls controls-row">
                            <div class="span12">
                                <? if ($regras["os|nota_fiscal"]["obrigatorio"] == true || $login_fabrica == 145) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                } ?>
                                <input id="nota_fiscal" name="os[nota_fiscal]" class="span12" type="text" value="<?=getValue('os[nota_fiscal]')?>" maxlength="20" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="span2">
                    <div class='control-group data_compra <?=(in_array('os[data_compra]', $msg_erro['campos'])) ? "error" : "" ?>'>
                    <?php if ($login_fabrica != 164) { ?>
                        <label class="control-label" for="data_compra"><?php echo traduz('data.compra');?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <? if ($regras["os|data_compra"]["obrigatorio"] == true || $login_fabrica == 145) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    } ?>
                                    <input id="data_compra" name="os[data_compra]" class="span12" type="text" value="<?=getValue('os[data_compra]')?>" />
                                </div>
                            </div>
                        <?php } ?> 
                    </div>
                </div>
            <?
            } else {
            ?>
                <div class="span3">
                    <div class='control-group <?=(in_array('os[unidade_negocio]', $msg_erro['campos'])) ? "error" : "" ?>'>
                        <label class="control-label" for="unidade_negocio"><?php echo traduz('unidade.de.negocio');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if ($regras["os|unidade_negocio"]["obrigatorio"] == true) { ?>
                                    <h5 class='asteristico'>*</h5>
                                <? } ?>
                                <select id="unidade_negocio" name="os[unidade_negocio]" class="span12">
                                    <option value=""></option>
                                    <?php
                                    if (strlen(getValue("posto[id]")) > 0) {
                                        $login_posto = getValue("posto[id]");
                                    }

                                    if (!empty($login_posto) || strlen(getValue("os[unidade_negocio]")) > 0) {
                                        if (strlen(getValue("os[unidade_negocio]")) > 0) {
                                            $sql = "
                                                SELECT DISTINCT
                                                    tbl_distribuidor_sla.distribuidor_sla,
                                                    tbl_distribuidor_sla.unidade_negocio,
                                                    tbl_unidade_negocio.nome
                                                FROM tbl_distribuidor_sla
                                                JOIN tbl_unidade_negocio ON tbl_unidade_negocio.codigo=tbl_distribuidor_sla.unidade_negocio
                                                WHERE tbl_distribuidor_sla.fabrica = {$login_fabrica}
                                                AND tbl_distribuidor_sla.unidade_negocio = '".getValue("os[unidade_negocio]")."';
                                            ";
                                        } else if (!empty($login_posto)) {
                                            $sql = "
                                                SELECT DISTINCT
                                                    tbl_distribuidor_sla.unidade_negocio,
                                                    tbl_distribuidor_sla.distribuidor_sla,
                                                    tbl_unidade_negocio.nome
                                                FROM tbl_distribuidor_sla_posto
                                                JOIN tbl_distribuidor_sla USING(distribuidor_sla, fabrica)
                                                JOIN tbl_unidade_negocio ON tbl_unidade_negocio.codigo=tbl_distribuidor_sla.unidade_negocio
                                                WHERE tbl_distribuidor_sla_posto.fabrica = {$login_fabrica}
                                                AND tbl_distribuidor_sla_posto.posto = {$login_posto};
                                            ";
                                        }

                                        $res = pg_query($con, $sql);

                                        if (pg_num_rows($res) > 0) {
                                            while ($result = pg_fetch_object($res)) {
                                                $selected  = (trim($result->unidade_negocio) == getValue("os[unidade_negocio]")) ? "SELECTED" : "";

                                                $nomeUnidade = $result->unidade_negocio . " - " . $result->nome;
                                                
                                                ?>
                                                <option value="<?=$result->unidade_negocio?>" <?=$selected?> ><?=$nomeUnidade?></option>
                                            <? }
                                        } else { ?>
                                            <option value=""><?php echo traduz('nenhuma.unidade.de.negocio.encontrada');?></option>
                                        <?
                                        }
                                    }
                                    ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <?php $displayMarca = (getValue("os[unidade_negocio]") == 7300) ? "block" : 'none'; ?>


                <div class="span2" id="marca" style="display:<?=$displayMarca?>">
                    <div class='control-group <?=(in_array('os[marca]', $msg_erro['campos'])) ? "error" : "" ?>'>
                        <label class="control-label" for="marco"><?php echo traduz('marca');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if ($regras["os|marca"]["obrigatorio"] == true) { ?>
                                    <h5 class='asteristico'>*</h5>
                                <? } ?>
                                <select  name="os[marca]" class="span12">
                                    <option value=""></option>
                                    <?php 
                                    $sql = "SELECT marca, nome FROM tbl_marca WHERE fabrica = $login_fabrica and marca in (662,663,664)";
                                    $res = pg_query($con, $sql);
                                    for($ma=0; $ma<pg_num_rows($res); $ma++){
                                        $marca = pg_fetch_result($res, $ma, 'marca');
                                        $nome = pg_fetch_result($res, $ma, 'nome');

                                        $selected = ( $marca == getValue("os[marca]") ) ? " selected " : " "; 

                                        echo "<option value='$marca' $selected >$nome</option>";
                                    }

                                    ?>

                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            <?
            }
            ?>
            <div class="span1"></div>
        </div>
        <? if (!in_array($login_fabrica, array(158))) { ?>
            <div class="row-fluid">
                <div class="span1"></div>
                <? if ((!isset($usaDefeitoReclamadoCadastro)) && !in_array($login_fabrica, array(52,165,175,177,194)) ) { ?>
                    <div class="span4" id="div_defeito_reclamado">
                        <div class='control-group <?=(in_array('os[defeito_reclamado]', $msg_erro['campos'])) ? "error" : "" ?>'>
                            <label class="control-label" for="defeito_reclamado"><?php echo traduz('defeito.reclamado');?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <? if (($login_fabrica != 139 && $regras["os|defeito_reclamado"]["obrigatorio"] == true) || ($login_fabrica == 139 && $regras["os|defeito_reclamado"]["obrigatorio"] == true && $os_revenda === false)) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                    } ?>
                                    <input id="defeito_reclamado<?php echo ($login_fabrica == 186) ? "_cli" : "";?>" name="os[defeito_reclamado]" class="span12" type="text" value="<?=getValue('os[defeito_reclamado]')?>" />
                                </div>
                            </div>
                        </div>
                    </div>
                <? } ?>

                <?php if($login_fabrica == 153 and strlen(getValue("os[tipo_atendimento]")) > 0 ){
                    $sql = "SELECT descricao
                        FROM tbl_tipo_atendimento
                        WHERE fabrica = $login_fabrica
                        AND tipo_atendimento = ".getValue("os[tipo_atendimento]") ;
                    $res = pg_query($con, $sql);
                    if(pg_num_rows($res)> 0 ){
                        $descricao = pg_fetch_result($res, 0, 'descricao');
                        if($descricao == "Laudo Zero Hora"){
                            $descricao_laudo_zero_hora = "Laudo Zero Hora";
                            $produto_pecas_positron = "display:none;";
                            $display_combo = " display:block; ";
                            $display_campo = " display:none; ";
                            $display_lacre_positron = " display:block; ";
                        }else{
                            $descricao_laudo_zero_hora = "";
                            $produto_pecas_positron = "display:block;";
                            $display_combo = " display:none; ";
                            $display_campo = "display:block";
                            $display_lacre_positron = " display:none; ";
                        }
                    } else {
                        $produto_pecas_positron = "display:block;";
                        $display_combo = " display:none; ";
                        $display_campo = "display:block";
                        $display_lacre_positron = " display:none; ";
                    }
                }
                ?>

                <?php if($login_fabrica == 191 and $postoInterno){ ?>
                        <div class="span3">
                            
                            <div class="control-group <?=(in_array('os[numero_nf_remessa]', $msg_erro['campos'])) ? "error" : "" ?>">
                                <label class="control-label" for="numero_nf_remessa"><?php echo traduz('nota.de.remessa');?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <? if ($regras["os|numero_nf_remessa"]["obrigatorio"] == true) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                        } ?>
                                        <input id="numero_nf_remessa" name="os[numero_nf_remessa]" class="span12" type="text" value="<?=getValue('os[numero_nf_remessa]')?>" />
                                    </div>
                                </div>
                            </div>
                        </div>
                <?php }?>

                <div class="span3">
                    <? if (in_array($login_fabrica, array(153))) {
                        if ($erro_aparencia) {
                            $msg_erro["campos"][] = "os[aparencia_produto]";
                        }
                    } ?>
                    <div class="control-group <?=(in_array('os[aparencia_produto]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="aparencia_produto"><?php echo traduz('aparencia.do.produto');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if (($login_fabrica != 139 && $regras["os|aparencia_produto"]["obrigatorio"] == true) || ($login_fabrica == 139 && $regras["os|aparencia_produto"]["obrigatorio"] == true && $os_revenda === false)) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                } ?>
                                <input id="aparencia_produto" name="os[aparencia_produto]" style="<?=$display_campo?>" class="span12" type="text" value="<?=getValue('os[aparencia_produto]')?>" />
                                <? if ($login_fabrica == 153) { ?>
                                    <select id="aparencia_produto_zero_hora" style="<?=$display_combo?>" name="os[aparencia_produto]" class="span12">
                                        <option></option>
                                        <option value="novo" <?php if(getValue('os[aparencia_produto]') == "novo") echo " selected " ?> >Novo</option>
                                        <option value="usado" <?php if(getValue('os[aparencia_produto]') == "usado") echo " selected " ?> >Usado</option>
                                    </select>
                                <?}?>
                            </div>
                        </div>
                    </div>
                </div>
                <?php if($login_fabrica == 161 and getValue('produto[linha]') == 1126){
                        $style = "style='display:none'";
                }?>
                <div class="span3 divacessorios" <?=$style?> >
                    <?
                    if (in_array($login_fabrica, array(148,153))) {
                        if($erro_acessorio){
                            $msg_erro["campos"][] = "os[acessorios]";
                        }
                    }
                    ?>
                    <div class="control-group <?=(in_array('os[acessorios]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="acessorios"><?php echo ($login_fabrica == 148) ? traduz('Implemento (s)') : traduz('acessorios');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if (($login_fabrica != 139 && $regras["os|acessorios"]["obrigatorio"] == true) || ($login_fabrica == 139 && $regras["os|acessorios"]["obrigatorio"] == true && $os_revenda === false)) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                } ?>
                                <input id="acessorios" name="os[acessorios]" class="span12" style="<?=$display_campo?>" type="text" value="<?=getValue('os[acessorios]')?>" />
                                <? if ($login_fabrica == 153) { ?>
                                    <select id="acessorios_zero_hora" name="os[acessorios]" style="<?=$display_combo?>" class="span12">
                                        <option></option>
                                        <option value="completo" <?php if(getValue('os[acessorios]') == "completo") echo " selected " ?> ><?php echo traduz('completo');?></option>
                                        <option value="incompleto" <?php if(getValue('os[acessorios]') == "incompleto") echo " selected " ?>><?php echo traduz('incompleto');?></option>
                                    </select>
                                <? } ?>
                            </div>
                        </div>
                    </div>
                </div>

               <?php if ($login_fabrica == 164) { ?>
                    <div class="span2">
                        <div class='control-group <?=(in_array('os[data_compra]', $msg_erro['campos'])) ? "error" : "" ?>'>
                            <label class="control-label" for="data_compra"><?php echo traduz('data.compra');?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <? if ($regras["os|data_compra"]["obrigatorio"] == true) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                        } ?>
                                        <input id="data_compra" name="os[data_compra]" class="span12" type="text" value="<?=getValue('os[data_compra]')?>" />
                                    </div>
                                </div>
                        </div>
                    </div>
                <?php } ?> 

                <?php if ($login_fabrica == 175){ ?>
                    <div class="span4">
                        <div class='control-group <?=(in_array('os[consumidor_revenda]', $msg_erro['campos'])) ? "error" : "" ?>'>
                            <label class="control-label" for="consumidor_revenda">Tipo de OS</label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <h5 class="asteristico">*</h5>
                                    <?php
                                        if(getValue("os[consumidor_revenda]") == "R"){
                                            $selected_revenda = "SELECTED";
                                        }else{
                                            $selected_consumidor = "SELECTED";
                                        }
                                    ?>
                                    <select class="span12" id="os_consumidor_revenda" name="os[consumidor_revenda]" >
                                        <option value="C" <?=$selected_consumidor?>>Consumidor</option>
                                        <option value="R" <?=$selected_revenda?> >Revenda</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                <?php } ?>

                <?php if(in_array($login_fabrica, array(167,203))){ //HD-3428328 ?>
                    <div class="span3">
                        <div class="control-group <?=(in_array('os[os_contato]', $msg_erro['campos'])) ? "error" : "" ?>">
                            <label class="control-label" for="os_contato"><?php echo traduz('contato');?></label>
                            <div class="controls controls-row">
                                <? if ($regras["os|os_contato"]["obrigatorio"] == true ) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                } ?>
                                <div class="span12">
                                    <input id="os_contato" name="os[os_contato]" maxlength="20" class="span12" type="text" value="<?=getValue('os[os_contato]')?>"/>
                                </div>
                            </div>
                        </div>
                    </div>
                 <?php } ?>
                <div class="span1"></div>
            </div>
        <? }

        if ($postoInterno != true) {
            $display_posto_interno = "style='display: none;'";
        }

        if (in_array($login_fabrica, array(156))) {
        ?>
            <div class="row-fluid div_posto_interno" <?=$display_posto_interno?> >
                <div class="span1"></div>

                <div class="span6">
                    <div class="control-group <?=(in_array('os[natureza_operacao]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" ><?php echo traduz('natureza.de.operacao');?></label>
                        <div class="controls controls-row">
                            <h5 class='asteristico'>*</h5>
                            <div class="span12" >
                                <label class="radio inline">
                                    <input type="radio" name="os[natureza_operacao]" <?=(getValue("os[natureza_operacao]") == "Remessa p/ Conserto" or !getValue("os[natureza_operacao]")) ? "checked" : ""?> value="Remessa p/ Conserto" /> <?php echo traduz('remessa.p.cconserto');?>
                                </label>
                                <label class="radio inline">
                                    <input type="radio" name="os[natureza_operacao]" <?=(getValue("os[natureza_operacao]") == "Venda") ? "checked" : ""?> value="Venda" /> <?php echo traduz('venda');?>
                                </label>
                                <label class="radio inline">
                                    <input type="radio" name="os[natureza_operacao]" <?=(getValue("os[natureza_operacao]") == "Troca e Devolução") ? "checked" : ""?> value="Troca e Devolução" />  <?php echo traduz('troca.e.devolucao');?>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span4">
                    <div class="control-group <?=(in_array('os[tipo_produto]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" ><?php echo traduz('tipo.de.os');?></label>
                        <div class="controls controls-row">
                            <h5 class='asteristico'>*</h5>
                            <div class="span12" >
                                <label class="radio inline">
                                    <input type="radio" name="os[tipo_produto]" checked value="Produto" /> <?php echo traduz('produto');?>
                                </label>
                                <label class="radio inline">
                                    <input type="radio" name="os[tipo_produto]" <?=(getValue("os[tipo_produto]") == "Módulo") ? "checked" : ""?> value="Módulo" /> <?php echo traduz('modulo');?>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>

            <div class="row-fluid div_posto_interno" <?=$display_posto_interno?> >
                <div class="span1"></div>
                <div class="span3">
                    <div class="control-group <?=(in_array('os[nota_fiscal_mo]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="os_nota_fiscal_mo"> <?php echo traduz('nf.mo');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <input id="os_nota_fiscal_mo" name="os[nota_fiscal_mo]" class="span12" type="text" value="<?=getValue('os[nota_fiscal_mo]')?>" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="span3">
                    <div class="control-group <?=(in_array('os[data_nota_fiscal_mo]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="os_data_nota_fiscal_mo"><?php echo traduz('data.nf.mo');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <input id="os_data_nota_fiscal_mo" name="os[data_nota_fiscal_mo]" class="span12" type="text" value="<?=getValue('os[data_nota_fiscal_mo]')?>" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="span3">
                    <div class="control-group <?=(in_array('os[valor_nota_fiscal_mo]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="os_valor_nota_fiscal_mo"><?php echo traduz('valor.nf.mo');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <input id="os_valor_nota_fiscal_mo" name="os[valor_nota_fiscal_mo]" class="span12" type="text" value="<?=getValue('os[valor_nota_fiscal_mo]')?>" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row-fluid div_posto_interno" <?=$display_posto_interno?> >
                <div class="span1"></div>
                <div class="span3">
                    <div class="control-group <?=(in_array('os[nota_fiscal_peca]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="os_nota_fiscal_peca"><?php echo traduz('nf.peca');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <input id="os_nota_fiscal_peca" name="os[nota_fiscal_peca]" class="span12" type="text" value="<?=getValue('os[nota_fiscal_peca]')?>" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="span3">
                    <div class="control-group <?=(in_array('os[data_nota_fiscal_peca]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="os_data_nota_fiscal_peca"><?php echo traduz('data.nf.peca');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <input id="os_data_nota_fiscal_peca" name="os[data_nota_fiscal_peca]" class="span12" type="text" value="<?=getValue('os[data_nota_fiscal_peca]')?>" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="span3">
                    <div class="control-group <?=(in_array('os[valor_nota_fiscal_peca]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="os_valor_nota_fiscal_peca"><?php echo traduz('valor.nf.peca');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <input id="os_valor_nota_fiscal_peca" name="os[valor_nota_fiscal_peca]" class="span12" type="text" value="<?=getValue('os[valor_nota_fiscal_peca]')?>" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <? } ?>
        <div class="row-fluid div_tipoOs">
            <div class="span1"></div>
            <?
            if ($login_fabrica == 156) {
            ?>
                <div class="span3 div_posto_interno" <?=$display_posto_interno?> >
                    <div class="control-group <?=(in_array('os[os_elgin_status]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="os_elgin_status"><?php echo traduz('status');?></label>
                        <div class="controls controls-row">
                            <? if ($regras["os|os_elgin_status"]["obrigatorio"] == true) {
                                echo "<h5 class='asteristico'>*</h5>";
                            } ?>
                            <div class="span12">
                                <select id="os_elgin_status" name="os[os_elgin_status]" class="span12">
                                    <option></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='Em analise') ? "SELECTED" : "" ; ?> value='Em analise' ><?php echo traduz('em.analise');?></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='Pendência de documento') ? "SELECTED" : "" ; ?> value='Pendência de documento' ><?php echo traduz('pendencia.de.documento');?></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='Aguardando NF') ? "SELECTED" : "" ; ?> value='Aguardando NF' > <?php echo traduz('aguardando.nf');?></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='Equip. env. p/ dep.') ? "SELECTED" : "" ; ?> value='Equip. env. p/ dep.' > <?php echo traduz('equip.env.p/.dep');?></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='Emitir Orçamento') ? "SELECTED" : "" ; ?> value='Emitir Orçamento' > <?php echo traduz('emitir.orcamento');?></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='Manut. em Terceiro') ? "SELECTED" : "" ; ?> value='Manut. em Terceiro' > <?php echo traduz('manut.em.terceiro');?></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='NF Emitida') ? "SELECTED" : "" ; ?> value='NF Emitida' > <?php echo traduz('nf.emitida');?></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='OS Encerrada') ? "SELECTED" : "" ; ?> value='OS Encerrada' > <?php echo traduz('os.encerrada');?></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='Orçam. (Aprovação)') ? "SELECTED" : "" ; ?> value='Orçam. (Aprovação)' > <?php echo traduz('orcam.aprovacao');?></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='Orçam. Aprovado') ? "SELECTED" : "" ; ?> value='Orçam. Aprovado' > <?php echo traduz('orcam.aprovado');?></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='Aguardando Pecas') ? "SELECTED" : "" ; ?> value='Aguardando Pecas' > <?php echo traduz('aguardando.pecas');?></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='Troca, Ag. Analise ZPM') ? "SELECTED" : "" ; ?> value='Troca, Ag. Analise ZPM' > <?php echo traduz('troca.ag.analise.zpm');?></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='Ag. Anal. MFD ZPM') ? "SELECTED" : "" ; ?> value='Ag. Anal. MFD ZPM' > <?php echo traduz('ag.anal.mfd.zpm');?></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='Ingênico, Orç Reprovado') ? "SELECTED" : "" ; ?> value='Ingênico, Orç Reprovado' ><?php echo traduz('ingenico.orc.reprovado');?></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='Pend. p/ pç GECARE') ? "SELECTED" : "" ; ?> value='Pend. p/ pç GECARE' ><?php echo traduz('pend.p/.pc.gecare');?></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='Pend. p/ pç SECONT') ? "SELECTED" : "" ; ?> value='Pend. p/ pç SECONT' ><?php echo traduz('pend.p/.pc.secont');?></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='Pend. p/ pç ASSISTÊNCIA') ? "SELECTED" : "" ; ?> value='Pend. p/ pç ASSISTÊNCIA' ><?php echo traduz('pend.p/.pc.assistencia');?></option>
                                    <option <?= (getValue('os[os_elgin_status]')=='Em Solicitação') ? "SELECTED" : "" ; ?> value='Em Solicitação' ><?php echo traduz('em.solicitacao');?></option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            <?php
            }

            if (in_array($login_fabrica, [173,174]) && !verifica_tipo_posto("posto_interno", "TRUE", $login_posto)) {
                $styleDivTecnico = "style='display:none;'";
            }
            if (in_array($login_fabrica, array(158,165,173,174))) { ?>
                <div class="span4" id="div_tecnico" <?= $styleDivTecnico; ?>>
                    <div class='control-group <?= (in_array('os[id_tecnico]', $msg_erro['campos'])) ? "error" : ""; ?>'>
                        <label class="control-label" for="id_tecnico"><?php echo traduz('tecnico');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if ($login_fabrica == 158) { ?>
                                    <input type="hidden" id="os_consumidor_revenda" name="os[consumidor_revenda]" value="C" />
                                <? }
                                if ($regras["os|id_tecnico"]["obrigatorio"] == true) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                } ?>
                                <select id="id_tecnico" name="os[id_tecnico]">
                                    <option value=""></option>
                                    <? if (strlen(getValue('posto[id]')) > 0 || strlen($login_posto) > 0) {
                                        if (strlen(getValue('posto[id]')) > 0) {
                                            $xid_posto = getValue('posto[id]');
                                        } else if (strlen($login_posto) > 0) {
                                            $xid_posto = $login_posto;
                                        }

                                        $sqlTec = "
                                            SELECT
                                                tecnico,
                                                nome
                                            FROM tbl_tecnico
                                            WHERE fabrica = {$login_fabrica}
                                            AND posto = {$xid_posto}
                                            AND ativo IS TRUE
                                            ORDER BY nome;
                                        ";
                                        $resTec = pg_query($con, $sqlTec);
                                        $tecnicos = pg_fetch_all($resTec);

                                        foreach ($tecnicos as $tecnico) {
                                            $selectedTec = (getValue("os[id_tecnico]") == $tecnico['tecnico']) ? " SELECTED" : ""; ?>
                                            <option value="<?= $tecnico['tecnico']; ?>"<?= $selectedTec; ?>><?= $tecnico['nome']; ?></option>
                                        <? }
                                    } ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            <? }
            if (in_array($login_fabrica, array(184,191,200)) && verifica_tipo_posto("posto_interno", "TRUE", $login_posto)) { ?>
                <div class="span4" id="div_tecnico" <?= $styleDivTecnico; ?>>
                    <div class='control-group <?= (in_array('os[tecnico]', $msg_erro['campos'])) ? "error" : ""; ?>'>
                        <label class="control-label" for="tecnico"><?php echo traduz('tecnico');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?
                                if ($regras["os|tecnico"]["obrigatorio"] == true) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                } ?>
                                <select id="tecnico" name="os[tecnico]">
                                    <option value=""></option>
                                    <? if (strlen($login_posto) > 0) {
                                        $sqlTec = "
                                            SELECT
                                                tecnico,
                                                nome
                                            FROM tbl_tecnico
                                            WHERE fabrica = {$login_fabrica}
                                            AND posto = {$login_posto}
                                            AND ativo IS TRUE
                                            ORDER BY nome;
                                        ";
                                        $resTec = pg_query($con, $sqlTec);
                                        $tecnicos = pg_fetch_all($resTec);

                                        foreach ($tecnicos as $tecnico) {
                                            $selectedTec = (getValue("os[tecnico]") == $tecnico['tecnico']) ? " SELECTED" : ""; ?>
                                            <option value="<?= $tecnico['tecnico']; ?>"<?= $selectedTec; ?>><?= $tecnico['nome']; ?></option>
                                        <? }
                                    } ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            <? }
            if (!in_array($login_fabrica, array(35,158,161,175)) || ($login_fabrica == 35 && $areaAdmin == 1) ||  ($login_fabrica == 161  and getValue('produto[linha]') != 1126 ) ) { ?>
                <div class="span4 tipodeos"> 

                    <div class='control-group <?=(in_array('os[consumidor_revenda]', $msg_erro['campos'])) ? "error" : "" ?>'>
                        <label class="control-label" for="consumidor_revenda"><?=($login_fabrica == 156) ? traduz('tipo.de.cliente') : traduz('tipo.de.os');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <h5 class="asteristico">*</h5>
                                <?php
                                    if($login_fabrica == 156){
                                        if(getValue("os[consumidor_revenda]") == "C"){
                                            $selected_consumidor = "SELECTED";
                                        }else{
                                            $selected_revenda = "SELECTED";
                                        }
                                    }else{
                                        if ($login_fabrica == 186){
                                            if (getValue("os[consumidor_revenda]") == "C"){
                                                $selected_consumidor = "SELECTED";
                                            }else if (getValue("os[consumidor_revenda]") == "R"){
                                                $selected_revenda = "SELECTED"; 
                                            }else if(getValue("os[consumidor_revenda]") == "E"){
                                                $selected_mercado = "SELECTED";
                                            }
                                        }elseif ($login_fabrica == 178){
                                            if (getValue("os[consumidor_revenda]") == "A"){
                                                $selected_arquiteto = "SELECTED";
                                            }else if (getValue("os[consumidor_revenda]") == "S"){
                                                $selected_construtora = "SELECTED";
                                            }else if (getValue("os[consumidor_revenda]") == "C"){
                                                $selected_consumidor = "SELECTED";
                                            }else if (getValue("os[consumidor_revenda]") == "E"){
                                                $selected_equipe_comercial = "SELECTED"; 
                                            }else if (getValue("os[consumidor_revenda]") == "I"){
                                                $selected_instalador = "SELECTED";
                                            }else if (getValue("os[consumidor_revenda]") == "P"){
                                                $selected_posto_autorizado = "SELECTED";
                                            }else if(getValue("os[consumidor_revenda]") == "R"){
                                                $selected_revenda = "SELECTED";
                                            }
                                        }else{
                                            if(getValue("os[consumidor_revenda]") == "R"){
                                                $selected_revenda = "SELECTED";
                                            }else{
                                                $selected_consumidor = "SELECTED";
                                            }
                                        }
                                    }

                                ?>
                                <select class="span12" id="os_consumidor_revenda" name="os[consumidor_revenda]" >

                                    <?php if (!in_array($login_fabrica, [178,186])){ ?>
                                        <option value="C" <?=$selected_consumidor?>><?= traduz('Consumidor') ?></option>
                                        <?php if(in_array($login_fabrica, array(157))){ ?>
                                            <?php if(isset($_GET["os_id"]) || strlen($os) > 0){ ?>
                                            <option value="R" <?=$selected_revenda?> ><?php echo traduz('revenda');?></option>
                                            <?php } ?>
                                        <?php }else{ 
                                            if ($login_fabrica != 138 && (!in_array($login_fabrica, [169,170]) || (in_array($login_fabrica, [169,170]) && ($digita_os_revenda == "t" || $areaAdmin)))) { 
                                                ?>
                                                <option value="R" <?=$selected_revenda?> ><?php echo traduz('revenda');?></option>
                                        <?php } 
                                        }
                                        ?>
                                    <?php } ?>
                                   <?php if (in_array($login_fabrica, [186])){ ?>
                                        <option value="C" <?=$selected_consumidor?>><?= traduz('Consumidor'); ?></option>
                                        <option value="R" <?=$selected_revenda?> ><?php echo traduz('Revenda');?></option>
                                        <option value="E" <?=$selected_mercado?> ><?php echo traduz('Mercado Especializado');?></option>
                                    <?php } ?>
                                    <?php if ($login_fabrica == 178){ ?>
                                            <!-- <option value="A" <?=$selected_arquiteto?> >Arquiteto/Engenheiro</option> -->
                                            <option value="S" <?=$selected_construtora?> >Construtora</option>
                                            <option value="C" <?=$selected_consumidor?> >Consumidor</option>
                                            <!-- <option value="E" <?=$selected_equipe_comercial?> >Equipe Comercial</option>
                                            <option value="I" <?=$selected_instalador?> >Instalador</option>
                                            <option value="P" <?=$selected_posto_autorizado?> >Posto Autorizado</option> -->
                                            <option value="R" <?=$selected_revenda?> >Revenda</option>
                                    <?php } ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <?php
                if($login_fabrica == 191 && !$postoInterno){
                ?>
                    <div class="span3">
                        <div class='control-group <?=(in_array('os[solicita_km]', $msg_erro['campos'])) ? "error" : "" ?>'>
                            <div class="controls controls-row">
                                <br>
                                <div class="span12">
                                    
                                        <input type="checkbox" name="os[solicita_km]" id="solicita_km" value="t" onclick="habilitaMapa()" <?= (getValue('os[qtde_km]') > 0 OR getValue('os[solicita_km]') == "t") ? "checked" : ""; ?> /> 
                                        <label class="control-label" for="os_os_posto"><?php echo traduz('solicitar.deslocamento');?></label>
                                </div>
                            </div>
                        </div>
                    </div>
               
                <?php
                }
                ?>

                <? 
                if (in_array($login_fabrica, [144]) && $postoInterno) { ?>

                    <div class="span4">
                        <div class='control-group <?=(in_array('os[os_posto]', $msg_erro['campos'])) ? "error" : "" ?>'>
                            <label class="control-label" for="os_os_posto">Número Único</label>
                            <div class="controls controls-row">
                                <div class="span9">
                                <h5 class="asteristico">*</h5>
                                <input id="os_os_posto" name="os[os_posto]" maxlength="20" class="span12" type="text" value="<?=getValue('os[os_posto]')?>" />
                                </div>
                            </div>
                        </div>
                    </div>

                <?php
                }

                if ($login_fabrica == 164) {
                    $display_box_destinacao = ($postoInterno != true || $areaAdmin == true) ? "style='display: none;'" : "style='display: block;'"; ?>

                    <div class="span4 box_destinacao" <?php echo $display_box_destinacao; ?>>
                        <div class='control-group <?=(in_array('os[destinacao]', $msg_erro['campos'])) ? "error" : "" ?>'>
                            <label class="control-label" for="destinacao"><?php echo traduz('destinacao');?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <select class="span12" id="destinacao" name="os[destinacao]" >
                                        <option value=""></option>
                                        <?php
                                            $sql_destinacao = "SELECT segmento_atuacao, descricao FROM tbl_segmento_atuacao WHERE fabrica = {$login_fabrica} AND ativo = true";
                                            $res_destinacao = pg_query($con, $sql_destinacao);

                                            if(pg_num_rows($res_destinacao) > 0){

                                                for($i = 0; $i < pg_num_rows($res_destinacao); $i++){

                                                    $segmento_atuacao  = pg_fetch_result($res_destinacao, $i, "segmento_atuacao");
                                                    $descricao_atuacao = pg_fetch_result($res_destinacao, $i, "descricao");
                                                    $selected = (getValue("os[destinacao]") == $segmento_atuacao) ? "selected" : "";

                                                    if($login_posto <> 113070) { 
                                                        echo "<option value='{$segmento_atuacao}' {$selected} > {$descricao_atuacao} </option>";
                                                    } else {
                                                        if($segmento_atuacao <> 10) {
                                                            echo "<option value='{$segmento_atuacao}' {$selected} > {$descricao_atuacao} </option>";
                                                        }
                                                    }                                                  

                                                }

                                            }
                                        ?>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                <? }

                if(in_array($login_fabrica, [177])) {
                ?>
                    <div class="span3" id="orcamento_status" style="display: none;">
                        <div class='control-group <?=(in_array('os[orcamento_status]', $msg_erro['campos'])) ? "error" : "" ?>'>
                            <label class="control-label" for="orcamento_status">Status Orçamento</label>
                            <div class="controls controls-row">
                                <div >
                                    <h5 class="asteristico">*</h5>
                                    <select class="span12" name="os[orcamento_status]">
                                        <option value=""></option>
                                            <?php
                                            $status_orcamento = array(
                                                "Aguardando Análise" => "Aguardando Análise",
                                                "Distribuição" => "Distribuição",
                                                "Em analise" => "Em Analise",
                                                "Orçam. (Aprovação)" => "Orçam. (Aprovação)",
                                                "Aguardando Pecas" => "Aguardando Peças",
                                                "Em reparo" => "Em reparo",
                                                "Reparado" => "Reparado",
                                                "Orçamento Reprovado" => "Orçamento Reprovado",
                                                "OS Encerrada" => "OS Encerrada"
                                            );

                                            foreach ($status_orcamento as $desc_orcamento => $value ) {
                                                if($_RESULT["os"]["orcamento_status"] == $desc_orcamento OR $_REQUEST["os"]["orcamento_status"] == $desc_orcamento){
                                                    $selectedTec = "SELECTED";
                                                }else{
                                                    $selectedTec = "";
                                                }

                                                    #$selectedTec = ($_RESULT["os"]["status_orcamento"] == $desc_orcamento) ? " SELECTED" : "";
                                                    #print_r($desc_orcamento);exit;
                                            ?>
                                                    <option value="<?=$desc_orcamento;?>" <?=$selectedTec?> > <?=$value;?> </option>
                                            <?php
                                            }
                                            ?>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                <?php 
                }

                if ($login_fabrica == 178){
                    $instalacao_publica = $_RESULT["os"]["instalacao_publica"];
                    
                    if (empty($instalacao_publica) AND empty($_RESULT['sua_os'])){
                        $instalacao_publica = "f";
                    }

                ?>
                    <div class="span2 box_instalacao_publica" >
                        <div class="control-group <?=(in_array("produto_{$p}", $msg_erro['campos'])) ? "error" : "" ?>">
                            <label class="control-label" for="instalacao_publica"><?php echo traduz("instalacao.publica");?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <select name="os[instalacao_publica]" id="instalacao_publica" class="span12 instalacao_publica">
                                        <?php

                                            $array_tipo_instalacao = array(
                                                "t" => "Sim",
                                                "f" => "Não",
                                            );

                                            foreach ($array_tipo_instalacao as $valor => $descricao) {
                                                $selected_tipos_os = ( isset($instalacao_publica) and ($instalacao_publica == $valor) ) ? "SELECTED" : '' ;
                                        ?>
                                                <option <?=$selected_tipos_os?> value="<?=$valor?>"><?=$descricao?></option>
                                        <?php
                                            }
                                        ?>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                <?php
                }
            }

            if (in_array($login_fabrica, array(148))) {

                $displayDataFalha = "display: none;";

                if (!empty(getValue("os[tipo_atendimento]"))) {

                    $sqlTipoGarantia = "SELECT tipo_atendimento
                                        FROM tbl_tipo_atendimento
                                        WHERE fora_garantia IS NOT TRUE
                                        AND tipo_atendimento = ".getValue("os[tipo_atendimento]");
                    $resTipoGarantia = pg_query($con, $sqlTipoGarantia);

                    if (pg_num_rows($resTipoGarantia) > 0) {

                        $displayDataFalha = "";

                    }

                } ?>
                <div class="span2 div-data-falha" style="<?= $displayDataFalha ?>">
                    <div class='control-group <?=(in_array('os[data_falha]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="data_falha">
                            <?= traduz('Data Falha') ?>
                        </label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <h5 class='asteristico'>*</h5>
                                <input id="data_falha" name="os[data_falha]" class="span12" type="text" autocomplete="off" value="<?=getValue('os[data_falha]')?>" />
                            </div>
                        </div>
                    </div>
                </div>
            <?php
            }

            if (in_array($login_fabrica,array(35,151,157,158))) {

                if ($login_fabrica == 151) {
                    $desc_os_posto = traduz('posto');
                } else if ($login_fabrica == 158) {
                    $desc_os_posto = traduz('Cliente');
                } else {
                    $desc_os_posto = traduz('interna');
                } ?>

                <div class="span4">
                    <div class="control-group">
                        <label class="control-label" for="os_os_posto"><?php echo traduz('os');?> <?= $desc_os_posto; ?></label>
                        <div class="controls controls-row">
                            <div class="span9">
                            <input id="os_os_posto" name="os[os_posto]" maxlength="20" class="span12" type="text" value="<?=getValue('os[os_posto]')?>" <?= ($login_fabrica == 158) ? "readonly" : ""; ?>/>
                            </div>
                        </div>
                    </div>
                </div>
            <?php
            }
            if (in_array($login_fabrica,array(167,186,190,191,195,203))) {
            ?>
                <div class="span3" id="status_orcamento" <?=$display_orcamento?> >
                    <div class='control-group <?=(in_array('os[status_orcamento]', $msg_erro['campos'])) ? "error" : "" ?>'>
                        <label class="control-label" for="status_orcamento"><?php echo traduz('status.orcamento');?></label>
                        <div class="controls controls-row">
                            <div >
                                <h5 class="asteristico">*</h5>
                                <select class="span12" name="os[status_orcamento]">
                                    <option value=""></option>
                                <?php
                                    if (in_array($login_fabrica,array(186,190))) {
                                        $status_orcamento = array(
                                            "Em analise"               => "Em Análise",
                                            "Aguardando Aprovação"  => "Aguardando Aprovação",
                                            "Aguardando Pagamento"  => "Aguardando Pagamento",
                                            "Aguardando Conserto"   => "Aguardando Conserto",
                                            "Aguardando Retirada"   => "Aguardando Retirada",
                                            "Pagamento Confirmado"  => "Pagamento Confirmado",
                                            "Finalizado"            => "Finalizado",
                                            "Orçamento Reprovado"   => "Orçamento Reprovado",
                                        );
                                    } else if(in_array($login_fabrica,array(191,195))){
                                        $status_orcamento = array(
                                            "Aguardando Orçamento"  => "Aguardando Orçamento",
                                            "Aguardando Aprovação"  => "Aguardando Aprovação",
                                            "Aguardando Pagamento"  => "Aguardando Pagamento",
                                            "Aguardando Conserto"   => "Aguardando Conserto",
                                            "Aguardando Retirada"   => "Aguardando Retirada",
                                            "Pagamento Confirmado"  => "Pagamento Confirmado",
                                            "Finalizado"            => "Finalizado",
                                            "Orçamento Reprovado"   => "Orçamento Reprovado",
                                            "Aguardando NF"         => "Aguardando NF Retorno",
                                        );
                                    }else {

                                        $status_orcamento = array(
                                            "Aguardando Análise" => "Aguardando Análise",
                                            "Distribuição" => "Distribuição",
                                            "Em analise" => "Em Analise",
                                            "Orçam. (Aprovação)" => "Orçam. (Aprovação)",
                                            "Aguardando Peças" => "Aguardando Peças",
                                            "Em reparo" => "Em reparo",
                                            "Reparado" => "Reparado",
                                            "Orçamento Reprovado" => "Orçamento Reprovado",
                                            "OS Encerrada" => "OS Encerrada"
                                        );
                                    }
                                    foreach ($status_orcamento as $desc_orcamento => $value ) {

                                        if(strtolower($_RESULT["os"]["status_orcamento"]) == strtolower($desc_orcamento) OR strtolower($_REQUEST["os"]["status_orcamento"]) == strtolower($desc_orcamento)){
                                            $selectedTec = "SELECTED";
                                        }else{
                                            $selectedTec = "";
                                        }

                                        #$selectedTec = ($_RESULT["os"]["status_orcamento"] == $desc_orcamento) ? " SELECTED" : "";
                                ?>
                                        <option value="<?=$desc_orcamento;?>" <?=$selectedTec?> > <?=$value;?> </option>
                                <?php
                                    }
                                ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

            <?php } ?>
            <div class="span1"></div>
        </div>
    <?php
	if ($login_fabrica == 35 and !$areaAdmin and !empty($_REQUEST['os_id'])) {
		$os_id_param = (int) $_REQUEST['os_id'];

		$sql_cons_rev = "SELECT consumidor_revenda FROM tbl_os WHERE os = $os_id_param";
		$res_cons_rev = pg_query($con, $sql_cons_rev);

		echo '<input type="hidden" name="os[consumidor_revenda]" value="' . pg_fetch_result($res_cons_rev, 0, 'consumidor_revenda') . '">';
	}
	?>
        <? if (in_array($login_fabrica, array(142,156,169,170))) { ?>
            <div class="row-fluid" id="div_visita">
                <div class="span1"></div>
                <div class="span2">
                    <label class="control-label" for="visitas"><?php echo traduz('visitas');?></label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <input type="number" class="span4" name="os[qtde_visita]" value="<?=getValue('os[qtde_visita]')?>" min="0" max="2" onchange="if (this.value > 2) this.value = 2;" />
                        </div>
                    </div>
                </div>
                <? if (in_array($login_fabrica, array(169,170))) { ?>
                    <div class="span6">
                        <label class="control-label" for="motivo_visita"><?php echo traduz('motivo.da.s.visita.s');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <input type="text" class="span12" name="os[motivo_visita]" value="<?=getValue('os[motivo_visita]')?>" />
                            </div>
                        </div>
                    </div>
                <? } ?>
                <div class="span1"></div>
            </div>
        <? }
        if (in_array($login_fabrica, array(138))) { ?>
            <div id="div_os_garantia" class="row-fluid" <?=$mostra_os_garantia?> >
                <div class="span1"></div>
                <div class="span10">
                    <div class='control-group <?=(in_array('os[garantia]', $msg_erro['campos'])) ? "error" : "" ?>'>
                        <label class="control-label" for="garantia"><?php echo traduz('essa.ordem.de.servico.atende.aos.requisitos.de.garantia');?>?</label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <h5 class='asteristico'>*</h5>
                                <? if (!isset($os)) { ?>
                                    <label class="radio inline">
                                        <input type="radio" name="os[garantia]" value="t" <? if (getValue("os[garantia]") == "t") echo "checked"; ?> /> <?php echo traduz('sim');?>
                                    </label>
                                    <label class="radio inline">
                                        <input type="radio" name="os[garantia]" value="f" <? if (getValue("os[garantia]") == "f") echo "checked"; ?> /> <?php echo traduz('nao');?>
                                    </label>
                                <? } else { ?>
                                    <input type="hidden" name="os[garantia]" value="<?=getValue("os[garantia]")?>" />
                                    <?=(getValue("os[garantia]") == "t") ? "<span class='label label-success'>".traduz('sim')."</span>" : "<span class='label label-important'>".traduz('nao')."</span>"?>
                                <? }

                                if (getValue("os[garantia]") == "f" && isset($mostra_os_garantia)) {
                                    $mostra_produto_pecas = "display: none;";
                                    $mostra_subproduto_pecas = "style='display: none;'";
                                } ?>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span1"></div>
            </div>
        <?php }
        if (in_array($login_fabrica, $os_cortesia) && $areaAdmin === true) { ?>
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10 checkbox">
                    <input type="checkbox" name="os[cortesia]" value="t" <?= (getValue('os[cortesia]') == "t") ? "checked" : ""; ?> /> <?php echo traduz('os.de.cortesia');?>
                </div>
                <div class="span1"></div>
            </div>
        <?php } else {
            if (in_array($login_fabrica, array(169,170))) { ?>
                <input type="hidden" name="os[cortesia]" value="<?=(getValue('os[cortesia]'))?>" />
        <?php }
        }
        if ($login_fabrica == 174) { ?>
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span2">
                    <label class="control-label" for="valor_nf"><?php echo traduz('Valor da NF');?></label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <input type="text" class="span12" name="os[valor_nf]" id="valor_nf" value="<?=getValue('os[valor_nf]')?>"/>
                        </div>
                    </div>
                </div>
                <div class="span1"></div>
            </div>
        <?php } ?>
    </div>
    <br />
    <?php
    $mensagemConsumidor = "";
    if ($login_fabrica == 143) {
        $readonly = "readonly";
    }
    if ($login_fabrica == 161) {
        $mensagemConsumidor = "(".traduz('preencher.conforme.nf.do.cliente').")";
    }   ?>
    <div id="div_informacoes_consumidor" class="tc_formulario">
        <div class="titulo_tabela"><?php echo ($login_fabrica == 178)? traduz('informacoes.do.cliente') : traduz('informacoes.do.consumidor');?> <?= $mensagemConsumidor; ?></div>

        <br />
        <?php
        if($login_fabrica == 151){?>
            <span class="label label-important"><?php echo traduz('e.obrigatorio.informar.telefone.ou.celular');?> </span> <br /> <br />
        <?php
        }
        if ($login_fabrica == 165 && $posto_interno == 't') {
            $style = (getValue('consumidor[cnpjCpf]') == "cpf") ? 'display:block"': 'display:none';
            ?>
            <span class="label label-important label-cpf" style="<?=$style?>"> <?php echo traduz('e.obrigatorio.o.anexo.de.declaracao.de.pessoa.fisica');?></span><br /> <br />
        <?php
        } ?>

        <div class="row-fluid">

            <div class="span1"></div>
            <?php if ($login_fabrica == 157) { ?>
                    <div class="span3 cidade_nacional">
                        <div class='control-group <?=(in_array('consumidor[cpf]', $msg_erro['campos'])) ? "error" : "" ?>' >
                            <label class="control-label" for="consumidor_cpf">
                                <?php if (strlen($os)) {
                                    echo traduz('cpf/cnpj');?>
                                <?php } else { ?>
                                    <?php echo traduz('cpf');?> <input type="radio" id="cpf_cnpj" name="consumidor[cnpjCpf]" <?= (getValue('consumidor[cnpjCpf]') == "cpf") ? 'checked="checked"': ''; ?> value="cpf" />
                                    /<?php echo traduz('cnpj');?> <input type="radio" id="cnpj_cpf" name="consumidor[cnpjCpf]" <?= (getValue('consumidor[cnpjCpf]') == "cnpj") ? 'checked="checked"': ''; ?> value="cnpj" />
                                <?php } ?>

                            </label>
                            <div class="controls controls-row">
                                <div class="span12 input-append">
                                    <? if ($regras["consumidor|cpf"]["obrigatorio"] == true && $os_revenda === false) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    } var_dump($cpfConsumidor); ?>
                                    <input id="consumidor_cpf" name="consumidor[cpf]" class="<?= (in_array($login_fabrica, array(158,175))) ? 'span10' : 'span12'; ?>" type="text" data-obrigatorio="<?=$regras["consumidor|cpf"]["obrigatorio"]?>" style="max-width: 171px;" value="<?=$cpfConsumidor?>" <?=$readonly?> />
                                    <span class="add-on" rel="lupa" >
                                        <i class="icon-search"></i>
                                    </span>
                                    <input type="hidden" name="lupa_config" tipo="consumidor_os" parametro="cpf_cnpj" />
                                </div>
                            </div>
                        </div>
                    </div>
                  
                    <div class="span3">
                        <div class='control-group <?=(in_array('consumidor[nome]', $msg_erro['campos'])) ? "error" : "" ?>' >
                            <label class="control-label" for="consumidor_nome"><?php echo traduz('nome');?></label>
                            <div class="controls controls-row">
                                <div class="span12 input-append">
                                    <?php
                                        if ($regras["consumidor|nome"]["obrigatorio"] == true && $os_revenda === false) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                        }
                                    ?>
                                    <input id="consumidor_nome" name="consumidor[nome]" class="<?= (in_array($login_fabrica, array(158,175))) ? 'span10' : 'span12'; ?>" type="text" data-obrigatorio="<?=$regras["consumidor|nome"]["obrigatorio"]?>" value="<?=getValue('consumidor[nome]')?>" <?=$readonly?> maxlength="50" />
                                    <? if (in_array($login_fabrica, array(158,175))) { ?>
                                    <span class="add-on" rel="lupa" >
                                        <i class="icon-search"></i>
                                    </span>
                                    <input type="hidden" name="lupa_config" tipo="consumidor_os" parametro="nome_consumidor" />
                                    <? } ?>
                                </div>
                            </div>
                        </div>
                    </div>
            <?php } else { ?>
                    <div class="span3">
                        <div class='control-group <?=(in_array('consumidor[nome]', $msg_erro['campos'])) ? "error" : "" ?>' >
                            <label class="control-label" for="consumidor_nome"><?php echo traduz('nome');?></label>
                            <div class="controls controls-row">
                                <div class="span12 input-append">
                                    <?php
                                        if ($regras["consumidor|nome"]["obrigatorio"] == true && $os_revenda === false) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                        }
                                    ?>
                                    <input id="consumidor_nome" name="consumidor[nome]" class="<?= (in_array($login_fabrica, array(158,175))) ? 'span10' : 'span12'; ?>" type="text" data-obrigatorio="<?=$regras["consumidor|nome"]["obrigatorio"]?>" value="<?=getValue('consumidor[nome]')?>" <?=$readonly?> maxlength="50" />
                                    <? if (in_array($login_fabrica, array(158,175))) { ?>
                                    <span class="add-on" rel="lupa" >
                                        <i class="icon-search"></i>
                                    </span>
                                    <input type="hidden" name="lupa_config" tipo="consumidor_os" parametro="nome_consumidor" />
                                    <? } ?>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="span3 cidade_nacional">
                        <div class='control-group <?=(in_array('consumidor[cpf]', $msg_erro['campos'])) ? "error" : "" ?>' >
                            <label class="control-label" for="consumidor_cpf">
                                <?php if ($cook_idioma == 'pt-br' or $areaAdmin) {
                                    if (!in_array($login_fabrica, array(35))) {
                                        if (strlen($os) && !in_array($login_fabrica, [131])) { ?>
                                            <?php echo traduz('cpf/cnpj');?>
                                        <? } else { ?>
                                            <?php echo traduz('cpf');?> 
                                            <input 
                                            type="radio" 
                                            id="cpf_cnpj" 
                                            name="consumidor[cnpjCpf]" 
                                            <?= (getValue('consumidor[cnpjCpf]') == "cpf") || ($login_fabrica == 177 && getValue('consumidor[cnpjCpf]') == "") ? 'checked="checked"': ''; ?> 
                                            value="cpf" />
                                            /<?php echo traduz('cnpj');?> <input type="radio" id="cnpj_cpf" name="consumidor[cnpjCpf]" <?= (getValue('consumidor[cnpjCpf]') == "cnpj") ? 'checked="checked"': ''; ?> value="cnpj" />
                                        <? } 
                                    } else { ?>
                                        <?php echo traduz('cpf');?>
                                    <?php
                                    }
                                } else {
                                     echo traduz('cpf')." / ".traduz('cnpj');
                                }
                                ?>
                            </label>
                            <div class="controls controls-row">
                                <div class="span12 input-append">
                                    <? if ($regras["consumidor|cpf"]["obrigatorio"] == true && $os_revenda === false) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    } ?>
                                    <input maxlength="14" id="consumidor_cpf" name="consumidor[cpf]" class="<?= (in_array($login_fabrica, array(158,175))) ? 'span10' : 'span12'; ?>" type="text" data-obrigatorio="<?=$regras["consumidor|cpf"]["obrigatorio"]?>" value="<?=$cpfConsumidor?>" <?=$readonly?> />
                                    <? if (in_array($login_fabrica, array(158,175))) { ?>
                                        <span class="add-on" rel="lupa" >
                                            <i class="icon-search"></i>
                                        </span>
                                        <input type="hidden" name="lupa_config" tipo="consumidor_os" parametro="cpf_cnpj" />
                                    <? } ?>
                                </div>
                            </div>
                        </div>
                    </div>
            <?php }

            if ($login_fabrica == 178 AND strlen($_RESULT["consumidor"]["inscricao_estadual"]) > 0 ){ 
                $display_estado_roca = "display: none;"; ?>
            <div class="span2 inscricao_estadual">
                <div class='control-group <?=(in_array('consumidor[inscricao_estadual]', $msg_erro['campos'])) ? "error" : "" ?>' >
                    <label class="control-label" for="inscricao_estadual"><?php echo traduz('inscricao_estadual');?></label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <? if ($regras["consumidor|inscricao_estadual"]["obrigatorio"] == true && $os_revenda === false) {
                                echo "<h5 class='asteristico'>*</h5>";
                            } ?>
                            <input id="inscricao_estadual" name="consumidor[inscricao_estadual]" class="span12" type="text" data-obrigatorio="<?=$regras["consumidor|inscricao_estadual"]["obrigatorio"]?>" value="<?=getValue('consumidor[inscricao_estadual]')?>" <?=$readonly?> />
                        </div>
                    </div>
                </div>
            </div>
            <?php }
            if ($login_fabrica == 52) { /* HD - 6201206 */ ?>
                <script>
                    $(function() {
                        $("#consumidor_cep").blur( function() {
                            var tamanho_cep = $(this).length;

                            if (tamanho_cep > 0) {
                                $("#consumidor_pais").val("BR");
                            }
                        });
                    })
                </script>
            <?php } ?>

            <div class="span2 cidade_nacional">
                <div class='control-group <?=(in_array('consumidor[cep]', $msg_erro['campos'])) ? "error" : "" ?>' >
                    <label class="control-label" for="consumidor_cep"><?php echo traduz('cep');?></label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <? if ($regras["consumidor|cep"]["obrigatorio"] == true && $os_revenda === false) {
                                echo "<h5 class='asteristico' id='asteristico'>*</h5>";
                            } ?>
                            <input id="consumidor_cep" name="consumidor[cep]" class="span12" type="text" data-obrigatorio="<?=$regras["consumidor|cep"]["obrigatorio"]?>" value="<?=getValue('consumidor[cep]')?>" <?=$readonly?> />
                        </div>
                    </div>
                </div>
            </div>

            <div class="span2 cidade_nacional" style="<?= $display_estado_cidade ?> <?=$display_estado_roca?>">
                <div class="control-group <?=(in_array('consumidor[estado]', $msg_erro['campos'])) ? "error" : "" ?>">
                    <label class="control-label" for="consumidor_estado"><?php echo traduz('estado'); echo $getpaisposto; ?></label>                    
                    <div class="controls controls-row">
			<div class="span12">
                            <?php if ($regras["consumidor|estado"]["obrigatorio"] == true && $os_revenda === false) {
                                echo "<h5 class='asteristico'>*</h5>";
                            }

                            $consumidor_estado = getValue('consumidor[estado]');

                            if ($login_fabrica == 143) {
                                foreach ($arrayEstados as $s => $ne) {
                                    if ($s == $consumidor_estado) {
                                        $sigla = $s;
                                        $nome_estado = $ne;
                                    }
                                } ?>
                                <input type="text" id="j_consumidor_estado" name="consumidor[estado]" class="span12" value="<?=$sigla?>" <?=$readonly?> data-obrigatorio="<?=$regras["consumidor|estado"]["obrigatorio"]?>" />
			    <?php } else {
                                $listaDeEstadosDoPais = getListaDeEstadosDoPais($paisOs); 

				if (!empty($listaDeEstadosDoPais) || in_array($login_fabrica, [180,181,182])) {
				    $tmpHtml = "<option value=''> </option>";
				    foreach ($listaDeEstadosDoPais as $estado) {
					if ($consumidor_estado == $estado['sigla']) {
					    $selected = "selected";
					} else {
					    $selected = "";
					}

					$tmpHtml .= "<option value='{$estado['sigla']}' {$selected}> {$estado['descricao']}  </option>";
				    }

                                    echo "<select style='display: block;' id='consumidor_estado' name='consumidor[estado]' class='span12' data-obrigatorio='{$regras['consumidor|estado']['obrigatorio']}'>{$tmpHtml}</select>";

                                    
                                    //echo "<input type='text' id='t_consumidor_estado' name='consumidor[estado]' class='span12' data-obrigatorio='". $regras['consumidor|estado']['obrigatorio']. "' style='display: none;' disabled value='". utf8_decode($campos_adicionais['consumidor']['estado']). "'/>";
                                    
                                } else {                                        
                                    echo "<input type='text' id='consumidor_estado' name='consumidor[estado]' class='span12' data-obrigatorio='". $regras['consumidor|estado']['obrigatorio']. "' value='".utf8_decode($campos_adicionais['consumidor']['estado']) . "'/>";
                                }
			    } ?>
                        </div>
                    </div>
                </div>
            </div>
            <?php
            if (in_array($login_fabrica, [148])) { ?>
                <div class="span2 cidade_exterior" hidden>
                     <div class="control-group <?=(in_array('consumidor[estado]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="consumidor_estado"><?php echo traduz('estado');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <input type="text" class="form-control" name="consumidor[estado_ex]" id="consumidor_estado_exterior" readonly />
                            </div>
                        </div>
                    </div>
                </div>
            <?php
            }
            ?>
        </div>

        <div class="row-fluid">
            <div class="span1"></div>
            <?php if ($login_fabrica == 178 AND strlen($_RESULT["consumidor"]["inscricao_estadual"]) > 0 ) { ?>
                <div class="span2 cidade_nacional">
                    <div class="control-group <?=(in_array('consumidor[estado]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="consumidor_estado"><?php echo traduz('estado');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?php
                                if ($regras["consumidor|estado"]["obrigatorio"] == true && $os_revenda === false) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                }

                                $consumidor_estado = getValue('consumidor[estado]');

								$listaDeEstadosDoPais = getListaDeEstadosDoPais($paisOs); 
									
								if (!empty($listaDeEstadosDoPais)) {
									$tmpHtml = "<option value=''> </option>";
									foreach ($listaDeEstadosDoPais as $estado) {

										if ($consumidor_estado == $estado['sigla']) {
											$selected = "selected";
										}else{
											$selected = "";
										}

									$tmpHtml .= "<option value='{$estado['sigla']}' {$selected}> {$estado['descricao']}  </option>";
								}

								echo "<select style='display: block;' id='consumidor_estado' name='consumidor[estado]' class='span12' data-obrigatorio='{$regras['consumidor|estado']['obrigatorio']}'>{$tmpHtml}</select>";
								}?>
                            </div>
                        </div>
                    </div>
                </div>
            <?php } ?>
            <div class="<?=($login_fabrica == 178 AND strlen($_RESULT["consumidor"]["inscricao_estadual"]) > 0) ? "span2" : "span3" ?> cidade_nacional" style="<?= $display_estado_cidade ?>">
                <div class="control-group <?=(in_array('consumidor[cidade]', $msg_erro['campos'])) ? "error" : "" ?>">
                    <label class="control-label" for="consumidor_cidade"><?php echo traduz('cidade');?></label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <?php if ($regras["consumidor|cidade"]["obrigatorio"] == true && $os_revenda === false) {
                                echo "<h5 class='asteristico'>*</h5>";
                            }

                            if($login_fabrica == 143) {
                                if (strlen($consumidor_estado) > 0) {
                                    $sql = "SELECT DISTINCT * FROM (
                                                SELECT UPPER(fn_retira_especiais(nome)) AS cidade FROM tbl_cidade WHERE UPPER(estado) = UPPER('".$consumidor_estado."')
                                                UNION (
                                                    SELECT UPPER(fn_retira_especiais(cidade)) AS cidade FROM tbl_ibge WHERE UPPER(estado) = UPPER('".$consumidor_estado."')
                                                )
                                            ) AS cidade
                                            ORDER BY cidade ASC";
                                    $res = pg_query($con, $sql);

                                    if (pg_num_rows($res) > 0) {
                                        $consumidor_cidade = getValue('consumidor[cidade]');

                                        while ($result = pg_fetch_object($res)) {
                                            if(trim($result->cidade) == trim($consumidor_cidade)){
                                                $cidade = $result->cidade;
                                            }
                                        }
                                    }
                                } ?>
                                <input type="text" id="consumidor_cidade" name="consumidor[cidade]" class="span12" value="<?=$cidade?>" <?=$readonly?> data-obrigatorio="<?=$regras["consumidor|cidade"]["obrigatorio"]?>" />
                            <?php } else {
			    	$consumidor_cidade = getValue('consumidor[cidade]');
				$html = '';
    				if (!empty($paisOs)) {
				    $displaySelCid = "style='display: none;'";
				    $displayInpCid = "style='display: block;'";
    				    $tmpHtml = "<option value=''>".traduz(Selecione)."</option>";
				    if (!empty($consumidor_estado)) {
    				    	$listaDeCidadesDoEstado = getCidadesDoEstado($paisOs, $consumidor_estado);
    				    	if (count($listaDeCidadesDoEstado) > 0) {
    					    foreach($listaDeCidadesDoEstado as $cidade){
                                            	if(strlen($cidade["cidade"]) > 0){
        					    $isSelecionada = ($cidade['cidade'] === $consumidor_cidade) ? 'selected' : null;
        					    $tmpHtml .= "<option value='{$cidade['cidade']}' {$isSelecionada}> {$cidade['cidade']} </option>";	
                                            	}
    					    }
					    $displaySelCid = "style='display: block;'";
	                                    $displayInpCid = "style='display: none;'";
					}
                        }
                                    echo "<select id='consumidor_cidade' name='consumidor[cidade]' class='span12' ". $disabled. "data-obrigatorio='". $regras["consumidor|cidade"]["obrigatorio"]. "'>". $tmpHtml. "</select>";
                                    //echo "<input {$displayInpCid} type='text' id='t_consumidor_cidade' name='consumidor[cidade]' class='span12' ". $disabled. "data-obrigatorio='". $regras["consumidor|cidade"]["obrigatorio"]. "' disabled value='". $consumidor_cidade. "'/>";
                                } else {
                                    echo "<input type='text' id='consumidor_cidade' name='consumidor[cidade]' class='span12' ". $disabled. "data-obrigatorio='". $regras["consumidor|cidade"]["obrigatorio"]. "' value='".$consumidor_cidade. "' />";
                                }  
                            } ?>
                        </div>
                    </div>
                </div>
            </div>
            <?php if (in_array($login_fabrica,[148])) { ?>
                <div class="span3 cidade_exterior" style="<?= $display_estado_cidade ?>" style="display: none">
                    <div class="control-group <?=(in_array('consumidor[cidade]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="consumidor_cidade"><?php echo traduz('cidade');?></label>
                        <div class="controls controls-row">
                            <input type="text" class="form-control" name="consumidor[cidade_ex]" id="consumidor_cidade_exterior" readonly />                           
                        </div>
                    </div>
                </div>
            <?php } ?>

            <div class="span3">
                <div class='control-group <?=(in_array('consumidor[bairro]', $msg_erro['campos'])) ? "error" : "" ?>' >
                    <label class="control-label" for="consumidor_bairro"><?php echo traduz('bairro');?></label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <?php if ($regras["consumidor|bairro"]["obrigatorio"] == true  && $os_revenda === false) {
                                echo "<h5 class='asteristico'>*</h5>";
                            } ?>
                            <input id="consumidor_bairro" name="consumidor[bairro]" class="span12" type="text" data-obrigatorio="<?=$regras["consumidor|bairro"]["obrigatorio"]?>" value="<?= str_replace("\\", "",getValue('consumidor[bairro]')) ?>" <?=$readonly?> />
                        </div>
                    </div>
                </div>
            </div>

            <div class="span3">
                <div class='control-group <?=(in_array('consumidor[endereco]', $msg_erro['campos'])) ? "error" : "" ?>' >
                    <label class="control-label" for="consumidor_endereco"><?php echo traduz('endereco');?></label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <?php
                                if ($regras["consumidor|endereco"]["obrigatorio"] == true && $os_revenda === false) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                }
                            ?>
                            <input id="consumidor_endereco" name="consumidor[endereco]" class="span12" type="text" data-obrigatorio="<?=$regras["consumidor|endereco"]["obrigatorio"]?>" value="<?= str_replace("\\", "",getValue('consumidor[endereco]'))?>" <?=$readonly?> />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row-fluid">
            <div class="span1"></div>

            <div class="span1">
                <div class='control-group <?=(in_array('consumidor[numero]', $msg_erro['campos'])) ? "error" : "" ?>' >
                    <label class="control-label" for="consumidor_numero"><?php echo traduz('numero');?></label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <?php
                                if ($regras["consumidor|numero"]["obrigatorio"] == true && $os_revenda === false) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                }
                            ?>
                            <input id="consumidor_numero" name="consumidor[numero]" class="span12" type="text" data-obrigatorio="<?=$regras["consumidor|numero"]["obrigatorio"]?>" value="<?=getValue('consumidor[numero]')?>" <?=$readonly?> />
                        </div>
                    </div>
                </div>
            </div>

            <div class="<?=($login_fabrica == 183 ? "span2" : "span3")?>">
                <div class='control-group <?=(in_array('consumidor[complemento]', $msg_erro['campos'])) ? "error" : "" ?>' >
                    <label class="control-label" for="consumidor_complemento"><?php echo traduz('complemento');?></label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <?php
                                if ($regras["consumidor|complemento"]["obrigatorio"] == true && $os_revenda === false) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                }
                            ?>
                            <input id="consumidor_complemento" name="consumidor[complemento]" class="span12" type="text" data-obrigatorio="<?=$regras["consumidor|complemento"]["obrigatorio"]?>" value="<?=getValue('consumidor[complemento]')?>" <?=$readonly?> maxlength="20" />
                        </div>
                    </div>
                </div>
            </div>

            <?php if ($login_fabrica == 183){ ?>
                <div class="span3">
                    <div class="control-group <?=(in_array('consumidor[ponto_referencia]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="ponto_referencia"><?php echo traduz('Ponto referência');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <input id="ponto_referencia" name="consumidor[ponto_referencia]" class="span12" type="text" data-obrigatorio="<?=$regras["consumidor|ponto_referencia"]["obrigatorio"]?>" value="<?=getValue('consumidor[ponto_referencia]')?>" <?=$readonly?> />
                            </div>
                        </div>
                    </div>
                </div>
            <?php } ?>

            <div class="<?=($login_fabrica == 183 ? "span2" : "span3")?>">
                <div class="control-group <?=(in_array('consumidor[celular]', $msg_erro['campos'])) ? "error" : "" ?>">
                    <label class="control-label" for="consumidor_celular"><?php echo traduz('celular');?></label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <?php
                                if (($regras["consumidor|celular"]["obrigatorio"] == true || in_array($login_fabrica, array(151,167,169,170,203)) && $os_revenda === false) || ($login_fabrica == 151 && $os_revenda === false)) {
                                    echo "<h5 class='asteristico asteristico_celular'>*</h5>";
                                }
                            
                            $placeholder_celular = "(98) 99999-9999";

                            if (in_array($login_fabrica,[180,181,182])) {
                                $placeholder_celular = "";
                            }

                            ?>
                            <input id="consumidor_celular" name="consumidor[celular]" class="span12" type="text" data-obrigatorio="<?=$regras["consumidor|celular"]["obrigatorio"]?>" value="<?=getValue('consumidor[celular]')?>" <?=$readonly?> maxlength="20" placeholder="<?= $placeholder_celular; ?>" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="<?=($login_fabrica == 183 ? "span2" : "span3")?>">
                <div class="control-group <?=(in_array('consumidor[telefone]', $msg_erro['campos'])) ? "error" : "" ?>">
                    <label class="control-label" for="consumidor_telefone"><?php echo traduz('telefone');?></label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <?php
                                if (($regras["consumidor|telefone"]["obrigatorio"] == true || in_array($login_fabrica, array(151,167,169,170,203))) && $os_revenda === false) {
                                    echo "<h5 class='asteristico asteristico_telefone'>*</h5>";
                                }

                                $tel = getValue('consumidor[telefone]');

                                $placeholder_telefone = "(99) 99999-9999";

                                if (in_array($login_fabrica, [180,181,182])) {
                                    $placeholder_telefone = "";
                                }

                            ?>
                            <input id="consumidor_telefone" name="consumidor[telefone]" class="span12" type="text" data-obrigatorio="<?=$regras["consumidor|telefone"]["obrigatorio"]?>"  value="<?=  $tel ?>" <?=$readonly?> maxlength="20" placeholder="<?=$placeholder_telefone?>" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="span1"></div>
        </div>

        <div class="row-fluid">
            <div class="span1"></div>

            <div class="span4">
                <div class='control-group <?=(in_array('consumidor[email]', $msg_erro['campos'])) ? "error" : "" ?>' >
                    <label class="control-label" for="consumidor_email"><?php echo traduz('email');?></label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <?php
                                if ($regras["consumidor|email"]["obrigatorio"] == true && $os_revenda === false) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                }
                            ?>
                            <input id="consumidor_email" name="consumidor[email]" class="span12" type="text" data-obrigatorio="<?=$regras["consumidor|email"]["obrigatorio"]?>" value="<?=getValue('consumidor[email]')?>" <?=$readonly?> />
                        </div>
                    </div>
                </div>
            </div>

            <?php if ($login_fabrica == 203) { ?>
             <div class="span2">
                <div class='control-group <?=(in_array('consumidor[nascimento]', $msg_erro['campos'])) ? "error" : "" ?>' >
                    <label class="control-label" for="consumidor_nascimento"><?php echo traduz('data.de.nascimento');?></label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <?php
                                if ($regras["consumidor|nascimento"]["obrigatorio"] == true && $os_revenda === false) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                }
                            ?>
                            <input id="consumidor_nascimento" name="consumidor[nascimento]" class="span12" type="text" data-obrigatorio="<?=$regras["consumidor|nascimento"]["obrigatorio"]?>" value="<?=getValue('consumidor[nascimento]')?>" <?=$readonly?> />
                        </div>
                    </div>
                </div>
            </div>
            <?php } ?>
            <?php if ($login_fabrica == 52) { /*HD - 4304128*/ ?> 
                <script>
                    function validapais(){
                        let pais = $('#consumidor_pais').val();
                        if(pais != 'BR'){
                            $('#asteristico').html('');
                            $('#consumidor_cep').removeAttr('data-obrigatorio');
                        }
                    }
                </script>
                <div class="span4">
                    <div class='control-group <?=(in_array('consumidor[pais]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="consumidor_pais">País</label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <h5 class='asteristico'>*</h5>
                                <select id="consumidor_pais" name="consumidor[pais]" class="span12" onchange="validapais()" <?=$disabled?> data-obrigatorio="<?=$regras["consumidor|pais"]["obrigatorio"]?>" >
                                    <option value="">Selecione</option>
                                    <?php
                                        $sql             = "SELECT pais, nome FROM tbl_pais";
                                        $res             = pg_query($con, $sql);

                                        if (pg_num_rows($res) > 0) {
                                            while ($result = pg_fetch_object($res)) {
                                                $selected  = (trim($result->pais) == trim($consumidor_pais)) ? "SELECTED" : "";

                                                echo "<option value='{$result->pais}' {$selected} >{$result->nome} </option>";
                                            }
                                        }
                                    ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            <?php } ?>
            <?php if ($login_fabrica == 139 && $areaAdmin === false && $os_revenda === false) { ?>
                    <div class="span2">
                        <div class='control-group'>
                            <label class="control-label" for="prateleira_box"><?php echo traduz('Box / Prateleira');?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <input id="prateleira_box" name="os[prateleira_box]" class="span12" type="text" maxlength="10" value="<?=getValue('os[prateleira_box]')?>"/>
                                </div>
                            </div>
                        </div>
                    </div>
            <?php } ?>
            <?php if($login_fabrica ==35){?>
                <div class="span2">
                    <div class='control-group'>
                        <label class="control-label" for="op_email"><br></label>
                        <div class="controls controls-row">
                            <div class="checkbox">
                                <label>
                                    <?php if(getValue('consumidor[op_email]') == "Não possui e-mail"){
                                        $selected_op = " checked ";
                                    }else{
                                        $selected_op = "";
                                    }?>
                                  <input type="radio" name='consumidor[op_email]' <?=$selected_op?> value='Não possui e-mail'> <?php echo traduz('nao.possui.e.mail');?>
                                </label>
                              </div>
                        </div>
                    </div>
                </div>
                <div class="span3">
                    <div class='control-group'>
                        <label class="control-label" for="op_email"><br></label>
                        <div class="controls controls-row">
                            <div class="checkbox">
                                <label>
                                <?php if(getValue('consumidor[op_email]') == "Não deseja informar e-mail"){
                                    $selected_op = " checked ";
                                }else{
                                    $selected_op = "";
                                }?>
                                  <input type="radio" name='consumidor[op_email]' <?=$selected_op?> value='Não deseja informar e-mail'> <?php echo traduz('nao.deseja.informar.e.mail');?>
                                </label>
                              </div>
                        </div>
                    </div>
                </div>
            <?php } ?>
            <? if ($login_fabrica == 171) { ?>

            <div class="span1">
                <div class='control-group <?=(in_array('os[edificio]', $msg_erro['campos'])) ? "error" : "" ?>' >
                    <label class="control-label" for="consumidor_edificio"><?php echo traduz('edificio');?></label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <?=($regras["os|edificio"]["obrigatorio"] == true) ? "<h5 class='asteristico'>*</h5>" : ''; ?>
                            <input id="consumidor_edificio" name="os[edificio]" type="checkbox" data-obrigatorio="<?=$regras["os|edificio"]["obrigatorio"]?>" value="t" <?=(getValue('os[edificio]') == 't') ? 'checked' : ''; ?> />
                        </div>
                    </div>
                </div>
            </div>
            <div class="span3" id="consumidor_qtd_andar">
                <div class='control-group <?=(in_array('os[edificio_total_andares]', $msg_erro['campos'])) ? "error" : "" ?>' >
                    <label class="control-label" for="consumidor_edificio_total_andares"><?php echo traduz('quantidade.de.andares');?></label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <?=($regras["os|edificio_total_andares"]["obrigatorio"] == true) ? "<h5 class='asteristico'>*</h5>" : ''; ?>
                            <input id="consumidor_edificio_total_andares" name="os[edificio_total_andares]" type="number" data-obrigatorio="<?=$regras["os|edificio_total_andares"]["obrigatorio"]?>" value="<? echo getValue('os[edificio_total_andares]'); ?>" />
                        </div>
                    </div>
                </div>
            </div>
            <? }else{ ?>
                <div class="span7"></div>
            <? } ?>
        </div>
    </div>

    <br />

    <div id="div_informacoes_deslocamento" >
        <div class="tc_formulario" style="padding-bottom: 30px;">

            <? if (!in_array($login_fabrica, array(143))) { ?>
                <div class="titulo_tabela"><?php echo traduz('informacoes.do.deslocamento');?> <label class="pull-right"><input type="checkbox" id="ver-mapa" /> <?php echo traduz('ver.mapa');?></label></div>
                <div id="google_maps" style='width:90%;margin-left:5%;height:400px;'></div>
            <? } else { ?>
                <div class="titulo_tabela"><?php echo traduz('informacoes.do.deslocamento');?></div>
            <? }
            if($login_fabrica == 145 && strlen($os) > 0){
                $sql = "SELECT tipo_atendimento FROM tbl_os WHERE os = {$os} and fabrica = {$login_fabrica} ";
                $res = pg_query($con,$sql);
                if (pg_num_rows($res)>0 and strlen($tipo_atendimento=pg_fetch_result($res, 0,0))>0){
                    $digita_km = 'readonly="readonly"';
                }
            }

            ?>

            <br />

            <div class="row-fluid">
                <div class="span2"></div>

                <? if (in_array($login_fabrica, array(52,171))) { ?>

                    <?php if($login_fabrica == 52){ ?>
                    <div class="span5" style="padding-top: 5px; padding-bottom: 10px; height: auto;">
                        <div class='control-group <?=(in_array('os[pedagio]', $msg_erro['campos'])) ? "error" : "" ?> tac' >
                            <label class="control-label" id="box_pedagio" for="box_pedagio"><?php echo traduz('pedagio');?></label>
                            <div class="controls controls-row">
                                <div class="span12 tac">
                                    <span id="info_km">
                                        <input id="pedagio" name="os[pedagio]" class="span3" type="text" value="<?=number_format(getValue('os[pedagio]'), 2, '.', '')?>" />
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <?php }else{ ?>
                    <input type="hidden" name="os[qtde_km_ida]" value="">
                    <input type="hidden" name="os[qtde_km_volta]" value="">
                    <div class="span3" style="padding-top: 5px; padding-bottom: 10px; height: auto;">
                        <div class='control-group <?=(in_array('os[qtde_visita]', $msg_erro['campos'])) ? "error" : "" ?>' >
                            <label class="control-label" id="qtde_visita" for="qtde_visita"><?php echo traduz('quantidade.de.visitas');?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <span id="info_km">
                                        <input id="os_qtde_visita" name="os[qtde_visita]" class="span5" type="number" value="<?=getValue('os[qtde_visita]')?>" />
                                        <input id="os_qtde_visita_anterior" name="qtde_visita_anterior" class="span7" type="hidden" value="<?=getValue('os[qtde_visita]')?>" />
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <?php } ?>

                    <div class="span5" style="padding-top: 5px; padding-bottom: 10px; height: auto;">
                        <div class='control-group <?=(in_array('os[qtde_km]', $msg_erro['campos'])) ? "error" : "" ?>' >
                            <label class="control-label" id="box_desc_distancia" for="box_desc_distancia"> <?php echo traduz('distancia');?><span style="color: #FF0000;">(<?php echo traduz('a.distancia.ja.e.calculada.a.ida.e.a.volta');?>)</span></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <span id="info_km">
                                        <h5 class="asteristico" style="float: none; display: inline;">*</h5>
                                        <input id="qtde_km" name="os[qtde_km]" class="span3" type="text" value="<?=number_format(getValue('os[qtde_km]'), 2, '.', '')?>" <?=$digita_km?>/>
                                    </span>
                                    <input id="qtde_km_hidden" name="os[qtde_km_hidden]" type="hidden" value="<?=getValue('os[qtde_km_hidden]')?>" />
                                    <?
                                    if ($areaAdmin === true || $login_fabrica == 171) {
                                        $disabled_calcular_km = "";
                                    } else {
                                        $disabled_calcular_km = " disabled";
                                    }
                                    ?>
                                    <button type="button" id="calcular_km" class="btn btn-primary btn-small"<?= $disabled_calcular_km; ?>><?php echo traduz('calcular.km');?></button>
                                </div>
                            </div>
                        </div>
                    </div>
                <?php
                } else {
                ?>

                    <div class="span10" style="padding-top: 5px;height: auto;">
                        <div class='control-group <?=(in_array('os[qtde_km]', $msg_erro['campos'])) ? "error" : "" ?> tac' >
                            <? if (in_array($login_fabrica, array(169,170)) && strlen(getValue("os[os_numero]")) > 0) { ?>
                                <div class="controls controls-row">
                                    <div class="span12 tac">
                                        <input id="qtde_km_hidden" name="os[qtde_km_hidden]" type="hidden" value="<?=getValue('os[qtde_km_hidden]')?>" />
                                        <input id="qtde_km" name="os[qtde_km]" type="hidden" value="<?=getValue('os[qtde_km]')?>" />
                                        <div class='alert alert-warning' ><?php echo traduz('o.deslocamento.sera.pago.na.ordem.de.servico.de.origem');?></div>
                                    </div>
                                </div>
                            <? } else {
                                if (($login_fabrica == 156 && $areaAdmin === false) || $login_fabrica == 158) {
                                    $digita_km = 'readonly="readonly"';
                                } ?>
                                <label class="control-label" id="box_desc_distancia" for="box_desc_distancia"> <?php echo traduz('distancia');?><span style="color: #FF0000;">(<?php echo traduz('a.distancia.ja.e.calculada.a.ida.e.a.volta');?>)</span></label>
                                <div class="controls controls-row">
                                    <div class="span12 tac">
                                        <span id="info_km">
                                            <h5 class="asteristico" style="float: none; display: inline;">*</h5>
                                           <input id="qtde_km" name="os[qtde_km]" class="span2" type="text" value="<?=number_format(getValue('os[qtde_km]'), 2, '.', '')?>" <?=$digita_km?>/>
                                        </span>
                                        <input id="qtde_km_hidden" name="os[qtde_km_hidden]" type="hidden" value="<?=getValue('os[qtde_km_hidden]')?>" />
                                        <?php
                                        if ((!in_array($login_fabrica, array(143)) AND empty($digita_km)) OR $login_fabrica == 158) {
                                        ?>
                                            <button type="button" id="calcular_km" class="btn btn-primary btn-small" ><?php echo traduz('calcular.km');?></button>
                                        <?php
                                        }
                                        ?>
                                    </div>
                                </div>
                            <?php
                            }
                            ?>
                        </div>
                    </div>

                    <?php
                }

                ?>

                <div class="span1"></div>

            </div>
            <?php  

            if (in_array($login_fabrica, array(152,180,181,182))) {
            ?>
                <div class="row-fluid">

                    <div class="span1"></div>

                    <div class="span10" style="padding-top: 5px;height: auto;">
                        <div class='control-group tac' >
                            <label class="control-label" for="os_tempo_deslocamento"> <?php echo traduz('tempo.de.deslocamento');?><span style="color: #FF0000;">(<?php echo traduz('informar.em.horas');?>)</span></label>
                            <div class="controls controls-row">
                                <div class="span12 tac">
                                    <input id="os_tempo_deslocamento" name="os[tempo_deslocamento]" class="span1 numeric" type="text" value="<?=getValue('os[tempo_deslocamento]')?>" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="span1"></div>
                </div>
            <?php
            }
            ?>
        </div>
        <br />
    </div>


    <?php if (empty($os) && $login_fabrica == 195 AND $areaAdmin === false){ ?>
    <div id="informacoes_agendamento" style="display: none;">
        <div class="tc_formulario" style="padding-bottom: 30px;">
            <div class="titulo_tabela"><?php echo traduz('informacoes.do.agendamento');?></div>
            <br/>
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span2">
                    <div class='control-group <?=(in_array('os[data_agendamento]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="data_agendamento"><?php echo traduz('data agendamento');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                            <?php
                                if ($regras["os|data_agendamento"]["obrigatorio"] == true) { echo "<h5 class='asteristico'>*</h5>";}
                            ?>
                                <input id="data_agendamento" name="os[data_agendamento]" class="span12" type="text" autocomplete="off" value="<?=getValue('os[data_agendamento]')?>"/>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span3">
                    <div class='control-group <?=(in_array('os[tecnico]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="revenda_cnpj"><?php echo traduz('tecnico');?></label>
                        <div class="controls controls-row">
                            <div class="span10">
                                <?php
                                    if ($regras["os|tecnico"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    }
                                ?>
                                    <select class="span12" name="os[tecnico]" id="tecnico">
                                        <option value=""></option>
                                        <?php
                                        $sql = "SELECT tecnico, nome FROM tbl_tecnico WHERE posto = $login_posto AND fabrica = $login_fabrica AND ativo IS TRUE";
                                        $res = pg_query($con,$sql);

                                        foreach (pg_fetch_all($res) as $key) {
                                            $selected_tecnico = ( isset($tecnico) and ($tecnico == $key['tecnico']) ) ? "SELECTED" : '' ;

                                        ?>
                                            <option value="<?php echo $key['tecnico']?>" <?php echo $selected_tecnico ?> >
                                                <?php echo $key['nome']?>
                                            </option>
                                        <?php
                                        }
                                        ?>
                                    </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span2">
                    <div class='control-group <?=(in_array('os[periodo_visita]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="periodo_visita"><?php echo traduz('periodo');?></label>
                        <div class="controls controls-row">
                            <div class="span12 input-append">
                            <?php
                                if ($regras["os|periodo_visita"]["obrigatorio"] == true) { echo "<h5 class='asteristico'>*</h5>";}
                            ?>
                                <select class="span12" name="os[periodo_visita]" id="periodo_visita">
                                        <option value=""></option>
                                        <option value="manha" <?=$selected_manha?> >Manhã</option>
                                        <option value="tarde" <?=$selected_tarde?> >Tarde</option>
                                    </select>
                            </div>
                        </div>
                    </div>
                </div>
                <?php if (1 == 2) {?>
                <div class="span2">
                    <div class='control-group <?=(in_array('os[data_visita_realizada]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="data_visita_realizada"><?php echo traduz('data.visita.realizada');?></label>
                        <div class="controls controls-row">
                            <div class="span12 input-append">
                            <?php
                                if ($regras["os|data_visita_realizada"]["obrigatorio"] == true) { echo "<h5 class='asteristico'>*</h5>";}
                            ?>
                                <input id="data_visita_realizada" name="os[data_visita_realizada]" class="span12" type="text" autocomplete="off" value="<?=getValue('os[data_visita_realizada]')?>"/>
                                  <span class="add-on"><i id="btnPopover" rel="popover" data-placement="top" data-trigger="hover" data-delay="500" title="Visita realizada" data-content="Preencher o campo somente se a visita tenha sido realizada " class="icon-question-sign"></i>   </span>
                            </div>
                        </div>
                    </div>
                </div>
                <?php }?>
            </div>
        </div>
    </div>
    <br/>
    <?php } ?>

    <?php if (!in_array($login_fabrica, array(143,156))) { ?>

        <input type="hidden" name="revenda[id]" value="<?=getValue('revenda[id]')?>" />
        <div id="div_informacoes_revenda" class="tc_formulario">
            <div class="titulo_tabela"><?=($login_fabrica == 145) ? traduz('informacoes.da.revenda/construtora') : traduz('informacoes.da.revenda')?></div>

            <br />

            <?php
            if ($login_fabrica == 145) {
            ?>
                <div class="row-fluid">
                    <div class="span1"></div>

                    <div class="span4">
                        <div class='control-group' >
                            <label >&nbsp;</label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <label class="checkbox" >
                                        <input type="checkbox" id="os_construtora" name="os[construtora]" value="t" <?=(getValue('os[construtora]') == "t") ? "checked" : ""?> />
                                         <?php echo traduz('construtora');?>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <?php
            }
            ?>

            <div class="row-fluid">
                <div class="span1"></div>

                <?php if(in_array($login_fabrica, array(164,157))){ ?>

                    <div class="span3">
                        <div class='control-group <?=(in_array('revenda[cnpj]', $msg_erro['campos'])) ? "error" : "" ?>' >
                            <label class="control-label" for="revenda_cnpj"><?php echo traduz('cnpj');?></label>
                            <div class="controls controls-row">
                                <div class="span10 input-append">
                                    <?php
                                        if ($regras["revenda|cnpj"]["obrigatorio"] == true) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                        }
                                    ?>
                                    <input id="revenda_cnpj" name="revenda[cnpj]" class="span12" type="text" value="<?=getValue('revenda[cnpj]')?>" />
                                    <span class="add-on" rel="lupa" >
                                        <i class="icon-search"></i>
                                    </span>
                                    <input type="hidden" name="lupa_config" tipo="revenda" parametro="cnpj" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="span4">
                        <div class='control-group <?=(in_array('revenda[nome]', $msg_erro['campos'])) ? "error" : "" ?>' >
                            <label class="control-label" for="revenda_nome"><?php echo traduz('nome');?></label>
                            <div class="controls controls-row">
                                <div class="span10 input-append">
                                    <?php
                                        if ($regras["revenda|nome"]["obrigatorio"] == true) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                        }
                                    ?>
                                    <input id="revenda_nome" name="revenda[nome]" class="span12" type="text" maxlength="50" value="<?=getValue('revenda[nome]')?>" />
                                    <span class="add-on" rel="lupa" >
                                        <i class="icon-search"></i>
                                    </span>
                                    <input type="hidden" name="lupa_config" tipo="revenda" parametro="razao_social" />
                                </div>
                            </div>
                        </div>
                    </div>

                <?php }else{ ?>

                    <div class="span4">
                        <div class='control-group <?=(in_array('revenda[nome]', $msg_erro['campos'])) ? "error" : "" ?>' >
                            <label class="control-label" for="revenda_nome"><?php echo traduz('nome');?></label>
                            <div class="controls controls-row">
                                <div class="span10 input-append">
                                    <?php
                                    if ($regras["revenda|nome"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    }
                                    ?>
                                    <input id="revenda_nome" name="revenda[nome]" class="span12" type="text" maxlength="50" data-consumidor-obrigatorio="<?=$consumidor_revenda_obrigatorio['revenda|nome']?>" data-obrigatorio="<?=($revenda_obrigatorio) ? $revenda_obrigatorio['revenda|nome']['obrigatorio'] : $regras['revenda|nome']['obrigatorio']?>" value="<?=getValue('revenda[nome]')?>" />
                                    <span class="add-on" rel="lupa" >
                                        <i class="icon-search"></i>
                                    </span>
                                    <input type="hidden" name="lupa_config" tipo="revenda" parametro="razao_social" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="span3">
                        <div class='control-group <?=(in_array('revenda[cnpj]', $msg_erro['campos'])) ? "error" : "" ?>'>
                            <?php
                            if (in_array($login_fabrica, [186])) { ?>
                                <label class="control-label" for="consumidor_cpf">
                                    <?= traduz('cpf') ?>
                                    <input type="radio" id="cpf_cnpj_revenda" name="revenda[cnpjCpf]" <?= (getValue('revenda[cnpjCpf]') == "cpf") ? 'checked="checked"': ''; ?> value="cpf" />
                                    <?= traduz('cnpj') ?> 
                                    <input type="radio" id="cnpj_cpf_revenda" name="revenda[cnpjCpf]" <?= (getValue('revenda[cnpjCpf]') == "cnpj" || empty(getValue('revenda[cnpjCpf]'))) ? 'checked="checked"': ''; ?> value="cnpj" />
                                </label>
                            <?php
                            } else { ?>
                                <label class="control-label" for="revenda_cnpj"><?php echo traduz('CNPJ');?></label>
                            <?php
                            } ?>
                            <div class="controls controls-row">
                                <div class="span10 input-append">
                                    <?php
                                        if ($regras["revenda|cnpj"]["obrigatorio"] == true) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                        }
                                        
                                    ?>
                                    <input id="revenda_cnpj" name="revenda[cnpj]" class="span12" type="text" data-consumidor-obrigatorio="<?=$consumidor_revenda_obrigatorio['revenda|cnpj']?>" data-obrigatorio="<?=($revenda_obrigatorio) ? $revenda_obrigatorio['revenda|cnpj']['obrigatorio'] : $regras["revenda|cnpj"]["obrigatorio"]?>" value="<?=getValue('revenda[cnpj]')?>" />
                                    <span class="add-on" rel="lupa" >
                                        <i class="icon-search"></i>
                                    </span>
                                    <input type="hidden" name="lupa_config" tipo="revenda" parametro="cnpj" />s
                                </div>
                            </div>
                        </div>
                    </div>

                <?php } ?>

                <div class="span2">
                    <div class='control-group <?=(in_array('revenda[cep]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="revenda_cep"><?php echo traduz('cep');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?php
                                    if ($regras["revenda|cep"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    }
                                ?>
                                <input id="revenda_cep" name="revenda[cep]" class="span12" type="text" data-consumidor-obrigatorio="<?=$consumidor_revenda_obrigatorio['revenda|cep']?>" data-obrigatorio="<?=($revenda_obrigatorio) ? $revenda_obrigatorio['revenda|cep']['obrigatorio'] : $regras["revenda|cep"]["obrigatorio"]?>" value="<?=getValue('revenda[cep]')?>" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span1"></div>
            </div>

            <div class="row-fluid">
                <div class="span1"></div>

                <div class="span2" style="<?= $display_estado_cidade ?>">
                    <div class="control-group <?=(in_array('revenda[estado]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="revenda_estado"><?php echo traduz('estado');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?php
                                    if ($regras["revenda|estado"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    }

    									 if((in_array($pais_posto, array('AR','CO', 'PE')) AND in_array($login_fabrica, array(180, 181, 182)) AND $pais_posto == $pais) OR $pais_posto == 'BR' OR $pais_posto == ''){
									$tmpHtml = "<option value=''> </option>";
    									foreach($listaDeEstadosDoPais as $estado){
										$revUfSelected = ($estado['sigla'] == getValue('revenda[estado]')) ? "selected" : "";
    										$tmpHtml .= "<option value='{$estado['sigla']}' {$revUfSelected}> {$estado['descricao']} </option>";
    									}
    									$tipoEstado = ($pais != 'BR') ? 'Provincias' : 'Estados';
                                        $html = "<optgroup label='{$tipoEstado}'> {{options}} </optgroup>";
                                        
                                        $html = str_replace('{{options}}', $tmpHtml, $html);
	
                                    ?>                                        
                                    <select style="display: block;" id="revenda_estado" name="revenda[estado]" data-consumidor-obrigatorio="<?=$consumidor_revenda_obrigatorio['revenda|estado']?>" data-obrigatorio="<?=($revenda_obrigatorio) ? $revenda_obrigatorio['revenda|estado']['obrigatorio'] : $regras["revenda|estado"]["obrigatorio"]?>" class="span12" ><?=$html ?></select>
                                     <input style="display: none;" type="text" id="t_revenda_estado" name="revenda[estado]" data-consumidor-obrigatorio="<?=$consumidor_revenda_obrigatorio['revenda|estado']?>" data-obrigatorio="<?=($revenda_obrigatorio) ? $revenda_obrigatorio['revenda|estado']['obrigatorio'] : $regras["revenda|estado"]["obrigatorio"]?>" class="span12" disabled value="<?=utf8_decode($campos_adicionais['revenda']['estado']) ?>" />
                                    <?
                                    } else {
                                        ?>
                                        <input type="text" id="revenda_estado" name="revenda[estado]" data-consumidor-obrigatorio="<?=$consumidor_revenda_obrigatorio['revenda|estado']?>" data-obrigatorio="<?=($revenda_obrigatorio) ? $revenda_obrigatorio['revenda|estado']['obrigatorio'] : $regras["revenda|estado"]["obrigatorio"]?>" class="span12" value="<?=utf8_decode($campos_adicionais['revenda']['estado']) ?>" />
                                        <?
                                    }   
                                ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span3" style="<?= $display_estado_cidade ?>">
                    <div class="control-group <?=(in_array('revenda[cidade]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="revenda_cidade"><?php echo traduz('cidade');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?php
                                    if ($regras["revenda|cidade"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    }
				 if((in_array($pais_posto, array('AR','CO', 'PE')) AND in_array($login_fabrica, array(180, 181, 182)) AND $pais_posto == $pais) OR $pais_posto == 'BR' OR $pais_posto == ''){
                                ?>
                                <input style="display: none;" type="text" id="t_revenda_cidade" name="revenda[cidade]" data-consumidor-obrigatorio="<?=$consumidor_revenda_obrigatorio['revenda|cidade']?>" data-obrigatorio="<?=($revenda_obrigatorio) ? $revenda_obrigatorio['revenda|cidade']['obrigatorio'] : $regras["revenda|cidade"]["obrigatorio"]?>" class="span12" disabled value="<?=utf8_decode($campos_adicionais['revenda']['cidade']) ?>" />
                                <select id="revenda_cidade" name="revenda[cidade]" data-consumidor-obrigatorio="<?=$consumidor_revenda_obrigatorio['revenda|cidade']?>" data-obrigatorio="<?=($revenda_obrigatorio) ? $revenda_obrigatorio['revenda|cidade']['obrigatorio'] : $regras["revenda|cidade"]["obrigatorio"]?>" class="span12" >
                                    <option value="" ><?php echo traduz('selecione');?></option>

                                    <?php

                                    if (strlen($rev_uf = getValue("revenda[estado]")) > 0) {
                                        $sql = "SELECT * FROM (
                                                    SELECT UPPER(TRIM(fn_retira_especiais(cidade))) AS cidade FROM tbl_ibge WHERE UPPER(estado) = UPPER('$rev_uf')
                                                    UNION (
                                                        SELECT UPPER(TRIM(fn_retira_especiais(nome))) AS cidade FROM tbl_cidade WHERE (UPPER(estado) = UPPER('$rev_uf') or upper(estado_exterior) = upper('$rev_uf'))
                                                    )
                                                ) AS cidade
                                                ORDER BY cidade ASC";
                                        $res = pg_query($con, $sql);

                                        if (pg_num_rows($res) > 0) {
                                            $rev_cidade = getValue("revenda[cidade]");

                                            $sql = "SELECT UPPER(TRIM(fn_retira_especiais('$rev_cidade')))";
                                            $resUpperCidade = pg_query($con,$sql);
                                            $rev_cidade = pg_fetch_result($resUpperCidade,0,0);

                                            while ($result = pg_fetch_object($res)) {
                                                $selected = ($result->cidade == $rev_cidade) ? " selected" : "";

                                                echo "\t<option value='{$result->cidade}'{$selected}>{$result->cidade}</option>\n";
                                            }
                                        }
                                    }
                                } else {
                                    ?>
                                       <input type="text" id="revenda_cidade" name="revenda[cidade]" data-consumidor-obrigatorio="<?=$consumidor_revenda_obrigatorio['revenda|cidade']?>" data-obrigatorio="<?=($revenda_obrigatorio) ? $revenda_obrigatorio['revenda|cidade']['obrigatorio'] : $regras["revenda|cidade"]["obrigatorio"]?>" class="span12" value="<?=utf8_decode($campos_adicionais['revenda']['cidade']) ?>" />
                                    <?
                                }
                                    ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span3">
                    <div class='control-group <?=(in_array('revenda[bairro]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="revenda_bairro"><?php echo traduz('bairro');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?php
                                    if ($regras["revenda|bairro"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    }
                                ?>
                                <input id="revenda_bairro" name="revenda[bairro]" class="span12" type="text" data-consumidor-obrigatorio="<?=$consumidor_revenda_obrigatorio['revenda|bairro']?>" data-obrigatorio="<?=($revenda_obrigatorio) ? $revenda_obrigatorio['revenda|bairro']['obrigatorio'] : $regras["revenda|bairro"]["obrigatorio"]?>" value="<?=getValue('revenda[bairro]')?>" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span1"></div>
            </div>

            <div class="row-fluid">
                <div class="span1"></div>

                <div class="span3">
                    <div class='control-group <?=(in_array('revenda[endereco]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="revenda_endereco"><?php echo traduz('endereco');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?php
                                    if ($regras["revenda|endereco"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    }
                                ?>
                                <input id="revenda_endereco" name="revenda[endereco]" class="span12" type="text" data-consumidor-obrigatorio="<?=$consumidor_revenda_obrigatorio['revenda|endereco']?>" data-obrigatorio="<?=($revenda_obrigatorio) ? $revenda_obrigatorio['revenda|endereco']['obrigatorio'] : $regras["revenda|endereco"]["obrigatorio"]?>" value="<?= str_replace("\\", "",getValue('revenda[endereco]')) ?>" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span1">
                    <div class='control-group <?=(in_array('revenda[numero]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="revenda_numero"><?php echo traduz('numero');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?php
                                    if ($regras["revenda|numero"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    }
                                ?>
                                <input id="revenda_numero" name="revenda[numero]" class="span12" type="text" maxlength="15" data-consumidor-obrigatorio="<?=$consumidor_revenda_obrigatorio['revenda|numero']?>" data-obrigatorio="<?=($revenda_obrigatorio) ? $revenda_obrigatorio['revenda|numero']['obrigatorio'] : $regras["revenda|numero"]["obrigatorio"]?>" value="<?=getValue('revenda[numero]')?>" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span2">
                    <div class='control-group <?=(in_array('revenda[complemento]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="revenda_complemento"><?php echo traduz('complemento');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?php
                                    if ($regras["revenda|complemento"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    }
                                ?>
                                <input id="revenda_complemento" name="revenda[complemento]" maxlength='30' class="span12" type="text" data-consumidor-obrigatorio="<?=$consumidor_revenda_obrigatorio['revenda|complemento']?>" data-obrigatorio="<?=($revenda_obrigatorio) ? $revenda_obrigatorio['revenda|complemento']['obrigatorio'] : $regras["revenda|complemento"]["obrigatorio"]?>" value="<?=getValue('revenda[complemento]')?>" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span3">
                    <div class="control-group <?=(in_array('revenda[telefone]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="revenda_telefone"><?php echo traduz('telefone');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?php
                                    if ($regras["revenda|telefone"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    }
                                ?>
                                <input id="revenda_telefone" name="revenda[telefone]" class="span12" type="text" data-consumidor-obrigatorio="<?=$consumidor_revenda_obrigatorio['revenda|telefone']?>" data-obrigatorio="<?=($revenda_obrigatorio) ? $revenda_obrigatorio['revenda|telefone']['obrigatorio'] : $regras["revenda|telefone"]["obrigatorio"]?>" value="<?=getValue('revenda[telefone]')?>" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span1"></div>
            </div>
            <? if (in_array($login_fabrica, array(169,170))) { ?>
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span6">
                        <div class="control-group <?=(in_array('revenda[contato]', $msg_erro['campos'])) ? "error" : "" ?>">
                            <label class="control-label" for="revenda_contato"><?php echo traduz('contato');?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <?php
                                        if ($regras["revenda|contato"]["obrigatorio"] == true) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                        }
                                    ?>
                                    <input id="revenda_contato" name="revenda[contato]" class="span12" type="text" data-consumidor-obrigatorio="<?=$consumidor_revenda_obrigatorio['revenda|contato']?>" data-obrigatorio="<?=($revenda_obrigatorio) ? $revenda_obrigatorio['revenda|contato']['obrigatorio'] : $regras["revenda|contato"]["obrigatorio"]?>" value="<?=getValue('revenda[contato]')?>" maxlength="50" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="span1"></div>
                </div>
            <? } ?>

            <? if (in_array($login_fabrica, array(186))) { ?>
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span4">
                        <div class="control-group <?=(in_array('revenda[email]', $msg_erro['campos'])) ? "error" : "" ?>">
                            <label class="control-label" for="revenda_email"><?php echo traduz('email.revenda');?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <?php
                                        if ($regras["revenda|email"]["obrigatorio"] == true) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                        }
                                    ?>
                                    <input id="revenda_email" name="revenda[email]" class="span12" type="text" data-consumidor-obrigatorio="<?=$consumidor_revenda_obrigatorio['revenda|email']?>" data-obrigatorio="<?=($revenda_obrigatorio) ? $revenda_obrigatorio['revenda|email']['obrigatorio'] : $regras["revenda|email"]["obrigatorio"]?>" value="<?=getValue('revenda[email]')?>" maxlength="50" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="span1"></div>
                </div>
            <? } ?>
        </div>

        <br />

    <?php
    }

    ?>

    <div id="div_informacoes_produto" class="tc_formulario">
        <div class="titulo_tabela"> <?php echo traduz('informacoes.do.produto');?> <? (in_array($login_fabrica, array(152,180,181,182))) ? " (".traduz("clique.na.lupa.para.selecionar.o.produto").")" : ""; ?></div>
        <?php

        if (strlen($produto = getValue("produto[id]")) > 0) {
            $produto_readonly      = "readonly='readonly'";
            $produto_esconde_lupa  = "style='display: none;'";

            if (empty($os)) {
                if (getValue("os[tipo_atendimento]") == 211 && $login_fabrica == 147) {
                    $produto_mostra_trocar = "style='display: none;'";
                } else {
                    $produto_mostra_trocar = "style='display: block;'";
                }
            } else {
                if (in_array($login_fabrica,array(161,165))) {
                    $produto_mostra_trocar = "style='display: block;'";
                    if (in_array($login_fabrica,array(161))) {
                        $produto_esconde_lupa  = "style='display: none;'";
                    }
                } else {
                    $produto_mostra_trocar = "style='display: none;'";
                }
                if($login_fabrica == 153 && $areaAdmin === true and !empty($os)){ //hd_chamado=2813100
                    if(verifica_pecas_lancadas($os) == true){
                        $produto_mostra_trocar = "style='display: block;'";
                    }
                }
            }

            if (in_array($login_fabrica, [169,170])) {
                $produto_mostra_trocar = "style='display: block;'";
            }

            if (!strlen(getValue("produto[os_produto]"))) {
                $produto_mostra_trocar = "style='display: block;'";
            }

            if ($login_fabrica == 156 && true === $areaAdmin) {
                $sql_defeito_peca = "
                    SELECT
                        tbl_os_defeito_reclamado_constatado.defeito_constatado
                    FROM tbl_os_defeito_reclamado_constatado
                    JOIN tbl_os USING(os)
                    JOIN tbl_os_produto ON tbl_os.os = tbl_os_produto.os
                    JOIN tbl_os_item USING(os_produto)
                    WHERE tbl_os.os = {$os} AND tbl_os.fabrica = {$login_fabrica};
                ";
                $qry_defeito_peca = pg_query($con, $sql_defeito_peca);

                if (pg_num_rows($qry_defeito_peca) == 0) {
                    $produto_mostra_trocar = 'style="display: block;"';
                }
            }

        }

        if(in_array($login_fabrica,array(162,165))){
            if ($areaAdmin === true) {
                $sqlOsFinalizada = "
                    SELECT finalizada
                    FROM tbl_os
                    WHERE os = {$os};
                ";
                $resOsFinalizada = pg_query($con,$sqlOsFinalizada);

                $finalizadaOs = pg_fetch_result($resOsFinalizada,0,finalizada);

                $mostra_data_saida  = "style='display:none'";
                $mostra_postagem    = "style='display:none'";

                if ($finalizadaOs != "") {
                    $mostra_data_saida  = "style='display:block'";
                    $mostra_postagem    = "style='display:block'";
                }
            }
            if ($login_fabrica == 162) {
                $produto_mostra_trocar = "style='display: none;'";
                $produto_mostra_partNumber = "style='display: none;'";
                $mostra_campo_imei = "style='display: none;'";

                if(getValue("produto[linha_informatica]") == 't'){
                    $produto_mostra_trocar = "style='display: block;'";

                    if(getValue("produto[sem_ns]") || strlen(trim(getValue("produto[partnumber]")))>0){
                        $produto_mostra_partNumber = "style='display: block;'";
                    }

                }elseif(getValue("produto[linha_informatica]") == 'f'){
                    $mostra_campo_imei = "style='display: block;'";
                }
            }

        }else{
            $mostra_campo_imei = "style='display: none;'";
        }

        if ($login_fabrica == 158 && $areaAdmin == true and !empty($os)) {
            $os_mobile = getValue("os[os_numero]");

            if (empty($os_mobile) && verifica_pecas_lancadas($os)) {
                $produto_mostra_trocar = "style='display: block;'";
            }
        }

        if (strlen(getValue("produto[os_produto]")) > 0) {
            $produto_possui_troca = verificaOsProdutoTroca(getValue("produto[os_produto]"));
        }

        if (in_array($login_fabrica, array(152,180,181,182))) {
            $produto_readonly = "readonly='readonly'";
        }

        $btn_comunicado_text = "Comunicados";

        if (strlen(getValue("produto[id]")) > 0) {
            $comunicados_produto = busca_comunicados_produto(getValue("produto[id]"));

            if (empty($comunicados_produto)) {
                $btn_comunicado_text     = "Não há comunicados para o produto";
                $btn_comunicado_disabled = "disabled='disabled'";
            }
        } ?>
        <br />
        <p class="tac" >
            <button type="button" class="btn btn-warning btn-small comunicados-produto" title="<?=traduz("Comunicados para o produto lançado")?>" <?=$btn_comunicado_disabled?> ><i class="icon-info-sign icon-white" ></i> <?=$btn_comunicado_text?></button>
        </p>

        <div class="modal hide fade modal-comunicados">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h3> <?php echo traduz('comunicados');?></h3>
            </div>
            <div class="modal-body">
                <table class="table table-bordered table-striped" >
                    <thead>
                        <tr class="titulo_coluna" >
                            <th><?php echo traduz('comunicado');?></th>
                            <th><?php echo traduz('tipo');?></th>
                            <th><?php echo traduz('data');?></th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        if (isset($comunicados_produto) && !empty($comunicados_produto)) {
                            $url = ($areaAdmin) ? "comunicado_produto.php" : "comunicado_mostra.php";

                            foreach ($comunicados_produto as $i => $comunicado) {
                                unset($comunicado_anexo_link);

                                $link = busca_comunicado_anexo($comunicado["comunicado"], $comunicado["extensao"], $comunicado["tipo"]);

                                if (!is_null($link)) {
                                    $comunicado_anexo_link = "
                                        <a href='{$link}' target='_blank' title='".traduz('visualizar.anexo.do.comunicado')."' >
                                            <button type='button' class='btn btn-info btn-mini' >
                                                <i class='icon-file icon-white' ></i>
                                            </button>
                                        </a>
                                    ";
                                }

                                echo "
                                    <tr>
                                        <td>{$comunicado['descricao']}</td>
                                        <td>{$comunicado['tipo']}</td>
                                        <td class='tac' >{$comunicado['data_comunicado']}</td>
                                        <td class='tac' >
                                            {$comunicado_anexo_link}
                                            <a href='{$url}?comunicado={$comunicado['comunicado']}' target='_blank' >
                                                <button type='button' class='btn btn-info btn-mini' title='".traduz('visualizar.comunicado')."' >
                                                    <i class='icon-search icon-white' ></i>
                                                </button>
                                            </a>
                                        </td>
                                    </tr>
                                ";
                            }
                        }
                        ?>
                    </tbody>
                </table>
            </div>
        </div>

        <br />

        <input type="hidden" id="produto_id" name="produto[id]" value="<?=getValue('produto[id]')?>" />
        <?php if($login_fabrica == 162){?>
            <input type="hidden" id="linha_informatica" name="produto[linha_informatica]" value="<?=getValue('produto[linha_informatica]')?>" />
        <?php } ?>
        <input type="hidden" id="produto_versao" name="" value="" />
        <input type="hidden" name="produto[os_produto]" value="<?=getValue('produto[os_produto]')?>" />
        <input type="hidden" id="tipo_produto" name="produto[tipo_produto]" value="<?=getValue('produto[tipo_produto]')?>" />
        <? if (in_array($login_fabrica, array(35,142,157,169,170))) {
            if (in_array($login_fabrica, array(142,157))) { ?>
                <input type="hidden" id="produto_entrega_tecnica" name="produto[entrega_tecnica]" value="<?=getValue('produto[entrega_tecnica]')?>" />
            <? } ?>
            <input type="hidden" id="produto_deslocamento_km" name="produto[deslocamento_km]" value="<?=getValue('produto[deslocamento_km]')?>" />
        <? }

        if (in_array($login_fabrica,array(169,170))) {
            $display_mascara = "none";
            if (strlen(getValue("produto[id]")) > 0) {
                if (!strlen(getValue("produto[serie]"))){
                    $sqlMascaras = "
                        SELECT pvs.mascara
                        FROM tbl_produto_valida_serie pvs
                        INNER JOIN tbl_produto p ON p.produto = pvs.produto AND p.fabrica_i = {$login_fabrica}
                        WHERE pvs.fabrica = {$login_fabrica}
                        AND pvs.produto = ".getValue("produto[id]")."
                    ";
                    $resMascaras = pg_query($con, $sqlMascaras);

                    if (pg_num_rows($resMascaras) > 0) {
                        $display_mascara = "inline-block";
                        $mascaras = pg_fetch_all($resMascaras);
                    }
                }
            }
            ?>
            <div id="produto-serie-mascaras" class="row-fluid" style="display: <?=$display_mascara?>;" >
                <div class="span1"></div>
                <div class="span9 alert alert-info tal" >
                    <h4><?php echo traduz('mascaras.do.numero.de.serie');?></h4>
                    <br />
                    L = Letra<br />
                    N = Número<br/>
                    <br />
                    <ul class="mascaras" >
                        <?php
                        if (count($mascaras) > 0) {
                            foreach ($mascaras as $mascara) {
                                echo "<li>{$mascara['mascara']}</li>";
                            }
                        }
                        ?>
                    </ul>
                </div>
            </div>
        <?php
        }

        if(in_array($login_fabrica, array(165,169,170, 175))){
            unset($readonly); ?>

            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span5">
                    <div class='control-group <?=(in_array('produto[serie]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="produto_serie"><?php echo traduz('numero.de.serie');?></label>
                        <div class="controls controls-row">
                            <div class="span12 input-append" id='fricon'>
                                <? if ($regras["produto|serie"]["obrigatorio"] == true) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                }

                                if (in_array($login_fabrica, array(169,170))) {
                                    if (strlen(getValue("produto['serie']")) > 0 && !in_array("Número de Série inválido", $msg_erro["msg"])) {
                                        $produto_serie_readonly = "readonly";
                                    } else {
                                        $produto_serie_readonly = "";
                                    }
                                }
                                
                                if ($login_fabrica == 175 && strlen(getValue('produto[id]')) > 0 && strlen(getValue('produto[serie]'))) {
                                    $produto_serie_readonly = "readonly";
                                }

                                $readonly = ((getValue('produto[sem_ns]') == 't')) ? "readonly='readonly'" : "";
                                ?>

                                <input id="produto_serie"
                                       name="produto[serie]"
                                       class="span10"
                                       type="text"
                                       value="<?=getValue('produto[serie]')?>"
                                       maxlength="30"
                                       <?=(in_array($login_fabrica, array(169,170,175))) ? $produto_serie_readonly : $readonly; ?>
                                />
                                <span class="add-on lupa_serie" rel="lupa_produto" <?= $produto_esconde_lupa; ?> style='cursor: pointer;'>
                                     <?=($login_fabrica == 161) ? "&nbsp; ".traduz('inserir')." &nbsp;" : "<i class='icon-search'></i>"?>
                                </span>
                                <input type="hidden" name="lupa_config" posto="<?=$login_posto?>" tipo="produto" parametro="numero_serie" <?=(in_array($login_fabrica, array(169,170))) ? "mascara='true' grupo-atendimento='' fora-garantia='' km-google=''" : ""?> <?=($usaProdutoGenerico) ? "produto-generico='true'" : ""?> />
                            </div>
                        </div>
                    </div>
                </div>

                <? 
                if (in_array($login_fabrica, array(175))) {
                ?>
                    <div class="span2">
                        <div class='control-group' >
                            <label class="control-label"><?=ucfirst(traduz('Venc. da Garantia'))?></label>
                            <div class="controls controls-row">
                                <div class="span12 input-append">
                                    <input id="produto_garantia"
                                        disabled="disabled"
                                        class="span10"
                                        type="text"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                <?php
                }
                
                if (!in_array($login_fabrica, array(169,170,175))) { 
                ?>
                    <div class="span5" id="prod_s_ns" <?=$produto_mostra_trocar?> >
                        <div class="control-group <?=(in_array('produto[sem_ns]', $msg_erro['campos'])) ? "error" : "" ?>">
                            <div class="controls controls-row">
                                <br />
                                <div class="span12">
                                    <?
                                    $produto_sem_ns = getValue("produto[sem_ns]");
                                    if($produto_sem_ns == 't'){
                                        $checked = " checked ";
                                        $produto_msg_fora_garantia = "style='display:block;'";
                                    } else {
                                        $checked = " ";
                                        $produto_msg_fora_garantia = "style='display:none;'";
                                    } ?>
                                    <input type="checkbox" name="produto[sem_ns]" value="t" <?= $checked ?> id="sem_ns" >
                                    <label class="control-label" for="produto_sem_ns"><?php echo traduz('produto.sem.numero.de.serie');?></label>
                                </div>
                            </div>
                        </div>
                    </div>
                <? } ?>

                <div class="span1"></div>
            </div>

        <? } ?>

        <div class="row-fluid">
            <div class="span1"></div>
            <?php if ($login_fabrica == 161){ ?>

            <div class="span3">
                <input type="hidden" name="produto[linhaproduto]" id="linhaproduto" value="<?=getValue('produto[linhaproduto]')?>">
                <div class="control-group">
                    <label class="control-label" for="produto_referencia_disabled"><?php echo traduz('referencia');?></label>
                    <div class="controls controls-row">
                        <div class="span10 input-append">
                            <input id="produto_referencia_disabled" name="produto_referencia_disabled" class="span12" type="text" value="<?=getValue('produto[referencia]')?>" disabled="disabled" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="span5">
                <div class="control-group">
                    <label class="control-label" for="produto_descricao_disabled"><?php echo traduz('descricao');?></label>
                    <div class="controls controls-row">
                        <div class="span10 input-append">
                            <input id="produto_descricao_disabled" name="produto_descricao_disabled" class="span12" type="text" value="<?=getValue('produto[descricao]')?>" disabled="disabled" />
                        </div>
                    </div>
                </div>
            </div>
            <?php 
            }else{ 
                if (in_array($login_fabrica, array(175))) {
                    $span = "span4";
                } else {
                    $span = "span3";
                }
                ?>
            <div class="<?=$span?>">
                <div class='control-group <?=(in_array('produto[id]', $msg_erro['campos'])) ? "error" : "" ?>' >
                    <label class="control-label" for="produto_referencia"><?php echo traduz('referencia');?></label>
                    <div class="controls controls-row">
                        <div class="span10 input-append">
                            <?php
                                if ($regras["produto|id"]["obrigatorio"] == true) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                }
                                if (in_array($login_fabrica, array(169,170))) {
                                    $produto_referencia = getValue('produto[referencia]');
                                    $produto_referencia = str_replace('YY', '-', $produto_referencia);
                                } else {
                                    $produto_referencia = getValue('produto[referencia]');
                                }
                            ?>
                            <input id="produto_referencia" name="produto[referencia]" class="span12" type="text" value="<?= $produto_referencia; ?>" <?=$produto_readonly?> />
                            <span class="add-on" rel="lupa_produto" <?=$produto_esconde_lupa?> >
                                <i class="icon-search"></i>
                            </span>
                            <input type="hidden" name="lupa_config" tipo="produto" parametro="referencia" posto="<?=$login_posto?>" ativo="t" <? if (isset($fabrica_usa_subproduto)) echo "subproduto='true'"; ?> <?=(in_array($login_fabrica, array(142))) ? "entrega-tecnica='t'" : ""?> <?=(in_array($login_fabrica, array(153))) ? "tela_cadastro_os='t'" : ""?> <?=(in_array($login_fabrica, array(169,170))) ? "mascara='true' grupo-atendimento='' fora-garantia='' km-google=''" : ""?> <?=($usaProdutoGenerico) ? "produto-generico='true'" : ""?> />
                            <input type="hidden" id="valida_suprimento" name="produto[valida_suprimento]" value="<?=$valida_suprimento?>">
                        </div>
                    </div>
                </div>
            </div>
            <? if (in_array($login_fabrica, array(145,161,175))) {
                $span = "span5";
            }elseif (in_array($login_fabrica, array(131,171))) {
                $span = "span4";
            } else {
                $span = "span3";
            } ?>
            <div class="<?=$span?>" >
                <div class='control-group <?=(in_array('produto[id]', $msg_erro['campos'])) ? "error" : "" ?>' >
                    <label class="control-label" for="produto_descricao"><?php echo traduz('descricao');?></label>
                    <div class="controls controls-row">
                        <div class="span10 input-append">
                            <?php
                                if ($regras["produto|id"]["obrigatorio"] == true) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                }
                            ?>
                            <input id="produto_descricao" name="produto[descricao]" class="span12" type="text" value="<?=getValue('produto[descricao]')?>" <?=$produto_readonly?> />
                            <span class="add-on" rel="lupa_produto" <?=$produto_esconde_lupa?> >
                                <i class="icon-search"></i>
                            </span>
                            <input type="hidden" name="lupa_config" tipo="produto" parametro="descricao" posto="<?=$login_posto?>" ativo="t" <? if (isset($fabrica_usa_subproduto)) echo "subproduto='true'"; ?> <?=(in_array($login_fabrica, array(142))) ? "entrega-tecnica='t'" : ""?> <?=(in_array($login_fabrica, array(153))) ? "tela_cadastro_os='t'" : ""?> <?=(in_array($login_fabrica, array(169,170))) ? "mascara='true' grupo-atendimento='' fora-garantia='' km-google=''" : ""?> <?=($usaProdutoGenerico) ? "produto-generico='true'" : ""?> />
                        </div>
                    </div>
                </div>
            </div>
            <?php } ?>

            <? switch ($login_fabrica) {
                case 143    : $espaco1 = "2"; $espaco2 = "2"; break;
                default     : $espaco1 = "1"; $espaco2 = "3"; break;
            }

            if (in_array($login_fabrica, array(143))) { ?>
                <div class="span<?php echo $espaco1; ?> ">
                    <div class='control-group <?=(in_array('os[rg_produto]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="produto_rg_produto"><?php echo traduz('horimetro');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?php
                                    if ($regras["os|rg_produto"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    }
                                ?>
                                <input id="produto_rg_produto" name="os[rg_produto]" class="span12 numeric" type="text" value="<?=getValue('os[rg_produto]')?>" <?= ($login_fabrica == 143) ? "" : "readonly='readonly'"; ?> />
                            </div>
                        </div>
                    </div>
                </div>
            <? } elseif(!in_array($login_fabrica, array(171))) { ?>
                <div class="span<?php echo $espaco1; ?> ">
                    <div class='control-group <?=(in_array('produto[voltagem]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="produto_voltagem"><?php echo traduz('voltagem');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if ($regras["produto|voltagem"]["obrigatorio"] == true) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                } ?>
                                <input id="produto_voltagem" name="produto[voltagem]" class="span12" type="text" value="<?=getValue('produto[voltagem]')?>" <?= (in_array($login_fabrica, array(35,143))) ? "" : "readonly='readonly'"; ?> />
                            </div>
                        </div>
                    </div>
                </div>
            <? }elseif(in_array($login_fabrica, array(171))) {
            ?>
                <div class="span3">
                    <div class='control-group <?=(in_array('os[pressao_agua]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="os_pressao_agua"><?php echo traduz('pressao.da.agua.mca');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?=($regras["os[pressao_agua]"]["obrigatorio"] == true) ? "<h5 class='asteristico'>*</h5>" : ''; ?>
                                <input id="os_pressao_agua" name="os[pressao_agua]" class="span12" type="number" value="<?=getValue('os[pressao_agua]')?>" />
                            </div>
                        </div>
                    </div>
                </div>
            <?
            }
            $spanX = "span12";
            if(!in_array($login_fabrica, array(145,161,165,169,170,171,175))){
                switch ($login_fabrica) {
                    case 35:
                        $label_serie = "PO#";
                        $spanX = "span10 input-append";
                        break;
                    case 131:
                        $label_serie = traduz('numero.de.serie');
                        $spanX = "span8 input-append";
                        break;
                    case 160:
                        $label_serie = traduz('lote');
                        break;

                    default:
                        $label_serie = traduz('numero.de.serie');
                        break;
                } ?>
                <div class="span<?= $espaco2; ?>">
                    <div class='control-group <?=(in_array('produto[serie]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="produto_serie"><?=$label_serie?></label>
                        <i id='tooltip' class='icon-info-sign tooltip_serie' style="margin-left: 80px; display: none;" data-toggle="tooltip" type="button" title="Para alterar o número de série remova todas as peças lançadas."></i>
                    
                        <div class="controls controls-row">
                            <?
                            $span = "12";

                            if(in_array($login_fabrica, array(52,158,167,203))){ //hd_chamado=2891049
                                if($login_fabrica == 52){
                                    if($areaAdmin === false){
                                        $esconde_lupa = "style='display:none;'";
                                    }else{
                                        $esconde_lupa = "";
                                    }
                                }else{
                                    $span = "span11";
                                }

                                if ($login_fabrica == 158 && $postoInterno == true && !empty($os)) {
                                    $esconde_lupa = "style='display:none;'";
                                }

                                if ($login_fabrica == 52) {
                                    $serieClassNumeric = "numeric";
                                }
                                ?>
                                <div class="span12 input-append" id='fricon'>
                                    <? if ($regras["produto|serie"]["obrigatorio"] == true || ($login_fabrica == 158 && $postoInterno == true)) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    }
                                    $readonly = ((getValue('produto[sem_ns]') == 't')) ? "readonly='readonly'" : ""; ?>
                                    <script>
                                        function validaSeriaNS(){
                                            var value = $('#produto_serie').val();

                                            var valores = ['NS','N/S','SN','S/N'];
                                            <?php 
                                                if ($login_fabrica == 203){ 
                                            ?>
                                                if ( value.length == "" || value.length == undefined) {
                                                    alert('<?php echo traduz('informacao.incorreta.para.numero.de.serie');?>');
                                                    $('#produto_serie').val("");
                                                }
                                            <?php }else{ ?>
                                                if (valores.indexOf(value) > -1 || ( value.length != 15 && value.length != 21)) {
                                                    alert('<?php echo traduz('informacao.incorreta.para.numero.de.serie');?>');
                                                    $('#produto_serie').val("");
                                                }
                                            <?php } ?>
                                        }
                                    </script>
                                    <?php
                                        if(in_array($login_fabrica, array(167,203))) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                        }

                                        $maxlength_serie = (in_array($login_fabrica, [167,203])) ? 21 : 30;

                                    ?>
                                    <input id="produto_serie" name="produto[serie]" class="<?=$span?> <?=$serieClassNumeric?>" type="text" value="<?=getValue('produto[serie]')?>" maxlength="<?= $maxlength_serie ?>" <?= $readonly; ?>
                                        <?=(in_array($login_fabrica, array(167,203))) ? "onBlur='validaSeriaNS()'" : ""; ?>
                                    />
                                    <span class="add-on" rel="lupa_produto" <?=$esconde_lupa;?> style='cursor: pointer;'>
                                        <?= "<i class='icon-search'></i>"; ?>
                                    </span>
                                    <input type="hidden" name="lupa_config" tipo="produto" parametro="numero_serie" />
                                </div>
                            <? } else { ?>
                                <div class="<?=$spanX?>">
                                    <? if (in_array($login_fabrica, array(35,52,131,148,160,164,176,183)) or $replica_einhell) {

                                        if ($regras["produto|serie"]["obrigatorio"] == true) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                        }
                                    } else {
                                        if (strlen(getValue('produto[id]')) > 0 && getValue('produto[sem_ns]') != "t" && $login_fabrica != 145) {
                                            $sql = "SELECT produto FROM tbl_produto WHERE fabrica_i = {$login_fabrica} AND produto = ".getValue("produto[id]")." AND numero_serie_obrigatorio IS TRUE";
                                            $res = pg_query($con, $sql);

                                            if (pg_num_rows($res) > 0) {
                                                echo "<h5 class='asteristico'>*</h5>";
                                            }
                                        }
                                    }

                                    $readonly = (in_array($login_fabrica, array(148)) || (in_array($login_fabrica, array(156)) && getValue('produto[sem_ns]') == 't')) ? "readonly='readonly'" : "";
                                    if (in_array($login_fabrica, array(183))) {
                                        $readonly = "";
                                    } 
                                    $maxlength_serie = (in_array($login_fabrica, array(164))) ? 12 : 30;

                                    if (in_array($login_fabrica, array(164))) {
                                        $serieClassNumeric = "numeric";
                                    } ?>
                                    <input id="produto_serie" name="produto[serie]" class="span12 <?php echo $serieClassNumeric; ?> ns_serie" type="text" value="<?=getValue('produto[serie]')?>" maxlength="<?= $maxlength_serie; ?>" <?= $readonly; ?> />
                                    <?php if($login_fabrica == 35){?>
                                        <span class="add-on" id="info_po" title="Encontra-se na etiqueta de voltagem do aparelho. Caso o produto não possua número de série, entre em contato com o fabricante." >
                                            <i class="icon-info-sign" ></i>
                                        </span>
                                    <?php } ?>
                                </div>
                            <? } ?>
                            <script>
                                function desabilitar(valor) {
                                    if ($('.sem_ns').prop('checked')) {
                                        $('.ns_serie').attr('readonly', 'true');
                                        $('.ns_serie').val("Apagado");
                                    } else {
                                        $('.ns_serie').removeAttr('readonly');
                                        $('.ns_serie').val("");
                                    }
                                }
                            </script>
                    <?php 
                        if($login_fabrica == 164 AND $postoInterno == true){ ?>                                      
                            <div class="span12">
                            <?
                                $produto_sem_ns = getValue("produto[sem_ns]");
                                if($produto_sem_ns == 't' or strlen(trim(getValue("produto[partnumber]")))>0){
                                    $checked = " checked ";
                                } else {
                                    $checked = " ";
                            } ?>
                                <input type="checkbox" name="produto[sem_ns]" value="t" <?= $checked ?> id="sem_ns" class="sem_ns" onclick="desabilitar('sim')" >&nbsp;
                                <label class="control-label" for="produto_sem_ns"><?php echo traduz('numero.de.serie.apagado');?></label>
                            </div>
                    <?php } ?>
                        </div>
                    </div>
                </div>
            <? }
            if (in_array($login_fabrica,array(131,165,195))) { 
                $dataFabricacaoReadOnly = ($login_fabrica == 165) ? "readOnly" : "";

        if(in_array($login_fabrica,array(131,195))){
        ?>
            <div class="span1"></div>
        </div>

        <div class="row-fluid" >
            <div class="span1" ></div>
        <?
        }
        ?>
                <div class="span2">
                    <div class="control-group">
                        <label class="control-label" for="data_fabricacao"><?php echo traduz('data.fabricacao');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                        <h5 class='asteristico'>*</h5>
                                <input id="data_fabricacao" name="produto[data_fabricacao]" class="span12" type="text" <?=$dataFabricacaoReadOnly?> value="<?=getValue('produto[data_fabricacao]')?>" />
                            </div>
                        </div>
                    </div>
                </div>
            <? } ?>


            <?php if ($login_fabrica == 195) { ?>
                <div style="display: none;" class="span5" id="div_solicita_troca_produto_195">
                    <div class="control-group ">
                        <div class="controls controls-row">
                            <br />
                            <div class="span12">
                                <input type="radio" name="produto[solicita_troca_antecipada]" value="troca_produto_antecipado" <?php echo (getValue("produto[solicita_troca_antecipada]") == "troca_produto_antecipado") ? "checked" : "";?> id="solicita_troca_antecipada" >
                                <label class="control-label" for="solicita_troca_antecipada"><?php echo traduz('solicitar.troca.de.produto.antecipado');?></label>
                            <br />
                                <input type="radio" name="produto[solicita_troca_antecipada]" value="troca_produto" <?php echo (getValue("produto[solicita_troca_antecipada]") == "troca_produto") ? "checked" : "";?> id="solicita_troca_antecipada" >
                                <label class="control-label" for="solicita_troca_antecipada"><?php echo traduz('solicitar.troca.de.produto');?></label>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: none;" class="span5" id="div_solicita_troca_produto_orcamento_195">
                    <div class="control-group ">
                        <div class="controls controls-row">
                            <br />
                            <div class="span12">
                                <input type="radio" name="produto[solicita_troca_antecipada_orcamento]" value="troca_produto_antecipada_orcamento" <?php echo (getValue("produto[solicita_troca_antecipada_orcamento]") == "troca_produto_antecipada_orcamento") ? "checked" : "";?>  id="solicita_troca_antecipada_orcamento" >
                                <label class="control-label" for="solicita_troca_antecipada_orcamento"><?php echo traduz('solicitar.troca.de.produto.antecipado.orçamento');?></label>
                            <br />
                                <input type="radio" name="produto[solicita_troca_antecipada_orcamento]" <?php echo (getValue("produto[solicita_troca_antecipada_orcamento]") == "troca_produto_orcamento") ? "checked" : "";?> value="troca_produto_orcamento"  id="solicita_troca_antecipada_orcamento" >
                                <label class="control-label" for="solicita_troca_antecipada_orcamento"><?php echo traduz('solicitar.troca.de.produto.orçamento');?></label>
                            </div>
                        </div>
                    </div>
                </div>
            <?php } ?>



            <div class="span1"></div>
        </div>
        <? if (in_array($login_fabrica, array(158)) || $usaDefeitoReclamadoCadastro) { ?>
            <div class="row-fluid" >
                <div class="span1" ></div>
                <? if (in_array($login_fabrica, array(158))) { ?>
                    <div class="span4">
                        <div class='control-group <?=(in_array('produto[amperagem]', $msg_erro['campos'])) ? "error" : "" ?>' >
                            <label class="control-label" for="produto_amperagem"><?php echo traduz('amperagem.leitura.equip');?></label>
                            <div class="controls controls-row">
                                <div class="span8">
                                    <? if ($regras["produto|amperagem"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    } ?>
                                    <input id="produto_amperagem" name="produto[amperagem]" class="span12" type="text" value="<?=getValue('produto[amperagem]')?>" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="span3">
                        <div class='control-group <?=(in_array('produto[patrimonio]', $msg_erro['campos'])) ? "error" : "" ?>' >
                            <label class="control-label" for="patrimonio"><?php echo traduz('patrimonio');?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <? if ($login_fabrica == 158) {
                                        $tipo_atendimento = getValue('os[tipo_atendimento]');
                                        if (!empty($tipo_atendimento)) {
                                            $sql = "
                                                SELECT
                                                    tipo_atendimento
                                                FROM tbl_tipo_atendimento
                                                WHERE fabrica = {$login_fabrica}
                                                AND fora_garantia IS TRUE
                                                AND tipo_atendimento = {$tipo_atendimento};
                                            ";
                                            $res = pg_query($con,$sql);
                                        }
                                    }
                                    if ($regras["produto|patrimonio"]["obrigatorio"] == true || pg_num_rows($res) > 0) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    } ?>
                                    <input id="patrimonio" name="produto[patrimonio]" class="span12" type="text" value="<?=getValue('produto[patrimonio]')?>" maxlength="100" />
                                </div>
                            </div>
                        </div>
                    </div>
                <? }
                if ($usaDefeitoReclamadoCadastro) { ?>
                    <div class="<?=($login_fabrica == 178)? "span6":"span3" ?>" >
                        <input type="hidden" name="produto[familia]" id="produto_familia" value="<?= getValue('produto[familia]') ?>" />
                        <div class="control-group <?=(in_array('os[defeito_reclamado]', $msg_erro['campos'])) ? 'error' : ''?>" >
                            <label class="control-label" for="os_defeito_reclamado" ><?php echo traduz('defeito.reclamado');?></label>
                            <div class="controls controls-row" >
                                 <div class="<?=($login_fabrica == 178)? "span11":"span12" ?>" >
                                    <?php
                                    if ($regras["os|defeito_reclamado"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico' >*</h5>";
                                    }

                                    $whereTipoAtendimento = "";

                                    if ($login_fabrica == 158) {
                                        if ($os_fora_garantia == true) {
                                            $aux_garantia_dig = "f";
                                        }

                                        $tipo_atendimento = getValue('os[tipo_atendimento]');

                                        if (!empty($tipo_atendimento) && empty($aux_garantia_dig)) {
                                            $sql = "SELECT fora_garantia
                                                    FROM tbl_tipo_atendimento
                                                    WHERE fabrica = {$login_fabrica}
                                                    AND tipo_atendimento = {$tipo_atendimento}
                                            ";
                                            $res = pg_query($con,$sql);

                                            $fora_garantia    = pg_fetch_result($res, 0, fora_garantia);
                                            $aux_garantia_dig = ($fora_garantia == "t") ? "f" : "t";


                                            $whereTipoAtendimento = "AND tbl_diagnostico.garantia = '{$aux_garantia_dig}'";
                                        } else if (!empty($aux_garantia_dig)) {
                                            $whereTipoAtendimento = "AND tbl_diagnostico.garantia = '{$aux_garantia_dig}'";
                                        }
                                        $whereTipoAtendimento .= ($tipo_atendimento == 272)
                                            ? " AND tbl_diagnostico.tipo_atendimento = 272"
                                            : " AND COALESCE(tbl_diagnostico.tipo_atendimento, -1) <> 272";

                                    }

                                    if (strlen(getValue("produto[id]")) > 0) {
                                        if ($login_fabrica == 158 && $grupo_atendimento == "S") {
                                            $sqlDR = "
                                                SELECT defeito_reclamado, codigo, descricao
                                                FROM tbl_defeito_reclamado
                                                WHERE fabrica = {$login_fabrica}
                                                AND defeito_reclamado = ".getValue("os[defeito_reclamado]")."
                                            ";

                                            $defeito_readonly = true;
                                        } else {
                                            $cond_sa = (in_array($login_fabrica, array(158))) ? " AND tbl_defeito_reclamado.codigo != 'SA' " : "";
                                            $sqlDR = "SELECT DISTINCT
                                                        tbl_defeito_reclamado.defeito_reclamado,
                                                        tbl_defeito_reclamado.codigo,
                                                        tbl_defeito_reclamado.descricao
                                                    FROM tbl_diagnostico
                                                    INNER JOIN tbl_defeito_reclamado ON tbl_defeito_reclamado.defeito_reclamado = tbl_diagnostico.defeito_reclamado AND tbl_defeito_reclamado.fabrica = {$login_fabrica} AND tbl_defeito_reclamado.ativo IS TRUE
                                                    INNER JOIN tbl_familia ON tbl_familia.familia = tbl_diagnostico.familia AND tbl_familia.fabrica = {$login_fabrica}
                                                    INNER JOIN tbl_produto ON tbl_produto.familia = tbl_familia.familia AND tbl_produto.fabrica_i = {$login_fabrica}
                                                    WHERE tbl_diagnostico.fabrica = {$login_fabrica}
                                                    AND tbl_diagnostico.ativo IS TRUE
                                                    AND tbl_produto.produto = ".getValue("produto[id]")."
                                                    $cond_sa
                                                    {$whereTipoAtendimento}
                                                    ORDER BY tbl_defeito_reclamado.codigo ASC, tbl_defeito_reclamado.descricao ASC";

                                        }
                                    }

                                    if (in_array($login_fabrica, array(169,170)) && (isset($_GET['os_id']) || isset($_GET['preos']) || isset($_GET['chave_os_conjunto'])) && ($os_revenda != true || strlen(getValue('os[defeito_reclamado]')) > 0) && getValue("os[tipo_atendimento]") != "304") {
                                        $sqlDR = 'SELECT DISTINCT tbl_defeito_reclamado.descricao
                                                  FROM tbl_defeito_reclamado
                                                  WHERE defeito_reclamado = '.getValue("os[defeito_reclamado]");
                                        $resDR = pg_query($con, $sqlDR);
                                        $descricao_defeito_reclamado = pg_fetch_result($resDR, 0, 'descricao');
                                    ?>
                                        <input type="hidden" name="os[defeito_reclamado]" value="<?=getValue("os[defeito_reclamado]")?>">
                                        <input class="span10" type="text" name="desc_defeito_reclamado" readonly="readonly" value="<?=$descricao_defeito_reclamado?>">
                                    <? } else {

                                        if (in_array($login_fabrica, [169,170])) {

                                            $sqlVerificaAtendimento = "SELECT descricao
                                                                       FROM tbl_tipo_atendimento
                                                                       WHERE tipo_atendimento = ".getValue("os[tipo_atendimento]")."
                                                                       AND fabrica = {$login_fabrica}
                                                                       AND descricao = 'Triagem'
                                                                       ";
                                            $resVerificaAtendimento = pg_query($con, $sqlVerificaAtendimento);

                                            if (pg_num_rows($resVerificaAtendimento) > 0) {

                                                $sqlDR = "SELECT tbl_defeito_reclamado.defeito_reclamado, 
                                                                 tbl_defeito_reclamado.codigo, 
                                                                 tbl_defeito_reclamado.descricao
                                                          FROM tbl_diagnostico
                                                          JOIN tbl_tipo_atendimento ON tbl_diagnostico.tipo_atendimento = tbl_tipo_atendimento.tipo_atendimento
                                                          JOIN tbl_defeito_reclamado ON tbl_defeito_reclamado.defeito_reclamado = tbl_diagnostico.defeito_reclamado
                                                          WHERE tbl_tipo_atendimento.tipo_atendimento = ".getValue("os[tipo_atendimento]").
                                                          " AND tbl_tipo_atendimento.fabrica = {$login_fabrica}";

                                            }

                                        }

                                        $resDR = pg_query($con, $sqlDR);
                                    ?>

                                    <?php $campo_multiplo = ($login_fabrica == 158) ? 'name="os[defeito_reclamado][]" multiple="multiple"' : 'name="os[defeito_reclamado]" ';?>

                                    <select id="defeito_reclamado" class="span12" <?=$campo_multiplo?> >
                                        <? if (!$defeito_readonly) { ?>
                                            <option value=""><?php echo traduz('selecione');?></option>
                                        <? }
                                        if (isset($resDR)) {
                                            if (pg_num_rows($resDR) > 0) {
                                                while ($defeito_reclamado = pg_fetch_object($resDR)) {

                                                    if (isset($moduloTraducao)) {
                                                        $sqlIdiomaReclamado = "SELECT descricao 
                                                                                 FROM tbl_defeito_reclamado_idioma 
                                                                                 WHERE defeito_reclamado = {$defeito_reclamado->defeito_reclamado}
                                                                                 AND LOWER(idioma) = LOWER('$cook_idioma')";
                                                        $resIdiomaReclamado = pg_query($con, $sqlIdiomaReclamado);

                                                        if (pg_num_rows($resIdiomaReclamado) > 0) {
                                                            $defeito_reclamado->descricao = utf8_decode(pg_fetch_result($resIdiomaReclamado, 0, 'descricao'));
                                                        }

                                                    }

                                                    if($login_fabrica == 158){
                                                        $defeitos_reclamados = getValue("os[defeito_reclamado]");
                                                        print_r($defeitos_reclamados); 
                                                        $selected = "  ";
                                                        if(in_array($defeito_reclamado->defeito_reclamado, $defeitos_reclamados)){
                                                            $selected = " selected ";
                                                        }

                                                    }else{
                                                        $selected = ($defeito_reclamado->defeito_reclamado == getValue("os[defeito_reclamado]")) ? "selected" : "";    
                                                    }

                                                    if (in_array($login_fabrica, array(50,101,158,165,169,170))) {
                                                        echo "<option value='{$defeito_reclamado->defeito_reclamado}' {$selected} >{$defeito_reclamado->codigo} - {$defeito_reclamado->descricao}</option>";
                                                    } else {
                                                        echo "<option value='{$defeito_reclamado->defeito_reclamado}' {$selected} >{$defeito_reclamado->descricao}</option>";
                                                    }
                                                }
                                            }
                                        } ?>
                                    </select>
                                    <?php } ?>
                                </div>
                            </div>                            
                        </div>                        
                    </div>
                    <?php
                        if ($login_fabrica == 176) {
                        if ($areaAdmin === false)
                        {
                            if ($_REQUEST['mostrar_indice_aux'] == 't'){
                                $mostra_indice         = "";
                                 $mostra_produto_pecas = "display: none;";
                    ?>

                    <?php
                            }else{
                                $mostra_indice        = "style='display: none;'";
                                $mostra_produto_pecas = "";
                            }
                        }else if ($areaAdmin === true)
                        {
                            $mostra_produto_pecas = "";
                            if ($_REQUEST['mostrar_indice_aux'] == 't'){
                                $mostra_indice = "";
                            }else{
                                $mostra_indice = "style='display: none;'";
                            }
                        }
                    ?>
                        <input type='hidden' name='mostrar_indice_aux' id='mostrar_indice_aux' value='<?php echo (getValue('mostrar_indice_aux') != '') ? getValue('mostrar_indice_aux') : 'f'; ?>' />
                        <div class="span4" id="div_os_indice" <?php echo $mostra_indice; ?>>
                            <div class='control-group <?=(in_array('os[indice]', $msg_erro['campos'])) ? "error" : "" ?>'>
                                <label class="control-label" for="os_indice"><?php echo traduz('indice');?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <?php if ($regras["os|indice"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                        } ?>
                                        <input id="os_indice" name="os[indice]" class="span12" type="text" max="99999999" value="<?php echo (getValue('os[indice]') != '') ? getValue('os[indice]') : ''; ?>" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?php
                        }
                    if (in_array($login_fabrica, array(173,174,184,186,190,191,193,195,198,200))) { ?>
                        <div class="<?= (in_array($login_fabrica, [193])) ? 'span3' : 'span3'; ?>" id="div_defeito_reclamado">
                            <div class='control-group <?=(in_array('os[defeito_reclamado_descricao]', $msg_erro['campos'])) ? "error" : "" ?>'>
                                <label class="control-label" for="defeito_reclamado_descricao"><?php echo traduz('defeito.reclamado.cliente');?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <? if ($regras["os|defeito_reclamado_descricao"]["obrigatorio"] == true) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                        } ?>
                                        <input id="defeito_reclamado_descricao" name="os[defeito_reclamado_descricao]" class="span12" type="text" value="<?=getValue('os[defeito_reclamado_descricao]')?>" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?php } ?>
                    <?php if (in_array($login_fabrica, array(183))) { ?>
                        <div class="span4" id="div_defeito_reclamado">
                            <div class='control-group <?=(in_array('os[defeito_reclamado_descricao]', $msg_erro['campos'])) ? "error" : "" ?>'<?= ($areaAdmin == true) ? "" : "style='display:none'"?>>
                                <label class="control-label" for="defeito_reclamado_descricao"><?php echo traduz('defeito.reclamado.cliente');?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <textarea id="defeito_reclamado_descricao" name="os[defeito_reclamado_descricao]" class="span12" type="text" /><?=getValue('os[defeito_reclamado_descricao]')?></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?php } ?>
                <? }
                if (in_array($login_fabrica, array(171))) {
                ?>
                    <div class="span3">
                        <div class='control-group <?=(in_array('os[tempo_uso]', $msg_erro['campos'])) ? "error" : "" ?>'>
                            <label class="control-label" for="tempo_uso"><?php echo traduz('tempo.de.uso.mes');?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <? if ($regras["os|tempo_uso"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    } ?>
                                    <input id="tempo_uso" name="os[tempo_uso]" class="span12" type="number" value="<?=getValue('os[tempo_uso]')?>" />
                                </div>
                            </div>
                        </div>
                    </div>
                <?php
                }
                if (in_array($login_fabrica, array(167,203))) { //HD-3428328 ?>
                    <div class="span3" id="contador" <?=$display_contador?>>
                        <div class="control-group <?=(in_array('produto[contador]', $msg_erro['campos'])) ? 'error' : ''?>">
                            <label class="control-label" for="os_contato"><?= ($login_fabrica == 203) ? traduz("Contador/Horas Trabalhadas") : traduz('contador') ?> </label>
                            <div class="controls controls-row">
                                <h5 class='asteristico contador' <?=$display_asteristico?> >*</h5>
                                <div class="span10">
                                    <input name="produto[contador]" maxlength="6" class="span12 numeric" type="text" value="<?=getValue('produto[contador]')?>"/>
                                    <input name="produto[valida_contador]" id="valida_contador" type="hidden" value="<?=$valida_contador?>">
                                </div>
                            </div>
                        </div>
                    </div>
                <? } ?>
                <?php if ($login_fabrica == 178) {?>

                    <div class="span3">
                        <div class="control-group <?=(in_array("produto[defeito_constatado_grupo]", $msg_erro['campos'])) ? "error" : "" ?>">
                            <label class="control-label" for="defeito_constatado_grupo"><?php echo traduz("grupo.defeito.constatado");?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <select  name="produto[defeito_constatado_grupo]" class="span12 defeito_constatado_grupo">
                                        <option value="">Selecione ...</option>
                                        <?php
                                            if (strlen(getValue('produto[defeito_constatado_grupo]')) > 0) {
                                                $xdefeito_constatado_grupo = getValue('produto[defeito_constatado_grupo]');
                                            }
                                            $sql = "
                                                SELECT DISTINCT
                                                    tbl_defeito_constatado_grupo.descricao,
                                                    tbl_defeito_constatado_grupo.defeito_constatado_grupo
                                                FROM tbl_defeito_constatado_grupo
                                                WHERE tbl_defeito_constatado_grupo.fabrica = $login_fabrica
                                                ORDER BY tbl_defeito_constatado_grupo.descricao ASC";
                                            
                                            $res = pg_query($con, $sql);

                                            if (pg_num_rows($res) > 0) {
                                                while ($result = pg_fetch_object($res)) {
                                                    $selected = ($result->defeito_constatado_grupo == $xdefeito_constatado_grupo) ? "selected" : "";
                                                ?>
                                                    <option value='<?=$result->defeito_constatado_grupo?>' <?=$selected?> <?=$disabled?> >
                                                        <?=$result->descricao; ?>
                                                    </option>
                                                <?php 
                                                }
                                            }
                                        ?>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                <?php }?>
                <div class="span1"></div>
            </div>
        <? } ?>
       
        <?php if (in_array($login_fabrica, array(169,170))) {
            $produto_retirado_oficina = getValue("produto[retirado_oficina]");
            $produto_emprestimo = getValue("produto[emprestimo]");
            if ($produto_retirado_oficina == 't' || $produto_emprestimo == 't') {
                $display_produto_retirado = "style='display:block;'";
            } else {
                $tipo_atendimento = getValue("os[tipo_atendimento]");
                if (!empty($tipo_atendimento)) {
                    $sqlKmGoogle = "SELECT km_google FROM tbl_tipo_atendimento WHERE fabrica = {$login_fabrica} AND tipo_atendimento = {$tipo_atendimento};";
                    $resKmGoogle = pg_query($con,$sqlKmGoogle);

                    if (pg_num_rows($resKmGoogle) > 0) {
                        $km_google = pg_fetch_result($resKmGoogle, 0, km_google);

                        if ($km_google == 't') {
                            $display_produto_retirado = "style='display:block;'";
                        }
                    }
                }
            } ?>
            <div class="row-fluid" id='div_produto_retirado' <?= $display_produto_retirado; ?>>
                <div class="span1"></div>
                <div class="span5">
                    <div class="control-group <?=(in_array('produto[retirado_oficina]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <div class="controls controls-row">
                            <br />
                            <div class="span12">
                                <? $checkedRetirado = ($produto_retirado_oficina == 't') ? "checked" : ""; ?>
                                <input type="checkbox" name="produto[retirado_oficina]" value="t" <?= $checkedRetirado; ?> id="produto_retirado_oficina" />
                                <label class="control-label" for="produto_retirado_oficina"> <?php echo traduz('produto.retirado.para.a.oficina');?></label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="span5">
                    <div class="control-group <?=(in_array('produto[emprestimo]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <div class="controls controls-row">
                            <br />
                            <div class="span12">
                                <? $checkedEmprestimo = ($produto_emprestimo == 't') ? "checked" : ""; ?>
                                <input type="checkbox" name="produto[emprestimo]" value="t" <?= $checkedEmprestimo; ?> id="produto_emprestimo" />
                                <label class="control-label" for="produto_emprestimo"> <?php echo traduz('emprestimo.de.produto.ao.consumidor');?></label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="span1"></div>
            </div>
        <? }
        if ($login_fabrica == 158) { ?>
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span3">
                    <div class="control-group <?= (in_array('os[nota_fiscal]', $msg_erro['campos'])) ? 'error' : ''; ?>">
                        <label class="control-label" for="nota_fiscal"> <?php echo traduz('nota.fiscal');?></label>
                        <? if ((isset($valida_anexo)) || $anexo_obrigatorio) {
                        ?>
                            <strong style="color:#B94A48" id="nota_obrigatoria">(<?php echo traduz('anexo.obrigatorio');?>)</strong>
                        <? } ?>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if ($regras["os|nota_fiscal"]["obrigatorio"] == true ) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                } ?>
                                <input id="nota_fiscal" name="os[nota_fiscal]" class="span12" type="text" value="<?=getValue('os[nota_fiscal]')?>" maxlength="20" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="span2">
                    <div class="control-group <?=(in_array('os[data_fabricacao]', $msg_erro['campos'])) ? 'error' : '' ?>">
                        <label class="control-label" for="data_fabricacao"><?php echo traduz('data.fabricacao');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if ($regras["os|data_fabricacao"]["obrigatorio"] == true ) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                } ?>
                                <input id="data_fabricacao" name="os[data_fabricacao]" class="span12" type="text" value="<?=getValue('os[data_fabricacao]')?>" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="span2">
                    <div class="control-group <?=(in_array('os[data_venda]', $msg_erro['campos'])) ? 'error' : '' ?>">
                        <label class="control-label" for="data_venda"><?php echo traduz('data.venda');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if ($regras["os|data_venda"]["obrigatorio"] == true ) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                } ?>
                                <input id="data_venda" name="os[data_venda]" class="span12" type="text" value="<?=getValue('os[data_venda]')?>" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class='span1'></div>
            </div>
        <? }
        if (in_array($login_fabrica, array(148))) { ?>
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span2">
                    <div class='control-group <?=(in_array('produto[horimetro]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="produto_horimetro"><?php echo traduz('horimetro');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if ($regras["produto|horimetro"]["obrigatorio"] == true) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                } ?>
                                <input id="produto_horimetro" name="produto[horimetro]" class="span11 numeric" type="text" maxlength="7" value="<?=getValue('produto[horimetro]')?>" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="span8 box_intervalo_revisao" style='display: none;' >
                    <div class='control-group <?=(in_array('produto[revisao]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="produto_intervalo_revisao"><?php echo traduz('revisao');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <h5 class='asteristico'>*</h5>
                                <div class="input-prepend input-append">
                                    <? if (empty($os)) { ?>
                                        <span class="add-on regra_revisao" data-revisao-acao="-" style="cursor: pointer;"><strong>-</strong></span>
                                        <input id="produto_intervalo_revisao" name="produto[revisao]" class="span2 numeric" maxlength="7" type="text" value="<?=getValue('produto[revisao]')?>" readonly="readonly" />
                                        <span class="add-on regra_revisao" data-revisao-acao="+" style="cursor: pointer;"><strong>+</strong></span>
                                        <label class="label label-info selecionar_revisoes" style="margin-left: 10px; line-height: normal;" >  <?php echo traduz('use.os.botoes.de./.ou.clique.aqui.para.selecionar.a.revisao');?></label>
                                    <? } else { ?>
                                        <input id="produto_intervalo_revisao" name="produto[revisao]" class="span8 numeric" maxlength="7" type="text" value="<?=getValue('produto[revisao]')?>" readonly="readonly" />
                                    <? } ?>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row-fluid alert-tolerancia" style="min-height: auto !important; display: none;" >
                <div class="span1" ></div>
                <div class="span4" >
                    <label class="label label-important" ><?php echo traduz('horimetro.esta.fora.da.tolerancia.da.revisao');?></label>
                </div>
            </div>
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span3">
                    <div class='control-group <?=(in_array('produto[serie_motor]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="produto_serie_motor"> <?php echo traduz('serie.motor');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if ($regras["produto|serie_motor"]["obrigatorio"] == true) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                } ?>
                                <input id="produto_serie_motor" name="produto[serie_motor]" class="span12" type="text" value="<?=getValue('produto[serie_motor]')?>" readonly="readonly" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="span3">
                    <div class='control-group <?=(in_array('produto[serie_transmissao]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="produto_serie_transmissao"> <?php echo traduz('serie.transmissao');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if ($regras["produto|serie_transmissao"]["obrigatorio"] == true) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                } ?>
                                <input id="produto_serie_transmissao" name="produto[serie_transmissao]" class="span12" type="text" value="<?=getValue('produto[serie_transmissao]')?>" readonly="readonly" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="span1"></div>
                <div class="span3 div_produto_em_estoque" style="display: none;">
                    <div class='control-group' >
                        <input type="checkbox" id="produto_em_estoque" name="produto[produto_em_estoque]" <?php echo (getValue('produto[produto_em_estoque]') == 'sim') ? 'checked' : ''; ?> >
                        <label for="produto_em_estoque"><?=traduz('Produto em Estoque')?></label>
                    </div>
                </div>
                <div class="span1"></div>
            </div>
        <? }
        if($login_fabrica == 52) { ?>
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span4">
                    <input type="hidden" name="produto[familia]" id="produto_familia" value="<?php echo getValue('produto[familia]') ?>" />
                    <div class="control-group <?=(in_array('produto[grupo_defeito_constatado]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="produto_grupo_defeito_constatado"><?php echo traduz('grupo.defeito.constatado');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if ($regras["produto|grupo_defeito_constatado"]["obrigatorio"] == true) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                } ?>
                                <select id="produto_grupo_defeito_constatado" name="produto[grupo_defeito_constatado]" class="span12" >
                                    <option value=""><?php echo traduz('selecione');?></option>
                                    <?
                                    $sql = "SELECT DISTINCT
                                            tbl_defeito_constatado_grupo.defeito_constatado_grupo,
                                            tbl_defeito_constatado_grupo.grupo_codigo,
                                            tbl_defeito_constatado_grupo.descricao
                                        FROM tbl_defeito_constatado_grupo
                                            JOIN tbl_defeito_constatado ON tbl_defeito_constatado.defeito_constatado_grupo = tbl_defeito_constatado_grupo.defeito_constatado_grupo
                                            JOIN tbl_diagnostico ON tbl_diagnostico.defeito_constatado = tbl_defeito_constatado.defeito_constatado
                                                AND tbl_diagnostico.fabrica = $login_fabrica
                                                AND tbl_diagnostico.ativo IS TRUE                                            
                                        WHERE tbl_defeito_constatado_grupo.ativo IS TRUE
                                            AND tbl_defeito_constatado_grupo.fabrica = $login_fabrica
                                            AND tbl_diagnostico.familia = ".getValue("produto[familia]")."
                                            AND tbl_defeito_constatado.ativo IS TRUE
                                        ORDER BY descricao ASC";

                                    $res = pg_query($con, $sql);

                                    if (pg_num_rows($res) > 0) {
                                        while ($result = pg_fetch_object($res)) {
                                            $selected = ($result->defeito_constatado_grupo == getValue("produto[grupo_defeito_constatado]")) ? "selected" : "";
                                            echo "<option value='{$result->defeito_constatado_grupo}' {$selected} >{$result->descricao}</option>";
                                        }
                                    } ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span3">
                    <div class="control-group <?=(in_array('produto[defeito_constatado]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="produto_defeito_constatado"><?php echo traduz('defeito.constatado');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if ($regras["produto|defeito_constatado"]["obrigatorio"] == true || $login_fabrica == 190) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                } ?>
                                <select id="produto_defeito_constatado" name="produto[defeito_constatado]" class="span12" >
                                    <option value=""><?php echo traduz('selecione');?></option>                                    
                                    <? if (strlen($produto) > 0) {

                                        $defeito_constatado_grupo = getValue("produto[grupo_defeito_constatado]");
                                        $familia = getValue("produto[familia]");
                                        $posto = getValue("posto[id]");                                                    

                                        if(strlen(trim($defeito_constatado_grupo))>0){
                                            $sql = "SELECT DISTINCT
                                                tbl_defeito_constatado.defeito_constatado,
                                                tbl_defeito_constatado.descricao,
                                                tbl_defeito_constatado.lancar_peca
                                            FROM tbl_defeito_constatado
                                            JOIN tbl_diagnostico USING(fabrica,defeito_constatado)
                                            JOIN tbl_posto_fabrica USING(tabela_mao_obra)
                                            WHERE
                                                tbl_defeito_constatado.defeito_constatado_grupo = $defeito_constatado_grupo
                                                AND tbl_defeito_constatado.ativo
                                                AND tbl_diagnostico.ativo
                                                AND tbl_posto_fabrica.fabrica = $login_fabrica
                                                AND tbl_posto_fabrica.posto = $posto
                                                AND tbl_diagnostico.familia = $familia
                                                AND tbl_defeito_constatado.ativo IS TRUE";
                                                
                                            $res = pg_query($con, $sql);
                                        }

                                        if (pg_num_rows($res) > 0) {
                                            while ($result = pg_fetch_object($res)) {
                                                $selected = ($result->defeito_constatado == getValue("produto[defeito_constatado]")) ? "selected" : "";

                                                echo "<option value='{$result->defeito_constatado}' data-lancar-pecas='{$result->lancar_peca}'  {$selected} >{$result->descricao}</option>";
                                            }
                                        }
                                    } ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span3">
                    <div class="control-group <?=(in_array('produto[solucao]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="solucao"><?php echo traduz('solucao');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if ($regras["produto|solucao"]["obrigatorio"] == true) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                } ?>
                                <select id="solucao" name="produto[solucao]" class="span12">
                                    <option value=""><?php echo traduz('selecione');?></option>

                                    <? if (strlen(getValue('produto[id]')) > 0) {

                                        $defeito_constatado = getValue('produto[defeito_constatado]');

                                        if(strlen($defeito_constatado) > 0){

                                            $sql = "SELECT
                                                 tbl_solucao.solucao,
                                                 tbl_solucao.descricao
                                            FROM tbl_defeito_constatado_solucao
                                            INNER JOIN tbl_solucao ON tbl_solucao.solucao = tbl_defeito_constatado_solucao.solucao AND tbl_solucao.fabrica = {$login_fabrica} AND tbl_solucao.ativo IS TRUE
                                            WHERE
                                                tbl_defeito_constatado_solucao.defeito_constatado = {$defeito_constatado}
                                                AND tbl_defeito_constatado_solucao.fabrica = {$login_fabrica}
                                                AND tbl_defeito_constatado_solucao.ativo IS TRUE
                                                AND tbl_solucao.ativo IS TRUE";
                                            $res = pg_query($con, $sql);

                                            $contadorSQL = pg_num_rows($res);

                                            if($contadorSQL > 0){

                                                for($i = 0; $i < $contadorSQL; $i++){

                                                    $solucao = pg_fetch_result($res, $i, "solucao");
                                                    $descricao = pg_fetch_result($res, $i, "descricao");

                                                    $selected = ($solucao == getValue("produto[solucao]")) ? "SELECTED" : "";

                                                    echo "<option value='{$solucao}' {$selected} >{$descricao}</option>";

                                                }
                                            }
                                        }
                                    } ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <? } else {
            $os_sem_pedido = false;
            if(in_array($login_fabrica, array(157,171,178,183,203)) && ($areaAdmin === true || in_array($login_fabrica, array(171,178,183))) && strlen($os) > 0){
                $os_sem_pedido = true;
                $produto_mostra_trocar = "style='display: block;'";

                $sql_pedido_os = "SELECT pedido FROM tbl_os_item WHERE os_produto IN (SELECT os_produto FROM tbl_os_produto WHERE os = {$os}) AND pedido NOTNULL";
                $res_pedido_os = pg_query($con, $sql_pedido_os);

                if(pg_num_rows($res_pedido_os) > 0){
                    $produto_mostra_trocar = "style='display: none;'";
                    $os_sem_pedido = false;
                }

                if ($login_fabrica == 178 AND empty($produto)){
                    $produto_mostra_trocar = "style='display: none;'";
                }

            }

            if (in_array($login_fabrica, array(153,156,162)) || isset($reparoNaFabrica)) {
                if (in_array($login_fabrica, array(153,162))) {
                    $linha_prod_s_ns = "linha_prod_s_ns";
                } else {
                    $linha_prod_s_ns = " ";
                } ?>
                <div class='row-fluid <?=$linha_prod_s_ns?>' <?=$produto_mostra_trocar?> >
                    <div class="span1"></div>
                    <? if (in_array($login_fabrica, array(153,156,162))) { ?>
                        <div class="span3" id="prod_s_ns" <?=$produto_mostra_trocar?> >
                            <div class="control-group <?=(in_array('produto[sem_ns]', $msg_erro['campos'])) ? "error" : "" ?>">
                                <label class="control-label" for="produto_sem_ns"><?php echo traduz('produto.sem.numero.de.serie');?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <?
                                        $produto_sem_ns = getValue("produto[sem_ns]");
                                        if($produto_sem_ns == 't' or strlen(trim(getValue("produto[partnumber]")))>0){
                                            $checked = " checked ";
                                            $produto_msg_fora_garantia = "style='display:block;'";
                                        } else {
                                            $checked = " ";
                                            $produto_msg_fora_garantia = "style='display:none;'";
                                        } ?>
                                        <input type="checkbox" name="produto[sem_ns]" value="t" <?= $checked ?> id="sem_ns" >
                                    </div>
                                </div>
                            </div>
                        </div>
                    <? }
                    if ($login_fabrica == 162) { ?>
                        <div class="span3" id="partnumber" <?=$produto_mostra_partNumber?> >
                            <div class="control-group <?=(in_array('produto[partnumber]', $msg_erro['campos'])) ? "error" : "" ?>">
                                <label class="control-label" for="partnumber"><?php echo traduz('n.serie.item.agregado');?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <h5 class='asteristico'>*</h5>
                                        <input type="text" name="produto[partnumber]"  id="partnumber_campo" value="<?= getValue("produto[partnumber]") ?>"  maxlength="10" class="span12">
                                    </div>
                                </div>
                            </div>
                        </div>
                    <? }
                    if ($login_fabrica == 165) { ?>
                        <div class="span7" id="msg_fora_garantia" <?=$produto_msg_fora_garantia?>>
                            <div class="control-group">
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <div class="alert alert-error">
                                            <?php echo traduz('produto.fora.de.garantia.para.validar.a.garantia.informe.o.numero.da.nota.fiscal.data.de.compra.e.anexe.a.imagem.da.nota.fiscal');?>
                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <? }
                    if ($reparoNaFabrica && $postoInterno != true) { ?>
                        <div class="span3" id="reparoNaFabrica">
                            <div class="control-group <?=(in_array('produto[produto_reparo_fabrica]', $msg_erro['campos'])) ? "error" : "" ?>">
                                <label class="control-label" for="produto_reparo_fabrica">  <?php echo traduz('reparar.na.fabrica');?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <?
                                        $produto_reparo_fabrica = getValue("produto[produto_reparo_fabrica]");

                                        if( $produto_reparo_fabrica == 't'){
                                            $checked = "checked";
                                        }else{
                                            $checked = "";
                                        }
                                        ?>
                                        <input type="checkbox" name="produto[produto_reparo_fabrica]" value="t" id="produto_reparo_fabrica" <?=$checked?> />
                                    </div>
                                </div>
                            </div>
                        </div>
                    <? } ?>
                    
                </div>
                <? if ($login_fabrica == 156) {
                    if ($postoInterno != true && getValue("produto[produto_reparo_fabrica]") != "t") {
                        $display_nf_envio = "style='display: none;'";
                        $id_linha_nf_envio = ' id="linha_nf_envio" ';
                    } else if ($postoInterno == true && $areaAdmin == true) {
                        $display_nf_envio = '';
                        $id_linha_nf_envio = '';
                    } ?>
                    <div class="row-fluid div_posto_interno" <?= $id_linha_nf_envio; ?> <?= $display_nf_envio; ?> >
                        <div class="span1"></div>
                        <div class="span3">
                            <div class="control-group <?=(in_array('os[nf_envio]', $msg_erro['campos'])) ? "error" : "" ?>">
                                <label class="control-label" for="nf_envio"><?=($postoInterno == true) ? traduz('nf.de.recebimento') : traduz('nf.de.envio')?></label>
                                <div class="controls controls-row">
                                    <h5 class='asteristico'>*</h5>
                                    <div class="span12">
                                        <input id="nf_envio" name="os[nf_envio]" class="span12" type="text" value="<?= getValue('os[nf_envio]'); ?>" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="span3">
                            <div class="control-group <?=(in_array('os[data_nf_envio]', $msg_erro['campos'])) ? "error" : "" ?>">
                                <label class="control-label" for="data_nf_envio" > <?=($postoInterno == true) ? traduz('data.nf.de.recebimento') : traduz('data.nf.de.envio')?></label>
                                <div class="controls controls-row">
                                    <h5 class='asteristico'>*</h5>
                                    <div class="span12">
                                        <input id="data_nf_envio" name="os[data_nf_envio]" class="span12" type="text" value="<?= getValue('os[data_nf_envio]'); ?>" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="span3">
                            <div class="control-group <?=(in_array('os[valor_nf_envio]', $msg_erro['campos'])) ? "error" : "" ?>">
                                <label class="control-label" for="os_valor_nf_envio"><?=($postoInterno == true) ? traduz('valor.nf.de.recebimento') : traduz('valor.nf.de.envio')?></label>
                                <div class="controls controls-row">
                                    <h5 class='asteristico'>*</h5>
                                    <div class="span12">
                                        <input id="os_valor_nf_envio" name="os[valor_nf_envio]" class="span12" type="text" value="<?=getValue('os[valor_nf_envio]')?>" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <? if ($login_fabrica == 156 && $areaAdmin == true && $postoInterno == true) { ?>
                        <div class="row-fluid">
                            <div class="span1"></div>
                            <div class="span3">
                                <div class="control-group <?=(in_array('os[nf_retorno]', $msg_erro['campos'])) ? "error" : "" ?>">
                                    <label class="control-label" for="nf_retorno"><?php echo traduz("nf.de.retorno");?></label>
                                    <div class="controls controls-row">
                                        <div class="span12">
                                            <input id="os_nf_retorno" name="os[nf_retorno]" class="span12" type="text" value="<?= getValue('os[nf_retorno]'); ?>" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="span3">
                                <div class="control-group <?=(in_array('os[data_nf_retorno]', $msg_erro['campos'])) ? "error" : "" ?>">
                                    <label class="control-label" for="data_nf_retorno" ><?php echo traduz("data.nf.de.retorno");?></label>
                                    <div class="controls controls-row">
                                        <div class="span12">
                                            <input id="os_data_nf_retorno" name="os[data_nf_retorno]" class="span12" type="text" value="<?= getValue('os[data_nf_retorno]'); ?>" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="span3">
                                <div class="control-group <?=(in_array('os[valor_nf_retorno]', $msg_erro['campos'])) ? "error" : "" ?>">
                                    <label class="control-label" for="valor_nf_retorno"><?php echo traduz("valor.nf.de.retorno");?></label>
                                    <div class="controls controls-row">
                                        <div class="span12">
                                            <input id="os_valor_nf_retorno" name="os[valor_nf_retorno]" class="span12" type="text" value="<?=getValue('os[valor_nf_retorno]')?>" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <? }
                }
            }

            if($os_sem_pedido === true){
            ?>

            <div class='row-fluid div_pr' <?=(in_array($login_fabrica, array(178,183))? "style='display:none'" : "")?> id="div_trocar_produto" <?= $produto_mostra_trocar; ?>>

                <div class="span1"></div>

                <div class="span10">
                    <div style='padding-top: 10px; padding-bottom: 10px;'>
                        <button type="button" id="#trocar_produto" class="btn btn-danger" ><?php echo traduz("alterar.produto");?></button>
                    </div>
                </div>

            </div>

            <?php

            }

            if ($login_fabrica == 160) { ?>
                <div class="row-fluid">
                 <div class="span1"></div>

                    <div class="span3" id="prod_versao">
                        <div class="control-group <?=(in_array('produto[versao]', $msg_erro['campos'])) ? "error" : "" ?>">
                            <label class="control-label" for="produto_versao"><?php echo traduz("versao.do.produto");?></label>
                            <div class="controls controls-row">
                                <?php if ($regras["produto|versao"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                }?>
                                <div class="span12">
                                    <input type="text" name="produto[versao]" maxlength="10" value="<?=getValue('produto[versao]')?>"  id="versao_produto" class="span12">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="span3">
                        <div class="control-group <?=(in_array('produto[fora_garantia]', $msg_erro['campos'])) ? "error" : "" ?>">
                            <label class="control-label" for="produto_fora_garantia"><?php echo traduz("produto.fora.de.garantia");?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <?php
                                        $produto_fora_garantia = getValue("produto[fora_garantia]");

                                    if( $produto_fora_garantia == '17'){
                                            $checked = " checked ";
                                        }else{
                                            $checked = " ";
                                        }?>
                                    <input type="checkbox" name="produto[fora_garantia]" value="17" <?= $checked ?> id="fora_garantia">
                                </div>
                            </div>
                        </div>
                    </div>
                <? }
                if($login_fabrica == 160 or $replica_einhell){
                    $fora_garantia = $campos['produto']['fora_garantia'];

                    if(strlen(trim($fora_garantia)) > 0){
                        $mostra_produto_pecas = "display: none;";
                        $mostra_comunicado_laudo = "display: block;";
                    }else{
                        $mostra_comunicado_laudo = "display: none;";
                    }
                }

                if ($login_fabrica == 158 && $grupo_atendimento == "S") {
                    $hide_defeito_constatado = true;
                }
                ?>
                <div class="row-fluid">
                <div class="span1"></div>

                <?if($login_fabrica == 162){ ?>
                    <div class="span3 campo_imei" <?php echo $mostra_campo_imei ?>>

                        <div class="control-group <?=(in_array('produto[imei]', $msg_erro['campos'])) ? "error" : "" ?>" >
                            <label class="control-label" for="imei">IMEI</label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <h5 class='asteristico'>*</h5>
                                    <input type="text" name="produto[imei]"  value="<?= getValue("produto[imei]") ?>" id="imei" maxlength="18" class="span12 numeric">
                                </div>
                            </div>
                        </div>
                    </div>
                <? }
                
                if ($defeitoReclamadoCadastroDefeitoReclamadoCliente) { ?>
                        <div class="span3" >
                            <input type="hidden" name="produto[familia]" id="produto_familia" value="<?= getValue('produto[familia]') ?>" />
                            <div class="control-group <?=(in_array('os[defeito_reclamado]', $msg_erro['campos'])) ? 'error' : ''?>" >
                                <label class="control-label" for="os_defeito_reclamado" >Defeito Reclamado</label>
                                <div class="controls controls-row" >
                                    <div class="span12" >
                                    <?php
                                        if (strlen(getValue("produto[id]")) > 0) {

                                            if ($login_fabrica == 175){
                                                $joinLinhaFamilia = " 
                                                    INNER JOIN tbl_linha ON tbl_linha.linha = tbl_diagnostico.linha AND tbl_linha.fabrica = {$login_fabrica} 
                                                    INNER JOIN tbl_produto ON tbl_produto.linha = tbl_linha.linha AND tbl_produto.fabrica_i = {$login_fabrica}
                                                ";
                                            }else{
                                                $joinLinhaFamilia = " 
                                                    INNER JOIN tbl_familia ON tbl_familia.familia = tbl_diagnostico.familia AND tbl_familia.fabrica = {$login_fabrica} 
                                                    INNER JOIN tbl_produto ON tbl_produto.familia = tbl_familia.familia AND tbl_produto.fabrica_i = {$login_fabrica}
                                                ";    
                                            }
                                            $sqlDR = "SELECT DISTINCT
                                                    tbl_defeito_reclamado.defeito_reclamado,
                                                    tbl_defeito_reclamado.codigo,
                                                    tbl_defeito_reclamado.descricao
                                                FROM tbl_diagnostico
                                                INNER JOIN tbl_defeito_reclamado ON tbl_defeito_reclamado.defeito_reclamado = tbl_diagnostico.defeito_reclamado AND tbl_defeito_reclamado.fabrica = {$login_fabrica} AND tbl_defeito_reclamado.ativo IS TRUE
                                                {$joinLinhaFamilia}
                                                WHERE tbl_diagnostico.fabrica = {$login_fabrica}
                                                AND tbl_diagnostico.ativo IS TRUE
                                                AND tbl_produto.produto = ".getValue("produto[id]")."
                                                ORDER BY tbl_defeito_reclamado.codigo ASC, tbl_defeito_reclamado.descricao ASC";
                                            $resDR = pg_query($con, $sqlDR);
                                        }
                                    ?>
                                        <h5 class='asteristico'>*</h5>
                                        <select id="defeito_reclamado" class="span12" name="os[defeito_reclamado]" >
                                            <?php if (!$defeito_readonly) { ?>
                                                <option value="">Selecione</option>
                                            <? } ?>
                                            <?php 
                                                if (isset($resDR)) {
                                                    if (pg_num_rows($resDR) > 0) {
                                                        while ($defeito_reclamado = pg_fetch_object($resDR)) {
                                                            $selected = ($defeito_reclamado->defeito_reclamado == getValue("os[defeito_reclamado]")) ? "selected" : "";
                                                            echo "<option value='{$defeito_reclamado->defeito_reclamado}' {$selected} >{$defeito_reclamado->descricao}</option>";
                                                            
                                                        }
                                                    }
                                                }
                                            ?>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <?php
                        if (!in_array($login_fabrica, [175])) {
                        ?>
                            <div class="span4" id="div_defeito_reclamado">
                                <div class='control-group <?=(in_array('os[defeito_reclamado_descricao]', $msg_erro['campos'])) ? "error" : "" ?>'>
                                    <label class="control-label" for="defeito_reclamado_descricao">Defeito Reclamado Cliente</label>
                                    <div class="controls controls-row">
                                        <div class="span12">
                                            <? if ($regras["os|defeito_reclamado_descricao"]["obrigatorio"] == true) {
                                                echo "<h5 class='asteristico'>*</h5>";
                                            } ?>
                                            <input id="defeito_reclamado_descricao" name="os[defeito_reclamado_descricao]" class="span12" type="text" value="<?=getValue('os[defeito_reclamado_descricao]')?>" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <? 
                        }
                    }
                    
                    if (in_array($login_fabrica, array(175))) {
                    ?>
                        <div class="span4">
                            <?php
                            if ($areaAdmin === true AND !empty($_RESULT["os"]["sua_os"])){
                                $login_posto = $_RESULT["posto"]["id"];
                            }
                            ?>
                            <div class="control-group <?=(in_array('tecnico', $msg_erro['campos'])) ? "error" : "" ?>" >
                                <label class="control-label" for="tecnico">Técnico</label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <select id="tecnico" name="os[tecnico]" class="span12" >
                                            <option value="">Selecione</option>
                                            <?php 
                                                if (in_array($login_fabrica, array(175))) {
                                                    $produto_id = getValue('produto[id]');
                                                    if ($areaAdmin === true){
                                                        $posto_id = getValue('posto[id]');
                                                    }else{
                                                        $posto_id = $login_posto;
                                                    }
                                                    if (!empty($produto_id) && !empty($posto_id)) {
                                                        $res = getTecnicosTreinamentoProduto($produto_id, $posto_id);
                                                    }
                                                } else {
                                                    $sql = "
                                                        SELECT 
                                                            tecnico, 
                                                            nome,
                                                            codigo_externo,
                                                            ativo 
                                                        FROM tbl_tecnico 
                                                        WHERE posto = $login_posto 
                                                        AND ativo IS TRUE
                                                        AND fabrica IS NULL
                                                    ";
                                                    $res = pg_query($con, $sql);
                                                }
                                                if (pg_num_rows($res) > 0) {
                                                    while ($result = pg_fetch_object($res)) {
                                                        if (empty($os) AND !empty($login_unico) AND !count($msg_erro["msg"])){
                                                            $selected = ($result->codigo_externo == $login_unico AND $result->ativo == 't') ? "selected" : "";
                                                        }else{
                                                            $selected = ($result->tecnico == getValue("os[tecnico]")) ? "selected" : "";
                                                        } 
                                                    ?>
                                                        <option value='<?=$result->tecnico?>' <?=$selected?> >
                                                            <?=$result->nome?>
                                                        </option>
                                                    <?php 
                                                    }
                                                }
                                            ?>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?php
                    }
                
                //if (!$hide_defeito_constatado) {
                    $span_size  = (in_array($login_fabrica, array(165,175,177,178))) ? 3 : 4;
                    
                    if ($areaAdmin === false AND $login_unico_tecnico_posto != "t" AND $login_fabrica == 175 
                        || (in_array($login_fabrica, [174]) && $posto_interno && (empty($os) || getValue("os[status_checkpoint]") == 40))) {

                        $display_df_reclamado = "style='display:none;'";
                        $display_produto_peca = "display:none;";

                    }else{
                        $display_df_reclamado = "";
                        $display_produto_peca = "";
                    }

                    ?>
                    <?php if ($login_fabrica == 177 AND $areaAdmin === false){ 
                        $xcausa_defeito = getValue("produto[causa_defeito]");
                        if (empty($xcausa_defeito)){
                            $xcausa_defeito =  $_REQUEST["produto"]["causa_defeito"];
                        }
                    ?>
                        <div class="span<?=$span_size?>">
                            <div class="control-group <?=(in_array('produto[causa_defeito]', $msg_erro['campos'])) ? "error" : "" ?>">
                                <label class="control-label" for="produto_causa_defeito"><?php echo traduz("defeito.constatado");?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <?php if (($login_fabrica == 177) && (empty($produto) == "") ) { ?>
                                            <h5 class='asteristico'>*</h5>
                                        <?php } ?>
                                        <select id="produto_causa_defeito" name="produto[causa_defeito]" class="<?php echo $span; ?>" >
                                            <option value=""><?php echo traduz("selecione");?></option>
                                            <?php
                                                $sql = "SELECT causa_defeito, descricao, codigo FROM tbl_causa_defeito WHERE fabrica = {$login_fabrica} AND ativo IS TRUE ORDER BY codigo ASC";
                                                $res = pg_query($con, $sql);
                                                if (pg_num_rows($res) > 0){
                                                    $causa_defeito = pg_fetch_all($res);
                                                    foreach ($causa_defeito as $key => $value) {
                                                        $selected_causa_defeito = ($value["causa_defeito"] == $xcausa_defeito) ? "SELECTED" : "";
                                                ?>
                                                        <option <?=$selected_causa_defeito?> value='<?=$value["causa_defeito"]?>' ><?=$value["codigo"]?> - <?=$value["descricao"]?></option>
                                                <?php
                                                    }
                                                }
                                            ?>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?php }else{ ?>

                        <div class="span<?=$span_size?> box_defeito_constatado" <?=$display_df_reclamado?> >
                            <div class="control-group <?=(in_array('produto[defeito_constatado]', $msg_erro['campos'])) ? "error" : "" ?>">
                                <label class="control-label" for="produto_defeito_constatado"><?php echo traduz("defeito.constatado");?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                    <? if ($regras["produto|defeito_constatado"]["obrigatorio"] == true) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                    }
                                    $span = (in_array($login_fabrica, array(164,177))) ? "span11" : "span9";
                                    $span = ($login_fabrica == 165 OR $login_fabrica == 175) ? "span12"  : $span;
                                    ?>

                                    <?php if($login_fabrica == 35){
                                        $span = "span12"; ?>
                                        <?php

                                            if(getValue("produto[produto_critico]") == 't' and aprovadoAuditoria('tbl_auditoria_os.auditoria_status = 3') == false){
                                                $oculta_peca = 'display:none; ';
                                                $mostra_msg_produto_critico = 'display:block; ';
                                            }else{
                                                $mostra_msg_produto_critico = 'display:none; ';
                                            }
                                        ?>
                                        <input type="hidden" name="produto[produto_critico]" id="produto_critico" value="<?=getValue("produto[produto_critico]")?>">
                                    <?php } ?>

                                    <select id="produto_defeito_constatado" name="produto[defeito_constatado]" class="<?php echo $span; ?>" >
                                        <option value=""><?php echo traduz("selecione");?></option>
                                        <?
                                        $whereTipoAtendimento = "";

                                        if (strlen($produto) > 0) {

                                            if ($login_fabrica == 158) {
                                                if (empty($aux_garantia_dig)) {
                                                    $aux_garantia_dig = ($fora_garantia == 't') ? 'f' : 't';
                                                    $whereTipoAtendimento = "AND tbl_diagnostico.garantia = '{$aux_garantia_dig}'";
                                                } else {
                                                    $whereTipoAtendimento = "AND tbl_diagnostico.garantia = '{$aux_garantia_dig}'";
                                                }

                                                $whereTipoAtendimento .= ($tipo_atendimento == 272)
                                                    ? " AND tbl_diagnostico.tipo_atendimento = 272"
                                                    : " AND COALESCE(tbl_diagnostico.tipo_atendimento, -1) <> 272";

                                                if ($grupo_atendimento == 'S') {
                                                    $whereSanitizacao = "AND tbl_defeito_constatado.codigo == 'SA'";
                                                } else {
                                                    $whereSanitizacao = "AND tbl_defeito_constatado.codigo != 'SA'";
                                                }
                                            }

                                            if (in_array($login_fabrica, array(169,170))) {
                                                if ($grupo_atendimento == 'R' && in_array($tipo_atendimento_descricao, array('RMA','Triagem'))) {
                                                    #$whereTipoAtendimento = "AND tbl_defeito_constatado.descricao = '{$tipo_atendimento_descricao}'";
                                                } else {
                                                    $whereTipoAtendimento = "AND tbl_defeito_constatado.descricao NOT IN ('Triagem', 'RMA')";
                                                }
                                            }

                                            if ($usa_linha_defeito_constatado == 't'){
                                                $join_linha_familia_produto = " JOIN tbl_linha ON tbl_linha.linha = tbl_diagnostico.linha AND tbl_linha.fabrica = {$login_fabrica}
                                                           JOIN tbl_produto ON tbl_produto.linha = tbl_linha.linha AND tbl_produto.fabrica_i = {$login_fabrica} ";
                                            }else{
                                                $join_linha_familia_produto = " JOIN tbl_familia ON tbl_familia.familia = tbl_diagnostico.familia AND tbl_familia.fabrica = {$login_fabrica}
                                                           JOIN tbl_produto ON tbl_produto.familia = tbl_familia.familia AND tbl_produto.fabrica_i = {$login_fabrica} ";
                					    }

                				if($login_fabrica == 178){
							$xdefeito_constatado_produto = getValue('produto[defeito_constatado]');
							if (empty($xdefeito_constatado_produto)){
								$xdefeito_constatado_produto = $_RESULT['produto']['defeito_constatado'];
							}

                                            		$join_defeito_constatado_grupo = " JOIN tbl_defeito_constatado_grupo ON tbl_defeito_constatado.defeito_constatado_grupo = tbl_defeito_constatado_grupo.defeito_constatado_grupo ";
                    					$campo_defeito_constatado_grupo = " ,tbl_defeito_constatado_grupo.descricao AS descricao_defeito_constatado_grupo";
                    					$order_defeito_constatado_grupo = "tbl_defeito_constatado_grupo.descricao, ";
                                            		$cond = " AND tbl_defeito_constatado.defeito_constatado = $xdefeito_constatado_produto";
                                            		if (strlen(getValue('produto[defeito_constatado_grupo]')) > 0) {
                                                		$xdefeito_constatado_grupo = getValue('produto[defeito_constatado_grupo]');
                                                		$cond = " AND tbl_defeito_constatado.defeito_constatado_grupo = $xdefeito_constatado_grupo";
                                            		}
                                        	}

                                            $sql = "
                                                SELECT DISTINCT
                                                    tbl_defeito_constatado.defeito_constatado,
                                                    tbl_defeito_constatado.descricao,
                                                    tbl_defeito_constatado.lancar_peca,
                                                    tbl_defeito_constatado.codigo,
                                                    tbl_defeito_constatado.lista_garantia,
                            						tbl_defeito_constatado.defeito_constatado_grupo
                            					    {$campo_defeito_constatado_grupo}
                                                FROM tbl_diagnostico
                                                JOIN tbl_defeito_constatado ON tbl_defeito_constatado.defeito_constatado = tbl_diagnostico.defeito_constatado AND tbl_defeito_constatado.fabrica = $login_fabrica
                        					    {$join_linha_familia_produto}
                        					    {$join_defeito_constatado_grupo}
                                                WHERE tbl_diagnostico.fabrica = $login_fabrica
                                                AND tbl_produto.produto = {$produto}
                                                AND tbl_diagnostico.ativo IS TRUE
                                                {$cond}
                                                {$whereTipoAtendimento}
                                                {$whereSanitizacao}
                                          ORDER BY {$order_defeito_constatado_grupo} tbl_defeito_constatado.descricao ASC;
                                            ";
                                            $res = pg_query($con, $sql);

                                            if (pg_num_rows($res) > 0) {
                                                while ($result = pg_fetch_object($res)) {

                                                    $selected = ($result->defeito_constatado == getValue("produto[defeito_constatado]")) ? "selected" : "";

                        						    if($login_fabrica == 178){
                            							$result->codigo = $result->descricao_defeito_constatado_grupo;
                        						    }

                                                   if (isset($moduloTraducao)) {
                                                        $sqlIdiomaConstatado = "SELECT descricao 
                                                                                 FROM tbl_defeito_constatado_idioma 
                                                                                 WHERE defeito_constatado = {$result->defeito_constatado}
                                                                                 AND LOWER(idioma) = LOWER('$cook_idioma')";
                                                        $resIdiomaConstatado = pg_query($con, $sqlIdiomaConstatado);

                                                        if (pg_num_rows($resIdiomaConstatado) > 0) {
                                                            $result->descricao = utf8_decode(pg_fetch_result($resIdiomaConstatado, 0, 'descricao'));
                                                        }

                                                    }

                                                    if ((in_array($login_fabrica, array(143,152,180,181,182)) || isset($defeitoConstatadoMultiplo)) && in_array($result->defeito_constatado, explode(",", getValue("produto[defeitos_constatados_multiplos]")))) {
                                                        continue;
                                                    } ?>

                                                    <option
                                                        value='<?=$result->defeito_constatado?>'
                                                        data-lancar-pecas='<?=$result->lancar_peca?>'
                                                        data-lista-garantia='<?=$result->lista_garantia?>'
                                                        data-defeito-grupo='<?=$result->defeito_constatado_grupo?>'
                                                        <?=$selected?>
                                                    >
                                                        <?=(in_array($login_fabrica, array(158,178))) ? $result->codigo." - ".$result->descricao : $result->descricao; ?>
                                                    </option>
                                                <? }
                                            }
                                        } ?>
                                        </select>
                                        <? if ((in_array($login_fabrica, array(143,152,180,181,182)) || isset($defeitoConstatadoMultiplo)) && !in_array($login_fabrica, [157])) { ?>
                                            <button type='button' class='btn btn-success' onclick="addDefeitos()" title="<?php echo traduz("adicionar.defeito.constatado");?>" ><i class="icon-white icon-plus"></i></button>
                                        <? } else if (in_array($login_fabrica, [157]) && isset($defeitoConstatadoMultiplo)) { ?>
                                            <button type='button' id="adicionar_defeito_constatado" class='btn btn-success' title="<?php echo traduz("adicionar.defeito.constatado");?>" ><i class="icon-white icon-plus"></i></button><div class="alert alert-danger msg_erro_defeitos" style="margin-top: 5px;display: none;width: 700px"><h5></h5></div>
                                        <?php
                                        } ?>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <?php } ?>
                        <?php if ($login_fabrica == 203) { ?>
                        <?php
                                $sqlPremium = " SELECT tbl_tipo_posto.codigo
                                              FROM tbl_posto_fabrica
                                              INNER JOIN tbl_tipo_posto ON tbl_tipo_posto.tipo_posto = tbl_posto_fabrica.tipo_posto
                                              WHERE tbl_posto_fabrica.fabrica  = {$login_fabrica}
                                              AND tbl_posto_fabrica.posto      = {$login_posto}
                                              AND UPPER(tbl_tipo_posto.codigo) = UPPER('PREMIUM')";
                                $resPremium = pg_query($con,$sqlPremium);

                                $displayViaCorreios = (!strlen(pg_last_error()) > 0 && pg_num_rows($resPremium) > 0) ? "" : "display: none;";
                        ?>
                        <div class="span3" style="<?= $displayViaCorreios ?>">
                            <div class="control-group" id="div_recebido_via_correios">
                                 <label class="control-label" for="produto_recebido_via_correios"> &nbsp; </label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <input type="checkbox" name="produto[recebido_via_correios]" id="produto_recebido_via_correios" value="t"   <?php echo (getValue("produto[recebido_via_correios]") == "t") ? "checked": ""; ?> />
                                        <label class="control-label" for="produto_recebido_via_correios"><?php echo traduz("produto.recebido.via.correios");?></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <?php } ?>
                        <?php if (in_array($login_fabrica, [193])) { ?>
                        <div class="span3">
                            <div class="control-group <?=(in_array("produto[fabricante_motor]", $msg_erro['campos'])) ? "error" : "" ?>" id="div_fabricante_motor">
                                <label class="control-label" for="fabricante_motor"><?php echo traduz("fabricante.motor");?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <?php echo ($regras["produto|fabricante_motor"]["obrigatorio"] == true) ? "<h5 class='asteristico'>*</h5>" : ""; ?>
                                        <input type="text" name="produto[fabricante_motor]" id="fabricante_motor" style="width: 96% !important;" value="<?= (empty($_POST['produto']['fabricante_motor'])) ? $_RESULT['os']['fabricante_motor'] : $_POST['produto']['fabricante_motor'] ?>" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="span3">
                            <div class="control-group <?=(in_array("produto[tempo_conserto]", $msg_erro['campos'])) ? "error" : "" ?>" id="div_tempo_conserto" style="display:none;">
                                <label class="control-label" for="tempo_conserto"><?php echo traduz("tempo.de.conserto");?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <input type="time" name="produto[tempo_conserto]" id="tempo_conserto" style="width: 92% !important;" value="<?= (empty($_POST['produto']['tempo_conserto'])) ? $_RESULT['os']['tempo_conserto'] : $_POST['produto']['tempo_conserto'] ?>" />
                                        <input type="hidden" id="show_tempo_conserto" name="show_tempo_conserto" value="<?= (empty($_RESULT['produto']['garantia_horas']) && empty($_RESULT['produto']['garantia_horas'])) ? 'f' : 't' ?>" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?php }
                    if (in_array($login_fabrica, [186,191])) {?>

                        <div class="span4 mostra_envia_email"  style="<?php echo ($tipo_atendimento_descr == "Orçamento") ? "": "display: none;";?>">
                            <div class='control-group ' >
                                <label class="control-label" for="envia_orcamento_email"><?php echo traduz('Enviar Orçamento para Email do Consumidor');?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <input id="envia_orcamento_email" <?php echo (getValue("os[envia_orcamento_email]") == "t") ? "checked": "";?> name="os[envia_orcamento_email]" type="checkbox" value="t" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?php }
                    if (in_array($login_fabrica, [190,195]) && $areaAdmin === true) {?>
                        <div class="span4 mostra_envia_email"  style="<?php echo ($tipo_atendimento_descr == "Orçamento") ? "": "display: none;";?>">
                            <div class='control-group ' >
                                <label class="control-label" for="envia_orcamento_email"><?php echo traduz('Enviar Orçamento para Email do Consumidor');?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <input id="envia_orcamento_email" <?php echo (getValue("os[envia_orcamento_email]") == "t") ? "checked": "";?> name="os[envia_orcamento_email]" type="checkbox" value="t" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?php }
                    if($login_fabrica == 35){?>
                        <div class="span3">
                            <div class="control-group <?=(in_array('produto[solucao]', $msg_erro['campos'])) ? "error" : "" ?>">
                                <label class="control-label" for="solucao"><?php echo traduz("solucao");?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <? if ($regras["produto|solucao"]["obrigatorio"] == true) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                        }
                                        ?>
                                        <select id="solucao" name="produto[solucao]" class="span12" >
                                            <option value=""><?php echo traduz("selecione");?></option>
                                            <?php 
                                                $sql = "SELECT tbl_solucao.solucao,
                                                        tbl_solucao.descricao
                                                        FROM tbl_solucao WHERE fabrica = $login_fabrica
                                                        AND ativo IS TRUE
                                                        ORDER BY descricao";
                                                $res = pg_query($con, $sql);
                                                $contadorSQL = pg_num_rows($res);
                                                if($contadorSQL > 0){
                                                    for($i = 0; $i < $contadorSQL; $i++){
                                                        $solucao = pg_fetch_result($res, $i, "solucao");
                                                        $descricao = pg_fetch_result($res, $i, "descricao");

                                                        $selected = ($solucao == getValue("produto[solucao]")) ? "SELECTED" : "";

                                                        echo "<option value='{$solucao}' {$selected} >{$descricao}</option>";
                                                    }
                                                }
                                             ?>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <?php
                        if($login_fabrica == 35){
                            $grupo_tipo_atendimento = " grupo_tipo_atendimento ";
                        }
                        ?>
                        <div class="span3 <?=$grupo_tipo_atendimento?>">
                            <div class="control-group <?=(in_array('os[tipo_atendimento]', $msg_erro['campos'])) ? "error" : "" ?>">
                                <label class="control-label" for="tipo_atendimento"><?php echo traduz("tipo.de.atendimento");?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <? if ($regras["os|tipo_atendimento"]["obrigatorio"] == true) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                        }
                                        ?>
                                        <select id="tipo_atendimento" name="os[tipo_atendimento]" class="span12">

                                        <?php
                                            $sql = "SELECT tipo_atendimento,
                                                    descricao,
                                                    fora_garantia,
                                                    km_google,
                                                    entrega_tecnica AS visita_tecnica,
                                                    grupo_atendimento
                                                FROM tbl_tipo_atendimento
                                                WHERE fabrica = {$login_fabrica}
                                                AND ativo IS TRUE
                                                {$whereGrupoAtendimento}
                                                {$whereEntregaTecnica}
                                                {$sql_descricao}
                                                {$whereForaGarantia}
                                                {$whereTpAtendPosto}
                                                ORDER BY descricao DESC";
                                            $res = pg_query($con, $sql);
                                            echo "<option></option>";
                                            while ($result = pg_fetch_object($res)) {

                                                if(getValue("os[tipo_atendimento]") == $result->tipo_atendimento){
                                                    $selected = 'selected';
                                                }else{
                                                    $selected = ' ';
                                                }

                                                echo "<option value='{$result->tipo_atendimento}' km_google='{$result->km_google}' fora_garantia='{$result->fora_garantia}' visita_tecnica='{$result->visita_tecnica}' {$selected} >{$result->descricao}</option>";
                                            }

                                        ?>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?php } ?>

                    <? if(in_array($login_fabrica,array(131))){ ?>

                        <div class="span<?=$span_size?>">
                            <div class="control-group <?=(in_array('produto[causa_defeito]', $msg_erro['campos'])) ? "error" : "" ?>">
                                <label class="control-label" for="produto_causa_defeito"><?php echo traduz("causa");?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <select id="produto_causa_defeito" name="produto[causa_defeito]" class="<?php echo $span; ?>" >
                                            <option value=""><?php echo traduz("selecione");?></option>
                                            <?php
                                                $sql = "SELECT causa_defeito, tbl_causa_defeito.descricao from  tbl_causa_defeito where fabrica = $login_fabrica ORDER BY tbl_causa_defeito.descricao";
                                                $res = pg_query($con, $sql);
                                                if (pg_num_rows($res) > 0){
                                                    $causa_defeito = pg_fetch_all($res);
                                                    foreach ($causa_defeito as $key => $value) {
                                                        $selected_causa_defeito = ($value["causa_defeito"] == $_RESULT["produto"]["causa_defeito"]) ? "SELECTED" : "";
                                                ?>
                                                        <option <?=$selected_causa_defeito?> value='<?=$value["causa_defeito"]?>' ><?=$value["descricao"]?></option>
                                                <?php
                                                    }
                                                }
                                            ?>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                    <? } ?>
                <? //}
                if ($login_fabrica == 162 && $finalizadaOs) { ?>
                    <div class="span3 data_saida" <?=$mostra_data_saida?>>

                        <div class="control-group <?=(in_array('os[data_saida]', $msg_erro['campos'])) ? "error" : "" ?>" >
                            <label class="control-label" for="data_saida"><?php echo traduz("data.de.saida");?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <input type="text" name="os[data_saida]"  value="<?=getValue("os[data_saida]")?>" id="data_saida" class="span8" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="span1"></div>
                </div>
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span9 rastreio" <?=$mostra_postagem?>>

                        <div class="control-group <?=(in_array('os[rastreio]', $msg_erro['campos'])) ? "error" : "" ?>" >
                            <label class="control-label" for="rastreio"><?php echo traduz("codigo.de.postagem");?></label>
                            <div class="controls controls-row">
                                <div class="span6">
                                    <input type="text" name="os[rastreio]"  value="<?=getValue("os[rastreio]")?>" id="rastreio" maxlength="13" class="span6" />
                                </div>
                            </div>
                        </div>
                    </div>
                <?php
                }

                if(in_array($login_fabrica, array(143,152,180,181,182)) || isset($defeitoConstatadoMultiplo)){
                    $defeito_constatado_json = json_encode(toUtf8(pg_fetch_all($res)));
		    $defeito_constatado_json = str_replace("\\r","",$defeito_constatado_json);
                    ?>

                    <script>
                        <?php
                        $defeitos_multiplos = getValue("produto[defeitos_constatados_multiplos]");

                        if(!empty($defeitos_multiplos)){
                            $campos["produto"]["defeitos_constatados_multiplos"] = $defeitos_multiplos;

                            if (in_array($login_fabrica, array(152,180,181,182))) {
                                $campos["produto"]["tempo_reparo_defeito"] = getValue("produto[tempo_reparo_defeito]");
                            }

                        }

                        if (in_array($login_fabrica, array(169, 170))) { ?>
                            var nf_obrigatoria = <?=($regras["os|nota_fiscal"]["obrigatorio"]) ? 1 : 0?>;
                            var data_nf_obrigatoria = <?=($regras["os|data_compra"]["obrigatorio"]) ? 1 : 0?>;
                            var anexo_obrigatorio = <?=($regras["anexo"]["anexo_obrigatorio"]) ? 1 : 0?>;
                        <? }

                        if(!empty($campos["produto"]["defeitos_constatados_multiplos"])){
                            $array_defeitos = $campos["produto"]["defeitos_constatados_multiplos"];
                        }
                        ?>

                        defeito_constatado_json = $.parseJSON('<?=$defeito_constatado_json?>');

                        defeitos_selecionados = [<?=$array_defeitos?>];

                    <?php 

                    /**
                    * hd-6513420
                    *
                    * @author William Castro <william.castro@telecontrol.com.br>
                    *
                    * Não exibir div para lançar peças quando a OS for do tipo "TRIAGEM" 
                    * Exibir Defeito da Peça para Triagem e RMA
                    *
                    */   

                    if (in_array($login_fabrica, array(169, 170)))  { ?>
                        
                        $(function() {

                            var defeitos = $(".tbl-defeitos-selecionados").data();
                            var tipoAtendimento = $("#tipo_atendimento option:selected").text();

                            if (tipoAtendimento == "RMA" || tipoAtendimento == "Triagem") {
                                
                                $("#produto_pecas").slideUp(); 

                                if (defeitos != null) {
                           
                                    retorna_produto_defeito_peca();
                                
                                    $("#div_produto_defeito_peca").show();
                                   
                                }
                            }
                            
                        });

                    <?php } ?>

                        function addDefeitos(){

                            var defeito = $("#produto_defeito_constatado").val();
                            var descricao = $("#produto_defeito_constatado option:selected").text();
                            var tipoAtendimento = $("#tipo_atendimento option:selected").text();
                            <?php if($login_fabrica == 148) : ?>
                                $('#descricao_defeito_148').css('display', 'block')
                            <?php endif; ?>
                            <?php
                            if (in_array($login_fabrica, array(169,170))) { ?>

                                var lista_garantia = $("#produto_defeito_constatado option:selected").data("lista-garantia");

                                if (lista_garantia == "fora_garantia" || lista_garantia == "sem_defeito") {
                                    var peca_lancada = false;

                                    $("#produto_pecas").find("div[name^=peca_]").each(function() {
                                       var p = $(this).find("input[rel=peca_id]").val();

                                       if (typeof p != "undefined" && p.length > 0) {
                                           peca_lancada = true;
                                           return false;
                                       }
                                    });

                                    if (peca_lancada == true) {
                                        alert("<?php echo traduz("nao.e.possivel.lancar.o.defeito.selecionado.com.pecas.lancadas.na.ordem.de.servico");?>");
                                        $("#produto_defeito_constatado").focus();
                                        return;
                                    }

                                    if (lista_garantia == "fora_garantia") {
                                        descricao += "<br /><span class='label label-warning defeito-fora-garantia' style='white-space: normal;' ><?php echo traduz("para.o.defeito.selecionado.nao.e.obrigatorio.informar.o.numero.da.nota.fiscal.data.da.compra.anexo.e.nao.e.possivel.lancar.pecas");?></span>";

                                        $("#nota_fiscal").prev("h5").hide();
                                        $("#data_compra").prev("h5").hide();
                                        $("#nota_obrigatoria, #anexo_obrig, #produto_pecas").hide();
                                    }

                                    if (lista_garantia == "sem_defeito") {
                                        descricao += "<br /><span class='label label-warning defeito-sem-defeito' style='white-space: normal;' ><?php echo traduz("para.o.defeito.selecionado.nao.e.possivel.lancar.pecas");?></span>";

                                        $("#produto_pecas").hide();
                                        $("#div_produto_defeito_peca").show();
                                    }
                                }

                            <? }
                            if (in_array($login_fabrica, [186,190,191,195])) { ?>
                                if ($(".mostra_envia_email").is(":visible")) {
                                    $("#envia_orcamento_email").prop("disabled", false);
                                }
                            <? } ?>

                            var lancar_pecas = $("#produto_defeito_constatado option:selected").data("lancar-pecas");

                            if (lancar_pecas == "t") {
                                descricao += "<br /><span class='label label-warning' style='white-space: normal;' ><?php echo traduz("obrigatorio.o.lancamento.de.peca.s.para.o.defeito.constatado");?></span>";
                            }

                            if (defeito == "") {
                                alert("<?php echo traduz("por.favor.selecione.um.defeito.constatado");?>!");
                                $("#produto_defeito_constatado").focus();
                                return;
                            }

                            if(defeitos_selecionados.length == 0) {
                                $("table.box-defeitos > tbody > tr").remove();
                            }

                            defeitos_selecionados.push(parseInt(defeito));

                            var tr = $("<tr></tr>", { id: "box-defeito-"+defeito, lancarpeca: lancar_pecas });

                            var td_descricao = $("<td></td>", { html: descricao });
                            $(tr).append(td_descricao);

                            <? if (in_array($login_fabrica, array(152,180,181,182))) { ?>
                                var input_tempo_reparo = $("<input />", {
                                    type: "text",
                                    class: "numeric",
                                    name: "produto[tempo_reparo_defeito]["+defeito+"]",
                                    css: {
                                        width: "50px"
                                    }
                                });
                                var td_tempo_reparo = $("<td></td>");
                                $(td_tempo_reparo).append(input_tempo_reparo).append("&nbsp;<strong style='color: #b94a48' >(<?php echo traduz("informar.em.minutos");?>)</strong>");
                                $(tr).append(td_tempo_reparo);
                            <? } ?>

                            var btn_remover  = $("<button></button>", {
                                type: "button",
                                class: "btn btn-danger btn-small removerDefeito",
                                text: "Remover"
                            });

                            $(btn_remover).data("loading-text", "Removendo...");
                            $(btn_remover).data("defeito-id", defeito);

                            var td_acao      = $("<td></td>", { class: "tac", css: { "vertical-align": "middle" } });
                            $(td_acao).append(btn_remover);
                            $(tr).append(td_acao);

                            $("table.box-defeitos > tbody").append(tr);

                            $("#defeitos_constatados_multiplos").val(defeitos_selecionados);
                            $("#produto_defeito_constatado option:selected").remove();

                            <? if (in_array($login_fabrica, array(152,180,181,182))) { ?>
                                $("#box-defeito-"+defeito+" input.numeric").numeric();
                            <? }
                            if (in_array($login_fabrica, array(158))) { ?>
                                busca_solucao_defeito_constatado(defeitos_selecionados);
                            <? }

                            if ($defeito_constatado_obriga_lancar_peca == true && !$defeitoConstatadoMultiplo) { ?>
                                peca_obrigatoria_defeito_constatado(true);
                            <? }

                            if (in_array($login_fabrica, array(169,170))) { ?>
                                $("#pecas_produto").find("div[name^=peca_]").each(function() {
                                    var linha_peca_nome = $(this).attr("name");
                                    linha_peca_nome = linha_peca_nome.split("_");
                                    var posicao = linha_peca_nome[1];
                                    var peca_id = $("input[name='produto_pecas["+posicao+"][id]']").val();
                                    var peca_pedido = $("input[name='produto_pecas["+posicao+"][pedido]']").val();
                                    if (typeof peca_id != "undefined" && peca_id.length > 0 && typeof peca_pedido != "undefined"  && peca_pedido.length == 0) {
                                        retorna_defeito_peca(peca_id,posicao);
                                    }
                                });
                                $("#produto_serie").trigger("change");

                                $("#tipo_atendimento").selectreadonly(true).attr("readonly", true);
                                $("#tipo_atendimento option:not(:selected)").attr('disabled',true);

                                var linhas_defeitos = $(".box-defeitos > tbody").find('tr');
                                var sem_peca = false;
                                var obrig_peca = false;

                                $(linhas_defeitos).each(function() {
                                    if ($(this).find("span.defeito-fora-garantia").length > 0 || $(this).find("span.defeito-sem-defeito").length > 0) {
                                        sem_peca = true;
                                    }

                                    if ($(this).attr("lancarpeca") == "t") {
                                        obrig_peca = true;
                                    }
                                });

                                if ($("#tipo_atendimento > option:selected").attr("grupo_atendimento") == "I") {
                                    var tipo_atendimento = $("#tipo_atendimento > option:selected").text();

                                    if (tipo_atendimento == "Instalação") {
                                        $("#produto_pecas, #lancar_peca_obrigatorio_tipo_atendimento").hide();
                                        $("#lancar_peca_bloqueado_tipo_atendimento").show();
                                    } else {
                                        $("#lancar_peca_bloqueado_tipo_atendimento").hide();
                                        $("#produto_pecas, #lancar_peca_obrigatorio_tipo_atendimento").show();
                                    }

                                    retorna_produto_defeito_peca();
                                } else {
                                    $("#lancar_peca_bloqueado_tipo_atendimento, #lancar_peca_obrigatorio_tipo_atendimento").hide();

                                    if (sem_peca == true) {
                                        $("#produto_pecas").hide();
                                    } else {
                                        $("#produto_pecas").show();
                                    }

                                    if (lista_garantia == "sem_defeito" || tipoAtendimento == "RMA" || tipoAtendimento == "Triagem") {

                                        retorna_produto_defeito_peca();

                                        if (tipoAtendimento == "RMA") {
                                            $("#div_produto_defeito_peca").show();
                                            $("#produto_pecas").hide();
                                        }
                                    }

                                    peca_obrigatoria_defeito_constatado(obrig_peca);
                                }

                                if ($("#tipo_atendimento option:selected").text() == 'Triagem') {

                                    $("#produto_pecas").hide();

                                }

                            <? } ?>
                        }

                        function in_array(needle, haystack){
                            var found = 0;
                            for (var i = 0, len = haystack.length; i < len; i++) {
                                if (haystack[i] == needle) return i;
                                    found++;
                            }
                            return -1;
                        }

                        function remove(arr, item) {
                            for(var i = arr.length; i--;) {
                                if(arr[i] === item) {
                                    arr.splice(i, 1);
                                }
                            }

                        }

                        function remAllDefeitos() {

                            var linhas_defeitos_selecionados = $("tr[id^=box-defeito-]");
                            var os = '<?=$_REQUEST["os_id"]?>';

                            $.each(linhas_defeitos_selecionados, function (key, linha_tr) {
                                var tr = linha_tr;
                                var def = $(this).find('button.removerDefeito').data("defeito-id");

                                remove(defeitos_selecionados, parseInt(def));

                                if (typeof os != "undefined" && os.length > 0) {
                                    $.ajax({
                                        async: false,
                                        url: "cadastro_os.php",
                                        type: "post",
                                        data: {
                                            ajax: true, ajax_deleta_defeito_constatado_multiplo_os: true, os: os, defeito_constatado: def },
                                    }).always(function(data) {
                                        data = $.parseJSON(data);

                                        if (data.error) {
                                            $(btn).button("reset");
                                            alert(data.error);
                                        } else {
                                            $(tr).remove();
                                        }
                                    });

                                } else {
                                    $(tr).remove();
                                }

                                $("#defeitos_constatados_multiplos").val(defeitos_selecionados);

                                if(defeitos_selecionados.length == 0) {
                                    <? if (in_array($login_fabrica, array(152,180,181,182))) { ?>
                                        colspan_defeito = 3;
                                    <? } else { ?>
                                        colspan_defeito = 2;
                                    <? } ?>

                                    $("table.box-defeitos > tbody").append("<tr class='sem_defeito_selecionado error' ><td class='tac' colspan="+colspan_defeito+" ><?php echo traduz("selecione.os.defeitos.constatados");?></td></tr>");

                                    <? if (in_array($login_fabrica, array(169,170))) { ?>
                                        $("#tipo_atendimento").selectreadonly(false).attr("readonly",false);
                                        $("#tipo_atendimento option:not(:selected)").attr('disabled',false);
                                    <? } ?>
                                }

                                $("#produto_defeito_constatado > option:first").nextAll().remove();

                                $.each(defeito_constatado_json, function(key, defeito_constatado) {
                                    if ($("#box-defeito-"+defeito_constatado.defeito_constatado).length == 0) {
                                        var option = $("<option></option>", {
                                            value: defeito_constatado.defeito_constatado,
                                            text: <?= (in_array($login_fabrica, array(158))) ? "defeito_constatado.codigo+' - '+" : ""; ?>defeito_constatado.descricao,
                                            data: { "lancar-pecas": defeito_constatado.lancar_peca, "lista-garantia": defeito_constatado.lista_garantia }
                                        });
                                        $("#produto_defeito_constatado").append(option);
                                    }
                                });
                            });

                        }

                        function remove_pecas_nao_vinculadas_com_defeito() {

                            var pecas_inseridas =   $(".produto_referencia").filter(function(){
                                                        return $(this).val() != "";
                                                    }).map(function(){
                                                        return $(this).val();
                                                    }).get();
                            var defeitos_lancados = $("#defeitos_constatados_multiplos").val();

                            $.ajax({
                                url: location.href,
                                type: "POST",
                                data: {
                                    ajax_remove_pecas_defeito: true,
                                    pecas_inseridas: pecas_inseridas,
                                    defeito: defeitos_lancados
                                },
                                dataType: "json",
                            }).always(function(data){

                                if (!data.erro && data.pecas_remover.length > 0) {

                                    $.each(data.pecas_remover, function(i, peca) {

                                        $("input[rel=peca_id]").filter(function(){
                                            return $(this).val() == peca;
                                        }).closest("div").find("button[name=remove_peca]").click();


                                    });

                                }
                            });

                        }

                        $(function() {
                            $(document).on("click", "button.removerDefeito", function() {

                                $(".box_defeito_constatado").show();

                                var tr  = $(this).parents("tr");
                                var btn = $(this);
                                $(btn).button("loading");

                                var def = $(this).data("defeito-id");

                                remove(defeitos_selecionados, parseInt(def));

                                var os = '<?=$_REQUEST["os_id"]?>';

                                if (typeof os != "undefined" && os.length > 0) {
                                    $.ajax({
                                        async: false,
                                        url: "cadastro_os.php",
                                        type: "post",
                                        data: { ajax: true, ajax_deleta_defeito_constatado_multiplo_os: true, os: os, defeito_constatado: def },
                                    }).always(function(data) {
                                        data = $.parseJSON(data);

                                        if (data.error) {
                                            $(btn).button("reset");
                                            alert(data.error);
                                        } else {
                                            $(tr).remove();
                                        }
                                    });
                                } else {
                                    $(tr).remove();
                                }

                                $("#defeitos_constatados_multiplos").val(defeitos_selecionados);

                                if(defeitos_selecionados.length == 0) {
                                    <? if (in_array($login_fabrica, array(152,180,181,182))) { ?>
                                        colspan_defeito = 3;
                                    <? } else { ?>
                                        colspan_defeito = 2;
                                    <? } ?>

                                    $("table.box-defeitos > tbody").append("<tr class='sem_defeito_selecionado error' ><td class='tac' colspan="+colspan_defeito+" ><?php echo traduz("selecione.os.defeitos.constatados");?></td></tr>");

                                    <? if (in_array($login_fabrica, array(169,170))) { ?>
                                        $("#tipo_atendimento").selectreadonly(false).attr("readonly",false);
                                        $("#tipo_atendimento option:not(:selected)").attr('disabled',false);
                                    <? } ?>

                                }

                                $("#produto_defeito_constatado > option:first").nextAll().remove();

                                <?php if (in_array($login_fabrica, array(158))) { ?>
                                    if (defeitos_selecionados.length > 0) {
                                        busca_solucao_defeito_constatado(defeitos_selecionados);
                                    } else {
                                        $("#solucao").empty().append('<option value=""><?php echo traduz("selecione.um.defeito.constatado");?></option>');
                                        $("#solucao").select2();
                                    }
                                <?php } ?>

                                $.each(defeito_constatado_json, function(key, defeito_constatado) {
                                    if ($("#box-defeito-"+defeito_constatado.defeito_constatado).length == 0) {
                                        var option = $("<option></option>", {
                                            value: defeito_constatado.defeito_constatado,
                                            text: <?= (in_array($login_fabrica, array(158))) ? "defeito_constatado.codigo+' - '+" : ""; ?>defeito_constatado.descricao,
                                            data: { "lancar-pecas": defeito_constatado.lancar_peca, "lista-garantia": defeito_constatado.lista_garantia }
                                        });
                                        $("#produto_defeito_constatado").append(option);
                                    }
                                });

                                <? if (in_array($login_fabrica, array(169,170))) { ?>
                                    var defeito_fora_garantia = $("table.box-defeitos").find("span.defeito-fora-garantia").length;

                                    if (defeito_fora_garantia == 0) {
                                        if (nf_obrigatoria == 1) {
                                            $("#nota_fiscal").prev("h5").show();
                                        }

                                        if (data_nf_obrigatoria == 1) {
                                            $("#data_compra").prev("h5").show();
                                        }

                                        if (anexo_obrigatorio == 1) {
                                            $("#nota_obrigatoria, #anexo_obrig").show();
                                        }

                                        $("#produto_pecas").show();

                                    }

                                    $("#produto_serie").trigger("change");

                                    var linhas_defeitos = $(".box-defeitos > tbody").find('tr');
                                    var sem_peca = false;
                                    var obrig_peca = false;

                                    $(linhas_defeitos).each(function() {
                                        if ($(this).find("span.defeito-fora-garantia").length > 0 || $(this).find("span.defeito-sem-defeito").length > 0) {
                                            sem_peca = true;
                                        }

                                        if ($(this).attr("lancarpeca") == "t") {
                                            obrig_peca = true;
                                        }
                                    });

                                    if ($("#tipo_atendimento > option:selected").attr("grupo_atendimento") == "I") {
                                        var tipo_atendimento = $("#tipo_atendimento > option:selected").text();

                                        if (tipo_atendimento == "Instalação") {
                                            $("#produto_pecas, #lancar_peca_obrigatorio_tipo_atendimento").hide();
                                            $("#lancar_peca_bloqueado_tipo_atendimento").show();
                                        } else {
                                            $("#lancar_peca_bloqueado_tipo_atendimento").hide();
                                            $("#produto_pecas, #lancar_peca_obrigatorio_tipo_atendimento").show();
                                        }
                                    } else {
                                        $("#lancar_peca_bloqueado_tipo_atendimento, #lancar_peca_obrigatorio_tipo_atendimento").hide();

                                        if (sem_peca == true) {
                                            $("#produto_pecas").hide();
                                        } else {
                                            $("#produto_pecas").show();
                                        }

                                        peca_obrigatoria_defeito_constatado(obrig_peca);
                                    }
                                <? } 

                                if (in_array($login_fabrica, [157])) { ?>

                                    remove_pecas_nao_vinculadas_com_defeito();

                                <?php
                                } ?>

                            });
                        });
                    </script>
                <? }
                if($login_fabrica == 153) { ?>
                    <div class="span3 codigo_lacre" style="<?= $display_lacre_positron; ?>">
                        <div class="control-group <?=(in_array('produto[codigo_lacre]', $msg_erro['campos'])) ? "error" : "" ?>">
                            <label class="control-label" for="produto_codigo_lacre"><?php echo traduz("codigo.do.lacre");?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <? if ($regras["produto|codigo_lacre"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    } ?>
                                    <input type="text" name="produto[codigo_lacre]"  value="<?= getValue("produto[codigo_lacre]") ?>" id="produto_codigo_lacre" maxlength="10" class="span12 numeric">
                                </div>
                            </div>
                        </div>
                    </div>
                <? }
            }
            if (isset($usaSolucao)) {
                if ($login_fabrica == 158) {
            ?>
                    <input type="hidden" name="solucao_lancada" id="solucao_lancada" value="<?=(empty($campos['produto']['solucao_lancada'])) ? implode(',', $_RESULT['produto']['solucao']) : $campos['produto']['solucao_lancada'] ?>">
            <?php
                }

             ?>
                <div class="<?=($login_fabrica == 158) ? "span6" : "span3";?>" >
                    <div class="control-group <?=(in_array('produto[solucao]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="solucao"><?php echo traduz("solucao");?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?
                                if ($regras["produto|solucao"]["obrigatorio"] == true) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                }

                                if ($login_fabrica == 158) {
                                    $solucao_select_name = "produto[solucao][]";

                                    if ($grupo_atendimento != "S") {
                                        $solucao_multiple = "multiple='multiple'";
                                    }
                                } else {
                                    $solucao_select_name = "produto[solucao]";
                                }
                                ?>
                                <select id="solucao" name="<?=$solucao_select_name?>" class="span12" <?=$solucao_multiple?> >
                                    <?php
                                    if ($login_fabrica != 158) {
                                    ?>
                                        <option value="">Selecione</option>
                                    <?
                                    }

                                    $busca_solucoes = false;

                                    if (in_array($login_fabrica, array(158))) {
                                        if ($grupo_atendimento == "S") {
                                            $busca_solucoes = true;

                                            if (strlen(getValue("produto[solucao]")) > 0) {
                                                $solucao_where = "AND solucao = ".getValue("produto[solucao]");
                                            } else {
                                                $solucao_where = "AND codigo = 'SA'";
                                            }
                                            $sql = "
                                                SELECT solucao, descricao, troca_peca, codigo
                                                FROM tbl_solucao
                                                WHERE fabrica = {$login_fabrica}
                                                {$solucao_where}
                                                ";
                                        } else if (strlen($campos["produto"]["defeitos_constatados_multiplos"]) > 0) {
                                            $busca_solucoes = true;
                                            $sql = "
                                                SELECT  DISTINCT
                                                        tbl_diagnostico.solucao,
                                                        tbl_solucao.descricao,
                                                        tbl_solucao.troca_peca,
                                                        tbl_solucao.codigo
                                                FROM    tbl_diagnostico
                                                JOIN    tbl_solucao ON  tbl_solucao.solucao = tbl_diagnostico.solucao
                                                                    AND tbl_solucao.ativo   IS TRUE
                                                                    AND tbl_solucao.fabrica = {$login_fabrica}
                                                WHERE   tbl_diagnostico.defeito_constatado  IN ({$campos["produto"]["defeitos_constatados_multiplos"]})
                                                AND     tbl_diagnostico.ativo               IS TRUE
                                                AND     tbl_diagnostico.fabrica             = {$login_fabrica}
                                                AND     tbl_solucao.codigo                  != 'SA'
                                                {$whereTipoAtendimento}
                                          ORDER BY      tbl_solucao.descricao;
                                            ";
                                        }
                                    } else {

                                        if ($login_fabrica == 183) {
                                            $busca_solucoes = true;
                                            $sql = "
                                                    SELECT  tbl_solucao.solucao, tbl_solucao.descricao
                                                      FROM tbl_solucao
                                                     WHERE tbl_solucao.fabrica = {$login_fabrica}
                                                       AND tbl_solucao.ativo IS TRUE
                                                  ORDER BY tbl_solucao.descricao ASC;
                                                ";
                                        } else {

                                            if (strlen(getValue('produto[id]')) > 0) {
                                                $busca_solucoes = true;
                                                if (isset($usaSolucaoLinha)) {
                                                    $joinSolucao = "
                                                        INNER JOIN tbl_linha ON tbl_linha.linha = tbl_diagnostico.linha AND tbl_linha.fabrica = {$login_fabrica}
                                                        INNER JOIN tbl_produto ON tbl_produto.linha = tbl_linha.linha AND tbl_produto.fabrica_i = {$login_fabrica}
                                                    ";
                                                } else if (isset($usaSolucaoFamilia)) {
                                                    $joinSolucao = "
                                                        INNER JOIN tbl_familia ON tbl_familia.familia = tbl_diagnostico.familia AND tbl_familia.fabrica = {$login_fabrica}
                                                        INNER JOIN tbl_produto ON tbl_produto.familia = tbl_familia.familia AND tbl_produto.fabrica_i = {$login_fabrica}
                                                    ";
                                                }

                                                $sql = "
                                                    SELECT DISTINCT tbl_solucao.solucao, tbl_solucao.descricao
                                                    FROM tbl_diagnostico
                                                    INNER JOIN tbl_solucao ON tbl_solucao.solucao = tbl_diagnostico.solucao AND tbl_solucao.fabrica = {$login_fabrica}
                                                    {$joinSolucao}
                                                    WHERE tbl_diagnostico.fabrica = {$login_fabrica}
                                                    AND tbl_produto.produto = ".getValue("produto[id]")."
                                                    AND tbl_diagnostico.ativo IS TRUE
                                                    ORDER BY tbl_solucao.descricao ASC;
                                                ";
                                            }
                                        }
                                    }

                                    if ($busca_solucoes) {
                                        $res = pg_query($con, $sql);
                                        if (pg_num_rows($res) > 0) {
                                            while ($result = pg_fetch_object($res)) {
                                                if ($login_fabrica == 158) {
                                                    $selected = (in_array($result->solucao, getValue("produto[solucao]"))) ? "selected" : "";
                                                } else {
                                                    $selected = ($result->solucao == getValue("produto[solucao]")) ? "selected" : "";
                                                }

                                                $mostra_produto_pecas = (in_array($login_fabrica, array(158)) && in_array($result->solucao, getValue("produto[solucao]")) && $result->troca_peca != 't') ? "display:none;" : "";
                                                ?>
                                                <option value='<?= $result->solucao; ?>' <?= $selected; ?>><?= (in_array($login_fabrica, array(158))) ? $result->codigo." - ".$result->descricao : $result->descricao; ?></option>
                                            <? }
                                        }
                                    } ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            <? }
            $troca_garantia = getValue("os[troca_garantia]");
            if (empty($troca_garantia)){
                $troca_garantia = $_RESULT["os"]["troca_garantia"];     
            }
           
	    if ($login_fabrica == 178) {
        ?>
            <div class="span3">
                <div class="control-group <?=(in_array('produto[marca_produto]', $msg_erro['campos'])) ? "error" : "" ?>">
                    <label class="control-label" for="marca_produto">Marca Produto</label>
                    <div class="controls controls-row">
                        <h5 class="asteristico">*</h5>
                        <select name="produto[marca_produto]" class="span12" id="marca_produto">
                        <?php
                            $id_produto = $_REQUEST["produto"]["id"];
                            if (empty($id_produto)){
                                $id_produto = getValue("produto[id]");
                            }

                            $id_marca_produto = $_REQUEST["produto"]["marca_produto"];
                            if (empty($id_marca_produto)){
                                $id_marca_produto = getValue("os[marca]");
                            }

							if(!empty($id_produto)) {
								$sql = "
									SELECT 
										parametros_adicionais
									FROM tbl_produto 
									WHERE fabrica_i = $login_fabrica
									AND produto = $id_produto ";
								$res = pg_query($con, $sql);
								if (pg_num_rows($res) > 0){
									$parametros_adicionais_produto = pg_fetch_result($res, 0, "parametros_adicionais");
									$parametros_adicionais_produto = json_decode($parametros_adicionais_produto, true);
									$marcas_produto = $parametros_adicionais_produto['marcas'];

									$count = count(explode(",", $marcas_produto));

									$sqlMarca = "
										SELECT
											marca, nome
										FROM tbl_marca
										WHERE fabrica = {$login_fabrica}
										AND marca IN ($marcas_produto)
										AND ativo IS TRUE
										ORDER BY nome DESC;
									";
									$resMarca = pg_query($con, $sqlMarca);
									
									if ($count > 1 AND empty($id_marca_produto)){
										echo "<option value=''>Selecione a Marca</option>";
									}
									while($result = pg_fetch_object($resMarca)) {
										$selected = ($result->marca == $id_marca_produto) ? "selected" : "";
										$disabled = ($result->marca != $id_marca_produto && !empty($id_marca_produto) AND empty($msg_erro["msg"])) ? "disabled" : ""; ?>
										<option value="<?= $result->marca; ?>" <?= $selected." ".$disabled; ?> ><?= $result->nome; ?></option>
							<?php
									}
								}
							}
                        ?>
                        </select>                
                    </div>
                </div>
            </div>

            <div class="span4">
                <div class="control-group ">
                    <label class="control-label" for="produto_descricao">Rastreabilidade</label>
                    <div class="controls controls-row">
                        <div class="span12">
                            <input id="rastreabilidade" name="os[rastreabilidade]" class="span12" type="text" value="<?=getValue("os[rastreabilidade]")?>">
                        </div>
                    </div>
                </div>
            </div>
        <?php
        }
            $styleReoperacao = 'style="display:none;"';
            if (in_array($login_fabrica, array(169,170))) {
                $os_revenda = explode("-", getValue('os[sua_os]'));
                $os_revenda = $os_revenda[0];
                if (!empty($os_revenda) && !empty($os) && $tipo_atendimento_descricao == 'Triagem') {
                    $sql = "SELECT * FROM tbl_os WHERE fabrica = {$login_fabrica} AND produto = ".getValue('produto[id]')." AND sua_os LIKE '{$os_revenda}-%' AND tipo_atendimento != {$tipo_atendimento} AND os != {$os} AND serie = '".getValue('produto[serie]')."';";
                    $res = pg_query($con, $sql);
                    if (pg_num_rows($res) == 0) {
                        $styleReoperacao = 'style="display:block;"';
                    } else {
                        $osReoperacaoAbertaId = pg_fetch_result($res, 0, "os");
                        $osReoperacaoAberta = pg_fetch_result($res, 0, "sua_os");
                    }
                }

                if (!empty($osReoperacaoAberta)) { ?>
                    <div class="span3">
                        <div class="control-group">
                            <label class="control-label" for="reoperacao"><?php echo traduz("os.reoperacao");?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <a href="os_press.php?os=<?= $osReoperacaoAbertaId; ?>" target="_blank"><?= $osReoperacaoAberta; ?></a>
                                </div>
                            </div>
                        </div>
                    </div>
                <? } else { ?>
                    <div id='check_reoperacao' class="span3" <?= $styleReoperacao; ?>>
                        <div class="control-group <?=(in_array('os[reoperacao]', $msg_erro['campos'])) ? "error" : "" ?>">
                            <label class="control-label" for="reoperacao"><?php echo traduz("abrir.os.reoperacao");?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <? $checked = (getValue("os[reoperacao]") == 't') ? "CHECKED" : ""; ?>
                                    <input type="checkbox" name="os[reoperacao]" value="t" id="os_reoperacao" <?= $checked; ?> />
                                </div>
                            </div>
                        </div>
                    </div>
                <? }

                $display_produto_defeito_peca = 'style="display:none;"';
                if (!empty($campos["produto"]["defeitos_constatados_multiplos"])) {
                    $sql = "
                        SELECT
                            defeito_constatado
                        FROM tbl_defeito_constatado
                        WHERE fabrica = {$login_fabrica}
                        AND defeito_constatado IN ({$campos["produto"]["defeitos_constatados_multiplos"]})
                        AND lista_garantia = 'sem_defeito';
                    ";
                    $resDfConsPeca = pg_query($con, $sql);

                    if (pg_num_rows($resDfConsPeca) > 0) {
                        $display_produto_defeito_peca = 'style="display:block;"';
                    }
                } ?>
                <div id="div_produto_defeito_peca" class="span3" <?= $display_produto_defeito_peca; ?>>
                    <div class="control-group <?=(in_array('produto[defeito_peca]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="produto_defeito_peca"><?php echo traduz("defeito.da.peca");?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <h5 class='asteristico'>*</h5>
                                <select id="produto_defeito_peca" name="produto[defeito_peca]" class="span12">
                                    <option value="">Selecione</option>
                                    <? if (pg_num_rows($resDfConsPeca) > 0) {
                                        $array_defeito_constatado_sem_defeito = array();
                                        for ($df = 0; $df < pg_num_rows($resDfConsPeca); $df++) {
                                            $array_defeito_constatado_sem_defeito[] = pg_fetch_result($resDfConsPeca, $df, "defeito_constatado");
                                        }
                                        $array_defeito_constatado_sem_defeito = implode(",", $array_defeito_constatado_sem_defeito);
                                        $sql = "
                                            SELECT
                                                d.defeito,
                                                d.codigo_defeito,
                                                d.descricao
                                            FROM tbl_diagnostico dg
                                            JOIN tbl_defeito d ON d.defeito = dg.defeito AND d.fabrica = {$login_fabrica}
                                            WHERE dg.fabrica = {$login_fabrica}
                                            AND dg.defeito_constatado IN ({$array_defeito_constatado_sem_defeito});
                                        ";
                                        $res = pg_query($con, $sql);

                                        if (pg_num_rows($res) > 0) {
                                            while ($result = pg_fetch_object($res)) {
                                                $selected = ($result->defeito == getValue("produto[defeito_peca]")) ? "selected" : ""; ?>
                                                <option value='<?= $result->defeito; ?>' <?= $selected; ?>><?= $result->codigo_defeito.' - '.utf8_decode($result->descricao); ?></option>
                                            <? }
                                        }
                                    } ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            <? }
            $span_size  = ($login_fabrica == 52) ? "span3" : "span2";
            $span_size  = ($login_fabrica == 177) ? "span1" : "span2";
            if($login_fabrica == 193){
                $span_size = "span4";
            }
            $style_span = ($login_fabrica == 52) ? "style='margin-left: 73px; margin-top: 10px;'" : "";
            if (in_array($login_fabrica, array(52))) { ?>
                <div class="row-fluid">
                <div class="span4" id="div_defeito_reclamado" <?= $style_span; ?> >
                    <div class='control-group <?=(in_array('os[defeito_reclamado]', $msg_erro['campos'])) ? "error" : "" ?>'>
                        <label class="control-label" for="defeito_reclamado"><?php echo traduz("defeito.reclamado");?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if ($regras["os|defeito_reclamado"]["obrigatorio"] == true) {
                                    echo "<h5 class='asteristico'>*</h5>";                                    
                                }

                                $produto_id           = getValue('produto[id]');
                                $defeito_reclamado_id = getValue('os[defeito_reclamado]');

                                if($areaAdmin === true) { ?>
                                    <select id="defeito_reclamado" name="os[defeito_reclamado]" class="span12">
                                        <option value="">Selecione</option>
                                        <? if(strlen($produto_id) > 0){
                                            if(strlen($os) ==  0) {
                                                $cond = " AND tbl_defeito_reclamado.ativo IS TRUE ";
                                            }

                                            $sql = "SELECT DISTINCT tbl_defeito_reclamado.defeito_reclamado,
                                                        tbl_defeito_reclamado.descricao
                                                FROM tbl_defeito_reclamado
                                                JOIN tbl_diagnostico ON tbl_diagnostico.defeito_reclamado = tbl_defeito_reclamado.defeito_reclamado
                                                JOIN tbl_produto ON tbl_produto.familia = tbl_diagnostico.familia
                                                WHERE tbl_defeito_reclamado.fabrica = $login_fabrica
                                                AND tbl_produto.produto = $produto_id
                                                $cond
                                                ORDER BY tbl_defeito_reclamado.descricao";

                                            $res = pg_query($con, $sql);

                                            $contadorSQL = pg_num_rows($res);

                                            if($contadorSQL > 0){

                                                for($i = 0; $i < $contadorSQL; $i++){

                                                    $defeito_reclamado = pg_fetch_result($res, $i, "defeito_reclamado");
                                                    $descricao         = pg_fetch_result($res, $i, "descricao");

                                                    $selected = ($defeito_reclamado == $defeito_reclamado_id) ? "SELECTED" : "";

                                                    echo "<option value='{$defeito_reclamado}' {$selected}>{$descricao}</option>";

                                                }
                                            }
                                        } ?>
                                    </select>
                                <? } else {
                                    $sql = "SELECT defeito_reclamado, descricao FROM tbl_defeito_reclamado WHERE defeito_reclamado = {$defeito_reclamado_id};";
                                    $res = pg_query($con, $sql);

                                    if (pg_num_rows($res) > 0) {
                                        $defeito_reclamado_descricao = pg_fetch_result($res, 0, descricao); ?>
                                        <input id="defeito_reclamado" name="os[defeito_reclamado]" class="span12" type="hidden" value="<?= $defeito_reclamado_id; ?>" />
                                        <input name="defeito_reclamado_descricao" class="span12" type="text" value="<?= $defeito_reclamado_descricao; ?>" />
                                    <? }
                                } ?>
                            </div>
                        </div>
                    </div>
                </div>
            <? } ?>

            <?php

            if($login_fabrica == 164){

                if(strlen($os) > 0){

                    $sql_pr = "
                        SELECT
                            JSON_FIELD('numero_serie_calefator',campos_adicionais) AS numero_serie_calefator,
                            JSON_FIELD('numero_serie_interno_placa_motor',campos_adicionais) AS numero_serie_interno_placa_motor,
                            JSON_FIELD('cor_indicativa_carcaca',campos_adicionais) AS cor_indicativa_carcaca
                        FROM tbl_os_campo_extra
                        WHERE
                            fabrica = {$login_fabrica}
                            AND os = {$os}";
                    $res_pr = pg_query($con, $sql_pr);

                    if(pg_num_rows($res_pr) > 0){
                        $display_origem_produto = "block";

                        $numero_serie_calefator           = pg_fetch_result($res_pr,0,"numero_serie_calefator");
                        $cor_indicativa_carcaca           = pg_fetch_result($res_pr,0,"cor_indicativa_carcaca");
                        $numero_serie_interno_placa_motor = pg_fetch_result($res_pr,0,"numero_serie_interno_placa_motor");

                    }

                    $origem_produto = getValue("produto[origem_produto]");

                    if(strlen($origem_produto) > 0 && $origem_produto == "NAC"){
                        $display_origem_produto = "block";
                    }else{
                        $display_origem_produto = "none";
                    }

                }else{

                    $origem_produto = getValue("produto[origem_produto]");

                    if(strlen($origem_produto) > 0 && $origem_produto == "NAC"){
                        $display_origem_produto = "block";
                    }else{
                        $display_origem_produto = "none";
                    }

                    $numero_serie_calefator           = getValue("produto[numero_serie_calefator]");
                    $cor_indicativa_carcaca           = getValue("produto[cor_indicativa_carcaca]");
                    $numero_serie_interno_placa_motor = getValue("produto[numero_serie_interno_placa_motor]");

                }

            ?>

                <input type="hidden" name="produto[origem_produto]" value="<?= getValue("produto[origem_produto]") ?>" />

                <div class="span3 box_numero_serie_calefator" style="display: <?php echo $display_origem_produto; ?>;">
                    <div class="control-group <?=(in_array('produto[numero_serie_calefator]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="numero_serie_calefator"><?php echo traduz("n.de.serie.do.calefator./.motor");?></label>
                        <div class="controls controls-row">
                            <div class="span11">
                                <h5 class='asteristico'>*</h5>
                                <input type="text" name="produto[numero_serie_calefator]" id="numero_serie_calefator" value="<?= $numero_serie_calefator ?>" maxlength="20" class="span12">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span3 box_cor_indicativa_carcaca" style="display: <?php echo $display_origem_produto; ?>;">
                    <div class="control-group <?=(in_array('produto[cor_indicativa_carcaca]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="cor_indicativa_carcaca"><?php echo traduz("cor.indicativa.da.carcaca");?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <h5 class='asteristico'>*</h5>
                                <input type="text" name="produto[cor_indicativa_carcaca]" id="cor_indicativa_carcaca" value="<?= $cor_indicativa_carcaca ?>" maxlength="20" class="span12">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span4 box_numero_serie_interno_placa_motor" style="display: <?php echo $display_origem_produto; ?>; padding-left: 56px; padding-top: 12px;">
                    <div class="control-group <?=(in_array('produto[numero_serie_interno_placa_motor]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="numero_serie_interno_placa_motor"><?php echo traduz("numero.de.serie.interno.placa/motor");?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <h5 class='asteristico'>*</h5>
                                <input type="text" name="produto[numero_serie_interno_placa_motor]" id="numero_serie_interno_placa_motor" value="<?= $numero_serie_interno_placa_motor ?>" maxlength="20" class="span12">
                            </div>
                        </div>
                    </div>
                </div>

            <?php } ?>
            <?php  if ($login_fabrica == 190) {?>
                <div class="span2 mostra_horimetro" style="display: <?php echo getValue('limite_horas_trabalhadas') == true ? '': 'none';?>">
                    <div class='control-group <?=(in_array('os[horimetro]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="horimetro"><?php echo traduz('horimetro');?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?php
                                    if ($regras["os|horimetro"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    }
                                ?>
                                <input id="limite_horas_trabalhadas" name="limite_horas_trabalhadas"  type="hidden" value="<?=getValue('limite_horas_trabalhadas')?>" />
                                <input id="horimetro" name="os[horimetro]" class="span12 numeric" type="text" value="<?=getValue('os[horimetro]')?>" />
                            </div>
                        </div>
                    </div>
                </div>

                <?php }?>
            <?php if (!in_array($login_fabrica, array(175,178))){ ?>

            <div class='<?php echo $span_size; ?>' >
                <? if(in_array($login_fabrica, array(52))) {
                    /* HD 1900165 */
                    ?>
                    <div class='control-group <?=(in_array('produto[marca]', $msg_erro['campos'])) ? "error" : "" ?>' style="margin-top: 10px;">
                        <label class="control-label" for="produto_marca"><?php echo traduz("marca");?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <? if ($regras["produto|marca"]["obrigatorio"] == true) {
                                    echo "<h5 class='asteristico'>*</h5>";
                                }

                                $produto_marca_id = getValue("produto[marca]");
                                if ($areaAdmin === true) {?>
                                    <select id="produto_marca" name="produto[marca]" class="span12" >
                                        <option value=""><?php echo traduz("selecione");?></option>
                                        <?
                                        $sql = "SELECT marca, nome FROM tbl_marca WHERE fabrica = $login_fabrica ORDER BY nome";
                                        $res = pg_query($con, $sql);

                                        if (pg_num_rows($res) > 0) {
                                            while ($result = pg_fetch_object($res)) {
                                                $selected = ($result->marca == $produto_marca_id) ? "selected" : "";
                                                echo "<option value='{$result->marca}' {$selected} >{$result->nome}</option>";
                                            }
                                        }
                                        ?>
                                    </select>
                                <? } elseif(strlen($produto_marca_id)>0){
                                    $sql = "SELECT marca, nome FROM tbl_marca WHERE fabrica = {$login_fabrica} AND marca = {$produto_marca_id};";
                                    $res = pg_query($con, $sql);

                                    if (pg_num_rows($res) > 0) {
                                        $produto_marca_descricao = pg_fetch_result($res, 0, nome); ?>
                                        <input type="hidden" id="produto_marca" name="produto[marca]" value="<?= $produto_marca_id; ?>">
                                        <input name="produto_marca_descricao" class="span12" type="text" value="<?= $produto_marca_descricao; ?>" />
                                    <? }
                                } ?>
                            </div>
                        </div>
                    </div>                
                <?php
                }                

                if(in_array($login_fabrica, array(145,164,165,193))) {

                    if (($login_fabrica == 145 && in_array(getValue("os[tipo_atendimento]"), array(201)) || ($login_fabrica == 164 && $postoInterno == true) || in_array($login_fabrica, [165,193]))) {
                        if ($login_fabrica == 193){
                            $display = "inline-flex";
                        }else{
                            $display = "block";
                        }
                    } else {
                        $display = "none";
                    }

                    if (getValue("produto[troca_produto]") == "t" AND !count($msg_erro["msg"])) {
                        if ($login_fabrica <> 193){
                            $mostra_produto_pecas = "display: none;";
                        }
                        $proibido_trocar_peca = "proibido_trocar_peca";
                        $readonly_troca = "readonly";
                    }
                    ?>
                    <div class="control-group">
                        <div class="checkbox" id="troca_produto" style="display: <?=$display?>;">
                            <br />
                            <input type="hidden" id="status_troca_produto" value="<?=$proibido_trocar_peca?>" />
                            <input type="checkbox" <?=$readonly_troca?> id="check_troca_produto" name="produto[troca_produto]" value="t" <?=(getValue("produto[troca_produto]") == "t") ? "checked" : ""?> /> <?php echo ($login_fabrica == 193) ? traduz("solicitar.troca.produto") : traduz("troca.de.produto");?>
                        </div>
                    </div>
                <?php
                } ?>
            </div>
            <?php } ?>
        </div>

        <?php 
        if ($login_fabrica == 177){

                if (!empty(getValue('produto[lote]')) || getValue('produto[produto_lote_hidden]') == 't') {
                    $display_lote = "";
                }else{
                    $display_lote = "style='display:none;'";
                }
            ?>
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span4" id="lote" <?= $display_lote ?>>
                    <div class='control-group <?=(in_array('produto[lote]', $msg_erro['campos'])) ? "error" : "" ?>'>
                        <label class="control-label" for="lote"><?php echo traduz('lote');?></label>
                        <div class="controls controls-row">
                            <div class="span8">
                                <h5 <?=$display_lote?> class='asteristico h5_lote'>*</h5>
                                <input id="produto_lote" name="produto[lote]" class="span12 numeric" type="text" value="<?=getValue('produto[lote]')?>" />
                                <input type="hidden" id="produto_lote_hidden" name="produto[produto_lote_hidden]" value="<?= getValue('produto[produto_lote_hidden]') ?>" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <?php 
        }
        
        if (in_array($login_fabrica, array(175))) {
        ?>
            <div class='row-fluid'>
                <div class='span1'></div>
                <?php
                if (strlen($preos) > 0 AND !empty(getValue("produto[capacidade]"))){
                    $produto_disparos = "true";
                }
                if (!empty(getValue('os[quantidade_disparos]')) OR getValue('produto_disparos') == 'true' OR !empty(getValue("produto[capacidade]"))){
                    $display_disparo = "";
                }else{
                    $display_disparo = "style='display:none';";
                }
                ?>
                <div class="span3" id="div_qtde_disparos" <?=$display_disparo?> >
                    <input type="hidden" name="produto_disparos" id="produto_disparos" value="<?=$produto_disparos#getValue('produto_disparos')?>">
                    <div class="control-group <?=(in_array('quantidade_disparos', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="quantidade_disparos">Quantidade de Disparos</label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <h5 class='asteristico'>*</h5>
                                <input type="text" class="numeric span12" id="quantidade_disparos" name="os[quantidade_disparos]" value="<?=getValue('os[quantidade_disparos]')?>">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <?php 
        }

        if ( ($usaPostoTecnico && !in_array($login_fabrica, array(175))) || (in_array($login_fabrica, [198]) && ($posto_interno === true || $tipo_posto_interno == 't')) ){
        ?>
            <div class="row-fluid">
                <div class='span1'></div>
                <div class="span4">
                    <?php
                    if ($areaAdmin === true AND !empty($_RESULT["os"]["sua_os"])){
                        $login_posto = $_RESULT["posto"]["id"];
                    }
                    ?>
                    <div class="control-group <?=(in_array('tecnico', $msg_erro['campos'])) ? "error" : "" ?>" >
                        <label class="control-label" for="tecnico"><?= traduz('Tecnico') ?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <select id="tecnico" name="os[tecnico]" class="span9" >
                                    <option value="">Selecione</option>
                                    <?php 
                                        $sql = "
                                            SELECT 
                                                tecnico, 
                                                nome,
                                                codigo_externo,
                                                ativo 
                                            FROM tbl_tecnico 
                                            WHERE posto = $login_posto 
                                            AND ativo IS TRUE
                                            AND fabrica IS NULL
                                        ";
                                        $res = pg_query($con, $sql);
                                        
                                        if (pg_num_rows($res) > 0) {
                                            while ($result = pg_fetch_object($res)) {
                                                if (empty($os) AND !empty($login_unico) AND !count($msg_erro["msg"])){
                                                    $selected = ($result->codigo_externo == $login_unico AND $result->ativo == 't') ? "selected" : "";
                                                }else{
                                                    $selected = ($result->tecnico == getValue("os[tecnico]")) ? "selected" : "";
                                                } 
                                            ?>
                                                <option value='<?=$result->tecnico?>' <?=$selected?> >
                                                    <?=$result->nome?>
                                                </option>
                                            <?php 
                                            }
                                        }
                                    ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <?php } ?>

        <?php if($login_fabrica == 160 or $replica_einhell){ ?>
            <div class='row-fluid' id='comunicado_laudo' style="<?php echo $mostra_comunicado_laudo ?>" >
                <div class='span1'></div>
                <div class='span10'><center>
                    <span style="color:#ff0000" class="alert alert-error"><?php echo traduz("produto.fora.de.garantia.por.favor.realizar.o.download.do.laudo.e.anexar.na.os.junto.com.a.nf.do.produto");?></span>
                    <br>
                    <br>
                    <a href="comunicado_mostra_pesquisa.php?acao=PESQUISAR&tipo=Laudo" target="blank"><?php echo traduz("download.laudo");?></a></center>

                </div>
                <div class='span1'></div>
            </div>


        <? } ?>
        <?php if($login_fabrica == 145) { ?>
            <div id='div_foto'>
                <div id="foto_Produto">
                    <?php
                    if (strlen(getValue("produto[id]")) > 0) {
                        $objAmazonS3 = new AmazonTC('produto', $login_fabrica);
                        $arquivo  = $objAmazonS3->getObjectList(getValue("produto[id]").".");

                        $basename = basename($arquivo[0]);
                        $basename_thumb = "thumb_".$basename;

                        $full  = $objAmazonS3->getLink($basename, false, "", "");
                        $thumb = $objAmazonS3->getLink($basename_thumb, false, "", "");
                        if (!empty($thumb)) {
                            echo "<div class='row-fluid'>";
                                echo "<div class='span1'></div>";
                                echo "<div class='span4'>";
                                    echo "<label class='control-label' for='produto_defeito_constatado'>".traduz("foto.do.produto")."</label>";
                                    echo "<div>";
                                    echo "<a href='$full' target='_blank'> <img src='$thumb' class='anexo_thumb' style='width: 100px; height: 90px;'></a>";
                                    echo "</div>";
                                echo "</div>";
                            echo "</div>";
                            echo "<script> setupZoom(); </script>";
                        }
                    }
                    ?>
                </div>
            </div>
        <? }
        if (in_array($login_fabrica, array(143,152,180,181,182)) || isset($defeitoConstatadoMultiplo)) { ?>

            <div style='clear: both;'></div>

            <div class='row-fluid' style="height: auto !important;">

                <div class="span1"></div>

                <div class="span10">
                    <input type="hidden" name="produto[defeitos_constatados_multiplos]" id="defeitos_constatados_multiplos" value="<?= $campos['produto']['defeitos_constatados_multiplos']; ?>" />

                    <?php
                    $colspan_defeito = 2;

                    if (in_array($login_fabrica, array(152,180,181,182))) {
                        $colspan_defeito = 3;
                    }

                    if ($hide_defeito_constatado) {
                        $colspan_defeito = 1;
                    }
                    ?>

                    <table class="table table-bordered box-defeitos" style="table-layout: fixed;" >
                        <thead>
                            <tr>
                                <th class="titulo_coluna" colspan="<?=$colspan_defeito?>" ><?php echo traduz("Defeitos Selecionados");?></th>
                            </tr>
                            <tr>
                                <th class="titulo_coluna" ><?php echo traduz("defeito");?></th>
                                <?
                                if (in_array($login_fabrica, array(152,180,181,182))) {
                                ?>
                                    <th class="titulo_coluna" ><?php echo traduz("tempo.de.reparo");?></th>
                                <?
                                }

                                if (!$hide_defeito_constatado) {
                                ?>
                                    <th class="titulo_coluna" > <?php echo traduz("acao");?></th>
                                <?php
                                }
                                ?>
                            </tr>
                        </thead>
                        <tbody>
                            <? if (empty($campos["produto"]["defeitos_constatados_multiplos"])) { ?>
                                <?php if($login_fabrica == 148){ 
                                    $display = 'style="display: none"';
                                } ?>
                                <tr class="sem_defeito_selecionado error" >
                                    <td class="tac" colspan="<?=$colspan_defeito?>" ><?php echo traduz("selecione.os.defeitos.constatados");?></td>
                                </tr>
                               
                            <? } else {
                                $defeitos_multi = explode(",", $campos["produto"]["defeitos_constatados_multiplos"]);

                                /*
                                 * Validar se já existe pedido para uma peça e não deixa remover defeitos constatados
                                */
                                if (in_array($login_fabrica, array(158,169,170))) {
                                    $pecas_valores = getValue("produto_pecas");
                                    $existePedido = 0 < count(
                                        array_filter(
                                            $pecas_valores,
                                            function ($a) {
                                                return array_key_exists('os_item', $a) && !empty($a['os_item']) && verifica_os_item($a['os_item']);
                                            }
                                        )
                                    );
                                    if ($existePedido) {
                                        $bloqRemovDefeitoConst = "disabled title='".traduz("nao.e.possivel.remover.o.defeito.constatado.pois.ja.existem.pecas.com.pedido")."'";
                                    } else {
                                        $bloqRemovDefeitoConst = "";
                                    }
                                } else {
                                    $bloqRemovDefeitoConst = "";
                                }

                                $defeito_peca_obrigatoria = false;

                                if($login_fabrica == 148){ 
                                   $display = 'style="display: block"';
                                }

                                $count_defeitos_multi = count($defeitos_multi);
                                for($i = 0; $i < $count_defeitos_multi; $i++){
                                    $defeito = $defeitos_multi[$i];
                                    //$descricao = descricao_defeito($defeito);
                                    $info_defeito = info_defeito($defeito);
                                    if (in_array($login_fabrica, array(169,170))){
                                        $descricao = $info_defeito["codigo"].' - '.$info_defeito["descricao"];
                                    }else{
                                        $descricao = $info_defeito["descricao"];
                                    }

                                    $lancar_peca = $info_defeito["lancar_peca"];
                                    $lista_garantia = $info_defeito["lista_garantia"];

                                    if ($lancar_peca == "t" && !$defeito_peca_obrigatoria) {
                                        $defeito_peca_obrigatoria = true;
                                    }
                                    ?>

                                    <tr id='box-defeito-<?=$defeito?>' class='tbl-defeitos-selecionados' >
                                        <td>
                                            <?=$descricao?>
                                            <?php
                                            if (in_array($login_fabrica, array(169,170)) && $lista_garantia == "fora_garantia") {
                                            ?>
                                                <br /><span class='label label-warning defeito-fora-garantia' style='white-space: normal;' ><?php echo traduz("para.o.defeito.selecionado.nao.e.obrigatorio.informar.o.numero.da.nota.fiscal.data.da.compra.anexo.e.nao.e.possivel.lancar.pecas");?></span>
                                                <script>
                                                    $(function() {
                                                        $("#nota_fiscal").prev("h5").hide();
                                                        $("#data_compra").prev("h5").hide();
                                                        $("#nota_obrigatoria, #anexo_obrig, #produto_pecas").hide();
                                                    });
                                                </script>
                                            <?php
                                            }

                                            if (in_array($login_fabrica, array(169,170)) && $lista_garantia == "sem_defeito") {
                                            ?>
                                                <br /><span class='label label-warning defeito-sem-defeito' style='white-space: normal;' ><?php echo traduz("para.o.defeito.selecionado.nao.e.possivel.lancar.pecas");?></span>
                                                <script>
                                                    $(function() {
                                                        $("#produto_pecas").hide();
                                                    });
                                                </script>                                             
                                            <?php
                                            }

                                            if ($lancar_peca == "t") {
                                            ?>
                                                <br /><span class='label label-warning' style='white-space: normal;' ><?php echo traduz("obrigatorio.o.lancamento.de.peca.s.para.o.defeito.constatado");?></span>
                                            <?php
                                            }
                                            ?>
                                        </td>
                                        <? if (in_array($login_fabrica, array(152,180,181,182))) {
                                            $tempo_reparo_defeito = $campos["produto"]["tempo_reparo_defeito"][$defeito]; ?>
                                            <td>
                                                <input type="text" class="numeric" id="produto_tempo_reparo_defeito_<?=$defeito?>" name="produto[tempo_reparo_defeito][<?=$defeito?>]" style="width: 50px;" value="<?=$tempo_reparo_defeito?>" />
                                                &nbsp;<strong style="color: #b94a48" >(<?php echo traduz("informar.em.minutos");?>)</strong>
                                            </td>
                                            <script>
                                                $(function(){
                                                    $("#produto_tempo_reparo_defeito_<?=$defeito?>").attr("readonly", false);
                                                });                                                
                                            </script>
                                        <?
                                        }

                                        if(in_array($login_fabrica, array(157)) && strlen($os) > 0 and $areaAdmin == false){

                                            $sql_os_auditoria = "SELECT os FROM tbl_auditoria_os WHERE os = {$os} AND liberada IS NULL";
                                            $res_os_auditoria = pg_query($con, $sql_os_auditoria);

                                            if(pg_num_rows($res_os_auditoria) > 0){
                                                $bloqRemovDefeitoConst = "disabled title='".traduz("Não é possível remover o defeito constatado pois a OS se encontra em auditoria")."'";
                                            }
                                        }

                                        if (!($hide_defeito_constatado)) {
                                        ?>
                                            <td class="tac" style="vertical-align: middle;<?= $displayBtnRemover ?>" ><button type='button' class='btn btn-danger btn-small removerDefeito' data-defeito-id="<?=$defeito?>" data-loading-text='Removendo...' <?= $bloqRemovDefeitoConst; ?>><?php echo traduz("remover");?></button></td>
                                        <?php
                                        }
                                        ?>
                                    </tr>
                                <? }
                            } ?>
                        </tbody>
                    </table>
                    <?php if($login_fabrica == 148): ?>
                        <script>
                            $(document).on("keydown", "#detalhes_do_defeito_constatado", function () {
                                var caracteresDigitados = parseInt($(this).val().length);

                                $(".caracteres").text(caracteresDigitados);
                            });
                        </script>
                        <div id="descricao_defeito_148" <?=$display?>>
                            <div class="span12">
                                <label class="control-label" for="produto[detalhes_defeito]">Detalhes  da Falha</label>
                                <textarea id="detalhes_do_defeito_constatado" name="produto[detalhes_defeito]" class="span12" style="height: 50px;"><?= (!empty(getValue('produto[detalhes_defeito]'))) ? getValue('produto[detalhes_defeito]') : '' ?></textarea> <br>
                                <span class="caracteres">0</span> Digitados <br>
                            </div>
                        </div>
                    <?php endif;?>
                </div>
            </div>

        <? } ?>

    	<?php if ($login_fabrica == 178) { ?>
    	    <div class='row-fluid'>
                <div class='span1'></div>
                <?php if (($produto_possui_troca !== true && $troca_garantia != "t") || $troca_garantia == "t") {
                    $trocar_produto = getValue("produto[solicita_troca]");
                    $displayTroca = ($trocar_produto == "t" OR $troca_garantia == "t") ? "block" : "none"; ?>
                    <div class="span3" id="div_solicita_troca_produto">
                        <div class="control-group <?=(in_array('produto[solicita_troca]', $msg_erro['campos'])) ? "error" : "" ?>">
                            <div class="controls controls-row">
                                <br />
                                <div class="span12">
                                    <?
                                    if($trocar_produto == 't' OR $troca_garantia == "t"){
                                        $checked = " checked ";
                                    } else {
                                        $checked = "";
                                    } ?>
                                    <input type="checkbox" name="produto[solicita_troca]" value="t" <?= $checked ?> id="solicita_troca" >
                                    <label class="control-label" for="solicita_troca"><?php echo traduz('solicitar.troca.de.produto');?></label>
                                    <input type="hidden" name="produto[produto_fora_linha]" id="produto_fora_linha" value="<?=getValue("produto[produto_fora_linha]")?>">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="span3" id="div_enviar_para" style="display:<?=$displayTroca?>">
            		<div class="control-group <?=(in_array('produto[enviar_para]', $msg_erro['campos'])) ? "error" : "" ?>">
                	    <label class="control-label" for="enviar_para"><?php echo traduz("enviar.para");?></label>
			    <div class="controls controls-row">
        		       	<select class="span10" id="enviar_para" name="produto[enviar_para]">
              					<option value="P">Posto Autorizado</option>
    		        			<?php if (!empty($os_id) AND getValue("os[consumidor_revenda]") == "R"){ ?>
                                <option value="R">Revenda</option>		
                                <?php } ?>
                            </select>
            		    </div>
        	        </div>
    		    </div> 
     
        		<div class="span4" id="div_marca_produto_troca" style="display:<?=$displayTroca?>;">
        			<div class="control-group <?=(in_array('produto[trocar_produto]', $msg_erro['campos'])) ? "error" : "" ?>">
        				<label class="control-label" for="solucao"><?php echo traduz("marca.produto.troca");?></label>
        				<div class="controls controls-row">
    						<select class="span10" id="marca_produto_troca" name="produto[marca_produto_troca]">
                                <option value=''></option>
    						</select>
        				</div>
        			</div>
        		</div>
            </div>
            <div class='row-fluid'>
                <div class='span7'></div>
                <div class="span4" id="div_produto_troca" style="display:<?=$displayTroca?>;">
                    <div class="control-group <?=(in_array('produto[produto_troca]', $msg_erro['campos'])) ? "error" : "" ?>">
                        <label class="control-label" for="solucao"><?php echo traduz("produto.troca");?></label>
                        <div class="controls controls-row">
                            <div class="span10">
                                <select id="produto_troca" name="produto[produto_troca]">
                                    <option value=''></option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <?php }
	}

        if (in_array($login_fabrica, [184,195,200]) && verifica_pecas_lancadas($os)) {
            $produto_mostra_trocar = "style='display: block;'";
        } ?>
    
        <input type="hidden" name="produto[produto_troca_obrigatoria]" id="produto_troca_obrigatoria" value="<?=getValue('produto[produto_troca_obrigatoria]')?>" />
        <div class='row-fluid div_p' id="div_trocar_produto" <?= $produto_mostra_trocar; ?>>
            <div class="span1"></div>
            <?php $spN = ($login_fabrica == 158) ? "span5" : "span10"; ?>
            <div class="<?=$spN?>">
                <div style='padding-top: 10px; padding-bottom: 10px;'>
                    <button type="button" id="trocar_produto" class="btn btn-danger" ><?php echo traduz("alterar.produto");?></button>
                </div>
            </div>

            <?php if ($login_fabrica == 158) { 
                $solucao_lancada = (empty($campos['produto']['solucao_lancada'])) ? implode(',', $_RESULT['produto']['solucao']) : $campos['produto']['solucao_lancada'];
                $mostraDiv = "display: none;";
                if (!empty($solucao_lancada)) {
                    $sqlPdv = "SELECT solucao FROM tbl_solucao WHERE fabrica = {$login_fabrica} AND solucao IN ({$solucao_lancada}) AND parametros_adicionais->>'programacao_pdv' = 'true' ";
                    $resPdv = pg_query($con, $sqlPdv);
                    if (pg_num_rows($resPdv) > 0) {
                        $mostraDiv = "display: block;";
                    }
                }

            ?>
                    <div id="div_pdv" style="<?=$mostraDiv?>">
                        <div class="span6" id="div_pdv_degelo">
                            <div class="control-group <?=(in_array('produto[pdv_chegada]', $msg_erro['campos'])) ? "error" : "" ?>">
                                <div class="controls controls-row span8">
                                    <label class="control-label" for="pdv_chegada"><?php echo traduz("Programação no Ato da Chegada no PDV:");?>&nbsp;</label>
                                </div>
                                <div class="controls controls-row span3">
                                    <input placeholder="27.7" class="span9 pdv_mask" min="-30.0" max="30.0" step="0.1" type="number" name="pdv_chegada" value="<?=(empty(getValue('produto[pdv_chegada]'))) ? $campos['produto']['pdv_chegada'] : getValue('produto[pdv_chegada]')?>">
                                </div>
                            </div>
                            <br />
                            <br />
                            <div class="control-group <?=(in_array('produto[pdv_saida]', $msg_erro['campos'])) ? "error" : "" ?>">
                                <div class="controls controls-row span8">
                                    <label class="control-label" for="pdv_saida"><?php echo traduz("Programação na Saída do PDV:");?>&nbsp;</label>
                                </div>
                                <div class="controls controls-row span3">
                                    <input placeholder="17.7" class="span9 pdv_mask" min="-30" max="30" step="0.1" type="number" name="pdv_saida" value="<?=(empty(getValue('produto[pdv_saida]'))) ? $campos['produto']['pdv_saida'] : getValue('produto[pdv_saida]')?>">
                                </div>
                            </div>
                        </div>
                    </div>
            <?php } ?>
        </div>
        <?php if($login_fabrica == 153) {
            $display_acessorio = 'display:none;';

            if($descricao_laudo_zero_hora != "Laudo Zero Hora"){
                if(strlen(trim(getValue("produto[id]")))>0){
                    $produto_id = getValue("produto[id]");

                    $acessorios = getValue("os[acessorios]");

                    $acessorios = explode(", ", $acessorios);

                    $sql = "SELECT tbl_peca.descricao, tbl_peca.referencia, tbl_lista_basica.type
                            FROM tbl_lista_basica
                            INNER JOIN tbl_peca on tbl_lista_basica.peca = tbl_peca.peca
                            WHERE tbl_lista_basica.produto = $produto_id
                            AND tbl_lista_basica.fabrica = $login_fabrica
                            AND tbl_lista_basica.type = 'acessorio'";
                    $res = pg_query($con, $sql);
                    $contadorSQL = pg_num_rows($res);
                    if($contadorSQL > 0){
                        $dados_acessorios .= "<table>";
                        for($i=0; $i<$contadorSQL; $i++){

                            $descricao = pg_fetch_result($res, $i, 'descricao');
                            $referencia = pg_fetch_result($res, $i, 'referencia');

                            if (in_array($descricao, $acessorios)) {
                                $checked = " checked ";
                            }else{
                                $checked = "";
                            }

                            if(isset($_POST['produto']['acessorio'])){
                                if(in_array($descricao, $_POST['produto']['acessorio'])){
                                    $checked = " checked ";
                                }else{
                                    $checked = "";
                                }
                            }

                            if($i == 0){
                                $dados_acessorios .= " <tr class='$i'>";
                            }elseif($i % 3 == 0){
                                $dados_acessorios .= "</tr  class='$i'>";
                                $dados_acessorios .= " <tr class='$i'>";
                            }

                            $dados_acessorios .= "<td>
                                <input id='produto_acessorio' name='produto[acessorio][$descricao]' type='checkbox' $checked  value='$descricao' />
                            ".substr($descricao, 0, 27). "&nbsp&nbsp&nbsp
                            </td>";
                        }
                        $dados_acessorios .= "</table>";
                    }
                    $display_acessorio = 'display:block;';
                }
            }

        ?>
        <div id="positron_acessorio" style="<?=$display_acessorio?>">
            <div class="row-fluid" >
                <div class="titulo_tabela"><?php echo traduz("acessorios");?></div>
            </div>
            <div class="row-fluid" >
                <div class="span1"></div>
                <div class="span10" id="acessorio_positron">
                    <?php echo $dados_acessorios ?>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <?php }	?>
        <br />
        <div style='clear: both;'></div>

    </div>
    <br />

    <?php

    if (isset($fabrica_usa_subproduto)) {
        if (strlen(getValue("subproduto[id]")) > 0 || verifica_subproduto(getValue("produto[id]")) === true) {
            $subproduto_mostra_div = "style='display: block;'";
        }

        if (strlen(getValue("subproduto[id]")) > 0) {
            $subproduto_readonly      = "readonly='readonly'";
            $subproduto_esconde_lupa  = "style='display: none;'";
            $subproduto_mostra_trocar = "style='display: block;'";
        }

        if (strlen(getValue("subproduto[os_produto]")) > 0) {
            $subproduto_possui_troca = verificaOsProdutoTroca(getValue("subproduto[os_produto]"));
        } ?>

        <div id="div_informacoes_subproduto" <?=$subproduto_mostra_div?> >
            <div class="tc_formulario">
                <div class="titulo_tabela"><?php echo traduz("informacoes.do.subconjunto");?></div>

                <br />

                <?php
                unset($btn_comunicado_disabled, $comunicados_produto);

                $btn_comunicado_text = traduz("comunicados");

                if (strlen(getValue("subproduto[id]")) > 0) {
                    $comunicados_produto = busca_comunicados_produto(getValue("subproduto[id]"));

                    if (empty($comunicados_produto)) {
                        $btn_comunicado_text     = traduz("nao.ha.comunicados.para.o.produto");
                        $btn_comunicado_disabled = "disabled='disabled'";
                    }
                }

                ?>

                <br />

                <p class="tac" >
                    <button type="button" class="btn btn-warning btn-small comunicados-subproduto" title="<?php echo traduz("comunicados.para.o.produto.lancado");?>" <?=$btn_comunicado_disabled?> ><i class="icon-info-sign icon-white" ></i> <?=$btn_comunicado_text?></button>
                </p>

                <div class="modal hide fade modal-comunicados-subproduto">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h3><?php echo traduz("comunicados");?></h3>
                    </div>
                    <div class="modal-body">
                        <table class="table table-bordered table-striped" >
                            <thead>
                                <tr class="titulo_coluna" >
                                    <th><?php echo traduz("comunicado");?></th>
                                    <th><?php echo traduz("tipo");?></th>
                                    <th><?php echo traduz("data");?></th>
                                    <th>&nbsp;</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php
                                if (isset($comunicados_produto) && !empty($comunicados_produto)) {
                                    $url = ($areaAdmin) ? "comunicado_produto.php" : "comunicado_mostra.php";

                                    foreach ($comunicados_produto as $i => $comunicado) {
                                        unset($comunicado_anexo_link);

                                        $link = busca_comunicado_anexo($comunicado["comunicado"], $comunicado["extensao"], $comunicado["tipo"]);

                                        if (!is_null($link)) {
                                            $comunicado_anexo_link = "
                                                <a href='{$link}' target='_blank' title='".traduz("visualizar.anexo.d.ocomunicado")."' >
                                                    <button type='button' class='btn btn-info btn-mini' >
                                                        <i class='icon-file icon-white' ></i>
                                                    </button>
                                                </a>
                                            ";
                                        }

                                        echo "
                                            <tr>
                                                <td>{$comunicado['descricao']}</td>
                                                <td>{$comunicado['tipo']}</td>
                                                <td class='tac' >{$comunicado['data_comunicado']}</td>
                                                <td class='tac' >
                                                    {$comunicado_anexo_link}
                                                    <a href='{$url}?comunicado={$comunicado['comunicado']}' target='_blank' >
                                                        <button type='button' class='btn btn-info btn-mini' title='".traduz("visualizar.comunicado")."' >
                                                            <i class='icon-search icon-white' ></i>
                                                        </button>
                                                    </a>
                                                </td>
                                            </tr>
                                        ";
                                    }
                                }
                                ?>
                            </tbody>
                        </table>
                    </div>
                </div>

                <br />

                <input type="hidden" id="subproduto_id" name="subproduto[id]" value="<?=getValue('subproduto[id]')?>" />
                <input type="hidden" name="subproduto[os_produto]" value="<?=getValue('subproduto[os_produto]')?>" />

                <div class="row-fluid">
                    <div class="span1"></div>

                    <div class="span3">
                        <div class='control-group <?=(in_array('subproduto[id]', $msg_erro['campos'])) ? "error" : "" ?>' >
                            <label class="control-label" for="subproduto_referencia"><?php echo traduz("referencia");?></label>
                            <div class="controls controls-row">
                                <div class="span10 input-append">
                                    <h5 class='asteristico'>*</h5>
                                    <input id="subproduto_referencia" name="subproduto[referencia]" class="span12" type="text" value="<?=getValue('subproduto[referencia]')?>" <?=$subproduto_readonly?> />
                                    <span class="add-on" rel="lupa_subproduto" <?=$subproduto_esconde_lupa?> >
                                        <i class="icon-search"></i>
                                    </span>
                                    <input type="hidden" name="lupa_config" tipo="subproduto" parametro="referencia" posto="<?=$login_posto?>" ativo="t" produto="" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="span3">
                        <div class='control-group <?=(in_array('subproduto[id]', $msg_erro['campos'])) ? "error" : "" ?>' >
                            <label class="control-label" for="subproduto_descricao"><?php echo traduz("decricao");?></label>
                            <div class="controls controls-row">
                                <div class="span10 input-append">
                                    <h5 class='asteristico'>*</h5>
                                    <input id="subproduto_descricao" name="subproduto[descricao]" class="span12" type="text" value="<?=getValue('subproduto[descricao]')?>" <?=$subproduto_readonly?> />
                                    <span class="add-on" rel="lupa_subproduto" <?=$subproduto_esconde_lupa?> >
                                        <i class="icon-search"></i>
                                    </span>
                                    <input type="hidden" name="lupa_config" tipo="subproduto" parametro="descricao" posto="<?=$login_posto?>" ativo="t" produto="" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="span1">
                        <div class='control-group <?=(in_array('subproduto[voltagem]', $msg_erro['campos'])) ? "error" : "" ?>' >
                            <label class="control-label" for="subproduto_voltagem"><?php echo traduz("voltagem");?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <?php
                                        if ($regras["subproduto|voltagem"]["obrigatorio"] == true) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                        }
                                    ?>
                                    <input id="subproduto_voltagem" name="subproduto[voltagem]" class="span12" type="text" value="<?=getValue('subproduto[voltagem]')?>" readonly="readonly" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="span3">
                        <div class='control-group <?=(in_array('subproduto[serie]', $msg_erro['campos'])) ? "error" : "" ?>' >
                            <label class="control-label" for="subproduto_serie"><?php echo traduz("numero.de.serie");?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <?php
                                    if (strlen(getValue('subproduto[id]')) > 0 && $login_fabrica != 145) {
                                        $sql = "SELECT produto FROM tbl_produto WHERE fabrica_i = {$login_fabrica} AND produto = ".getValue("subproduto[id]")." AND numero_serie_obrigatorio IS TRUE";
                                        $res = pg_query($con, $sql);

                                        if (pg_num_rows($res) > 0) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                        }
                                    }
                                    ?>
                                    <input id="subproduto_serie" name="subproduto[serie]" class="span12" type="text" value="<?=getValue('subproduto[serie]')?>" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="span1"></div>
                </div>

                <div class="row-fluid">
                    <div class="span1"></div>

                    <div class="span5">
                        <div class="control-group <?=(in_array('subproduto[defeito_constatado]', $msg_erro['campos'])) ? "error" : "" ?>">
                            <label class="control-label" for="subproduto_defeito_constatado"><?php echo traduz("defeito.constatado");?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <?php
                                        if ($regras["subproduto|defeito_constatado"]["obrigatorio"] == true) {
                                            echo "<h5 class='asteristico'>*</h5>";
                                        }
                                    ?>
                                    <select id="subproduto_defeito_constatado" name="subproduto[defeito_constatado]" class="span12" >
                                        <option value=""><?php echo traduz("selecione");?></option>

                                        <?php

                                        if (strlen(getValue('subproduto[id]')) > 0) {
                                            $sql = "SELECT distinct tbl_defeito_constatado.defeito_constatado, tbl_defeito_constatado.descricao
                                                    FROM tbl_diagnostico
                                                    INNER JOIN tbl_defeito_constatado ON tbl_defeito_constatado.defeito_constatado = tbl_diagnostico.defeito_constatado AND tbl_defeito_constatado.fabrica = {$login_fabrica}
                                                    INNER JOIN tbl_familia ON tbl_familia.familia = tbl_diagnostico.familia AND tbl_familia.fabrica = {$login_fabrica}
                                                    INNER JOIN tbl_produto ON tbl_produto.familia = tbl_familia.familia AND tbl_produto.fabrica_i = {$login_fabrica}
                                                    WHERE tbl_diagnostico.fabrica = {$login_fabrica}
                                                    AND tbl_produto.produto = ".getValue("subproduto[id]")."
                                                    AND tbl_diagnostico.ativo IS TRUE
                                                    ORDER BY tbl_defeito_constatado.descricao ASC";
                                            $res = pg_query($con, $sql);

                                            if (pg_num_rows($res) > 0) {
                                                while ($result = pg_fetch_object($res)) {
                                                    $selected = ($result->defeito_constatado == getValue("subproduto[defeito_constatado]")) ? "selected" : "";

                                                    echo "<option value='{$result->defeito_constatado}' {$selected} >{$result->descricao}</option>";
                                                }
                                            }
                                        }

                                        ?>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="span1"></div>
                </div>

                <?php
                if ($subproduto_possui_troca != true) {
                ?>
                    <div id="div_trocar_subproduto" class="row-fluid" <?=$subproduto_mostra_trocar?> >
                        <div class="span1"></div>
                        <div class="span11">
                            <button type="button" id="trocar_subproduto" class="btn btn-danger" ><?php echo traduz("alterar.subconjunto");?></button>
                        </div>
                    </div>
                <?php
                }
                ?>
            </div>
            <br />
        </div>
    <?php

    }

    if(in_array($login_fabrica,array(138,148,191))) {

    ?>
        <div id="div_informacoes_solucao" class="tc_formulario">
            <?php if(in_array($login_fabrica, array(191))){ ?>
                    <div class="titulo_tabela"><?php echo traduz("Serviço Realizado / Solução");?></div>
            <?php }else{ ?>
                    <div class="titulo_tabela"><?php echo traduz("solucao");?></div>
            <?php } ?>

            <br />
            <div class="row-fluid">
                <div class="span1"></div>

                <div class="span8">
                    <div class='control-group <?=(in_array('os[solucao]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <div class="controls controls-row">
                            <div class="span12 tac">
                                <?php
                                    if ($regras["os|solucao"]["obrigatorio"] == true || $login_fabrica == 138) {
                                        echo "<strong class='asteristico' style='float: none;'>*</strong>";
                                    }
                                ?>
                                <select id="solucao" name="os[solucao]" class="span9">
                                    <option value=""><?php echo traduz("selecione");?></option>

                                    <?php
                                    if (strlen(getValue("produto[id]")) > 0) {
                                        if (empty($tipo_produto) && !isset($usaSolucaoLinha) && !isset($usaSolucaoFamilia)) {
                                            $sql = "SELECT  tbl_solucao.solucao,
                                                            tbl_solucao.descricao
                                                    FROM    tbl_diagnostico
                                                    JOIN    tbl_solucao ON  tbl_solucao.solucao = tbl_diagnostico.solucao
                                                                        AND tbl_solucao.fabrica = {$login_fabrica}
                                                    JOIN    tbl_familia ON  tbl_familia.familia = tbl_diagnostico.familia
                                                                        AND tbl_familia.fabrica = {$login_fabrica}
                                                    JOIN    tbl_produto ON  tbl_produto.familia = tbl_familia.familia
                                                                        AND tbl_produto.fabrica_i = {$login_fabrica}
                                                    WHERE   tbl_diagnostico.fabrica     = {$login_fabrica}
                                                    AND     tbl_produto.produto         = {$produto}
                                                    AND     tbl_diagnostico.ativo       IS TRUE
                                                    AND     tbl_diagnostico.diagnostico NOT IN(SELECT diagnostico FROM tbl_diagnostico_produto)

                                                    UNION

                                                    SELECT  tbl_solucao.solucao,
                                                            tbl_solucao.descricao
                                                    FROM    tbl_diagnostico
                                                    JOIN    tbl_solucao             ON  tbl_solucao.solucao             = tbl_diagnostico.solucao
                                                                                    AND tbl_solucao.fabrica             = {$login_fabrica}
                                                    JOIN    tbl_familia             ON  tbl_familia.familia             = tbl_diagnostico.familia
                                                                                    AND tbl_familia.fabrica             = {$login_fabrica}
                                                    JOIN    tbl_produto             ON  tbl_produto.familia             = tbl_familia.familia
                                                                                    AND tbl_produto.fabrica_i           = {$login_fabrica}
                                                                                    AND tbl_produto.familia             = tbl_diagnostico.familia
                                                    JOIN    tbl_diagnostico_produto ON  tbl_diagnostico.diagnostico     = tbl_diagnostico_produto.diagnostico
                                                                                    AND tbl_diagnostico_produto.produto = tbl_produto.produto
                                                    WHERE   tbl_diagnostico.fabrica = {$login_fabrica}
                                                    AND     tbl_produto.produto     = {$produto}
                                                    AND     tbl_diagnostico.ativo   IS TRUE";
                                        } else {
                                            $sql = "SELECT  DISTINCT
                                                            tbl_solucao.solucao,
                                                            tbl_solucao.descricao
                                                    FROM    tbl_diagnostico
                                                    JOIN    tbl_solucao ON  tbl_solucao.solucao = tbl_diagnostico.solucao
                                                                        AND tbl_solucao.fabrica = {$login_fabrica}
                                                    JOIN    tbl_familia ON  tbl_familia.familia = tbl_diagnostico.familia
                                                                        AND tbl_familia.fabrica = {$login_fabrica}
                                                    JOIN    tbl_produto ON  tbl_produto.familia = tbl_familia.familia
                                                                        AND tbl_produto.fabrica_i = {$login_fabrica}
                                                    WHERE   tbl_diagnostico.fabrica = {$login_fabrica}
                                                    AND     tbl_produto.produto = ".getValue("produto[id]")."
                                                    AND     tbl_diagnostico.ativo IS TRUE
                                            ORDER BY      tbl_solucao.descricao ASC";
                                        }
                                        $res = pg_query($con, $sql);

                                        if (pg_num_rows($res) > 0) {
                                            while ($result = pg_fetch_object($res)) {
                                                $selected = ($result->solucao == getValue("os[solucao]")) ? "selected" : "";
                                                echo "<option value='{$result->solucao}' {$selected} >{$result->descricao}</option>";
                                            }
                                        }
                                    }

                                    ?>
                                </select>
                                <? if(in_array($login_fabrica,array(138,148,191))) { ?>

                                <script type="text/javascript">

                                    <?php

                                        $solucoes_multiplos = getValue("produto[solucoes_multiplos]");

                                        if(!empty($solucoes_multiplos)){
                                            $campos["produto"]["solucoes_multiplos"] = $solucoes_multiplos;
                                        }

                                        if(!empty($campos["produto"]["solucoes_multiplos"])){

                                            $arr = explode(",", $campos["produto"]["solucoes_multiplos"]);

                                            $array_solucoes = "";

                                            for ($i = 0; $i < count($arr); $i++) {
                                                $array_solucoes .= "'".$arr[$i]."'";
                                                if($i < count($arr)){
                                                    $array_solucoes .= ",";
                                                }
                                            }

                                        }
                                    ?>

                                    var solucoes = [<?=$array_solucoes?>];

                                    function addSolucoes(){
                                        <?php if($login_fabrica == 148) : ?>
                                            $('#descricao_solucao_148').css('display', 'block')
                                        <?php endif; ?>
                                        var solucao = $("#solucao").val();
                                        var descricao = $("#solucao option:selected").text();

                                        if(solucao == ""){
                                            alert("<?php echo traduz("por.favor.selecione.uma.solucao");?>!");
                                            $("#solucao").focus();
                                            return;
                                        }

                                        var verifica = verificaSolucoes(solucao);

                                        if(verifica){
                                            alert("<?php echo traduz("solucao.ja.selecionada");?>!");
                                            return;
                                        }

                                        <?php if(in_array($login_fabrica,[191])){ ?>

                                                 $.ajax({
                                                    url: "cadastro_os.php",
                                                    type: "POST",
                                                    data: {ajax_mo_solucao : true, solucao : solucao, produto : $("#produto_id").val()},
                                                    }).fail(function(){

                                                        descricao = descricao + " - M.O: 0.00";
                                                    }).done(function(data){

                                                        data = JSON.parse(data);
                                                        console.log(data);
                                                        if (data.success == "ok"){
                                                            descricao = descricao + " - Mão de Obra: " + parseFloat(data.mao_obra).toFixed(2);

                                                        }else{
                                                            
                                                            descricao = descricao + " - M.O: 0.00";
                                                        }
                                                        
                                                    });
                                                    
                                        <?php } ?>

                                        setTimeout(function(){
                                            if(solucoes.length == 0)
                                                $(".box-solucoes").html("");

                                            solucoes.push(solucao);

                                            var div_solucao = "<div class='breadcrumb span8' id='box-solucao-"+solucao+"' data='"+descricao+"' style='margin-left: 0px; margin-right: 5px;'><span class='icon-remove' onclick='delSolucoes(\""+solucao+"\")' title='<?php echo traduz("remover.solucao");?>'></span> "+descricao+"</div>";

                                            $(".box-solucoes").append(div_solucao);

                                            $("#solucoes_multiplos").val(solucoes);

                                            removeSolucoesSel(solucao);
                                        },100);


                                    }

                                    function verificaSolucoes(sol){

                                        if(solucoes.length == 0){
                                            return false;
                                        }else{
                                            if(in_array(sol,solucoes) != -1){
                                                return true;
                                            }else{
                                                return false;
                                            }
                                        }

                                    }

                                    function removeSolucoesSel(sol){

                                        if(solucoes.length == 0){
                                            return false;
                                        }else{
                                            $("#solucao").find("option").each(function(){
                                                if ($(this).val() == sol){
                                                    $(this).remove();
                                                }
                                            });
                                        }

                                    }

                                    function delSolucoes(sol){

                                        remove(solucoes, sol);

                                        var option ;
                                        var desc ;

                                        desc = $("#box-solucao-"+sol).attr("data");
                                        option = "<option value='"+sol+"'>"+desc+"</option>" ;

                                        $("#box-solucao-"+sol).remove();

                                        $("#solucoes_multiplos").val(solucoes);
                                        $("#solucao").append(option);

                                        if(solucoes.length == 0)
                                                $(".box-solucoes").html("<?php echo traduz("selecione.as.solucoes");?>");

                                    }

                                    function in_array(needle, haystack){
                                        var found = 0;
                                        for (var i = 0, len = haystack.length; i < len; i++) {
                                            if (haystack[i] == needle) return i;
                                                found++;
                                        }
                                        return -1;
                                    }

                                    function remove(arr, item) {
                                        for(var i = arr.length; i--;) {
                                            if(arr[i] === item) {
                                                arr.splice(i, 1);
                                            }
                                        }
                                    }

                                </script>
		                &nbsp;
				<button type='button' class='btn btn-success' onclick="addSolucoes()" title="<?php echo traduz("adicionar.solucao");?>" ><i class="icon-white icon-plus"></i></button>
                                <?php
                            }
                            ?>
                            </div>
                        </div>
                    </div>
                </div>

                <?php
                if(in_array($login_fabrica, array(138))){

                    if(strlen(getValue("produto[troca_compressor]")) > 0){
                        if(strlen(getValue("produto[troca_compressor]")) > 1){
                            $troca_compressor = json_decode(getValue("produto[troca_compressor]"));
                            $troca_compressor = ($troca_compressor->troca_compressor == "t") ? "t" : "f";
                        }else{
                            $troca_compressor = getValue("produto[troca_compressor]");
                            $troca_compressor = ($troca_compressor == "t") ? "t" : "f";
                        }
                    }

                    ?>
                    <div class="checkbox span3" id="troca_compressor" >
                        <input type="checkbox" name="produto[troca_compressor]" value="t" <?php echo ($troca_compressor == "t") ? "checked" : ""; ?> /> <?php echo traduz("garantia.compressor");?>
                    </div>
                <?php
                }else{
                    echo "<div class='span1'></div>";
                }
                ?>


            </div>

            <div class="row">
                <div class="span1"></div>
                <div class="span8">
                    <? if (in_array($login_fabrica, array(138,148,191))) {
                        ?>
                        <div class='row'>
                            <div class="span8">
                                <input type="hidden" name="produto[solucoes_multiplos]" id="solucoes_multiplos" value="<?php echo $campos['produto']['solucoes_multiplos']; ?>" />
                                <? if (!in_array($login_fabrica, array(191))) { ?>
                                <strong><?php echo traduz("solucoes.selecionadas");?></strong>
                            <? } ?>

                                <div class="box-solucoes" style='padding-bottom: 10px;'>
                                    <?php
                                        #echo $campos["produto"]["solucoes_multiplos"];exit;
                                        if(empty($campos["produto"]["solucoes_multiplos"])){
                                            if (!in_array($login_fabrica, array(191))) {
                                                echo traduz("selecione.as.solucoes");
                                            }
                                            if($login_fabrica == 148){ 
                                                $display = 'style="display: none"';
                                            }
                                        }else{
                                            if($login_fabrica == 148){ 
                                                $display = 'style="display: block"';
                                            }
                                            $solucoes_multi = explode(",", $campos["produto"]["solucoes_multiplos"]);
                                            $count_solucoes_multi = count($solucoes_multi);
                                            for($i = 0; $i < $count_solucoes_multi; $i++){

                                                $solucao = $solucoes_multi[$i];

                                                if (!in_array($login_fabrica, array(191))) {
                                                    $descricao = descricao_solucao($solucao);
                                                }else{
                                                    $descricao = descricao_solucao_mo($solucao,$produto);
                                                }

                                                echo "
                                                    <div class='breadcrumb' id='box-solucao-".$solucao."' style='margin-left: 0px; margin-right: 5px;'><span class='icon-remove' onclick='delSolucoes(\"".$solucao."\")' title='".traduz("remover.solucao")."'></span> ".$descricao."</div>
                                                ";

                                            }
                                        }
                                    ?>
                                </div>
                            </div>
                            <?php if($login_fabrica == 148): ?>
                                <script>
                                    $(document).on("keydown", "#detalhes_da_solucao", function () {
                                        var caracteresDigitados = parseInt($(this).val().length);

                                        $(".caracteres_solucao").text(caracteresDigitados);
                                    });
                                </script>
                                <div id="descricao_solucao_148" <?=$display?>>
                                    <div class="span12">
                                        <label class="control-label" for="produto[detalhes_solucao]">Detalhes da Solução</label>
                                    </div>
                                    <div class="span12">
                                        <textarea id="detalhes_da_solucao" name="produto[detalhes_solucao]" class="span12" style="height: 50px;width: 710px;"><?= (!empty(getValue('produto[detalhes_solucao]'))) ? getValue('produto[detalhes_solucao]') : '' ?></textarea> <br>
                                        <span class="caracteres_solucao">0</span> Digitados <br>
                                    </div>
                                </div>
                            <?php endif;?>
                        </div>

                    <?php
                    }

                    ?>
                </div>
            </div>

            <div style='clear: both;margin-bottom: 3%;'></div>
        </div>

        <br />

    <?php
    }

     if ($login_fabrica == 158) {
        $id_posto_novo = (getValue("posto[id]") == "") ? $login_posto : getValue("posto[id]");
        if (verifica_tipo_posto("tecnico_proprio", "TRUE", $id_posto_novo) == true) {
            unset($fabrica_usa_valor_adicional);
        }
    }

    if($fabrica_usa_valor_adicional) {
        $vi = 0;
        $mostra_va = true;

        if(!in_array($login_fabrica, array(35,191))){
            $display_valores_adicionais = "style='display: none;'";
        }

	    if (in_array($login_fabrica, array(169,170)) && !empty($os)) {
                $sql = "
                        SELECT
                                tipo_revenda
                        FROM tbl_posto_fabrica pf
                        JOIN tbl_tipo_posto tp ON tp.tipo_posto = pf.tipo_posto AND tp.fabrica = {$login_fabrica}
                        JOIN tbl_os o ON o.posto = pf.posto AND o.fabrica = {$login_fabrica}
                        WHERE pf.fabrica = {$login_fabrica}
                        AND o.os = {$os}
                        AND tp.tipo_revenda IS TRUE;
                ";

                $res = pg_query($con, $sql);

                if (pg_num_rows($res) > 0) {
                        $mostra_va = false;
                }

        }

        if(strlen(getValue("produto[id]")) > 0){
            if (isset($os)) {
                $sql = "SELECT valores_adicionais FROM tbl_os_campo_extra WHERE os = {$os}";
                $resVAOS = pg_query($con, $sql);
            }

            if (strlen(getValue("subproduto[id]")) > 0) {
                $where = "produto IN (".getValue("produto[id]").", ".getValue("subproduto[id]").")";
            } else {
                $where = "produto = ".getValue("produto[id]");
            }

            $sql = "SELECT valores_adicionais FROM tbl_produto WHERE fabrica_i = {$login_fabrica} AND {$where}";
            $resVAPROD = pg_query($con,$sql);
        }

        $whereTipoAtendimento = "";

        if (in_array($login_fabrica, array(169,170)) && !empty($tipo_atendimento)) {
            $whereTipoAtendimento = "AND JSON_FIELD('tipo_atendimento', valores_adicionais)::INT = {$tipo_atendimento}";
        }
        if (in_array($login_fabrica, [131,139,191]) && !empty($os)) {
            $sql = "SELECT valores_adicionais FROM tbl_os_campo_extra WHERE os = {$os}";
            $resA = pg_query($con,$sql);
            if (pg_num_rows($resA) == 0 or empty(pg_fetch_result($resA,0,0))) {
                $sql = "SELECT valores_adicionais FROM tbl_fabrica WHERE fabrica = {$login_fabrica} {$whereTipoAtendimento};";    
            }
        } else {
            $sql = "SELECT valores_adicionais FROM tbl_fabrica WHERE fabrica = {$login_fabrica} {$whereTipoAtendimento};";
        }

        $resVA = pg_query($con,$sql);

        $valfab = pg_fetch_result($resVA ,0, "valores_adicionais");
        $valos = pg_fetch_result($resVAOS ,0, "valores_adicionais");
        $valprod = pg_fetch_result($resVAPROD ,0, "valores_adicionais");

        if (($valprod != null || $valos  != null || $valfab != null) && $mostra_va == true) {
            $display_valores_adicionais = "style='display: block;'";
        }

        $valor_adicional_selecionado       = array();
        $valor_adicional_selecionado_valor = array();

        if (!empty(getValue("os[valor_adicional]"))) {
            foreach (getValue("os[valor_adicional]") as $key => $value) {

                list($name, $valor) = explode("|", $value);

                if (in_array($login_fabrica, [131,191])) {
                    $name = strtoupper($name);
                }

                if ($login_fabrica == 139) {
                    $valor_adicional_selecionado[] = strtoupper($name);
                    $valor_adicional_selecionado_valor[strtoupper($name)] = $valor;
                } else {
                    $valor_adicional_selecionado[] = strtoupper($name);
                    $valor_adicional_selecionado_valor[strtoupper($name)] = getValue("os[valor_adicional_valor][".$name."]");
                }
            }
    
        } elseif (pg_num_rows($resVAOS) > 0 && !count($msg_erro["msg"])) {
            $valores = json_decode(pg_fetch_result($resVAOS, 0, "valores_adicionais"), true);

            if (is_array($valores)) {

                foreach ($valores as $key => $value) {
                    $value_key = array_keys($value);

                    $valor_adicional_selecionado[]                    = strtoupper($value_key[0]);
                    $valor_adicional_selecionado_valor[strtoupper($value_key[0])] = $value[$value_key[0]];
                }
            }
        }

        if(in_array($login_fabrica, [167, 203])){
            $tipo_at = getValue("os[tipo_atendimento]");
            $sql_at = "SELECT descricao FROM tbl_tipo_atendimento WHERE tipo_atendimento = {$tipo_at}";
            $res_at = pg_query($con, $sql_at);

            $desc_at = pg_fetch_result($res_at, 0, 'descricao');

            if($desc_at == "Orçamento"){
                $display_valores_adicionais = "style='display: none;'";
            }
        } 

        if(in_array($login_fabrica, [195])){
            $tipo_at = getValue("os[tipo_atendimento]");
            $sql_at = "SELECT km_google FROM tbl_tipo_atendimento WHERE tipo_atendimento = {$tipo_at}";
            $res_at = pg_query($con, $sql_at);

            $desc_at = pg_fetch_result($res_at, 0, 'km_google');

            if($desc_at){
                $display_valores_adicionais = "style='display: inline;'";
            } else {
                $display_valores_adicionais = "style='display: none;'";
            }
        } 


        ?>
        <div id="div_valores_adicionais" class="tc_formulario" <?=$display_valores_adicionais?> >
            <div class="titulo_tabela"><?php echo traduz("valores.adicionais");?></div>
            <? if ($login_fabrica == 154) { ?>
                <strong style="color:#b94a48;">(<?php echo traduz("favor.selecionar");?>)</strong>
            <? } ?>
            <br />
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
                    <div class='row-fluid'>
                        <div id="valores_adicionais">
                            <?php

			    $typeInput = ($login_fabrica == 178) ? "radio" : "checkbox";

                            if(strlen(getValue("produto[id]")) > 0){

                                if (pg_num_rows($resVAPROD) > 0) {
                                    while ($result = pg_fetch_object($resVAPROD)) {
                                        $v_adicional = $result->valores_adicionais;
                                        $v_adicional = utf8_encode($v_adicional);
                                        $valores     = json_decode($v_adicional,true);

                                        foreach ($valores as $key => $value) {
                                            $valor = $key."|".$value;
                                            $valor = trim($valor);

                                            //if (in_array($login_fabrica, [131])) {
                                                $key = strtoupper($key);
                                            //}

                                            $checked = (in_array($key, $valor_adicional_selecionado) || in_array(utf8_decode($valor), $valor_adicional_selecionado)) ? "CHECKED" : "";

                                            if ($checked == "CHECKED") {
                                                $value = $valor_adicional_selecionado_valor[$key];
                                            }

                                            echo "
                                                <div class='span3 label label-default valor_adicional_produto' style='min-height: 50px; margin-top: 10px; ".(($vi % 4 == 0) ? "margin-left: 0px !important;" : "")."' >
                                                    <input type='$typeInput' name='os[valor_adicional][]' value='$key|$value' $checked> ".utf8_decode(wordwrap($key, 20, "<br/>", true))."<br />
                                                    <input type='text' class='span12 valor_adicional_valor' readonly=readonly name='os[valor_adicional_valor][".$key."]' value='".$value."'>
                                                </div>
                                            ";

                                            $vi++;
                                        }
                                    }
                                }
                            }

                            if (pg_num_rows($resVA) > 0) {

                                while ($result = pg_fetch_object($resVA)) {
                                    $v_adicional = $result->valores_adicionais;
                                    $v_adicional = utf8_encode($v_adicional);
                                    $valores     = json_decode($v_adicional,true);

                                    /*if (in_array($login_fabrica, [131]) && !empty($os)) {

                                        $arrayValores = [];

                                        foreach ($valores as $key => $value) {

                                            foreach ($value as $descricaoAdicional => $valorAdicional) {

                                                $editarAdicional = ($areaAdmin === true) ? "t" : "f";

                                                $arrayValores[$descricaoAdicional] = ["valor" =>$valorAdicional, "editar" => $editarAdicional];

                                            }

                                        }

                                        $valores = $arrayValores;

                                    }*/

                                    foreach ($valores as $key => $value) {
                                        unset($block);

                                        if (in_array($login_fabrica, [131,139]) && pg_num_rows($resA) > 0 && !empty(pg_fetch_result($resA,0,0))) {
                                            
                                            foreach ($value as $titulo => $v) {
                                                $preco = $v;
                                                $valor = $titulo."|".$preco;
                                                $valor = trim($valor);

                                                /*if (in_array($login_fabrica, [131])) {
                                                    $key = strtoupper($key);
                                                }*/

                                                $checked = (in_array($titulo, $valor_adicional_selecionado) || in_array(utf8_decode($valor), $valor_adicional_selecionado) || in_array(strtoupper($titulo), $valor_adicional_selecionado) || in_array(strtoupper(utf8_decode($valor)), $valor_adicional_selecionado)) ? "CHECKED" : "";

                                                if ($checked == "CHECKED") {
                                                    $v = (!empty($valor_adicional_selecionado_valor[$titulo])) ? $valor_adicional_selecionado_valor[$titulo] : $valor_adicional_selecionado_valor[strtoupper($titulo)];
                                                    $preco          = $v;
                                                    $arrayOutrosExclui[] = strtolower($titulo);
                                                }

                                                if ($value["editar"] != "t") {
                                                    $block = "readonly=readonly";
                                                }
                                                
                                                $texto = $titulo;
                                                $titulo = strtolower($titulo);
                                                $titulo = ucfirst($titulo); 
                                                if (strlen(trim($titulo)) > 25){
                                                    $titulo = substr(trim($titulo), 0, 19).'...';
                                                }else{
                                                    $titulo = $titulo;
                                                }

                                                echo "
                                                    <div class='span3 label label-default div_valor_adicional' style='min-height: 50px; margin-top: 10px; ".(($vi % 4 == 0) ? "margin-left: 0px !important;" : "")."' >
                                                        <input type='checkbox' name='os[valor_adicional][]' value='$titulo|$preco' $checked> <text title='".utf8_decode($texto)."' > ".utf8_decode($titulo)."</text><br />
                                                        <input placeholder='Valor' type='text' class='span12 valor_adicional_valor'  {$block} name='os[valor_adicional_valor][".$titulo."]' value=' ".$v." '>
                                                    </div>
                                                ";

                                                $vi++;
                                            }
                                        } else {
                                            
                                            $preco = $value['valor'];
                                            $valor = $key."|".$preco;
                                            $valor = trim($valor);

                                            /*if (in_array($login_fabrica, [131])) {
                                                $key = strtoupper($key);
                                            }*/

                                            $key = strtoupper($key);

                                            $checked = (in_array($key, $valor_adicional_selecionado) || in_array(utf8_decode($valor), $valor_adicional_selecionado)) ? "CHECKED" : "";

                                            if ($checked == "CHECKED") {
                                                $value["valor"] = $valor_adicional_selecionado_valor[$key];
                                                $preco          = $value["valor"];
                                                $arrayOutrosExclui[] = strtolower($key);
                                            }

                                            if ($value["editar"] != "t") {
                                                $block = "readonly=readonly";
                                            }
                                            
                                            $texto = $key;
                                            $key = strtolower($key);
                                            $key = ucfirst($key); 
                                            if (strlen(trim($key)) > 25){
                                                $key = substr(trim($key), 0, 19).'...';
                                            }else{
                                                $key = $key;
                                            }

                                            echo "
                                                <div class='span3 label label-default div_valor_adicional' style='min-height: 50px; margin-top: 10px; ".(($vi % 4 == 0) ? "margin-left: 0px !important;" : "")."' >
                                                    <input type='$typeInput' name='os[valor_adicional][]' value='$key|$preco' $checked> <text title='".utf8_decode($texto)."' > ".utf8_decode($key)."</text><br />
                                                    <input placeholder='Valor' type='text' class='span12 valor_adicional_valor'  {$block} name='os[valor_adicional_valor][".$key."]' value=' ".$value['valor']." '>
                                                </div>
                                            ";

                                            $vi++;
                                        }
                                    }

                                    if (in_array($login_fabrica, [131,139,191])) {
                                        
                                        $valoresOutros = $_POST['os']['valor_adicional'];

                                        if(count($valoresOutros) > 0){
                                            foreach ($valoresOutros as $key => $val) {

                                                $explodeOutros = explode("|",$val);

                                                $descricaoOutros = $explodeOutros[0];
                                                $valorOutros     = $explodeOutros[1];
                                                
                                                if (!in_array(strtolower($descricaoOutros), $arrayOutrosExclui)) { ?>
                                                    <div class="span3 label label-default div_valor_adicional" style="min-height: 50px; margin-top: 10px;">
                                                        <input class="label-valor-adicional form-control" placeholder="Descrição" type="text" style="width: 82.5%; font-size: 11.844px;" value="<?= $descricaoOutros ?>">
                                                        <button class="btn-remover-adicional btn btn-danger btn-small" type="button" style="width: 17.5%; height: 35%;" onclick="removeAdicional(this)">x</button>
                                                        <input type="checkbox" name="os[valor_adicional][]" value="<?= $descricaoOutros ?>|<?= $valorOutros ?>" style="display: none;" checked>
                                                        <input placeholder="Valor" type="text" class="span12 valor_adicional_valor" name="os[valor_adicional_valor][]" value="<?= $valorOutros ?>" style="font-size: 11.844px;display: block;">
                                                    </div>
                                                <?php
                                                }

                                            }
                                        }else{
                                        ?>
                                            <div class="span3 label label-default div_valor_adicional" style="display:none; min-height: 50px; margin-top: 10px; margin-left: 0px !important;">
                                                <input type="checkbox" name="os[valor_adicional][]" value="Pedagio|0,01"> <text title="PEDAGIO"> Pedagio</text><br>
                                                <input placeholder="Valor" type="text" class="span12 valor_adicional_valor" name="os[valor_adicional_valor][Pedagio]" value=" 0,01 ">
                                            </div>
                                        <?php
                                        }
                                    }
                                            
                                }
                            }
                            ?>
                        </div>
                    </div>

                    <br />

                </div>
                <div class="span1"></div>
            </div>
            <?php
             if (in_array($login_fabrica, [131,139,191])) { ?>
                <div class="row row-fluid">
                    <center>
                        <button class="btn btn-primary" type="button" id="adicionar_valor_adicional">Adicionar Outros</button>
                    </center>
                </div>
            <?php
            } ?>
            <div style='clear: both;'></div>

        </div>

        <br />
    <? }

    if($login_fabrica == 52){
        if(strlen($os) > 0){
            include (($areaAdmin === true) ? "../" : "") . "pedido_descricao_os.php";
        }
    }

    if (in_array($login_fabrica, array(52,148,151,169,170))) {
            $placeholder = 'placeholder="Referência - Descrição"';
    }

    $troca_obrigatoria = getValue("produto[troca_obrigatoria]");

    if ($troca_obrigatoria != 't') {
        if ($login_fabrica == 153) {
            $defeito_const_mau_uso = getValue("produto[defeito_constatado]");
            $mau_uso_positron = "display:none;";
            if (strlen(trim($defeito_const_mau_uso)) > 0) {
                $sql = "SELECT * FROM tbl_defeito_constatado WHERE fabrica = $login_fabrica and defeito_constatado = $defeito_const_mau_uso";
                $res = pg_query($con, $sql);
                if (pg_num_rows($res) > 0) {
                    $descricao = pg_fetch_result($res, 0, 'descricao');
                    if($descricao == "Mau Uso"){
                        $mau_uso_positron = "display:block;";
                        $produto_pecas_positron = "display:none;";
                    }else{
                        $mau_uso_positron = "display:none;";
                        $produto_pecas_positron = "display:block;";
                    }
                }else{
                    $mau_uso_positron = "display:none;";
                    $produto_pecas_positron  = "display:block;";
                }
            }

            $atendimento = getValue("os[tipo_atendimento]");

            if ($atendimento == 243) {
                $produto_pecas_positron = "display:none;";
            } ?>

            <div class="tc_formulario" id="mau_uso" style="<?= $mau_uso_positron ?>">
                <div class="titulo_tabela"><?php echo traduz("descricao.do.mau.uso");?></div>
                <br />

                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class='control-group <?=($erro_campo_mau_uso== true)? 'error': '' ?>'>
                        <label class="control-label" ><?php echo traduz("descricao");?></label>
                        <div class="controls controls-row" >
                            <div class="span10">
                                <textarea name="produto[desc_mau_uso]" class="span12" style="height:150px;"><?= getValue("produto[desc_mau_uso]"); ?></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        <? } ?>
        <?php if(in_array($login_fabrica, [167, 203])){ //HD-3428328 ?>
            <div class="alert alert-block" id="comunicado_suprimento" <?=$comunicado_suprimento?> >
                <h4><?php echo traduz("atencao");?>!</h4>
                   <?php echo traduz("esse.tipo.de.produto.e.de.troca.obrigatoria.e.ira.para.auditoria.da.fabrica");?>
            </div>
        <?php } ?>

        <?php

        if(in_array($login_fabrica, array(157)) && strlen($os) > 0 and $areaAdmin == false){

            $sql_os_auditoria = "SELECT os FROM tbl_auditoria_os WHERE os = {$os} AND liberada IS NULL";
            $res_os_auditoria = pg_query($con, $sql_os_auditoria);

            if(pg_num_rows($res_os_auditoria) > 0){
                $oculta_peca = "display: none;";
            }
        }
        if ($login_fabrica == 176){
            if ($desc_tipo_atendimento == "Instalação"){
                $mostra_produto_pecas = "display: none;";
            }
        }

        if ($login_fabrica == 178){
            if ($campos["produto"]["solicita_troca"] == 't'){
                $mostra_produto_pecas = "display: none;";
            }else{
                $mostra_produto_pecas = "";
            }
        }

        if ($campos["produto"]["produto_troca_obrigatoria"] > 0) {
            $mostra_produto_pecas = "display: none;";
        }
        ?>
        <p class="tac" >
            <div class="alert alert-warning" id='lancar_peca_bloqueado_tipo_atendimento' style='display: none;' >
                <?php echo traduz("bloqueado.o.lancamento.de.peca.para.o.tipo.de.atendimento");?>
            </div>
        <?php if ($areaAdmin === false AND $login_unico_tecnico_posto != "t" AND $login_fabrica == 175){ ?>
            <div class="alert alert-warning">
                <h4>Somente técnicos (login único) podem lançar peças/defeito na Ordem de Serviço</h4>
            </div>
        <?php } ?>
        <?php if($login_fabrica == 35){?>
            <div class="tc_formulario" id="produto_pecas_mensagem" style='<?=$mostra_msg_produto_critico ?>'>
                <div class="titulo_tabela"><?php echo traduz("pecas.do.produto");?></div>
                <br>
                <div class='alert alert-warning div_regra_revisao'>
                    <?php echo traduz("o.produto.informado.e.um.produto.critico.a.ordem.de.servico.sera.auditada.pelo.fabricante");?>
                </div>
            </div>
            <br>
        <?php } ?>
        
        <div class="tc_formulario" id="produto_pecas" style="<?=$display_produto_peca?> <?=$mostra_produto_pecas?> <?=$produto_pecas_positron?> <?=$oculta_peca?>">
            <div class="titulo_tabela" ><?php echo traduz("pecas.do.produto");?></div>
            <br />

	    <?php

		if($login_fabrica == 131){
	    ?>
            <script type="text/javascript">
                
                $( function() {

                    $("#estoque_aguardar").on("change", function () {

                        var radio = $("#estoque_aguardar input[name=estoque_aguardar]:checked").val();

                        if (radio == "utilizar_estoque") { 
                            $("#previsao_entrega").show(); 
                        } else { 
                            $("#previsao_entrega").hide(); 
                        }

                    });
                });

            </script>
            <?php 
                /** 
                 * @author William Castro <william.castro@telecontrol.com.br>
                 * hd-6320472
                 */

			$checked1 = "";
			$checked2 = "";
			$display = 'style="display: none;"';
			if ($_POST['estoque_aguardar'] == 'utilizar_estoque') {
			    $checked2 = "checked";
			    $display = "";
			} else {
			    $checked1 = "checked";
			}

            ?>

            <div class="row-fluid" id="estoque_aguardar" style="margin-left: 10%">
                <div class="span6"> 
                    <label>
                        <input type="radio" id="aguardar_pecas" name="estoque_aguardar" value="aguardar_pecas"<?php echo $checked1; ?> >
                        Aguardar as peças serem enviadas
                    </label>

                    <br>
                    <label>
                        <input type="radio" id="utilizar_estoque" name="estoque_aguardar" value="utilizar_estoque" <?php echo $checked2; ?> >
                        Utilizar as peças do estoque
                    </label>
                </div>
                <div class="col span6" id="previsao_entrega" <?php echo $display ?>">
                    <label>Previsão de Conserto
                        <div class="controls controls-row">
                            <div>
                                <input id="data_entrega" name="previsao_entrega" type="text" autocomplete="off" value="<?=getValue('previsao_entrega')?>" <?=$data_readonly?> />
                            </div>
                        </div>
                    </label><br>
                </div>
            </div>
	    <?php
		}
	    ?>
			<?php if ($login_fabrica == 35 and !empty($os)): ?>
			<div class='alert alert-warning'>
				<strong><?php echo traduz("alteracoes.relacionadas.a.pecas.so.terao.efeitos.depois.de.gravar.os");?>.</strong>
			</div>
			<br>
			<?php endif ?>
            <p class="tac" >
                <label class='label label-warning' id='lancar_peca_obrigatorio' style='display: none;' > <?php echo traduz("obrigatorio.o.lancamento.de.peça.s.para.o.defeito.constatado");?></label>
                <label class='label label-warning' id='lancar_peca_obrigatorio_tipo_atendimento' style='display: none;' ><?php echo traduz("obrigatorio.o.lancamento.de.peca.para.o.tipo.de.atendimento");?></label>
            </p>
            <br />
            <?
            if (in_array($login_fabrica, array(35))) {
                $span_referencia_peca = "span3";
                $span_descricao_peca = "span5";
                $span_defeito_peca = "span2";

            } elseif(in_array($login_fabrica, array(52))){
                $span_defeito_peca = "span4";
                $span_referencia_peca = "span3";
                $span_descricao_peca = "span4";
            }elseif(in_array($login_fabrica, array(157))){
                $span_defeito_peca = "span2";
                $span_referencia_peca = "span2";
                $span_descricao_peca = "span3";
            }elseif (in_array($login_fabrica, array(156))) {
                $span_referencia_peca = "span2";
                $span_descricao_peca = "span3";
            } else if (in_array($login_fabrica, array(148))) {
                $span_referencia_peca = "span7";
                $span_descricao_peca = "span3";
            } elseif (in_array($login_fabrica, array(186,190,195))) {
                $valida_atendimento = getValue("os[tipo_atendimento]");
                $span_referencia_peca = "span3";
                $span_descricao_peca = "span4";
                if (strlen($valida_atendimento) > 0) {
                    $sqlTipo = "SELECT descricao FROM tbl_tipo_atendimento WHERE fabrica={$login_fabrica} AND tipo_atendimento=".$valida_atendimento;
                    $resTipo = pg_query($con, $sqlTipo);
                    $tipoDescricao  = pg_fetch_result($resTipo, 0, 'descricao');
                    if (trim($tipoDescricao) ==  "Orçamento"){
                        $span_referencia_peca = "span2";
                        $span_descricao_peca = "span3";
                    }  
                }
            } elseif(in_array($login_fabrica, array(183))){
                $span_defeito_peca = "span3";
                $span_referencia_peca = "span2";
                $span_descricao_peca = "span2";
            } else {
                $span_referencia_peca = "span3";
                $span_descricao_peca = "span4";
            }
            if ($login_fabrica == 148) { ?>
                <div class='alert alert-warning div_regra_revisao'>
                    <h5> <?php echo traduz("pecas.de.lancamento.obrigatorio.para.a.revisao.de");?> <strong class='regra_revisao'></strong> <?php echo traduz("horas");?></h5>
                    <table class="table table-striped" style="width: 410px; margin: 0 auto;" >
                        <thead>
                            <tr>
                                <th class="titulo_coluna"><?php echo traduz("peca");?></th>
                                <th class="titulo_coluna"><?php echo traduz("servico");?></th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            <? } ?>

            <div id="modelo_peca">
                <div class="row-fluid div-linha-peca" name="peca___modelo__">
                    
                    <div class="span1">
                        <div class='control-group'>
                            <br />
                            <div class="controls controls-row">
                                <div class="span12 tac" >
                                    <?php if($login_fabrica == 191 && $postoInterno){ ?>
                                            <input title="Selecione para enviar a peça para separação do estoque" type="checkbox" name="produto_pecas[__modelo__][separa_estoque]" value="t">
                                    <?php } ?>
                                    <input type="hidden" name="produto_pecas[__modelo__][id]" rel="peca_id" value="" disabled="disabled" posicao="__modelo__" />
				                    <? if ($pecasExcedenteLB == true && in_array($login_fabrica, [169,170])) { ?>

                                        <input type="hidden" name="produto_pecas[__modelo__][tem_obs]" value="" disabled="disabled" />
                                    <? } ?>
                                    <? if (in_array($login_fabrica, [158])) { ?>
                                        <input type="hidden" name="produto_pecas[__modelo__][subitem]" value="" disabled="disabled" />
                                    <? } ?>
                                    <button type="button" class="btn btn-mini btn-danger" name="remove_peca" rel="__modelo__" style="display: none;" >X</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <? $referencia = (in_array($login_fabrica, array(52,148,151,169,170))) ? traduz("Peça") : traduz("Referência"); ?>

                    <div class="<?=$span_referencia_peca?>" <?= $width_referencia_peca; ?> id="pecas_referencia___modelo__">
                        <div class='control-group' >
                            <label class="control-label"><?= $referencia; ?></label>
                            <div class="controls controls-row">
                                <div class="span10 input-append">
                                    <input  name="produto_pecas[__modelo__][referencia]" class="span12 produto_referencia" type="text" value="" <?=$placeholder?> disabled="disabled" />
                                    <span class="add-on" rel="lupa_peca">
                                        <i class="icon-search"></i>
                                    </span>
                                    <input type="hidden" name="lupa_config" tipo="lista_basica" parametro="referencia" posicao="__modelo__" <?php if($login_fabrica == 177 || (in_array($login_fabrica,[186,191]) && $posto_interno == true)){
                                                    echo "preco_peca='true' cadastro_os='true' "; 
                                                } ?>  <?=(in_array($login_fabrica, array(156,163)) || ($login_fabrica == 161 && $posto_interno == true)) ? "preco_peca='true'" : ""?>   />
                                </div>
                            </div>
                        </div>
                    </div>
                    <? if(!in_array($login_fabrica, array(52,148,151,169,170))) { ?>
                        <div class="<?= $span_descricao_peca; ?>" id="pecas_descricao___modelo__">
                            <div class='control-group'>
                                <label class="control-label" ><?php echo traduz("descricao");?></label>
                                <div class="controls controls-row">
                                    <div class="span10 input-append">
                                        <input name="produto_pecas[__modelo__][descricao]" class="span12 produto_peca_descricao" type="text" value="" disabled="disabled" />
                                        <span class="add-on" rel="lupa_peca" >
                                            <i class="icon-search"></i>
                                        </span>
                                        <input type="hidden" name="lupa_config" tipo="lista_basica" parametro="descricao" posicao="__modelo__" <?php if($login_fabrica == 177 || (in_array($login_fabrica,[186,191]) && $posto_interno == true)){
                                                    echo "preco_peca='true' cadastro_os='true' "; 
                                                } ?> <?=(in_array($login_fabrica, array(156,163)) || ($login_fabrica == 161 && $posto_interno == true)) ? "preco_peca='true'" : ""?> />
                                    </div>
                                </div>
                            </div>
                        </div>
                    <? } ?>
                    <div class="span1">
                        <div class='control-group' >
                            <label class="control-label" ><?php echo traduz("qtde");?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <input name="produto_pecas[__modelo__][qtde]" posicao="__modelo__" class="span12 numeric" type="text" value="" disabled="disabled" <? if (in_array($login_fabrica, array(148,156,163)) || (in_array($login_fabrica, array(161,167,177,186,190,191,203)) && ($areaAdmin == true || $postoInterno == true)) ) { ?> onchange="calcula_valor_total_pecas(__modelo__);" <? } ?> />
                                </div>
                            </div>
                        </div>
                    </div>
                    <? if (in_array($login_fabrica, array(151,169,170))) { ?>
                        <div class="span4">
                            <div class='control-group' >
                                <label class="control-label" ><?php echo traduz("defeito.da.peca");?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <select class='span12' name='produto_pecas[__modelo__][defeito_peca]'>
                                            <option value=''></option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                    <? }
                    if (in_array($login_fabrica, array(52,157))) { ?>

                        <div class="<?=$span_defeito_peca?>">
                            <div class='control-group' >
                                <label class="control-label" ><?php echo ($login_fabrica == 157) ? traduz("motivo") : traduz("defeito.da.peca");?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <select class='span12' name='produto_pecas[__modelo__][defeito_peca]' >
                                            <option value=''></option>
                                            <? $sql = "SELECT defeito, descricao FROM tbl_defeito WHERE fabrica = {$login_fabrica} AND ativo IS TRUE ORDER BY descricao ASC";
                                            $res = pg_query($con,$sql);

                                            while ($result = pg_fetch_object($res)) {
                                                $selected = ($result->defeito == $pecas_valores[$i]["defeito_peca"]) ? "SELECTED" : "";
                                                echo "<option value='{$result->defeito}' $selected>{$result->descricao}</option>";
                                            } ?>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <? } ?>

                    <?php if ($login_fabrica == 183){ ?>
                        <div class="span3">
                            <div class='control-group'>
                                <label class="control-label">Código Utilização</label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <select class='span12' name='produto_pecas[__modelo__][codigo_utilizacao]'>
                                            <option value=""><?php echo traduz("selecione");?></option>
                                            <?php 
                                                $sql_utilizacao = "
                                                    SELECT causa_defeito, codigo, descricao 
                                                    FROM tbl_causa_defeito 
                                                    WHERE fabrica = {$login_fabrica} 
                                                    AND ativo IS TRUE;";
                                                $res_utilizacao = pg_query($con, $sql_utilizacao);
                                                
                                                if (pg_num_rows($res_utilizacao) > 0) {

                                                    for($ut = 0; $ut < pg_num_rows($res_utilizacao); $ut++) {
                                                        $desc_motivo   = pg_fetch_result($res_utilizacao, $ut, "descricao");
                                                        $cod_motivo    = pg_fetch_result($res_utilizacao, $ut, "codigo");
                                                        $causa_defeito = pg_fetch_result($res_utilizacao, $ut, "causa_defeito");

                                                        $selected_motivo = "";
                                                        if ($produto_pecas[$i]["causa_defeito"] == $causa_defeito) {
                                                            $selected_motivo = "selected";
                                                        }

                                                        echo "<option value='{$causa_defeito}' $selected_motivo>{$cod_motivo} - {$desc_motivo}</option>";
                                                    }
                                                }
                                            ?>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?php } ?>

                    <?php if (in_array($login_fabrica, array(35,143))) { ?>
                        <input name="produto_pecas[__modelo__][servico_realizado]" type="hidden" value="<?=$servico_realizado?>" disabled="disabled" />
                    <? } else { 
                            if(in_array($login_fabrica, array(186,190,195))){ 
                                $valida_atendimento = getValue("os[tipo_atendimento]");
                                if (strlen($valida_atendimento) > 0) {

                                    $sqlTipo = "SELECT descricao FROM tbl_tipo_atendimento WHERE fabrica={$login_fabrica} AND tipo_atendimento=".$valida_atendimento;
                                    $resTipo = pg_query($con, $sqlTipo);
                                    $tipoDescricao  = pg_fetch_result($resTipo, 0, 'descricao');
                                    if (trim($tipoDescricao) ==  "Orçamento"){
                                        $display_none = "display:block;";
                                        $valor_total_display = "display: block;";
                                        $display_valor = "display:block;";
                                        $display_servico_peca = "style='display:none;'";
                                    } else {
                                        $display_none = "display:none;";
                                        $valor_total_display = "display:none;";
                                        $display_valor = "display:none;";
                                        $display_servico_peca = "style='display:block;'";
                                    }
                                } else {
                                    $display_none = "display:none;";
                                    $valor_total_display = "display:none;";
                                    $display_valor = "display:none;";
                                    $display_servico_peca = "style='display:block;'";
                                }
                            }
                        ?>
                        <div class="span2" id="div_servicos_peca___modelo__" <?php echo $display_servico_peca; ?>>
                            <div class='control-group' >
                                <label class="control-label" ><?php echo traduz("servicos");?></label>
                                <div class="controls controls-row">
                                    <div class="span12 tal">
                                        <select class="span12 servicos_peca_realizado" id="servicos_peca___modelo__" name="produto_pecas[__modelo__][servico_realizado]">
                                            <? 
                                            if (in_array($login_fabrica, array(175,178))){
                                                $res_sr = get_servico_realizado(null, null, getValue("os[tipo_atendimento]"));
                                            } else if (in_array($login_fabrica, [161])) {
                                                $res_sr = get_servico_realizado(null, null, null, getValue("produto[id]"));
                                            } else if (empty($res_sr)) {
                                                $res_sr = get_servico_realizado();//Adicionado pois estava sem - Lucas
                                            }
                                            $rows_sr = pg_num_rows($res_sr);

                                            for($sr = 0; $sr < $rows_sr; $sr++) {
                                                $servico_realizado = pg_fetch_result($res_sr, $sr, "servico_realizado");
                                                $descricao         = pg_fetch_result($res_sr, $sr, "descricao");
                                                $troca_de_peca     = pg_fetch_result($res_sr, $sr, "troca_de_peca");
                                                $gera_pedido       = pg_fetch_result($res_sr, $sr, "gera_pedido");
                                                $peca_estoque      = pg_fetch_result($res_sr, $sr, "peca_estoque");
                                                $selected = '';

                                                if ($areaAdmin === false) {
                                                    if (($tipo_posto_interno == 'f' AND $gera_pedido == 't') OR ($tipo_posto_interno == 't' AND $gera_pedido == 'f')) {
                                                        continue;
                                                    }
                                                }
                                                if ($login_fabrica == 178){
                                                    if (strtolower($descricao) == "troca de produto" OR strtolower($descricao) == "cancelado"){
                                                        continue;
                                                    }
                                                }
                                                echo "<option {$selected} value='{$servico_realizado}' troca_de_peca='{$troca_de_peca}' gera_pedido='{$gera_pedido}' peca_estoque='{$peca_estoque}' >".$descricao."</option>";
                                            } ?>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <?php if($login_fabrica == 35){ //HD-3428297 ?>
                            <div class="span2" style= "display:none;" id="po_pecas___modelo__">
                                <div class='control-group' >
                                    <label class="control-label" ><?php echo traduz("po.peca");?></label>
                                        <div class="controls controls-row">
                                            <div class="span12">
                                                <input class="span10 po_pecas numeric" name="produto_pecas[__modelo__][po_pecas]" type="text" value="" />
                                                <input type='hidden' name='produto_pecas[__modelo__][po_pecas_hidden]' id="hidden_po_pecas___modelo__" value=''>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        <?php } ?>
                        <?php if(in_array($login_fabrica, [167, 203])){ //HD-3428297 ?>
                            <div class="span3" style= "display:none; margin-left: 73px; margin-bottom: 15px;" id="serie_peca___modelo__">
                                <div class='control-group' >
                                    <label class="control-label" ><?php echo traduz("serie.da.peca");?></label>
                                        <div class="controls controls-row">
                                            <div class="span12">
                                                <input class="span10 serie_peca" name="produto_pecas[__modelo__][serie_peca]" type="text" value="" />
                                                <input type="hidden" name="produto_pecas[__modelo__][valida_serie_peca]" value="">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        <?php } ?>
                    <? }
                    if (in_array($login_fabrica, array(148,156,161,163,167,177,186,190,191,195,203))) {
                        if ($login_fabrica == 156){ ?>
                            <div class="span2 div_void_peca" style="width: 70px;" id="pecas_void___modelo__">
                                <div class='control-group <?=(in_array('produto_pecas[__modelo__][void]', $msg_erro['campos'])) ? "error" : "" ?>' >
                                    <label class="control-label">Void</label>
                                    <div class="controls controls-row">
                                        <div class="span12">
                                            <h5 class='asteristico'>*</h5>
                                            <input name="produto_pecas[__modelo__][void]" id="void_peca" class="span12 void_peca" type="text" value="" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <? }

                        $display_none = "";

                        if ((in_array($login_fabrica, array(161,167,177,203)) && $areaAdmin == false && $postoInterno == false ) OR $login_fabrica == 163) {
                            $display_none = "display: none;'";
                        }

                        if (in_array($login_fabrica, [167, 203])) {
                            if ($posto_interno != true) {
                                $readonly_valor = "readonly='readonly'";
                            }
                        }else if (in_array($login_fabrica,[177,191])){
                            $readonly_valor = "";
                        } else {
                            $readonly_valor = "readonly='readonly'";
                        }

                        if (in_array($login_fabrica,[190]) && $areaAdmin == false){
                            $readonly_valor = "readonly='readonly'";
                            $display_none = "display: none;'";
                        }

                        ?>
                        <div class="span2 div_valor_total_peca" style="width: 70px; <?php echo $display_none; ?>" id="pecas_valor___modelo__">
                            <div class='control-group'>
                                <label class="control-label" ><?php echo traduz("valor");?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <input posicao="__modelo__" name="produto_pecas[__modelo__][valor]" id="valor_peca" class="span12 valor_peca" type="text" value="" <?= $readonly_valor ?> />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="span2 div_valor_total_peca" style="width: 70px; <?php echo $display_none; ?>" id="pecas_valor_total___modelo__">
                            <div class='control-group' >
                                <label class="control-label"><?php echo traduz("valor.total");?></label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <input name="produto_pecas[__modelo__][valor_total]" id="valor_total_peca" class="span12 valor_total_peca" type="text" value="" <?= $readonly_valor ?> />
                                        <?php if (in_array($login_fabrica, [167, 203])) { ?>
                                                <input type="hidden" id="motivo_segunda_peca___modelo__" name="produto_pecas[__modelo__][motivo_segunda_peca]" value="" />
                                                <input type="hidden" id="motivo_segunda_motivo___modelo__" name="produto_pecas[__modelo__][motivo_segunda_motivo]" value="" />
                                                <input type="hidden" id="motivo_segunda_extraviada___modelo__" name="produto_pecas[__modelo__][motivo_segunda_extraviada]" value="" />
                                        <?php } ?>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <? }
                    if ($login_fabrica == 156){
                    ?>
                        <div class="span2 div_void_peca" style="width: 70px;" id="pecas_void___modelo__">
                            <div class='control-group' >
                                <label class="control-label">Void</label>
                                <div class="controls controls-row">
                                    <div class="span12">
                                        <input name="produto_pecas[__modelo__][void]" id="void_peca" class="span12 void_peca" type="text" value="" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?
                    }
                    ?>
                    <?php if ($login_fabrica == 175){ ?>
                        <div class="div_env" >
                            <div></div>
                            <div class="span3" style="display:none;" id='div_qtde_disparos_peca__modelo__'>
                                <input type="hidden" name="pecas_disparos__modelo__" id="pecas_disparos__modelo__" value="">
                                <div class='control-group'>
                                    <label class="control-label">Quantidade de Disparos</label>
                                    <div class="controls controls-row">
                                        <div class="span10">
                                            <input name="produto_pecas[__modelo__][quantidade_disparos]" class="span12 quantidade_disparos" type="text" value=""/>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="span3" style="display: none;" id="div_numero_serie_peca__modelo__">
                                <div class='control-group' >
                                    <label class="control-label" >Número de Série</label>
                                    <div class="controls controls-row">
                                        <div class="span12">
                                            <input class="span10 serie_peca numeric" name="produto_pecas[__modelo__][numero_serie]" type="text" value="" />
                                            <input type="hidden" name="produto_pecas[__modelo__][valida_serie_peca]" id="valida_serie_peca__modelo__" value="">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="span3" id="div_componente_raiz__modelo__">
                                <div class='control-group'>
                                    <div class='control-group'>
                                        <div class="span10">
                                              <label class="checkbox" style="margin-top: 15px;"><input type="checkbox" name="produto_pecas[__modelo__][componente_raiz]" value="t">Componente Raiz</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    <?php } ?>
                    <?php if ($login_fabrica == 177){ ?>
                        <div style="display: none;">
                            <div class="span3" style="margin-left: 2.5%">
                                <input type="hidden" name="produto_pecas[__modelo__][peca_lote]" id="peca_lote__modelo__" value="">
                                <div class='control-group'>
                                    <label class="control-label">Lote da Peça Danificada</label>
                                    <div class="controls controls-row">
                                        <div class="span10">
                                            <h5 class="asteristico h5_lote__modelo__">*</h5>
                                            <input name="produto_pecas[__modelo__][lote]" class="span12" type="text" value="" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--
                            <div class="span3">
                                <div class='control-group' >
                                    <label class="control-label" >Lote nova peça</label>
                                    <div class="controls controls-row">
                                        <div class="span12">
                                            <input class="span10 serie_peca numeric" name="produto_pecas[__modelo__][lote_nova]" type="text" value="" />
                                        </div>
                                    </div>
                                </div>
                            </div> -->
                        </div>
                    <?php } 

                    if (in_array($login_fabrica, [148])) { ?>

                        <div class="row-fluid div_nf_estoque_fabrica" id="div_nf_estoque_fabrica___modelo__" style="display:none;">
                            <div class="span2"></div>
                            <div class="span10">
                                <div class='control-group'>
                                    <label class="control-label">Nota Fiscal</label>
                                    <div class="controls controls-row">
                                        <div class="span5">
                                            <input type="text" name='produto_pecas[__modelo__][nf_estoque_fabrica]' value="" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="span1"></div>
                        </div>
                        <br />

                    <?php
                    }
                    ?>
                </div>
		        
                <? if ($pecasExcedenteLB == true && in_array($login_fabrica, [169,170])) { ?>
                    <div class="row-fluid" name="div_peca_excedente" id="div_peca_excedente___modelo__" style="display:none;">
                        <div class="span1"></div>
                        <div class="span10">
                            <div class='control-group'>
                                <label class="control-label">Motivo 2ª Solicitação</label>
                                <div class="controls controls-row">
                                    <div class="span5">
                                        <select class='span12' name='produto_pecas[__modelo__][causa_defeito]'>
                                        <option value=""><?php echo traduz("selecione");?></option>
                                        <?php 
                                            $sql_motivo = "SELECT causa_defeito, codigo, descricao 
                                                            FROM tbl_causa_defeito 
                                                            WHERE fabrica = {$login_fabrica} 
                                                            AND ativo IS TRUE;";
                                            $res_motivo = pg_query($con, $sql_motivo);

                                            $contadorMotivo = pg_num_rows($res_motivo);
                                            
                                            if ($contadorMotivo > 0) {

                                                for($mt = 0; $mt < $contadorMotivo; $mt++) {
                                                    $desc_motivo   = pg_fetch_result($res_motivo, $mt, "descricao");
                                                    $cod_motivo    = pg_fetch_result($res_motivo, $mt, "codigo");
                                                    $causa_defeito = pg_fetch_result($res_motivo, $mt, "causa_defeito");

                                                    $selected_motivo = "";
                                                    if ($produto_pecas[$i]["causa_defeito"] == $causa_defeito) {
                                                        $selected_motivo = "selected";
                                                    }

                                                    echo "<option value='{$causa_defeito}' $selected_motivo>{$desc_motivo}</option>";
                                                }
                                            }
                                        ?>
                                    </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="span1"></div>
                    </div>
                    <br />
                <? } ?>
            </div>

            <? if($login_fabrica == 153){ ?>
                <div id="dev_obrig_modelo">
                    <div class="row-fluid" name="dev_obrig" id="dev_obrig___modelo__" style="display:none" <?=$bgcolor?> >
                        <div class="span1"></div>
                        <div class="span10 alert alert-danger" ><?php echo traduz("esta.peca.devera.ser.devolvida.para.a.fabrica");?></div>
                        <div class="span1"></div>
                    </div>
                </div>
            <? }
            if ($login_fabrica == 148) {
            ?>
            <p class="tac">
                <button type="button" name="lista_basica" class="btn" style="display: none;"><?php echo traduz("lista.basica");?></button>
            </p>
<?php
            }
            if ($produto_possui_troca != true && !in_array($login_fabrica, [148])) {
?>
                <p class="tac">
                    <?php if (!in_array($login_fabrica, [190])) {?>
                    <button type="button" name="lista_basica" class="btn" <?= $disabled; ?>><?php echo traduz("lista.basica");?> <?= ($login_fabrica == 143) ? " / ".traduz("vista.explodida") : ""; ?></button>
                    <?php }?>
<?php
                if (!in_array($login_fabrica, array(143))) {
                    $vista_explodida_display = "none";

                    if (strlen(getValue("produto[id]")) > 0) {
                        $sql = "SELECT comunicado FROM tbl_comunicado WHERE fabrica = {$login_fabrica} AND tipo = 'Vista Explodida' AND produto = ".getValue("produto[id]")." ORDER BY comunicado DESC LIMIT 1";
                        $res = pg_query($con, $sql);

						if ($login_fabrica == 35 and !pg_num_rows($res)) {
							$sql = "SELECT tbl_comunicado.comunicado, tbl_comunicado.extensao, tbl_comunicado.tipo
								FROM tbl_comunicado
								INNER JOIN tbl_comunicado_produto ON tbl_comunicado_produto.comunicado = tbl_comunicado.comunicado
								INNER JOIN tbl_produto ON tbl_produto.produto = tbl_comunicado_produto.produto AND tbl_produto.fabrica_i = $login_fabrica
								WHERE fabrica = $login_fabrica
								AND tbl_comunicado.tipo = 'Vista Explodida'
								AND tbl_comunicado_produto.produto = ".getValue("produto[id]") . "
								$cond_serie AND tbl_comunicado.ativo IS TRUE";
							$res = pg_query($con, $sql);
						}

                        if (pg_num_rows($res) > 0) {
                            $comunicado = pg_fetch_result($res, 0, "comunicado");

                            if ($anexaS3->temAnexos($comunicado)) {
                                $linkVE = $anexaS3->url;
                                $vista_explodida_display = "inline";
                            }
                        }
                    }
?>
                        <a id="vista_explodida" href="<?=$linkVE?>" class="btn btn-info" target="_blank" style="display: <?=$vista_explodida_display?>;" > <?php echo traduz("vista.explodida");?></a>
<?php
                }

            }
            if ($login_fabrica == 161 && $posto_interno == TRUE) {
                $sqlTabela = "
                    SELECT  tabela,
                            sigla_tabela || ' - ' || descricao AS tabela_descricao
                    FROM    tbl_tabela
                    WHERE   fabrica = $login_fabrica";
                $resTabela = pg_query($con,$sqlTabela);

                $style = ($tipo_atendimento_callcenter == 271) ? "display:block;" : "display:none";
//                 echo $tipo_atendimento;
?>
                <select name="tabela" id="tabela" style="<?=$style?>">
                    <option value=""><?php echo traduz("selecione");?></option>
<?php
                while ($tabelas = pg_fetch_object($resTabela)) {
?>
                    <option value="<?=$tabelas->tabela?>" <?=($tabelas->tabela == $tabela) ? "selected='selected'" : ""?>><?=$tabelas->tabela_descricao?></option>
<?php
                }
?>
                </select>
<?php
            }
?>
            </p>
            <div id="pecas_produto">
<?php

                if (!count(getValue("produto_pecas"))) {
                    $qtde_pecas = 3;
                } else {
                    $qtde_pecas    = verifica_quantidade_pecas(getValue("produto_pecas"), getValue("os[tipo_atendimento]"));
                    $pecas_valores = getValue("produto_pecas");

                    if($login_fabrica == 148 && getValue("os[tipo_atendimento]") == 227){
                        $readonly = "readonly='readonly'";
                    }
                }

                for ($i = 0; $i < $qtde_pecas; $i++) {

                    if($login_fabrica == 153){
                        $param_adicinal = getValue("produto_pecas[$i][parametros_adicionais]");
                        $param_adicinal = str_replace("\\", "", $param_adicinal);
                        $param_adicinal = json_decode($param_adicinal, true);
                    }

                    if ($produto_possui_troca == true && empty($pecas_valores[$i]["os_item"])) {
                        continue;
                    }

                    if (count($msg_erro["msg"]) > 0 && in_array("produto_pecas[$i]", $msg_erro["campos"])) {
                        $bgcolor = "style='background-color: #F2DEDE'";
                    } else {
                        unset($bgcolor);
                    }

                    unset($servico);

                    if (strlen($pecas_valores[$i]["id"]) > 0) {
                        $peca_readonly     = "readonly='readonly'";
                        $peca_esconde_lupa = "style='display: none;'";
                        $peca_botao_remove = "inline";
                        $servico = $pecas_valores[$i]['servico_realizado'];
                    } else {
                        unset($peca_readonly, $peca_esconde_lupa);
                        $peca_botao_remove = "none";
                    }

                    if ($login_fabrica == 177){
                        $sql_gp = "SELECT gera_pedido FROM tbl_servico_realizado WHERE servico_realizado = $servico";
                        $res_gp = pg_query($con, $sql_gp);
                        unset($gera_pedido_selecionado);
                        if (pg_num_rows($res_gp) > 0){
                            $gera_pedido_selecionado = pg_fetch_result($res_gp, 0, 'gera_pedido');
                        }
                    }

                    $peca_cancelada = verificaPecaCancelada($pecas_valores[$i]['os_item']);

                    if ($peca_cancelada === false) {
                        $peca_troca_produto = verificaTrocaProduto($pecas_valores[$i]['os_item']);
                        $qtde_cancelada = verificaPecaCanceladaPedido($pecas_valores[$i]['os_item']);

                        if ($peca_troca_produto === false) { ?>
                            <div class="row-fluid div-linha-peca" name="peca_<?=$i?>" <?=$bgcolor?>>
                                <div class="span1">
                                    <div class='control-group'>
                                        <br />
                                        <div class="controls controls-row">
                                            <div class="span12 tac">
                                                <?php if($login_fabrica == 191 && $postoInterno && $pecas_valores[$i]['liberacao_pedido'] != "t"){ ?>
                                                        <input title="Selecione para enviar a peça para separação do estoque" type="checkbox" name="produto_pecas[<?=$i?>][separa_estoque]" value="t">
                                                <?php } ?>
                                                <input type="hidden" name="produto_pecas[<?=$i?>][id]" rel="peca_id" <?php if($login_fabrica == 35){ echo " id='peca_id_$i' "; }?> value="<?=$pecas_valores[$i]['id']?>" posicao="<?= $i ?>" />

                                                <input type="hidden" name="produto_pecas[<?=$i?>][cancelada]" id='peca_cancelada_<?=$pecas_valores[$i]['id']?>' rel="peca_id_cancelada" value="<?=$qtde_cancelada ?>" />

                                                <input type="hidden" name="produto_pecas[<?=$i?>][pedido]" id='pedido_peca_<?=$i ?>' rel="peca_pedido" value="<?=$pecas_valores[$i]["pedido"] ?>" />

						<input type="hidden" name="produto_pecas[<?=$i?>][qtde_faturada]" id='peca_faturada_<?=$pecas_valores[$i]['id']?>' rel="quantidade_faturada" value="<?=$pecas_valores[$i]["qtde_faturada"] ?>" />

						<? if ($pecasExcedenteLB == true && in_array($login_fabrica, [169,170])) { ?>
                                                    <input type="hidden" name="produto_pecas[<?=$i?>][tem_obs]" value="<?= $pecas_valores[$i]['tem_obs']; ?>" />
                                                <? } ?>

                                                <input type="hidden" name="pecas_antes[<?=$i?>][id]" rel="pecas_antes" value="<?=$pecas_valores[$i]['id']?>" />
                                                <input type="hidden" <?php if($login_fabrica == 35){ echo "id='peca_os_item_$i'"; } ?> name="produto_pecas[<?=$i?>][os_item]" value="<?=$pecas_valores[$i]['os_item']?>" />
                                                <input type="hidden" name="produto_pecas[<?=$i?>][subitem]" value="<?=$pecas_valores[$i]['subitem']?>" />
                                                <? if (!(strlen($os) > 0 && strlen($pecas_valores[$i]["os_item"]) > 0 && verifica_os_item($pecas_valores[$i]["os_item"]) === true)) {
                                                    if(getValue("os[tipo_atendimento]") != 227){
                                                        if ($login_fabrica == 153 && $param_adicinal['recall'] != 1) { ?>
                                                            <button type="button" class="btn btn-mini btn-danger" name="remove_peca" <? if($login_fabrica == 153){ echo "onclick='verifica_estoque(".$i.", ".true.")'"; }?>  rel="<?=$i?>" style="display: <?=$peca_botao_remove?>;" >X</button><?
                                                        } else if (!in_array($login_fabrica, array(153,177,190))) { ?>
                                                            <button type="button" class="btn btn-mini btn-danger" name="remove_peca" rel="<?=$i?>" style="display: <?=$peca_botao_remove?>;" >X</button>
                                                        <? }else if ($login_fabrica == 177){
                                                                if (($areaAdmin === false AND $gera_pedido_selecionado == "t") || verifica_defeito_lancado($os)) {

                                                                    if (verifica_defeito_lancado($os)) {
                                                                        $title = "Não é possível excluir a peça, pois a OS já possui defeito constatado";
                                                                    } else {
                                                                        $title = "Não é possível excluir a peça. O serviço foi alterado pela fabrica, favor entrar em contato com a mesma para excluir a peça";
                                                                    }

                                                        ?>
                                                                    <button type="button" title="<?= $title ?>" disabled class="btn btn-mini btn-danger" name="remove_peca" rel="<?=$i?>" style="display: <?=$peca_botao_remove?>;" >X</button>
                                                        
                                                        <?php   }else{   ?>
                                                                    <button type="button" class="btn btn-mini btn-danger" name="remove_peca" rel="<?=$i?>" style="display: <?=$peca_botao_remove?>;" >X</button>
                                                        <?php
                                                                }
                                                        }
                                                    }
                                                } ?>

                                                <?php if (strlen($os) > 0 && in_array($login_fabrica, [190])) {?>

                                                    <button type="button" class="btn btn-mini btn-danger" name="remove_peca" rel="<?=$i?>" style="display: <?=$peca_botao_remove?>;" >X</button>
                                                <?php }?>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="<?= $span_referencia_peca; ?>" id="pecas_referencia_<?= $i; ?>">
                                    <div class='control-group' >
                                        <label class="control-label"><?=$referencia?></label>
                                        <div class="controls controls-row">
                                            <div class="<?php echo ($login_fabrica==148) ? "span11" : "span10"; ?> input-append">
                                                <input <?php if($login_fabrica == 35){echo "id='codigo_referencia_$i'"; }?> name="produto_pecas[<?=$i?>][referencia]" class="span12 produto_referencia" type="text" <?=$placeholder?> value="<?=$pecas_valores[$i]['referencia']?>" <?=$peca_readonly?> />
                                                <span class="add-on" rel="lupa_peca" <?=$peca_esconde_lupa?> readonly="readonly" >
                                                    <i class="icon-search"></i>
                                                </span>
                                                <input type="hidden" name="lupa_config" tipo="lista_basica" parametro="referencia" produto="" posicao="<?=$i?>" <? if (in_array($login_fabrica, array(156,163)) || (in_array($login_fabrica, array(161,167,203)) && ($areaAdmin == true || $postoInterno == true)) ) echo "preco_peca='true'";  if($login_fabrica == 177){
                                                    echo "preco_peca='true' cadastro_os='true' "; 
                                                } ?>     />
                                                <input type="hidden" name="pecas_antes[<?=$i?>][referencia]" rel="pecas_antes" value="<?=$pecas_valores[$i]['referencia']?>" />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <? if (!in_array($login_fabrica, array(52,148,151,169,170))) { ?>
                                    <div class="<?= $span_descricao_peca; ?>" id="pecas_descricao_<?= $i; ?>">
                                        <div class='control-group' >
                                            <label class="control-label" ><?php echo traduz("descricao");?></label>
                                            <div class="controls controls-row">
                                                <div class="span10 input-append">
                                                    <input name="produto_pecas[<?=$i?>][descricao]" class="span12 produto_peca_descricao produto_peca_descricao_<?=$i?>" type="text" value="<?=$pecas_valores[$i]['descricao']?>" <?=$peca_readonly?> />
                                                    <span class="add-on" rel="lupa_peca" <?=$peca_esconde_lupa?>>
                                                        <i class="icon-search"></i>
                                                    </span>
                                                    <input type="hidden" name="lupa_config" tipo="lista_basica" parametro="descricao" produto="" posicao="<?=$i?>" <? if (in_array($login_fabrica, array(156,163)) || (in_array($login_fabrica, array(161,167,203)) && ($areaAdmin == true || $postoInterno == true)) ) echo "preco_peca='true'"; if($login_fabrica == 177){ echo "preco_peca='true' cadastro_os='true' "; } ?> />
                                                    <input type="hidden" name="pecas_antes[<?=$i?>][descricao]" rel="pecas_antes" value="<?=$pecas_valores[$i]['descricao']?>" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <? } ?>
                                <div class="span1">
                                    <div class='control-group' >
                                        <label class="control-label" ><?php echo traduz("qtde");?></label>
                                        <div class="controls controls-row">
                                            <div class="span12">
                                                <? if (strlen($os) > 0 && strlen($pecas_valores[$i]["os_item"]) > 0 && verifica_os_item($pecas_valores[$i]["os_item"]) === true) { ?>
                                                    <input name="produto_pecas[<?=$i?>][qtde]" class="span12" type="text" value="<?=$pecas_valores[$i]['qtde']?>" readonly="readonly" id='qtde_<?=$i?>'/>
                                                <? } else { ?>

							        <input
    								name="produto_pecas[<?=$i?>][qtde]"
    								<?php
    								if($login_fabrica == 153){
        								echo "onchange='verifica_estoque($i,0)'";
    								}
                                    if($login_fabrica == 35){
                                        echo " onchange='limpaMovimentacaoEstoque($i)'";
                                    }
    								?>
                                    posicao="<?= $i ?>"
    								class="span12 qtde_peca_item"
    								id='qtde_<?=$i?>'
    								type="text"
    								value="<?=$pecas_valores[$i]['qtde']?>"
    								<?php
    								if (!in_array($login_fabrica, array(148,156,163,165))) {
        								if (in_array($login_fabrica, array(161,167,177,186,190,191,203)) && ($areaAdmin == true || $postoInterno == true)) {
                                                echo "onchange='calcula_valor_total_pecas(".$i.")';";
                                         } elseif (in_array($login_fabrica, array(195))) {
                                                echo "onchange='calcula_valor_total_pecas(".$i.")';";
                                         } else {
            									echo $readonly;
        								 }
    								} else if ($login_fabrica != 165) {
        								echo "onchange='calcula_valor_total_pecas(".$i.")';";
    								}
								?>
							/>

                                                <? } ?>
                                                    <input type="hidden" name="pecas_antes[<?=$i?>][qtde]" rel="pecas_antes" value="<?=$pecas_valores[$i]['qtde']?>" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <? if (in_array($login_fabrica, array(151,169,170))) {
                                    if(strlen($pecas_valores[$i]["pedido"]) > 0){
                                        $readonlyselect .= "$('select[id=\"peca_defeitos_{$i}\"]').selectreadonly(true); ";
                                    } ?>
                                    <div class="span4">
                                        <div class='control-group' >
                                            <label class="control-label" ><?php echo traduz("defeito.da.peca");?></label>
                                            <div class="controls controls-row">
                                                <div class="span12">
                                                    <select class='span12' id="peca_defeitos_<?=$i?>" name='produto_pecas[<?=$i?>][defeito_peca]' >
                                                        <option value=''></option>
                                                        <? if (strlen($pecas_valores[$i]["id"]) > 0) {
                                                            if (in_array($login_fabrica, array(35,169,170)) && strlen($defeitos_multiplos) > 0) {
                                                                $sql = "
                                                                    SELECT
                                                                        tbl_defeito.defeito,
                                                                        tbl_defeito.codigo_defeito,
                                                                        tbl_defeito.descricao AS defeito_descricao
                                                                    FROM tbl_diagnostico
                                                                    JOIN tbl_defeito ON tbl_defeito.defeito = tbl_diagnostico.defeito AND tbl_defeito.fabrica = {$login_fabrica}
                                                                    WHERE tbl_diagnostico.fabrica = {$login_fabrica}
                                                                    AND tbl_diagnostico.defeito_constatado IN ({$defeitos_multiplos})
                                                                    ORDER BY tbl_defeito.descricao;
                                                                ";

                                                            } else {
                                                                $sql = "SELECT familia_peca from tbl_peca_familia where fabrica = {$login_fabrica} AND peca = {$pecas_valores[$i]['id']}";
                                                                $res = pg_query($con,$sql);

                                                                $familia = pg_fetch_result($res, 0,"familia_peca");

                                                                if (strlen($familia) > 0) {
                                                                    $sql = "
                                                                        SELECT
                                                                            tbl_peca_defeito.defeito,
                                                                            tbl_defeito.descricao AS defeito_descricao
                                                                        FROM tbl_peca_defeito
                                                                        JOIN tbl_familia_peca ON tbl_familia_peca.familia_peca = tbl_peca_defeito.familia_peca AND tbl_familia_peca.fabrica = {$login_fabrica} AND tbl_familia_peca.ativo is true
                                                                        JOIN tbl_defeito ON tbl_defeito.defeito = tbl_peca_defeito.defeito AND tbl_defeito.fabrica = {$login_fabrica}
                                                                        WHERE tbl_peca_defeito.familia_peca = {$familia}
                                                                        ORDER BY tbl_familia_peca.descricao, tbl_peca_defeito.defeito;
                                                                    ";
                                                                }
                                                            }

                                                            $res = pg_query($con, $sql);

                                                            while ($result = pg_fetch_object($res)) {
                                                                if ($result->defeito == $pecas_valores[$i]["defeito_peca"]) {
                                                                    $selected = "selected";
                                                                } else {
                                                                    unset($selected);
                                                                } ?>
                                                                <option value='<?= $result->defeito; ?>' <?= $selected; ?>><?php echo ((in_array($login_fabrica, array(169,170))) ? $result->codigo_defeito." - " : "").$result->defeito_descricao; ?></option>
                                                            <? }
                                                        } ?>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                <? }
                                if (in_array($login_fabrica, array(52,157))) { ?>

                                    <div class="<?=$span_defeito_peca?>">
                                        <div class='control-group' >
                                            <label class="control-label" ><?php echo ($login_fabrica == 157) ? traduz("motivo") : traduz("defeito.da.peca");?></label>
                                            <div class="controls controls-row">
                                                <div class="span12">
                                                    <select class='span12' id="peca_defeitos_<?=$i?>" name='produto_pecas[<?=$i?>][defeito_peca]' >
                                                        <option value=''></option>
                                                        <?
                                                        $sql = "SELECT defeito, descricao FROM tbl_defeito WHERE fabrica = {$login_fabrica} AND ativo IS TRUE ORDER BY descricao ASC";
                                                        $res = pg_query($con,$sql);

                                                        while ($result = pg_fetch_object($res)) {
                                                            $selected = ($result->defeito == $pecas_valores[$i]["defeito_peca"]) ? "SELECTED" : ""; ?>
                                                            <option value='<?= $result->defeito; ?>' <?= $selected; ?>><?= $result->descricao; ?></option>
                                                        <? } ?>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <? } ?>

                                <?php if ($login_fabrica == 183){ 
                                    $codigo_utilizacao = $_REQUEST["produto_pecas"][$i]["codigo_utilizacao"];
                                    if (empty($codigo_utilizacao)){
                                        $codigo_utilizacao = getValue("produto_pecas[$i][codigo_utilizacao]");
                                    }
                                ?>
                                    <div class="span3">
                                            <div class='control-group'>
                                                <label class="control-label">Código Utilização</label>
                                                <div class="controls controls-row">
                                                    <div class="span12">
                                                        <select class='span12' name='produto_pecas[<?= $i; ?>][codigo_utilizacao]'>
                                                            <option value=""><?php echo traduz("selecione");?></option>
                                                            <?php 
                                                                $sql_utilizacao = "
                                                                    SELECT causa_defeito, codigo, descricao 
                                                                    FROM tbl_causa_defeito 
                                                                    WHERE fabrica = {$login_fabrica} 
                                                                    AND ativo IS TRUE;";
                                                                $res_utilizacao = pg_query($con, $sql_utilizacao);
                                                                
                                                                if (pg_num_rows($res_utilizacao) > 0) {

                                                                    for($ut = 0; $ut < pg_num_rows($res_utilizacao); $ut++) {
                                                                        $desc_motivo   = pg_fetch_result($res_utilizacao, $ut, "descricao");
                                                                        $cod_motivo    = pg_fetch_result($res_utilizacao, $ut, "codigo");
                                                                        $causa_defeito = pg_fetch_result($res_utilizacao, $ut, "causa_defeito");

                                                                        $selected_codigo_utilizacao = "";
                                                                        if ($codigo_utilizacao == $causa_defeito) {
                                                                            $selected_codigo_utilizacao = "selected";
                                                                        }
                                                                        echo "<option value='{$causa_defeito}' $selected_codigo_utilizacao>{$cod_motivo} - {$desc_motivo}</option>";
                                                                    }
                                                                }
                                                            ?>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                    </div>
                            <?php } ?>

                                <?php if (in_array($login_fabrica, array(143))) {
                                ?>
                                <input name="produto_pecas[<?=$i?>][servico_realizado]" type="hidden" value="<?=$servico_realizado?>" />

                                <?php } elseif (in_array($login_fabrica, array(35))) {
                                ?>
                                    <input name="produto_pecas[<?=$i?>][servico_realizado]" type="hidden" value="<?=(empty($servico)) ? $servico_realizado : $servico;?>" />
                                <? } else { 

                                ?>
                                    <div class="span2" id="div_servicos_peca_<?=$i?>" <?=$display_servico_peca;?> >
                                        <div class='control-group'>
                                            <label class="control-label"><?php echo traduz("servicos");?></label>
                                            <div class="controls controls-row">
                                                <div class="span12 tal">
                                        <?php
                                        if (strlen($os) > 0 && (strlen($pecas_valores[$i]["os_item"]) > 0 && (verifica_os_item($pecas_valores[$i]["os_item"]) === true || $login_fabrica == 158))) {
                                           
                                            if ($login_fabrica == 165 && $pecas_valores[$i]['id'] != "") {
                                                $res_sr = get_servico_realizado(null,$pecas_valores[$i]['id'],null);
                                            }
                                        ?>
                                        <select class='span12' id="servicos_peca_<?=$i?>" name='produto_pecas[<?=$i?>][servico_realizado]'>
                                        <?php
					                        $servico_selected = false;
                                            $contadorSR = pg_num_rows($res_sr);
                                            for($sr = 0; $sr < $contadorSR; $sr++) {
                                                $servico_realizado = pg_fetch_result($res_sr, $sr, "servico_realizado");
                                                $descricao         = pg_fetch_result($res_sr, $sr, "descricao");
                                                $gera_pedido       = pg_fetch_result($res_sr, $sr, "gera_pedido");
                                                $troca_de_peca     = pg_fetch_result($res_sr, $sr, "troca_de_peca");
                                                $peca_estoque      = pg_fetch_result($res_sr, $sr, "peca_estoque");

                                                if ($descricao != 'Ajuste' && $cristofoliInter) {
                                                	continue;
                                                }

												$selected = "";
                                                if (!in_array($login_fabrica, [177]) OR $areaAdmin === false) {
                                                    if ($servico_realizado != $servico and !empty($servico)) {
                                                        continue;
                                                    } elseif($servico_realizado == $servico) {
														$selected = "selected";
														$servico_selected = true;
                                                    }
                                                } elseif (in_array($login_fabrica, [177]) AND $areaAdmin === true) {
													if ($servico_realizado == $servico) {
														$selected = "selected";
														$servico_selected = true;
													} else {
														$selected = "";
													}
                                                } ?> 
                                                <option value='<?= $servico_realizado; ?>' <?= $selected ?> gera_pedido='<?= $gera_pedido; ?>' troca_de_peca='<?= $troca_de_peca; ?>' peca_estoque='<?= $peca_estoque; ?>' <?= $attr_codigo ?>><?=$descricao?></option>
                    					    <?php }

                    						if ($servico_selected === false) {
                    							$sqlServico = "SELECT descricao FROM tbl_servico_realizado WHERE fabrica = $login_fabrica AND servico_realizado = $servico";
                    							$resServico = pg_query($con, $sqlServico);
                    							$descricao = pg_fetch_result($resServico, 0, 'descricao');
                    						?>
                    							<option value='<?= $servico; ?>'><?=$descricao?></option>
                    						<?php
                    						}
                                            if ($login_fabrica == 165 && $pecas_valores[$i]['id'] != "") {
                                                unset($res_sr);
                                            }
?>
                                                    </select>
<?                                      } else {

                                            if (in_array($login_fabrica, array(35, 165, 177)) && $pecas_valores[$i]['id'] != "") {
                                                if($login_fabrica == 35 and $pecas_valores[$i]['peca_estoque'] == 't'){
                                                    $usaEstoquePosto = true;
                                                }else{
                                                    $usaEstoquePosto = false;
                                                }
                                                $res_sr = get_servico_realizado(null,$pecas_valores[$i]['id'],null);
                                            }elseif (in_array($login_fabrica, array(35, 165, 177)) && $pecas_valores[$i]['id'] == "") {
                                                $usaEstoquePosto = false;
                                                $res_sr = get_servico_realizado();

					    }else if(in_array($login_fabrica,array(161))){
						$res_sr = get_servico_realizado();
					    }


?>
                                            <select class='span12 servicos_peca_realizado' id="servicos_peca_<?=$i?>" <?= $disabled ?> name='produto_pecas[<?=$i?>][<?php echo $cristofoliInter ? '' : 'servico_realizado'?>]' <?= (!in_array($login_fabrica,array(148,156,165))) ? $readonly : ""; ?>>
<?php
                                            $contadorSR = pg_num_rows($res_sr);
                                            for($sr = 0; $sr < $contadorSR; $sr++) {
                                                $servico_realizado = pg_fetch_result($res_sr, $sr, "servico_realizado");
                                                $descricao         = pg_fetch_result($res_sr, $sr, "descricao");
                                                $gera_pedido       = pg_fetch_result($res_sr, $sr, "gera_pedido");
                                                $troca_de_peca     = pg_fetch_result($res_sr, $sr, "troca_de_peca");
                                                $peca_estoque      = pg_fetch_result($res_sr, $sr, "peca_estoque");
                                                $attr_codigo       = '';

                                                if (in_array($login_fabrica, [193])) {
                                                    $descricao      = (mb_detect_encoding($descricao) == 'UTF-8') ? utf8_decode($descricao) : $descricao;
                                                    $codigo_servico = pg_fetch_result($res_sr, $sr, "codigo_servico");
                                                    $attr_codigo    = 'codigo_servico="'.$codigo_servico.'"';
                                                }

                                                if($login_fabrica == 161){
                                                    if(getValue('produto[linha]') != 1126 and $descricao == "Registro" ){
                                                        continue;
                                                    }

                                                    if ($descricao != 'Ajuste' && $cristofoliInter) {
                                                    	continue;
                                                    }
                                                }  

                                                if (in_array($login_fabrica, [177])) {
                                                    if ($areaAdmin === false) {
                                                        if($gera_pedido == 't' AND $troca_de_peca == 't'){
                                                            continue;
                                                        }

                                                        if ($tipo_posto_interno == 't') {
                                                            if (!empty($servico) AND $servico != $servico_realizado) {
                                                                continue;
                                                            }
                                                        } else {
                                                            if (empty($servico) AND $gera_pedido == 't') {
                                                                continue;
                                                            } elseif (!empty($servico) AND $servico != $servico_realizado) {
                                                                continue;
                                                            }
                                                        }
                                                    }
                                                }
                                                if ($login_fabrica == 178){
                                                    $id_posto = getValue('posto[id]');
                                                    $disabled_estoque = "";
                                                    
                                                    if ($pecas_valores[$i]['id']){
                                                        $sql_estoque = "
                                                            SELECT qtde 
                                                            FROM tbl_estoque_posto 
                                                            WHERE fabrica = $login_fabrica 
                                                            AND posto = $id_posto 
                                                            AND peca = {$pecas_valores[$i]['id']}";
                                                        $res_estoque = pg_query($con, $sql_estoque);

                                                        if (pg_num_rows($res_estoque) > 0){
                                                            if ($peca_estoque == 'f'){
                                                                $disabled_estoque = "style='display:none;'";
                                                            }
                                                        }else if ($peca_estoque == 't'){
                                                            $disabled_estoque = "style='display:none;'";
                                                        }
                                                    }
                                                    if (strtolower($descricao) == "troca de produto" OR strtolower($descricao) == "cancelado"){
                                                        continue;
                                                    }
                                                }

                                                if (isset($moduloTraducao) && !empty($servico_realizado)) {
                                                    $sqlIdiomaServico = "SELECT descricao 
                                                                             FROM tbl_servico_realizado_idioma 
                                                                             WHERE servico_realizado = {$servico_realizado}
                                                                             AND LOWER(idioma) = LOWER('$cook_idioma')";
                                                    $resIdiomaServico = pg_query($con, $sqlIdiomaServico);

                                                    if (pg_num_rows($resIdiomaServico) > 0) {
                                                        $descricao = utf8_decode(pg_fetch_result($resIdiomaServico, 0, 'descricao'));
                                                    }
                                                }

                                                if (($servico_realizado == $servico) || ($login_fabrica == 156 AND $descricao == "Troca de Peça (gera pedido)" and empty($servico))) {
                                                    $selected = "selected";
                                                } else {
                                                    $selected = "";
                                                }
?>
                                                        <option <?=$disabled_estoque?> value='<?=$servico_realizado; ?>' gera_pedido='<?= $gera_pedido; ?>' troca_de_peca='<?= $troca_de_peca; ?>' peca_estoque='<?= $peca_estoque; ?>' <?= $attr_codigo ?> <?= $selected; ?>><?=$descricao?></option>
<?php
                                            }

                                            if ($login_fabrica == 165 && $pecas_valores[$i]['id'] != "") {
                                                unset($res_sr);
                                            }
?>
                                                    </select>
<?php
                                        }
?>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <?php

                                        if($login_fabrica == 35){
                                            $parametros_adicionais = $pecas_valores[$i]['parametros_adicionais'];
                                            $parametros_adicionais = json_decode($parametros_adicionais, true);

                                            if($pecas_valores[$i]['po_pecas_hidden'] == 't'){
                                                $po_peca_display = "display:block; ";
                                            }else{
                                                $po_peca_display = "display:none; ";

                                            }
                                        ?>
                                        <div class="span2" id="po_pecas_<?= $i; ?>" style='<?=$po_peca_display?>'>
                                            <div class='control-group <?=(in_array('sim', array($msg_erro['campos'][$pecas_valores[$i]['referencia']]))) ? "error" : "" ?> ' >
                                                <label class="control-label" ><?php echo traduz("po.peca");?></label>
                                                <div class="controls controls-row">
                                                    <div class="span10">
                                                        <input class='po_pecas span12' name="produto_pecas[<?=$i?>][po_pecas]" type="text" value="<?=$pecas_valores[$i]['po_pecas']?>" />
                                                        <input type='hidden' name='produto_pecas[<?=$i?>][po_pecas_hidden]' id="hidden_po_pecas_<?= $i; ?>" value='<?=$pecas_valores[$i]['po_pecas_hidden']?>'>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    <?php } ?>

                                    <? if ($login_fabrica == 145 && getValue("os[tipo_atendimento]") == 201) { ?>
                                        <script>
                                            $("select[name='produto_pecas[<?=$i?>][servico_realizado]']").selectreadonly(true);
                                        </script>
                                    <? }
                                }
                                if(in_array($login_fabrica, [167, 203])){ //HD-3428297
                                
                                    if(strlen(trim($pecas_valores[$i]['serie_peca'])) == 0 AND $_REQUEST['produto_pecas'][$i]['valida_serie_peca'] <> "t"){ //HD-3428297
                                        $display_167 = "display: none;";
                                    }else{
                                        if($valida_atendimento == "Orçamento"){
                                            $display_167 = "display: none;";
                                        }else{
                                            $display_167 = "";
                                        }
                                    }
                                ?>
                                    <div class="span3" style= " <?=$display_167?> margin-left: 73px; margin-bottom: 15px;" id="serie_peca_<?=$i?>">
                                        <div class='control-group' >
                                            <label class="control-label" ><?php echo traduz("serie.da.peca");?></label>
                                            <div class="controls controls-row">
                                                <div class="span12">
                                                    <input class="span10 serie_peca" name="produto_pecas[<?=$i?>][serie_peca]" type="text" value="<?=$pecas_valores[$i]['serie_peca']?>" />
                                                    <input type="hidden" name="produto_pecas[<?=$i?>][valida_serie_peca]" value="<?=$pecas_valores[$i]['valida_serie_peca']?>">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <?php }
                                if ($login_fabrica == 156){ ?>
                                    <div class="span2 div_void_peca" style="width: 70px;" id="pecas_void_<?=$i?>">
                                        <div class='control-group <?=(in_array('produto_pecas['.$i.'][void]', $msg_erro['campos'])) ? "error" : "" ?>' >
                                            <label class="control-label">Void</label>
                                            <div class="controls controls-row">
                                                <div class="span12">
                                                <h5 class='asteristico'>*</h5>
                                                <input name="produto_pecas[<?=$i?>][void]" class="span12 void_peca" type="text" value="<?= getValue('produto_pecas['.$i.'][void]') ?>" />
                                                <input type="hidden" name="pecas_antes[<?=$i?>][void]" rel="pecas_antes" value="<?=$pecas_valores[$i]['void']?>" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <? }
                                if (in_array($login_fabrica, array(148,156,161,163,167,177,186,190,191,195,203))) {

                                    if (in_array($login_fabrica, array(148))) {
                                        $display_valor = " display: none;";
                                    } else if (in_array($login_fabrica, array(156))) {
                                        $readonly_valor = "readonly='readonly'";

                                        if (getValue("os[tipo_atendimento]") != 247) {
                                            $display_valor = "display: none;";
                                        }
                                    } else if(in_array($login_fabrica, array(161,167,177,203))){

                                        if (in_array($login_fabrica, [167, 203])) {
                                            if ($posto_interno != true) {
                                                $readonly_valor = "readonly='readonly'";
                                            }
                                        }else if ($login_fabrica == 177){
                                            $readonly_valor = "";
                                        } else {
                                            $readonly_valor = "readonly='readonly'";
                                        }

                                        if (strlen(getValue("os[tipo_atendimento]")) == 0 || getValue("os[tipo_atendimento]") != $id_orcamento) {
                                            $display_valor = "display: none;";
                                        }
                                    } else if (in_array($login_fabrica, array(163))) {
                                        $display_valor = "display: none;";
                                        $readonly_valor = "readonly='readonly'";
                                    } else if (in_array($login_fabrica, array(186,190,195))) {


                                        $readonly_valor = "readonly='readonly'";

                                    }
                                    if (in_array($login_fabrica, array(190)) && $areaAdmin == false) {
                                        $display_valor = "display: none !important;";
                                        $readonly_valor = "readonly='readonly'";

                                    }
                                ?>
                                    <div class="span2" style="width:70px;<?=$display_valor?>" id="pecas_valor_<?=$i?>">
                                        <div class='control-group'>
                                            <label class="control-label"><?php echo traduz("valor");?></label>
                                            <div class="controls controls-row">
                                                <div class="span12">
                                                    <input posicao="<?=$i?>" name="produto_pecas[<?=$i?>][valor]" class="span12 valor_peca" id="valor_peca" type="text" value="<?=str_replace(".", ",", $pecas_valores[$i]['valor'])?>" <?=$readonly_valor?> />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="span2" style="width:70px;<?= $display_valor; ?>" id="pecas_valor_total_<?= $i; ?>">
                                        <div class='control-group'>
                                            <label class="control-label"><?php echo traduz("valor.total");?></label>
                                            <div class="controls controls-row">
                                                <div class="span12">
                                                    <input name="produto_pecas[<?=$i?>][valor_total]" class="span12 valor_total_peca" id="valor_total_peca" type="text" value="<?=str_replace(".", ",", $pecas_valores[$i]['valor_total']);?>" <?= $readonly_valor; ?> />
                                                    <?php if (in_array($login_fabrica, [167, 203])) { ?>
                                                        <input type="hidden" id="motivo_segunda_peca_<?=$i?>" name="produto_pecas[<?=$i?>][motivo_segunda_peca]" value="" />
                                                        <input type="hidden" id="motivo_segunda_motivo_<?=$i?>" name="produto_pecas[<?=$i?>][motivo_segunda_motivo]" value="" />
                                                        <input type="hidden" id="motivo_segunda_extraviada_<?=$i?>" name="produto_pecas[<?=$i?>][motivo_segunda_extraviada]" value="" />
                                                <?php } ?>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <? }?>
                                <?php 
                                if ($login_fabrica == 175){
                                    if (!empty($pecas_valores[$i]['quantidade_disparos']) OR getValue("produto_pecas[$i][pecas_disparos]") == 'true'){
                                        $display_peca_disparo = "";
                                    }else{
                                        $display_peca_disparo = "style='display:none';";
                                    }

                                    if (!empty($pecas_valores[$i]['numero_serie']) OR getValue("produto_pecas[$i][valida_serie_peca]") == 'true'){
                                        $display_serie_peca = "";
                                    }else{
                                        $display_serie_peca = "style='display:none';";
                                    }
                                ?>  
                                    <div class='div_env'>
                                        <div></div>
                                        <div class="span3" id="div_qtde_disparos_peca<?= $i; ?>" <?=$display_peca_disparo?>>
                                            <input type="hidden" name="produto_pecas[<?=$i?>][pecas_disparos]" id="pecas_disparos<?=$i?>" value="<?=getValue("produto_pecas[$i][pecas_disparos]")?>">
                                            <div class='control-group'>
                                                <label class="control-label">Quantidade de Disparos</label>
                                                <div class="controls controls-row">
                                                    <div class="span10">
                                                        <input name="produto_pecas[<?=$i?>][quantidade_disparos]" class="span12 quantidade_disparos" type="text" value="<?=$pecas_valores[$i]['quantidade_disparos']?>"/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="span3" <?=$display_serie_peca?> id="div_numero_serie_peca<?=$i?>">
                                            <div class='control-group' >
                                                <label class="control-label" >Número de Série</label>
                                                <div class="controls controls-row">
                                                    <div class="span12">
                                                        <input class="span10 serie_peca numeric" name="produto_pecas[<?=$i?>][numero_serie]" type="text" value="<?=$pecas_valores[$i]['numero_serie']?>" />
                                                        <input type="hidden" name="produto_pecas[<?=$i?>][valida_serie_peca]" id="valida_serie_peca<?=$i?>" value="<?=$pecas_valores[$i]['valida_serie_peca']?>">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <?php 
                                            if ($pecas_valores[$i]["componente_raiz"] == "t"){
                                                $checked_raiz = "checked";
                                            }else{
                                                $checked_raiz = "";
                                            }
                                        ?>
                                        <div class="span3" id="div_componente_raiz<?= $i; ?>">
                                            <div class='control-group'>
                                                <div class='control-group'>
                                                    <div class="span10">
                                                        <label class="checkbox" style="margin-top: 15px;"><input type="checkbox" <?=$checked_raiz?> name="produto_pecas[<?=$i?>][componente_raiz]" value="t">Componente Raiz</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                            <?php } ?>

                            <?php 
                                if ($login_fabrica == 177){
                                    if (($_REQUEST["produto_pecas"][$i]["peca_lote"] == 't') || !empty(getValue('produto_pecas[$i][peca_lote]'))) {
                                        $display_lote_peca = "";
                                    }else if (!empty($os) AND (!empty($_RESULT["produto_pecas"][$i]["lote"]) or $_RESULT["produto_pecas"][$i]["peca_lote"] =='t')){
                                        $display_lote_peca = "";
                                    }else{
                                        $display_lote_peca = "style='display:none !important;'";
                                    }
                            ?>
                                <div class="peca_lote<?= $i ?>" <?= $display_lote_peca ?>>
                                    <div class="span3" style="margin-left: 70px;margin-top: 5px;">
                                        <input type="hidden" name="produto_pecas[<?=$i?>][peca_lote]" id="peca_lote<?=$i?>" value="<?=getValue("produto_pecas[$i][peca_lote]")?>">
                                        <div class='control-group'>
                                            <label class="control-label">Lote da Peça Danificada</label>
                                            <div class="controls controls-row">
                                                <div class="span10">
                                                    <h5 class='asteristico h5_lote<?=$i?>'>*</h5>
                                                    <input name="produto_pecas[<?=$i?>][lote]" class="span12 numeric input_lote<?= $i ?>" <?=(!empty($pecas_valores[$i]['lote']) ? "readonly" : "")?>  type="text" value="<?=$pecas_valores[$i]['lote']?>"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--
                                    <div class="span3">
                                        <div class='control-group'>
                                            <label class="control-label">Lote nova peça</label>
                                            <div class="controls controls-row">
                                                <div class="span10">
                                                    <input name="produto_pecas[<?=$i?>][lote_nova]" class="span12 numeric" <?=(!empty($pecas_valores[$i]['lote_nova']) ? "readonly" : "")?> type="text" value="<?=$pecas_valores[$i]['lote_nova']?>"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    -->
                                </div>
                            <?php } ?>

                                <?php
                                if (in_array($login_fabrica, [148])) { 
                                    
                                    $displayNfEstoque = "display: none;";

                                    if (!empty(getValue("produto_pecas[$i][servico_realizado]"))) {

                                        $sqlServicoPedido = "SELECT servico_realizado 
                                                             FROM tbl_servico_realizado
                                                             WHERE servico_realizado = ".getValue("produto_pecas[$i][servico_realizado]")."
                                                             AND gera_pedido IS TRUE
                                                             AND troca_de_peca IS TRUE";
                                        $resServicoPedido = pg_query($con, $sqlServicoPedido);

                                        if (pg_num_rows($resServicoPedido) > 0) {

                                            $displayNfEstoque = "";

                                        }

                                    }

                                ?>

                                    <div class="row-fluid div_nf_estoque_fabrica" id="div_nf_estoque_fabrica_<?= $i ?>" style="<?= $displayNfEstoque ?>margin-left: 40px;">
                                        <div class="span1"></div>
                                        <div class="span10">
                                            <div class='control-group'>
                                                <label class="control-label"> &nbsp; Nota Fiscal</label>
                                                <div class="controls controls-row">
                                                    <h5 class='asteristico'>*</h5>
                                                    <div class="span5">
                                                        <input type="text" name='produto_pecas[<?= $i ?>][nf_estoque_fabrica]' value="<?= getValue("produto_pecas[$i][nf_estoque_fabrica]") ?>" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="span1"></div>
                                    </div>
                                    <br />

                                <?php
                                }
                                ?>

                            </div>
                            <?php if (in_array($login_fabrica, array(175,177))){ echo "<br/>";} ?>
                            <? if($login_fabrica == 153) { ?>
                                <div class="row-fluid" name="dev_obrig" id="dev_obrig_<?=$i?>" style="display:none" <?=$bgcolor?> >
                                    <div class="span1"></div>
                                    <div class="span10 alert alert-danger" > <?php echo traduz("esta.peca.devera.ser.devolvida.para.a.fabrica");?></div>
                                    <div class="span1"></div>
                                </div>
                            <?php } ?>
                            
                            <?php if ($pecasExcedenteLB == true && in_array($login_fabrica, [169,170])) {
                                if (!empty($produto_pecas[$i]["causa_defeito"]) || !empty($pecas_valores[$i]['tem_obs'])) {
                                    $displayObsPeca = 'style="display:block;"';
                                } else {
                                    $displayObsPeca = 'style="display:none"';
                                } ?>
                                <div class="row-fluid" name="div_peca_excedente" id="div_peca_excedente_<?= $i; ?>" <?= $displayObsPeca; ?> <?= $bgcolor; ?> >
                                    <div class="span1"></div>
                                    <div class="span10">
                                        <div class='control-group'>
                                            <label class="control-label">Motivo 2ª Solicitação</label>
                                            <div class="controls controls-row">
                                                <div class="span5">
                                                    <select class='span12' name='produto_pecas[<?=$i?>][causa_defeito]'>
                                                    <option value=""><?php echo traduz("selecione");?></option>
                                                    <?php 
                                                        $sql_motivo = "SELECT causa_defeito, codigo, descricao 
                                                                        FROM tbl_causa_defeito 
                                                                        WHERE fabrica = {$login_fabrica} 
                                                                        AND ativo IS TRUE;";
                                                        $res_motivo = pg_query($con, $sql_motivo);

                                                        $contadorMotivo = pg_num_rows($res_motivo);
                                                        
                                                        if ($contadorMotivo > 0) {

                                                            for($mt = 0; $mt < $contadorMotivo; $mt++) {
                                                                $desc_motivo   = pg_fetch_result($res_motivo, $mt, "descricao");
                                                                $cod_motivo    = pg_fetch_result($res_motivo, $mt, "codigo");
                                                                $causa_defeito = pg_fetch_result($res_motivo, $mt, "causa_defeito");

                                                                $selected_motivo = "";
                                                                if ($produto_pecas[$i]["causa_defeito"] == $causa_defeito) {
                                                                    $selected_motivo = "selected";
                                                                }

                                                                echo "<option value='{$causa_defeito}' $selected_motivo >{$desc_motivo}</option>";
                                                            }
                                                        }
                                                    ?>
                                                </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="span1"></div>
                                </div>
                                <br />
                            <?php } ?>

                        <?php
                        } else { ?>
                            <div class="row-fluid" name="peca_<?=$i?>" <?=$bgcolor?> >
                                <div class="span1"></div>

                                <div class="span10">
                                    <div class='control-group' >
                                        <br />
                                        <div class="controls controls-row">
                                            <div class="span12 tac" >
                                                <input type="hidden" name="produto_pecas[<?=$i?>][os_item]" value="<?=$pecas_valores[$i]['os_item']?>" />
                                                <input type="hidden" name="produto_pecas[<?=$i?>][referencia]" value="<?=$pecas_valores[$i]['referencia']?>" />
                                                <input type="hidden" name="produto_pecas[<?=$i?>][descricao]" value="<?=$pecas_valores[$i]['descricao']?>" />
                                                <input type="hidden" name="produto_pecas[<?=$i?>][qtde]" value="<?=$pecas_valores[$i]['qtde']?>" />
                                                <div class="alert alert-info tal" style="margin-bottom: 0px;" >
                                                    <h4><?php echo traduz("produto.de.troca");?>: <?=$pecas_valores[$i]['referencia']?> - <?=$pecas_valores[$i]['descricao']?></h4>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="span1"></div>
                            </div>
                        <? }
                    } else { ?>
                        <div class="row-fluid" name="peca_<?=$i?>" <?=$bgcolor?>>
                            <div class="span1"></div>
                            <div class="span10">
                                <div class='control-group'>
                                    <div class="controls controls-row">
                                        <div class="span12 tac">
                                            <input type="hidden" name="produto_pecas[<?=$i?>][os_item]" value="<?=$pecas_valores[$i]['os_item']?>" />
                                            <input type="hidden" name="produto_pecas[<?=$i?>][referencia]" value="<?=$pecas_valores[$i]['referencia']?>" />
                                            <input type="hidden" name="produto_pecas[<?=$i?>][descricao]" value="<?=$pecas_valores[$i]['descricao']?>" />
                                            <input type="hidden" name="produto_pecas[<?=$i?>][qtde]" value="<?=$pecas_valores[$i]['qtde']?>" />
                                            <div class="alert alert-danger tal" style="margin-bottom: 0px;" >
                                                <h6><?php echo traduz("peca.cancelada");?>: <?=$pecas_valores[$i]['referencia']?> - <?=$pecas_valores[$i]['descricao']?></h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="span1"></div>
                        </div>
                    <? }
                } ?>
            </div>
            <? if (in_array($login_fabrica, array(156))) {
                $valor_total_pecas = getValue('os[valor_total_pecas]');
                $valor_total_display = "display:none;";
                ?>
                <div class="row-fluid div_valor_total_pecas" style="min-height: 40px !important;<?= $valor_total_display; ?>">
                    <div class="span11" style="text-align: right; padding: 0px;">
                        <h4>
                            <input type="hidden" name="os[valor_total_pecas]" id="valor_total_pecas" valor="<?=$valor_total_pecas?>" />
                            <?php echo traduz("valor.total.de.pecas");?>:
                            <span class="preco-total-pecas tac" style="width: 70px;"><?=(strlen($valor_total_pecas) == 0) ? "0.00" : $valor_total_pecas; ?></span>
                        </h4>
                    </div>
                    <div class="span1"></div>
                </div>
            <?php
            } else if(in_array($login_fabrica, array(163,186,190,191,195))){
                $valor_total_pecas = getValue('os[valor_total_pecas]');

                if (in_array($login_fabrica, array(163))) {
                    $valor_total_display = "display:none;"; 
                }
              
            ?>

                <div class="row-fluid div_valor_total_pecas" style="<?= $valor_total_display; ?>">
                    <div class="span1"></div>
                    <div class="span3 txt_valor_add">
                        <div class="control-group <?=(in_array('os[valor_adicional]', $msg_erro['campos'])) ? "error" : "" ?>">
                            <label class="control-label" for="valor_adicional"><?php echo (in_array($login_fabrica, [186,190,191,195])) ? traduz("valor.de.mao.de.obra") : traduz("valor.adicional");?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <input id="valor_adicional" name="os[valor_adicional_mo]" class="span12" type="text" value="<?=getValue('os[valor_adicional_mo]')?>" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <?php if (!in_array($login_fabrica, [186,190,191,195])) {?>                    <div class="span3">
                        <div class="control-group <?=(in_array('os[desconto]', $msg_erro['campos'])) ? "error" : "" ?>">
                            <label class="control-label" for="desconto"><?php echo traduz("desconto");?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <input id="desconto" name="os[desconto]" class="span12" type="text" value="<?=getValue('os[desconto]')?>" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <?php }?> 
                    <div class="span4" style="text-align: right; padding: 0px;">
                        <h4 style="padding-top: 15px;">
                            <input type="hidden" name="os[valor_total_pecas]" id="valor_total_pecas" valor="<?=$valor_total_pecas?>" />
                            <?php echo traduz("valor.total.da.os");?>:
                            <span class="preco-total-pecas tac" style="width: 70px;"><?= (strlen($valor_total_pecas) == 0) ? "0.00" : $valor_total_pecas; ?></span>
                        </h4>
                    </div>
                    <div class="span1"></div>
                </div>
            <? } else if (($postoInterno == true || $areaAdmin == true) && in_array($login_fabrica, array(161,167,177,203))) {

                $valor_total_pecas = getValue('os[valor_total_pecas]');
                $valor_total_display = "display:none;";

                $labelValorAdicional = (in_array($login_fabrica, array(167,177,203))) ? traduz("valor.de.mao.de.obra") : traduz("valor.adicional");

            ?>

                <div class="row-fluid div_valor_total_pecas" style="<?= $valor_total_display; ?>">
                    <div class="span1"></div>
                    <div class="span3 txt_valor_add">
                        <div class="control-group <?=(in_array('os[valor_adicional]', $msg_erro['campos'])) ? "error" : "" ?>">
                            <label class="control-label" for="valor_adicional"><?= $labelValorAdicional ?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <?php if(in_array($login_fabrica, [167, 203])){ ?>
                                        <input id="valor_adicional" name="os[valor_adicional_peca_produto]" class="span12" type="text" value="<?=getValue('os[valor_adicional_peca_produto]')?>" />
                                    <?php }else{ ?>
                                        <input id="valor_adicional" name="os[valor_adicional_mo]" class="span12" type="text" value="<?=getValue('os[valor_adicional_mo]')?>" />
                                    <?php } ?>
                                </div>
                            </div>
                        </div>
                    </div>
                    <?php if ($login_fabrica != 177) { ?>
                    <div class="span3" <?=$display_desconto?> >
                        <div class="control-group <?=(in_array('os[desconto]', $msg_erro['campos'])) ? "error" : "" ?>">
                            <label class="control-label" for="desconto"><?php echo traduz("desconto");?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <input id="desconto" name="os[desconto]" class="span12" type="text" value="<?=getValue('os[desconto]')?>" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <?php } ?>
                    <div class="span4" style="text-align: right; padding: 0px;">
                        <h4 style="padding-top: 15px;">
                            <input type="hidden" name="os[valor_total_pecas]" id="valor_total_pecas" valor="<?=$valor_total_pecas?>" />
                            <?php echo traduz("valor.total.de.pecas");?>:
                            <span class="preco-total-pecas tac" style="width: 70px;"><?= (strlen($valor_total_pecas) == 0) ? "0.00" : $valor_total_pecas; ?></span>
                        </h4>
                    </div>
                    <div class="span1"></div>
                </div>

            <?php
            } else { ?>
                <br />
            <? }
            if ($produto_possui_troca != true) { ?>
                <button type="button" name="adicionar_linha" class="btn btn-primary" ><?php echo traduz("adicionar.nova.linha");?></button>
            <? } ?>
            <br />
            <br />
        </div>
    <? } //fim do troca obrigatoria ?>
    <br />

    <!-- Removido 160 HD-6796695 -->
    <!-- Removido 188 HD-7167296 -->
<!--     <?php # if (in_array($login_fabrica, [188])) { ?>
            <div class="tc_formulario" id="div_mensagem_termo" style="margin-bottom: 20px; display: none;">
                <div class="titulo_tabela">
                    Mensagens Termo
                </div>
                <br />
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10 tac">
                        <div class="alert alert-warning">
                            <p><b>Termo de Entrega</b></p>
                            <p>
                                Termo de ENTREGA deve ser feito quando o consumidor leva a ferramenta quebrada, sem funcionar ou com mau funconamento na Assistência Técnica. Favor imprimir em 2 vias, a pessoa que está deixando na AT deve assinar e o atendente da AT também deve assinar as 2 vias. Entregar uma via para o consumidor e anexar a outra via na OS.
                            </p>
                  
                            <p><b>Termo de Retirada</b></p>
                            <p>
                                Termo de RETIRADA deve ser feito quando o consumidor retira a ferramenta consertada ou trocada da Assistência Técnica, para voltar usar a ferramenta. Favor imprimir em 2 vias, a pessoa que está retirando na AT deve assinar e o atendente da AT também deve assinar as 2 vias. Entregar uma via para o consumidor e anexar a outra via na OS.
                            </p>

                            <p><b>Lançar Peças</b></p>
                            <p>
                                Para habilitar o lançamento de peças, anexe o termo de entrega e pressione o botão Lançar Peças.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="row-fluid">
                    <div class="tac">
						<button type="button" class="btn btn-primary" id="lanca_peca_termo">Lançar Peças</button>
						<?php # if (!empty($os) || isset($_GET['os_id'])) { ?>
						<button type="button" class="btn btn-warning" id="abrir_termo">Abrir Termo</button>
						<?php #} ?>
                    </div>
                </div>
            </div>
    <? #} ?>
 -->

    <? if (isset($anexo_peca_os) AND $login_fabrica != 157) { ?>
        <div class="tc_formulario" id="div_peca_anexo" style="margin-bottom: 20px;">
            <div class="titulo_tabela"><?php echo traduz("anexo.das.pecas");?></div>
            <br />
            <ul class="thumbnails" style="text-align: center;">
                <li id="peca_anexo_model" class="span2 tac" style="display: none; float: none; vertical-align: top;">
                    <label style="display: block;"></label>
                    <img src="imagens/imagem_upload.png" class="anexo_thumb" style="width: 100px; height: 90px;" />
                    <button type="button" class="btn btn-mini btn-primary" name="anexar_peca" style="width: 100px;" produto="" peca="" >Anexar</button>

                    <img src="imagens/loading_img.gif" class="anexo_loading" style="width: 64px; height: 64px; display: none;" />
                    <input type="hidden" rel="anexo" name="anexo_peca[__model__]" value="" />
                    <input type="hidden" name="anexo_peca_s3[__model__]" value="" />
                </li>
                <? if (count(getValue("produto_pecas")) > 0) {
                    $s3_item = new AmazonTC("os_item", $login_fabrica);

                    $pecas = getValue("produto_pecas");
                    $produto = getValue("produto[id]");

                    foreach ($pecas as $key => $peca) {
                        $id         = $peca['id'];
                        $referencia = $peca['referencia'];

                        if (empty($id)) {
                            continue;
                        }

                        if (!verifica_peca_anexo($id)) {
                            continue;
                        } else { ?>
                            <script>
                                if ($('#div_peca_anexo').not(':visible')) {
                                    $('#div_peca_anexo').show();
                                }
                            </script>
                        <? }

                        // 07/2015 - MLG - Alterando para manipular vários upload por PEÇA
                        $anexos = getValue("anexo_peca[$produto][$id]");

                        // qtde_max_anexos_peca é retornado na função verifica_peca_anexo()
                        for ($i=0; $i < $qtde_max_anexos_peca; $i++) {
                            $anexo_imagem  = 'imagens/imagem_upload.png';
                            $anexo_no_s3 = false;
                            $anexo_peca    = '';

                            unset($anexo_link);

                            if ($anexos[$i] and $anexo_peca_s3[$produto][$id][$i]!='t') {
                                $anexo_peca = reset($s3_item->getObjectList($anexos[$i], true));
                            } else {
                                if (strlen($os) > 0) {
                                    $id_anexo_s3 = implode('_', array_filter(
                                        array($os, getValue('produto[os_produto]'), $peca['os_item'], $i))
                                    );
                                } else {
                                    $id_anexo_s3 = implode('_', array_filter(
                                        array($anexo_chave, $produto, $peca['id'], $i))
                                    );
                                }
                                $anexo_peca = reset($s3_item->getObjectList($id_anexo_s3));

                                if (is_array($anexo_peca)) {
                                    $anexo_nome = $anexo_peca[0];
                                    unset($anexo_peca);
                                    $anexo_peca = $anexo_nome;
                                }
                            }

                            if ($anexo_peca) {
                                $anexo_no_s3 = true;
                                $anexo_link = $s3_item->getLink(basename($anexo_peca));
                                $ext = pathinfo($anexo_peca, PATHINFO_EXTENSION);

                                if ($ext == 'pdf') {
                                    $anexo_imagem = 'imagens/pdf_icone.png';
                                } else if (in_array($ext, array('doc', 'docx'))) {
                                    $anexo_imagem = 'imagens/docx_icone.png';
                                } else {
                                    if ($anexo_peca)
                                        $anexo_imagem = $s3_item->getLink('thumb_'.basename($anexo_peca));
                                }
                            }
                            $id_anexo_peca = implode('_',
                                array_filter(
                                    array('peca_anexo', $produto, $id, $i)
                                )
                            ); ?>
                            <li id="<?=$id_anexo_peca?>" data-index="<?=$i?>" class="span2 tac" style="display: inline-block; float: none; vertical-align: top;">
                                <label style="display: block;"> Ref: <?=$referencia?></label>
                                <? if (isset($anexo_link)) { ?>
                                    <a href="<?=$anexo_link?>" target="_blank">
                                <? } ?>
                                <img src="<?=$anexo_imagem?>" class="anexo_thumb" style="width: 100px; height: 90px;" />
                                <? if (isset($anexo_link)) { ?>
                                    </a>
                                    <script>setupZoom();</script>
                                <? } ?>

                                <? if ($anexo_no_s3 === false) { ?>
                                    <button type="button" class="btn btn-mini btn-primary" name="anexar_peca" style="width: 100px;" produto="<?=$produto?>" peca="<?=$id?>" data-imgid="<?=$i?>"><?php echo traduz("anexar");?></button>
                                <? } ?>
                                <img src="imagens/loading_img.gif" class="anexo_loading" style="width: 64px; height: 64px; display: none;" />
                                <input type="hidden" rel="anexo" name="anexo_peca[<?=$produto?>][<?=$id?>][<?=$i?>]" value="<?=$anexo_peca?>" />
                                <input type="hidden" name="anexo_peca_s3[<?=$produto?>][<?=$id?>][<?=$i?>]" value="<?=($anexo_no_s3 === true) ? 't' : 'f'?>" />
                            </li>
                        <? }
                    }
                } ?>
            </ul>
            <hr color="white" />
        </div>
    <? }
    if (isset($fabrica_usa_subproduto)) {
        if (strlen(getValue("subproduto[id]")) > 0) {
            $subproduto_mostra_div = "style='display: block;'";
        }

        if (in_array($login_fabrica, array(138)) && isset($mostra_subproduto_pecas)) {
            $subproduto_mostra_div = $mostra_subproduto_pecas;
        } ?>
        <div class="tc_formulario" id="div_subproduto_pecas" <?=$subproduto_mostra_div?> >
            <div class="titulo_tabela"><?php echo traduz("pecas.do.subconjunto");?></div>
            <br />
            <div id="modelo_subproduto_peca">
                <div class="row-fluid" name="subproduto_peca___modelo__">
                    <div class="span1">
                        <div class='control-group' >
                            <br />
                            <div class="controls controls-row">
                                <div class="span12 tac" >
                                    <input type="hidden" name="subproduto_pecas[__modelo__][id]" rel="subproduto_peca_id" value="" disabled="disabled" />
                                    <button type="button" class="btn btn-mini btn-danger" name="remove_peca" rel="__modelo__" style="display: none;" subproduto="t" >X</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="span3">
                        <div class='control-group' >
                            <label class="control-label" ><?php echo traduz("referencia");?></label>
                            <div class="controls controls-row">
                                <div class="span10 input-append">
                                    <input  name="subproduto_pecas[__modelo__][referencia]" class="span12" type="text" value="" disabled="disabled" />
                                    <span class="add-on" rel="lupa_peca" >
                                        <i class="icon-search"></i>
                                    </span>
                                    <input type="hidden" name="lupa_config" tipo="lista_basica" parametro="referencia" posicao="__modelo__" subproduto="t" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="span4">
                        <div class='control-group' >
                            <label class="control-label" ><?php echo traduz("descricao");?></label>
                            <div class="controls controls-row">
                                <div class="span10 input-append">
                                    <input name="subproduto_pecas[__modelo__][descricao]" class="span12" type="text" value="" disabled="disabled" />
                                    <span class="add-on" rel="lupa_peca" >
                                        <i class="icon-search"></i>
                                    </span>
                                    <input type="hidden" name="lupa_config" tipo="lista_basica" parametro="descricao" posicao="__modelo__" subproduto="t" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="span1">
                        <div class='control-group' >
                            <label class="control-label" ><?php echo traduz("qtde");?></label>
                            <div class="controls controls-row">
                                <div class="span12">
                                    <input name="subproduto_pecas[__modelo__][qtde]" class="span12 numeric" type="text" value="" disabled="disabled" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="span2">
                        <div class='control-group' >
                            <label class="control-label" ><?php echo traduz("servico");?></label>
                            <div class="controls controls-row">
                                <div class="span12 tal">
                                <select class='span12' name='subproduto_pecas[__modelo__][servico_realizado]'>
                                    <?php
                                    $contadorSR = pg_num_rows($res_sr);
                                    for($sr = 0; $sr < $contadorSR; $sr++) {
                                        $servico_realizado = pg_fetch_result($res_sr, $sr, "servico_realizado");
                                        $descricao         = pg_fetch_result($res_sr, $sr, "descricao");
                                        $gera_pedido       = pg_fetch_result($res_sr, $sr, "gera_pedido");
                                        $troca_de_peca     = pg_fetch_result($res_sr, $sr, "troca_de_peca");
                                        $peca_estoque      = pg_fetch_result($res_sr, $sr, "peca_estoque");

                                        echo "<option value='{$servico_realizado}' gera_pedido='{$gera_pedido}' troca_de_peca='{$troca_de_peca}' peca_estoque='{$peca_estoque}' >{$descricao}</option>";
                                    }
                                    ?>
                                </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <? if ($subproduto_possui_troca != true) { ?>
                <p class="tac">
                    <button type="button" name="lista_basica" class="btn" subproduto="t" ><?php echo traduz("lista.basica");?></button>
                    <?php
                    if (!in_array($login_fabrica, array(143))) {
                        $vista_explodida_subproduto_display = "none";
                        $vista_explodida_subproduto_link    = "";

                        if (strlen(getValue("subproduto[id]")) > 0) {
                            $sql = "SELECT comunicado FROM tbl_comunicado WHERE fabrica = {$login_fabrica} AND tipo = 'Vista Explodida' AND produto = ".getValue("subproduto[id]")." ORDER BY comunicado DESC LIMIT 1";
                            $res = pg_query($con, $sql);

                            if (pg_num_rows($res) > 0) {
                                $comunicado = pg_fetch_result($res, 0, "comunicado");

                                unset($linkVE);

                                if ($anexaS3->temAnexos($comunicado)) {
                                    $linkVE = $anexaS3->url;
                                    $vista_explodida_subproduto_display = "inline";
                                }
                            }
                        }
                    ?>
                        <a id="vista_explodida_subproduto" href="<?=$linkVE?>" class="btn btn-info" target="_blank" style="display: <?=$vista_explodida_subproduto_display?>;" >Vista Explodida</a>
                    <?php
                    }
                    ?>
                </p>
            <?php
            }
            ?>

            <div id="pecas_subproduto" >

                <?php
                $pecas_valores = array();


                if (!count(getValue("subproduto_pecas"))) {
                    $qtde_pecas = 3;
                } else {
                    $qtde_pecas    = verifica_quantidade_pecas(getValue("subproduto_pecas"));
                    $pecas_valores = getValue("subproduto_pecas");
                }

                for ($i = 0; $i < $qtde_pecas; $i++) {
                    if ($subproduto_possui_troca == true && empty($pecas_valores[$i]["os_item"])) {
                        continue;
                    }

                    if (count($msg_erro["msg"]) > 0 && in_array("subproduto_pecas[$i]", $msg_erro["campos"])) {
                        $bgcolor = "style='background-color: #F2DEDE'";
                    } else {
                        unset($bgcolor);
                    }

                    unset($servico);
                    if (strlen($pecas_valores[$i]["id"]) > 0) {
                        $peca_readonly     = "readonly='readonly'";
                        $peca_esconde_lupa = "style='display: none;'";
                        $peca_botao_remove = "inline";
                        $servico = $pecas_valores[$i]['servico_realizado'];
                    } else {
                        unset($peca_readonly, $peca_esconde_lupa);

                        $peca_botao_remove = "none";
                    }

                    $peca_cancelada = verificaPecaCancelada($pecas_valores[$i]['os_item']);

                    if ($peca_cancelada === false) {
                        $peca_troca_produto = verificaTrocaProduto($pecas_valores[$i]['os_item']);

                        if ($peca_troca_produto === false) {
                        ?>
                            <div class="row-fluid" name="subproduto_peca_<?=$i?>" <?=$bgcolor?> >
                                <div class="span1">
                                    <div class='control-group' >
                                        <br />
                                        <div class="controls controls-row">
                                            <div class="span12 tac" >
                                                <input type="hidden" name="subproduto_pecas[<?=$i?>][id]" rel="subproduto_peca_id" value="<?=$pecas_valores[$i]['id']?>" />
                                                <input type="hidden" name="subproduto_pecas[<?=$i?>][os_item]" value="<?=$pecas_valores[$i]['os_item']?>" />
                                                <input type="hidden" name="subproduto_pecas[<?=$i?>][subitem]" value="<?=$pecas_valores[$i]['subitem']?>" />

                                                <?php
                                                if (!(strlen($os) > 0 && strlen($pecas_valores[$i]["os_item"]) > 0 && verifica_os_item($pecas_valores[$i]["os_item"]) === true)) {
                                                ?>
                                                    <button type="button" class="btn btn-mini btn-danger" name="remove_peca" rel="<?=$i?>" style="display: <?=$peca_botao_remove?>;" subproduto="t" >X</button>
                                                <?php
                                                }
                                                ?>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="span3">
                                    <div class='control-group' >
                                        <label class="control-label" ><?php echo traduz("referencia");?></label>
                                        <div class="controls controls-row">
                                            <div class="span10 input-append">
                                                <input  name="subproduto_pecas[<?=$i?>][referencia]" class="span12"  type="text" value="<?=$pecas_valores[$i]['referencia']?>" <?=$peca_readonly?> />
                                                <span class="add-on" rel="lupa_peca" <?=$peca_esconde_lupa?> >
                                                    <i class="icon-search"></i>
                                                </span>
                                                <input type="hidden" name="lupa_config" tipo="lista_basica" parametro="referencia" produto="" posicao="<?=$i?>" subproduto="t" />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="span4">
                                    <div class='control-group' >
                                        <label class="control-label" ><?php echo traduz("descricao");?></label>
                                        <div class="controls controls-row">
                                            <div class="span10 input-append">
                                                <input name="subproduto_pecas[<?=$i?>][descricao]" class="span12" type="text" value="<?=$pecas_valores[$i]['descricao']?>" <?=$peca_readonly?> />
                                                <span class="add-on" rel="lupa_peca" <?=$peca_esconde_lupa?> >
                                                    <i class="icon-search"></i>
                                                </span>
                                                <input type="hidden" name="lupa_config" tipo="lista_basica" parametro="descricao" produto="" posicao="<?=$i?>" subproduto="t" />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="span1">
                                    <div class='control-group' >
                                        <label class="control-label" >Qtde</label>
                                        <div class="controls controls-row">
                                            <div class="span12">
                                                <?php
												   
                                                $readonlyQtdSubProduto = '';
												if (strlen($os) > 0 && strlen($pecas_valores[$i]["os_item"]) > 0 && verifica_os_item($pecas_valores[$i]["os_item"]) === true) {
                                                    $readonlyQtdSubProduto = 'readonly="readonly"';
                                                } ?>
                                                <input name="subproduto_pecas[<?=$i?>][qtde]" class="span12 numeric" type="text" value="<?=$pecas_valores[$i]['qtde']?>" <?= $readonlyQtdSubProduto; ?> />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="span2">
                                    <div class='control-group' >
                                        <label class="control-label" ><?php echo traduz("servico");?></label>
                                        <div class="controls controls-row">
                                            <div class="span12 tal">
                                                <?php


                                                if (strlen($os) > 0 && strlen($pecas_valores[$i]["os_item"]) > 0 && verifica_os_item($pecas_valores[$i]["os_item"]) === true) {
                                                ?>
                                                    <select class='span12' name='subproduto_pecas[<?=$i?>][servico_realizado]'>
                                                        <?php
                                                        $contadorSR = pg_num_rows($res_sr);
                                                        for($sr = 0; $sr < $contadorSR; $sr++) {
                                                            $servico_realizado = pg_fetch_result($res_sr, $sr, "servico_realizado");
                                                            $descricao         = pg_fetch_result($res_sr, $sr, "descricao");
                                                            $gera_pedido       = pg_fetch_result($res_sr, $sr, "gera_pedido");
                                                            $troca_de_peca     = pg_fetch_result($res_sr, $sr, "troca_de_peca");
                                                            $peca_estoque      = pg_fetch_result($res_sr, $sr, "peca_estoque");

                                                            if ($servico_realizado != $servico) {
                                                                continue;
                                                            }

                                                            echo "<option value='{$servico_realizado}' gera_pedido='{$gera_pedido}' troca_de_peca='{$troca_de_peca}' peca_estoque='{$peca_estoque}' >{$descricao}</option>";
                                                        }
                                                        ?>
                                                    </select>
                                                <?php
                                                } else {
                                                    ?>
                                                    <select class='span12' name='subproduto_pecas[<?=$i?>][servico_realizado]'>
                                                    <?php
                                                    $contadorSR = pg_num_rows($res_sr);
                                                        for($sr = 0; $sr < $contadorSR; $sr++) {
                                                            $servico_realizado = pg_fetch_result($res_sr, $sr, "servico_realizado");
                                                            $descricao         = pg_fetch_result($res_sr, $sr, "descricao");
                                                            $gera_pedido       = pg_fetch_result($res_sr, $sr, "gera_pedido");
                                                            $troca_de_peca     = pg_fetch_result($res_sr, $sr, "troca_de_peca");
                                                            $peca_estoque      = pg_fetch_result($res_sr, $sr, "peca_estoque");

                                                            if ($servico_realizado == $servico) {
                                                                $selected = "selected";
                                                            } else {
                                                                $selected = "";
                                                            }

                                                            echo "<option value='{$servico_realizado}' gera_pedido='{$gera_pedido}' troca_de_peca='{$troca_de_peca}' peca_estoque='{$peca_estoque}' {$selected} >{$descricao}</option>";
                                                        }
                                                    ?>
                                                    </select>
                                                <?php
                                                }
                                                ?>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <?php
                        } else {
                        ?>
                            <div class="row-fluid" name="peca_<?=$i?>" <?=$bgcolor?> >
                                <div class="span1"></div>

                                <div class="span10">
                                    <div class='control-group' >
                                        <br />
                                        <div class="controls controls-row">
                                            <div class="span12 tac" >
                                                <input type="hidden" name="subproduto_pecas[<?=$i?>][os_item]" value="<?=$pecas_valores[$i]['os_item']?>" />
                                                <input type="hidden" name="subproduto_pecas[<?=$i?>][referencia]" value="<?=$pecas_valores[$i]['referencia']?>" />
                                                <input type="hidden" name="subproduto_pecas[<?=$i?>][descricao]" value="<?=$pecas_valores[$i]['descricao']?>" />
                                                <input type="hidden" name="subproduto_pecas[<?=$i?>][qtde]" value="<?=$pecas_valores[$i]['qtde']?>" />
                                                <div class="alert alert-info tal" style="margin-bottom: 0px;" >
                                                    <h4><?php echo traduz("produto.de.troca");?>: <?=$pecas_valores[$i]['referencia']?> - <?=$pecas_valores[$i]['descricao']?></h4>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="span1"></div>
                            </div>
                        <?php
                        }
                    } else {
                    ?>
                        <div class="row-fluid" name="peca_<?=$i?>" <?=$bgcolor?> >
                            <div class="span1"></div>

                            <div class="span10">
                                <div class='control-group' >
                                    <div class="controls controls-row">
                                        <div class="span12 tac" >
                                            <input type="hidden" name="subproduto_pecas[<?=$i?>][os_item]" value="<?=$pecas_valores[$i]['os_item']?>" />
                                            <input type="hidden" name="subproduto_pecas[<?=$i?>][referencia]" value="<?=$pecas_valores[$i]['referencia']?>" />
                                            <input type="hidden" name="subproduto_pecas[<?=$i?>][descricao]" value="<?=$pecas_valores[$i]['descricao']?>" />
                                            <input type="hidden" name="subproduto_pecas[<?=$i?>][qtde]" value="<?=$pecas_valores[$i]['qtde']?>" />
                                            <div class="alert alert-danger tal" style="margin-bottom: 0px;" >
                                                <h6><?php echo traduz("peca.cancelada");?>: <?=$pecas_valores[$i]['referencia']?> - <?=$pecas_valores[$i]['descricao']?></h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="span1"></div>
                        </div>
                    <?php
                    }
                }
                ?>
            </div>
            <?php
            if ($subproduto_possui_troca != true) {
            ?>
                <br />
                <button type="button" name="adicionar_linha" class="btn btn-primary" subproduto="t" ><?php echo traduz("adicionar.nova.linha");?></button>
            <?php
            }
            ?>
            <br /><br />
        </div>

        <br />

        <?php
        if (isset($anexo_peca_os)) {
        ?>
            <div class="tc_formulario" id="div_peca_anexo_subproduto" >
                <div class="titulo_tabela"> <?php echo traduz("anexo.das.pecas.do.subconjunto");?></div>

                <br />

                <ul class="thumbnails" style="text-align: center;">
                    <?php
                    if (count(getValue("subproduto_pecas")) > 0) {
                        $s3_item = new AmazonTC("os_item", $login_fabrica);

                        $pecas = getValue("subproduto_pecas");

                        $produto = getValue("subproduto[id]");

                        foreach ($pecas as $key => $peca) {
                            $id         = $peca["id"];
                            $referencia = $peca["referencia"];

                            if (empty($id)) {
                                continue;
                            }

                            if (!verifica_peca_anexo($id)) {
                                continue;
                            } else {
                                echo "
                                <script>
                                    if ($('#div_peca_anexo_subproduto').not(':visible')) {
                                        $('#div_peca_anexo_subproduto').show();
                                    }
                                </script>";
                            }

                            $anexo_imagem  = "imagens/imagem_upload.png";
                            $anexo_peca_s3 = false;
                            $anexo_peca    = "";

                            unset($anexo_link);

                            if (strlen(getValue("anexo_peca[{$produto}][{$id}]")) > 0 && getValue("anexo_peca_s3[{$produto}][{$id}]") != "t") {
                                $anexos       = $s3_item->getObjectList(getValue("anexo_peca[{$produto}][{$id}]"), true);

                                $ext = strtolower(preg_replace("/.+\./", "", basename($anexos[0])));

                                if ($ext == "pdf") {
                                    $anexo_imagem = "imagens/pdf_icone.png";
                                } else if (in_array($ext, array("doc", "docx"))) {
                                    $anexo_imagem = "imagens/docx_icone.png";
                                } else {
                                    $anexo_imagem = $s3_item->getLink("thumb_".basename($anexos[0]), true);
                                }

                                $anexo_link = $s3_item->getLink(basename($anexos[0]), true);
                                $anexo_peca = getValue("anexo_peca[{$produto}][{$id}]");
                            } else if(strlen($os) > 0) {
                                $anexos = $s3_item->getObjectList("{$os}_".getValue("subproduto[os_produto]")."_".$peca["os_item"].".");

                                if (count($anexos) > 0) {
                                    $ext = strtolower(preg_replace("/.+\./", "", basename($anexos[0])));

                                    if ($ext == "pdf") {
                                        $anexo_imagem = "imagens/pdf_icone.png";
                                    } else if (in_array($ext, array("doc", "docx"))) {
                                        $anexo_imagem = "imagens/docx_icone.png";
                                    } else {
                                        $anexo_imagem = $s3_item->getLink("thumb_".basename($anexos[0]));
                                    }

                                    $anexo_link    = $s3_item->getLink(basename($anexos[0]));
                                    $anexo_peca    = basename($anexos[0]);
                                    $anexo_peca_s3 = true;
                                }
                            }
                            ?>

                            <li id="peca_anexo_<?=$produto?>_<?=$id?>" class="span2 tac" style="display: inline-block; float: none; vertical-align: top;">
                                <label style="display: block;"><?=$referencia?></label>
                                <?php if (isset($anexo_link)) { ?>
                                    <a href="<?=$anexo_link?>" target="_blank" >
                                <?php } ?>
                                        <img src="<?=$anexo_imagem?>" class="anexo_thumb" style="width: 100px; height: 90px;" />
                                <?php if (isset($anexo_link)) { ?>
                                    </a>
                                    <script>setupZoom();</script>
                                <?php } ?>

                                <?php if ($anexo_peca_s3 === false) { ?>
                                    <button type="button" class="btn btn-mini btn-primary" name="anexar_peca" style="width: 100px;" produto="<?=$produto?>" peca="<?=$id?>" ><?php echo traduz("anexar");?></button>
                                <?php } ?>

                                <img src="imagens/loading_img.gif" class="anexo_loading" style="width: 64px; height: 64px; display: none;" />
                                <input type="hidden" rel="anexo" name="anexo_peca[<?=$produto?>][<?=$id?>]" value="<?=$anexo_peca?>" />
                                <input type="hidden" name="anexo_peca_s3[<?=$produto?>][<?=$id?>]" value="<?=($anexo_peca_s3 === true) ? 't' : 'f'?>" />
                            </li>

                        <?php
                        }
                    }
                    ?>
                </ul>
            </div>
        <?php
        }
    }
    ?>
    <?php if (in_array($login_fabrica, array(176))){ ?>
        <input type="hidden" name='mostra_indice_alerta' id='mostra_indice_alerta' value="<?php echo getValue('mostra_indice_alerta'); ?>" />
        <div class="alert alert-warning" id='indice_alerta' <?php echo (getValue('mostra_indice_alerta') == 't') ? "style=''" : "style='display: none !important;'"; ?>><h5 style="margin: 0px;"><?php echo traduz("informe.as.pecas.necessarias.nas.observacoes.da.ordem.de.servico");?>.</h5></div>
    <?php } ?>

    <div id="div_observacoes" class="tc_formulario">
        <? if (in_array($login_fabrica, array(152,180,181,182))) { ?>
            <div class="titulo_tabela"> <?php echo traduz("descricao.detalhada.do.problema");?></div>
        <? } else { ?>
            <div class="titulo_tabela">
                <?php
                    switch ($login_fabrica) {
                        case 156: $obs = traduz("laudo.de.analise.tecnica"); break;
                        case 163: $obs = traduz("causa.do.defeito"); break;
                        case 171: $obs = traduz("comentario.sobre.a.visita"); break;
                        case 175: $obs = traduz("servico.executado"); break;
			            case 184: $obs = traduz("Descrição detalhada do defeito"); break;
                        case 200: $obs = traduz("Descrição detalhada do defeito"); break;
                        default: $obs = traduz("observacoes.da.ordem.de.servico"); break;
                    }
                    echo $obs;
                ?>

            </div>
        <? } ?>
        <br />
        <div class="row-fluid">
            <div class="span1"></div>

            <div class="span10">
                <div class='control-group <?=(in_array('os[observacoes]', $msg_erro['campos'])) ? "error" : "" ?>' >
                    <div class="controls controls-row">
                        <? if ($regras["os|observacoes"]["obrigatorio"] == true || in_array($login_fabrica, array(152,180,181,182))) { ?>
                            <h5 class='asteristico'>*</h5>
                        <? } ?>
                        <textarea id="os_observacoes" name="os[observacoes]" class="span12" style="height: 50px;" ><?=getValue("os[observacoes]")?></textarea>
                    </div>
                </div>
            </div>

            <div class="span1"></div>
        </div>
    </div>
    <?php
    if (in_array($login_fabrica, [131]) && $areaAdmin) { ?>
        <div id="div_justificativa" class="tc_formulario">
            <div class="titulo_tabela"> <?php echo traduz("Informe uma justificativa para abertura da OS");?></div>
            <br />
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
                    <div class='control-group <?=(in_array('os[justificativa_abertura]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <div class="controls controls-row">
                            <h5 class='asteristico'>*</h5>
                            <textarea id="justificativa_abertura" name="os[justificativa_abertura]" class="span12" style="height: 50px;" ><?=getValue("os[justificativa_abertura]")?></textarea>
                        </div>
                    </div>
                </div>
                <div class="span1"></div>
            </div>
        </div>
    <?php
    } ?>

    <br />

<?php if(($login_fabrica == 156 && ($postoInterno || $areaAdmin)) || in_array($login_fabrica, [173]) || ($login_fabrica == 148 && $app_ticket == "true")){
    if(!isset($obs_adicionais)){
        $obs_adicionais = getValue("os[obs_adicionais]");
    }

    if (in_array($login_fabrica, [148])) {       
        if (!strlen($obs_observacao) > 0) {
            $obs_observacao = (count($msg_erro['msg']) > 0) ? getValue("os[obs_adicionais]") : getValue("os[valores_adicionais][observacao]");
        }

        if (!strlen($obs_nome_contato) > 0) {
            $obs_nome_contato = (count($msg_erro['msg']) > 0) ? getValue("os[observacoes_nome_contato]") : getValue("os[valores_adicionais][nome_contato]");
        }

        if(!strlen($obs_telefone_contato) > 0){ 
            $obs_telefone_contato = (count($msg_erro['msg']) > 0) ? getValue("os[observacoes_telefone_contato]") : getValue("os[valores_adicionais][telefone_contato]");
        }
    }
 ?>
    <div id="div_observacoes_pecas" class="tc_formulario">
        <div class="titulo_tabela">
            <?php
                switch ($login_fabrica) {
                    case 173: $obs = traduz("posicao.componentes"); break;
                    case 148: $obs = traduz("observacoes.sigilosas"); break;
                    default: $obs = traduz("observacoes.administrativas"); break;
                }
                echo $obs;
            ?>  

        </div>
            <br />
            <div class="row-fluid">
                <div class="span1"></div>

                <div class="span10">
                    <div class='control-group <?=(in_array('os[observacoes]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <div class="controls controls-row">
                            <? if ($regras["os|observacoes_adicionais"]["obrigatorio"] == true) { ?>
                                <h5 class='asteristico'>*</h5>
                                <? } ?>
                                <div class="span12">
                                    <label class="control-label" for="os[obs_adicionais]">Mensagem Sigilosa para o Técnico</label>
                                    <textarea id="os_observacoes_administrativas" name="os[obs_adicionais]" class="span12" style="height: 50px;" ><?=$obs_observacao?></textarea> <br />
                                    
                                   
                                    <!-- HD-7074643 -->
                                    <div class="row-fluid">
                                        <div class="span6">
                                            <div class="control-group">
                                                <label class="control-label" for="os[observacoes_nome_contato]">Nome</label>
                                            </div>
                                            <div class="controls controls-row">
                                                <input type="text" name="os[observacoes_nome_contato]" id="os_observacoes_nome_contato" style="width: 100% !important;"  class="form-control" value="<?=$obs_nome_contato;?>"/>
                                            </div>
                                        </div>

                                        <div class="span6">
                                            <div class="control-group">
                                                <label class="control-label" for="os[observacoes_telefone_contato]">Telefone </label>
                                            </div>
                                            <div class="controls controls-row">
                                                <input type="text" name="os[observacoes_telefone_contato]" id="os_observacoes_telefone_contato" style="width: 100% !important;"  class="form-control" value="<?=$obs_telefone_contato;?>"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </div>
                    </div>
                </div>
            <div class="span1"></div>
        </div>
    </div>

    <br />
<?php }

    if($login_fabrica == 52){

        ?>

        <div id="div_anexos" class="tc_formulario">
            <div class="titulo_tabela"><?php echo traduz("dados.do.tecnico");?></div>
            <br />


            <div class="row-fluid">

                <div class="span1"></div>

                <div class="span6">
                    <div class='control-group <?=(in_array('os[nome_tecnico]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="nome_tecnico"><?php echo traduz("nome");?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?php
                                    if ($regras["os|nome_tecnico"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    }
                                ?>
                                <input name="os[nome_tecnico]" class="span12" type="text" value="<?=getValue('os[nome_tecnico]')?>" <?=$readonly?> />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span4">
                    <div class='control-group <?=(in_array('os[rg_tecnico]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="rg_tecnico"><?php echo traduz("rg");?></label>
                        <div class="controls controls-row">
                            <div class="span12">
                                <?php
                                    if ($regras["os|rg_tecnico"]["obrigatorio"] == true) {
                                        echo "<h5 class='asteristico'>*</h5>";
                                    }
                                ?>
                                <input name="os[rg_tecnico]" class="span12" type="text" maxlength="9" value="<?=getValue('os[rg_tecnico]')?>" <?=$readonly?> />
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>

        <br />

    <?php } ?>

    <?php

    if($login_fabrica == 52 && $areaAdmin !== true){

        $display = "none";

        if(strlen($os) > 0){

            $sql = "SELECT current_date - data_abertura AS interval, motivo_atraso FROM tbl_os WHERE os = {$os}";
            $res = pg_query($con, $sql);

            $interval = pg_fetch_result($res, 0, "interval");
            $motivo_atraso = pg_fetch_result($res, 0, "motivo_atraso");

            /* maaior que 72 horas */
            if($interval > 3){
                $display = "block";
            }

        }else if(strlen(getValue("os[data_abertura]")) > 0){

            $data_abertura = getValue("os[data_abertura]");

            list($d, $m, $a) = explode("/", $data_abertura);
            $data_abertura = $a."-".$m."-".$d;

            $sql = "SELECT current_date - '{$data_abertura}' AS intervalo";
            $res = pg_query($con, $sql);

            $interval = pg_fetch_result($res, 0, "intervalo");

            /* maaior que 72 horas */
            if($interval > 3){
                $display = "block";

                if(strlen(getValue("os[motivo_atraso]")) == 0){

                    $msg_erro["campos"][] = "os[motivo_atraso]";

                }

            }

        }

        ?>

        <div id="div_motivo_atraso" class="tc_formulario" style="display: <?php echo $display; ?>;">
            <div class="titulo_tabela"><?php echo traduz("motivo.de.atraso");?></div>
            <br />


            <div class="row-fluid">

                <div class="span3"></div>

                <div class="span6">
                    <div class='control-group <?=(in_array('os[motivo_atraso]', $msg_erro['campos'])) ? "error" : "" ?>' >
                        <label class="control-label" for="motivo_atraso"><?php echo traduz("opcoes.de.motivos.de.atraso");?></label>
                        <div class="controls controls-row">
                            <div class="span12">

                                <h5 class="asteristico">*</h5>

                                <select name="os[motivo_atraso]" id="motivo_atraso" class="span12">
                                    <option value=""><?php echo traduz("selecione");?></option>
                                    <?php

                                    $sql = "SELECT motivo_atraso_fechamento, descricao FROM tbl_motivo_atraso_fechamento WHERE fabrica = {$login_fabrica} AND ativo IS TRUE";
                                    $res = pg_query($con, $sql);

                                    if(pg_num_rows($res) > 0){

                                        for ($i = 0; $i < pg_num_rows($res); $i++) {

                                            $motivo = pg_fetch_result($res, $i, "motivo_atraso_fechamento");
                                            $descricao = pg_fetch_result($res, $i, "descricao");

                                            $selected = ($motivo == getValue('os[motivo_atraso]')) ? "SELECTED" : "";

                                            echo "<option value='{$motivo}' {$selected} > {$descricao} </option>";

                                        }

                                    }

                                    ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="span3"></div>

            </div>

        </div>

        <br />

       <?php
    }

    $display_msg_anexo = ((isset($valida_anexo) && !in_array($login_fabrica, array(52))) || $anexo_obrigatorio) ? '' : 'style="display:none;"';

    if ($login_fabrica == 163 AND $areaAdmin === false AND $postoInterno === true) {
        $display_msg_anexo = 'style="display:none;"';
    }

    if ((in_array($login_fabrica, array(169,170)) AND strlen(trim($os) > 0) AND getValue('os[cortesia') == 't') || ($login_fabrica == 171 && getValue('os[contrato]') != "t")) {
        $display_msg_anexo = 'style="display:none;"';
    }
    
    $anexo_prepend = "<label class='label label-important' id='anexo_obrig' {$display_msg_anexo} >Anexo(s) obrigatórios</label>";

    if ($login_fabrica == 157) {

        $anexo_prepend .=  '<br><label class="label label-important" id="tipo_anexo">Tipos de imagem reconhecidas: "png","jpg","jpeg","gif","bmp","exif","tiff","ico","PNG","JPG","JPEG","GIF"</label>';
    }
    
    // Remove label de anexo obrigatorios
    if ($anexo_obrigatorio === false) {
        unset($anexo_prepend);
    }

    if ($areaAdmin == false && in_array($login_fabrica, array(174)) && $login_posto_interno == true) {
        unset($anexo_prepend);
    }
    
    if ($login_fabrica == 173 && ($login_posto_interno == true || $postoInterno == true)) {
        unset($anexo_prepend);
    }
    
    if (in_array($login_fabrica, array(169,170))) {
        $anexo_prepend .= "
            <span id='anexo_nf_produto_obrig' class='tac' style='display: none;' >
                <br />
                <label class='label label-important' >Obrigatório o anexo da nota fiscal e de uma foto do produto</label>
            </span>
        ";
    }

    if ($login_fabrica == 157) {
        if ($campos["os"]["consumidor_revenda"] == "R") {
            $display_label_anexo_produto = "inline-block";
        } else {
            $display_label_anexo_produto = "none";
        }

        $anexo_prepend .= "
            <br />
            <label id='div_anexo_produto_nf' class='label label-warning' style='display: {$display_label_anexo_produto};'>É obrigatório o anexo da nota fiscal e foto do produto</label>
        ";
    }

    if (in_array($login_fabrica, array(171))) {
        $anexo_prepend .= "
            <br />
            <span id='anexo_os_obrig_div' class='tac' style='display: none;' >
                <br /><label class='label label-important' >Favor anexar a OS assinada pelo consumidor</label>
            </span>
        ";
    }

    if (in_array($login_fabrica, [177]) && verifica_pecas_lancadas($os)) {
        $anexo_prepend = '
            <div class="row-fluid">
                <div class="span3"></div>
                <div class="span6">
                    <div class="span12 alert alert-warning tal">
                        <center>
                            <b>Obrigatório os seguintes anexos</b><br /><br />
                        </center>
                        <strong>Na abertura da OS: &nbsp;&nbsp;&nbsp;&nbsp;</strong> <u>Nota fiscal</u><br />
                        <strong>No lançamento de peças: </strong> <u>Foto Frontal do Produto</u>, <u>Foto da Traseira do Produto</u> e <u>interior da caneca</u>.<br />
                    </div>
                </div>
                <div class="span3"></div>
            </div>';
    }

    if ($fabricaFileUploadOS) {
	    
        $boxUploader = array(
            "div_id" => "div_anexos",
            "prepend" => $anexo_prepend,
            "context" => "os",
            "unique_id" => $tempUniqueId,
            "hash_temp" => $anexoNoHash,
            "reference_id" => $tempUniqueId
        );

        include "box_uploader.php";
    } else {
    ?>

    <div id="div_anexos" class="tc_formulario">
            <div class="titulo_tabela">
                <?php echo traduz("anexo.s");?>
            </div>
            <br />

            <div class="tac" >
                <?=$anexo_prepend?>
                <?php
                if (in_array($login_fabrica, array(171))) {
                ?>
                    <span id="anexo_os_obrig_div" class="tac" style="display: none;" >
                        <br /><label class='label label-important' >Favor anexar a OS assinada pelo consumidor</label>
                    </span>
                <?php
                }
                ?>
                <br />
                <?php
                if ($fabrica_qtde_anexos > 0) {
                     
                        if (strlen($os) > 0) {
                            list($dia,$mes,$ano) = explode("/", getValue("os[data_abertura]"));
                        }

                        echo "<input type='hidden' name='anexo_chave' value='{$anexo_chave}' />";
                    

                        for ($i = 0; $i < $fabrica_qtde_anexos; $i++) {
                            unset($anexo_link);

                            $anexo_imagem = "imagens/imagem_upload.png";
                            $anexo_s3     = false;
                            $anexo        = "";

                            if (strlen(getValue("anexo[{$i}]")) > 0 && getValue("anexo_s3[{$i}]") != "t") {
                                $anexos       = $s3->getObjectList(getValue("anexo[{$i}]"), true);

                                $ext = strtolower(preg_replace("/.+\./", "", basename($anexos[0])));

                                if ($ext == "pdf") {
                                    $anexo_imagem = "imagens/pdf_icone.png";
                                } else if (in_array($ext, array("doc", "docx"))) {
                                    $anexo_imagem = "imagens/docx_icone.png";
                                } else {
                                    $anexo_imagem = $s3->getLink("thumb_".basename($anexos[0]), true);
                                }

                                $anexo_link = $s3->getLink(basename($anexos[0]), true);

                                $anexo        = getValue("anexo[$i]");
                            } else if(strlen($os) > 0) {
                                $anexos = $s3->getObjectList("{$os}_{$i}.", false, $ano, $mes);

                                if (count($anexos) > 0) {

                                    $ext = strtolower(preg_replace("/.+\./", "", basename($anexos[0])));

                                    if ($ext == "pdf") {
                                        $anexo_imagem = "imagens/pdf_icone.png";
                                    } else if (in_array($ext, array("doc", "docx"))) {
                                        $anexo_imagem = "imagens/docx_icone.png";
                                    } else {
                                        $anexo_imagem = $s3->getLink("thumb_".basename($anexos[0]), false, $ano, $mes);
                                    }

                                    $anexo_link = $s3->getLink(basename($anexos[0]), false, $ano, $mes);

                                    $anexo        = basename($anexos[0]);
                                    $anexo_s3     = true;
                                }
                            }
                            ?>
                            <div id="div_anexo_<?=$i?>" class="tac" style="display: inline-block; margin: 0px 5px 0px 5px; vertical-align: top">

                                <?php   if ($regras["anexo"]["obrigatorio"] == true) { ?>
                                    <h5 class='asteristico' style="margin-left: 40px;">*</h5> <br />
                                <?php   } ?>
                                <?php   if (isset($anexo_link)) { ?>
                                    <a href="<?=$anexo_link?>" target="_blank" >
                                <?php } ?>
                                        <img src="<?=$anexo_imagem?>" class="anexo_thumb" style="width: 100px; height: 90px;" />
                                <?php if (isset($anexo_link)) { ?>
                                    </a>
                                    <script>setupZoom();</script>
                                <?php } ?>

                                <?php
                                if ($anexo_s3 === false) {
                                    if (in_array($login_fabrica,[35])) {
                                ?>  
                                    <button type="button" style="display: none;" class="btn btn-mini btn-remover-anexo btn-danger btn-block" data-tdocsid="<?=$tdocs_id?>" data-posicao="<?=$i?>";">Remover</button>
                                <?php } ?>
                                    <button type="button" class="btn btn-mini btn-primary btn-block" name="anexar" rel="<?=$i?>" ><?php echo traduz("anexar");?></button>
                                <?php
                                }
                                ?>

                                <img src="imagens/loading_img.gif" class="anexo_loading" style="width: 64px; height: 64px; display: none;" />

                                <input type="hidden" rel="anexo" name="anexo[<?=$i?>]" value="<?=$anexo?>" />
                                <input type="hidden" name="anexo_s3[<?=$i?>]" value="<?=($anexo_s3) ? 't' : 'f'?>" />
                            </div>
                        <?php
                        }
                    }
                    if ($mensagem_anexo_obrigatorio != "") {
                    ?>
                        <div class="alert alert-info" style="width:40%;margin:20px auto 0 auto;text-align:center;">
                            <h6><?=$mensagem_anexo_obrigatorio?></h6>
                        </div>
                    <?php
                    }
                ?>
            </div>
            <br />
        </div>
    <?php
    }
    ?>

    <br />

    <?php
    if($areaAdmin){
        $tipo_posto = getValue("tipo_posto");
    }else{
        $tipo_posto = $posto_interno;
    }
    ?>
    <div class="tac">
        <?php
        if (in_array($login_fabrica, array(169, 170)) && !empty($os)) {
            $x_hd_chamado        = getValue("os[hd_chamado]");
            $x_familia_deslocamento = getValue("produto[familia_deslocamento]");
            $os_numero           = getValue("os[os_numero]");

            $sql_os_numero = "SELECT os_numero FROM tbl_os WHERE fabrica = {$login_fabrica} AND os_numero = {$os}";
            $res_os_numero = pg_query($con, $sql_os_numero);

            if (pg_num_rows($res_os_numero) > 0) {
                $x_os_numero = true;
            } else {
                $x_os_numero = false;
            }

            if (strtolower($x_familia_deslocamento) == "t" && !empty($x_hd_chamado) && empty($os_numero) && !$x_os_numero) {
            ?>
                <button type="button" class="btn btn-info" onclick="window.open('cadastro_os.php?chave_os_conjunto=<?=sha1($os.$login_fabrica)?>&os=<?=$os?>');" ><?php echo traduz("abrir.ordem.de.servico.para.o.produto.do.conjunto");?></button><br /><br />
            <?php
            }
        }

        if (in_array($login_fabrica, [160]) && data_corte_termo($os) && !$areaAdmin && 1==2) { ?>
            <div id="div_anexos" class="tc_formulario">
                <div class="titulo_tabela">
                    <?php echo traduz("anexos.termo");?>
                </div>
                <br />
                <div class="tac" >
                    <?=$anexo_prepend?>
                    <br />
                    <?php
                    if ((in_array($login_fabrica, [160]) or $replica_einhell)) { 
                        $fabrica_qtde_anexos_termo = 2;
                    }
                     
                    if (strlen($os) > 0) {
                        list($dia,$mes,$ano) = explode("/", getValue("os[data_abertura]"));
                    }

                    echo "<input type='hidden' name='anexo_chave_termo' value='{$anexo_chave}' />";
                   
                    unset($array_links);
                    
                    if(strlen($os) > 0) {
                        $sql_anexo = "SELECT tdocs_id, obs 
                                      FROM tbl_tdocs 
                                      WHERE referencia_id = {$os} 
                                      AND fabrica = {$login_fabrica} 
                                      AND situacao = 'ativo'";
                        $res_anexo = pg_query($con, $sql_anexo);
                        
                        if (pg_num_rows($res_anexo) > 0) {
                            for ($a=0; $a < pg_num_rows($res_anexo); $a++) { 
                                $arr_obs_anexo = current(json_decode(pg_fetch_result($res_anexo, $a, 'obs'), true));
                                $hash_anexo = pg_fetch_result($res_anexo, $a, 'tdocs_id');
                                $obs_anexo[$a] = $arr_obs_anexo;
                                $obs_anexo[$a]['hash'] = $hash_anexo;
                            }
                            foreach ($obs_anexo as $ky => $vlr) {
                                if ($vlr['termo_entrega'] == 'ok') {
                                    $array_links[$ky] = $vlr;
                                    $array_links[$ky]['link'] = '//api2.telecontrol.com.br/tdocs/document/id/'.$vlr['hash'];
                                }
                            }
                        }
                    }

                    for ($i = 0; $i < $fabrica_qtde_anexos_termo; $i++) {
                        unset($anexo_link);

                        $anexo_imagem = "imagens/imagem_upload.png";
                        $anexo_s3     = false;
                        $anexo        = "";

                        if (isset($array_links[$i]) && count($array_links) > 0) {

                            $ext = strtolower(preg_replace("/.+\./", "", basename($array_links[$i]['filename'])));
                            
                            if ($ext == "pdf") {
                                $anexo_imagem = "imagens/pdf_icone.png";
                            } else if (in_array($ext, array("doc", "docx"))) {
                                $anexo_imagem = "imagens/docx_icone.png";
                            } else {
                                $anexo_imagem = $array_links[$i]['link'];
                            }

                            $anexo_link = $array_links[$i]['link'];

                            $anexo        = basename($array_links[$i]['filename']);
                            $anexo_s3     = true;
                        }
                        ?>
                        <div id="div_anexo_termo_<?=$i?>" class="tac" style="display: inline-block; margin: 0px 5px 0px 5px; vertical-align: top">

                            <?php   if ($regras["anexo"]["obrigatorio"] == true) { ?>
                                <h5 class='asteristico' style="margin-left: 40px;">*</h5> <br />
                            <?php   } ?>
                            <?php   if (isset($anexo_link)) { ?>
                                <a href="<?=$anexo_link?>" target="_blank" >
                            <?php } ?>
                                    <img src="<?=$anexo_imagem?>" class="anexo_thumb" style="width: 100px; height: 90px;" />
                            <?php if (isset($anexo_link)) { ?>
                                </a>
                                <script>setupZoom();</script>
                            <?php } ?>

                            <?php
                            if ($anexo_s3 === false) {
                             ?>
                                <button type="button" class="btn btn-mini btn-primary btn-block" name="anexar_termo" rel="<?=$i?>" ><?php echo traduz("anexar");?></button>
                            <?php
                            }
                            ?>

                            <img src="imagens/loading_img.gif" class="anexo_loading" style="width: 64px; height: 64px; display: none;" />

                            <input type="hidden" rel="anexo_termo" name="anexo_termo_[<?=$i?>]" value="<?=$anexo?>" />
                            <input type="hidden" name="anexo_s3_termo_[<?=$i?>]" value="<?=($anexo_s3) ? 't' : 'f'?>" />
                        </div>
                    <?php
                    }?>
                </div>
            </div>
            <br /><br />
                
      <?  }
        ?>
        <input type='hidden' name="gravar" >
        <?php if($login_fabrica == 165){ ?>
            <input type="hidden" name="tipo_posto" id="tipo_posto" value="<?=$tipo_posto?>">
        <?php }?>
        <input type="button" class="btn btn-large"  value="<?= traduz('Gravar') ?>"  id="os_form_submit" data-submit=""  />
    </div>
</form>
</div>

<?php

if (in_array($login_fabrica, array(171)))
{ ?>
    <script>
    $(function(){
        $("#anexo_os_obrig_div").show();
    });
    </script>
<?php }

if (in_array($login_fabrica, array(176))) {?>
<script>
    $(function(){

        $("#tipo_atendimento").change(function(){
            var tipo_atendimento = $("#tipo_atendimento > option:selected").text();
            if (tipo_atendimento == "Instalação") {
                $("#produto_pecas, #lancar_peca_obrigatorio_tipo_atendimento").hide();
                $("#lancar_peca_bloqueado_tipo_atendimento").show();
                $("#mensagem_posto_lofra").show();
                $("#anexo_obrig").text("<?php echo traduz("anexo.s.obrigatarios");?>");
                $("#msg_instalacao").val("true");
            } else {
                $("#lancar_peca_bloqueado_tipo_atendimento").hide();
                $("#mensagem_posto_lofra").hide();
                $("#lancar_peca_obrigatorio_tipo_atendimento").hide();
                $("#produto_pecas").show();
                $("#anexo_obrig").text("<?php echo traduz("anexar.uma.copia.da.nf.e.da.etiqueta.do.produto");?>");
                $("#msg_instalacao").val("false");
            }
        });
        <?php if (count($msg_erro["msg"]) > 0 || strlen($os) > 0) {?>
            $("#tipo_atendimento").trigger('click');
        <?php }?>
    });
</script>
<?php }?>
<? if(($login_fabrica == 151 && strlen($readonlyselect) > 0) || ($login_fabrica == 165 && count(getValue("produto_pecas")) > 0 && strlen(getValue("produto[defeito_constatado]")) > 0)) { ?>
    <script>
        $(function(){
            $("#produto_defeito_constatado").selectreadonly(true);
        });
    </script>
<? }

if ($login_fabrica == 52) {

    if(strlen($os) > 0 && strlen($hd_chamado) == 0){
        ?>
        <script>
            $(function(){

                if($("#produto_grupo_defeito_constatado").val() != ""){
                    $("#produto_grupo_defeito_constatado").selectreadonly(true);
                }

                if($("#produto_defeito_constatado").val() != ""){
                    $("#produto_defeito_constatado").selectreadonly(true);
                }

                if($("#solucao").val() != ""){
                    $("#solucao").selectreadonly(true);
                }

                if($("#defeito_reclamado").val() != ""){
                    $("#defeito_reclamado").selectreadonly(true);
                }

                if($("#produto_marca").val() != ""){
                    $("#produto_marca").selectreadonly(true);
                }

            });
        </script>
        <?php
    }

    if(strlen($os) > 0 && strlen($hd_chamado) > 0 && $areaAdmin === true){
        ?>
        <script>
            $(function(){

                /* OS */
                $("#tipo_atendimento").selectreadonly(false).attr("readonly", false);

                /* Produto */
                $("#defeito_reclamado").selectreadonly(true);

                /* Consumidor */
                $("#consumidor_cidade").selectreadonly(true);
                $("#consumidor_complemento").prop({"readonly": false});
                $("#consumidor_email").prop({"readonly": false});
            });
        </script>
        <?
    }

    if(strlen($os) > 0 && strlen($hd_chamado) > 0 && $areaAdmin === false){
        ?>
        <script>
            $(function(){

                /* OS */
                $("#tipo_atendimento").removeAttr("readonly");

                /* Produto */
                //$("#defeito_reclamado").attr("readonly", true);
                //$("#produto_marca").attr("readonly", true);

                /* Consumidor */
                $("#consumidor_celular").attr("readonly", true);
                $("#consumidor_email").attr("readonly", true);
                $("#consumidor_complemento").attr("readonly", true);

                /* Revenda */
                $("#revenda_numero").attr("readonly", true);
                $("#revenda_telefone").attr("readonly", true);
                $("#revenda_complemento").attr("readonly", true);

                /* KM */
                $("#qtde_km").attr("readonly", true);

                /* Obs */
                $("#os_observacoes").prop({"readonly": false});

            });
        </script>
        <?
    }

}

if ($login_fabrica == 35){
    ?>
        <script>
            $(function(){

                $("#consumidor_numero").attr("readonly", false);
                $("#consumidor_celular").attr("readonly", false);
                $("#consumidor_telefone").attr("readonly", false);

            });
        </script>
    <?
}

if (in_array($login_fabrica, array(169,170))) { ?>
    <script>
    $(function() {
        <? if(strlen($os) > 0 && strlen($hd_chamado) > 0 && strlen(getValue('produto[id]')) == 0 && $areaAdmin === false) { ?>
            /* Produto */
            $("#defeito_reclamado").selectreadonly(false).attr("readonly", false);
            $("#produto_retirado_oficina").attr("readonly", false);
            $("#produto_emprestimo").attr("readonly", false);
        <? }

        if (!empty($os) || !empty($preos)) { ?>

            if ($("#tipo_atendimento option:selected").attr('km_google') == 'f') {

                $("#nota_fiscal").filter(function(){
                    return $(this).val() != "";
                }).attr("readonly",true);

                $("#data_compra").filter(function(){
                    return $(this).val() != "";
                }).attr("readonly",true);
            }

            if ($("#tipo_atendimento option:selected").attr('km_google') == 't') {
                $("#div_produto_retirado").show();
            }

            <? if (!empty($campos['produto']['defeitos_constatados_multiplos'])) { ?>
                $("#tipo_atendimento").selectreadonly(true).attr("readonly", true);
                $("#tipo_atendimento option:not(:selected)").attr('disabled',true);
            <? } ?>

            $("#os_consumidor_revenda").selectreadonly(true);
            $("#os_consumidor_revenda option:not(:selected)").attr('disabled',true);
        <? }

        if (!empty($os)) {
            if (!verifica_pecas_lancadas($os)) { ?>
                $(".removerDefeito").attr("disabled", true);
            <? }
        } ?>

        var linhas_defeitos = $(".box-defeitos > tbody").find('tr');
        var sem_peca = false;
        var obrig_peca = false;

        $(linhas_defeitos).each(function() {
            if ($(this).find("span.defeito-fora-garantia").length > 0 || $(this).find("span.defeito-sem-defeito").length > 0) {
                sem_peca = true;
            }

            if ($(this).attr("lancarpeca") == "t") {
                obrig_peca = true;
            }
        });

        if ($("#tipo_atendimento > option:selected").attr("grupo_atendimento") == "I") {
            var tipo_atendimento = $("#tipo_atendimento > option:selected").text();

            if (tipo_atendimento == "Instalação") {
                $("#produto_pecas, #lancar_peca_obrigatorio_tipo_atendimento").hide();
                $("#lancar_peca_bloqueado_tipo_atendimento").show();
            } else {
                $("#lancar_peca_bloqueado_tipo_atendimento").hide();
                $("#produto_pecas, #lancar_peca_obrigatorio_tipo_atendimento").show();
            }
        } else if ($("#tipo_atendimento > option:selected").text() != 'Triagem') {
            $("#lancar_peca_bloqueado_tipo_atendimento, #lancar_peca_obrigatorio_tipo_atendimento").hide();

            if (sem_peca == true) {
                $("#produto_pecas").hide();
            } else {
                $("#produto_pecas").show();
            }

            peca_obrigatoria_defeito_constatado(obrig_peca);
        }

    });
    </script>
<? }

if ((in_array($login_fabrica, [160]) or $replica_einhell)) {
    $qt_anexo = 2;
    for ($a=0; $a < $qt_anexo; $a++) { 
    ?>
        <form name="form_anexo_termo" method="post" action="cadastro_os.php" enctype="multipart/form-data" style="display: none;" >
            <input type="file" name="anexoUploadTermo_<?=$a?>" value="" />

            <input type="hidden" name="ajax_anexo_upload_termo" value="t" />
            <input type="hidden" name="anexo_posicao_termo" value="<?=$a?>" />
            <input type="hidden" name="anexo_chave_termo" value="<?=$anexo_chave?>" />
            <input type="hidden" name="os_termo_anexo" value="<?=$os_id?>" />
        </form>
    <?php 
    }
}

if ($fabrica_qtde_anexos > 0) {
    for ($i = 0; $i < $fabrica_qtde_anexos; $i++) {
    ?>
        <form name="form_anexo" method="post" action="cadastro_os.php" enctype="multipart/form-data" style="display: none;" >
            <input type="file" name="anexo_upload_<?=$i?>" value="" />

            <input type="hidden" name="ajax_anexo_upload" value="t" />
            <input type="hidden" name="anexo_posicao" value="<?=$i?>" />
            <input type="hidden" name="anexo_chave" value="<?=$anexo_chave?>" />
        </form>
    <?php
    }
}


if($login_fabrica == 153){
?>
    <form name="form_anexo_sem_ns" method="post" action="cadastro_os.php" enctype="multipart/form-data" style="display: none;" >
        <input type="file" name="anexo_sem_ns_upload" value="" />

        <input type="hidden" name="ajax_anexo_sem_ns_upload" value="t" />
        <input type="hidden" name="anexo_chave" value="<?=$anexo_chave?>" />
    </form>
<?php
}

if (isset($anexo_peca_os)) {
?>
    <form id="model_form_anexo_peca" name="form_anexo_peca" method="post" action="cadastro_os.php" enctype="multipart/form-data" style="display: none;" >
        <input type="file" name="anexo_peca_upload" value="" />

        <input type="hidden" name="ajax_anexo_peca_upload" value="t" />
        <input type="hidden" name="anexo_produto" value="" />
        <input type="hidden" name="anexo_posicao" value="" />
        <input type="hidden" name="anexo_peca" value="" />
        <input type="hidden" name="anexo_chave" value="<?=$anexo_chave?>" />
    </form>
<?php
    if (count(getValue("produto_pecas")) > 0) {
        $pecas = getValue("produto_pecas");

        $produto = getValue("produto[id]");

        foreach ($pecas as $key => $peca) {
            $id = $peca["id"];

            if (empty($id)) {
                continue;
            }

            if (!verifica_peca_anexo($id)) {
                continue;
            } else {
                $qtde_max_anexos_peca = ($fabrica_qtde_anexo_peca_os) ? $fabrica_qtde_anexo_peca_os : 1;

                for ($i=0; $i < $qtde_max_anexos_peca; $i++) {
                    $file_key = implode('_', array_filter(array('anexo_peca_upload', $produto, $id, $i)));
            ?>
                <form name="form_anexo_peca" method="post" action="cadastro_os.php" enctype="multipart/form-data" style="display: none;" >
                    <input type="file" name="<?=$file_key?>" value="" />

                    <input type="hidden" name="ajax_anexo_peca_upload" value="t" />
                    <input type="hidden" name="anexo_produto"          value="<?=$produto?>" />
                    <input type="hidden" name="anexo_posicao"          value="<?=$i?>" />
                    <input type="hidden" name="anexo_peca"             value="<?=$id?>" />
                    <input type="hidden" name="anexo_chave"            value="<?=$anexo_chave?>" />
                </form>
            <?php
                }
            }
        }
    }

    if (isset($fabrica_usa_subproduto)) {
        if (count(getValue("subproduto_pecas")) > 0) {
            $pecas = getValue("subproduto_pecas");

            $produto = getValue("subproduto[id]");

            foreach ($pecas as $key => $peca) {
                $id         = $peca["id"];

                if (empty($id)) {
                    continue;
                }

                if (!verifica_peca_anexo($id)) {
                    continue;
                } else {
                ?>
                    <form name="form_anexo_peca" method="post" action="cadastro_os.php" enctype="multipart/form-data" style="display: none;" >
                        <input type="file" name="anexo_peca_upload_<?=$produto?>_<?=$id?>" value="" />

                        <input type="hidden" name="ajax_anexo_peca_upload" value="t" />
                        <input type="hidden" name="anexo_produto" value="<?=$produto?>" />
                        <input type="hidden" name="anexo_peca" value="<?=$id?>" />
                        <input type="hidden" name="anexo_chave" value="<?=$anexo_chave?>" />
                    </form>
                <?php
                }
            }
        }
    }
}

if ($login_fabrica == 173) {
    if ($areaAdmin === true) {
        $posto = getValue('posto[id]');
    } else {
        $posto = $login_posto;
    }

    if (!empty($posto)) {
        $sqlPostoInterno = "
            SELECT posto_interno 
            FROM tbl_posto_fabrica 
            JOIN tbl_tipo_posto USING (tipo_posto) 
            WHERE tbl_posto_fabrica.fabrica = $login_fabrica 
            AND posto = $posto
        ";
        $resPostoInterno = pg_query($con, $sqlPostoInterno);
        $interno = pg_fetch_result($resPostoInterno, 0, 'posto_interno');

        if ($interno == 'f') {?>
            <script type="text/javascript">
                $("#tipo_atendimento option[value='345']").remove();
            </script>
        <?
        } 
    }
}

?>
    <script>
        
        $(function() {
     
            <?php if (in_array($login_fabrica, [190])) { ?>
               $(document).on('change', '.servicos_peca_realizado', function(){
                    var servico = $(this).find('option:selected').text();
                    var posicao_vetor = $(this).attr('id').split('_');
                    var posicao = posicao_vetor[2];

                    var xxos = '<?php echo $os;?>';
                    if (servico == 'Mau Uso') {
                        if (xxos) {
                            alert('Para adicionar peças de Mau Uso, você precisa abrir uma Ordem de Serviço de Orçamento, após gravar essa Os, sera habilitado um botão Abrir Ordem de Serviço Orçamento')
                        } else {
                             alert('Para adicionar peças de Mau Uso, você precisa abrir uma Ordem de Serviço de Orçamento, após gravar essa Os, sera habilitado um botão Abrir Ordem de Serviço Orçamento')
                        }

                        $("div.row-fluid[name='peca_"+posicao+"']").remove();
                    }
               });
               
               var descricao_tipo_atendimento = $("#tipo_atendimento option:selected").text();

        	   let xlimite_horas_trabalhadas = '<?php echo $limite_horas_trabalhadas;?>';

                if(descricao_tipo_atendimento == 'Preventiva'){
                    if (xlimite_horas_trabalhadas == true) {
                        $(".mostra_horimetro").show();                
                        $("#limite_horas_trabalhadas").val(true);                
                    } else {
                        $(".mostra_horimetro").hide();                
                        $("#limite_horas_trabalhadas").val('');                
                    }
                }
            <?php } ?>
 
            $(document).on("change", ".defeito_constatado_grupo", function() {
                var grupo = $(this).val();
                var posicao = $(this).attr("rel");
                var produto = $("input[id='produto_id']").val();
                $("#produto_defeito_constatado").html('');
                $.ajax({
                    url: "cadastro_os.php",
                    type: "POST",
                    dataType:"JSON",
                    data: {
                        ajax_busca_defeito_constatado: true,
                        produto: produto,
                        grupo: grupo
                    }
                })
                .done(function(data) {
                    if (data.defeitos_constatados) {
                        
                        var option = "<option value=''>Selecione</option>";
                        $.each(data.defeitos_constatados, function(key, value) {
                            var descricao = value.descricao;
                            option += "<option value='"+value.defeito_constatado+"' data-lancar-pecas='"+value.lancar_pecas+"' data-lista-garantia='"+value.lista_garantia+"' data-defeito-grupo='"+value.defeito_constatado_grupo+"' >"+descricao.trim()+"</option>";
                        });
                        $("#produto_defeito_constatado").append(option);
                    } else {
                        $("#produto_defeito_constatado").append("<option value='' >Nenhum defeito encontrado</option>");
                    }
                    $("#produto_defeito_constatado").show().next().remove();
                });
            });



            $("#lanca_peca_termo").click(function() {
                var id_tem_os = '<?=$os?>';
                ja_anexou(id_tem_os);
            });

            $("#abrir_termo").click(function() {
                var id_tem_os = '<?=$os?>';
                if (id_tem_os == "" || id_tem_os == undefined) {
                    id_tem_os = "<?=$_GET['os_id']?>";
                }

                window.open("termo_entrega.php?os="+id_tem_os, "_blank");
            });
        });

        // $(function() {

        //     window.onload = function() {

        //         var serie_venda = $("#venda_numero_serie").val();
        //         var posto_id = $("#posto_id").val();

        //         if(serie_venda == ""){
        //             //alert("Por favor informe o número de série do produto");
        //             $("#venda_numero_serie").focus();
        //             return;
        //         }

        //         $.ajax({
        //         url: '<?php echo $_SERVER["PHP_SELF"]; ?>',
        //         type: "post",
        //         dataType:"JSON",
        //         data: {
        //             ajax: true,
        //             verifica_serie_venda: true,
        //             serie_venda : serie_venda,
        //             posto_id: posto_id
        //         },
        //         beforeSend: function(){
        //             console.log('teste');
        //             $('.loading').html("<br /> <img src='imagens/loading_img.gif' style='height: 27px; margin-top: 2px;' />");
        //         }
        //         }).done(function(data){
        //             $('.loading').html("");

        //             if(data.status == true) {
                        
        //                 $("#revenda_telefone").val(data.telefone_posto);
                        
        //                 if (data.consumidor_estado == "EX") {

        //                     $(".cidade_exterior").show();
        //                     $(".cidade_nacional").hide();
                            
        //                     $("#consumidor_telefone").val(data.consumidor_fone);
        //                     $("#consumidor_estado_exterior").val(data.consumidor_estado);
        //                     $("#consumidor_cidade_exterior").val(data.consumidor_cidade_nome);

        //                 } else {
        //                     $(".cidade_exterior").hide();
        //                     $(".cidade_nacional").show();
        //                 }
        //             }
        //         });
        //     }

        // }); 

    </script>
<?php if ($login_fabrica == 158) { 

        $unidadesUsamCorretiva = \Posvenda\Regras::getUnidades("usaGarantiaCorretiva", $login_fabrica);
        $jsonCorretivas = json_encode($unidadesUsamCorretiva);

    ?>
<script type="text/javascript">

    

    $('#unidade_negocio').on('change', function() {
        let valor = $(this).val();

        if(valor == '7300'){
            $("#marca").show();
        }else{
            $("#marca").hide();
        }

        var jsonCorretivas = JSON.parse('<?= $jsonCorretivas ?>');

        if ($.inArray(valor, jsonCorretivas) == -1) {
            $("#tipo_atendimento option[value='273']").remove();
        } else {
            if ($("#tipo_atendimento option[value='273']").length == 0){
                $("#tipo_atendimento").append('<option value="273" km_google="t" fora_garantia="f" visita_tecnica="f">Garantia Corretiva</option>');
            }
        };
    });

    /*$(document).ready(function() {
        verifica_valores_adicionais()
    })*/
</script>
<?php }

if ($login_fabrica == 157) { ?>
    <script type="text/javascript">
        $(document).ready(function() {

            var retorno_autocomplete_cpf_cnpj = {
                "cpf_cnpj_cliente": {
                    retorno: function (item) {
                        if (item.cod != undefined) {
                            if (item.cod.length == 11){
                                $("#cpf_cnpj").trigger("change");
                                $("#cpf_cnpj").prop("checked", true);
                            } else if (item.cod.length == 14){
                                $("#cnpj_cpf").trigger("change");
                                $("#cnpj_cpf").prop("checked", true);
                            }

                            $("#consumidor_cep").val(item.consumidor_cep).blur();
                            $("#consumidor_bairro").val(item.consumidor_bairro);
                            $("#consumidor_numero").val(item.consumidor_numero);
                            $("#consumidor_complemento").val(item.consumidor_complemento);
                            $("#consumidor_celular").val(item.consumidor_celular);
                            $("#consumidor_telefone").val(item.consumidor_fone_comercial);
                            $("#consumidor_email").val(item.consumidor_email);
                        }
                    }
                }
            }

            $.autocompleteLoad(["cpf_cnpj_cliente"], null, retorno_autocomplete_cpf_cnpj);

        });
    </script>
<?php }

if ($login_fabrica == 161) { ?>
    <script type="text/javascript">
        let pt_interno = '<?=$posto_interno?>'

        // Liberado sem_serie para todos os postos HD-7303553
        /*if (pt_interno == 't') {
            $("#produto_sem_serie").show();
            $("#prod_s_ns").show();
        } else {
            $("#sem_ns").prop("checked",false);
            $("#produto_sem_serie").hide();
            $("#prod_s_ns").hide();
        }*/

        $(document).ready(function() {
            verifica_sem_serie()
        })

    </script>
<?
}
if (in_array($login_fabrica, [193])) {
?>
    <script type="text/javascript">
        $(function() {
            window.onload = function() {
                tempoConserto = $("#show_tempo_conserto").val();

                if (tempoConserto == 't') {
                    $("#div_tempo_conserto").show();     
                } else {
                    $("#div_tempo_conserto").hide();     
                }
            }

            var tipo_atendimento = $("#tipo_atendimento > option:selected").attr('codigo');

            if (tipo_atendimento == 'fora_garantia') {
                $("div[id^=div_servicos_peca_]").each(function(idx){
                    $(this).find('option').hide();
                });
                
                $("select option[codigo_servico=troca_peca_estoque]").show().prop("selected", true);     
            } else {
                $("div[id^=div_servicos_peca_]").each(function(idx){
                    $(this).find('option').show();
                });
            }

            <?php if (getValue("produto[troca_produto]") == "t"){ ?>
                $("#check_troca_produto").click(function(){
                    return false;
                })
            <?php } ?>
        });
    </script>
<?
}

if (in_array($login_fabrica, [194])) { ?> 
    <script type="text/javascript">
        $(function() {
            $("#tipo_atendimento > option").each(function() {
                var codigo_externo = $(this).attr('codigo');
                
                if (codigo_externo == 'garantia') {
                    $(this).attr('selected','selected');
                }
            });            
        });
    </script>
<?php } 

if ($login_fabrica == 177 && getValue('consumidor[cnpjCpf]') == "") { ?>
    <script>
        setTimeout(function(){ 
            $('#cpf_cnpj').change();
        }, 3000);
    </script>
<?php }

if (in_array($login_fabrica, [178])) { ?>
    <script type="text/javascript">
        $(function() {
        <?php if (verifica_pedido_gerado($os) == false) { ?>
            $("#tipo_atendimento").selectreadonly(false).attr("readonly", false);
        <?php } ?>
        });
    </script>

<?php
}

if ($login_fabrica == 139) {
?>
    <script type="text/javascript">
        $(document).ready(function() {
            $("#os_consumidor_revenda").val("C");
            $(".div_tipoOs").hide();
            $("#revenda_telefone").prop({"readonly":true});
        });
    </script>
<?php
}

if (in_array($login_fabrica, [169,170])) {
    if ((in_array('consumidor[celular]',$msg_erro['campos']))) {
?>
        <script type="text/javascript">
            $(window).load(function() {
                $("#consumidor_celular").attr("readonly", false);
            });
        </script>
<?php         
    } else if ((in_array('consumidor[telefone]',$msg_erro['campos']))) {
?>
        <script type="text/javascript">
            $(window).load(function() {
                $("#consumidor_telefone").attr("readonly", false);
            });
        </script>
<?php
    }
}

if ($login_fabrica == 158) {
?>
    <script type="text/javascript">
        $(window).load(function() {
            if ($("input[name=pdv_chegada]").val() != '' && $("input[name=pdv_chegada]").val() != undefined && $("input[name=pdv_saida]").val() != '' && $("input[name=pdv_chegada]").val() != undefined && !$('#div_trocar_produto').is(':visible')) {
                $("#div_trocar_produto").show();
                <?php if ($areaAdmin != true) { ?>
                    $("#trocar_produto").hide();
                <?php } ?>
            } else {
                $("#solucao").trigger("change");
                <?php if ($areaAdmin != true) { ?>
                    $("#trocar_produto").hide();
                <?php } ?>
            }
        });
    </script>
<?php
}

include "rodape.php"; ?>
